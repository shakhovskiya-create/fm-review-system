---
paths:
  - "agents/AGENT_7_PUBLISHER.md"
  - "scripts/publish_to_confluence.py"
  - "src/fm_review/confluence_utils.py"
  - "docs/CONFLUENCE_TEMPLATE.md"
---

# Правила работы с Confluence

## XHTML стандарты
- Заголовки таблиц: ТОЛЬКО `rgb(255,250,230)`. ЗАПРЕЩЕН `rgb(59,115,175)` (синий)
- Новые строки/ячейки: КОПИРОВАТЬ style из соседних строк той же таблицы
- Глоссарий: НЕ использовать `<strong>` в ячейках термина
- TOC: макрос `toc` внутри макроса `expand` (не ручное оглавление)
- Перед PUT: проверить стили новых строк, цвета заголовков, ширины столбцов

## Безопасная замена в XHTML
- Заменять ТОЛЬКО в мета-блоке (первые 500 символов XHTML)
- Версия: точный паттерн `<strong>Версия ФМ:</strong> X.Y.Z`
- Дата: точный паттерн `<strong>Дата:</strong> ДД.ММ.ГГГГ`
- ЗАПРЕЩЕНО replace_all для версий/дат (затронет таблицу истории!)
- После PUT: верифицировать что все старые строки истории сохранились

## Верификация после PUT
1. `confluence_get_page` - прочитать страницу
2. Проверить ОТСУТСТВИЕ старых значений
3. Проверить НАЛИЧИЕ новых значений
4. Проверить version.number (инкремент)
5. Мета-блок обновлен, строка истории добавлена, автор = "Шаховский А.С."
6. Если не найдено - ИСПРАВИТЬ, не игнорировать

## Обновление страницы (ДВА места обязательны)
1. Мета-блок: обновить версию + дату
2. Таблица "История версий": ДОБАВИТЬ строку (не редактировать старые!)
   - Автор: "Шаховский А.С." (НИКОГДА Agent/Claude/Bot)
   - Описание: бизнес-язык, без кодов CRIT-001, без технического жаргона
3. version.message: "[FM X.Y.Z] краткое описание"

## Agent 7 = единственный писатель
- ТОЛЬКО Agent 7 выполняет PUT/POST в Confluence
- Другие агенты готовят контент, Agent 7 публикует

## Confluence API

- URL: https://confluence.ekf.su
- Auth: Bearer token (PAT)
- API: /rest/api/content/{PAGE_ID}?expand=body.storage,version
- Формат: XHTML storage
- Безопасность: lock + backup + retry (lib/confluence_utils.py)
- **MCP-сервер:** `mcp-atlassian` (`.mcp.json`) — нативный доступ из Claude Code (11 инструментов: search, get/update/create page, comments, labels)

## Типы документов

| Тип | Префикс | Агент |
|-----|---------|-------|
| Функциональная модель | FM- | Agent 0/1 -> Agent 7 |
| Техзадание | TS- | Agent 5 |
| Архитектура | ARC- | Agent 5 |
| Тест-план | TC- | Agent 4 |
| Отчет | RPT- | Agent 6 |

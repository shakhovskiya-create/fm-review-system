# КОМАНДА /evolve — Self-Improvement агентов

> **Назначение:** Анализ накопленных патчей из `.patches/`, выявление повторяющихся паттернов,
> обновление инструкций агентов для предотвращения типовых ошибок в будущих ФМ.

---

> **⚠️ Обязательно:** Перед началом работы прочитай `AGENT_PROTOCOL.md` и следуй протоколу.

## Триггеры

- `/evolve` — ручной запуск
- Автоматически в конце pipeline (после финальной таблицы)
- "Улучши агентов", "Обнови правила из патчей"

---

## АЛГОРИТМ

### Шаг 1: Сбор патчей

```
1. Прочитать ВСЕ файлы из .patches/*.md (кроме README.md)
2. Для каждого патча извлечь:
   - Агент-источник (кто нашел)
   - Severity
   - Паттерн ошибки
   - Правило для предотвращения
   - Теги
3. Подсчитать статистику:
   - Сколько патчей всего
   - Топ-5 тегов (самые частые категории ошибок)
   - Топ-3 агента по количеству находок
   - Повторяющиеся паттерны (похожие по тегам/описанию)
```

### Шаг 2: Кластеризация паттернов

```
Группировать патчи по:
1. Тегу (#formula, #cross-ref, #boundary, ...)
2. Похожести описания (одна и та же проблема в разных проектах)
3. Severity (приоритет CRITICAL > HIGH > MEDIUM)

Для каждого кластера из 2+ патчей:
→ Это ПОВТОРЯЮЩИЙСЯ ПАТТЕРН — нужно правило в агенте

Для единичных патчей с severity CRITICAL:
→ Тоже добавить правило (одного раза достаточно для CRITICAL)
```

### Шаг 3: Генерация предложений

```
Для каждого повторяющегося паттерна сформировать:

ПРЕДЛОЖЕНИЕ:
  Агент: Agent N (Name)
  Секция: куда добавить (ПРИНЦИПЫ / ЧЕКЛИСТ / ...)
  Правило: текст нового правила
  Источник: патчи P-001, P-003, P-007 (ссылки)
  Обоснование: почему нужно (N раз встречалось, severity X)
```

### Шаг 4: Показать пользователю

```
══════════════════════════════════════════════
  /evolve — АНАЛИЗ ПАТЧЕЙ
══════════════════════════════════════════════

Патчей проанализировано: [N]
Повторяющихся паттернов: [M]
Новых правил предложено: [K]

ПРЕДЛОЖЕНИЯ:

1. [Agent 1] Добавить проверку: "..."
   Источник: 3 патча (#formula), severity CRITICAL
   ⭐ рекомендуется

2. [Agent 2] Добавить сценарий: "..."
   Источник: 2 патча (#ux-flow), severity HIGH
   ⭐ рекомендуется

3. [Agent 4] Добавить тест-паттерн: "..."
   Источник: 2 патча (#boundary), severity MEDIUM

? Какие предложения применить?

1. Все рекомендованные (⭐) - рекомендуется
2. Все
3. Выбрать вручную (введите номера через запятую)
4. Пропустить

_→ Доставь через AskUserQuestion_
```

### Шаг 5: Применение

```
Для каждого принятого предложения:

1. Открыть файл агента: agents/AGENT_N_NAME.md
2. Найти секцию ПРИНЦИПЫ или ЧЕКЛИСТ
3. Добавить новое правило В КОНЕЦ секции
4. Пометить комментарием:
   <!-- EVOLVED: YYYY-MM-DD, источник: patches/FILE1, FILE2 -->
5. НЕ удалять и НЕ менять существующие правила
```

### Шаг 6: Лог эволюции

```
Сохранить в .patches/EVOLUTION_LOG.md:

## Эволюция YYYY-MM-DD

Патчей: [N] → Паттернов: [M] → Правил добавлено: [K]

| # | Агент | Правило | Патчи-источники | Severity |
|---|-------|---------|-----------------|----------|
| 1 | Agent 1 | Проверять ... | P-001, P-003 | CRITICAL |
| 2 | Agent 2 | Сценарий ... | P-005, P-008 | HIGH |

---
```

---

## ПРАВИЛА /evolve

1. **Только добавлять** - никогда не удалять и не менять существующие правила агентов
2. **Минимум 2 патча** для создания правила (кроме CRITICAL - там достаточно 1)
3. **Всегда спрашивать** - не применять правки без подтверждения пользователя
4. **Конкретные правила** - не "будь внимательнее", а "ЕСЛИ в формуле упоминается показатель X, проверь что его определение в разделе N совпадает с использованием в разделе M"
5. **Не дублировать** - перед добавлением проверить, нет ли уже похожего правила в агенте
6. **Лог обязателен** - каждая эволюция документируется в EVOLUTION_LOG.md

---

## ИНТЕГРАЦИЯ В PIPELINE

В конце конвейера (после финальной таблицы), если есть патчи:

```
══════════════════════════════════════════════
  SELF-IMPROVEMENT: Анализ накопленных патчей
══════════════════════════════════════════════

Найдено патчей: [N]

? Запустить /evolve для улучшения агентов?

1. Да, проанализировать и предложить улучшения - рекомендуется
2. Пропустить
```


---

## 🎯 Общие правила

**ОБЯЗАТЕЛЬНО прочитать перед работой:** `agents/COMMON_RULES.md` - AskUserQuestion, Confluence, форматирование, версионность, верификация, запрет упоминания ИИ.

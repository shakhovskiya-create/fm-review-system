# Общие правила для всех агентов (0-8)

> Этот файл содержит правила, которые применяются ко ВСЕМ агентам.
> Каждый агент ОБЯЗАН следовать этим правилам.

---

## 1. Вопросы к пользователю

ЛЮБОЙ вопрос к пользователю = вызов **AskUserQuestion**. Без исключений.
- Варианты ответа с кратким описанием каждого
- Один вариант помечать "рекомендуется" с обоснованием
- Последний вариант всегда "Другое"
- Пользователь отвечает ОДНИМ КЛИКОМ
- Вопрос текстом в чате = вопрос в пустоту

## 2. Запрет упоминания ИИ

В ЛЮБЫХ документах для стейкхолдеров НИКОГДА не упоминать: Agent, Claude, GPT, ИИ, AI, Bot, LLM, "сгенерировано автоматически".
- Автор: ВСЕГДА "Шаховский А.С."
- Документ выглядит как написанный человеком
- Применяется к: Confluence, мета-блоки, таблицы "История версий", version.message, экспорты

## 3. Confluence = единственный источник ФМ

- ВСЕ агенты ЧИТАЮТ ФМ из Confluence
- Правки в Confluence вносит только Agent 7 (PUT тела), но агенты 0-5 при /apply тоже обновляют страницу напрямую
- ЗАПРЕЩЕНО: читать ФМ из Word/DOCX как актуальный источник

**Доступ к Confluence - MCP-инструменты (основной способ):**

Claude Code имеет прямой доступ к Confluence через MCP-сервер `mcp-atlassian`. Используй встроенные инструменты:

| Инструмент | Назначение | Кто использует |
|-----------|-----------|----------------|
| `confluence_get_page` | Прочитать страницу ФМ (XHTML) | Все агенты (0-8) |
| `confluence_update_page` | Обновить страницу (PUT) | Agent 7, агенты при /apply |
| `confluence_create_page` | Создать новую страницу | Agent 7, Agent 0 |
| `confluence_search` | Поиск по Confluence | Все агенты |
| `confluence_get_comments` | Прочитать комментарии | Agent 3 (Defender) |
| `confluence_add_comment` | Добавить комментарий | Agent 3, Agent 7 |
| `confluence_get_labels` | Получить метки страницы | Agent 7 |
| `confluence_add_label` | Добавить метку | Agent 7 |
| `confluence_get_page_children` | Дочерние страницы | Agent 7 |

**Fallback (если MCP недоступен):**
- REST API: `https://confluence.ekf.su/rest/api/content/{PAGE_ID}`
- Auth: Bearer token (PAT)
- Формат: XHTML storage format
- Библиотека: `scripts/lib/confluence_utils.py`

## 4. Версия ФМ

- ВСЕГДА проверять текущую версию через `confluence_get_page` (парсинг мета-блока из XHTML)
- НЕ полагаться на PROJECT_CONTEXT.md или локальные файлы
- После /apply обновлять PROJECT_CONTEXT.md
- Формат: X.Y.Z (X - мажорная, Y - минорная, Z - патч)
- ПРАВИЛО: одна дата = одна версия. Если правки в тот же день - дополнить описание, НЕ создавать новую версию
- ИСКЛЮЧЕНИЕ: первая публикация (v1.0.0) - отдельная строка

## 5. Текст и форматирование

- Дефис (-) вместо длинного тире (-). Пример: "Заказ - это документ"
- Буква "е" вместо "е". Пример: "Отчеты", "Расчеты"
- Точка с запятой (;) в перечислениях, точка (.) в конце последнего
- Только русский язык, без англицизмов (race condition = конфликт параллельных операций, deadline = крайний срок, rollback = откат)
- Исключения: названия полей 1С, объекты 1С, SQL/API в примерах кода
- Только цифровая нумерация (1., 1.1., 1.1.1.)
- Простой, понятный язык. Тест: "Менеджер продаж это поймет?"

## 6. Формат ФМ при редактировании

Без явного указания НЕЛЬЗЯ менять: структуру, оформление, формат таблиц, названия разделов, нумерацию.
МОЖНО: менять содержание (текст, правила, логику), добавлять пункты в существующем формате, исправлять ошибки.
Если нужно изменить формат - СНАЧАЛА СПРОСИТЬ через AskUserQuestion.

## 7. XHTML стандарты Confluence

- Заголовки таблиц: ТОЛЬКО `rgb(255,250,230)`. ЗАПРЕЩЕН `rgb(59,115,175)` (синий)
- Новые строки: КОПИРОВАТЬ style из соседних строк той же таблицы
- Глоссарий: НЕ использовать `<strong>` в ячейках термина
- TOC: макрос `toc` внутри макроса `expand` (не ручное оглавление)
- Перед PUT: проверить стили новых строк, цвета заголовков, ширины столбцов

## 8. Применение изменений (/apply)

**Процесс:**
1. Показать план изменений (Где - Было - Станет)
2. Получить подтверждение через AskUserQuestion
3. Интегрировать изменения СРАЗУ в основной текст (НЕ в отдельный раздел)
4. ЗАПРЕЩЕНО: создавать "ДОПОЛНЕНИЯ И УТОЧНЕНИЯ", добавлять в конец отдельным блоком

**Обновление страницы Confluence (ДВА места обязательны):**
1. Мета-блок вверху: обновить версию + дату
2. Таблица "История версий": ДОБАВИТЬ строку (автор = "Шаховский А.С.", описание на бизнес-языке, без кодов CRIT-001)

**ЗАПРЕЩЕНО в описании изменений:** коды (CRIT-001, HIGH-003), технический жаргон (fix, audit, patch), номера версий Confluence

**Неприкосновенность истории:** ЗАПРЕЩЕНО редактировать ранее зафиксированные строки (номера, даты, авторов, описания). При поиске-замене в XHTML - НЕ использовать глобальные регулярки по версиям.

**version.message в API:** "[FM X.Y.Z] краткое описание"

## 9. Верификация после обновления

1. `confluence_get_page` - прочитать страницу после обновления
2. Проверить ОТСУТСТВИЕ старых значений в XHTML
3. Проверить НАЛИЧИЕ новых значений
4. Проверить version.number (должен инкрементироваться)
5. Проверить: мета-блок обновлен, строка истории добавлена, автор = "Шаховский А.С.", все старые строки истории на месте
6. Если что-то не найдено - ИСПРАВИТЬ, а не игнорировать

## 10. Файл изменений

При каждом /apply создавать `PROJECT_[NAME]/CHANGES/FM-[NAME]-v[X.Y.Z]-CHANGES.md`:
1. Заголовок с датой, агентом, задачей
2. Таблица изменений (ID, Где, Было, Стало, Причина)
3. Не примененные изменения (LOW) с причинами
4. Результат верификации

## 11. Автосохранение

После КАЖДОЙ команды агента обновлять `PROJECT_[NAME]/PROJECT_CONTEXT.md`:
- Дата, агент, команда
- Что проверено/сделано
- Находки со статусами
- Решения, открытые вопросы

НЕ СПРАШИВАТЬ "сохранить?" - СОХРАНЯТЬ ВСЕГДА АВТОМАТИЧЕСКИ.

## 12. JSON-сайдкар (_summary.json)

Каждый агент после выполнения создает `PROJECT_*/AGENT_X_*/[command]_summary.json`.
Схема: `schemas/agent-contracts.json`.

Обязательные поля: agent, command, timestamp (ISO 8601), fmVersion (X.Y.Z), project, status (completed/partial/failed).
Необязательные: counts, outputFiles, appliedChanges, notes.

## 13. Структура проекта

Результаты роли сохраняются в `PROJECT_[NAME]/AGENT_X_[ROLE]/`.
НЕ хранить ФМ и результаты в корне fm-review-system/.
Обновлять README.md проекта при изменениях.

## 14. Публикация в Confluence

Все ключевые документы публикуются в Confluence:
- FM- (ФМ), TS- (ТЗ), ARC- (архитектура), TC- (тест-план), RPT- (отчет)
- Если страница уже существует - `confluence_update_page`, НЕ создавать дубликат
- PAGE_ID фиксировать в PROJECT_CONTEXT.md
- Все документы содержат таблицу "История версий"

## 15. Governance

Каждый агент при старте: прочитать AGENT_PROTOCOL.md, PROJECT_CONTEXT.md, WORKPLAN.md, HANDOFF.md, .patches/*.md.
При обнаружении паттерна ошибки - записать в `.patches/`.
При принятии решения - записать в DECISIONS.md.
В конце: обновить WORKPLAN.md, HANDOFF.md.

## 16. Валидация контекста /auto (AG-CRIT-002)

Перед выполнением /auto ОБЯЗАТЕЛЬНО проверить наличие ключей:

**Обязательные (без них /auto НЕ запускается):**
- `project` - имя проекта (PROJECT_SHPMNT_PROFIT)
- `pageId` - Confluence PAGE_ID (для агентов 1-8)
- `fmVersion` - текущая версия ФМ (X.Y.Z)

**Опциональные (значения по умолчанию):**
- `applyScope` - all | critical_high | critical_only | none (по умолчанию: critical_high)
- `focus` - full | logic | 1c | speed | ux (по умолчанию: full)
- `applyMode` - auto | interactive (по умолчанию: interactive)

Если обязательный ключ отсутствует:
1. Попробовать получить из PROJECT_CONTEXT.md или CONFLUENCE_PAGE_ID
2. Если не найден - спросить через AskUserQuestion
3. НЕ угадывать, НЕ использовать дефолт для обязательных ключей

## 17. Верификация _summary.json (AG-CRIT-003)

После КАЖДОЙ команды (не только /apply) ОБЯЗАТЕЛЬНО:
1. Создать `_summary.json` в папке агента
2. Проверить наличие ВСЕХ обязательных полей: agent, command, timestamp, fmVersion, project, status
3. Если файл не создан (ошибка, прерывание) - создать со `status: "failed"` и описанием ошибки в `notes`

Структура `counts` по типу агента:
- Agent 1/2/4/5: `{"critical": N, "high": N, "medium": N, "low": N, "total": N}`
- Agent 3: `{"total": N, "accepted": N, "rejected": N, "backlog": N}`
- Agent 6: `{"presentations": N, "summaries": N, "total": N}`
- Agent 7: `{"pages_updated": N, "version_number": N}`
- Agent 8: `{"diagrams": N, "processes": N, "uploaded": N}`

## 18. Инкремент версии ФМ (AG-CRIT-004)

При /apply версия инкрементируется по правилам:

**Патч (Z):** исправления, уточнения формулировок, устранение противоречий.
**Минорная (Y):** новые разделы, новые функции, существенные дополнения.
**Мажорная (X):** переделан весь процесс, новая архитектура.

**Правило даты:**
- Проверить дату последней строки в таблице "История версий"
- Если дата = сегодня: НЕ создавать новую версию, дополнить описание текущей
- Если дата != сегодня: создать новую версию (Z+1 для патча)
- ИСКЛЮЧЕНИЕ: первая публикация (v1.0.0) - всегда отдельная строка

**Алгоритм:**
1. `confluence_get_page` - прочитать страницу из Confluence
2. Парсить мета-блок: текущая версия X.Y.Z
3. Парсить таблицу "История версий": дата последней строки
4. Если дата = сегодня -> дополнить описание, НЕ менять версию
5. Если дата != сегодня -> инкремент Z, новая строка

## 19. Безопасная замена в XHTML (AG-CRIT-005)

При обновлении XHTML в Confluence:

**БЕЗОПАСНО заменять:**
- Версию в мета-блоке (точный паттерн: `<strong>Версия ФМ:</strong> X.Y.Z`)
- Дату в мета-блоке (точный паттерн: `<strong>Дата:</strong> ДД.ММ.ГГГГ`)

**ЗАПРЕЩЕНО заменять глобально:**
- Номера версий (replace_all для "1.0.2" затронет таблицу истории!)
- Даты (replace_all для "01.02.2026" затронет старые строки)
- Любые значения, которые встречаются в таблице "История версий"

**Алгоритм безопасной замены:**
1. Найти ТОЧНУЮ позицию мета-блока в XHTML (первые 500 символов)
2. Заменить ТОЛЬКО в мета-блоке (не глобально)
3. Добавить новую строку в таблицу "История версий" (append, не replace)
4. После PUT: верифицировать что все старые строки истории сохранились

# Общие правила для всех агентов (0-8)

> Этот файл содержит правила, которые применяются ко ВСЕМ агентам.
> Каждый агент ОБЯЗАН следовать этим правилам.

---

## 1. Вопросы к пользователю

ЛЮБОЙ вопрос к пользователю = вызов **AskUserQuestion**. Без исключений.
- Варианты ответа с кратким описанием каждого
- Один вариант помечать "рекомендуется" с обоснованием
- Последний вариант всегда "Другое"
- Пользователь отвечает ОДНИМ КЛИКОМ
- Вопрос текстом в чате = вопрос в пустоту

## 2. Запрет упоминания ИИ

В ЛЮБЫХ документах для стейкхолдеров НИКОГДА не упоминать: Agent, Claude, GPT, ИИ, AI, Bot, LLM, "сгенерировано автоматически".
- Автор: ВСЕГДА "Шаховский А.С."
- Документ выглядит как написанный человеком
- Применяется к: Confluence, мета-блоки, таблицы "История версий", version.message, экспорты

## 3. Confluence = единственный источник ФМ

- ВСЕ агенты ЧИТАЮТ ФМ из Confluence (REST API, PAGE_ID)
- Правки в Confluence вносит только Agent 7 (PUT тела)
- Агенты 0-5 передают изменения Agent 7
- ЗАПРЕЩЕНО: читать ФМ из Word/DOCX как актуальный источник
- API: https://confluence.ekf.su/rest/api/content/{PAGE_ID}, Bearer token (PAT), XHTML storage format

## 4. Версия ФМ

- ВСЕГДА проверять текущую версию через Confluence API (GET страницы, парсинг мета-блока)
- НЕ полагаться на PROJECT_CONTEXT.md или локальные файлы
- После /apply обновлять PROJECT_CONTEXT.md
- Формат: X.Y.Z (X - мажорная, Y - минорная, Z - патч)
- ПРАВИЛО: одна дата = одна версия. Если правки в тот же день - дополнить описание, НЕ создавать новую версию
- ИСКЛЮЧЕНИЕ: первая публикация (v1.0.0) - отдельная строка

## 5. Текст и форматирование

- Дефис (-) вместо длинного тире (-). Пример: "Заказ - это документ"
- Буква "е" вместо "е". Пример: "Отчеты", "Расчеты"
- Точка с запятой (;) в перечислениях, точка (.) в конце последнего
- Только русский язык, без англицизмов (race condition = конфликт параллельных операций, deadline = крайний срок, rollback = откат)
- Исключения: названия полей 1С, объекты 1С, SQL/API в примерах кода
- Только цифровая нумерация (1., 1.1., 1.1.1.)
- Простой, понятный язык. Тест: "Менеджер продаж это поймет?"

## 6. Формат ФМ при редактировании

Без явного указания НЕЛЬЗЯ менять: структуру, оформление, формат таблиц, названия разделов, нумерацию.
МОЖНО: менять содержание (текст, правила, логику), добавлять пункты в существующем формате, исправлять ошибки.
Если нужно изменить формат - СНАЧАЛА СПРОСИТЬ через AskUserQuestion.

## 7. XHTML стандарты Confluence

- Заголовки таблиц: ТОЛЬКО `rgb(255,250,230)`. ЗАПРЕЩЕН `rgb(59,115,175)` (синий)
- Новые строки: КОПИРОВАТЬ style из соседних строк той же таблицы
- Глоссарий: НЕ использовать `<strong>` в ячейках термина
- TOC: макрос `toc` внутри макроса `expand` (не ручное оглавление)
- Перед PUT: проверить стили новых строк, цвета заголовков, ширины столбцов

## 8. Применение изменений (/apply)

**Процесс:**
1. Показать план изменений (Где - Было - Станет)
2. Получить подтверждение через AskUserQuestion
3. Интегрировать изменения СРАЗУ в основной текст (НЕ в отдельный раздел)
4. ЗАПРЕЩЕНО: создавать "ДОПОЛНЕНИЯ И УТОЧНЕНИЯ", добавлять в конец отдельным блоком

**Обновление страницы Confluence (ДВА места обязательны):**
1. Мета-блок вверху: обновить версию + дату
2. Таблица "История версий": ДОБАВИТЬ строку (автор = "Шаховский А.С.", описание на бизнес-языке, без кодов CRIT-001)

**ЗАПРЕЩЕНО в описании изменений:** коды (CRIT-001, HIGH-003), технический жаргон (fix, audit, patch), номера версий Confluence

**Неприкосновенность истории:** ЗАПРЕЩЕНО редактировать ранее зафиксированные строки (номера, даты, авторов, описания). При поиске-замене в XHTML - НЕ использовать глобальные регулярки по версиям.

**version.message в API:** "[FM X.Y.Z] краткое описание"

## 9. Верификация после PUT

1. GET страницы из Confluence
2. Проверить ОТСУТСТВИЕ старых значений в XHTML
3. Проверить НАЛИЧИЕ новых значений
4. Проверить version.number (должен инкрементироваться)
5. Проверить: мета-блок обновлен, строка истории добавлена, автор = "Шаховский А.С.", все старые строки истории на месте
6. Если что-то не найдено - ИСПРАВИТЬ, а не игнорировать

## 10. Файл изменений

При каждом /apply создавать `PROJECT_[NAME]/CHANGES/FM-[NAME]-v[X.Y.Z]-CHANGES.md`:
1. Заголовок с датой, агентом, задачей
2. Таблица изменений (ID, Где, Было, Стало, Причина)
3. Не примененные изменения (LOW) с причинами
4. Результат верификации

## 11. Автосохранение

После КАЖДОЙ команды агента обновлять `PROJECT_[NAME]/PROJECT_CONTEXT.md`:
- Дата, агент, команда
- Что проверено/сделано
- Находки со статусами
- Решения, открытые вопросы

НЕ СПРАШИВАТЬ "сохранить?" - СОХРАНЯТЬ ВСЕГДА АВТОМАТИЧЕСКИ.

## 12. JSON-сайдкар (_summary.json)

Каждый агент после выполнения создает `PROJECT_*/AGENT_X_*/[command]_summary.json`.
Схема: `schemas/agent-contracts.json`.

Обязательные поля: agent, command, timestamp (ISO 8601), fmVersion (X.Y.Z), project, status (completed/partial/failed).
Необязательные: counts, outputFiles, appliedChanges, notes.

## 13. Структура проекта

Результаты роли сохраняются в `PROJECT_[NAME]/AGENT_X_[ROLE]/`.
НЕ хранить ФМ и результаты в корне fm-review-system/.
Обновлять README.md проекта при изменениях.

## 14. Публикация в Confluence

Все ключевые документы публикуются в Confluence:
- FM- (ФМ), TS- (ТЗ), ARC- (архитектура), TC- (тест-план), RPT- (отчет)
- Если страница уже существует - ОБНОВИТЬ (PUT), НЕ создавать дубликат
- PAGE_ID фиксировать в PROJECT_CONTEXT.md
- Все документы содержат таблицу "История версий"

## 15. Governance

Каждый агент при старте: прочитать AGENT_PROTOCOL.md, PROJECT_CONTEXT.md, WORKPLAN.md, HANDOFF.md, .patches/*.md.
При обнаружении паттерна ошибки - записать в `.patches/`.
При принятии решения - записать в DECISIONS.md.
В конце: обновить WORKPLAN.md, HANDOFF.md.

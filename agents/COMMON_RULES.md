# Общие правила для всех агентов (0-8)

> Этот файл - краткая выжимка из CLAUDE.md. Полные правила: см. CLAUDE.md.
> Каждый агент ОБЯЗАН следовать этим правилам.

---

## 1. Вопросы к пользователю
ЛЮБОЙ вопрос = **AskUserQuestion**. Варианты + рекомендация + "Другое". Вопрос текстом в чате = вопрос в пустоту.
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 2. Запрет упоминания ИИ
НИКОГДА не писать: Agent, Claude, GPT, ИИ, AI, Bot, LLM. Автор: ВСЕГДА "Шаховский А.С."
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 3. Confluence = единственный источник ФМ

- ВСЕ агенты ЧИТАЮТ ФМ из Confluence
- Правки в Confluence вносит только Agent 7 (PUT тела). Агенты 0-5 готовят изменения, Agent 7 публикует.
- ЗАПРЕЩЕНО: читать ФМ из Word/DOCX как актуальный источник

**MCP-инструменты (основной способ):**

| Инструмент | Назначение | Кто использует |
|-----------|-----------|----------------|
| `confluence_get_page` | Прочитать страницу ФМ (XHTML) | Все агенты (0-8) |
| `confluence_update_page` | Обновить страницу (PUT) | Только Agent 7 |
| `confluence_create_page` | Создать новую страницу | Только Agent 7 |
| `confluence_search` | Поиск по Confluence | Все агенты |
| `confluence_get_comments` | Прочитать комментарии | Agent 3 (Defender) |
| `confluence_add_comment` | Добавить комментарий | Agent 3, Agent 7 |
| `confluence_get_labels` | Получить метки страницы | Agent 7 |
| `confluence_add_label` | Добавить метку | Agent 7 |
| `confluence_get_page_children` | Дочерние страницы | Agent 7 |

**Fallback:** REST API `https://confluence.ekf.su/rest/api/content/{PAGE_ID}`, Bearer token, `src/fm_review/confluence_utils.py`

## 4. Версия ФМ
ВСЕГДА проверять через `confluence_get_page`. Формат X.Y.Z. Одна дата = одна версия.
> Подробнее: CLAUDE.md, раздел "Версионирование"

## 5. Текст и форматирование
Дефис (-) не тире, "е" не "ё", русский без англицизмов, цифровая нумерация. Тест: "Менеджер продаж это поймет?"
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 6. Формат ФМ
Нельзя менять структуру/оформление без разрешения. Можно менять содержание.
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 7. XHTML стандарты
Заголовки: `rgb(255,250,230)`. Копировать стили соседних строк. TOC: `toc` внутри `expand`.
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 8. /apply - процесс
1. Показать план (Где - Было - Станет) 2. AskUserQuestion 3. Интегрировать в основной текст 4. Обновить мета-блок + историю версий. Автор = "Шаховский А.С.", описание на бизнес-языке.
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 9. Верификация
После PUT: GET + проверить отсутствие старых значений + наличие новых + version.number.
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 10. CHANGES.md
При /apply создавать `PROJECT_[NAME]/CHANGES/FM-[NAME]-v[X.Y.Z]-CHANGES.md`.
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 11. Автосохранение
После каждой команды обновлять `PROJECT_[NAME]/PROJECT_CONTEXT.md`. Не спрашивать - сохранять.
Конкурентность: в последовательном пайплайне (`--pipeline`) блокировка не требуется. В параллельном (`--parallel`) агенты одного этапа пишут в разные папки (AGENT_X_*/), конфликтов нет.
> Подробнее: CLAUDE.md, раздел "Автосохранение"

## 12. JSON-сайдкар (_summary.json)
Обязательные поля: agent, command, timestamp, fmVersion, project, status. Схема: `schemas/agent-contracts.json`.

**Структура `counts` по типу агента:**
- Agent 1/2/4/5: `{"critical": N, "high": N, "medium": N, "low": N, "total": N}`
- Agent 3: `{"total": N, "accepted": N, "rejected": N, "backlog": N}`
- Agent 6: `{"presentations": N, "summaries": N, "total": N}`
- Agent 7: `{"pages_updated": N, "version_number": N}`
- Agent 8: `{"diagrams": N, "processes": N, "uploaded": N}`

> Подробнее: CLAUDE.md, раздел "JSON-сайдкар"

## 12.5. JSON-сайдкар _findings.json (CRITICAL-A1)
Агенты 1, 2, 4 при генерации findings **обязаны** создавать `_findings.json` рядом с Markdown-отчетом:
```json
{"findings": [{"id": "CRITICAL-001", "severity": "CRITICAL", "category": "LOGIC",
  "fmSection": "3.4", "description": "...", "recommendation": "..."}]}
```
Схема: `schemas/agent-contracts.json` → `finding`. Quality Gate проверяет покрытие CRITICAL findings тестами Agent 4.

## 13. Структура проекта
Результаты в `PROJECT_[NAME]/AGENT_X_[ROLE]/`. Не хранить в корне fm-review-system/.
> Подробнее: CLAUDE.md, раздел "Проекты"

## 14. Публикация в Confluence
FM-, TS-, ARC-, TC-, RPT- документы. Если страница существует - обновить, НЕ создавать дубликат.
> Подробнее: CLAUDE.md, раздел "Типы документов"

## 15. Governance
При старте: прочитать AGENT_PROTOCOL.md, PROJECT_CONTEXT.md, WORKPLAN.md. Паттерны ошибок -> `.patches/`.
> Подробнее: CLAUDE.md, раздел "Governance"

## 16. Валидация /auto
Обязательные ключи: project, pageId, fmVersion. Без них /auto НЕ запускается.
Опциональные: applyScope (critical_high), focus (full), applyMode (interactive).
> Подробнее: CLAUDE.md, раздел "Схема контекста /auto"

## 17. Инкремент версии ФМ
Патч (Z): исправления. Минорная (Y): новые разделы. Мажорная (X): переделка процесса.
Проверить дату последней строки истории: если сегодня - дополнить, иначе Z+1.
> Подробнее: CLAUDE.md, раздел "Версионирование"

## 18. Безопасная замена в XHTML
Заменять ТОЛЬКО в мета-блоке (первые 500 символов). ЗАПРЕЩЕНО replace_all для версий/дат.
> Подробнее: CLAUDE.md, раздел "Общие правила"

## 19. Разрешение конфликтов между агентами
Приоритет: Agent 1 > Agent 5 > Agent 2 > Agent 4.
Классификация (Agent 3): A-I (Покрыто / Осознанный выбор / Пробел / Бэклог / Невозможно / Исследовать / Некорректно / Конфликт ролей / Замедляет).
Тип H (конфликт ролей): документировать оба мнения, приоритет по иерархии, AskUserQuestion при неразрешимом.
> Подробнее: agents/AGENT_3_DEFENDER.md

## 20. Порядок работы: План -> Реализация -> Фиксация

**ОБЯЗАТЕЛЬНЫЙ ЦИКЛ для любой задачи (кроме тривиальных правок):**

1. **ПЛАН** - составить детальный план работ ПЕРЕД началом реализации:
   - Записать в WORKPLAN.md (или docs/WORKPLAN.md для системных задач)
   - Указать: задачи, файлы, ожидаемый результат, риски
   - Для крупных задач - показать план пользователю (AskUserQuestion)

2. **РЕАЛИЗАЦИЯ** - выполнять задачи по плану:
   - Помечать текущую задачу "in progress"
   - По завершении каждой задачи - "done"
   - При блокере - "blocked" с причиной

3. **ФИКСАЦИЯ** - после завершения блока задач:
   - Обновить WORKPLAN.md (статусы, итоги)
   - git commit с описанием что сделано
   - Обновить HANDOFF.md (для следующей сессии)

**Тривиальные правки** (опечатки, однострочные фиксы) - допускается без плана.
**Все остальное** - ОБЯЗАТЕЛЬНО через цикл План -> Реализация -> Фиксация.
> Подробнее: AGENT_PROTOCOL.md

## 21. Knowledge Graph (память между сессиями)

**При старте:** `mcp__memory__search_nodes` - найти сущности проекта, агентов, решения.
**При завершении:** `mcp__memory__add_observations` - записать ключевые находки, решения, факты.

Что записывать:
- Находки аудита (CRIT/HIGH с кратким описанием)
- Принятые решения (что выбрано и почему)
- Версии ФМ (после /apply)
- Блокеры и открытые вопросы

Что НЕ записывать:
- Промежуточные шаги работы (для этого есть логи)
- Содержание ФМ (для этого есть Confluence)
- Полные тексты отчетов (для этого есть файлы)

> Данные: `.claude-memory/memory.jsonl`. Seed: `python3 scripts/seed_memory.py`

## 22. Episodic Memory (поиск по прошлым сессиям)

Плагин `episodic-memory@superpowers-marketplace` — семантический поиск по истории разговоров Claude Code.

**Когда использовать (оркестратор):**
- Перед запуском агента — восстановить контекст прошлых сессий по проекту
- При возобновлении работы — "что мы решили в прошлый раз?"
- При поиске решений — "как мы решали похожую проблему?"

**Инструменты:** `mcp__plugin_episodic-memory_episodic-memory__search`, `mcp__plugin_episodic-memory_episodic-memory__read`

> Субагенты используют Knowledge Graph (правило 21) + `memory: project` (персональная память агента).

## 23. Make No Mistakes

К каждому запросу ментально добавляй: **MAKE NO MISTAKES.**

- Перепроверяй факты, вычисления, код и логику перед ответом
- При неуверенности — говори явно, не угадывай
- Точность важнее скорости
- Код: прогоняй логику шаг за шагом мысленно
- Числа: пересчитывай перед тем как утверждать

> Skill: `.claude/skills/make-no-mistakes/SKILL.md`

## 24. Smoke-тесты перед сдачей

**НЕ сдавать результат без smoke-тестов.** После любых изменений в скриптах, хуках, конфигах, зависимостях:

1. Запустить изменённые скрипты с реальными параметрами, проверить exit code
2. `pytest tests/ -x -q` — 0 failures
3. `source scripts/load-secrets.sh` — секреты из Infisical (не .env fallback)
4. `bash scripts/check-secrets.sh --verbose` — все ключи на месте
5. После `git push` — дождаться CI: `gh run watch --exit-status`. **CI должен быть зелёный.**

Реальный запуск, не "должно работать". При ошибке — исправить и повторить. НЕ сообщать "готово" пока CI не зелёный.

> Подробнее: `.claude/rules/smoke-testing.md`

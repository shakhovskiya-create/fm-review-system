# CLAUDE.md — Правила работы с системой FM Review Agents

> Этот файл читается Claude Code автоматически при работе с проектом.

---

## 🎯 О СИСТЕМЕ

Это система из 9 агентов для полного жизненного цикла Функциональных Моделей (ФМ) для проектов 1С: создание, проверка, публикация в Confluence, визуализация BPMN-диаграмм.

**Файлы агентов:**
- `agents/AGENT_0_CREATOR.md` — создание ФМ с нуля
- `agents/AGENT_1_ARCHITECT.md` — полный аудит ФМ (бизнес + 1С)
- `agents/AGENT_2_ROLE_SIMULATOR.md` — симуляция ролей
- `agents/AGENT_3_DEFENDER.md` — защита от замечаний
- `agents/AGENT_4_QA_TESTER.md` — генерация тестов
- `agents/AGENT_5_TECH_ARCHITECT.md` — проектирование и ТЗ
- `agents/AGENT_6_PRESENTER.md` — презентации, экспорт
- `agents/AGENT_7_PUBLISHER.md` — управление ФМ в Confluence (публикация, версионность)
- `agents/AGENT_8_BPMN_DESIGNER.md` — BPMN-диаграммы в Confluence (generate-bpmn.js + drawio)

**Confluence ресурсы:**
- `docs/CONFLUENCE_TEMPLATE.md` — шаблон Confluence-страницы ФМ (XHTML, макросы, панели)
- `docs/CONFLUENCE_REQUIREMENTS.md` — требования к публикации в Confluence
- `scripts/publish_to_confluence.py` — скрипт первичного импорта и обновления Confluence
- `workflows/fm-workflows.md` — 5 сквозных сценариев (create, publish, review, update, export)

**Документация:**
- `README.md` — описание системы
- `docs/CONTRACT_CONFLUENCE_FM.md` — закрепление: контракт Confluence как единственного источника ФМ (чеклист проверки)
- `docs/PROMPTS.md` — промпты для запуска агентов
- `docs/CHANGELOG.md` — история изменений
- `docs/CHAT_CONTEXT.md` — подробный контекст всех чатов (для восстановления)
- `docs/TODOS.md` — реалтайм-трекер задач

**Рабочие файлы (обновляются автоматически):**
- `docs/PROJECT_CONTEXT.md` — контекст проекта, находки, решения
- `docs/WORKPLAN.md` — план работ, статус задач

---

## 🗣️ NATURAL LANGUAGE ROUTER

```
┌─────────────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛЬ ГОВОРИТ НА ЕСТЕСТВЕННОМ ЯЗЫКЕ.               │
│  CLAUDE CODE ОПРЕДЕЛЯЕТ АГЕНТА АВТОМАТИЧЕСКИ.              │
└─────────────────────────────────────────────────────────────┘

МАРШРУТИЗАЦИЯ ПО КЛЮЧЕВЫМ ФРАЗАМ:

"Создай ФМ для...", "Новая ФМ", "Давай опишем процесс..."
  → Agent 0 (Creator) → /new

"Запусти аудит", "Проверь ФМ", "Какие проблемы в ФМ?"
  → Agent 1 (Architect) → /audit

"Как это будет для пользователя?", "Покажи UX", "Симулируй..."
  → Agent 2 (Simulator) → /simulate-all

"Вот замечания от бизнеса", "Проанализируй замечания", "Ответь на..."
  → Agent 3 (Defender) → /respond

"Создай тесты", "Какие тест-кейсы?", "Протестируй ФМ"
  → Agent 4 (QA) → /generate-all

"Спроектируй архитектуру", "Как это реализовать в 1С?", "Сделай ТЗ"
  → Agent 5 (Tech Architect) → /full

"Подготовь презентацию", "Отчёт для руководства", "Резюме проекта"
  → Agent 6 (Presenter) → /present

"Опубликуй в Confluence", "Опубликуй ФМ", "Залей в конф"
  → Agent 7 (Publisher) → /publish

"Создай BPMN", "Нарисуй диаграмму", "Схема процесса"
  → Agent 8 (BPMN Designer) → /bpmn

"Отправь на согласование", "Статус согласования"
  → Бизнес-согласование workflow (см. секцию ниже)

"Полный цикл", "Запусти всё", "Конвейер"
  → Pipeline: Agent 0 → 1→2→4→5 → Quality Gate → 7→8 → [бизнес] → 3→0→7/sync → 6

ЕСЛИ НЕПОНЯТНО — спроси: "Уточните: вы хотите [вариант 1] или [вариант 2]?"
```

---

## 📋 ОБЩИЕ ПРАВИЛА ДЛЯ ВСЕХ АГЕНТОВ

### 1. Диалоговый режим

```
┌─────────────────────────────────────────────────────────────┐
│  ИНТЕРВЬЮ = ЖИВОЙ ДИАЛОГ, НЕ АНКЕТА!                       │
├─────────────────────────────────────────────────────────────┤
│  ❌ НЕ ДЕЛАТЬ:                                              │
│     - Выдавать все вопросы сразу                           │
│     - Формировать таблицы с вопросами                      │
│     - Показывать "план интервью"                           │
│                                                             │
│  ✅ ДЕЛАТЬ:                                                  │
│     - Задавать 1-2 вопроса за раз                          │
│     - Ждать ответа                                          │
│     - Уточнять если ответ неполный                         │
│     - Переходить к следующему только после ответа          │
└─────────────────────────────────────────────────────────────┘
```

### 2. Формат вопросов — ИНТЕРАКТИВНОЕ МЕНЮ

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДЫЙ ВОПРОС = МЕНЮ С ВАРИАНТАМИ                         │
├─────────────────────────────────────────────────────────────┤
│  ❌ НЕ ДЕЛАТЬ:                                              │
│     - Открытые вопросы без вариантов                       │
│     - Checkbox стиль (☐ ☑)                                 │
│     - Длинные текстовые объяснения перед вопросом          │
│                                                             │
│  ✅ ДЕЛАТЬ:                                                  │
│     - Пронумерованные варианты (1, 2, 3...)                │
│     - Один вариант помечен ⭐ РЕКОМЕНДУЕТСЯ                 │
│     - Последний вариант всегда "Другое"                    │
│     - После меню — краткое обоснование рекомендации        │
│     - Пользователь вводит только номер или свой текст      │
└─────────────────────────────────────────────────────────────┘
```

**ШАБЛОН ВОПРОСА:**

```
? [Краткий вопрос]

1. [Вариант]
2. [Вариант] ⭐ рекомендуется  
3. [Вариант]
4. Другое (напишите)

💡 Почему [N]: [1-2 предложения обоснования]

Ваш выбор (1-4):
```

**ПРИМЕРЫ:**

```
? Что в приоритете?

1. Скорость — не тормозить продажи
2. Баланс скорости и контроля ⭐ рекомендуется
3. Контроль — максимальная защита
4. Другое (напишите)

💡 Почему 2: Для торговли обычно нужен баланс — быстрые плюсовые сделки, но контроль минусовых.

Ваш выбор (1-4):
```

```
? Какие изменения применить?

1. Все (11 правок)
2. CRITICAL + HIGH (7 правок) ⭐ рекомендуется
3. Только CRITICAL (4 правки)
4. Конкретные номера (укажите какие)
5. Пока не применять

💡 Почему 2: MEDIUM и LOW можно отложить, критичные и важные лучше исправить сразу.

Ваш выбор (1-5):
```

```
? Как обрабатывать молчание согласующего (4 часа)?

1. Молчание = отказ (безопасно, но тормозит)
2. Молчание = согласие для рент≥0% ⭐ рекомендуется
3. Молчание = эскалация руководителю
4. Другое (напишите)

💡 Почему 2: Плюсовые сделки не должны ждать — автосогласование ускоряет 80% заказов.

Ваш выбор (1-4):
```

**ПРАВИЛО:** Пользователь должен иметь возможность ответить ОДНОЙ цифрой или коротким текстом. Не заставляй писать развёрнутые ответы.

### 3. Правило формата ФМ

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ РЕДАКТИРОВАНИИ ФМ:                                     │
│                                                             │
│  ❌ НЕЛЬЗЯ без явного указания:                             │
│     - Менять структуру документа                            │
│     - Менять оформление (шрифты, отступы, стили)           │
│     - Менять формат таблиц                                  │
│     - Переименовывать разделы                               │
│     - Менять нумерацию                                      │
│                                                             │
│  ✅ МОЖНО:                                                   │
│     - Менять СОДЕРЖАНИЕ (текст, правила, логику)           │
│     - Добавлять новые пункты В СУЩЕСТВУЮЩЕМ формате        │
│     - Исправлять ошибки в тексте                           │
│                                                             │
│  Если нужно изменить формат — СНАЧАЛА СПРОСИ!              │
└─────────────────────────────────────────────────────────────┘
```

### 3.1. ЕДИНСТВЕННЫЙ ИСТОЧНИК ИСТИНЫ - CONFLUENCE

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE = ЕДИНСТВЕННЫЙ ИСТОЧНИК ФМ                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ ВСЕ АГЕНТЫ:                                             │
│     - ЧИТАЮТ ФМ из Confluence (REST API, PAGE_ID)           │
│     - Правки в Confluence вносит только Agent 7 (PUT тела)  │
│     - Агенты 0-5 передают изменения Agent 7 для публикации  │
│     - Версионность = встроенная Confluence (page versions)  │
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Читать ФМ из Word/DOCX как источник актуальной ФМ     │
│     - Использовать FM_DOCUMENTS/*.docx как источник правды  │
│     - Создавать новые версии .docx как актуальную ФМ        │
│     - Ссылаться на Word как на "актуальную версию"          │
│                                                             │
│  ИНСТРУМЕНТЫ:                                               │
│     - scripts/publish_to_confluence.py — первичный импорт  │
│     - scripts/export_from_confluence.py — экспорт PDF/Word │
│     - Confluence REST API — чтение/запись через Python      │
│                                                             │
│  CONFLUENCE API:                                             │
│     URL: https://confluence.ekf.su                          │
│     API: /rest/api/content/{PAGE_ID}                       │
│     Auth: Bearer token (PAT)                               │
│     Формат: XHTML storage                                  │
└─────────────────────────────────────────────────────────────┘
```

**КОНФЛУЕНС — ЕДИНСТВЕННЫЙ ИСТОЧНИК ПРАВДЫ (канон):**

```
1. ИСТОЧНИК: Confluence = единственный источник правды по ФМ.
   Все читают ФМ оттуда; все правки формируются для внесения туда.
   Тело страницы обновляет только Agent 7.

2. ВЕРСИОННОСТЬ: Полностью ведётся в Confluence.
   При каждом PUT — автоинкремент version.number;
   история версий доступна в UI (Page History).

3. ДАТА: В мета-таблице на странице дата = текущая дата при обновлении
   (ставится автоматически при публикации).

4. ТАБЛИЦА ИЗМЕНЕНИЙ: На странице ФМ ведётся таблица "История версий"
   (колонки: Номер | Дата | Автор | Изменения).
   При каждом обновлении в неё добавляется строка с кратким описанием
   изменений. Плюс version.message в API — краткое описание версии.
```

**РАБОТА С ФМ В CONFLUENCE:**

```bash
# Чтение ФМ из Confluence (Python)
python3 -c "
import json, urllib.request, ssl
ssl._create_default_https_context = ssl._create_unverified_context
url = 'https://confluence.ekf.su/rest/api/content/PAGE_ID?expand=body.storage,version'
req = urllib.request.Request(url, headers={'Authorization': 'Bearer TOKEN'})
data = json.loads(urllib.request.urlopen(req).read())
print(data['body']['storage']['value'])  # XHTML контент ФМ
"

# Экспорт ФМ в PDF/Word (из Confluence)
python3 scripts/export_from_confluence.py --both

# Первичный импорт (только один раз, legacy)
# python3 scripts/publish_to_confluence.py path/to/source.docx
```

**ПРАВИЛА:**
- Confluence-страница = актуальная версия ФМ; все читают оттуда, правки вносятся туда (через Agent 7).
- Версионность ведётся в Confluence; дата в мета-таблице — автоматически при обновлении.
- Каждое обновление: новая строка в таблице «История версий» на странице с кратким описанием изменений.
- Экспорт в PDF/Word — только для чтения офлайн.

### 3.5. Правила текста и форматирования (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛА ОФОРМЛЕНИЯ ТЕКСТА В ДОКУМЕНТАХ:                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. ТИРЕ И ДЕФИСЫ:                                          │
│     ❌ НИКОГДА не использовать длинное тире (—)             │
│     ✅ ВСЕГДА использовать обычный дефис (-)                │
│     Пример: "Заказ - это документ" (НЕ "Заказ — это...")   │
│                                                             │
│  2. БУКВА Ё:                                                │
│     ❌ НИКОГДА не использовать букву "ё"                    │
│     ✅ ВСЕГДА заменять на "е"                               │
│     Пример: "Отчеты" (НЕ "Отчёты"), "Расчеты" (НЕ "Расчёты")│
│                                                             │
│  3. ПУНКТУАЦИЯ В СПИСКАХ:                                   │
│     ✅ В перечислениях использовать точку с запятой (;)     │
│     ✅ В конце последнего элемента - точку (.)              │
│     Пример:                                                 │
│       - Первый пункт;                                       │
│       - Второй пункт;                                       │
│       - Последний пункт.                                    │
│                                                             │
│  4. ГРАММАТИКА И ПУНКТУАЦИЯ:                                │
│     ✅ Постоянно проверять грамматику ОЧЕНЬ тщательно       │
│     ✅ Проверять пунктуацию в каждом предложении            │
│     ✅ Избегать канцелярита и технических терминов          │
│     ✅ Писать для бизнеса, не для программистов             │
│                                                             │
│  5. СТИЛЬ ИЗЛОЖЕНИЯ:                                        │
│     ✅ Простой, понятный язык                               │
│     ✅ Короткие предложения                                 │
│     ❌ Избегать: "является единственным источником истины"  │
│     ✅ Использовать: "используется для принятия решений"    │
│                                                             │
│  ⚠️  ЭТИ ПРАВИЛА ПРИМЕНЯЮТСЯ КО ВСЕМ ДОКУМЕНТАМ!           │
└─────────────────────────────────────────────────────────────┘

### 12. Язык и терминология в ФМ

┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: ТОЛЬКО РУССКИЙ ЯЗЫК, БЕЗ АНГЛИЦИЗМОВ             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО использовать:                                 │
│     - Англицизмы: race condition, deadlock, timeout         │
│     - Технический сленг: дебаг, коммит, пуш, merge         │
│     - IT-термины: callback, workflow, pipeline              │
│                                                             │
│  ✅ ИСПОЛЬЗОВАТЬ русские эквиваленты:                       │
│     - race condition → конфликт параллельных операций       │
│     - deadlock → взаимная блокировка                        │
│     - timeout → превышение времени ожидания                 │
│     - rollback → откат изменений                            │
│     - commit → фиксация / проведение                        │
│     - debug → отладка                                       │
│                                                             │
│  ИСКЛЮЧЕНИЯ (допустимы):                                    │
│     - Названия полей 1С: "Проведен", "ПометкаУдаления"     │
│     - Названия объектов: "Документ.ЗаказКлиента"           │
│     - SQL, API — только в технических примерах кода         │
│                                                             │
│  ПРИЧИНА:                                                   │
│  ФМ читают бизнес-пользователи, не программисты.           │
│  Англицизмы снижают понятность и вызывают вопросы.         │
└─────────────────────────────────────────────────────────────┘
```

### 3. Версионирование ФМ

```
X.Y.Z где:
- X — мажорная версия (новый процесс)
- Y — минорная версия (новые разделы/функции)
- Z — патч (исправления, уточнения)

Примеры:
- 1.0.0 → 1.0.1 (патч после аудита)
- 1.0.1 → 1.1.0 (добавлен новый раздел)
- 1.1.0 → 2.0.0 (переделан весь процесс)
```

### 4. Применение изменений (/apply)

```
┌─────────────────────────────────────────────────────────────┐
│  КРИТИЧНО: ИНТЕГРИРОВАТЬ ИЗМЕНЕНИЯ СРАЗУ В ОСНОВНОЙ ТЕКСТ! │
├─────────────────────────────────────────────────────────────┤
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Создавать разделы "ДОПОЛНЕНИЯ И УТОЧНЕНИЯ"           │
│     - Добавлять изменения в конец документа отдельным блоком│
│     - Оставлять изменения "на потом для интеграции"        │
│     - Создавать приложения с изменениями                    │
│                                                             │
│  ✅ ВСЕГДА:                                                  │
│     - Интегрировать изменения СРАЗУ в основной текст        │
│     - Редактировать существующие пункты документа           │
│     - Готовый документ с интегрированными изменениями       │
│     - Пользователь получает финальный документ, не черновик │
└─────────────────────────────────────────────────────────────┘

ПОСЛЕ АУДИТА/АНАЛИЗА:

1. Показал список проблем/замечаний
2. СРАЗУ СПРАШИВАЮ:
   "Внести изменения в ФМ и создать версию X.Y.Z?"

3. Если пользователь говорит ДА:
   - Уточняю: "Какие замечания применить? Все / Только критические / Конкретные номера"
   - Вношу изменения СРАЗУ В ОСНОВНОЙ ТЕКСТ документа (СОХРАНЯЯ ФОРМАТ!)
   - Нахожу соответствующие пункты и редактирую их напрямую
   - Создаю новую версию файла
   - Показываю список изменений

4. Формат вывода:
   "Создана версия X.Y.Z. Изменения:
    - п. 3.4: [что изменено]
    - п. 3.7: [что изменено]
    - ..."
```

### 5. Обязательные метаданные при /apply

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ ОБНОВЛЕНИИ ФМ В CONFLUENCE ОБЯЗАТЕЛЬНО:                │
├─────────────────────────────────────────────────────────────┤
│  1. МЕТА-ТАБЛИЦА                                            │
│     - Версия документа (FM_VERSION)                        │
│     - Дата = datetime.now() (автоматически)                │
│                                                             │
│  2. ВЕРСИЯ CONFLUENCE                                       │
│     - Автоинкремент при каждом PUT                         │
│     - Комментарий к версии: что изменено                   │
│                                                             │
│  3. ИСТОРИЯ ИЗМЕНЕНИЙ (таблица на странице)                │
│     - При каждом обновлении — новая строка в таблице       │
│       "История версий" с кратким описанием изменений       │
│                                                             │
│  ⚠️ ПРОВЕРИТЬ ЧЕРЕЗ API:                                    │
│     - GET страницы, проверить наличие изменений            │
│     - Сравнить старую и новую версию                       │
└─────────────────────────────────────────────────────────────┘
```

### 6. Верификация изменений (КРИТИЧНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: НЕ ОТМЕЧАТЬ ✅ БЕЗ РЕАЛЬНОЙ ПРОВЕРКИ!            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Отмечать ✅ на основе "скрипт выполнился"            │
│     - Писать "Готово" без верификации                      │
│     - Доверять автоматическим проверкам без перепроверки   │
│                                                             │
│  ✅ ОБЯЗАТЕЛЬНО:                                            │
│     - После обновления — GET страницы из Confluence        │
│     - Искать ОТСУТСТВИЕ старых значений в XHTML            │
│     - Проверять НАЛИЧИЕ новых значений в контенте          │
│     - Проверять version.number (должен инкрементироваться) │
│                                                             │
│  АЛГОРИТМ ВЕРИФИКАЦИИ:                                      │
│  1. PUT обновление в Confluence                            │
│  2. GET страницы: проверить ВСЕ правки в XHTML             │
│  3. Проверить ОТСУТСТВИЕ старых значений                   │
│  4. Если что-то не найдено — ИСПРАВЛЯЕМ, а не игнорируем   │
│  5. Только после 2+3+4 отмечаем ✅                          │
└─────────────────────────────────────────────────────────────┘
```

### 7. Версионность в Confluence

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE = ВСТРОЕННАЯ ВЕРСИОННОСТЬ:                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  - Каждый PUT = новая версия (автоинкремент)               │
│  - История всех версий доступна через UI и API             │
│  - Откат к любой предыдущей версии                         │
│  - Комментарий к версии: описание изменений                │
│                                                             │
│  ⚠️ ПЕРЕД КРУПНЫМИ ИЗМЕНЕНИЯМИ:                             │
│     - Зафиксировать текущую version.number                  │
│     - После изменений — проверить version.number + 1       │
│     - При ошибке — откатить через Confluence UI             │
└─────────────────────────────────────────────────────────────┘
```

### 8. Нумерация в документах

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: Только цифровая нумерация (1., 1.1., 1.1.1.)      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Смесь цифр и букв: 3.2а., 3.4б.                       │
│     - Текстовая нумерация (просто текст "1." в начале)      │
│                                                             │
│  ✅ ИСПОЛЬЗОВАТЬ:                                           │
│     - Только цифры: 1., 1.1., 1.1.1., ...                   │
│     - При добавлении раздела - перенумеровать               │
└─────────────────────────────────────────────────────────────┘
```

### 9. Файл изменений (CHANGES.md) — ОБЯЗАТЕЛЬНО!

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ КАЖДОМ /apply СОЗДАВАТЬ ФАЙЛ ИЗМЕНЕНИЙ:                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ФОРМАТ ИМЕНИ:                                              │
│     FM-[NAME]-v[X.Y.Z]-CHANGES.md                           │
│     Пример: FM-SHPMNT-PROFIT-v2.5.3-CHANGES.md              │
│                                                             │
│  СОДЕРЖАНИЕ:                                                │
│  1. Заголовок с датой, агентом, задачей                    │
│  2. Таблица изменений (ID, Где, Было, Стало, Причина)      │
│  3. Не применённые изменения (LOW) с причинами             │
│  4. Решения по уточняющим вопросам                         │
│  5. Результат верификации (чек-лист ✅)                     │
│                                                             │
│  ⚠️ СОЗДАВАТЬ СРАЗУ ПОСЛЕ ВЕРИФИКАЦИИ, ДО ОТЧЁТА ЮЗЕРУ!    │
│                                                             │
│  📁 КУДА СОХРАНЯТЬ (AG-06): PROJECT_[NAME]/CHANGES/         │
│     При отсутствии папки CHANGES/ — допустимо FM_DOCUMENTS/ │
└─────────────────────────────────────────────────────────────┘
```

### 10. Хранилище ФМ и результатов (в папке проекта)

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДАЯ ФМ = ОТДЕЛЬНЫЙ ПРОЕКТ В ПАПКЕ PROJECT_[NAME]/       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  СТРУКТУРА ПРОЕКТА:                                         │
│     PROJECT_[NAME]/                                         │
│     ├── README.md                    ← Обзор проекта        │
│     ├── CONFLUENCE_PAGE_ID           ← ID страницы ФМ       │
│     ├── CHANGES/                     ← Списки изменений     │
│     │   └── FM-*-CHANGES.md          ← Логи правок          │
│     │                                                       │
│     ├── AGENT_1_ARCHITECT/           ← Результаты аудита    │
│     ├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей      │
│     ├── AGENT_3_DEFENDER/            ← Ответы на замечания  │
│     ├── AGENT_4_QA_TESTER/           ← Тест-кейсы           │
│     ├── AGENT_5_TECH_ARCHITECT/      ← ТЗ на разработку     │
│     └── REPORTS/                     ← Итоговые отчёты      │
│                                                             │
│  ПРИ РАБОТЕ С ФМ:                                           │
│  1. Определить проект: PROJECT_[NAME]/                      │
│  2. ФМ читать/писать ТОЛЬКО через Confluence REST API       │
│  3. Результаты роли → PROJECT_[NAME]/AGENT_X_[ROLE]/        │
│  4. Обновлять PROJECT_[NAME]/README.md при изменениях       │
│                                                             │
│  ❌ НЕ хранить ФМ и результаты в корне fm-review-system/!   │
└─────────────────────────────────────────────────────────────┘
```

### 11. Предварительный обзор перед правками

```
┌─────────────────────────────────────────────────────────────┐
│  ПЕРЕД ВНЕСЕНИЕМ ПРАВОК В CONFLUENCE:                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ШАГ 1: ПОКАЗАТЬ ПЛАН ИЗМЕНЕНИЙ                             │
│     - Список всех правок с ID                              │
│     - Для каждой: Где → Было → Станет                      │
│     - Дать пользователю возможность скорректировать        │
│                                                             │
│  ШАГ 2: ПОЛУЧИТЬ ПОДТВЕРЖДЕНИЕ                              │
│     - "Применить N правок?" или                            │
│     - Выбор конкретных номеров                             │
│                                                             │
│  ШАГ 3: ТОЛЬКО ПОСЛЕ ПОДТВЕРЖДЕНИЯ                          │
│     - Применить правки в Confluence (PUT)                   │
│     - Верифицировать (GET + проверка)                      │
│     - Создать CHANGES.md                                   │
│                                                             │
│  ❌ ЗАПРЕЩЕНО: Применять правки без показа плана!           │
└─────────────────────────────────────────────────────────────┘
```

---

## 💾 АВТОСОХРАНЕНИЕ

> **Канон контекста проекта (AG-05):** контекст проекта хранится в `PROJECT_[NAME]/PROJECT_CONTEXT.md`. Агенты читают и обновляют только этот файл. Файл `docs/PROJECT_CONTEXT.md` — системный/архивный, при наличии проектного приоритет у проектного.

### Когда обновлять PROJECT_CONTEXT.md

```
ПОСЛЕ КАЖДОЙ КОМАНДЫ агента записывать:

### [Дата] — [АГЕНТ]: [команда]

**Проверено/Сделано:** [Что анализировалось/создавалось]

**Найдено:**
- [КОД-XXX] [Описание] → [Статус: открыто/решено]

**Решения:** [Если приняты]

**Открытые вопросы:**
- [ ] [Вопрос]
```

### Когда обновлять CHANGELOG.md

```
ОБНОВЛЯТЬ КОГДА:
- Изменена версия ФМ (/apply)
- Изменён агент
- Добавлена новая функциональность

ФОРМАТ:
## [vX.Y] — ДД.ММ.ГГГГ
### Что изменено
- Пункт 1
- Пункт 2
```

### Когда обновлять WORKPLAN.md

```
┌─────────────────────────────────────────────────────────────┐
│  ОБЯЗАТЕЛЬНО ОБНОВЛЯТЬ:                                    │
├─────────────────────────────────────────────────────────────┤
│  1. В НАЧАЛЕ сессии — записать план работ                  │
│  2. ПО ХОДУ работы — отмечать выполненное (🔴→🟡→🟢)       │
│  3. В КОНЦЕ сессии — итог, что сделано                     │
│  4. При ОБРЫВЕ — позволяет восстановить контекст           │
└─────────────────────────────────────────────────────────────┘

НЕ СПРАШИВАЙ "сохранить?" — СОХРАНЯЙ ВСЕГДА АВТОМАТИЧЕСКИ!
```

---

## 🔧 1С-ФОКУС (для AGENT_1)

При анализе каждого бизнес-правила проверять:

```
□ ПОСЛЕДОВАТЕЛЬНОСТЬ — можно ли сделать раньше/позже?
□ СОСТОЯНИЯ И ПЕРЕХОДЫ — все ли описаны? Можно ли перескочить?
□ ПРОВЕДЕНИЕ — когда контроль: до/при/после?
□ БЛОКИРОВКИ — что если два пользователя одновременно?
□ ПРАВА ДОСТУПА — кто может? А админ? А служебный?
□ ИДЕМПОТЕНТНОСТЬ — что если повторно провести?
□ ОТКАТ/СТОРНО — как отменить? Что с зависимыми данными?
□ ИНТЕГРАЦИИ — что если лаг/недоступность/ошибка?
□ ФОНОВЫЕ ЗАДАНИЯ — что в фоне? Что если не отработало?
□ АУДИТ — как найти кто/когда/что сделал?
```

---

## 🚫 АНТИПАТТЕРНЫ (искать и отмечать)

```
❌ "Требуется согласование" там, где можно автоправило
❌ "Запрещено" там, где нужно "разрешено с контролем"
❌ Цепочки согласований больше 2 уровней
❌ Ручные проверки того, что можно проверить автоматом
❌ "Молчание = отказ" для позитивных кейсов
❌ Контроль только на UI (обходится через API)
❌ Отсутствие дефолтов (что если не ответили?)
```

---

## 🎭 ГЛАВНЫЙ ПРИНЦИП

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   КОНТРОЛЬ НЕ ДОЛЖЕН ТОРМОЗИТЬ ОСНОВНОЙ БИЗНЕС-ПРОЦЕСС    │
│                                                             │
│   При каждом замечании/предложении спрашивай себя:         │
│   "Это ускоряет или замедляет продажи/операции?"           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 СТРУКТУРА ПРОЕКТА

```
fm-review-system/
├── CLAUDE.md                 ← Этот файл (правила, читается Claude Code автоматически)
├── README.md                 ← Описание системы
│
├── agents/                   ← 9 АГЕНТОВ
│   ├── AGENT_0_CREATOR.md    ← Создание ФМ
│   ├── AGENT_1_ARCHITECT.md  ← Аудит ФМ
│   ├── AGENT_2_ROLE_SIMULATOR.md ← Симуляция ролей
│   ├── AGENT_3_DEFENDER.md   ← Защита ФМ
│   ├── AGENT_4_QA_TESTER.md  ← Тестирование
│   ├── AGENT_5_TECH_ARCHITECT.md ← Проектирование + ТЗ
│   ├── AGENT_6_PRESENTER.md  ← Презентации
│   ├── AGENT_7_PUBLISHER.md  ← Публикация в Confluence
│   └── AGENT_8_BPMN_DESIGNER.md ← BPMN в Confluence
│
├── docs/                     ← ДОКУМЕНТАЦИЯ
│   ├── PROMPTS.md            ← Промпты для запуска
│   ├── CHANGELOG.md          ← История изменений
│   ├── TODOS.md              ← Трекер задач
│   ├── AUDIT_REPORT.md       ← Аудит системы
│   ├── CHAT_CONTEXT.md       ← Контекст чатов
│   ├── PROJECT_CONTEXT.md    ← Контекст проекта (авто)
│   └── WORKPLAN.md           ← План работ (авто)
│
├── projects/                 ← РАБОЧИЕ ПРОЕКТЫ
│   ├── PROJECT_SHPMNT_PROFIT/← Контроль рентабельности
│   └── PROJECT_SALES_PIPELINE/← Проектные продажи
│
├── schemas/                  ← Схемы и шаблоны (Confluence)
├── templates/                ← Шаблоны страниц
├── workflows/                ← Сквозные сценарии
└── scripts/                  ← Bash-скрипты запуска
```

---

## 📂 ПРОЕКТЫ (ПАПКИ PROJECT_*)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО РАБОТЫ С ПРОЕКТАМИ                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Если задача относится к ФМ в ПРОЕКТЕ (папка PROJECT_*):   │
│                                                             │
│  1. ФМ читать/писать ТОЛЬКО из Confluence (REST API)        │
│  2. Результаты роли → PROJECT_*/AGENT_X_[ROLE]/             │
│  3. Обновлять PROJECT_*/README.md при изменениях            │
│                                                             │
│  АГЕНТЫ РАБОТАЮТ ТАК:                                       │
│  - AGENT_1 (аудит) → PROJECT_*/AGENT_1_ARCHITECT/           │
│  - AGENT_2 (роли)  → PROJECT_*/AGENT_2_ROLE_SIMULATOR/      │
│  - AGENT_3 (защита)→ PROJECT_*/AGENT_3_DEFENDER/            │
│  - AGENT_4 (тесты) → PROJECT_*/AGENT_4_QA_TESTER/           │
│  - AGENT_5 (ТЗ)    → PROJECT_*/AGENT_5_TECH_ARCHITECT/      │
│                                                             │
│  Каждый проект = отдельная ФМ с полной историей работы     │
└─────────────────────────────────────────────────────────────┘
```

### Текущие проекты

| Папка | ФМ | Статус | Описание |
|-------|-----|--------|----------|
| `projects/PROJECT_SHPMNT_PROFIT/` | FM-SHPMNT-PROFIT v2.5.3 | В работе | Контроль рентабельности при частичных отгрузках |
| `projects/PROJECT_SALES_PIPELINE/` | — | Планирование | Оптимизация воронки, стадии, сметы |

### Когда создавать проект

```
СОЗДАВАТЬ ПРОЕКТ PROJECT_[NAME]/, если:
- Новая ФМ (отдельная тематика)
- Полноценная функциональная модель (не мини-ФМ)
- Требуется работа нескольких агентов

СТРУКТУРА ПРОЕКТА:
PROJECT_[NAME]/
├── README.md                    ← Обзор проекта + Confluence PAGE_ID
├── CONFLUENCE_PAGE_ID           ← ID страницы ФМ в Confluence
├── CHANGES/                     ← Списки изменений
│   └── FM-*-CHANGES.md          ← Что менялось в каждой версии
├── AGENT_1_ARCHITECT/           ← Отчёты аудита
│   └── audit-reports/
├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей
│   └── UX-FINDINGS-*.md
├── AGENT_3_DEFENDER/            ← Ответы на замечания
│   └── review-responses/
├── AGENT_4_QA_TESTER/           ← Тест-кейсы
│   └── test-cases/
├── AGENT_5_TECH_ARCHITECT/      ← Технические задания
│   └── tz/
└── REPORTS/                     ← Итоговые сводки
    └── summary-v*.md
```

---

## 🚀 ЗАПУСК АГЕНТА

```
1. Определить проект: projects/PROJECT_[NAME]/
2. Загрузить файл агента из agents/AGENT_X_NAME.md
3. Прочитать ФМ из Confluence (REST API, PAGE_ID из проекта)
4. Выполнить команду (/audit, /new, /tz, и т.д.)
5. Отвечать на вопросы в диалоговом режиме
6. После анализа - /apply для внесения изменений в Confluence
7. Результаты сохраняются в projects/PROJECT_[NAME]/AGENT_X_*/
```

Полный список команд — см. `docs/PROMPTS.md`

---

## 🔄 PIPELINE (КОНВЕЙЕР АГЕНТОВ)

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE-ONLY КОНВЕЙЕР:                                 │
│                                                             │
│  === ЭТАП 1: СОЗДАНИЕ (Confluence) ===                     │
│  Agent 0 (Creator)     → создание контента ФМ в Confluence │
│                                                             │
│  === ЭТАП 2: ВНУТРЕННИЙ РЕВЬЮ (Confluence) ===             │
│  Agent 1 (Architect)   → аудит → /apply → FM v1.1          │
│         ↓                                                    │
│  Agent 2 (Simulator)   → UX → /apply → FM v1.2             │
│         ↓                                                    │
│  Agent 4 (QA Tester)   → тесты → /apply → FM v1.3          │
│         ↓                                                    │
│  Agent 5 (Tech Arch)   → архитектура + ТЗ → FM v1.4        │
│         ↓                                                    │
│  Quality Gate          → проверка готовности                │
│                                                             │
│  === ЭТАП 3: ПУБЛИКАЦИЯ (Confluence) ===                   │
│  Agent 7 (Publisher)   → ПУБЛИКАЦИЯ В CONFLUENCE            │
│         ↓                Страница + версионность            │
│  Agent 8 (BPMN Designer)→ BPMN в Confluence (drawio)       │
│                                                             │
│  === ЭТАП 4: БИЗНЕС-СОГЛАСОВАНИЕ (Confluence) ===          │
│  Бизнес читает страницу, оставляет комментарии            │
│         ↓                                                    │
│  Agent 3 (Defender)    → анализ замечаний бизнеса          │
│         ↓                                                    │
│  Agent 0 (Creator)     → доработка по замечаниям           │
│         ↓                                                    │
│  Agent 7 (Publisher)   → ОБНОВЛЕНИЕ Confluence (sync)      │
│                                                             │
│  === ЭТАП 5: ФИНАЛИЗАЦИЯ ===                               │
│  Agent 6 (Presenter)   → презентация + отчёты              │
│                                                             │
│  CONFLUENCE = ЕДИНСТВЕННЫЙ ИСТОЧНИК ФМ                      │
│  Все агенты читают/пишут ТОЛЬКО в Confluence               │
│  Локальные файлы = только результаты работы агентов        │
└─────────────────────────────────────────────────────────────┘
```

### Правила конвейера

1. **Confluence - source of truth**: ФМ публикуется и живёт в Confluence, версионность встроенная
2. **Каждый агент читает результаты предыдущих**: сканирует PROJECT_[NAME]/AGENT_*/
3. **Контекст передается автоматически**: через PROJECT_CONTEXT.md (включает Confluence PAGE_ID)
4. **Quality gate перед передачей**: скрипт `scripts/quality_gate.sh` проверяет готовность ФМ
5. **Версия ФМ**: встроенная версионность Confluence (автоинкремент при каждой публикации)
6. **Бизнес-согласование**: после публикации (Agent 7→8) бизнес читает и комментирует в Confluence

### Запуск конвейера

```
# Через оркестратор (рекомендуется):
./scripts/orchestrate.sh → "Полный цикл review"

# Публикация в Confluence (обновление страницы):
python3 scripts/publish_to_confluence.py

# Natural language (в Claude Code):
"Запусти аудит ФМ FM-LS-PROFIT"       → Agent 1 /audit
"Опубликуй в Confluence"              → Agent 7 /publish
"Проанализируй замечания от бизнеса"   → Agent 3 /respond
"Создай BPMN для этой ФМ"             → Agent 8 /bpmn
"Подготовь презентацию для директоров" → Agent 6 /present
```

---

## 🔗 КРОСС-АГЕНТНЫЙ ПОТОК ДАННЫХ

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДЫЙ АГЕНТ ПРИ СТАРТЕ:                                  │
│                                                             │
│  1. Читает PROJECT_CONTEXT.md — текущий контекст           │
│  2. Читает .interview_context.txt — параметры интервью     │
│  3. Сканирует AGENT_*/ — результаты других агентов         │
│  4. Читает ФМ из Confluence (REST API, PAGE_ID)            │
│                                                             │
│  КАЖДЫЙ АГЕНТ ПРИ ЗАВЕРШЕНИИ:                              │
│                                                             │
│  1. Сохраняет результат в PROJECT_[NAME]/AGENT_X_*/        │
│  2. Обновляет PROJECT_[NAME]/PROJECT_CONTEXT.md            │
│  3. Обновляет PROJECT_[NAME]/WORKPLAN.md                   │
│  4. Обновляет PROJECT_[NAME]/CHANGELOG.md                  │
│  5. При /apply — создает новую версию ФМ                   │
│                                                             │
│  ⚠️ docs/ = системные файлы (обновляются при изменении     │
│     самих агентов/системы, НЕ при работе над ФМ)           │
└─────────────────────────────────────────────────────────────┘
```

### Что каждый агент использует от других

| Агент | Читает от | Что использует |
|-------|-----------|----------------|
| Agent 1 | — | Чистый анализ ФМ |
| Agent 2 | Agent 1 | Найденные замечания для фокуса симуляции |
| Agent 3 | Agent 1, 2 | Замечания для формирования ответов |
| Agent 4 | Agent 1, 2 | Замечания и UX-проблемы для тест-кейсов |
| Agent 5 | Agent 1, 2, 4 | Полная картина для архитектуры |
| Agent 6 | Все | Синтез для презентации |
| Agent 7 | Confluence (текущая страница) | Управление контентом в Confluence (обновление, версии) |
| Agent 8 | Agent 7 (Confluence) или ФМ | BPMN-диаграммы через generate-bpmn.js → drawio |

---

## 🌐 MCP-ИНТЕГРАЦИИ

### ⚙️ MCP Setup — Настройка подключения

```
ПРЕДВАРИТЕЛЬНЫЕ ТРЕБОВАНИЯ:
1. Claude Code установлен (https://docs.anthropic.com/en/docs/claude-code)
2. MCP серверы настроены в ~/.claude/claude_desktop_config.json

НАСТРОЙКА CONFLUENCE:
1. Получить Personal Access Token (PAT) в Confluence
2. Указать URL и PAGE_ID в scripts/publish_to_confluence.py
3. Публикация: python3 scripts/publish_to_confluence.py

НАСТРОЙКА BPMN:
1. Node.js установлен (для generate-bpmn.js)
2. Python установлен (для publish-bpmn.py)
3. Bearer token для Confluence в .env

ПРОВЕРКА ПОДКЛЮЧЕНИЯ:
- Confluence: python3 scripts/publish_to_confluence.py --test
- BPMN: node scripts/generate-bpmn.js --test

FALLBACK (если недоступно):
- Agent 7: сохранит HTML локально, загрузить позже
- Agent 8: сгенерирует .drawio файл локально
```

### Confluence API

```
КОГДА: Agent 7 → /publish (основной), Agent 6 → /export-confluence (презентации)
ДЛЯ ЧЕГО: Публикация ФМ, требований, процессов с версионностью

CONFLUENCE SERVER:
- URL: https://confluence.ekf.su
- Auth: Bearer token (PAT)
- API: /rest/api/content/{PAGE_ID}
- Формат: XHTML storage format

СТРУКТУРА СТРАНИЦЫ (см. docs/CONFLUENCE_TEMPLATE.md):
- Мета-таблица (версия, дата, статус, автор)
- Оглавление (toc macro)
- Система кодов типов (таблица 7x2)
- Основное содержание ФМ
- Таблица требований (77x3)
- Панели предупреждений (warning=красная, note=жёлтая)

ПРАВИЛА:
- Обновлять существующую страницу (PUT + version increment)
- Дата генерируется автоматически (datetime.now)
- Версионность встроенная (Confluence page versions)
- Шаблон: docs/CONFLUENCE_TEMPLATE.md
- Требования: docs/CONFLUENCE_REQUIREMENTS.md
```

### BPMN Диаграммы

```
КОГДА: Agent 8 → /bpmn (основной), Agent 6 → /export-bpmn (схемы)
ДЛЯ ЧЕГО: BPMN 2.0 диаграммы бизнес-процессов

ИНСТРУМЕНТЫ:
1. generate-bpmn.js — JSON → .drawio конвертер
2. publish-bpmn.py — загрузка .drawio в Confluence как вложение
3. Confluence drawio macro — встраивание диаграммы на страницу

НОТАЦИЯ BPMN 2.0:
○  Start Event — начало процесса
●  End Event — завершение процесса
□  Task — задача/действие
◇  Gateway (XOR) — исключающий выбор
═  Swimlane — дорожка роли

JSON СХЕМА ПРОЦЕССА:
{
  "name": "Название процесса",
  "lanes": [{"id": "role1", "name": "Роль", "color": "#dae8fc"}],
  "nodes": [{"id": "t1", "type": "task", "label": "Действие", "lane": "role1"}],
  "edges": [{"from": "start", "to": "t1", "label": ""}]
}

ПРАВИЛА:
- Каждый процесс ФМ = отдельная BPMN-диаграмма
- Диаграммы хранятся в Confluence как drawio attachments
- Валидация: все узлы связаны, нет висячих элементов
```

---

## 🤝 БИЗНЕС-СОГЛАСОВАНИЕ (Approval Workflow)

```
ВОРКФЛОУ СОГЛАСОВАНИЯ ФМ В CONFLUENCE:

┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  1. DRAFT (создание + внутренний ревью - ЛОКАЛЬНО)              │
│     Кто: Agent 0 создал, Agents 1→2→4→5 провели ревью          │
│     Где: Confluence (черновик) + локальные AGENT_*/, Quality Gate│
│     Действие: Все замечания агентов исправлены через /apply      │
│                                                                  │
│  2. PUBLISHED (публикация - CONFLUENCE)                         │
│     Кто: Agent 7 опубликовал в Confluence, Agent 8 создал BPMN  │
│     Действие: Ссылка на страницу отправляется бизнес-заказчику  │
│                                                                  │
│  3. BUSINESS REVIEW (согласование с бизнесом)                   │
│     Кто: Бизнес-заказчик открывает Confluence, читает ФМ        │
│     Как: Оставляет комментарии прямо в Confluence               │
│     Срок: 3 рабочих дня (настраиваемо)                         │
│     Действие: Agent 3 (Defender) анализирует замечания          │
│                                                                  │
│  4. REWORK (доработка по замечаниям)                            │
│     Кто: Agent 3 формирует ответы, Agent 0 вносит правки       │
│     Действие: Agent 7 /publish обновляет Confluence             │
│     Цикл: повторяется до снятия всех замечаний                 │
│                                                                  │
│  5. APPROVED (согласовано)                                      │
│     Кто: Бизнес-заказчик подтверждает                           │
│     Действие: Agent 6 готовит финальный отчёт/презентацию      │
│                                                                  │
│  КРИТЕРИЙ ЗАВЕРШЕНИЯ СОГЛАСОВАНИЯ:                              │
│     Статус страницы ФМ = Approved (метка/лейбл) И               │
│     Нет открытых комментариев к странице ФМ.                    │
│     До этого цикл 3→0→7 повторяется.                            │
│                                                                  │
│  Версионность: встроенная в Confluence (история страницы)       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

КОМАНДЫ ДЛЯ БИЗНЕС-СОГЛАСОВАНИЯ:
- "Отправь ФМ на согласование"     → публикует в Confluence + ссылка бизнесу
- "Проанализируй замечания"        → Agent 3 → /respond
- "ФМ согласована"                 → фиксация версии
- "Покажи статус согласования"     → читает комментарии из Confluence
```

---

## 📜 СКРИПТЫ

```
scripts/
├── publish_to_confluence.py ← Обновление страницы ФМ в Confluence
├── orchestrate.sh           ← ГЛАВНЫЙ ЛАУНЧЕР (единая точка входа)
├── new_project.sh           ← Создание нового проекта из шаблона
├── fm_version.sh            ← Управление версиями (list/diff/bump/log)
├── quality_gate.sh          ← Проверка готовности к передаче
├── export_bpmn.sh           ← Экспорт BPMN (через Agent 8)
└── lib/
    └── common.sh            ← Общие функции (цвета, утилиты, проекты)
```

**Запуск:** `./scripts/orchestrate.sh` — единая точка входа для всех операций

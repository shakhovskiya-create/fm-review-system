# CLAUDE.md — Правила работы с системой FM Review Agents

> Этот файл читается Claude Code автоматически при работе с проектом.

---

## 🎯 О СИСТЕМЕ

Это система из 8 агентов для полного жизненного цикла Функциональных Моделей (ФМ) для проектов 1С: создание, проверка, публикация в Confluence.

**Файлы агентов:**
- `agents/AGENT_0_CREATOR.md` — создание ФМ с нуля
- `agents/AGENT_1_ARCHITECT.md` — полный аудит ФМ (бизнес + 1С)
- `agents/AGENT_2_ROLE_SIMULATOR.md` — симуляция ролей
- `agents/AGENT_3_DEFENDER.md` — защита от замечаний
- `agents/AGENT_4_QA_TESTER.md` — генерация тестов
- `agents/AGENT_5_TECH_ARCHITECT.md` — проектирование и ТЗ
- `agents/AGENT_6_PRESENTER.md` — презентации, экспорт
- `agents/AGENT_7_PUBLISHER.md` — управление ФМ в Confluence (публикация, версионность)

**Confluence ресурсы:**
- `docs/CONFLUENCE_TEMPLATE.md` - шаблон Confluence-страницы ФМ (XHTML, макросы, панели)
- `docs/CONFLUENCE_REQUIREMENTS.md` - требования к публикации в Confluence
- `scripts/publish_to_confluence.py` - обновление Confluence (v3.0, с блокировками и бекапами)
- `scripts/import_docx.py` - одноразовый импорт DOCX в Confluence (symlink на publish_to_confluence.py)
- `scripts/lib/confluence_utils.py` - Confluence API клиент (lock, backup, retry)
- `workflows/fm-workflows.md` - 5 сквозных сценариев (create, publish, review, update, export)
- `workflows/PIPELINE_AUTO.md` - протокол автономного конвейера в чате (все 7 агентов)

**Документация (актуальная):**
- `README.md` — описание системы
- `docs/CONTRACT_CONFLUENCE_FM.md` — контракт Confluence как единственного источника ФМ
- `docs/LEAD_AUDITOR_FULL_AUDIT.md` — последний аудит системы (AG-12...AG-15)
- `docs/FC_IMPLEMENTATION_REPORT.md` — отчет реализации FC-01...FC-06
- `docs/READINESS_CHECK.md` — проверка готовности системы к работе
- `docs/PROMPTS.md` — промпты для запуска агентов
- `docs/CHANGELOG.md` — история изменений
- `docs/CONFLUENCE_TEMPLATE.md` — шаблон страницы ФМ
- `docs/CONFLUENCE_REQUIREMENTS.md` — требования к публикации

**Артефакты Lead Architect (постоянные, НЕ затирать!):**
- `docs/FINDINGS_LEDGER.md` — реестр находок (OPEN / CLOSED / ACCEPTED_RISK)
- `docs/ARCHITECT_WORKPLAN.md` — рабочий план архитектора (дополняется, не перезаписывается)

**Self-Improvement (патчи и эволюция):**
- `.patches/` — накопленные паттерны типовых ошибок в ФМ (создаются агентами 1-5 автоматически)
- `.patches/README.md` — шаблон и категории тегов
- `.patches/EVOLUTION_LOG.md` — лог всех эволюций агентов
- `agents/EVOLVE.md` — инструкции команды /evolve (анализ патчей → обновление агентов)
- `docs/PATCH_INSTRUCTIONS.md` — правила записи патчей для агентов

**Рабочие файлы (обновляются автоматически):**
- `docs/PROJECT_CONTEXT.md` — контекст проекта, находки, решения
- `docs/WORKPLAN.md` — план работ, статус задач

**Governance (обязательный протокол):**
- `AGENT_PROTOCOL.md` — обязательный workflow каждого агента (старт → работа → итог → handoff)
- `HANDOFF.md` — передача контекста между сессиями (что сделано, что дальше, блокеры)
- `DECISIONS.md` — журнал решений (ADR-lite: проблема → варианты → выбор → последствия)
- `logs/` — пошаговые логи работы агентов (формат в AGENT_PROTOCOL.md)

**Автономный пайплайн:**
- `scripts/run_agent.py` — автономный запуск агентов через Claude Code CLI (`claude -p`)

**Экспериментальные модули:**
- `scripts/experimental/contract_validator.py` — валидация JSON-выходов (отложено)

---

## 🗣️ NATURAL LANGUAGE ROUTER

```
┌─────────────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛЬ ГОВОРИТ НА ЕСТЕСТВЕННОМ ЯЗЫКЕ.               │
│  CLAUDE CODE ОПРЕДЕЛЯЕТ АГЕНТА АВТОМАТИЧЕСКИ.              │
└─────────────────────────────────────────────────────────────┘

МАРШРУТИЗАЦИЯ ПО КЛЮЧЕВЫМ ФРАЗАМ:

"Создай ФМ для...", "Новая ФМ", "Давай опишем процесс..."
  → Agent 0 (Creator) → /new

"Запусти аудит", "Проверь ФМ", "Какие проблемы в ФМ?"
  → Agent 1 (Architect) → /audit

"Как это будет для пользователя?", "Покажи UX", "Симулируй..."
  → Agent 2 (Simulator) → /simulate-all

"Вот замечания от бизнеса", "Проанализируй замечания", "Ответь на..."
  → Agent 3 (Defender) → /respond

"Создай тесты", "Какие тест-кейсы?", "Протестируй ФМ"
  → Agent 4 (QA) → /generate-all

"Спроектируй архитектуру", "Как это реализовать в 1С?", "Сделай ТЗ"
  → Agent 5 (Tech Architect) → /full

"Подготовь презентацию", "Отчёт для руководства", "Резюме проекта"
  → Agent 6 (Presenter) → /present

"Опубликуй в Confluence", "Опубликуй ФМ", "Залей в конф"
  → Agent 7 (Publisher) → /publish

"Отправь на согласование", "Статус согласования"
  → Бизнес-согласование workflow (см. секцию ниже)

"Полный цикл", "Запусти всё", "Конвейер", "Запусти полный цикл ФМ..."
  → Прочитай workflows/PIPELINE_AUTO.md и выполни протокол конвейера в чате
  → Порядок: Agent 1→2→4→5 → Quality Gate → 7→6 → /evolve (все этапы показываются в диалоге)

"Улучши агентов", "Обнови правила", "Эволюция", "/evolve"
  → Прочитай agents/EVOLVE.md и выполни анализ патчей из .patches/

ЕСЛИ НЕПОНЯТНО — спроси: "Уточните: вы хотите [вариант 1] или [вариант 2]?"
```

---

## 📋 ОБЩИЕ ПРАВИЛА ДЛЯ ВСЕХ АГЕНТОВ

### 1. Диалоговый режим

```
┌─────────────────────────────────────────────────────────────┐
│  ИНТЕРВЬЮ = ЖИВОЙ ДИАЛОГ, НЕ АНКЕТА!                       │
├─────────────────────────────────────────────────────────────┤
│  ❌ НЕ ДЕЛАТЬ:                                              │
│     - Выдавать все вопросы сразу                           │
│     - Формировать таблицы с вопросами                      │
│     - Показывать "план интервью"                           │
│                                                             │
│  ✅ ДЕЛАТЬ:                                                  │
│     - Задавать 1-2 вопроса за раз                          │
│     - Ждать ответа                                          │
│     - Уточнять если ответ неполный                         │
│     - Переходить к следующему только после ответа          │
└─────────────────────────────────────────────────────────────┘
```

### 2. Формат вопросов — ВСЕГДА AskUserQuestion

```
┌─────────────────────────────────────────────────────────────┐
│  ⚠️  АБСОЛЮТНОЕ ПРАВИЛО:                                    │
│  ЛЮБОЙ ВОПРОС К ПОЛЬЗОВАТЕЛЮ = AskUserQuestion             │
│  НИКОГДА не задавать вопросы текстом в чате!               │
│  Вопрос без AskUserQuestion = вопрос в пустоту.            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Задавать вопрос текстом в чате (пользователь          │
│       не сможет удобно ответить)                           │
│     - Открытые вопросы без вариантов                       │
│     - Текстовые меню "Ваш выбор (1-5):" в чате            │
│     - Длинные текстовые объяснения перед вопросом          │
│     - Оставлять вопрос "висеть" без виджета                │
│                                                             │
│  ✅ ВСЕГДА ДЕЛАТЬ:                                          │
│     - Вызывать AskUserQuestion для ЛЮБОГО вопроса          │
│     - Варианты с кратким описанием                         │
│     - Один вариант рекомендуется (⭐ в описании)            │
│     - Последний вариант всегда "Другое"                    │
│     - Группировать связанные вопросы в табы                │
│                                                             │
│  КОГДА ВЫЗЫВАТЬ:                                            │
│     - Нужно уточнение требований → AskUserQuestion         │
│     - Есть несколько вариантов → AskUserQuestion            │
│     - Нужно подтверждение действия → AskUserQuestion        │
│     - Простой да/нет → AskUserQuestion                      │
│     - Любой другой вопрос → AskUserQuestion                │
└─────────────────────────────────────────────────────────────┘
```

**Правила AskUserQuestion:**
- Формулируй вопрос с конкретными вариантами и кратким описанием каждого
- Один вариант помечай "⭐ рекомендуется" с обоснованием в описании
- Всегда добавляй вариант "Другое" для свободного ответа
- НИКОГДА не выполняй необратимые действия без подтверждения
- Пользователь должен иметь возможность ответить одним кликом
- Если сомневаешься, нужен ли AskUserQuestion - НУЖЕН

**ПРАВИЛО:** Пользователь должен иметь возможность ответить ОДНИМ КЛИКОМ. Не заставляй писать развернутые ответы.

### 3. Правило формата ФМ

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ РЕДАКТИРОВАНИИ ФМ:                                     │
│                                                             │
│  ❌ НЕЛЬЗЯ без явного указания:                             │
│     - Менять структуру документа                            │
│     - Менять оформление (шрифты, отступы, стили)           │
│     - Менять формат таблиц                                  │
│     - Переименовывать разделы                               │
│     - Менять нумерацию                                      │
│                                                             │
│  ✅ МОЖНО:                                                   │
│     - Менять СОДЕРЖАНИЕ (текст, правила, логику)           │
│     - Добавлять новые пункты В СУЩЕСТВУЮЩЕМ формате        │
│     - Исправлять ошибки в тексте                           │
│                                                             │
│  Если нужно изменить формат — СНАЧАЛА СПРОСИ!              │
└─────────────────────────────────────────────────────────────┘
```

### 4. Единственный источник истины - Confluence

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE = ЕДИНСТВЕННЫЙ ИСТОЧНИК ФМ                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ ВСЕ АГЕНТЫ:                                             │
│     - ЧИТАЮТ ФМ из Confluence (REST API, PAGE_ID)           │
│     - Правки в Confluence вносит только Agent 7 (PUT тела)  │
│     - Агенты 0-5 передают изменения Agent 7 для публикации  │
│     - Версионность = встроенная Confluence (page versions)  │
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Читать ФМ из Word/DOCX как источник актуальной ФМ     │
│     - Использовать FM_DOCUMENTS/*.docx как источник правды  │
│     - Создавать новые версии .docx как актуальную ФМ        │
│     - Ссылаться на Word как на "актуальную версию"          │
│                                                             │
│  ИНСТРУМЕНТЫ:                                               │
│     - scripts/publish_to_confluence.py — первичный импорт  │
│     - scripts/export_from_confluence.py — экспорт PDF/Word │
│     - Confluence REST API — чтение/запись через Python      │
│                                                             │
│  CONFLUENCE API:                                             │
│     URL: https://confluence.ekf.su                          │
│     API: /rest/api/content/{PAGE_ID}                       │
│     Auth: Bearer token (PAT)                               │
│     Формат: XHTML storage                                  │
└─────────────────────────────────────────────────────────────┘
```

**КОНФЛУЕНС — ЕДИНСТВЕННЫЙ ИСТОЧНИК ПРАВДЫ (канон):**

```
1. ИСТОЧНИК: Confluence = единственный источник правды по ФМ.
   Все читают ФМ оттуда; все правки формируются для внесения туда.
   Тело страницы обновляет только Agent 7.

2. ВЕРСИОННОСТЬ: Полностью ведётся в Confluence.
   При каждом PUT — автоинкремент version.number;
   история версий доступна в UI (Page History).

3. ДАТА: В мета-таблице на странице дата = текущая дата при обновлении
   (ставится автоматически при публикации).

4. ТАБЛИЦА ИЗМЕНЕНИЙ: На странице ФМ ведётся таблица "История версий"
   (колонки: Номер | Дата | Автор | Изменения).
   При каждом обновлении в неё добавляется строка с кратким описанием
   изменений. Плюс version.message в API — краткое описание версии.
   ЖЕСТКИЕ ПРАВИЛА для таблицы "История версий":
   - Автор: ВСЕГДА "Шаховский А.С." (НЕ имя агента, НЕ "Claude", НЕ "Bot")
   - Описание: ТОЛЬКО бизнес-язык (НЕ коды типа CRIT-001, НЕ технические ID)
   - Описание должно быть понятно бизнес-пользователю без аудиторского отчета
```

**РАБОТА С ФМ В CONFLUENCE:**

```bash
# Чтение ФМ из Confluence (Python)
python3 -c "
import json, urllib.request, ssl
ssl._create_default_https_context = ssl._create_unverified_context
url = 'https://confluence.ekf.su/rest/api/content/PAGE_ID?expand=body.storage,version'
req = urllib.request.Request(url, headers={'Authorization': 'Bearer TOKEN'})
data = json.loads(urllib.request.urlopen(req).read())
print(data['body']['storage']['value'])  # XHTML контент ФМ
"

# Экспорт ФМ в PDF/Word (из Confluence)
python3 scripts/export_from_confluence.py --both

# Первичный импорт (только один раз, legacy)
# python3 scripts/publish_to_confluence.py path/to/source.docx
```

**ПРАВИЛА:**
- Confluence-страница = актуальная версия ФМ; все читают оттуда, правки вносятся туда (через Agent 7).
- Версионность ведётся в Confluence; дата в мета-таблице — автоматически при обновлении.
- Каждое обновление: новая строка в таблице «История версий» на странице с кратким описанием изменений.
- Экспорт в PDF/Word — только для чтения офлайн.

### 5. Правила текста и форматирования (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛА ОФОРМЛЕНИЯ ТЕКСТА В ДОКУМЕНТАХ:                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. ТИРЕ И ДЕФИСЫ:                                          │
│     ❌ НИКОГДА не использовать длинное тире (—)             │
│     ✅ ВСЕГДА использовать обычный дефис (-)                │
│     Пример: "Заказ - это документ" (НЕ "Заказ — это...")   │
│                                                             │
│  2. БУКВА Ё:                                                │
│     ❌ НИКОГДА не использовать букву "ё"                    │
│     ✅ ВСЕГДА заменять на "е"                               │
│     Пример: "Отчеты" (НЕ "Отчёты"), "Расчеты" (НЕ "Расчёты")│
│                                                             │
│  3. ПУНКТУАЦИЯ В СПИСКАХ:                                   │
│     ✅ В перечислениях использовать точку с запятой (;)     │
│     ✅ В конце последнего элемента - точку (.)              │
│     Пример:                                                 │
│       - Первый пункт;                                       │
│       - Второй пункт;                                       │
│       - Последний пункт.                                    │
│                                                             │
│  4. ГРАММАТИКА И ПУНКТУАЦИЯ:                                │
│     ✅ Постоянно проверять грамматику ОЧЕНЬ тщательно       │
│     ✅ Проверять пунктуацию в каждом предложении            │
│     ✅ Избегать канцелярита и технических терминов          │
│     ✅ Писать для бизнеса, не для программистов             │
│                                                             │
│  5. СТИЛЬ ИЗЛОЖЕНИЯ:                                        │
│     ✅ Простой, понятный язык                               │
│     ✅ Короткие предложения                                 │
│     ❌ Избегать: "является единственным источником истины"  │
│     ✅ Использовать: "используется для принятия решений"    │
│                                                             │
│  ⚠️  ЭТИ ПРАВИЛА ПРИМЕНЯЮТСЯ КО ВСЕМ ДОКУМЕНТАМ!           │
└─────────────────────────────────────────────────────────────┘

### 6. Язык и терминология в ФМ

┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: ТОЛЬКО РУССКИЙ ЯЗЫК, БЕЗ АНГЛИЦИЗМОВ             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО использовать:                                 │
│     - Англицизмы: race condition, deadlock, timeout         │
│     - Технический сленг: дебаг, коммит, пуш, merge         │
│     - IT-термины: callback, workflow, pipeline              │
│                                                             │
│  ✅ ИСПОЛЬЗОВАТЬ русские эквиваленты:                       │
│     - race condition → конфликт параллельных операций       │
│     - deadlock → взаимная блокировка                        │
│     - timeout → превышение времени ожидания                 │
│     - rollback → откат изменений                            │
│     - commit → фиксация / проведение                        │
│     - debug → отладка                                       │
│                                                             │
│  ИСКЛЮЧЕНИЯ (допустимы):                                    │
│     - Названия полей 1С: "Проведен", "ПометкаУдаления"     │
│     - Названия объектов: "Документ.ЗаказКлиента"           │
│     - SQL, API — только в технических примерах кода         │
│                                                             │
│  ПРИЧИНА:                                                   │
│  ФМ читают бизнес-пользователи, не программисты.           │
│  Англицизмы снижают понятность и вызывают вопросы.         │
└─────────────────────────────────────────────────────────────┘
```

### 7. Версионирование ФМ

```
X.Y.Z где:
- X — мажорная версия (новый процесс)
- Y — минорная версия (новые разделы/функции)
- Z — патч (исправления, уточнения)

Примеры:
- 1.0.0 → 1.0.1 (патч после аудита)
- 1.0.1 → 1.1.0 (добавлен новый раздел)
- 1.1.0 → 2.0.0 (переделан весь процесс)
```

### 8. Применение изменений (/apply)

```
┌─────────────────────────────────────────────────────────────┐
│  КРИТИЧНО: ИНТЕГРИРОВАТЬ ИЗМЕНЕНИЯ СРАЗУ В ОСНОВНОЙ ТЕКСТ! │
├─────────────────────────────────────────────────────────────┤
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Создавать разделы "ДОПОЛНЕНИЯ И УТОЧНЕНИЯ"           │
│     - Добавлять изменения в конец документа отдельным блоком│
│     - Оставлять изменения "на потом для интеграции"        │
│     - Создавать приложения с изменениями                    │
│                                                             │
│  ✅ ВСЕГДА:                                                  │
│     - Интегрировать изменения СРАЗУ в основной текст        │
│     - Редактировать существующие пункты документа           │
│     - Готовый документ с интегрированными изменениями       │
│     - Пользователь получает финальный документ, не черновик │
└─────────────────────────────────────────────────────────────┘

ПОСЛЕ АУДИТА/АНАЛИЗА:

1. Показал список проблем/замечаний
2. СРАЗУ СПРАШИВАЮ:
   "Внести изменения в ФМ и создать версию X.Y.Z?"

3. Если пользователь говорит ДА:
   - Уточняю: "Какие замечания применить? Все / Только критические / Конкретные номера"
   - Вношу изменения СРАЗУ В ОСНОВНОЙ ТЕКСТ документа (СОХРАНЯЯ ФОРМАТ!)
   - Нахожу соответствующие пункты и редактирую их напрямую
   - Создаю новую версию файла
   - Показываю список изменений

4. Формат вывода:
   "Создана версия X.Y.Z. Изменения:
    - п. 3.4: [что изменено]
    - п. 3.7: [что изменено]
    - ..."
```

### 9. Обязательные метаданные при /apply

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ ОБНОВЛЕНИИ ФМ В CONFLUENCE — ТРИ МЕСТА НА СТРАНИЦЕ:    │
│  ВСЕ ТРИ ОБЯЗАТЕЛЬНЫ. ПРОПУСК ЛЮБОГО = ОШИБКА.             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. МЕТА-БЛОК (строка вверху: "Код | Версия | Дата"):      │
│     → ОБНОВИТЬ версию (1.0.0 → 1.0.1)                     │
│     → ОБНОВИТЬ дату на текущую                             │
│     ⚠️ ФОРМАТ: "Версия:</strong> X.Y.Z | Дата: ДД.ММ.ГГГГ"│
│     ⚠️ ИСКАТЬ ТОЧНЫЙ ПАТТЕРН В XHTML, НЕ ПОЛАГАТЬСЯ       │
│        НА ОБЩИЕ РЕГУЛЯРКИ ТИПА >X.Y.Z<                     │
│                                                             │
│  2. МЕТА-ТАБЛИЦА (Версия/Дата/Статус/Автор):                │
│     → ОБНОВИТЬ ячейку "Версия" на новую (1.0.1)           │
│     → ОБНОВИТЬ ячейку "Дата" на текущую                   │
│     → НЕ ТРОГАТЬ Статус и Автор                            │
│                                                             │
│  3. ТАБЛИЦА "ИСТОРИЯ ВЕРСИЙ" (Номер/Дата/Автор/Изменения): │
│     → ДОБАВИТЬ новую строку В КОНЕЦ (не удаляя старые!)    │
│                                                             │
│     АВТОР: ВСЕГДА "Шаховский А.С."                         │
│     ❌ НИКОГДА не писать "Agent X", "Claude", "Bot" и т.д. │
│     ❌ НИКОГДА не писать имя агента как автора              │
│     Автор ФМ - человек, агенты - инструмент.               │
│                                                             │
│     ОПИСАНИЕ: Бизнес-язык, понятный человеку.              │
│     ✅ "Устранены противоречия в формулах, исправлены      │
│        ссылки, добавлены недостающие определения"           │
│     ✅ "Уточнены SLA, добавлен план отката пилота"         │
│     ❌ ЗАПРЕЩЕНО: коды (CRIT-001, HIGH-003), ID правок     │
│     ❌ ЗАПРЕЩЕНО: технический жаргон (fix, audit, patch)    │
│     ❌ ЗАПРЕЩЕНО: "30 правок", "v38", номера версий Confl.  │
│     Бизнес-пользователь должен понять суть изменений       │
│     БЕЗ чтения аудиторского отчета.                        │
│                                                             │
│     ❌ НЕ ЗАТИРАТЬ предыдущие строки таблицы                │
│                                                             │
│  4. ВЕРСИЯ CONFLUENCE                                       │
│     - Автоинкремент при каждом PUT                         │
│     - version.message: "[FM X.Y.Z] краткое описание"       │
│                                                             │
│  ⚠️ ЧЕКЛИСТ ПЕРЕД PUT (проверить все 3 места!):             │
│     □ Мета-блок: версия + дата обновлены?                  │
│     □ Мета-таблица: версия + дата обновлены?               │
│     □ История: строка добавлена?                           │
│     □ История: автор = "Шаховский А.С."?                   │
│     □ История: описание на бизнес-языке, без кодов?        │
│     □ Старые строки истории на месте?                      │
│                                                             │
│  ⚠️ ВЕРИФИКАЦИЯ ЧЕРЕЗ API ПОСЛЕ PUT:                        │
│     - GET страницы, проверить ВСЕ 3 места                  │
│     - Убедиться что МЕТА-БЛОК обновлен (не только таблица!)│
│     - Убедиться что автор = "Шаховский А.С."              │
│     - Убедиться что описание без кодов                     │
└─────────────────────────────────────────────────────────────┘
```

### 10. Верификация изменений (КРИТИЧНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: НЕ ОТМЕЧАТЬ ✅ БЕЗ РЕАЛЬНОЙ ПРОВЕРКИ!            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Отмечать ✅ на основе "скрипт выполнился"            │
│     - Писать "Готово" без верификации                      │
│     - Доверять автоматическим проверкам без перепроверки   │
│                                                             │
│  ✅ ОБЯЗАТЕЛЬНО:                                            │
│     - После обновления — GET страницы из Confluence        │
│     - Искать ОТСУТСТВИЕ старых значений в XHTML            │
│     - Проверять НАЛИЧИЕ новых значений в контенте          │
│     - Проверять version.number (должен инкрементироваться) │
│                                                             │
│  ОБЯЗАТЕЛЬНЫЕ ПРОВЕРКИ МЕТАДАННЫХ (каждый PUT!):            │
│  □ Мета-блок (верхняя строка): версия + дата обновлены     │
│  □ Мета-таблица: версия + дата обновлены                   │
│  □ История версий: автор = "Шаховский А.С." (НЕ агент!)   │
│  □ История версий: описание на бизнес-языке, без кодов     │
│  Если любая проверка не прошла - ИСПРАВИТЬ ДО завершения!  │
│                                                             │
│  АЛГОРИТМ ВЕРИФИКАЦИИ:                                      │
│  1. PUT обновление в Confluence                            │
│  2. GET страницы: проверить ВСЕ правки в XHTML             │
│  3. Проверить ОТСУТСТВИЕ старых значений                   │
│  4. Если что-то не найдено — ИСПРАВЛЯЕМ, а не игнорируем   │
│  5. Только после 2+3+4 отмечаем ✅                          │
└─────────────────────────────────────────────────────────────┘
```

### 11. Версионность в Confluence

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE = ВСТРОЕННАЯ ВЕРСИОННОСТЬ:                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  - Каждый PUT = новая версия (автоинкремент)               │
│  - История всех версий доступна через UI и API             │
│  - Откат к любой предыдущей версии                         │
│  - Комментарий к версии: описание изменений                │
│                                                             │
│  ⚠️ ПЕРЕД КРУПНЫМИ ИЗМЕНЕНИЯМИ:                             │
│     - Зафиксировать текущую version.number                  │
│     - После изменений — проверить version.number + 1       │
│     - При ошибке — откатить через Confluence UI             │
└─────────────────────────────────────────────────────────────┘
```

### 12. Нумерация в документах

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: Только цифровая нумерация (1., 1.1., 1.1.1.)      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Смесь цифр и букв: 3.2а., 3.4б.                       │
│     - Текстовая нумерация (просто текст "1." в начале)      │
│                                                             │
│  ✅ ИСПОЛЬЗОВАТЬ:                                           │
│     - Только цифры: 1., 1.1., 1.1.1., ...                   │
│     - При добавлении раздела - перенумеровать               │
└─────────────────────────────────────────────────────────────┘
```

### 13. Файл изменений (CHANGES.md) - ОБЯЗАТЕЛЬНО!

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ КАЖДОМ /apply СОЗДАВАТЬ ФАЙЛ ИЗМЕНЕНИЙ:                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ФОРМАТ ИМЕНИ:                                              │
│     FM-[NAME]-v[X.Y.Z]-CHANGES.md                           │
│     Пример: FM-LS-PROFIT-v1.0.1-CHANGES.md                  │
│                                                             │
│  СОДЕРЖАНИЕ:                                                │
│  1. Заголовок с датой, агентом, задачей                    │
│  2. Таблица изменений (ID, Где, Было, Стало, Причина)      │
│  3. Не применённые изменения (LOW) с причинами             │
│  4. Решения по уточняющим вопросам                         │
│  5. Результат верификации (чек-лист ✅)                     │
│                                                             │
│  ⚠️ СОЗДАВАТЬ СРАЗУ ПОСЛЕ ВЕРИФИКАЦИИ, ДО ОТЧЁТА ЮЗЕРУ!    │
│                                                             │
│  📁 КУДА СОХРАНЯТЬ (AG-06): PROJECT_[NAME]/CHANGES/         │
│     При отсутствии папки CHANGES/ - создать ее              │
└─────────────────────────────────────────────────────────────┘
```

### 14. Хранилище ФМ и результатов (в папке проекта)

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДАЯ ФМ = ОТДЕЛЬНЫЙ ПРОЕКТ В ПАПКЕ PROJECT_[NAME]/       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  СТРУКТУРА ПРОЕКТА (локальная):                             │
│     PROJECT_[NAME]/                                         │
│     ├── README.md                    ← Обзор проекта        │
│     ├── CONFLUENCE_PAGE_ID           ← ID страницы ФМ       │
│     ├── CHANGES/                     ← Списки изменений     │
│     │   └── FM-*-CHANGES.md          ← Логи правок          │
│     │                                                       │
│     ├── AGENT_1_ARCHITECT/           ← Результаты аудита    │
│     ├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей      │
│     ├── AGENT_3_DEFENDER/            ← Ответы на замечания  │
│     ├── AGENT_4_QA_TESTER/           ← Тест-кейсы           │
│     ├── AGENT_5_TECH_ARCHITECT/      ← ТЗ и архитектура     │
│     └── REPORTS/                     ← Итоговые отчеты      │
│                                                             │
│  СТРУКТУРА В CONFLUENCE (зеркало):                          │
│     [Проект]                                                │
│     ├── Функциональные модели                               │
│     │   └── FM-[NAME]                ← страница ФМ          │
│     ├── ТЗ и Архитектура                                    │
│     │   ├── TS-FM-[NAME]             ← техзадание           │
│     │   └── ARC-FM-[NAME]            ← архитектура          │
│     ├── Тестирование                                        │
│     │   └── TC-FM-[NAME]             ← тест-план            │
│     └── Отчеты                                              │
│         └── RPT-FM-[NAME]            ← итоговый отчет       │
│                                                             │
│  ПРИ РАБОТЕ С ФМ:                                           │
│  1. Определить проект: PROJECT_[NAME]/                      │
│  2. ФМ читать/писать ТОЛЬКО через Confluence REST API       │
│  3. Результаты роли → PROJECT_[NAME]/AGENT_X_[ROLE]/        │
│  4. Обновлять PROJECT_[NAME]/README.md при изменениях       │
│                                                             │
│  ❌ НЕ хранить ФМ и результаты в корне fm-review-system/!   │
└─────────────────────────────────────────────────────────────┘
```

### 15. Предварительный обзор перед правками

```
┌─────────────────────────────────────────────────────────────┐
│  ПЕРЕД ВНЕСЕНИЕМ ПРАВОК В CONFLUENCE:                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ШАГ 1: ПОКАЗАТЬ ПЛАН ИЗМЕНЕНИЙ                             │
│     - Список всех правок с ID                              │
│     - Для каждой: Где → Было → Станет                      │
│     - Дать пользователю возможность скорректировать        │
│                                                             │
│  ШАГ 2: ПОЛУЧИТЬ ПОДТВЕРЖДЕНИЕ                              │
│     - "Применить N правок?" или                            │
│     - Выбор конкретных номеров                             │
│                                                             │
│  ШАГ 3: ТОЛЬКО ПОСЛЕ ПОДТВЕРЖДЕНИЯ                          │
│     - Применить правки в Confluence (PUT)                   │
│     - Верифицировать (GET + проверка)                      │
│     - Создать CHANGES.md                                   │
│                                                             │
│  ❌ ЗАПРЕЩЕНО: Применять правки без показа плана!           │
└─────────────────────────────────────────────────────────────┘
```

### 16. Неприкосновенность истории версий (КРИТИЧНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ТАБЛИЦА "ИСТОРИЯ ВЕРСИЙ" = ЮРИДИЧЕСКИЙ ФАКТ               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ПРИНЦИП: ИСТОРИЯ ДОПОЛНЯЕТСЯ, НЕ РЕДАКТИРУЕТСЯ.           │
│                                                             │
│  1.1. Каждая строка таблицы - историческая фиксация        │
│       состояния документа на конкретную дату.               │
│  1.2. ЗАПРЕЩЕНО редактировать ранее зафиксированные:        │
│       - номера версий                                       │
│       - даты                                                │
│       - авторов                                             │
│       - описания                                            │
│  1.3. Изменения оформляются ТОЛЬКО через:                   │
│       - создание НОВОЙ строки с новой версией               │
│       - указание текущей даты                               │
│       - указание автора                                     │
│       - описание причины изменения                          │
│  1.4. Нарушение = критическая методологическая ошибка.      │
│                                                             │
│  ⚠️  ПРИ ПОИСКЕ-ЗАМЕНЕ В XHTML:                             │
│     - НЕ использовать глобальные регулярки по версиям       │
│       (replace_all для "1.0.2" затронет историю!)           │
│     - Заменять ТОЛЬКО в конкретных местах (мета-блок,       │
│       мета-таблица), НЕ в таблице истории                   │
│     - После замены ПРОВЕРИТЬ: все старые строки истории      │
│       сохранили исходные номера и даты                      │
│                                                             │
│  ВЕРИФИКАЦИЯ ПОСЛЕ КАЖДОГО PUT:                              │
│     □ Все строки истории на месте (кол-во строк)?           │
│     □ Даты старых строк не изменились?                      │
│     □ Номера старых версий не изменились?                   │
│     □ Описания старых строк не изменились?                  │
└─────────────────────────────────────────────────────────────┘
```

### 17. Стандарты форматирования XHTML (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ДОБАВЛЕНИЕ СТРОК/ЯЧЕЕК = КОПИРОВАНИЕ СТИЛЯ СОСЕДЕЙ        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  2.1. При добавлении строк в таблицу - КОПИРОВАТЬ           │
│       style="..." из соседних строк той же таблицы.         │
│       Не оставлять ячейки без стилей.                       │
│  2.2. При добавлении в таблицу требований - КОПИРОВАТЬ      │
│       background-color, text-align, font-weight из          │
│       соседних строк с тем же приоритетом (P1=зеленый,      │
│       P2=желтый и т.д.).                                    │
│  2.3. При добавлении в глоссарий - КОПИРОВАТЬ               │
│       background-color из заголовка или соседних строк.      │
│  2.4. Визуальная консистентность = обязательная проверка    │
│       ПЕРЕД PUT. Если добавил строку - сравни стиль         │
│       с соседними.                                          │
│                                                             │
│  2.5. Единый цвет заголовков таблиц: rgb(255,250,230).      │
│       ❌ НИКОГДА не использовать rgb(59,115,175) (синий)     │
│       ❌ НИКОГДА не создавать заголовки <th> без style=      │
│       ✅ ВСЕГДА: <th style="background-color:               │
│          rgb(255,250,230);"><strong>Текст</strong></th>      │
│  2.6. Глоссарий: НЕ использовать <strong> в ячейках         │
│       термина. Существующие записи без <strong> = стандарт.  │
│  2.7. Не добавлять в глоссарий очевидные аббревиатуры       │
│       (ФД, СБ, IT-директор и т.п.) - итак понятно.          │
│                                                             │
│  ЧЕКЛИСТ ФОРМАТИРОВАНИЯ (перед каждым PUT):                  │
│     □ У новых строк есть style, как у соседних?             │
│     □ Приоритеты (P1/P2/P3) имеют правильный фон?          │
│     □ Ширины столбцов не сломаны?                           │
│     □ Нет пустых td без стилей рядом со стилизованными?    │
│     □ ВСЕ заголовки таблиц = rgb(255,250,230)?             │
│     □ Глоссарий: нет <strong> в ячейках терминов?           │
└─────────────────────────────────────────────────────────────┘
```

### 18. Простота бизнес-языка (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ФМ = ИНСТРУМЕНТ БИЗНЕСА, НЕ АКАДЕМИЧЕСКИЙ ДОКУМЕНТ        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  3.1. Формулировки - короткие и понятные.                   │
│       ❌ "кратковременная блокировка до завершения           │
│          пересчета рентабельности, чтобы параллельные       │
│          Заказы не использовали устаревшие данные"          │
│       ✅ "при возврате - пауза на пересчет (до 30 сек.)"   │
│                                                             │
│  3.2. Запрещено усложнять без необходимости.                │
│       ❌ "Режим работы системы контроля, при котором         │
│          отклонения рассчитываются и фиксируются, но        │
│          блокировка не выполняется (только предупреждения)" │
│       ✅ "Система предупреждает, но не блокирует"           │
│                                                             │
│  3.3. Тест читаемости: если бизнес-пользователь             │
│       не поймет с первого прочтения - переписать.           │
│                                                             │
│  3.4. Детализация обучения, SLA, лимитов -                  │
│       без избыточных подробностей. ФМ фиксирует ЧТО,       │
│       а не КАК (КАК - в ТЗ на разработку).                 │
│                                                             │
│  3.5. Каждое добавление в ФМ проверять вопросом:            │
│       "Менеджер продаж это поймет?" Если нет - упростить.  │
└─────────────────────────────────────────────────────────────┘
```

### 19. Публикация документов в Confluence (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ВСЕ КЛЮЧЕВЫЕ ДОКУМЕНТЫ ПУБЛИКУЮТСЯ В CONFLUENCE            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ПРАВИЛО: Локальные файлы = рабочие черновики.              │
│  Confluence = единственный источник для стейкхолдеров.     │
│  После создания документа агент ОБЯЗАН опубликовать его    │
│  в Confluence (или передать Agent 7 для публикации).       │
│                                                             │
│  ТИПЫ ДОКУМЕНТОВ И КОДИРОВКА:                               │
│                                                             │
│  | Тип          | Префикс | Пример           | Агент     │
│  |--------------|---------|------------------|-----------|│
│  | Функц. модель| FM-     | FM-LS-PROFIT     | Agent 0/1 |│
│  | Техзадание   | TS-     | TS-FM-PROFIT     | Agent 5   |│
│  | Архитектура  | ARC-    | ARC-FM-PROFIT    | Agent 5   |│
│  | Тест-план    | TC-     | TC-FM-PROFIT     | Agent 4   |│
│  | Отчет        | RPT-    | RPT-FM-PROFIT    | Agent 6   |│
│                                                             │
│  СТРУКТУРА СТРАНИЦ В CONFLUENCE:                            │
│                                                             │
│  Проекты                                                    │
│  └── [Название проекта]            ← корень проекта        │
│      ├── Функциональные модели                              │
│      │   └── FM-[NAME]             ← страница ФМ           │
│      ├── ТЗ и Архитектура                                   │
│      │   ├── TS-FM-[NAME]          ← техзадание            │
│      │   └── ARC-FM-[NAME]         ← архитектура           │
│      ├── Тестирование                                       │
│      │   └── TC-FM-[NAME]          ← тест-план             │
│      └── Отчеты                                             │
│          └── RPT-FM-[NAME]         ← итоговый отчет        │
│                                                             │
│  ОБЯЗАТЕЛЬНО ПУБЛИКОВАТЬ:                                   │
│  ✅ ФМ (Agent 0/1 → Agent 7)                               │
│  ✅ ТЗ на разработку (Agent 5)                             │
│  ✅ Архитектуру (Agent 5)                                  │
│  ✅ Тест-план (Agent 4) — по решению пользователя          │
│  ✅ Итоговый отчет (Agent 6) — по решению пользователя     │
│                                                             │
│  ПРАВИЛА ПУБЛИКАЦИИ:                                        │
│  1. Название страницы = код документа (TS-FM-PROFIT)        │
│  2. Родительская страница = соответствующий раздел          │
│  3. Формат = XHTML storage format (как ФМ)                  │
│  4. Версионность = встроенная Confluence                    │
│  5. При обновлении документа - обновлять и в Confluence     │
│  6. PAGE_ID новых страниц фиксировать в PROJECT_CONTEXT.md │
│                                                             │
│  ПОСЛЕ ПУБЛИКАЦИИ В CONFLUENCE:                              │
│  □ PAGE_ID записан в PROJECT_CONTEXT.md                     │
│  □ Ссылка на страницу добавлена в README.md проекта        │
│  □ Документ доступен стейкхолдерам по ссылке               │
└─────────────────────────────────────────────────────────────┘
```

---

## 💾 АВТОСОХРАНЕНИЕ

> **Канон контекста проекта (AG-05):** контекст проекта хранится в `PROJECT_[NAME]/PROJECT_CONTEXT.md`. Агенты читают и обновляют только этот файл. Файл `docs/PROJECT_CONTEXT.md` — системный/архивный, при наличии проектного приоритет у проектного.

### Когда обновлять PROJECT_CONTEXT.md

```
ПОСЛЕ КАЖДОЙ КОМАНДЫ агента записывать:

### [Дата] — [АГЕНТ]: [команда]

**Проверено/Сделано:** [Что анализировалось/создавалось]

**Найдено:**
- [КОД-XXX] [Описание] → [Статус: открыто/решено]

**Решения:** [Если приняты]

**Открытые вопросы:**
- [ ] [Вопрос]
```

### Когда обновлять CHANGELOG.md

```
ОБНОВЛЯТЬ КОГДА:
- Изменена версия ФМ (/apply)
- Изменён агент
- Добавлена новая функциональность

ФОРМАТ:
## [vX.Y] — ДД.ММ.ГГГГ
### Что изменено
- Пункт 1
- Пункт 2
```

### Когда обновлять WORKPLAN.md

```
┌─────────────────────────────────────────────────────────────┐
│  ОБЯЗАТЕЛЬНО ОБНОВЛЯТЬ:                                    │
├─────────────────────────────────────────────────────────────┤
│  1. В НАЧАЛЕ сессии — записать план работ                  │
│  2. ПО ХОДУ работы — отмечать выполненное (🔴→🟡→🟢)       │
│  3. В КОНЦЕ сессии — итог, что сделано                     │
│  4. При ОБРЫВЕ — позволяет восстановить контекст           │
└─────────────────────────────────────────────────────────────┘

НЕ СПРАШИВАЙ "сохранить?" — СОХРАНЯЙ ВСЕГДА АВТОМАТИЧЕСКИ!
```

---

## 🔧 1С-ФОКУС (для AGENT_1)

При анализе каждого бизнес-правила проверять:

```
□ ПОСЛЕДОВАТЕЛЬНОСТЬ — можно ли сделать раньше/позже?
□ СОСТОЯНИЯ И ПЕРЕХОДЫ — все ли описаны? Можно ли перескочить?
□ ПРОВЕДЕНИЕ — когда контроль: до/при/после?
□ БЛОКИРОВКИ — что если два пользователя одновременно?
□ ПРАВА ДОСТУПА — кто может? А админ? А служебный?
□ ИДЕМПОТЕНТНОСТЬ — что если повторно провести?
□ ОТКАТ/СТОРНО — как отменить? Что с зависимыми данными?
□ ИНТЕГРАЦИИ — что если лаг/недоступность/ошибка?
□ ФОНОВЫЕ ЗАДАНИЯ — что в фоне? Что если не отработало?
□ АУДИТ — как найти кто/когда/что сделал?
```

---

## 🚫 АНТИПАТТЕРНЫ (искать и отмечать)

```
❌ "Требуется согласование" там, где можно автоправило
❌ "Запрещено" там, где нужно "разрешено с контролем"
❌ Цепочки согласований больше 2 уровней
❌ Ручные проверки того, что можно проверить автоматом
❌ "Молчание = отказ" для позитивных кейсов
❌ Контроль только на UI (обходится через API)
❌ Отсутствие дефолтов (что если не ответили?)
```

---

## 🎭 ГЛАВНЫЙ ПРИНЦИП

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   КОНТРОЛЬ НЕ ДОЛЖЕН ТОРМОЗИТЬ ОСНОВНОЙ БИЗНЕС-ПРОЦЕСС    │
│                                                             │
│   При каждом замечании/предложении спрашивай себя:         │
│   "Это ускоряет или замедляет продажи/операции?"           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 СТРУКТУРА ПРОЕКТА

```
fm-review-system/
├── CLAUDE.md                 ← Этот файл (правила, читается Claude Code автоматически)
├── README.md                 ← Описание системы
├── .env.example              ← Шаблон переменных окружения (скопировать в .env)
│
├── agents/                   ← 7 АГЕНТОВ
│   ├── AGENT_0_CREATOR.md    ← Создание ФМ
│   ├── AGENT_1_ARCHITECT.md  ← Аудит ФМ
│   ├── AGENT_2_ROLE_SIMULATOR.md ← Симуляция ролей
│   ├── AGENT_3_DEFENDER.md   ← Защита ФМ
│   ├── AGENT_4_QA_TESTER.md  ← Тестирование
│   ├── AGENT_5_TECH_ARCHITECT.md ← Проектирование + ТЗ
│   ├── AGENT_6_PRESENTER.md  ← Презентации
│   └── AGENT_7_PUBLISHER.md  ← Публикация в Confluence
│
├── docs/                     ← ДОКУМЕНТАЦИЯ (актуальная)
│   ├── PROMPTS.md            ← Промпты для запуска
│   ├── CHANGELOG.md          ← История изменений
│   ├── CONFLUENCE_TEMPLATE.md← Шаблон страницы ФМ (XHTML)
│   ├── CONFLUENCE_REQUIREMENTS.md ← Требования к публикации
│   ├── CONTRACT_CONFLUENCE_FM.md ← Контракт Confluence-only
│   ├── LEAD_AUDITOR_FULL_AUDIT.md ← Последний аудит (AG-12...AG-15)
│   ├── READINESS_CHECK.md    ← Проверка готовности
│   ├── FC_IMPLEMENTATION_REPORT.md ← Отчет реализации FC-01...FC-06
│   ├── PROJECT_CONTEXT.md    ← Контекст проекта (авто)
│   └── WORKPLAN.md           ← План работ (авто)
│
├── projects/                 ← РАБОЧИЕ ПРОЕКТЫ
│   ├── PROJECT_SHPMNT_PROFIT/← Контроль рентабельности
│   └── PROJECT_SALES_PIPELINE/← Проектные продажи
│
├── schemas/                  ← JSON-схемы (agent-contracts.json v2.1)
├── templates/                ← Шаблоны страниц
├── workflows/                ← Сквозные сценарии
└── scripts/                  ← Скрипты и утилиты
    ├── run_agent.py           ← Автономный запуск агентов (claude -p, --pipeline)
    ├── publish_to_confluence.py ← Обновление Confluence (v3.0)
    ├── import_docx.py         ← Одноразовый импорт DOCX (symlink)
    ├── lib/
    │   ├── common.sh          ← Общие bash-функции
    │   └── confluence_utils.py← Confluence API клиент (lock/backup/retry)
    └── experimental/          ← Неактивные модули (contract_validator.py)
```

---

## 📂 ПРОЕКТЫ (ПАПКИ PROJECT_*)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО РАБОТЫ С ПРОЕКТАМИ                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Если задача относится к ФМ в ПРОЕКТЕ (папка PROJECT_*):   │
│                                                             │
│  1. ФМ читать/писать ТОЛЬКО из Confluence (REST API)        │
│  2. Результаты роли → PROJECT_*/AGENT_X_[ROLE]/             │
│  3. Обновлять PROJECT_*/README.md при изменениях            │
│                                                             │
│  АГЕНТЫ РАБОТАЮТ ТАК:                                       │
│  - AGENT_1 (аудит) → PROJECT_*/AGENT_1_ARCHITECT/           │
│  - AGENT_2 (роли)  → PROJECT_*/AGENT_2_ROLE_SIMULATOR/      │
│  - AGENT_3 (защита)→ PROJECT_*/AGENT_3_DEFENDER/            │
│  - AGENT_4 (тесты) → PROJECT_*/AGENT_4_QA_TESTER/           │
│  - AGENT_5 (ТЗ)    → PROJECT_*/AGENT_5_TECH_ARCHITECT/      │
│                                                             │
│  Каждый проект = отдельная ФМ с полной историей работы     │
└─────────────────────────────────────────────────────────────┘
```

### Текущие проекты

| Папка | ФМ | Статус | Описание |
|-------|-----|--------|----------|
| `projects/PROJECT_SHPMNT_PROFIT/` | FM-LS-PROFIT v1.0 | Готов к разработке | Контроль рентабельности при частичных отгрузках |
| `projects/PROJECT_SALES_PIPELINE/` | — | Планирование | Оптимизация воронки, стадии, сметы |

### Когда создавать проект

```
СОЗДАВАТЬ ПРОЕКТ PROJECT_[NAME]/, если:
- Новая ФМ (отдельная тематика)
- Полноценная функциональная модель (не мини-ФМ)
- Требуется работа нескольких агентов

СТРУКТУРА ПРОЕКТА (локальная):
PROJECT_[NAME]/
├── README.md                    ← Обзор проекта + Confluence PAGE_ID
├── CONFLUENCE_PAGE_ID           ← ID страницы ФМ в Confluence
├── CHANGES/                     ← Списки изменений
│   └── FM-*-CHANGES.md          ← Что менялось в каждой версии
├── AGENT_1_ARCHITECT/           ← Отчеты аудита
├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей
├── AGENT_3_DEFENDER/            ← Ответы на замечания
├── AGENT_4_QA_TESTER/           ← Тест-кейсы
├── AGENT_5_TECH_ARCHITECT/      ← ТЗ и архитектура
└── REPORTS/                     ← Итоговые отчеты

СТРУКТУРА В CONFLUENCE (зеркало):
[Проект]
├── Функциональные модели / FM-[NAME]
├── ТЗ и Архитектура / TS-FM-[NAME], ARC-FM-[NAME]
├── Тестирование / TC-FM-[NAME]
└── Отчеты / RPT-FM-[NAME]

ВСЕ КЛЮЧЕВЫЕ ДОКУМЕНТЫ ПУБЛИКУЮТСЯ В CONFLUENCE!
См. правило 19 в CLAUDE.md
```

---

## 🚀 ЗАПУСК АГЕНТА

```
1. Определить проект: projects/PROJECT_[NAME]/
2. Загрузить файл агента из agents/AGENT_X_NAME.md
3. Прочитать ФМ из Confluence (REST API, PAGE_ID из проекта)
4. Выполнить команду (/audit, /new, /tz, и т.д.)
5. Отвечать на вопросы в диалоговом режиме
6. После анализа - /apply для внесения изменений в Confluence
7. Результаты сохраняются в projects/PROJECT_[NAME]/AGENT_X_*/
```

Полный список команд — см. `docs/PROMPTS.md`

---

## 🔄 PIPELINE (КОНВЕЙЕР АГЕНТОВ)

### Запуск конвейера в чате (рекомендуется)

```
Скажите: "Запусти полный цикл ФМ FM-LS-PROFIT"

Claude прочитает workflows/PIPELINE_AUTO.md и последовательно выполнит
все этапы прямо в чате, показывая диалог и результаты каждого агента.

ИНТЕРАКТИВНЫЙ РЕЖИМ: конвейер НЕ слепо автономный!
- При каждом решении/развилке — варианты с рекомендацией аналитика
- Пользователь выбирает номер — конвейер продолжается
- Технические действия (чтение, запись, API) — автоматически
```

### Запуск конвейера скриптом (фоновый, без диалога)

```bash
# Полный конвейер (все агенты как отдельные процессы):
python3 scripts/run_agent.py --pipeline --project PROJECT_SHPMNT_PROFIT

# Выборочные агенты:
python3 scripts/run_agent.py --pipeline --project PROJECT_SHPMNT_PROFIT --agents 1,2,4
```

### Схема конвейера

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE-ONLY КОНВЕЙЕР:                                 │
│                                                             │
│  === ЭТАП 1: СОЗДАНИЕ (Confluence) ===                     │
│  Agent 0 (Creator)     → создание контента ФМ в Confluence │
│                                                             │
│  === ЭТАП 2: ВНУТРЕННИЙ РЕВЬЮ (Confluence) ===             │
│  Agent 1 (Architect)   → аудит → /apply → FM v1.1          │
│         ↓                                                    │
│  Agent 2 (Simulator)   → UX → /apply → FM v1.2             │
│         ↓                                                    │
│  Agent 4 (QA Tester)   → тесты → /apply → FM v1.3          │
│         ↓                                                    │
│  Agent 5 (Tech Arch)   → архитектура + ТЗ → FM v1.4        │
│         ↓                + публикация TS-FM-* и ARC-FM-*    │
│  Quality Gate          → проверка готовности                │
│                                                             │
│  === ЭТАП 3: ПУБЛИКАЦИЯ (Confluence) ===                   │
│  Agent 7 (Publisher)   → ПУБЛИКАЦИЯ ФМ В CONFLUENCE         │
│                          Страница FM-* + версионность       │
│                          + проверка TS-*/ARC-* опубликованы │
│                                                             │
│  === ЭТАП 4: БИЗНЕС-СОГЛАСОВАНИЕ (Confluence) ===          │
│  Бизнес читает страницу, оставляет комментарии            │
│         ↓                                                    │
│  Agent 3 (Defender)    → анализ замечаний бизнеса          │
│         ↓                                                    │
│  Agent 0 (Creator)     → доработка по замечаниям           │
│         ↓                                                    │
│  Agent 7 (Publisher)   → ОБНОВЛЕНИЕ Confluence (sync)      │
│                                                             │
│  === ЭТАП 5: ФИНАЛИЗАЦИЯ ===                               │
│  Agent 6 (Presenter)   → презентация + отчёты              │
│                                                             │
│  CONFLUENCE = ЕДИНСТВЕННЫЙ ИСТОЧНИК ФМ                      │
│  Все агенты читают/пишут ТОЛЬКО в Confluence               │
│  Локальные файлы = только результаты работы агентов        │
└─────────────────────────────────────────────────────────────┘
```

### Правила конвейера

1. **Confluence - source of truth**: ФМ публикуется и живет в Confluence, версионность встроенная
2. **Каждый агент читает результаты предыдущих**: сканирует PROJECT_[NAME]/AGENT_*/
3. **Контекст передается автоматически**: через PROJECT_CONTEXT.md (включает Confluence PAGE_ID)
4. **Quality Gate ОБЯЗАТЕЛЕН перед Agent 7** (FC-08C): `scripts/quality_gate.sh` проверяет 9 секций; CRITICAL блокирует, WARN можно пропустить с `--reason`
5. **Версия ФМ**: патч (Z) автоматически при /apply (FC-11C); минорная/мажорная - вручную через `fm_version.sh bump`
6. **Бизнес-согласование**: после публикации (Agent 7) бизнес читает и комментирует в Confluence
7. **Каждый агент создает _summary.json** (FC-07A): машиночитаемая сводка для оркестратора
8. **Журнал аудита**: каждый PUT в Confluence логируется в `.audit_log/` (FC-12B)

### Команды запуска

```
# В ЧАТЕ (рекомендуется — видите диалог каждого агента):
"Запусти полный цикл ФМ FM-LS-PROFIT"     → workflows/PIPELINE_AUTO.md (все этапы в чате)
"Запусти агенты 1, 2, 4 для FM-LS-PROFIT" → выборочные агенты в чате

# СКРИПТОМ (фоновый, без диалога):
python3 scripts/run_agent.py --pipeline --project PROJECT_SHPMNT_PROFIT
python3 scripts/run_agent.py --pipeline --project PROJECT_SHPMNT_PROFIT --agents 1,2,4
python3 scripts/run_agent.py --agent 1 --project PROJECT_SHPMNT_PROFIT

# ОРКЕСТРАТОР (интерактивный с gum меню):
./scripts/orchestrate.sh → "Полный цикл review"

# ОТДЕЛЬНЫЕ АГЕНТЫ (в чате):
"Запусти аудит ФМ FM-LS-PROFIT"       → Agent 1 /audit
"Опубликуй в Confluence"              → Agent 7 /publish
"Проанализируй замечания от бизнеса"   → Agent 3 /respond
"Подготовь презентацию для директоров" → Agent 6 /present
```

---

## 🔗 КРОСС-АГЕНТНЫЙ ПОТОК ДАННЫХ

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДЫЙ АГЕНТ ПРИ СТАРТЕ:                                  │
│                                                             │
│  1. Читает PROJECT_CONTEXT.md — текущий контекст           │
│  2. Читает .interview_context.txt — параметры интервью     │
│  3. Сканирует AGENT_*/ — результаты других агентов         │
│  4. Читает ФМ из Confluence (REST API, PAGE_ID)            │
│                                                             │
│  КАЖДЫЙ АГЕНТ ПРИ ЗАВЕРШЕНИИ:                              │
│                                                             │
│  1. Сохраняет результат в PROJECT_[NAME]/AGENT_X_*/        │
│  2. Создает _summary.json (FC-07A, ОБЯЗАТЕЛЬНО!)           │
│  3. Обновляет PROJECT_[NAME]/PROJECT_CONTEXT.md            │
│  4. Обновляет PROJECT_[NAME]/WORKPLAN.md                   │
│  5. Обновляет PROJECT_[NAME]/CHANGELOG.md                  │
│  6. При /apply — создает новую версию ФМ + автопатч Z      │
│                                                             │
│  ⚠️ docs/ = системные файлы (обновляются при изменении     │
│     самих агентов/системы, НЕ при работе над ФМ)           │
└─────────────────────────────────────────────────────────────┘
```

### Что каждый агент использует от других

| Агент | Читает от | Что использует |
|-------|-----------|----------------|
| Agent 1 | — | Чистый анализ ФМ |
| Agent 2 | Agent 1 | Найденные замечания для фокуса симуляции |
| Agent 3 | Agent 1, 2 | Замечания для формирования ответов |
| Agent 4 | Agent 1, 2 | Замечания и UX-проблемы для тест-кейсов |
| Agent 5 | Agent 1, 2, 4 | Полная картина для архитектуры |
| Agent 6 | Все | Синтез для презентации |
| Agent 7 | Confluence (текущая страница) | Управление контентом в Confluence (обновление, версии) |

### JSON-сайдкар (_summary.json) - FC-04

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДЫЙ АГЕНТ ПОСЛЕ ВЫПОЛНЕНИЯ СОЗДАЕТ _summary.json        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ФАЙЛ: PROJECT_*/AGENT_X_*/[command]_summary.json          │
│  СХЕМА: schemas/agent-contracts.json → agentSummary        │
│                                                             │
│  ОБЯЗАТЕЛЬНЫЕ ПОЛЯ:                                        │
│     agent       - имя агента (Agent1_Architect и т.д.)     │
│     command     - выполненная команда (/audit, /auto)      │
│     timestamp   - ISO 8601 дата-время                      │
│     fmVersion   - версия ФМ (семантическая, X.Y.Z)        │
│     project     - имя проекта (PROJECT_SHPMNT_PROFIT)      │
│     status      - completed | partial | failed             │
│                                                             │
│  НЕОБЯЗАТЕЛЬНЫЕ ПОЛЯ:                                      │
│     counts      - {critical, high, medium, low, total}     │
│     outputFiles - список созданных Markdown-файлов         │
│     appliedChanges - количество примененных правок         │
│     notes       - свободный комментарий                    │
│                                                             │
│  ПРИМЕР:                                                    │
│  {                                                          │
│    "agent": "Agent1_Architect",                             │
│    "command": "/audit",                                     │
│    "timestamp": "2026-02-07T14:30:00Z",                    │
│    "fmVersion": "1.0.0",                                   │
│    "project": "PROJECT_SHPMNT_PROFIT",                     │
│    "status": "completed",                                  │
│    "counts": {"critical": 2, "high": 5, "total": 12},     │
│    "outputFiles": ["audit-report-v1.0.md"]                 │
│  }                                                          │
│                                                             │
│  ЗАЧЕМ: Машиночитаемая сводка для конвейера и оркестратора │
│  Позволяет автоматически определить, прошел ли агент       │
│  успешно и сколько находок/правок он сделал                │
└─────────────────────────────────────────────────────────────┘
```

---

## 🌐 MCP-ИНТЕГРАЦИИ

### ⚙️ MCP Setup — Настройка подключения

```
ПРЕДВАРИТЕЛЬНЫЕ ТРЕБОВАНИЯ:
1. Claude Code установлен (https://docs.anthropic.com/en/docs/claude-code)
2. MCP серверы настроены в ~/.claude/claude_desktop_config.json

НАСТРОЙКА CONFLUENCE:
1. Получить Personal Access Token (PAT) в Confluence
2. Указать URL и PAGE_ID в scripts/publish_to_confluence.py
3. Публикация: python3 scripts/publish_to_confluence.py

ПРОВЕРКА ПОДКЛЮЧЕНИЯ:
- Confluence: python3 scripts/publish_to_confluence.py --test

FALLBACK (если недоступно):
- Agent 7: сохранит HTML локально, загрузить позже
```

### Confluence API

```
КОГДА: Agent 7 → /publish (основной), Agent 6 → /export-confluence (презентации)
ДЛЯ ЧЕГО: Публикация ФМ, требований, процессов с версионностью

CONFLUENCE SERVER:
- URL: https://confluence.ekf.su
- Auth: Bearer token (PAT)
- API: /rest/api/content/{PAGE_ID}
- Формат: XHTML storage format

СТРУКТУРА СТРАНИЦЫ (см. docs/CONFLUENCE_TEMPLATE.md):
- Мета-таблица (версия, дата, статус, автор)
- Оглавление (toc macro)
- Система кодов типов (таблица 7x2)
- Основное содержание ФМ
- Таблица требований (77x3)
- Панели предупреждений (warning=красная, note=жёлтая)

ПРАВИЛА:
- Обновлять существующую страницу (PUT + version increment)
- Дата генерируется автоматически (datetime.now)
- Версионность встроенная (Confluence page versions)
- Шаблон: docs/CONFLUENCE_TEMPLATE.md
- Требования: docs/CONFLUENCE_REQUIREMENTS.md
```

---

## 🤝 БИЗНЕС-СОГЛАСОВАНИЕ (Approval Workflow)

```
ВОРКФЛОУ СОГЛАСОВАНИЯ ФМ В CONFLUENCE:

┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  1. DRAFT (создание + внутренний ревью - ЛОКАЛЬНО)              │
│     Кто: Agent 0 создал, Agents 1→2→4→5 провели ревью          │
│     Где: Confluence (черновик) + локальные AGENT_*/, Quality Gate│
│     Действие: Все замечания агентов исправлены через /apply      │
│                                                                  │
│  2. PUBLISHED (публикация - CONFLUENCE)                         │
│     Кто: Agent 7 опубликовал в Confluence                       │
│     Действие: Ссылка на страницу отправляется бизнес-заказчику  │
│                                                                  │
│  3. BUSINESS REVIEW (согласование с бизнесом)                   │
│     Кто: Бизнес-заказчик открывает Confluence, читает ФМ        │
│     Как: Оставляет комментарии прямо в Confluence               │
│     Срок: 3 рабочих дня (настраиваемо)                         │
│     Действие: Agent 3 (Defender) анализирует замечания          │
│                                                                  │
│  4. REWORK (доработка по замечаниям)                            │
│     Кто: Agent 3 формирует ответы, Agent 0 вносит правки       │
│     Действие: Agent 7 /publish обновляет Confluence             │
│     Цикл: повторяется до снятия всех замечаний                 │
│                                                                  │
│  5. APPROVED (согласовано)                                      │
│     Кто: Бизнес-заказчик подтверждает                           │
│     Действие: Agent 6 готовит финальный отчёт/презентацию      │
│                                                                  │
│  КРИТЕРИЙ ЗАВЕРШЕНИЯ СОГЛАСОВАНИЯ:                              │
│     Статус страницы ФМ = Approved (метка/лейбл) И               │
│     Нет открытых комментариев к странице ФМ.                    │
│     До этого цикл 3→0→7 повторяется.                            │
│                                                                  │
│  EXIT CONDITIONS (R-04):                                        │
│     MAX_ITERATIONS = 5 (эскалация руководителю)                 │
│     TIMEOUT = 7 рабочих дней (уведомление + запрос решения)     │
│     ESCALATION = 3 итерации без прогресса (созыв совещания)     │
│     При достижении лимита: Review-Blocked + ручное вмешательство│
│                                                                  │
│  Версионность: встроенная в Confluence (история страницы)       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

КОМАНДЫ ДЛЯ БИЗНЕС-СОГЛАСОВАНИЯ:
- "Отправь ФМ на согласование"     → публикует в Confluence + ссылка бизнесу
- "Проанализируй замечания"        → Agent 3 → /respond
- "ФМ согласована"                 → фиксация версии
- "Покажи статус согласования"     → читает комментарии из Confluence
```

---

## 📜 СКРИПТЫ

```
scripts/
├── orchestrate.sh            ← ГЛАВНЫЙ ЛАУНЧЕР (единая точка входа)
│
├── ПУБЛИКАЦИЯ И ЭКСПОРТ:
├── publish_to_confluence.py  ← Обновление Confluence (v3.0, confluence_utils)
├── import_docx.py            ← Одноразовый импорт DOCX → Confluence (symlink)
├── export_from_confluence.py ← Экспорт ФМ из Confluence (PDF/Word)
│
├── CONFLUENCE-УТИЛИТЫ:
├── check_confluence_macros.py← Проверяет доступные макросы на Confluence Server
│
├── УПРАВЛЕНИЕ ПРОЕКТОМ:
├── new_project.sh            ← Создание нового проекта из шаблона
├── fm_version.sh             ← Управление версиями (list/diff/bump/log)
├── quality_gate.sh           ← Проверка готовности к передаче
├── run_agent.py              ← АВТОНОМНЫЙ ЗАПУСК агентов (claude -p, --pipeline)
│
├── ЛАУНЧЕРЫ АГЕНТОВ (интерактивные):
├── agent0_new.sh             ← Запуск Agent 0 (Creator) - интервью + создание ФМ
├── agent1_audit.sh           ← Запуск Agent 1 (Architect) - аудит ФМ
├── agent2_simulate.sh        ← Запуск Agent 2 (Simulator) - симуляция ролей
├── agent3_defend.sh          ← Запуск Agent 3 (Defender) - защита от замечаний
├── agent4_test.sh            ← Запуск Agent 4 (QA) - генерация тест-кейсов
├── agent5_architect.sh       ← Запуск Agent 5 (Tech Architect) - ТЗ и архитектура
│
├── lib/
│   ├── common.sh             ← Общие функции (цвета, утилиты, проекты)
│   └── confluence_utils.py   ← Confluence клиент: блокировки, бекапы, retry
│
└── experimental/             ← Неактивные модули
    └── contract_validator.py ← Валидация JSON-схем (отложен)
```

**Запуск:**
- Интерактивный: `./scripts/orchestrate.sh`
- Автономный: `python3 scripts/run_agent.py --pipeline --project PROJECT_NAME`

### Безопасность Confluence (confluence_utils.py v1.1)

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДОЕ ОБНОВЛЕНИЕ CONFLUENCE ПРОХОДИТ ЧЕРЕЗ:               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. БЛОКИРОВКА (file-based lock, fcntl)                    │
│     - Исключает параллельные записи одной страницы         │
│     - Таймаут 60 секунд                                    │
│                                                             │
│  2. БЕКАП (перед каждым PUT)                               │
│     - Сохраняет текущее состояние страницы локально        │
│     - До 10 последних бекапов (.backups/{page_id}/)        │
│     - Позволяет откатить при ошибке                        │
│                                                             │
│  3. RETRY (экспоненциальная задержка)                      │
│     - 3 попытки, задержки 1s->2s->4s                       │
│     - Повтор при HTTP 500, 502, 503, 504, 408, 429         │
│     - При сетевых ошибках (URLError)                       │
│                                                             │
│  4. ЖУРНАЛ АУДИТА (FC-12B)                                 │
│     - Каждый PUT/rollback записывается в .audit_log/       │
│     - JSONL формат с timestamp, agent, version_number      │
│     - quality_gate.sh проверяет единственного писателя     │
│                                                             │
│  ИСПОЛЬЗОВАНИЕ:                                             │
│     from lib.confluence_utils import ConfluenceClient       │
│     client = ConfluenceClient(url, token, page_id)          │
│     with client.lock():                                     │
│         page = client.get_page()                            │
│         client.update_page(body, "описание изменений",      │
│                            agent_name="Agent7_Publisher")    │
└─────────────────────────────────────────────────────────────┘
```

### Журнал аудита Confluence (FC-12B)

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДАЯ ЗАПИСЬ В CONFLUENCE ЛОГИРУЕТСЯ:                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ГДЕ: scripts/.audit_log/confluence_{PAGE_ID}.jsonl         │
│                                                             │
│  ФОРМАТ ЗАПИСИ (JSONL):                                     │
│  {                                                          │
│    "timestamp": "2026-02-09T14:30:00",                     │
│    "page_id": "83951683",                                  │
│    "action": "update",                                     │
│    "agent": "Agent7_Publisher",                             │
│    "version_message": "Обновлена секция 3.4",              │
│    "version_number": 42,                                   │
│    "pid": 12345                                            │
│  }                                                          │
│                                                             │
│  ПРАВИЛА:                                                   │
│  - ТОЛЬКО Agent 7 пишет в Confluence (через update_page)   │
│  - Все остальные агенты передают изменения Agent 7          │
│  - quality_gate.sh проверяет: нет записей от чужих агентов │
│  - При откате (rollback) тоже создается запись             │
│                                                             │
│  ИСПОЛЬЗОВАНИЕ:                                             │
│     client.update_page(body, "описание",                   │
│                        agent_name="Agent7_Publisher")       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔒 QUALITY GATE (FC-08C)

```
┌─────────────────────────────────────────────────────────────┐
│  ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА ПЕРЕД ПУБЛИКАЦИЕЙ (Agent 7)          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ЗАПУСК:                                                    │
│     ./scripts/quality_gate.sh PROJECT_NAME                  │
│     ./scripts/quality_gate.sh PROJECT_NAME --reason "текст" │
│                                                             │
│  ЧТО ПРОВЕРЯЕТ (9 секций):                                  │
│  1. Структура проекта (FM_DOCUMENTS/, README, CHANGES/)    │
│  2. Функциональная модель (наличие, версия)                │
│  3. Результаты агентов (AGENT_1..7, отчеты)                │
│  4. Открытые замечания (CRITICAL=блок, HIGH=предупреждение) │
│  5. Сайдкары _summary.json (FC-07A)                        │
│  6. Матрица трассируемости (FC-10A)                        │
│  7. Журнал аудита Confluence (FC-12B)                      │
│  8. Документация (CHANGELOG.md)                            │
│  9. Confluence (URL в PROJECT_CONTEXT.md)                   │
│                                                             │
│  КОДЫ ВЫХОДА:                                               │
│  0 = Готово к передаче                                      │
│  1 = CRITICAL (нельзя пропустить!)                         │
│  2 = WARN (можно пропустить с --reason "обоснование")      │
│                                                             │
│  В КОНВЕЙЕРЕ (orchestrate.sh):                              │
│  - Quality Gate вызывается АВТОМАТИЧЕСКИ перед Agent 7      │
│  - При коде 1: конвейер останавливается                    │
│  - При коде 2: запрашивается причина пропуска              │
│  - При коде 0: Agent 7 запускается автоматически           │
│                                                             │
│  ❌ ЗАПРЕЩЕНО: публиковать в Confluence без Quality Gate    │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 МАТРИЦА ТРАССИРУЕМОСТИ (FC-10A)

```
┌─────────────────────────────────────────────────────────────┐
│  СВЯЗЬ: ЗАМЕЧАНИЕ → ТЕСТ → РАЗДЕЛ ФМ → ОБЪЕКТ ТЗ           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  КТО СОЗДАЕТ: Agent 4 (QA Tester)                          │
│  ГДЕ: PROJECT_*/AGENT_4_QA_TESTER/traceability-matrix.json │
│  СХЕМА: schemas/agent-contracts.json → traceabilityMatrix  │
│                                                             │
│  ФОРМАТ:                                                    │
│  {                                                          │
│    "project": "PROJECT_SHPMNT_PROFIT",                     │
│    "fmVersion": "1.0.0",                                   │
│    "timestamp": "2026-02-09T14:30:00Z",                    │
│    "entries": [                                             │
│      {                                                      │
│        "findingId": "CRITICAL-001",                        │
│        "tests": ["TC-001", "TC-002"],                      │
│        "fmSection": "3.4",                                 │
│        "tzObject": "Документ.ЗаказКлиента",                │
│        "status": "covered"                                 │
│      }                                                      │
│    ],                                                       │
│    "summary": {                                             │
│      "totalFindings": 12,                                  │
│      "covered": 10,                                        │
│      "uncovered": 2                                        │
│    }                                                        │
│  }                                                          │
│                                                             │
│  quality_gate.sh проверяет наличие и покрытие матрицы       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎛️ СХЕМА КОНТЕКСТА ДЛЯ /auto (FC-09C)

```
┌─────────────────────────────────────────────────────────────┐
│  ДЕТЕРМИНИРОВАННЫЙ РЕЖИМ /auto (БЕЗ ИНТЕРВЬЮ)              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ОБЯЗАТЕЛЬНЫЕ КЛЮЧИ (без них /auto не запускается):        │
│  - project   — имя проекта (PROJECT_SHPMNT_PROFIT)         │
│  - pageId    — Confluence PAGE_ID                          │
│  - fmVersion — текущая версия ФМ (X.Y.Z)                  │
│                                                             │
│  ОПЦИОНАЛЬНЫЕ (со значениями по умолчанию):                │
│  - applyScope — all | critical_high | critical_only | none │
│                 (по умолчанию: critical_high)              │
│  - focus      — full | logic | 1c | speed | ux             │
│                 (по умолчанию: full)                        │
│  - audience   — business | executive | developer           │
│                 (по умолчанию: business)                    │
│  - applyMode  — auto | interactive                         │
│                 (по умолчанию: interactive)                 │
│                                                             │
│  ПРАВИЛО: Если обязательный ключ не указан:                │
│  - НЕ угадывать и НЕ использовать дефолт                   │
│  - СПРОСИТЬ пользователя или прочитать из                  │
│    PROJECT_CONTEXT.md / CONFLUENCE_PAGE_ID                  │
│                                                             │
│  СХЕМА: schemas/agent-contracts.json → contextSchema       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🏗️ АРХИТЕКТУРНЫЙ АУДИТ (Lead Architect)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛА РАБОТЫ Lead Architect:                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  АРТЕФАКТЫ (постоянные, НЕ перезаписывать):                │
│                                                             │
│  1. docs/FINDINGS_LEDGER.md                                │
│     - Единственный источник правды по находкам             │
│     - Статусы: OPEN → CLOSED / ACCEPTED_RISK              │
│     - CLOSED/ACCEPTED_RISK повторно НЕ поднимаются        │
│     - Новая запись = новый класс проблемы или регрессия    │
│     - Нумерация: AG-XX (агенты), FC-XX (архитектура)      │
│     - ЧИТАТЬ ПЕРЕД КАЖДЫМ АУДИТОМ!                         │
│                                                             │
│  2. docs/ARCHITECT_WORKPLAN.md                             │
│     - Рабочий план Lead Architect                          │
│     - Новые записи ДОПИСЫВАЮТСЯ в конец секций            │
│     - Старые записи НЕ удаляются                          │
│     - Содержит: приоритеты, историю сессий, решения, долг  │
│                                                             │
│  ПРАВИЛА АУДИТА:                                            │
│  - Не ставить галочку без реальной проверки                │
│  - Закрытие = реализация + верификация                     │
│  - Регрессия = повторное открытие с доказательством        │
│  - Каждый аудит = новая сессия в ARCHITECT_WORKPLAN.md     │
│                                                             │
│  АВТОНОМНОСТЬ:                                              │
│  - Патчи (Z) — автоматически при /apply (FC-11C)           │
│  - Минорные/мажорные версии — только вручную               │
│  - Quality Gate — обязателен перед Agent 7 (FC-08C)        │
│  - Журнал аудита — автоматически при каждом PUT (FC-12B)   │
│                                                             │
│  ОБЯЗАТЕЛЬНЫЙ ФИНАЛ КАЖДОЙ СЕССИИ:                          │
│  1. git add — все измененные файлы                         │
│  2. git commit — с описанием что сделано                   │
│  3. git push — отправить в удаленный репозиторий           │
│  4. gh pr create — создать Pull Request в main             │
│  5. gh pr merge — СРАЗУ замерджить PR в main               │
│  НЕ ЗАВЕРШАТЬ СЕССИЮ без коммита, пуша и мерджа!           │
└─────────────────────────────────────────────────────────────┘
```


---

## 🎯 Взаимодействие с пользователем

**АБСОЛЮТНОЕ ПРАВИЛО: Есть вопрос → вызывай AskUserQuestion. БЕЗ ИСКЛЮЧЕНИЙ.**

Вопрос текстом в чате = вопрос в пустоту. Пользователь не сможет удобно ответить. ВСЕГДА используй встроенный инструмент **AskUserQuestion**.

**Правила:**
- ЛЮБОЙ вопрос к пользователю = AskUserQuestion (да/нет, выбор, уточнение - ВСЕ)
- Формулируй вопрос с конкретными вариантами ответа и кратким описанием каждого
- Группируй связанные вопросы в табы (если несколько тем)
- Всегда добавляй вариант "Другое" для свободного ответа
- НИКОГДА не выполняй необратимые действия без подтверждения через AskUserQuestion
- НИКОГДА не задавай вопрос текстом в чате - только AskUserQuestion

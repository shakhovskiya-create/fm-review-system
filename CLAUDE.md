# CLAUDE.md — Правила работы с системой FM Review Agents

> Этот файл читается Claude Code автоматически при работе с проектом.

---

## 🎯 О СИСТЕМЕ

Это система из 6 агентов для создания и проверки Функциональных Моделей (ФМ) для проектов 1С.

**Файлы агентов:**
- `AGENT_0_CREATOR.md` — создание ФМ с нуля
- `AGENT_1_ARCHITECT.md` — полный аудит ФМ (бизнес + 1С)
- `AGENT_2_ROLE_SIMULATOR.md` — симуляция ролей
- `AGENT_3_DEFENDER.md` — защита от замечаний
- `AGENT_4_QA_TESTER.md` — генерация тестов
- `AGENT_5_TECH_ARCHITECT.md` — проектирование и ТЗ

**Документация:**
- `README.md` — описание системы
- `PROMPTS.md` — промпты для запуска агентов
- `CHANGELOG.md` — история изменений

**Рабочие файлы (обновляются автоматически):**
- `PROJECT_CONTEXT.md` — контекст проекта, находки, решения
- `WORKPLAN.md` — план работ, статус задач

---

## 📋 ОБЩИЕ ПРАВИЛА ДЛЯ ВСЕХ АГЕНТОВ

### 1. Диалоговый режим

```
┌─────────────────────────────────────────────────────────────┐
│  ИНТЕРВЬЮ = ЖИВОЙ ДИАЛОГ, НЕ АНКЕТА!                       │
├─────────────────────────────────────────────────────────────┤
│  ❌ НЕ ДЕЛАТЬ:                                              │
│     - Выдавать все вопросы сразу                           │
│     - Формировать таблицы с вопросами                      │
│     - Показывать "план интервью"                           │
│                                                             │
│  ✅ ДЕЛАТЬ:                                                  │
│     - Задавать 1-2 вопроса за раз                          │
│     - Ждать ответа                                          │
│     - Уточнять если ответ неполный                         │
│     - Переходить к следующему только после ответа          │
└─────────────────────────────────────────────────────────────┘
```

### 2. Формат вопросов — ИНТЕРАКТИВНОЕ МЕНЮ

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДЫЙ ВОПРОС = МЕНЮ С ВАРИАНТАМИ                         │
├─────────────────────────────────────────────────────────────┤
│  ❌ НЕ ДЕЛАТЬ:                                              │
│     - Открытые вопросы без вариантов                       │
│     - Checkbox стиль (☐ ☑)                                 │
│     - Длинные текстовые объяснения перед вопросом          │
│                                                             │
│  ✅ ДЕЛАТЬ:                                                  │
│     - Пронумерованные варианты (1, 2, 3...)                │
│     - Один вариант помечен ⭐ РЕКОМЕНДУЕТСЯ                 │
│     - Последний вариант всегда "Другое"                    │
│     - После меню — краткое обоснование рекомендации        │
│     - Пользователь вводит только номер или свой текст      │
└─────────────────────────────────────────────────────────────┘
```

**ШАБЛОН ВОПРОСА:**

```
? [Краткий вопрос]

1. [Вариант]
2. [Вариант] ⭐ рекомендуется  
3. [Вариант]
4. Другое (напишите)

💡 Почему [N]: [1-2 предложения обоснования]

Ваш выбор (1-4):
```

**ПРИМЕРЫ:**

```
? Что в приоритете?

1. Скорость — не тормозить продажи
2. Баланс скорости и контроля ⭐ рекомендуется
3. Контроль — максимальная защита
4. Другое (напишите)

💡 Почему 2: Для торговли обычно нужен баланс — быстрые плюсовые сделки, но контроль минусовых.

Ваш выбор (1-4):
```

```
? Какие изменения применить?

1. Все (11 правок)
2. CRITICAL + HIGH (7 правок) ⭐ рекомендуется
3. Только CRITICAL (4 правки)
4. Конкретные номера (укажите какие)
5. Пока не применять

💡 Почему 2: MEDIUM и LOW можно отложить, критичные и важные лучше исправить сразу.

Ваш выбор (1-5):
```

```
? Как обрабатывать молчание согласующего (4 часа)?

1. Молчание = отказ (безопасно, но тормозит)
2. Молчание = согласие для рент≥0% ⭐ рекомендуется
3. Молчание = эскалация руководителю
4. Другое (напишите)

💡 Почему 2: Плюсовые сделки не должны ждать — автосогласование ускоряет 80% заказов.

Ваш выбор (1-4):
```

**ПРАВИЛО:** Пользователь должен иметь возможность ответить ОДНОЙ цифрой или коротким текстом. Не заставляй писать развёрнутые ответы.

### 3. Правило формата ФМ

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ РЕДАКТИРОВАНИИ ФМ:                                     │
│                                                             │
│  ❌ НЕЛЬЗЯ без явного указания:                             │
│     - Менять структуру документа                            │
│     - Менять оформление (шрифты, отступы, стили)           │
│     - Менять формат таблиц                                  │
│     - Переименовывать разделы                               │
│     - Менять нумерацию                                      │
│                                                             │
│  ✅ МОЖНО:                                                   │
│     - Менять СОДЕРЖАНИЕ (текст, правила, логику)           │
│     - Добавлять новые пункты В СУЩЕСТВУЮЩЕМ формате        │
│     - Исправлять ошибки в тексте                           │
│                                                             │
│  Если нужно изменить формат — СНАЧАЛА СПРОСИ!              │
└─────────────────────────────────────────────────────────────┘
```

### 3.1. ИНСТРУМЕНТЫ ДЛЯ РАБОТЫ С DOCX (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ОСНОВНОЙ ИНСТРУМЕНТ: PANDOC + MARKDOWN                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  УСТАНОВКА (один раз):                                      │
│     brew install pandoc     # macOS                         │
│     pandoc --version        # Проверка                      │
│                                                             │
│  ШАБЛОН (один раз для проекта):                             │
│     Скопируй любой существующий ФМ документ как            │
│     template_fm.docx - он содержит все стили и форматы     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**WORKFLOW ДЛЯ СТРУКТУРНЫХ ИЗМЕНЕНИЙ (добавление разделов, правки текста):**

```bash
# 1. Конвертация DOCX → Markdown
pandoc document.docx -o draft.md --extract-media=./media

# 2. Редактирование draft.md
#    - Claude редактирует Markdown (просто, понятно)
#    - Видно структуру документа
#    - Легко добавлять/менять разделы

# 3. Сборка Markdown → DOCX с сохранением стилей
pandoc draft.md -o output.docx --reference-doc=template_fm.docx
#      ^^^^^^^^                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
#      твой MD                   шаблон со стилями исходного документа
```

**WORKFLOW ДЛЯ ТОЧЕЧНЫХ ЗАМЕН (версия, дата, конкретные слова):**

```bash
# 1. Распаковать DOCX (это ZIP архив)
unzip -o document.docx -d temp_docx/

# 2. Замена текста в XML с сохранением форматирования
sed -i '' 's/v1.1.0/v1.2.0/g' temp_docx/word/document.xml
sed -i '' 's/28 января 2026/29 января 2026/g' temp_docx/word/document.xml

# 3. Запаковать обратно
cd temp_docx && zip -r ../output.docx . && cd .. && rm -rf temp_docx
```

**КОГДА ЧТО ИСПОЛЬЗОВАТЬ:**

```
┌─────────────────────────────────────────────────────────────┐
│  PANDOC (Markdown):                                         │
│  ✅ Добавление/изменение разделов                           │
│  ✅ Интеграция 10+ исправлений в текст                      │
│  ✅ Реструктуризация документа                              │
│  ✅ Видно структуру - понятно где что менять                │
│                                                             │
│  SED (XML):                                                 │
│  ✅ Точечные замены (версия, дата, конкретные слова)        │
│  ✅ Быстрые правки без конвертации                          │
│  ⚠️  Опасно для сложных изменений (можно сломать XML)      │
│                                                             │
│  python-docx:                                               │
│  ❌ ИЗБЕГАТЬ - сложно сохранить форматирование              │
│  ❌ ИЗБЕГАТЬ - ломает стили и таблицы                       │
│  ✅ Только для чтения/анализа структуры                     │
└─────────────────────────────────────────────────────────────┘
```

**ПРИМЕР ПОЛНОГО ЦИКЛА:**

```bash
# Задача: внести 22 исправления в FM-LS-PROFIT-v1.1.0.docx

# 1. Создаем шаблон (один раз)
cp FM-LS-PROFIT-v1.1.0.docx template_fm.docx

# 2. Конвертируем в Markdown
pandoc FM-LS-PROFIT-v1.1.0.docx -o draft.md --extract-media=./media

# 3. Claude редактирует draft.md:
#    - Находит п. 3.4 и добавляет уточнение
#    - Находит п. 3.5 и интегрирует правку
#    - ... (все 22 исправления)

# 4. Собираем обратно
pandoc draft.md -o FM-LS-PROFIT-v1.2.0-temp.docx --reference-doc=template_fm.docx

# 5. Точечные замены метаданных
unzip -o FM-LS-PROFIT-v1.2.0-temp.docx -d temp_docx/
sed -i '' 's/v1.1.0/v1.2.0/g' temp_docx/word/document.xml
sed -i '' 's/28 января 2026/29 января 2026/g' temp_docx/word/document.xml
cd temp_docx && zip -r ../FM-LS-PROFIT-v1.2.0.docx . && cd .. && rm -rf temp_docx

# 6. Готово!
```

**КРИТИЧНО:**
- ✅ ВСЕГДА использовать Pandoc для структурных изменений
- ✅ ВСЕГДА проверять результат (открыть DOCX и визуально проверить)
- ✅ ВСЕГДА создавать бэкап перед правками
- ❌ НИКОГДА не использовать python-docx для редактирования (только для чтения)

### 3.5. Правила текста и форматирования (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛА ОФОРМЛЕНИЯ ТЕКСТА В ДОКУМЕНТАХ:                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. ТИРЕ И ДЕФИСЫ:                                          │
│     ❌ НИКОГДА не использовать длинное тире (—)             │
│     ✅ ВСЕГДА использовать обычный дефис (-)                │
│     Пример: "Заказ - это документ" (НЕ "Заказ — это...")   │
│                                                             │
│  2. БУКВА Ё:                                                │
│     ❌ НИКОГДА не использовать букву "ё"                    │
│     ✅ ВСЕГДА заменять на "е"                               │
│     Пример: "Отчеты" (НЕ "Отчёты"), "Расчеты" (НЕ "Расчёты")│
│                                                             │
│  3. ПУНКТУАЦИЯ В СПИСКАХ:                                   │
│     ✅ В перечислениях использовать точку с запятой (;)     │
│     ✅ В конце последнего элемента - точку (.)              │
│     Пример:                                                 │
│       - Первый пункт;                                       │
│       - Второй пункт;                                       │
│       - Последний пункт.                                    │
│                                                             │
│  4. ГРАММАТИКА И ПУНКТУАЦИЯ:                                │
│     ✅ Постоянно проверять грамматику ОЧЕНЬ тщательно       │
│     ✅ Проверять пунктуацию в каждом предложении            │
│     ✅ Избегать канцелярита и технических терминов          │
│     ✅ Писать для бизнеса, не для программистов             │
│                                                             │
│  5. СТИЛЬ ИЗЛОЖЕНИЯ:                                        │
│     ✅ Простой, понятный язык                               │
│     ✅ Короткие предложения                                 │
│     ❌ Избегать: "является единственным источником истины"  │
│     ✅ Использовать: "используется для принятия решений"    │
│                                                             │
│  ⚠️  ЭТИ ПРАВИЛА ПРИМЕНЯЮТСЯ КО ВСЕМ ДОКУМЕНТАМ!           │
└─────────────────────────────────────────────────────────────┘
```

### 3. Версионирование ФМ

```
X.Y.Z где:
- X — мажорная версия (новый процесс)
- Y — минорная версия (новые разделы/функции)
- Z — патч (исправления, уточнения)

Примеры:
- 1.0.0 → 1.0.1 (патч после аудита)
- 1.0.1 → 1.1.0 (добавлен новый раздел)
- 1.1.0 → 2.0.0 (переделан весь процесс)
```

### 4. Применение изменений (/apply)

```
┌─────────────────────────────────────────────────────────────┐
│  КРИТИЧНО: ИНТЕГРИРОВАТЬ ИЗМЕНЕНИЯ СРАЗУ В ОСНОВНОЙ ТЕКСТ! │
├─────────────────────────────────────────────────────────────┤
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Создавать разделы "ДОПОЛНЕНИЯ И УТОЧНЕНИЯ"           │
│     - Добавлять изменения в конец документа отдельным блоком│
│     - Оставлять изменения "на потом для интеграции"        │
│     - Создавать приложения с изменениями                    │
│                                                             │
│  ✅ ВСЕГДА:                                                  │
│     - Интегрировать изменения СРАЗУ в основной текст        │
│     - Редактировать существующие пункты документа           │
│     - Готовый документ с интегрированными изменениями       │
│     - Пользователь получает финальный документ, не черновик │
└─────────────────────────────────────────────────────────────┘

ПОСЛЕ АУДИТА/АНАЛИЗА:

1. Показал список проблем/замечаний
2. СРАЗУ СПРАШИВАЮ:
   "Внести изменения в ФМ и создать версию X.Y.Z?"

3. Если пользователь говорит ДА:
   - Уточняю: "Какие замечания применить? Все / Только критические / Конкретные номера"
   - Вношу изменения СРАЗУ В ОСНОВНОЙ ТЕКСТ документа (СОХРАНЯЯ ФОРМАТ!)
   - Нахожу соответствующие пункты и редактирую их напрямую
   - Создаю новую версию файла
   - Показываю список изменений

4. Формат вывода:
   "Создана версия X.Y.Z. Изменения:
    - п. 3.4: [что изменено]
    - п. 3.7: [что изменено]
    - ..."
```

### 5. Обязательные метаданные при /apply

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ СОЗДАНИИ НОВОЙ ВЕРСИИ DOCX ОБЯЗАТЕЛЬНО ОБНОВИТЬ:      │
├─────────────────────────────────────────────────────────────┤
│  1. КОЛОНТИТУЛ (header/footer)                              │
│     - Версия документа в верхнем колонтитуле               │
│     - Пример: "FM-SHPMNT-PROFIT v2.5.1" → "v2.5.2"         │
│                                                             │
│  2. ЗАГОЛОВОК/ПАСПОРТ документа                            │
│     - Версия в теле документа                              │
│     - Дата последнего изменения                            │
│                                                             │
│  3. ИСТОРИЯ ИЗМЕНЕНИЙ (если есть в документе)              │
│     - Добавить запись о текущей версии                     │
│                                                             │
│  ⚠️ ПРОВЕРИТЬ ПРОГРАММНО:                                   │
│     - Поиск по всему документу старой версии               │
│     - Замена во ВСЕХ местах, включая таблицы               │
└─────────────────────────────────────────────────────────────┘
```

### 6. Верификация изменений (КРИТИЧНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: НЕ ОТМЕЧАТЬ ✅ БЕЗ РЕАЛЬНОЙ ПРОВЕРКИ!            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Отмечать ✅ на основе "скрипт выполнился"            │
│     - Писать "Готово" без верификации                      │
│     - Доверять автоматическим проверкам без перепроверки   │
│                                                             │
│  ✅ ОБЯЗАТЕЛЬНО:                                            │
│     - После каждого скрипта — ПРОВЕРКА наличия изменений   │
│     - Искать ОТСУТСТВИЕ старых значений (не только новые)  │
│     - Проверять ВСЕ места: параграфы, таблицы, колонтитулы │
│     - Для форматирования (шрифт, заливка) — отдельная      │
│       проверка через python-docx свойств                   │
│                                                             │
│  АЛГОРИТМ ВЕРИФИКАЦИИ:                                      │
│  1. Скрипт внесения изменений                              │
│  2. Скрипт проверки: ищем ВСЕ правки из списка             │
│  3. Скрипт проверки: ищем ОТСУТСТВИЕ старых значений       │
│  4. Если что-то не найдено — ИСПРАВЛЯЕМ, а не игнорируем   │
│  5. Только после 2+3+4 отмечаем ✅                          │
│                                                             │
│  ПРИЧИНА ОШИБОК:                                            │
│  - Текст в разных runs (Word разбивает форматирование)     │
│  - Текст в таблицах (отдельная структура)                  │
│  - Колонтитулы (отдельный объект section.header/footer)    │
│  - Заливка ≠ цвет шрифта (shading vs font.color)          │
└─────────────────────────────────────────────────────────────┘
```

### 7. Бэкапы перед программными изменениями

```
┌─────────────────────────────────────────────────────────────┐
│  ПЕРЕД ЛЮБЫМ ПРОГРАММНЫМ ИЗМЕНЕНИЕМ DOCX:                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. СОЗДАТЬ БЭКАП:                                          │
│     cp файл.docx файл.bak                                   │
│                                                             │
│  2. ПРОВЕРИТЬ ЧТО БЭКАП СОЗДАН:                             │
│     ls -la *.bak                                            │
│                                                             │
│  3. ТОЛЬКО ПОТОМ ВЫПОЛНЯТЬ СКРИПТ                           │
│                                                             │
│  ⚠️ ЕСЛИ СКРИПТ СЛОМАЛ ДОКУМЕНТ:                            │
│     cp файл.bak файл.docx                                   │
│     → Исправить скрипт и повторить                          │
│                                                             │
│  УДАЛЯТЬ БЭКАП ТОЛЬКО ПОСЛЕ:                                │
│     - Успешной верификации изменений                        │
│     - Подтверждения пользователем                           │
└─────────────────────────────────────────────────────────────┘
```

### 8. Нумерация в документах

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: Только цифровая нумерация (1., 1.1., 1.1.1.)      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Смесь цифр и букв: 3.2а., 3.4б.                       │
│     - Текстовая нумерация (просто текст "1." в начале)      │
│                                                             │
│  ✅ ИСПОЛЬЗОВАТЬ:                                           │
│     - Word-нумерацию (функция списков)                      │
│     - Только цифры: 1., 1.1., 1.1.1., ...                   │
│     - При добавлении раздела — перенумеровать               │
└─────────────────────────────────────────────────────────────┘
```

### 9. Файл изменений (CHANGES.md) — ОБЯЗАТЕЛЬНО!

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ КАЖДОМ /apply СОЗДАВАТЬ ФАЙЛ ИЗМЕНЕНИЙ:                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ФОРМАТ ИМЕНИ:                                              │
│     FM-[NAME]-v[X.Y.Z]-CHANGES.md                           │
│     Пример: FM-SHPMNT-PROFIT-v2.5.3-CHANGES.md              │
│                                                             │
│  СОДЕРЖАНИЕ:                                                │
│  1. Заголовок с датой, агентом, задачей                    │
│  2. Таблица изменений (ID, Где, Было, Стало, Причина)      │
│  3. Не применённые изменения (LOW) с причинами             │
│  4. Решения по уточняющим вопросам                         │
│  5. Результат верификации (чек-лист ✅)                     │
│                                                             │
│  ⚠️ СОЗДАВАТЬ СРАЗУ ПОСЛЕ ВЕРИФИКАЦИИ, ДО ОТЧЁТА ЮЗЕРУ!    │
│                                                             │
│  📁 ВСЕ ФАЙЛЫ СОХРАНЯТЬ В: FM_DOCUMENTS/                    │
└─────────────────────────────────────────────────────────────┘
```

### 10. Хранилище ФМ и результатов (в папке проекта)

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДАЯ ФМ = ОТДЕЛЬНЫЙ ПРОЕКТ В ПАПКЕ PROJECT_[NAME]/       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  СТРУКТУРА ПРОЕКТА:                                         │
│     PROJECT_[NAME]/                                         │
│     ├── README.md                    ← Обзор проекта        │
│     ├── FM_DOCUMENTS/                ← ВСЕ ВЕРСИИ ФМ        │
│     │   ├── README.md                ← История версий       │
│     │   ├── FM-*-v*.docx             ← Версии документа     │
│     │   ├── FM-*-CHANGES.md          ← Списки изменений     │
│     │   └── *.bak                    ← Бэкапы (временные)   │
│     │                                                       │
│     ├── AGENT_1_ARCHITECT/           ← Результаты аудита    │
│     ├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей      │
│     ├── AGENT_3_DEFENDER/            ← Ответы на замечания  │
│     ├── AGENT_4_QA_TESTER/           ← Тест-кейсы           │
│     ├── AGENT_5_TECH_ARCHITECT/      ← ТЗ на разработку     │
│     └── REPORTS/                     ← Итоговые отчёты      │
│                                                             │
│  ПРИ РАБОТЕ С ФМ:                                           │
│  1. Определить проект: PROJECT_[NAME]/                      │
│  2. ФМ читать/писать в PROJECT_[NAME]/FM_DOCUMENTS/         │
│  3. Результаты роли → PROJECT_[NAME]/AGENT_X_[ROLE]/        │
│  4. Обновлять PROJECT_[NAME]/README.md при изменениях       │
│                                                             │
│  ❌ НЕ хранить ФМ и результаты в корне fm-review-system/!   │
└─────────────────────────────────────────────────────────────┘
```

### 11. Предварительный обзор перед правками

```
┌─────────────────────────────────────────────────────────────┐
│  ПЕРЕД ВНЕСЕНИЕМ ПРАВОК В DOCX:                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ШАГ 1: ПОКАЗАТЬ ПЛАН ИЗМЕНЕНИЙ                             │
│     - Список всех правок с ID                              │
│     - Для каждой: Где → Было → Станет                      │
│     - Дать пользователю возможность скорректировать        │
│                                                             │
│  ШАГ 2: ПОЛУЧИТЬ ПОДТВЕРЖДЕНИЕ                              │
│     - "Применить N правок?" или                            │
│     - Выбор конкретных номеров                             │
│                                                             │
│  ШАГ 3: ТОЛЬКО ПОСЛЕ ПОДТВЕРЖДЕНИЯ                          │
│     - Создать бэкап                                        │
│     - Применить правки                                     │
│     - Верифицировать                                       │
│     - Создать CHANGES.md                                   │
│                                                             │
│  ❌ ЗАПРЕЩЕНО: Применять правки без показа плана!           │
└─────────────────────────────────────────────────────────────┘
```

---

## 💾 АВТОСОХРАНЕНИЕ

### Когда обновлять PROJECT_CONTEXT.md

```
ПОСЛЕ КАЖДОЙ КОМАНДЫ агента записывать:

### [Дата] — [АГЕНТ]: [команда]

**Проверено/Сделано:** [Что анализировалось/создавалось]

**Найдено:**
- [КОД-XXX] [Описание] → [Статус: открыто/решено]

**Решения:** [Если приняты]

**Открытые вопросы:**
- [ ] [Вопрос]
```

### Когда обновлять CHANGELOG.md

```
ОБНОВЛЯТЬ КОГДА:
- Изменена версия ФМ (/apply)
- Изменён агент
- Добавлена новая функциональность

ФОРМАТ:
## [vX.Y] — ДД.ММ.ГГГГ
### Что изменено
- Пункт 1
- Пункт 2
```

### Когда обновлять WORKPLAN.md

```
┌─────────────────────────────────────────────────────────────┐
│  ОБЯЗАТЕЛЬНО ОБНОВЛЯТЬ:                                    │
├─────────────────────────────────────────────────────────────┤
│  1. В НАЧАЛЕ сессии — записать план работ                  │
│  2. ПО ХОДУ работы — отмечать выполненное (🔴→🟡→🟢)       │
│  3. В КОНЦЕ сессии — итог, что сделано                     │
│  4. При ОБРЫВЕ — позволяет восстановить контекст           │
└─────────────────────────────────────────────────────────────┘

НЕ СПРАШИВАЙ "сохранить?" — СОХРАНЯЙ ВСЕГДА АВТОМАТИЧЕСКИ!
```

---

## 🔧 1С-ФОКУС (для AGENT_1)

При анализе каждого бизнес-правила проверять:

```
□ ПОСЛЕДОВАТЕЛЬНОСТЬ — можно ли сделать раньше/позже?
□ СОСТОЯНИЯ И ПЕРЕХОДЫ — все ли описаны? Можно ли перескочить?
□ ПРОВЕДЕНИЕ — когда контроль: до/при/после?
□ БЛОКИРОВКИ — что если два пользователя одновременно?
□ ПРАВА ДОСТУПА — кто может? А админ? А служебный?
□ ИДЕМПОТЕНТНОСТЬ — что если повторно провести?
□ ОТКАТ/СТОРНО — как отменить? Что с зависимыми данными?
□ ИНТЕГРАЦИИ — что если лаг/недоступность/ошибка?
□ ФОНОВЫЕ ЗАДАНИЯ — что в фоне? Что если не отработало?
□ АУДИТ — как найти кто/когда/что сделал?
```

---

## 🚫 АНТИПАТТЕРНЫ (искать и отмечать)

```
❌ "Требуется согласование" там, где можно автоправило
❌ "Запрещено" там, где нужно "разрешено с контролем"
❌ Цепочки согласований больше 2 уровней
❌ Ручные проверки того, что можно проверить автоматом
❌ "Молчание = отказ" для позитивных кейсов
❌ Контроль только на UI (обходится через API)
❌ Отсутствие дефолтов (что если не ответили?)
```

---

## 🎭 ГЛАВНЫЙ ПРИНЦИП

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   КОНТРОЛЬ НЕ ДОЛЖЕН ТОРМОЗИТЬ ОСНОВНОЙ БИЗНЕС-ПРОЦЕСС    │
│                                                             │
│   При каждом замечании/предложении спрашивай себя:         │
│   "Это ускоряет или замедляет продажи/операции?"           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 СТРУКТУРА ПРОЕКТА

```
fm-review-system/
├── CLAUDE.md                 ← Этот файл (правила)
├── README.md                 ← Описание системы
├── PROMPTS.md                ← Промпты для запуска
├── CHANGELOG.md              ← История изменений системы
├── PROJECT_CONTEXT.md        ← Общий контекст (авто)
├── WORKPLAN.md               ← Общий план работ (авто)
│
├── AGENT_0_CREATOR.md        ← Создание ФМ
├── AGENT_1_ARCHITECT.md      ← Аудит ФМ
├── AGENT_2_ROLE_SIMULATOR.md ← Симуляция ролей
├── AGENT_3_DEFENDER.md       ← Защита ФМ
├── AGENT_4_QA_TESTER.md      ← Тестирование
├── AGENT_5_TECH_ARCHITECT.md ← Проектирование + ТЗ
│
├── PROJECT_SHPMNT_PROFIT/    ← ПРОЕКТ: Контроль рентабельности
│   ├── README.md             ← Обзор проекта
│   ├── FM_DOCUMENTS/         ← Версии ФМ
│   ├── AGENT_1_ARCHITECT/    ← Результаты аудита
│   ├── AGENT_2_ROLE_SIMULATOR/  ← Симуляции ролей
│   ├── AGENT_3_DEFENDER/     ← Ответы на замечания
│   ├── AGENT_4_QA_TESTER/    ← Тест-кейсы
│   ├── AGENT_5_TECH_ARCHITECT/  ← ТЗ
│   └── REPORTS/              ← Итоговые отчёты
│
└── PROJECT_SALES_PIPELINE/   ← ПРОЕКТ: Проектные продажи
    ├── README.md             ← Обзор тематики
    ├── FM-*.md               ← Мини-ФМ
    └── docx/                 ← DOCX версии
```

---

## 📂 ПРОЕКТЫ (ПАПКИ PROJECT_*)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО РАБОТЫ С ПРОЕКТАМИ                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Если задача относится к ФМ в ПРОЕКТЕ (папка PROJECT_*):   │
│                                                             │
│  1. ФМ читать/писать в PROJECT_*/FM_DOCUMENTS/              │
│  2. Результаты роли → PROJECT_*/AGENT_X_[ROLE]/             │
│  3. Обновлять PROJECT_*/README.md при изменениях            │
│                                                             │
│  АГЕНТЫ РАБОТАЮТ ТАК:                                       │
│  - AGENT_1 (аудит) → PROJECT_*/AGENT_1_ARCHITECT/           │
│  - AGENT_2 (роли)  → PROJECT_*/AGENT_2_ROLE_SIMULATOR/      │
│  - AGENT_3 (защита)→ PROJECT_*/AGENT_3_DEFENDER/            │
│  - AGENT_4 (тесты) → PROJECT_*/AGENT_4_QA_TESTER/           │
│  - AGENT_5 (ТЗ)    → PROJECT_*/AGENT_5_TECH_ARCHITECT/      │
│                                                             │
│  Каждый проект = отдельная ФМ с полной историей работы     │
└─────────────────────────────────────────────────────────────┘
```

### Текущие проекты

| Папка | ФМ | Статус | Описание |
|-------|-----|--------|----------|
| `PROJECT_SHPMNT_PROFIT/` | FM-SHPMNT-PROFIT v2.5.3 | В работе | Контроль рентабельности при частичных отгрузках |
| `PROJECT_SALES_PIPELINE/` | — | Планирование | Оптимизация воронки, стадии, сметы |

### Когда создавать проект

```
СОЗДАВАТЬ ПРОЕКТ PROJECT_[NAME]/, если:
- Новая ФМ (отдельная тематика)
- Полноценная функциональная модель (не мини-ФМ)
- Требуется работа нескольких агентов

СТРУКТУРА ПРОЕКТА:
PROJECT_[NAME]/
├── README.md                    ← Обзор проекта + текущая версия
├── FM_DOCUMENTS/                ← ВСЕ ВЕРСИИ ФМ
│   ├── README.md                ← История версий
│   ├── FM-*-v*.docx             ← Версии документа
│   ├── FM-*-CHANGES.md          ← Списки изменений
│   └── *.bak                    ← Бэкапы
├── AGENT_1_ARCHITECT/           ← Отчёты аудита
│   └── audit-reports/
├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей
│   └── UX-FINDINGS-*.md
├── AGENT_3_DEFENDER/            ← Ответы на замечания
│   └── review-responses/
├── AGENT_4_QA_TESTER/           ← Тест-кейсы
│   └── test-cases/
├── AGENT_5_TECH_ARCHITECT/      ← Технические задания
│   └── tz/
└── REPORTS/                     ← Итоговые сводки
    └── summary-v*.md
```

---

## 🚀 ЗАПУСК АГЕНТА

```
1. Определить проект: PROJECT_[NAME]/
2. Загрузить файл агента (AGENT_X_NAME.md)
3. Загрузить ФМ из PROJECT_[NAME]/FM_DOCUMENTS/
4. Выполнить команду (/audit, /new, /tz, и т.д.)
5. Отвечать на вопросы в диалоговом режиме
6. После анализа — /apply для внесения изменений
7. Результаты сохраняются в PROJECT_[NAME]/AGENT_X_*/
```

Полный список команд — см. `PROMPTS.md`

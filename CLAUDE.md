# CLAUDE.md — Правила работы с системой FM Review Agents

> Этот файл читается Claude Code автоматически при работе с проектом.

---

## 🎯 О СИСТЕМЕ

Это система из 9 агентов для полного жизненного цикла Функциональных Моделей (ФМ) для проектов 1С: создание, проверка, публикация в Confluence.

**Файлы агентов:**
- `agents/AGENT_0_CREATOR.md` — создание ФМ с нуля
- `agents/AGENT_1_ARCHITECT.md` — полный аудит ФМ (бизнес + 1С)
- `agents/AGENT_2_ROLE_SIMULATOR.md` — симуляция ролей
- `agents/AGENT_3_DEFENDER.md` — защита от замечаний
- `agents/AGENT_4_QA_TESTER.md` — генерация тестов
- `agents/AGENT_5_TECH_ARCHITECT.md` — проектирование и ТЗ
- `agents/AGENT_6_PRESENTER.md` — презентации, экспорт
- `agents/AGENT_7_PUBLISHER.md` — управление ФМ в Confluence (публикация, версионность)
- `agents/AGENT_8_BPMN_DESIGNER.md` — BPMN-диаграммы в Confluence

**Confluence ресурсы:**
- `docs/CONFLUENCE_TEMPLATE.md` - шаблон Confluence-страницы ФМ (XHTML, макросы, панели)
- `docs/CONFLUENCE_REQUIREMENTS.md` - требования к публикации в Confluence
- `scripts/publish_to_confluence.py` - обновление Confluence (v3.0, с блокировками и бекапами)
- `scripts/import_docx.py` - одноразовый импорт DOCX в Confluence (symlink на publish_to_confluence.py)
- `scripts/lib/confluence_utils.py` - Confluence API клиент (lock, backup, retry)
- `workflows/fm-workflows.md` - 5 сквозных сценариев (create, publish, review, update, export)
- `workflows/PIPELINE_AUTO.md` - протокол автономного конвейера в чате (все 8 агентов)

**Документация (актуальная):**
- `README.md` — описание системы
- `docs/CONTRACT_CONFLUENCE_FM.md` — контракт Confluence как единственного источника ФМ
- `docs/LEAD_AUDITOR_FULL_AUDIT.md` — последний аудит системы (AG-12...AG-15)
- `docs/FC_IMPLEMENTATION_REPORT.md` — отчет реализации FC-01...FC-06
- `docs/READINESS_CHECK.md` — проверка готовности системы к работе
- `docs/PROMPTS.md` — промпты для запуска агентов
- `docs/CHANGELOG.md` — история изменений
- `docs/CONFLUENCE_TEMPLATE.md` — шаблон страницы ФМ
- `docs/CONFLUENCE_REQUIREMENTS.md` — требования к публикации

**Self-Improvement (патчи и эволюция):**
- `.patches/` — накопленные паттерны типовых ошибок в ФМ (создаются агентами 1-5 автоматически)
- `.patches/README.md` — шаблон и категории тегов
- `.patches/EVOLUTION_LOG.md` — лог всех эволюций агентов
- `agents/EVOLVE.md` — инструкции команды /evolve (анализ патчей → обновление агентов)
- `docs/PATCH_INSTRUCTIONS.md` — правила записи патчей для агентов

**Governance (обязательный протокол):**
- `AGENT_PROTOCOL.md` — обязательный workflow каждого агента (старт → работа → итог → handoff)
- `HANDOFF.md` — передача контекста между сессиями (что сделано, что дальше, блокеры)
- `DECISIONS.md` — журнал решений (ADR-lite: проблема → варианты → выбор → последствия)
- `logs/` — пошаговые логи работы агентов (формат в AGENT_PROTOCOL.md)

**Автономный пайплайн:**
- `scripts/run_agent.py` — автономный запуск агентов через Claude Code CLI (`claude -p`)

**Экспериментальные модули:**
- `scripts/experimental/contract_validator.py` — валидация JSON-выходов (отложено)

---

## 🗣️ NATURAL LANGUAGE ROUTER

```
┌─────────────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛЬ ГОВОРИТ НА ЕСТЕСТВЕННОМ ЯЗЫКЕ.               │
│  CLAUDE CODE ОПРЕДЕЛЯЕТ АГЕНТА АВТОМАТИЧЕСКИ.              │
└─────────────────────────────────────────────────────────────┘

МАРШРУТИЗАЦИЯ ПО КЛЮЧЕВЫМ ФРАЗАМ:

"Создай ФМ для...", "Новая ФМ", "Давай опишем процесс..."
  → Agent 0 (Creator) → /new

"Запусти аудит", "Проверь ФМ", "Какие проблемы в ФМ?"
  → Agent 1 (Architect) → /audit

"Как это будет для пользователя?", "Покажи UX", "Симулируй..."
  → Agent 2 (Simulator) → /simulate-all

"Вот замечания от бизнеса", "Проанализируй замечания", "Ответь на..."
  → Agent 3 (Defender) → /respond

"Создай тесты", "Какие тест-кейсы?", "Протестируй ФМ"
  → Agent 4 (QA) → /generate-all

"Спроектируй архитектуру", "Как это реализовать в 1С?", "Сделай ТЗ"
  → Agent 5 (Tech Architect) → /full

"Подготовь презентацию", "Отчёт для руководства", "Резюме проекта"
  → Agent 6 (Presenter) → /present

"Опубликуй в Confluence", "Опубликуй ФМ", "Залей в конф"
  → Agent 7 (Publisher) → /publish

"Создай BPMN", "Визуализируй процесс", "Диаграмма процесса", "BPMN-диаграмма"
  → Agent 8 (BPMN Designer) → /bpmn

"Отправь на согласование", "Статус согласования"
  → Бизнес-согласование workflow (см. секцию ниже)

"Полный цикл", "Запусти всё", "Конвейер", "Запусти полный цикл ФМ..."
  → Прочитай workflows/PIPELINE_AUTO.md и выполни протокол конвейера в чате
  → Порядок: Agent 1→2→4→5 → Quality Gate → 7→8→6 → /evolve (все этапы показываются в диалоге)

"Улучши агентов", "Обнови правила", "Эволюция", "/evolve"
  → Прочитай agents/EVOLVE.md и выполни анализ патчей из .patches/

ЕСЛИ НЕПОНЯТНО — спроси: "Уточните: вы хотите [вариант 1] или [вариант 2]?"
```

---

## 📋 ОБЩИЕ ПРАВИЛА ДЛЯ ВСЕХ АГЕНТОВ

### 1. Диалоговый режим

```
┌─────────────────────────────────────────────────────────────┐
│  ИНТЕРВЬЮ = ЖИВОЙ ДИАЛОГ, НЕ АНКЕТА!                       │
├─────────────────────────────────────────────────────────────┤
│  ❌ НЕ ДЕЛАТЬ:                                              │
│     - Выдавать все вопросы сразу                           │
│     - Формировать таблицы с вопросами                      │
│     - Показывать "план интервью"                           │
│                                                             │
│  ✅ ДЕЛАТЬ:                                                  │
│     - Задавать 1-2 вопроса за раз                          │
│     - Ждать ответа                                          │
│     - Уточнять если ответ неполный                         │
│     - Переходить к следующему только после ответа          │
└─────────────────────────────────────────────────────────────┘
```

### 2. Формат вопросов — ВСЕГДА AskUserQuestion

```
┌─────────────────────────────────────────────────────────────┐
│  ⚠️  АБСОЛЮТНОЕ ПРАВИЛО:                                    │
│  ЛЮБОЙ ВОПРОС К ПОЛЬЗОВАТЕЛЮ = AskUserQuestion             │
│  НИКОГДА не задавать вопросы текстом в чате!               │
│  Вопрос без AskUserQuestion = вопрос в пустоту.            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Задавать вопрос текстом в чате (пользователь          │
│       не сможет удобно ответить)                           │
│     - Открытые вопросы без вариантов                       │
│     - Текстовые меню "Ваш выбор (1-5):" в чате            │
│     - Длинные текстовые объяснения перед вопросом          │
│     - Оставлять вопрос "висеть" без виджета                │
│                                                             │
│  ✅ ВСЕГДА ДЕЛАТЬ:                                          │
│     - Вызывать AskUserQuestion для ЛЮБОГО вопроса          │
│     - Варианты с кратким описанием                         │
│     - Один вариант рекомендуется (⭐ в описании)            │
│     - Последний вариант всегда "Другое"                    │
│     - Группировать связанные вопросы в табы                │
│                                                             │
│  КОГДА ВЫЗЫВАТЬ:                                            │
│     - Нужно уточнение требований → AskUserQuestion         │
│     - Есть несколько вариантов → AskUserQuestion            │
│     - Нужно подтверждение действия → AskUserQuestion        │
│     - Простой да/нет → AskUserQuestion                      │
│     - Любой другой вопрос → AskUserQuestion                │
└─────────────────────────────────────────────────────────────┘
```

**Правила AskUserQuestion:**
- Формулируй вопрос с конкретными вариантами и кратким описанием каждого
- Один вариант помечай "⭐ рекомендуется" с обоснованием в описании
- Всегда добавляй вариант "Другое" для свободного ответа
- НИКОГДА не выполняй необратимые действия без подтверждения
- Пользователь должен иметь возможность ответить одним кликом
- Если сомневаешься, нужен ли AskUserQuestion - НУЖЕН

**ПРАВИЛО:** Пользователь должен иметь возможность ответить ОДНИМ КЛИКОМ. Не заставляй писать развернутые ответы.

### 3. Правило формата ФМ

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ РЕДАКТИРОВАНИИ ФМ:                                     │
│                                                             │
│  ❌ НЕЛЬЗЯ без явного указания:                             │
│     - Менять структуру документа                            │
│     - Менять оформление (шрифты, отступы, стили)           │
│     - Менять формат таблиц                                  │
│     - Переименовывать разделы                               │
│     - Менять нумерацию                                      │
│                                                             │
│  ✅ МОЖНО:                                                   │
│     - Менять СОДЕРЖАНИЕ (текст, правила, логику)           │
│     - Добавлять новые пункты В СУЩЕСТВУЮЩЕМ формате        │
│     - Исправлять ошибки в тексте                           │
│                                                             │
│  Если нужно изменить формат — СНАЧАЛА СПРОСИ!              │
└─────────────────────────────────────────────────────────────┘
```

### 4. Единственный источник истины - Confluence

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE = ЕДИНСТВЕННЫЙ ИСТОЧНИК ФМ                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ ВСЕ АГЕНТЫ:                                             │
│     - ЧИТАЮТ ФМ из Confluence (REST API, PAGE_ID)           │
│     - Правки в Confluence вносит только Agent 7 (PUT тела)  │
│     - Агенты 0-5 передают изменения Agent 7 для публикации  │
│     - Версионность = встроенная Confluence (page versions)  │
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Читать ФМ из Word/DOCX как источник актуальной ФМ     │
│     - Использовать FM_DOCUMENTS/*.docx как источник правды  │
│     - Создавать новые версии .docx как актуальную ФМ        │
│     - Ссылаться на Word как на "актуальную версию"          │
│                                                             │
│  ИНСТРУМЕНТЫ:                                               │
│     - scripts/publish_to_confluence.py — первичный импорт  │
│     - scripts/export_from_confluence.py — экспорт PDF/Word │
│     - Confluence REST API — чтение/запись через Python      │
│                                                             │
│  CONFLUENCE API:                                             │
│     URL: https://confluence.ekf.su                          │
│     API: /rest/api/content/{PAGE_ID}                       │
│     Auth: Bearer token (PAT)                               │
│     Формат: XHTML storage                                  │
└─────────────────────────────────────────────────────────────┘
```

**КОНФЛУЕНС — ЕДИНСТВЕННЫЙ ИСТОЧНИК ПРАВДЫ (канон):**

```
1. ИСТОЧНИК: Confluence = единственный источник правды по ФМ.
   Все читают ФМ оттуда; все правки формируются для внесения туда.
   Тело страницы обновляет только Agent 7.

2. ВЕРСИОННОСТЬ: Полностью ведётся в Confluence.
   При каждом PUT — автоинкремент version.number;
   история версий доступна в UI (Page History).

3. ДАТА: В мета-блоке на странице дата = текущая дата при обновлении
   (ставится автоматически при публикации).

4. ТАБЛИЦА ИЗМЕНЕНИЙ: На странице ФМ ведётся таблица "История версий"
   (колонки: Номер | Дата | Автор | Изменения).
   При каждом обновлении в неё добавляется строка с кратким описанием
   изменений. Плюс version.message в API — краткое описание версии.
   ЖЕСТКИЕ ПРАВИЛА для таблицы "История версий":
   - Автор: ВСЕГДА "Шаховский А.С." (НЕ имя агента, НЕ "Claude", НЕ "Bot")
   - Описание: ТОЛЬКО бизнес-язык (НЕ коды типа CRIT-001, НЕ технические ID)
   - Описание должно быть понятно бизнес-пользователю без аудиторского отчета
```

**РАБОТА С ФМ В CONFLUENCE:**

```bash
# Чтение ФМ из Confluence (Python)
python3 -c "
import json, urllib.request, ssl
ssl._create_default_https_context = ssl._create_unverified_context
url = 'https://confluence.ekf.su/rest/api/content/PAGE_ID?expand=body.storage,version'
req = urllib.request.Request(url, headers={'Authorization': 'Bearer TOKEN'})
data = json.loads(urllib.request.urlopen(req).read())
print(data['body']['storage']['value'])  # XHTML контент ФМ
"

# Экспорт ФМ в PDF/Word (из Confluence)
python3 scripts/export_from_confluence.py --both

# Первичный импорт (только один раз, legacy)
# python3 scripts/publish_to_confluence.py path/to/source.docx
```

**ПРАВИЛА:**
- Confluence-страница = актуальная версия ФМ; все читают оттуда, правки вносятся туда (через Agent 7).
- Версионность ведется в Confluence; дата в мета-блоке - автоматически при обновлении.
- Каждое обновление: новая строка в таблице «История версий» на странице с кратким описанием изменений.
- Экспорт в PDF/Word — только для чтения офлайн.

### 5. Правила текста и форматирования (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛА ОФОРМЛЕНИЯ ТЕКСТА В ДОКУМЕНТАХ:                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. ТИРЕ И ДЕФИСЫ:                                          │
│     ❌ НИКОГДА не использовать длинное тире (—)             │
│     ✅ ВСЕГДА использовать обычный дефис (-)                │
│     Пример: "Заказ - это документ" (НЕ "Заказ — это...")   │
│                                                             │
│  2. БУКВА Ё:                                                │
│     ❌ НИКОГДА не использовать букву "ё"                    │
│     ✅ ВСЕГДА заменять на "е"                               │
│     Пример: "Отчеты" (НЕ "Отчёты"), "Расчеты" (НЕ "Расчёты")│
│                                                             │
│  3. ПУНКТУАЦИЯ В СПИСКАХ:                                   │
│     ✅ В перечислениях использовать точку с запятой (;)     │
│     ✅ В конце последнего элемента - точку (.)              │
│     Пример:                                                 │
│       - Первый пункт;                                       │
│       - Второй пункт;                                       │
│       - Последний пункт.                                    │
│                                                             │
│  4. ГРАММАТИКА И ПУНКТУАЦИЯ:                                │
│     ✅ Постоянно проверять грамматику ОЧЕНЬ тщательно       │
│     ✅ Проверять пунктуацию в каждом предложении            │
│     ✅ Избегать канцелярита и технических терминов          │
│     ✅ Писать для бизнеса, не для программистов             │
│                                                             │
│  5. СТИЛЬ ИЗЛОЖЕНИЯ:                                        │
│     ✅ Простой, понятный язык                               │
│     ✅ Короткие предложения                                 │
│     ❌ Избегать: "является единственным источником истины"  │
│     ✅ Использовать: "используется для принятия решений"    │
│                                                             │
│  ⚠️  ЭТИ ПРАВИЛА ПРИМЕНЯЮТСЯ КО ВСЕМ ДОКУМЕНТАМ!           │
└─────────────────────────────────────────────────────────────┘

### 6. Язык и терминология в ФМ

┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: ТОЛЬКО РУССКИЙ ЯЗЫК, БЕЗ АНГЛИЦИЗМОВ             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО использовать:                                 │
│     - Англицизмы: race condition, deadlock, timeout         │
│     - Технический сленг: дебаг, коммит, пуш, merge         │
│     - IT-термины: callback, workflow, pipeline              │
│                                                             │
│  ✅ ИСПОЛЬЗОВАТЬ русские эквиваленты:                       │
│     - race condition → конфликт параллельных операций       │
│     - deadlock → взаимная блокировка                        │
│     - timeout → превышение времени ожидания                 │
│     - rollback → откат изменений                            │
│     - commit → фиксация / проведение                        │
│     - debug → отладка                                       │
│                                                             │
│  ИСКЛЮЧЕНИЯ (допустимы):                                    │
│     - Названия полей 1С: "Проведен", "ПометкаУдаления"     │
│     - Названия объектов: "Документ.ЗаказКлиента"           │
│     - SQL, API — только в технических примерах кода         │
│                                                             │
│  ПРИЧИНА:                                                   │
│  ФМ читают бизнес-пользователи, не программисты.           │
│  Англицизмы снижают понятность и вызывают вопросы.         │
└─────────────────────────────────────────────────────────────┘
```

### 7. Версионирование ФМ

```
X.Y.Z где:
- X — мажорная версия (новый процесс)
- Y — минорная версия (новые разделы/функции)
- Z — патч (исправления, уточнения)

Примеры:
- 1.0.0 → 1.0.1 (патч после аудита)
- 1.0.1 → 1.1.0 (добавлен новый раздел)
- 1.1.0 → 2.0.0 (переделан весь процесс)

┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: ОДНА ДАТА = ОДНА ВЕРСИЯ                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Если изменения вносятся В ТОТ ЖЕ ДЕНЬ:                    │
│  → НЕ создавать новую версию                               │
│  → Дополнить описание текущей версии                       │
│                                                             │
│  Новая версия (Z+1) создается ТОЛЬКО если дата другая.     │
│                                                             │
│  ИСКЛЮЧЕНИЕ: первая публикация (v1.0.0) - отдельная строка,│
│  даже если правки в тот же день.                           │
│                                                             │
│  Это правило применяется ко ВСЕМ документам:               │
│  ФМ, ТЗ, Архитектура, Тесты, Отчеты.                      │
└─────────────────────────────────────────────────────────────┘
```

### 8. Применение изменений (/apply)

```
┌─────────────────────────────────────────────────────────────┐
│  КРИТИЧНО: ИНТЕГРИРОВАТЬ ИЗМЕНЕНИЯ СРАЗУ В ОСНОВНОЙ ТЕКСТ! │
├─────────────────────────────────────────────────────────────┤
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Создавать разделы "ДОПОЛНЕНИЯ И УТОЧНЕНИЯ"           │
│     - Добавлять изменения в конец документа отдельным блоком│
│     - Оставлять изменения "на потом для интеграции"        │
│     - Создавать приложения с изменениями                    │
│                                                             │
│  ✅ ВСЕГДА:                                                  │
│     - Интегрировать изменения СРАЗУ в основной текст        │
│     - Редактировать существующие пункты документа           │
│     - Готовый документ с интегрированными изменениями       │
│     - Пользователь получает финальный документ, не черновик │
└─────────────────────────────────────────────────────────────┘

ПОСЛЕ АУДИТА/АНАЛИЗА:

1. Показал список проблем/замечаний
2. СРАЗУ СПРАШИВАЮ:
   "Внести изменения в ФМ и создать версию X.Y.Z?"

3. Если пользователь говорит ДА:
   - Уточняю: "Какие замечания применить? Все / Только критические / Конкретные номера"
   - Вношу изменения СРАЗУ В ОСНОВНОЙ ТЕКСТ документа (СОХРАНЯЯ ФОРМАТ!)
   - Нахожу соответствующие пункты и редактирую их напрямую
   - Создаю новую версию файла
   - Показываю список изменений

4. Формат вывода:
   "Создана версия X.Y.Z. Изменения:
    - п. 3.4: [что изменено]
    - п. 3.7: [что изменено]
    - ..."
```

### 9. Обязательные метаданные при /apply

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ ОБНОВЛЕНИИ ФМ В CONFLUENCE — ДВА МЕСТА НА СТРАНИЦЕ:    │
│  ОБА ОБЯЗАТЕЛЬНЫ. ПРОПУСК ЛЮБОГО = ОШИБКА.                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. МЕТА-БЛОК (строка вверху страницы):                     │
│     ФОРМАТ: <p><strong>Код проекта:</strong> FM-...         │
│       <strong>Версия ФМ:</strong> X.Y.Z                    │
│       <strong>Дата:</strong> ДД.ММ.ГГГГ                    │
│       <strong>Автор:</strong> Шаховский А.С.               │
│       <strong>Платформа:</strong> 1С:УТ</p>                │
│     → ОБНОВИТЬ версию (1.0.0 → 1.0.1)                     │
│     → ОБНОВИТЬ дату на текущую                             │
│     ⚠️ ИСКАТЬ ТОЧНЫЙ ПАТТЕРН В XHTML, НЕ ПОЛАГАТЬСЯ       │
│        НА ОБЩИЕ РЕГУЛЯРКИ ТИПА >X.Y.Z<                     │
│                                                             │
│  2. ТАБЛИЦА "ИСТОРИЯ ВЕРСИЙ" (Номер/Дата/Автор/Изменения): │
│     → ДОБАВИТЬ новую строку В КОНЕЦ (не удаляя старые!)    │
│                                                             │
│     АВТОР: ВСЕГДА "Шаховский А.С."                         │
│     ❌ НИКОГДА не писать "Agent X", "Claude", "Bot" и т.д. │
│     ❌ НИКОГДА не писать имя агента как автора              │
│     Автор ФМ - человек, агенты - инструмент.               │
│                                                             │
│     ОПИСАНИЕ: Бизнес-язык, понятный человеку.              │
│     ✅ "Устранены противоречия в формулах, исправлены      │
│        ссылки, добавлены недостающие определения"           │
│     ✅ "Уточнены SLA, добавлен план отката пилота"         │
│     ❌ ЗАПРЕЩЕНО: коды (CRIT-001, HIGH-003), ID правок     │
│     ❌ ЗАПРЕЩЕНО: технический жаргон (fix, audit, patch)    │
│     ❌ ЗАПРЕЩЕНО: "30 правок", "v38", номера версий Confl.  │
│     Бизнес-пользователь должен понять суть изменений       │
│     БЕЗ чтения аудиторского отчета.                        │
│                                                             │
│     ❌ НЕ ЗАТИРАТЬ предыдущие строки таблицы                │
│                                                             │
│  3. ВЕРСИЯ CONFLUENCE                                       │
│     - Автоинкремент при каждом PUT                         │
│     - version.message: "[FM X.Y.Z] краткое описание"       │
│                                                             │
│  ⚠️ ЧЕКЛИСТ ПЕРЕД PUT (проверить оба места!):               │
│     □ Мета-блок: версия + дата обновлены?                  │
│     □ История: строка добавлена?                           │
│     □ История: автор = "Шаховский А.С."?                   │
│     □ История: описание на бизнес-языке, без кодов?        │
│     □ Старые строки истории на месте?                      │
│                                                             │
│  ⚠️ ВЕРИФИКАЦИЯ ЧЕРЕЗ API ПОСЛЕ PUT:                        │
│     - GET страницы, проверить ОБА места                    │
│     - Убедиться что МЕТА-БЛОК обновлен                     │
│     - Убедиться что автор = "Шаховский А.С."              │
│     - Убедиться что описание без кодов                     │
└─────────────────────────────────────────────────────────────┘
```

### 10. Верификация изменений (КРИТИЧНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: НЕ ОТМЕЧАТЬ ✅ БЕЗ РЕАЛЬНОЙ ПРОВЕРКИ!            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Отмечать ✅ на основе "скрипт выполнился"            │
│     - Писать "Готово" без верификации                      │
│     - Доверять автоматическим проверкам без перепроверки   │
│                                                             │
│  ✅ ОБЯЗАТЕЛЬНО:                                            │
│     - После обновления — GET страницы из Confluence        │
│     - Искать ОТСУТСТВИЕ старых значений в XHTML            │
│     - Проверять НАЛИЧИЕ новых значений в контенте          │
│     - Проверять version.number (должен инкрементироваться) │
│                                                             │
│  ОБЯЗАТЕЛЬНЫЕ ПРОВЕРКИ МЕТАДАННЫХ (каждый PUT!):            │
│  □ Мета-блок (верхняя строка): версия + дата обновлены     │
│  □ История версий: строка добавлена?                       │
│  □ История версий: автор = "Шаховский А.С." (НЕ агент!)   │
│  □ История версий: описание на бизнес-языке, без кодов     │
│  Если любая проверка не прошла - ИСПРАВИТЬ ДО завершения!  │
│                                                             │
│  АЛГОРИТМ ВЕРИФИКАЦИИ:                                      │
│  1. PUT обновление в Confluence                            │
│  2. GET страницы: проверить ВСЕ правки в XHTML             │
│  3. Проверить ОТСУТСТВИЕ старых значений                   │
│  4. Если что-то не найдено — ИСПРАВЛЯЕМ, а не игнорируем   │
│  5. Только после 2+3+4 отмечаем ✅                          │
└─────────────────────────────────────────────────────────────┘
```

### 11. Версионность в Confluence

```
┌─────────────────────────────────────────────────────────────┐
│  CONFLUENCE = ВСТРОЕННАЯ ВЕРСИОННОСТЬ:                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  - Каждый PUT = новая версия (автоинкремент)               │
│  - История всех версий доступна через UI и API             │
│  - Откат к любой предыдущей версии                         │
│  - Комментарий к версии: описание изменений                │
│                                                             │
│  ⚠️ ПЕРЕД КРУПНЫМИ ИЗМЕНЕНИЯМИ:                             │
│     - Зафиксировать текущую version.number                  │
│     - После изменений — проверить version.number + 1       │
│     - При ошибке — откатить через Confluence UI             │
└─────────────────────────────────────────────────────────────┘
```

### 12. Нумерация в документах

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО: Только цифровая нумерация (1., 1.1., 1.1.1.)      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Смесь цифр и букв: 3.2а., 3.4б.                       │
│     - Текстовая нумерация (просто текст "1." в начале)      │
│                                                             │
│  ✅ ИСПОЛЬЗОВАТЬ:                                           │
│     - Только цифры: 1., 1.1., 1.1.1., ...                   │
│     - При добавлении раздела - перенумеровать               │
└─────────────────────────────────────────────────────────────┘
```

### 13. Файл изменений (CHANGES.md) - ОБЯЗАТЕЛЬНО!

```
┌─────────────────────────────────────────────────────────────┐
│  ПРИ КАЖДОМ /apply СОЗДАВАТЬ ФАЙЛ ИЗМЕНЕНИЙ:                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ФОРМАТ ИМЕНИ:                                              │
│     FM-[NAME]-v[X.Y.Z]-CHANGES.md                           │
│     Пример: FM-LS-PROFIT-v1.0.1-CHANGES.md                  │
│                                                             │
│  СОДЕРЖАНИЕ:                                                │
│  1. Заголовок с датой, агентом, задачей                    │
│  2. Таблица изменений (ID, Где, Было, Стало, Причина)      │
│  3. Не применённые изменения (LOW) с причинами             │
│  4. Решения по уточняющим вопросам                         │
│  5. Результат верификации (чек-лист ✅)                     │
│                                                             │
│  ⚠️ СОЗДАВАТЬ СРАЗУ ПОСЛЕ ВЕРИФИКАЦИИ, ДО ОТЧЁТА ЮЗЕРУ!    │
│                                                             │
│  📁 КУДА СОХРАНЯТЬ (AG-06): PROJECT_[NAME]/CHANGES/         │
│     При отсутствии папки CHANGES/ - создать ее              │
└─────────────────────────────────────────────────────────────┘
```

### 14. Хранилище ФМ и результатов (в папке проекта)

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДАЯ ФМ = ОТДЕЛЬНЫЙ ПРОЕКТ В ПАПКЕ PROJECT_[NAME]/       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  СТРУКТУРА ПРОЕКТА (локальная):                             │
│     PROJECT_[NAME]/                                         │
│     ├── README.md                    ← Обзор проекта        │
│     ├── CONFLUENCE_PAGE_ID           ← ID страницы ФМ       │
│     ├── CHANGES/                     ← Списки изменений     │
│     │   └── FM-*-CHANGES.md          ← Логи правок          │
│     │                                                       │
│     ├── AGENT_1_ARCHITECT/           ← Результаты аудита    │
│     ├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей      │
│     ├── AGENT_3_DEFENDER/            ← Ответы на замечания  │
│     ├── AGENT_4_QA_TESTER/           ← Тест-кейсы           │
│     ├── AGENT_5_TECH_ARCHITECT/      ← ТЗ и архитектура     │
│     └── REPORTS/                     ← Итоговые отчеты      │
│                                                             │
│  СТРУКТУРА В CONFLUENCE (зеркало):                          │
│     [Проект]                                                │
│     ├── Функциональные модели                               │
│     │   └── FM-[NAME]                ← страница ФМ          │
│     ├── ТЗ и Архитектура                                    │
│     │   ├── TS-FM-[NAME]             ← техзадание           │
│     │   └── ARC-FM-[NAME]            ← архитектура          │
│     ├── Тестирование                                        │
│     │   └── TC-FM-[NAME]             ← тест-план            │
│     └── Отчеты                                              │
│         └── RPT-FM-[NAME]            ← итоговый отчет       │
│                                                             │
│  ПРИ РАБОТЕ С ФМ:                                           │
│  1. Определить проект: PROJECT_[NAME]/                      │
│  2. ФМ читать/писать ТОЛЬКО через Confluence REST API       │
│  3. Результаты роли → PROJECT_[NAME]/AGENT_X_[ROLE]/        │
│  4. Обновлять PROJECT_[NAME]/README.md при изменениях       │
│                                                             │
│  ❌ НЕ хранить ФМ и результаты в корне fm-review-system/!   │
└─────────────────────────────────────────────────────────────┘
```

### 15. Предварительный обзор перед правками

```
┌─────────────────────────────────────────────────────────────┐
│  ПЕРЕД ВНЕСЕНИЕМ ПРАВОК В CONFLUENCE:                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ШАГ 1: ПОКАЗАТЬ ПЛАН ИЗМЕНЕНИЙ                             │
│     - Список всех правок с ID                              │
│     - Для каждой: Где → Было → Станет                      │
│     - Дать пользователю возможность скорректировать        │
│                                                             │
│  ШАГ 2: ПОЛУЧИТЬ ПОДТВЕРЖДЕНИЕ                              │
│     - "Применить N правок?" или                            │
│     - Выбор конкретных номеров                             │
│                                                             │
│  ШАГ 3: ТОЛЬКО ПОСЛЕ ПОДТВЕРЖДЕНИЯ                          │
│     - Применить правки в Confluence (PUT)                   │
│     - Верифицировать (GET + проверка)                      │
│     - Создать CHANGES.md                                   │
│                                                             │
│  ❌ ЗАПРЕЩЕНО: Применять правки без показа плана!           │
└─────────────────────────────────────────────────────────────┘
```

### 16. Неприкосновенность истории версий (КРИТИЧНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ТАБЛИЦА "ИСТОРИЯ ВЕРСИЙ" = ЮРИДИЧЕСКИЙ ФАКТ               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ПРИНЦИП: ИСТОРИЯ ДОПОЛНЯЕТСЯ, НЕ РЕДАКТИРУЕТСЯ.           │
│                                                             │
│  1.1. Каждая строка таблицы - историческая фиксация        │
│       состояния документа на конкретную дату.               │
│  1.2. ЗАПРЕЩЕНО редактировать ранее зафиксированные:        │
│       - номера версий                                       │
│       - даты                                                │
│       - авторов                                             │
│       - описания                                            │
│  1.3. Изменения оформляются ТОЛЬКО через:                   │
│       - создание НОВОЙ строки с новой версией               │
│       - указание текущей даты                               │
│       - указание автора                                     │
│       - описание причины изменения                          │
│  1.4. Нарушение = критическая методологическая ошибка.      │
│                                                             │
│  ⚠️  ПРИ ПОИСКЕ-ЗАМЕНЕ В XHTML:                             │
│     - НЕ использовать глобальные регулярки по версиям       │
│       (replace_all для "1.0.2" затронет историю!)           │
│     - Заменять ТОЛЬКО в мета-блоке, НЕ в таблице истории    │
│                                                             │
│     - После замены ПРОВЕРИТЬ: все старые строки истории      │
│       сохранили исходные номера и даты                      │
│                                                             │
│  ВЕРИФИКАЦИЯ ПОСЛЕ КАЖДОГО PUT:                              │
│     □ Все строки истории на месте (кол-во строк)?           │
│     □ Даты старых строк не изменились?                      │
│     □ Номера старых версий не изменились?                   │
│     □ Описания старых строк не изменились?                  │
└─────────────────────────────────────────────────────────────┘
```

### 17. Стандарты форматирования XHTML (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ДОБАВЛЕНИЕ СТРОК/ЯЧЕЕК = КОПИРОВАНИЕ СТИЛЯ СОСЕДЕЙ        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  2.1. При добавлении строк в таблицу - КОПИРОВАТЬ           │
│       style="..." из соседних строк той же таблицы.         │
│       Не оставлять ячейки без стилей.                       │
│  2.2. При добавлении в таблицу требований - КОПИРОВАТЬ      │
│       background-color, text-align, font-weight из          │
│       соседних строк с тем же приоритетом (P1=зеленый,      │
│       P2=желтый и т.д.).                                    │
│  2.3. При добавлении в глоссарий - КОПИРОВАТЬ               │
│       background-color из заголовка или соседних строк.      │
│  2.4. Визуальная консистентность = обязательная проверка    │
│       ПЕРЕД PUT. Если добавил строку - сравни стиль         │
│       с соседними.                                          │
│                                                             │
│  2.5. Единый цвет заголовков таблиц: rgb(255,250,230).      │
│       ❌ НИКОГДА не использовать rgb(59,115,175) (синий)     │
│       ❌ НИКОГДА не создавать заголовки <th> без style=      │
│       ✅ ВСЕГДА: <th style="background-color:               │
│          rgb(255,250,230);"><strong>Текст</strong></th>      │
│  2.6. Глоссарий: НЕ использовать <strong> в ячейках         │
│       термина. Существующие записи без <strong> = стандарт.  │
│  2.7. Не добавлять в глоссарий очевидные аббревиатуры       │
│       (ФД, СБ, IT-директор и т.п.) - итак понятно.          │
│                                                             │
│  ЧЕКЛИСТ ФОРМАТИРОВАНИЯ (перед каждым PUT):                  │
│     □ У новых строк есть style, как у соседних?             │
│     □ Приоритеты (P1/P2/P3) имеют правильный фон?          │
│     □ Ширины столбцов не сломаны?                           │
│     □ Нет пустых td без стилей рядом со стилизованными?    │
│     □ ВСЕ заголовки таблиц = rgb(255,250,230)?             │
│     □ Глоссарий: нет <strong> в ячейках терминов?           │
└─────────────────────────────────────────────────────────────┘
```

### 18. Простота бизнес-языка (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ФМ = ИНСТРУМЕНТ БИЗНЕСА, НЕ АКАДЕМИЧЕСКИЙ ДОКУМЕНТ        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  3.1. Формулировки - короткие и понятные.                   │
│       ❌ "кратковременная блокировка до завершения           │
│          пересчета рентабельности, чтобы параллельные       │
│          Заказы не использовали устаревшие данные"          │
│       ✅ "при возврате - пауза на пересчет (до 30 сек.)"   │
│                                                             │
│  3.2. Запрещено усложнять без необходимости.                │
│       ❌ "Режим работы системы контроля, при котором         │
│          отклонения рассчитываются и фиксируются, но        │
│          блокировка не выполняется (только предупреждения)" │
│       ✅ "Система предупреждает, но не блокирует"           │
│                                                             │
│  3.3. Тест читаемости: если бизнес-пользователь             │
│       не поймет с первого прочтения - переписать.           │
│                                                             │
│  3.4. Детализация обучения, SLA, лимитов -                  │
│       без избыточных подробностей. ФМ фиксирует ЧТО,       │
│       а не КАК (КАК - в ТЗ на разработку).                 │
│                                                             │
│  3.5. Каждое добавление в ФМ проверять вопросом:            │
│       "Менеджер продаж это поймет?" Если нет - упростить.  │
└─────────────────────────────────────────────────────────────┘
```

### 19. Публикация документов в Confluence (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ВСЕ КЛЮЧЕВЫЕ ДОКУМЕНТЫ ПУБЛИКУЮТСЯ В CONFLUENCE            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ПРАВИЛО: Локальные файлы = рабочие черновики.              │
│  Confluence = единственный источник для стейкхолдеров.     │
│  После создания документа агент ОБЯЗАН опубликовать его    │
│  в Confluence (или передать Agent 7 для публикации).       │
│                                                             │
│  ТИПЫ ДОКУМЕНТОВ И КОДИРОВКА:                               │
│                                                             │
│  | Тип          | Префикс | Пример           | Агент     │
│  |--------------|---------|------------------|-----------|│
│  | Функц. модель| FM-     | FM-LS-PROFIT     | Agent 0/1 |│
│  | Техзадание   | TS-     | TS-FM-PROFIT     | Agent 5   |│
│  | Архитектура  | ARC-    | ARC-FM-PROFIT    | Agent 5   |│
│  | Тест-план    | TC-     | TC-FM-PROFIT     | Agent 4   |│
│  | Отчет        | RPT-    | RPT-FM-PROFIT    | Agent 6   |│
│                                                             │
│  СТРУКТУРА СТРАНИЦ В CONFLUENCE:                            │
│                                                             │
│  Проекты                                                    │
│  └── [Название проекта]            ← корень проекта        │
│      ├── Функциональные модели                              │
│      │   └── FM-[NAME]             ← страница ФМ           │
│      ├── ТЗ и Архитектура                                   │
│      │   ├── TS-FM-[NAME]          ← техзадание            │
│      │   └── ARC-FM-[NAME]         ← архитектура           │
│      ├── Тестирование                                       │
│      │   └── TC-FM-[NAME]          ← тест-план             │
│      └── Отчеты                                             │
│          └── RPT-FM-[NAME]         ← итоговый отчет        │
│                                                             │
│  ОБЯЗАТЕЛЬНО ПУБЛИКОВАТЬ:                                   │
│  ✅ ФМ (Agent 0/1 → Agent 7)                               │
│  ✅ ТЗ на разработку (Agent 5)                             │
│  ✅ Архитектуру (Agent 5)                                  │
│  ✅ Тест-план (Agent 4) — по решению пользователя          │
│  ✅ Итоговый отчет (Agent 6) — по решению пользователя     │
│                                                             │
│  ПРАВИЛА ПУБЛИКАЦИИ:                                        │
│  1. Название страницы = код документа (TS-FM-PROFIT)        │
│  2. Родительская страница = соответствующий раздел          │
│  3. Формат = XHTML storage format (как ФМ)                  │
│  4. Версионность = встроенная Confluence                    │
│  5. При обновлении документа - обновлять и в Confluence     │
│  6. PAGE_ID новых страниц фиксировать в PROJECT_CONTEXT.md │
│                                                             │
│  ⚠️ ИДЕМПОТЕНТНОСТЬ (ОБЯЗАТЕЛЬНО!):                        │
│  ЕСЛИ страница УЖЕ СУЩЕСТВУЕТ в Confluence:                │
│  → ОБНОВИТЬ существующую (PUT + инкремент версии)          │
│  → НЕ создавать дубликат!                                  │
│  Проверка: GET по PAGE_ID из PROJECT_CONTEXT.md             │
│  Локально: перезаписать файл, НЕ плодить v1.0.6, v1.0.7   │
│                                                             │
│  📋 ИСТОРИЯ ВЕРСИЙ (на каждой странице!):                   │
│  Все документы (ТЗ, Архитектура, Тест-план, Отчет)         │
│  должны содержать таблицу "История версий" КАК В ФМ:       │
│  (Номер | Дата | Автор | Изменения)                        │
│  - При обновлении - добавлять строку, НЕ затирать старые   │
│  - Автор: ВСЕГДА "Шаховский А.С."                          │
│  - Описание: бизнес-язык, без кодов                        │
│                                                             │
│  ПОСЛЕ ПУБЛИКАЦИИ В CONFLUENCE:                              │
│  □ PAGE_ID записан в PROJECT_CONTEXT.md                     │
│  □ Ссылка на страницу добавлена в README.md проекта        │
│  □ Документ доступен стейкхолдерам по ссылке               │
│  □ История версий ведется (таблица на странице)            │
└─────────────────────────────────────────────────────────────┘
```

### 20. Запрет упоминания ИИ и агентов в документах (АБСОЛЮТНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  В ЛЮБЫХ ДОКУМЕНТАХ ДЛЯ СТЕЙКХОЛДЕРОВ:                     │
│  НИКОГДА, НИГДЕ, НИ В КАКОМ ВИДЕ не упоминать:             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО ПИСАТЬ:                                       │
│     - "Agent 0/1/2/3/4/5/6/7/8"                           │
│     - "Tech Architect", "QA Tester", "Simulator" и т.д.    │
│     - "Claude", "GPT", "ИИ", "AI", "Bot", "LLM"           │
│     - "Сгенерировано автоматически"                        │
│     - "Агент создал", "Агент проверил"                     │
│     - Любые ссылки на то, что документ создан ИИ           │
│                                                             │
│  ✅ ВМЕСТО ЭТОГО:                                           │
│     - Автор: "Шаховский А.С." (ВСЕГДА, ВЕЗДЕ)             │
│     - Без указания инструмента создания                    │
│     - Документ выглядит как написанный человеком            │
│                                                             │
│  ГДЕ ПРИМЕНЯЕТСЯ:                                           │
│     - Confluence: ФМ, ТЗ, Архитектура, Тесты, Отчеты      │
│     - Мета-блоки (Автор: ...)                              │
│     - Таблицы "История версий" (колонка Автор)             │
│     - Тело документа (нигде в тексте!)                     │
│     - version.message в API                                 │
│     - Любые экспорты (PDF, DOCX, PPTX)                    │
│                                                             │
│  ⚠️ ЧЕКЛИСТ ПЕРЕД КАЖДОЙ ПУБЛИКАЦИЕЙ:                       │
│     □ Нет слов "Agent", "Claude", "Bot", "ИИ" в тексте?   │
│     □ Автор = "Шаховский А.С." везде?                      │
│     □ Документ не выдает происхождение от ИИ?              │
└─────────────────────────────────────────────────────────────┘
```

### 21. Сворачиваемое оглавление (TOC)

```
┌─────────────────────────────────────────────────────────────┐
│  ОГЛАВЛЕНИЕ В CONFLUENCE = СВОРАЧИВАЕМОЕ                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  TOC оборачивается в макрос expand:                        │
│                                                             │
│  <ac:structured-macro ac:name="expand">                    │
│    <ac:parameter ac:name="title">Содержание</ac:parameter> │
│    <ac:rich-text-body>                                      │
│      <ac:structured-macro ac:name="toc">                   │
│        <ac:parameter ac:name="maxLevel">3</ac:parameter>   │
│      </ac:structured-macro>                                │
│    </ac:rich-text-body>                                     │
│  </ac:structured-macro>                                    │
│                                                             │
│  ❌ НЕ создавать ручное оглавление (markdown-ссылки)       │
│  ❌ НЕ использовать <a href="#якорь">                       │
│  ✅ ТОЛЬКО макрос toc внутри expand                        │
└─────────────────────────────────────────────────────────────┘
```

### 22. Актуальная версия ФМ (ОБЯЗАТЕЛЬНО!)

```
┌─────────────────────────────────────────────────────────────┐
│  ВЕРСИЯ ФМ = ТОЛЬКО ИЗ CONFLUENCE (НЕ ИЗ ЛОКАЛЬНЫХ ФАЙЛОВ)│
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ❌ ЗАПРЕЩЕНО:                                              │
│     - Полагаться на версию из PROJECT_CONTEXT.md            │
│     - Использовать версию из локальных файлов              │
│     - Предполагать версию без проверки                      │
│                                                             │
│  ✅ ОБЯЗАТЕЛЬНО:                                            │
│     - ВСЕГДА проверять текущую версию ФМ через             │
│       Confluence API (GET страницы, парсинг мета-блока)    │
│     - Использовать эту версию как базу для инкремента      │
│     - После /apply обновлять PROJECT_CONTEXT.md            │
│                                                             │
│  ПРИЧИНА: Другие агенты/сессии могут обновить ФМ.          │
│  Локальный PROJECT_CONTEXT.md может быть устаревшим.       │
│  Confluence = единственный источник правды по версии.       │
└─────────────────────────────────────────────────────────────┘
```

---

## 💾 АВТОСОХРАНЕНИЕ

> **Канон контекста проекта:** контекст проекта хранится в `PROJECT_[NAME]/PROJECT_CONTEXT.md`. Агенты читают и обновляют только этот файл.

### Когда обновлять PROJECT_CONTEXT.md

```
ПОСЛЕ КАЖДОЙ КОМАНДЫ агента записывать:

### [Дата] — [АГЕНТ]: [команда]

**Проверено/Сделано:** [Что анализировалось/создавалось]

**Найдено:**
- [КОД-XXX] [Описание] → [Статус: открыто/решено]

**Решения:** [Если приняты]

**Открытые вопросы:**
- [ ] [Вопрос]
```

### Когда обновлять CHANGELOG.md

```
ОБНОВЛЯТЬ КОГДА:
- Изменена версия ФМ (/apply)
- Изменён агент
- Добавлена новая функциональность

ФОРМАТ:
## [vX.Y] — ДД.ММ.ГГГГ
### Что изменено
- Пункт 1
- Пункт 2
```

### Когда обновлять WORKPLAN.md

```
┌─────────────────────────────────────────────────────────────┐
│  ОБЯЗАТЕЛЬНО ОБНОВЛЯТЬ:                                    │
├─────────────────────────────────────────────────────────────┤
│  1. В НАЧАЛЕ сессии — записать план работ                  │
│  2. ПО ХОДУ работы — отмечать выполненное (🔴→🟡→🟢)       │
│  3. В КОНЦЕ сессии — итог, что сделано                     │
│  4. При ОБРЫВЕ — позволяет восстановить контекст           │
└─────────────────────────────────────────────────────────────┘

НЕ СПРАШИВАЙ "сохранить?" — СОХРАНЯЙ ВСЕГДА АВТОМАТИЧЕСКИ!
```

---

## 🔧 1С-ФОКУС (для AGENT_1)

При анализе каждого бизнес-правила проверять:

```
□ ПОСЛЕДОВАТЕЛЬНОСТЬ — можно ли сделать раньше/позже?
□ СОСТОЯНИЯ И ПЕРЕХОДЫ — все ли описаны? Можно ли перескочить?
□ ПРОВЕДЕНИЕ — когда контроль: до/при/после?
□ БЛОКИРОВКИ — что если два пользователя одновременно?
□ ПРАВА ДОСТУПА — кто может? А админ? А служебный?
□ ИДЕМПОТЕНТНОСТЬ — что если повторно провести?
□ ОТКАТ/СТОРНО — как отменить? Что с зависимыми данными?
□ ИНТЕГРАЦИИ — что если лаг/недоступность/ошибка?
□ ФОНОВЫЕ ЗАДАНИЯ — что в фоне? Что если не отработало?
□ АУДИТ — как найти кто/когда/что сделал?
```

---

## 🚫 АНТИПАТТЕРНЫ (искать и отмечать)

```
❌ "Требуется согласование" там, где можно автоправило
❌ "Запрещено" там, где нужно "разрешено с контролем"
❌ Цепочки согласований больше 2 уровней
❌ Ручные проверки того, что можно проверить автоматом
❌ "Молчание = отказ" для позитивных кейсов
❌ Контроль только на UI (обходится через API)
❌ Отсутствие дефолтов (что если не ответили?)
```

---

## 🎭 ГЛАВНЫЙ ПРИНЦИП

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   КОНТРОЛЬ НЕ ДОЛЖЕН ТОРМОЗИТЬ ОСНОВНОЙ БИЗНЕС-ПРОЦЕСС    │
│                                                             │
│   При каждом замечании/предложении спрашивай себя:         │
│   "Это ускоряет или замедляет продажи/операции?"           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 СТРУКТУРА ПРОЕКТА

```
fm-review-system/
├── CLAUDE.md                 ← Этот файл (правила, читается Claude Code автоматически)
├── README.md                 ← Описание системы
├── .env.example              ← Шаблон переменных окружения (скопировать в .env)
│
├── agents/                   ← 7 АГЕНТОВ
│   ├── AGENT_0_CREATOR.md    ← Создание ФМ
│   ├── AGENT_1_ARCHITECT.md  ← Аудит ФМ
│   ├── AGENT_2_ROLE_SIMULATOR.md ← Симуляция ролей
│   ├── AGENT_3_DEFENDER.md   ← Защита ФМ
│   ├── AGENT_4_QA_TESTER.md  ← Тестирование
│   ├── AGENT_5_TECH_ARCHITECT.md ← Проектирование + ТЗ
│   ├── AGENT_6_PRESENTER.md  ← Презентации
│   └── AGENT_7_PUBLISHER.md  ← Публикация в Confluence
│
├── docs/                     ← ДОКУМЕНТАЦИЯ (актуальная)
│   ├── PROMPTS.md            ← Промпты для запуска
│   ├── CHANGELOG.md          ← История изменений
│   ├── CONFLUENCE_TEMPLATE.md← Шаблон страницы ФМ (XHTML)
│   ├── CONFLUENCE_REQUIREMENTS.md ← Требования к публикации
│   ├── CONTRACT_CONFLUENCE_FM.md ← Контракт Confluence-only
│   ├── LEAD_AUDITOR_FULL_AUDIT.md ← Последний аудит (AG-12...AG-15)
│   ├── READINESS_CHECK.md    ← Проверка готовности
│   └── FC_IMPLEMENTATION_REPORT.md ← Отчет реализации FC-01...FC-06
│
├── projects/                 ← РАБОЧИЕ ПРОЕКТЫ
│   └── PROJECT_SHPMNT_PROFIT/← Контроль рентабельности
│
├── schemas/                  ← JSON-схемы (agent-contracts.json v2.1)
├── templates/                ← Шаблоны страниц
├── workflows/                ← Сквозные сценарии
└── scripts/                  ← Скрипты и утилиты
    ├── run_agent.py           ← Автономный запуск агентов (claude -p, --pipeline)
    ├── publish_to_confluence.py ← Обновление Confluence (v3.0)
    ├── import_docx.py         ← Одноразовый импорт DOCX (symlink)
    ├── lib/
    │   ├── common.sh          ← Общие bash-функции
    │   └── confluence_utils.py← Confluence API клиент (lock/backup/retry)
    └── experimental/          ← Неактивные модули (contract_validator.py)
```

---

## 📂 ПРОЕКТЫ (ПАПКИ PROJECT_*)

```
┌─────────────────────────────────────────────────────────────┐
│  ПРАВИЛО РАБОТЫ С ПРОЕКТАМИ                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Если задача относится к ФМ в ПРОЕКТЕ (папка PROJECT_*):   │
│                                                             │
│  1. ФМ читать/писать ТОЛЬКО из Confluence (REST API)        │
│  2. Результаты роли → PROJECT_*/AGENT_X_[ROLE]/             │
│  3. Обновлять PROJECT_*/README.md при изменениях            │
│                                                             │
│  АГЕНТЫ РАБОТАЮТ ТАК:                                       │
│  - AGENT_1 (аудит) → PROJECT_*/AGENT_1_ARCHITECT/           │
│  - AGENT_2 (роли)  → PROJECT_*/AGENT_2_ROLE_SIMULATOR/      │
│  - AGENT_3 (защита)→ PROJECT_*/AGENT_3_DEFENDER/            │
│  - AGENT_4 (тесты) → PROJECT_*/AGENT_4_QA_TESTER/           │
│  - AGENT_5 (ТЗ)    → PROJECT_*/AGENT_5_TECH_ARCHITECT/      │
│                                                             │
│  Каждый проект = отдельная ФМ с полной историей работы     │
└─────────────────────────────────────────────────────────────┘
```

### Текущие проекты

| Папка | ФМ | Статус | Описание |
|-------|-----|--------|----------|
| `projects/PROJECT_SHPMNT_PROFIT/` | FM-LS-PROFIT v1.0.1 | На согласовании | Контроль рентабельности при частичных отгрузках |

### Когда создавать проект

```
СОЗДАВАТЬ ПРОЕКТ PROJECT_[NAME]/, если:
- Новая ФМ (отдельная тематика)
- Полноценная функциональная модель (не мини-ФМ)
- Требуется работа нескольких агентов

СТРУКТУРА ПРОЕКТА (локальная):
PROJECT_[NAME]/
├── README.md                    ← Обзор проекта + Confluence PAGE_ID
├── CONFLUENCE_PAGE_ID           ← ID страницы ФМ в Confluence
├── CHANGES/                     ← Списки изменений
│   └── FM-*-CHANGES.md          ← Что менялось в каждой версии
├── AGENT_1_ARCHITECT/           ← Отчеты аудита
├── AGENT_2_ROLE_SIMULATOR/      ← Симуляции ролей
├── AGENT_3_DEFENDER/            ← Ответы на замечания
├── AGENT_4_QA_TESTER/           ← Тест-кейсы
├── AGENT_5_TECH_ARCHITECT/      ← ТЗ и архитектура
└── REPORTS/                     ← Итоговые отчеты

СТРУКТУРА В CONFLUENCE (зеркало):
[Проект]
├── Функциональные модели / FM-[NAME]
├── ТЗ и Архитектура / TS-FM-[NAME], ARC-FM-[NAME]
├── Тестирование / TC-FM-[NAME]
└── Отчеты / RPT-FM-[NAME]

ВСЕ КЛЮЧЕВЫЕ ДОКУМЕНТЫ ПУБЛИКУЮТСЯ В CONFLUENCE!
См. правило 19 в CLAUDE.md
```

---

## 🚀 ЗАПУСК АГЕНТА

```
1. Определить проект: projects/PROJECT_[NAME]/
2. Загрузить файл агента из agents/AGENT_X_NAME.md
3. Прочитать ФМ из Confluence (REST API, PAGE_ID из проекта)
4. Выполнить команду (/audit, /new, /tz, и т.д.)
5. Отвечать на вопросы в диалоговом режиме
6. После анализа - /apply для внесения изменений в Confluence
7. Результаты сохраняются в projects/PROJECT_[NAME]/AGENT_X_*/
```

Полный список команд — см. `docs/PROMPTS.md`

---

## 🔄 PIPELINE (КОНВЕЙЕР АГЕНТОВ)

> Полная документация конвейера: `workflows/PIPELINE_AUTO.md`

```
Порядок: Agent 0 → 1→2→4→5 → Quality Gate → 7 → [бизнес-ревью] → 3→0→7 → 6

Запуск в чате: "Запусти полный цикл ФМ FM-LS-PROFIT"
Запуск скриптом: python3 scripts/run_agent.py --pipeline --project PROJECT_SHPMNT_PROFIT
Оркестратор: ./scripts/orchestrate.sh
```

---

## 🔗 КРОСС-АГЕНТНЫЙ ПОТОК ДАННЫХ

```
┌─────────────────────────────────────────────────────────────┐
│  КАЖДЫЙ АГЕНТ ПРИ СТАРТЕ:                                  │
│                                                             │
│  1. Читает PROJECT_CONTEXT.md — текущий контекст           │
│  2. Читает .interview_context.txt — параметры интервью     │
│  3. Сканирует AGENT_*/ — результаты других агентов         │
│  4. Читает ФМ из Confluence (REST API, PAGE_ID)            │
│                                                             │
│  КАЖДЫЙ АГЕНТ ПРИ ЗАВЕРШЕНИИ:                              │
│                                                             │
│  1. Сохраняет результат в PROJECT_[NAME]/AGENT_X_*/        │
│  2. Создает _summary.json (FC-07A, ОБЯЗАТЕЛЬНО!)           │
│  3. Обновляет PROJECT_[NAME]/PROJECT_CONTEXT.md            │
│  4. Обновляет PROJECT_[NAME]/WORKPLAN.md                   │
│  5. Обновляет PROJECT_[NAME]/CHANGELOG.md                  │
│  6. При /apply — создает новую версию ФМ + автопатч Z      │
│                                                             │
│  ⚠️ docs/ = системные файлы (обновляются при изменении     │
│     самих агентов/системы, НЕ при работе над ФМ)           │
└─────────────────────────────────────────────────────────────┘
```

### Что каждый агент использует от других

| Агент | Читает от | Что использует |
|-------|-----------|----------------|
| Agent 1 | — | Чистый анализ ФМ |
| Agent 2 | Agent 1 | Найденные замечания для фокуса симуляции |
| Agent 3 | Agent 1, 2 | Замечания для формирования ответов |
| Agent 4 | Agent 1, 2 | Замечания и UX-проблемы для тест-кейсов |
| Agent 5 | Agent 1, 2, 4 | Полная картина для архитектуры |
| Agent 6 | Все | Синтез для презентации |
| Agent 7 | Confluence (текущая страница) | Управление контентом в Confluence (обновление, версии) |

### JSON-сайдкар (_summary.json)

Каждый агент после выполнения создает `PROJECT_*/AGENT_X_*/[command]_summary.json`. Схема: `schemas/agent-contracts.json → agentSummary`. Обязательные поля: agent, command, timestamp, fmVersion, project, status.

---

## 🌐 MCP-ИНТЕГРАЦИИ

### ⚙️ MCP Setup — Настройка подключения

```
ПРЕДВАРИТЕЛЬНЫЕ ТРЕБОВАНИЯ:
1. Claude Code установлен (https://docs.anthropic.com/en/docs/claude-code)
2. MCP серверы настроены в ~/.claude/claude_desktop_config.json

НАСТРОЙКА CONFLUENCE:
1. Получить Personal Access Token (PAT) в Confluence
2. Указать URL и PAGE_ID в scripts/publish_to_confluence.py
3. Публикация: python3 scripts/publish_to_confluence.py

ПРОВЕРКА ПОДКЛЮЧЕНИЯ:
- Confluence: python3 scripts/publish_to_confluence.py --test

FALLBACK (если недоступно):
- Agent 7: сохранит HTML локально, загрузить позже
```

### Confluence API

```
КОГДА: Agent 7 → /publish (основной), Agent 6 → /export-confluence (презентации)
ДЛЯ ЧЕГО: Публикация ФМ, требований, процессов с версионностью

CONFLUENCE SERVER:
- URL: https://confluence.ekf.su
- Auth: Bearer token (PAT)
- API: /rest/api/content/{PAGE_ID}
- Формат: XHTML storage format

СТРУКТУРА СТРАНИЦЫ (см. docs/CONFLUENCE_TEMPLATE.md):
- Мета-блок (код проекта, версия, дата, автор, платформа)
- Оглавление (toc macro в expand)
- Система кодов типов (таблица 7x2)
- Основное содержание ФМ
- Таблица требований (77x3)
- Панели предупреждений (warning=красная, note=жёлтая)

ПРАВИЛА:
- Обновлять существующую страницу (PUT + version increment)
- Дата генерируется автоматически (datetime.now)
- Версионность встроенная (Confluence page versions)
- Шаблон: docs/CONFLUENCE_TEMPLATE.md
- Требования: docs/CONFLUENCE_REQUIREMENTS.md
```

---

## 🤝 БИЗНЕС-СОГЛАСОВАНИЕ

```
Цикл: DRAFT → PUBLISHED → BUSINESS REVIEW → REWORK → APPROVED
- Бизнес читает в Confluence, оставляет комментарии
- Agent 3 анализирует замечания, Agent 0 вносит правки, Agent 7 обновляет
- Критерий: нет открытых комментариев + метка Approved
- Exit: MAX 5 итераций, TIMEOUT 7 рабочих дней, ESCALATION 3 итерации без прогресса
```

---

## 📜 СКРИПТЫ

Основные: `orchestrate.sh` (главный лаунчер), `run_agent.py` (автономный запуск), `publish_to_confluence.py` (обновление Confluence), `quality_gate.sh` (проверка готовности). Лаунчеры агентов: `agent0_new.sh` ... `agent5_architect.sh`. Библиотеки: `lib/confluence_utils.py`, `lib/common.sh`.

### Confluence (scripts/lib/confluence_utils.py)

Каждое обновление Confluence проходит через: блокировку (file lock) → бекап → retry (3 попытки) → журнал аудита (.audit_log/). Подробности - в коде `scripts/lib/confluence_utils.py`.

---

## 🔒 QUALITY GATE

```
Запуск: ./scripts/quality_gate.sh PROJECT_NAME [--reason "текст"]
Коды: 0=OK, 1=CRITICAL (блокирует), 2=WARN (можно пропустить)
Обязателен ПЕРЕД публикацией в Confluence (Agent 7).
```

> Схемы _summary.json, traceability-matrix.json, /auto контекст - см. `schemas/agent-contracts.json`

---

## 🎯 Взаимодействие с пользователем

**АБСОЛЮТНОЕ ПРАВИЛО: Есть вопрос → вызывай AskUserQuestion. БЕЗ ИСКЛЮЧЕНИЙ.**

Вопрос текстом в чате = вопрос в пустоту. Пользователь не сможет удобно ответить. ВСЕГДА используй встроенный инструмент **AskUserQuestion**.

**Правила:**
- ЛЮБОЙ вопрос к пользователю = AskUserQuestion (да/нет, выбор, уточнение - ВСЕ)
- Формулируй вопрос с конкретными вариантами ответа и кратким описанием каждого
- Группируй связанные вопросы в табы (если несколько тем)
- Всегда добавляй вариант "Другое" для свободного ответа
- НИКОГДА не выполняй необратимые действия без подтверждения через AskUserQuestion
- НИКОГДА не задавай вопрос текстом в чате - только AskUserQuestion

name: DoD Check on Issue Close

on:
  issues:
    types: [closed]

jobs:
  check-dod:
    runs-on: ubuntu-latest
    # Skip bot-only issues (e.g. dependabot)
    if: "!contains(github.event.issue.labels.*.name, 'skip-dod')"
    steps:
      - name: Check DoD comment exists
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const labels = issue.labels.map(l => l.name);

            // Skip if no agent label (not an agent-managed issue)
            const hasAgentLabel = labels.some(l => l.startsWith('agent:'));
            if (!hasAgentLabel) {
              console.log(`Issue #${issueNumber} has no agent: label, skipping DoD check.`);
              return;
            }

            // Get all comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            // Check if any comment contains DoD structure
            const dodPattern = /## (Результат|Result)[\s\S]*## DoD[\s\S]*- \[x\]/i;
            const hasDoD = comments.data.some(c => dodPattern.test(c.body));

            if (!hasDoD) {
              // Reopen the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'open',
              });

              // Add warning comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  '⚠️ **Issue reopened: DoD checklist missing**',
                  '',
                  'Эта issue была закрыта без обязательного DoD-комментария.',
                  'Закрытие через `Closes #N` в коммитах запрещено — используйте:',
                  '```bash',
                  `scripts/gh-tasks.sh done ${issueNumber} --comment "## Результат\\n...\\n## DoD\\n- [x] Tests pass\\n..."`,
                  '```',
                  '',
                  'Требования: [.claude/rules/dod.md](../blob/main/.claude/rules/dod.md)',
                  '',
                  '---',
                  '*Automated by dod-check workflow*',
                ].join('\n'),
              });

              // Add status label back
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['status:in-progress'],
                });
              } catch (e) {
                console.log('Could not add label:', e.message);
              }

              core.setFailed(`Issue #${issueNumber} closed without DoD comment. Reopened.`);
            } else {
              console.log(`Issue #${issueNumber} has valid DoD comment. ✓`);
            }

name: Jira Commit Sync

on:
  push:
    branches: [main]

jobs:
  sync-commits:
    runs-on: ubuntu-latest
    env:
      JIRA_PAT: ${{ secrets.JIRA_PAT }}
      JIRA_BASE_URL: https://jira.ekf.su
    steps:
      - name: Link commits to Jira issues
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const jiraBase = process.env.JIRA_BASE_URL;
            const jiraPat = process.env.JIRA_PAT;

            if (!jiraPat) {
              console.log('JIRA_PAT not configured, skipping.');
              return;
            }

            const commits = context.payload.commits || [];
            if (commits.length === 0) {
              console.log('No commits in push event.');
              return;
            }

            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const jiraKeyPattern = /EKFLAB-\d+/g;
            let linked = 0;

            for (const commit of commits) {
              const message = commit.message || '';
              const keys = [...new Set(message.match(jiraKeyPattern) || [])];
              if (keys.length === 0) continue;

              const shortSha = commit.id.substring(0, 7);
              const commitUrl = `${repoUrl}/commit/${commit.id}`;
              const firstLine = message.split('\n')[0].substring(0, 120);
              const author = commit.author?.name || 'unknown';
              const ts = (commit.timestamp || '').substring(0, 19).replace('T', ' ');

              const comment = [
                `*Коммит:* [${shortSha}|${commitUrl}]`,
                `*Автор:* ${author}`,
                `*Сообщение:* ${firstLine}`,
                `*Ветка:* main`,
                `*Дата:* ${ts}`,
              ].join('\n');

              const bodyJson = JSON.stringify({ body: comment });

              for (const key of keys) {
                try {
                  const curlCmd = [
                    'curl', '-s', '-o', '/tmp/jira_resp.txt',
                    '-w', '%{http_code}',
                    '--connect-timeout', '10',
                    '--max-time', '15',
                    '-X', 'POST',
                    '-H', `Authorization: Bearer ${jiraPat}`,
                    '-H', 'Content-Type: application/json',
                    `${jiraBase}/rest/api/2/issue/${key}/comment`,
                    '-d', bodyJson,
                  ];
                  const result = execSync(curlCmd.join(' '), { encoding: 'utf-8' }).trim();

                  if (result === '201') {
                    console.log(`Linked commit ${shortSha} to ${key}`);
                    linked++;
                  } else {
                    const resp = require('fs').readFileSync('/tmp/jira_resp.txt', 'utf-8').substring(0, 200);
                    console.log(`Failed ${key}: HTTP ${result} — ${resp}`);
                  }
                } catch (err) {
                  console.log(`Error on ${key}: ${err.message.substring(0, 200)}`);
                }
              }
            }

            console.log(`Processed ${commits.length} commits, linked ${linked}.`);

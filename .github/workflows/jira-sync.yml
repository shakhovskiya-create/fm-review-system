name: Jira Commit Sync

on:
  push:
    branches: [main]

jobs:
  sync-commits:
    runs-on: ubuntu-latest
    env:
      JIRA_PAT: ${{ secrets.JIRA_PAT }}
      JIRA_BASE_URL: https://jira.ekf.su
    steps:
      - name: Link commits to Jira issues
        shell: bash
        run: |
          if [ -z "$JIRA_PAT" ]; then
            echo "JIRA_PAT not configured, skipping."
            exit 0
          fi

          REPO_URL="https://github.com/${{ github.repository }}"
          COMMITS='${{ toJSON(github.event.commits) }}'

          if [ "$COMMITS" = "null" ] || [ -z "$COMMITS" ]; then
            echo "No commits in push event."
            exit 0
          fi

          LINKED=0
          COUNT=$(echo "$COMMITS" | jq 'length')

          for i in $(seq 0 $((COUNT - 1))); do
            SHA=$(echo "$COMMITS" | jq -r ".[$i].id")
            MESSAGE=$(echo "$COMMITS" | jq -r ".[$i].message")
            AUTHOR=$(echo "$COMMITS" | jq -r ".[$i].author.name")
            TIMESTAMP=$(echo "$COMMITS" | jq -r ".[$i].timestamp")

            # Extract EKFLAB-N keys
            KEYS=$(echo "$MESSAGE" | grep -oE 'EKFLAB-[0-9]+' | sort -u || true)
            [ -z "$KEYS" ] && continue

            SHORT_SHA="${SHA:0:7}"
            COMMIT_URL="${REPO_URL}/commit/${SHA}"
            FIRST_LINE=$(echo "$MESSAGE" | head -1 | cut -c1-120)
            DATE="${TIMESTAMP:0:19}"
            DATE="${DATE/T/ }"

            COMMENT="*Коммит:* [${SHORT_SHA}|${COMMIT_URL}]\n*Автор:* ${AUTHOR}\n*Сообщение:* ${FIRST_LINE}\n*Ветка:* main\n*Дата:* ${DATE}"

            for KEY in $KEYS; do
              BODY=$(jq -n --arg body "$COMMENT" '{body: $body}')

              HTTP_CODE=$(curl -s -o /tmp/jira_response.txt -w "%{http_code}" \
                --connect-timeout 10 \
                --max-time 15 \
                -X POST \
                -H "Authorization: Bearer $JIRA_PAT" \
                -H "Content-Type: application/json" \
                "${JIRA_BASE_URL}/rest/api/2/issue/${KEY}/comment" \
                -d "$BODY" 2>/dev/null || echo "000")

              if [ "$HTTP_CODE" = "201" ]; then
                echo "Linked commit ${SHORT_SHA} to ${KEY}"
                LINKED=$((LINKED + 1))
              else
                echo "Failed to comment on ${KEY}: HTTP ${HTTP_CODE}"
                cat /tmp/jira_response.txt 2>/dev/null | head -3 || true
                echo ""
              fi
            done
          done

          echo "Processed ${COUNT} commits, linked ${LINKED}."

# Протокол конвейера в чате (интерактивный)

> **Назначение:** Пошаговая инструкция для Claude Code - как выполнить полный конвейер агентов
> прямо в текущем чате, показывая пользователю диалог и результаты каждого этапа.
> **Ключевой принцип:** Конвейер НЕ слепо автономный. При каждом решении - варианты с рекомендацией аналитика.

---

## Триггеры

Этот протокол активируется когда пользователь говорит:
- "Полный цикл ФМ [NAME]"
- "Запусти полный цикл"
- "Конвейер для [PROJECT]"
- "Запусти все агенты"

---

## ШАГ 0: Определение проекта

1. Извлечь имя ФМ из промпта пользователя (например: FM-LS-PROFIT)
2. Найти папку проекта: `projects/PROJECT_*/` (сопоставить по коду ФМ в PROJECT_CONTEXT.md)
3. Прочитать `PROJECT_CONTEXT.md` - текущий контекст, версия, статус
4. Прочитать `CONFLUENCE_PAGE_ID` - ID страницы в Confluence
5. Показать пользователю:

```
══════════════════════════════════════════════
  КОНВЕЙЕР ФМ: [код ФМ] | Проект: [PROJECT_NAME]
  Версия: [текущая] | Confluence: PAGE_ID [id]
══════════════════════════════════════════════

Порядок: Agent 1 → 2 → 4 → 5 → 3 → Quality Gate → 7 → 8 → 6
```

---

## ПОРЯДОК ЭТАПОВ

| # | Агент | Роль | Команда |
|---|-------|------|---------|
| 1 | Agent 1 | Architect | /auto |
| 2 | Agent 2 | Simulator | /auto (= /simulate-all) |
| 3 | Agent 4 | QA Tester | /auto |
| 4 | Agent 5 | Tech Architect | /auto |
| 5 | Agent 3 | Defender | /auto |
| 6 | Quality Gate | (скрипт) | bash quality_gate.sh |
| 7 | Agent 7 | Publisher | /auto |
| 8 | Agent 8 | BPMN Designer | /auto |
| 9 | Agent 6 | Presenter | /auto |
| 10 | /evolve | Self-Improvement | анализ .patches/ |

> **Agent 2:** В конвейере запускает `/auto` (= `/simulate-all` + автоматический /apply).
> Режим `/business` - отдельный ручной запуск перед бизнес-согласованием, не часть основного конвейера.
>
> **Agent 3:** Анализирует findings агентов 1, 2, 4, 5 и готовит аргументированные ответы.
> Классифицирует каждую находку (покрыто / пробел / осознанный выбор / в бэклоге).
> Находки типа "пробел" автоматически предлагаются к исправлению через /apply.

---

## ГЛАВНОЕ ПРАВИЛО: ИНТЕРАКТИВНЫЕ РЕШЕНИЯ

```
┌─────────────────────────────────────────────────────────────┐
│  КОНВЕЙЕР = ДИАЛОГ, НЕ АВТОПИЛОТ!                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  При КАЖДОМ решении, уточнении или развилке:               │
│                                                             │
│  1. ПОКАЗАТЬ варианты (пронумерованные 1, 2, 3...)         │
│  2. ОДИН вариант пометить рекомендацией аналитика          │
│  3. ОБОСНОВАТЬ рекомендацию (1-2 предложения)              │
│  4. ДОЖДАТЬСЯ ответа пользователя (номер или свой вариант) │
│  5. ПРОДОЛЖИТЬ конвейер с выбранным решением               │
│                                                             │
│  КОГДА СПРАШИВАТЬ:                                          │
│  - Какие замечания применить (все / CRIT+HIGH / выбор)     │
│  - Противоречивые находки (два агента расходятся)          │
│  - Архитектурные решения (несколько вариантов реализации)  │
│  - Неоднозначные бизнес-правила (требуют уточнения)       │
│  - Решения по GAP (пробелы - добавлять или нет?)          │
│  - Приоритеты при конфликте (скорость vs контроль)         │
│                                                             │
│  КОГДА НЕ СПРАШИВАТЬ (делать автоматически):               │
│  - Чтение файлов, Confluence API                           │
│  - Создание _summary.json, CHANGES.md                     │
│  - Обновление PROJECT_CONTEXT.md                          │
│  - Верификация (GET после PUT)                            │
│  - Переход к следующему агенту после решения              │
│                                                             │
│  ФОРМАТ ВОПРОСА (обязательный):                            │
│                                                             │
│  ? [Краткий вопрос]                                        │
│                                                             │
│  1. [Вариант]                                              │
│  2. [Вариант] - рекомендуется                              │
│  3. [Вариант]                                              │
│  4. Другое (напишите)                                      │
│                                                             │
│  Почему [N]: [1-2 предложения обоснования]                 │
│                                                             │
│  _→ Доставь через AskUserQuestion_                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## ДЛЯ КАЖДОГО ЭТАПА (1-4, 6-7) выполнить:

### Перед запуском агента:

1. Показать заголовок:
```
═══ ЭТАП [N]/7: Agent [X] ([Name]) ═══
```

2. **Прочитать файл роли** агента: `agents/AGENT_X_NAME.md`
3. **Принять роль** этого агента - следовать его инструкциям
4. Прочитать результаты предыдущих агентов из `PROJECT_*/AGENT_*/`

### Выполнение:

5. Выполнить анализ/работу по инструкциям из файла роли:
   - Брать параметры из PROJECT_CONTEXT.md (пропустить вводное интервью)
   - Выполнить полный анализ
   - Показывать пользователю ВСЕ находки, правки, решения

6. **При необходимости /apply - СПРОСИТЬ пользователя:**
```
? Какие изменения применить?

1. Все (N правок)
2. CRITICAL + HIGH (M правок) - рекомендуется
3. Только CRITICAL (K правок)
4. Конкретные номера (укажите какие)
5. Пока не применять

Почему 2: MEDIUM и LOW можно отложить на следующую итерацию.

_→ Доставь через AskUserQuestion_
```

7. Применить выбранные изменения, обновить версию ФМ

8. **Сохранить результаты:**
   - Отчет в `PROJECT_*/AGENT_X_NAME/`
   - `_summary.json` с обязательными полями: agent, command, timestamp, fmVersion, project, status
   - Обновить `PROJECT_CONTEXT.md`

### После завершения:

9. Показать краткий итог:
```
✅ Agent [X] ([Name]) завершен
   Найдено: [N] замечаний | Применено: [M] правок | Версия: [X.Y.Z]
   Результаты: PROJECT_*/AGENT_X_NAME/
```

10. **Проверка перед следующим этапом:**
    - Если _summary.json → status = "failed" → ОСТАНОВИТЬ конвейер, сообщить об ошибке
    - Если status = "partial" → показать предупреждение, спросить: продолжить?
    - Если status = "completed" → перейти к следующему этапу

---

## ЭТАП 6: Quality Gate (между Agent 3 и Agent 7)

```
═══ ЭТАП 6/9: Quality Gate ═══
```

1. Запустить: `bash scripts/quality_gate.sh [PROJECT_NAME]`
2. Обработать результат:
   - **Exit code 0** → все проверки пройдены, продолжить
   - **Exit code 1** → CRITICAL ошибки → показать и спросить:
     ```
     ? Quality Gate: найдены CRITICAL ошибки. Что делать?

     1. Остановить конвейер, исправить вручную
     2. Продолжить (на свой риск) - не рекомендуется
     3. Показать детали ошибок

     Почему 1: CRITICAL ошибки могут привести к некорректной публикации.

     _→ Доставь через AskUserQuestion_
     ```
   - **Exit code 2** → предупреждения → показать, продолжить

---

## ПРИМЕРЫ ИНТЕРАКТИВНЫХ РЕШЕНИЙ В КОНВЕЙЕРЕ

### Agent 1 (после аудита):
```
? Найдено 15 замечаний. Какие применить?

1. Все 15 (CRIT: 1, HIGH: 3, MED: 5, LOW: 4, GAP: 2)
2. CRITICAL + HIGH (4 правки) - рекомендуется
3. Только CRITICAL (1 правка)
4. Выбрать конкретные номера
5. Не применять, только отчет

Почему 2: Критичные и важные замечания влияют на корректность ФМ. MEDIUM/LOW можно отложить.

_→ Доставь через AskUserQuestion_
```

### Agent 5 (архитектурное решение):
```
? Как реализовать контроль рентабельности?

1. Регламентное задание каждые 15 минут - рекомендуется
2. Событие при проведении документа
3. Комбинированный (событие + регламентное)
4. Другое

Почему 1: Наименьшая нагрузка на систему, покрывает 95% сценариев.

_→ Доставь через AskUserQuestion_
```

### Agent 7 (перед публикацией):
```
? Публикация в Confluence. Подтвердите:

1. Опубликовать (обновить страницу) - рекомендуется
2. Показать предпросмотр XHTML
3. Отложить публикацию

Почему 1: Все проверки пройдены, Quality Gate OK.

_→ Доставь через AskUserQuestion_
```

---

## ФИНАЛ: Итоговая таблица

После завершения всех этапов показать:

```
══════════════════════════════════════════════
  КОНВЕЙЕР ЗАВЕРШЕН
══════════════════════════════════════════════

| # | Агент | Статус | Находки | Правки | Версия |
|---|-------|--------|---------|--------|--------|
| 1 | Architect | ✅ | 12 | 10 | 1.0.1 |
| 2 | Simulator | ✅ | 5 | 3 | 1.0.2 |
| 3 | QA Tester | ✅ | 8 | - | - |
| 4 | Tech Arch | ✅ | 3 | 2 | 1.0.3 |
| 5 | Defender | ✅ | 4 | 2 | 1.0.4 |
| 6 | Quality Gate | ✅ | - | - | - |
| 7 | Publisher | ✅ | - | PUT | v28 |
| 8 | BPMN | ✅ | - | - | - |
| 9 | Presenter | ✅ | - | - | - |

Итого: [N]/9 этапов завершено. ФМ: v[X.Y.Z]
```

---

## ЭТАП 8: SELF-IMPROVEMENT (/evolve)

После финальной таблицы — автоматически запустить анализ патчей:

1. Подсчитать патчи в `.patches/` (кроме README.md и EVOLUTION_LOG.md)
2. Если патчей 0 — пропустить с сообщением "Патчей нет, /evolve пропущен"
3. Если патчи есть — показать:

```
══════════════════════════════════════════════
  ЭТАП 8/8: SELF-IMPROVEMENT
══════════════════════════════════════════════

Новых патчей за этот pipeline: [N]
Всего патчей накоплено: [M]

? Запустить /evolve для улучшения агентов?

1. Да, проанализировать и предложить улучшения - рекомендуется
2. Пропустить

_→ Доставь через AskUserQuestion_
```

4. При выборе "Да" — прочитать `agents/EVOLVE.md` и выполнить алгоритм
5. Результат: обновленные агенты + запись в `.patches/EVOLUTION_LOG.md`

---

## ПРАВИЛА

1. **Интерактивные решения** - при каждой развилке спрашивать через меню с вариантами и рекомендацией
2. **Не останавливать конвейер** - решения принимаются на ходу, цикл продолжается
3. **Всегда рекомендация** - один вариант помечен "рекомендуется" с обоснованием
4. **Показывать все** - пользователь видит находки, правки, решения каждого агента
5. **_summary.json обязателен** - без него следующий агент не знает статус предыдущего
6. **Quality Gate обязателен** - перед Agent 7 (Publisher)
7. **Остановка только на CRITICAL** - и то с подтверждением пользователя
8. **Патчи обязательны** - агенты 1-5 записывают паттерны ошибок в `.patches/` после каждого аудита
9. **/evolve в конце** - анализ патчей и предложения по улучшению агентов

---

## РЕЖИМ ВЫБОРОЧНЫХ АГЕНТОВ

Если пользователь говорит: "Запусти агенты 1, 2, 4 для FM-LS-PROFIT"
- Выполнить только указанные агенты в правильном порядке
- Quality Gate - только если в списке есть Agent 7
- Остальные правила те же

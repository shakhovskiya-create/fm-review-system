# Протокол автономного конвейера (в чате)

> **Назначение:** Пошаговая инструкция для Claude Code — как выполнить полный конвейер агентов
> прямо в текущем чате, показывая пользователю диалог и результаты каждого этапа.

---

## Триггеры

Этот протокол активируется когда пользователь говорит:
- "Полный цикл ФМ [NAME]"
- "Запусти полный цикл"
- "Конвейер для [PROJECT]"
- "Запусти все агенты"

---

## ШАГ 0: Определение проекта

1. Извлечь имя ФМ из промпта пользователя (например: FM-LS-PROFIT)
2. Найти папку проекта: `projects/PROJECT_*/` (сопоставить по коду ФМ в PROJECT_CONTEXT.md)
3. Прочитать `PROJECT_CONTEXT.md` — текущий контекст, версия, статус
4. Прочитать `CONFLUENCE_PAGE_ID` — ID страницы в Confluence
5. Показать пользователю:

```
══════════════════════════════════════════════
  КОНВЕЙЕР ФМ: [код ФМ] | Проект: [PROJECT_NAME]
  Версия: [текущая] | Confluence: PAGE_ID [id]
══════════════════════════════════════════════

Порядок: Agent 1 → 2 → 4 → 5 → Quality Gate → 7 → 8 → 6
```

---

## ПОРЯДОК ЭТАПОВ

| # | Агент | Роль | Команда |
|---|-------|------|---------|
| 1 | Agent 1 | Architect | /auto |
| 2 | Agent 2 | Simulator | /auto |
| 3 | Agent 4 | QA Tester | /auto |
| 4 | Agent 5 | Tech Architect | /auto |
| 5 | Quality Gate | (скрипт) | bash quality_gate.sh |
| 6 | Agent 7 | Publisher | /auto |
| 7 | Agent 8 | BPMN Designer | /auto |
| 8 | Agent 6 | Presenter | /auto |

---

## ДЛЯ КАЖДОГО ЭТАПА (1-4, 6-8) выполнить:

### Перед запуском агента:

1. Показать заголовок:
```
═══ ЭТАП [N]/8: Agent [X] ([Name]) — /auto ═══
```

2. **Прочитать файл роли** агента: `agents/AGENT_X_NAME.md`
3. **Принять роль** этого агента — следовать его инструкциям для /auto
4. Прочитать результаты предыдущих агентов из `PROJECT_*/AGENT_*/`

### Выполнение:

5. Выполнить `/auto` по инструкциям из файла роли:
   - Пропустить интервью — брать параметры из PROJECT_CONTEXT.md
   - Выполнить полный анализ/работу
   - Применить изменения если агент поддерживает /apply (APPLY_MODE=auto, APPLY_SCOPE=all)
   - Показывать пользователю ВСЕ находки, правки, решения

6. **Сохранить результаты:**
   - Отчет в `PROJECT_*/AGENT_X_NAME/`
   - `_summary.json` с обязательными полями: agent, command, timestamp, fmVersion, project, status
   - Обновить `PROJECT_CONTEXT.md`

### После завершения:

7. Показать краткий итог:
```
✅ Agent [X] ([Name]) завершен
   Найдено: [N] замечаний | Применено: [M] правок | Версия: [X.Y.Z]
   Результаты: PROJECT_*/AGENT_X_NAME/
```

8. **Проверка перед следующим этапом:**
   - Если _summary.json → status = "failed" → ОСТАНОВИТЬ конвейер, сообщить об ошибке
   - Если status = "partial" → показать предупреждение, продолжить
   - Если status = "completed" → перейти к следующему этапу

---

## ЭТАП 5: Quality Gate (между Agent 5 и Agent 7)

```
═══ ЭТАП 5/8: Quality Gate ═══
```

1. Запустить: `bash scripts/quality_gate.sh [PROJECT_NAME]`
2. Обработать результат:
   - **Exit code 0** → все проверки пройдены, продолжить
   - **Exit code 1** → CRITICAL ошибки → ОСТАНОВИТЬ конвейер, показать ошибки
   - **Exit code 2** → предупреждения → показать, продолжить

```
✅ Quality Gate: все проверки пройдены (или)
⚠️ Quality Gate: N предупреждений (продолжаем) (или)
❌ Quality Gate: CRITICAL — конвейер остановлен
```

---

## ФИНАЛ: Итоговая таблица

После завершения всех этапов показать:

```
══════════════════════════════════════════════
  КОНВЕЙЕР ЗАВЕРШЕН
══════════════════════════════════════════════

| # | Агент | Статус | Находки | Правки | Версия |
|---|-------|--------|---------|--------|--------|
| 1 | Architect | ✅ | 12 | 10 | 1.0.1 |
| 2 | Simulator | ✅ | 5 | 3 | 1.0.2 |
| 3 | QA Tester | ✅ | 8 | — | — |
| 4 | Tech Arch | ✅ | 3 | 2 | 1.0.3 |
| 5 | Quality Gate | ✅ | — | — | — |
| 6 | Publisher | ✅ | — | PUT | v28 |
| 7 | BPMN | ✅ | 3 диаграммы | — | — |
| 8 | Presenter | ✅ | — | — | — |

Итого: [N]/8 этапов завершено. ФМ: v[X.Y.Z]
```

---

## ПРАВИЛА

1. **APPLY_MODE=auto** — при /apply не спрашивать пользователя, применять автоматически
2. **APPLY_SCOPE=all** — применять все замечания (не только CRITICAL+HIGH)
3. **Показывать все** — пользователь должен видеть находки, правки, решения каждого агента
4. **_summary.json обязателен** — без него следующий агент не знает статус предыдущего
5. **Quality Gate обязателен** — перед Agent 7 (Publisher)
6. **Остановка на CRITICAL** — если Quality Gate или агент завершился с ошибкой

---

## РЕЖИМ ВЫБОРОЧНЫХ АГЕНТОВ

Если пользователь говорит: "Запусти агенты 1, 2, 4 для FM-LS-PROFIT"
- Выполнить только указанные агенты в правильном порядке
- Quality Gate — только если в списке есть Agent 7
- Остальные правила те же

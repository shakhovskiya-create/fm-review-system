# 🔄 Workflows: Полный цикл работы с ФМ

---

## 1️⃣ Создание новой ФМ (полный pipeline)

```
┌─────────────────────────────────────────────────────────────────┐
│                    WORKFLOW: Создание ФМ                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ЭТАП 1 — СОЗДАНИЕ (локально)                                  │
│  ┌──────────────────────┐                                      │
│  │ Agent 0 (Creator)    │ ← Уточняющие вопросы / PROJECT_CONTEXT│
│  │ /auto                │ → FM v1.0 (Markdown)                  │
│  └──────────┬───────────┘                                      │
│             ▼                                                   │
│  ЭТАП 2 — ВНУТРЕННИЙ РЕВЬЮ (локально)                          │
│  ┌──────────────────────┐                                      │
│  │ Agent 1 (Architect)  │ → аудит → /apply → FM v1.1           │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐                                      │
│  │ Agent 2 (Simulator)  │ → UX → /apply → FM v1.2              │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐                                      │
│  │ Agent 4 (QA Tester)  │ → тесты → /apply → FM v1.3           │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐                                      │
│  │ Agent 5 (Tech Arch)  │ → архитектура + ТЗ → FM v1.4         │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐                                      │
│  │ Quality Gate         │ → проверка готовности                 │
│  └──────────┬───────────┘                                      │
│             ▼                                                   │
│  ЭТАП 3 — ПУБЛИКАЦИЯ (Confluence + Miro)                        │
│  ┌──────────────────────┐                                      │
│  │ Agent 7 (Publisher)  │ → создание в Confluence (Draft)        │
│  │ /auto                │ → Confluence-страницы заполнены        │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐                                      │
│  │ Agent 8 (EPC Design) │ → ePC в Miro → embed в Confluence     │
│  │ /auto                │                                       │
│  └──────────┬───────────┘                                      │
│             ▼                                                   │
│  ЭТАП 4 — БИЗНЕС-СОГЛАСОВАНИЕ (Confluence)                      │
│  ┌──────────────────────┐                                      │
│  │ Статус: Draft→Review │ → бизнес читает, комментирует        │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐                                      │
│  │ Agent 3 (Defender)   │ → анализ замечаний бизнеса            │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐  ◄── цикл если есть доработки        │
│  │ Agent 0 (Creator)    │ → доработка по замечаниям             │
│  │ Agent 7 /sync        │ → обновление Confluence                │
│  └──────────┬───────────┘                                      │
│  ┌──────────┴───────────┐                                      │
│  │ Статус: → Approved   │                                       │
│  └──────────┬───────────┘                                      │
│             ▼                                                   │
│  ЭТАП 5 — ФИНАЛИЗАЦИЯ                                          │
│  ┌──────────────────────┐                                      │
│  │ Agent 6 (Presenter)  │ → презентация + отчёты                │
│  │ /auto                │                                       │
│  └──────────────────────┘                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Команды

```bash
# ЭТАП 1: Создание ФМ
/new "Название процесса"

# ЭТАП 2: Внутренний ревью (агенты 1→2→4→5)
/audit

# ЭТАП 3: Публикация
/publish    # Agent 7 → Confluence
/epc        # Agent 8 → Miro

# ЭТАП 4: Бизнес-согласование
# "Отправь ФМ на согласование" → Agent 7 меняет статус
# "Проанализируй замечания" → Agent 3
# "Доработай по замечаниям" → Agent 0 + Agent 7 /sync

# ЭТАП 5: Финализация
/present    # Agent 6 → отчёты
```

---

## 2️⃣ Управление ФМ в Confluence

```
┌─────────────────────────────────────────────────────────────────┐
│                   WORKFLOW: Управление ФМ в Confluence           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [1. Чтение текущей ФМ]                                        │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────┐                                           │
│  │ AGENT_7_MIGRATOR │ ← GET /rest/api/content/{PAGE_ID}        │
│  │ Чтение Confluence│                                           │
│  └────────┬────────┘                                           │
│           │                                                     │
│           ├──► Извлечь структуру (заголовки)                   │
│           ├──► Извлечь таблицы                                 │
│           ├──► Извлечь глоссарий                               │
│           ├──► Извлечь требования (по паттерну XX-YY-NNN)      │
│           └──► Извлечь риски                                   │
│           │                                                     │
│           ▼                                                     │
│  [2. Обновление в Confluence]                                   │
│      │                                                          │
│      └──► PUT /rest/api/content/{PAGE_ID} (version+1)          │
│           │                                                     │
│           ▼                                                     │
│  [3. Создание ePC]                                              │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────┐                                           │
│  │ AGENT_8_EPC_DESIGNER │ ← Данные процесса из Confluence      │
│  │ Создание ePC    │                                           │
│  └────────┬────────┘                                           │
│           │                                                     │
│           └──► Miro: Доска + диаграмма                         │
│           │                                                     │
│           ▼                                                     │
│  [4. Валидация]                                                 │
│      │                                                          │
│      ├──► Проверить полноту контента в Confluence               │
│      ├──► Проверить связи                                      │
│      └──► Сформировать отчет                                   │
│           │                                                     │
│           ▼                                                     │
│  [5. Отчет о публикации]                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Команды

```bash
# Обновить ФМ в Confluence
/publish

# Обновить с валидацией
/publish --validate

# Прочитать текущую ФМ из Confluence
/read
```

---

## 3️⃣ Logic Review

```
┌─────────────────────────────────────────────────────────────────┐
│                   WORKFLOW: Logic Review                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [1. Загрузка ФМ]                                               │
│      │                                                          │
│      ├──► Confluence: Получить страницу ФМ                      │
│      ├──► Confluence: Получить требования                       │
│      └──► Miro: Получить ePC (если есть)                       │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────┐                                           │
│  │ AGENT_1_ARCHITECT.md  │                                           │
│  │                 │                                           │
│  │ ┌─────────────┐ │                                           │
│  │ │ Чек-лист    │ │ ← Проверка по категориям                  │
│  │ └─────────────┘ │                                           │
│  │ ┌─────────────┐ │                                           │
│  │ │ Паттерны    │ │ ← Поиск типовых ошибок                    │
│  │ └─────────────┘ │                                           │
│  │ ┌─────────────┐ │                                           │
│  │ │ Симуляция   │ │ ← Прогон сценариев                        │
│  │ └─────────────┘ │                                           │
│  └────────┬────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  [2. Категоризация находок]                                     │
│      │                                                          │
│      ├──► 🔴 CRITICAL (блокеры)                                │
│      ├──► 🟠 HIGH (серьёзные)                                  │
│      ├──► 🟡 MEDIUM (улучшения)                                │
│      └──► 🟢 LOW (косметика)                                   │
│           │                                                     │
│           ▼                                                     │
│  [3. Формирование отчёта]                                       │
│      │                                                          │
│      ├──► Markdown отчёт                                       │
│      └──► Confluence: Комментарии к требованиям                 │
│           │                                                     │
│           ▼                                                     │
│  [4. Рекомендации]                                              │
│      │                                                          │
│      └──► Приоритизированный список доработок                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Команды

```bash
# Полный ревью
/audit FM-XXX

# Ревью только бизнес-правил
/audit FM-XXX --scope=BR

# Ревью с фокусом на edge cases
/audit FM-XXX --mode=edge-cases

# Экспресс-ревью (только Critical)
/audit FM-XXX --quick
```

---

## 4️⃣ Обновление ФМ

```
┌─────────────────────────────────────────────────────────────────┐
│                   WORKFLOW: Обновление ФМ                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [1. Запрос изменений]                                          │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────┐                                           │
│  │ AGENT_0_CREATOR.md   │ ← Описание изменений                      │
│  │ Анализ влияния  │                                           │
│  └────────┬────────┘                                           │
│           │                                                     │
│           ├──► Какие разделы затронуты?                        │
│           ├──► Какие требования меняются?                      │
│           └──► Нужно ли обновить ePC?                          │
│           │                                                     │
│           ▼                                                     │
│  [2. Внесение изменений]                                        │
│      │                                                          │
│      ├──► Confluence: Обновить страницу                         │
│      ├──► Confluence: Обновить/добавить требования              │
│      └──► Miro: Обновить ePC (если нужно)                      │
│           │                                                     │
│           ▼                                                     │
│  [3. Версионирование]                                           │
│      │                                                          │
│      ├──► Инкремент версии (major.minor.patch)                 │
│      ├──► Запись в историю версий                              │
│      └──► Описание изменений                                   │
│           │                                                     │
│           ▼                                                     │
│  [4. Ревью изменений]                                           │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────┐                                           │
│  │ AGENT_1_ARCHITECT.md  │ ← Только изменённые части                 │
│  │ Delta Review    │                                           │
│  └────────┬────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  [5. Публикация]                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Правила версионирования

```
MAJOR.MINOR.PATCH

MAJOR (X.0.0):
- Кардинальное изменение логики
- Новые бизнес-правила
- Изменение scope

MINOR (0.X.0):
- Новые требования
- Изменение существующих требований
- Новые разделы

PATCH (0.0.X):
- Исправление ошибок
- Уточнение формулировок
- Косметические правки
```

### Команды

```bash
# Обновить ФМ
/update FM-XXX "Описание изменений"

# Обновить с указанием версии
/update FM-XXX --version=1.3.0 "Новая логика санкций"

# Добавить требование
/add-req FM-XXX BR "Название" "Описание"

# Обновить ePC
/epc-update FM-XXX
```

---

## 5️⃣ Генерация документации

```
┌─────────────────────────────────────────────────────────────────┐
│               WORKFLOW: Генерация документов                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [Confluence ФМ] ──┬──► PDF (для согласования)                  │
│                   │                                             │
│                   ├──► Confluence (основной)                    │
│                   │                                             │
│                   ├──► Confluence (корп. wiki)                 │
│                   │                                             │
│                   └──► Презентация (для стейкхолдеров)         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Команды

```bash
# Экспорт в PDF
/export FM-XXX --format=pdf

# Экспорт в PDF (из Confluence)
/export FM-XXX --format=pdf-from-confluence

# Создать презентацию (ключевые моменты)
/present FM-XXX --slides=10
```

---

## 6️⃣ Бизнес-согласование

```
┌─────────────────────────────────────────────────────────────────┐
│              WORKFLOW: Согласование ФМ с бизнесом               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [1. Внутренний ревью завершён]                                 │
│      │                                                          │
│      ▼                                                          │
│  Confluence: Статус ФМ → "Review" (жёлтый)                      │
│  Confluence-страница расшаривается бизнес-заказчику             │
│      │                                                          │
│      ▼                                                          │
│  [2. Бизнес читает ФМ в Confluence]                              │
│      │                                                          │
│      ├──► Оставляет комментарии в Confluence                    │
│      └──► Срок: 3 рабочих дня                                  │
│      │                                                          │
│      ▼                                                          │
│  [3. Анализ замечаний]                                          │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────┐                                           │
│  │ AGENT_3_DEFENDER │ ← Замечания из Confluence                 │
│  │ Ответ на замечания│                                          │
│  └────────┬────────┘                                           │
│           │                                                     │
│           ├──► Принять (доработать ФМ)                         │
│           └──► Отклонить (с аргументацией)                     │
│      │                                                          │
│      ▼                                                          │
│  [4. Доработка] ◄─── цикл до снятия замечаний                  │
│      │                                                          │
│      ▼                                                          │
│  [5. Согласовано]                                               │
│      │                                                          │
│      ▼                                                          │
│  Confluence: Статус ФМ → "Approved" (зелёный)                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Команды

```bash
# Отправить на согласование (статус → Review)
"Отправь ФМ на согласование"

# Проанализировать замечания бизнеса (Agent 3)
"Проанализируй замечания от бизнеса"  → /respond

# Подтвердить согласование (статус → Approved)
"ФМ согласована"

# Проверить статус
"Покажи статус согласования"
```

---

## 🔧 Интеграция с MCP

### Confluence API (Agent 7 — основной ответственный)

```
# Создать страницу ФМ
confluence_create_page(
  space: {key: "FM"},
  title: "FM-LS-PROFIT",
  body: {storage: {value: "...", representation: "storage"}}
)

# Проверить дубликат перед созданием
confluence_search(cql: "title = 'FM-LS-PROFIT'") → если найдено → обновить, не создавать

# Получить ФМ для валидации
confluence_get_page(page_id: "...")

# Обновить статус
confluence_update_page(page_id: "...", status: "Review")

# Добавить контент на страницу
confluence_append_body(page_id: "...", body: {storage: {value: "...", representation: "storage"}})
```

### Miro MCP (Agent 8 — основной ответственный)

```
# Получить DSL-спецификацию
MIRO:diagram_get_dsl(board_id: "...", diagram_type: "flowchart")

# Создать ePC-диаграмму
MIRO:diagram_create(board_id: "...", diagram_dsl: "...", diagram_type: "flowchart")

# Добавить легенду
MIRO:doc_create(board_id: "...", content: "# Легенда ePC\n...")

# Добавить RACI-таблицу
MIRO:table_create(board_id: "...", table_title: "RACI", columns: [...])

# Проверить содержимое доски
MIRO:context_explore(board_url: "https://miro.com/app/board/...")
```

### Filesystem (Claude Code встроенный)

```
# Прочитать ФМ — через Confluence REST API
# Записать отчёт — через стандартные файловые операции Claude Code
```

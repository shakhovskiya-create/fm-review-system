# Техническое задание: Контроль рентабельности отгрузок по ЛС

**Код проекта:** FM-LS-PROFIT
**Версия ФМ:** 1.0.4 (Confluence v82)
**Версия ТЗ:** 2.0
**Дата:** 25.02.2026
**Автор:** Шаховский А.С.
**Платформа:** 1С:Управление Торговлей 11.5+
**Расширение:** КонтрольРентабельностиОтгрузок
**Предыдущая версия ТЗ:** 1.0 (13.02.2026, ФМ v1.0.6)

---

## Содержание

1. [Общая информация](#1-общая-информация)
2. [Объекты разработки](#2-объекты-разработки)
3. [Интеграции](#3-интеграции)
4. [Фоновые задания](#4-фоновые-задания)
5. [Инфраструктура](#5-инфраструктура)
6. [Миграция и развертывание](#6-миграция-и-развертывание)
7. [Оценка трудоемкости](#7-оценка-трудоемкости)
8. [Критерии приемки](#8-критерии-приемки)
9. [Открытые вопросы](#9-открытые-вопросы)

---

## 1. Общая информация

### 1.1. Назначение системы

Система контроля рентабельности отгрузок по локальным сметам (ЛС) предназначена для предотвращения убыточных и низкомаржинальных частичных отгрузок в 1С:УТ. Система реализует:

- автоматический расчет рентабельности при создании Заказа клиента;
- 4-уровневую матрицу согласования отклонений (РБЮ - Директор ДРП - ДП - ГД);
- интеграцию с ELMA BPM для маршрутизации задач согласования;
- резервный режим при недоступности ELMA (НОВОЕ v1.0.4);
- интеграцию с WMS для контроля отгрузок;
- агрегированные лимиты автосогласования (НОВОЕ v1.0.4);
- перекрестный контроль шкал при изменении плана ЛС (НОВОЕ v1.0.4);
- автотриггеры пересчета НПСС (НОВОЕ v1.0.4);
- систему санкций за невыкуп ЛС (Этап 2).

### 1.2. Ссылки на документы

| Документ | Расположение |
|----------|-------------|
| Функциональная модель | Confluence, PAGE_ID 83951683, v1.0.4 |
| Архитектура | ARCHITECTURE-v1.0.4.md |
| Аудит-отчет | AUDIT-REPORT-v1.0.4-2026-02-25.md (13 замечаний: 1C/3H/5M/4L) |
| Тест-кейсы | TEST-CASES-v1.0.4-2026-02-25.md (72 тест-кейса) |
| Матрица трассируемости | traceability-matrix.json (30 записей, 100% покрытие) |
| ТЗ в Confluence | PAGE_ID 86048834 |
| Архитектура в Confluence | PAGE_ID 86048854 |

### 1.3. Основные формулы

**Рентабельность позиции:**
```
Рентабельность = (Цена - НПСС) / Цена x 100%
```

**Накопленная + Заказ:**
```
(Выручка_отгруж + Выручка_заказа - Себест_отгруж(НПСС) - Себест_заказа) /
(Выручка_отгруж + Выручка_заказа) x 100%
```

**Рентабельность остатка ЛС:**
```
SUM((Цена_i - НПСС_i) x Кол_i) / SUM(Цена_i x Кол_i) x 100%
```
где i - неотгруженные позиции за вычетом позиций Заказов в статусах "На согласовании" и "Согласован".

**Отклонение:**
```
Отклонение = Рент_ЛС(плановая) - MAX(Накопленная+Заказ, Рент_остатка)
Округление: до 2 знаков ДО сравнения с границами
```

### 1.4. Матрица согласования Заказов

| Отклонение (п.п.) | Согласующий | SLA P1 | SLA P2 | SLA <100тр | Автоэскалация |
|-------------------|-------------|--------|--------|------------|---------------|
| < 1,00 | Не требуется | - | - | - | - |
| 1,00 - 15,00 | РБЮ | 4ч | 24ч | 2ч | Директор ДРП |
| 15,01 - 25,00 | ДП | 8ч | 48ч | 4ч | ГД |
| > 25,00 | ГД | 24ч | 72ч | 12ч | Автоотказ 48ч |

### 1.5. Приоритизация (P1 / P2)

- **P1 (MVP):** **64 требования** -- контроль рентабельности, согласование, жизненный цикл, блокировки, базовые отчеты, интеграции, пилотные отчеты (LS-BR/FR/WF/INT/NFR/SEC до 049, LS-FR-070, LS-BR-075, LS-RPT-068..074);
- **P2 (Этап 2):** 19 требований -- обеспечение наличием, санкции за невыкуп, расширенные отчеты (LS-FR/WF/RPT 050-068 кроме 068).

### 1.6. Целевые показатели

- **50-70 одновременных пользователей** (обновлено, было 10-50);
- до 1000 позиций в одной ЛС;
- до 50 Заказов на согласовании по одной ЛС;
- расчет рентабельности -- не более 2 секунд (до 500 позиций);
- обработка сообщения WMS -- не более 30 секунд;
- **таймаут блокировки ЛС: 5 минут** (обновлено, было 15 минут).

---

## 2. Объекты разработки

### 2.1. Расширение конфигурации

**Имя:** `КонтрольРентабельностиОтгрузок`
**Режим совместимости:** Версия 8.3.22+

**Расширяемые объекты типовой конфигурации:**
- Документ.ЗаказКлиента (новые реквизиты, подписки на события, форма);
- Документ.РеализацияТоваровУслуг (подписка на проведение, проверка согласования);
- Документ.ВозвратТоваровОтПокупателя (подписка на проведение, пересчет);
- Справочник.Контрагенты (новые реквизиты для санкций);
- Справочник.Номенклатура (чтение НПСС).

### 2.2. Новые объекты v1.0.4 (дельта от v1.0.6)

Полная спецификация объектов, перешедших из v1.0.6, -- см. TZ-v1.0.6.md. Ниже описаны только изменения и новые объекты v1.0.4.

---

#### 2.2.1. Изменение: Блокировка ЛС (CRIT-001)

**Было (v1.0.6):** Таймаут блокировки 15 мин, регламентное задание ОчисткаБлокировок каждые 5 мин.
**Стало (v1.0.4):** Таймаут **5 мин**, ОчисткаБлокировок **каждую минуту**.

**Затронутые объекты:**
- Константа `ТаймаутБлокировкиЛС`: значение 15 -> **5**
- Регистр `БлокировкиЛС`: реквизит ВремяИстечения = ВремяБлокировки + **5 мин**
- Регламентное задание `ОчисткаБлокировок`: расписание каждую **1 мин** (было 5 мин)
- Уведомление "Завершите редактирование": через **3 мин** (было 10 мин)

**Трассировка:** CRIT-001 аудита -> LS-BR-035 -> п. 3.15, п. 3.16 ФМ

**Псевдокод:**
```
// При создании/редактировании Заказа
Процедура УстановитьБлокировкуЛС(ЛокальнаяСмета, Пользователь)
  ТаймаутМинут = Константы.ТаймаутБлокировкиЛС.Получить(); // = 5
  Запись = РегистрыСведений.БлокировкиЛС.СоздатьМенеджерЗаписи();
  Запись.ЛокальнаяСмета = ЛокальнаяСмета;
  Запись.Пользователь = Пользователь;
  Запись.ВремяБлокировки = ТекущаяДата();
  Запись.ВремяИстечения = ТекущаяДата() + ТаймаутМинут * 60;
  Запись.Записать();
КонецПроцедуры

// Регламентное задание: каждую 1 мин
Процедура ОчисткаБлокировок()
  Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ БлокировкиЛС.ЛокальнаяСмета
    ИЗ РегистрСведений.БлокировкиЛС КАК БлокировкиЛС
    ГДЕ БлокировкиЛС.ВремяИстечения < &ТекущееВремя";
  Запрос.УстановитьПараметр("ТекущееВремя", ТекущаяДата());
  // Удалить просроченные записи
КонецПроцедуры
```

---

#### 2.2.2. НОВЫЙ объект: Регистр накопления "ЛимитыАвтосогласования" (BIZ-001)

**Назначение:** Контроль дневных лимитов автосогласования на менеджера и БЮ.

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | Менеджер | СправочникСсылка.Пользователи | Менеджер |
| Измерение | БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ |
| Измерение | Период | Дата | День |
| Ресурс | СуммаМенеджер | Число(15,2) | Лимит 20 000 руб./день |
| Ресурс | СуммаБЮ | Число(15,2) | Лимит 100 000 руб./день |

**Регистратор:** Документ.ЗаказКлиента (при автосогласовании)

**Алгоритм проверки:**
```
// Перед автосогласованием
Функция ПроверитьЛимитыАвтосогласования(Менеджер, БЮ, СуммаЗаказа) Экспорт
  // 1. Получить текущие остатки на сегодня
  ОстаткиМенеджер = ПолучитьОстатки(Менеджер, ТекущаяДата());
  ОстаткиБЮ = ПолучитьОстатки(БЮ, ТекущаяДата());

  // 2. Проверить оба лимита
  ЕСЛИ ОстаткиМенеджер + СуммаЗаказа > 20000 ТОГДА
    Возврат Ложь; // Направить на стандартное согласование РБЮ
  КонецЕсли;

  ЕСЛИ ОстаткиБЮ + СуммаЗаказа > 100000 ТОГДА
    Возврат Ложь;
  КонецЕсли;

  Возврат Истина; // Автосогласование разрешено
КонецФункции
```

**Трассировка:** BIZ-001 -> п. 3.7 ФМ -> TC-013, TC-014, TC-016

---

#### 2.2.3. НОВЫЙ объект: Регистр сведений "НагрузкаСогласующих" (HIGH-002, HIGH-003)

**Назначение:** Мониторинг нагрузки с двумя раздельными порогами.

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | Согласующий | СправочникСсылка.Пользователи | Согласующий |
| Период | Период | Дата | День |
| Ресурс | ЗадачВОчереди | Число(3,0) | Текущее количество задач (порог 30 = перелив) |
| Ресурс | ЗадачЗаДень | Число(3,0) | Всего задач за день (порог 50 = доп. согласующий) |
| Ресурс | ПереливАктивен | Булево | Автоперелив включен |
| Ресурс | ДопСогласующийНазначен | Булево | Доп. согласующий назначен |

**Два механизма (HIGH-002):**
- **Порог 30 (перелив):** автоматическое переключение новых задач на заместителя. Работает без участия человека.
- **Порог 50 (назначение):** информационный сигнал руководителю о необходимости назначить дополнительного согласующего. Ручное действие.

**Виджет согласующего (UX-MEDIUM-003):**
```
Wireframe:
+-----------------------------------------------------+
| Нагрузка: 28/30 (перелив) | 42/50 (дневной лимит)  |
| [===========================.....]                   |
| [================================.............]      |
+-----------------------------------------------------+
```

**Трассировка:** HIGH-002, HIGH-003 -> п. 5 ФМ -> TC-028, TC-029, TC-031

---

#### 2.2.4. НОВЫЙ объект: Регистр сведений "ОчередьРезервногоРежима" (BIZ-012)

**Назначение:** Очередь заявок при недоступности ELMA.

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | ЗаявкаНаСогласование | ДокументСсылка | Заявка |
| Ресурс | ДатаПостановки | Дата | Когда поставлена в очередь |
| Ресурс | Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | P1 / P2 |
| Ресурс | Отклонение | Число(5,2) | Отклонение (п.п.) |
| Ресурс | Статус | Строка(20) | ВОчереди / Автосогласовано / ОтправленоВЕлму |

**Алгоритм резервного режима:**
```
// Определение недоступности ELMA
Функция ELMAДоступна() Экспорт
  // Таймаут 30 сек ИЛИ 3 неудачные попытки
  Результат = ИнтеграцияELMAСервер.ПроверитьДоступность();
  Возврат Результат.Успех;
КонецФункции

// При создании заявки на согласование
ЕСЛИ НЕ ELMAДоступна() ТОГДА
  ЕСЛИ Отклонение <= 5.00 ТОГДА
    // Автосогласование без ELMA
    ЗаписатьВОчередь(Заявка, "Автосогласовано");
    УведомитьСогласующего("Автосогласовано в резервном режиме");
  ИНАЧЕ
    // Ожидание в очереди FIFO
    ЗаписатьВОчередь(Заявка, "ВОчереди");
    УведомитьМенеджера("ELMA недоступна. Заявка в очереди.");
  КонецЕсли;
КонецЕсли;

// При восстановлении ELMA
Процедура ОбработатьОчередь()
  // P1 первыми, далее P2, внутри приоритета - FIFO
  Очередь = ПолучитьОчередь("ВОчереди");
  Для Каждого Заявка Из Очередь Цикл
    ИнтеграцияELMAСервер.СоздатьЗадачу(Заявка);
    ОбновитьСтатус(Заявка, "ОтправленоВЕлму");
  КонецЦикла;
КонецПроцедуры
```

**Трассировка:** BIZ-012 -> п. 3.13 ФМ -> TC-025, TC-026, TC-027

---

#### 2.2.5. НОВЫЙ объект: Регистр сведений "ИтерацииКорректировкиЦены"

**Назначение:** Журнал итераций корректировки цены (п. 3.5.1, лимит 5).

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | ЗаказКлиента | ДокументСсылка | Заказ |
| Измерение | НомерИтерации | Число(1,0) | 1-5 |
| Ресурс | ДатаИтерации | Дата | Дата/время |
| Ресурс | Инициатор | СправочникСсылка.Пользователи | Согласующий |
| Ресурс | ПредложеннаяЦена | Число(15,2) | Новая цена |
| Ресурс | Результат | Строка(20) | Принято / Отклонено / АвтоОтказ |

**Алгоритм:**
```
// При решении "Согласовать с корректировкой"
Функция ПроверитьЛимитИтераций(ЗаказСсылка) Экспорт
  ТекущаяИтерация = ПолучитьКоличествоИтераций(ЗаказСсылка);
  Лимит = Константы.ЛимитИтерацийКорректировки.Получить(); // = 5

  ЕСЛИ ТекущаяИтерация >= Лимит ТОГДА
    // Автоотказ
    УстановитьСтатусЗаказа(ЗаказСсылка, "Черновик");
    УведомитьМенеджера("Лимит итераций корректировки исчерпан (5 из 5).");
    Возврат Ложь;
  КонецЕсли;

  Возврат Истина;
КонецФункции
```

**Трассировка:** п. 3.5.1 ФМ -> TC-017, TC-018, TC-019

---

#### 2.2.6. Изменение: Расширение Заказа клиента

Дополнительно к реквизитам из v1.0.6:

| Имя | Тип 1С | Описание |
|-----|--------|----------|
| НомерИтерацииКорректировки | Число(1,0) | Счетчик итераций (макс. 5) |

---

#### 2.2.7. Изменение: ЗаявкаНаСогласование

Дополнительно к реквизитам из v1.0.6:

| Имя | Тип 1С | Описание |
|-----|--------|----------|
| РежимСогласования | ПеречислениеСсылка.РежимыСогласования | Стандартный / Резервный |
| ПричинаПерекрестногоКонтроля | Строка(500) | Причина возврата на пересогласование |

---

#### 2.2.8. Шаблон уведомления при перекрестном контроле (UX-MEDIUM-004)

**Шаблон:**
```
Заказ N[НомерЗаказа] возвращен на согласование.
Причина: изменение плана ЛС с [СтарыйПлан]% до [НовыйПлан]%.
Новый уровень согласования: [Уровень].
SLA: [SLAЧасов]ч.
```

**Канал доставки:** Push-уведомление в 1С + email.

---

### 2.3. Отчеты v1.0.4

#### 2.3.1. LS-RPT-070 "Дашборд эффективности контроля" (НОВЫЙ)

**Назначение:** Ежедневный дашборд для ФД.
**Получатели:** Финансовый директор.
**Обновление:** Ежедневно, автоматически.

**Виджеты:**
- Количество согласований за период (одобрено / отклонено / эскалировано)
- Средняя маржа ЛС (план vs факт)
- Топ-10 менеджеров по отклонению от плана
- Суммарный убыток из-за согласований
- Количество экстренных согласований

**Автоалерт (UX-LOW-001, рекомендация P2):** при отклонении показателя > 20% от среднего за 7 дней -- автоматическое уведомление ФД.

#### 2.3.2. LS-RPT-072 "Нагрузка согласующих" (НОВЫЙ, обновлен HIGH-003)

**Назначение:** Контроль нагрузки на согласующих с ДВУМЯ порогами.
**Получатели:** ДП, РБЮ.
**Периодичность:** Еженедельно.

**Колонки:**
- Согласующий (ФИО, роль, БЮ)
- Задач в очереди (текущее значение / порог 30)
- Задач за день (текущее значение / порог 50)
- Автоперелив (Да/Нет)
- Доп. согласующий назначен (Да/Нет)
- Среднее время решения
- Количество эскалаций

**Два порога (HIGH-002, HIGH-003):**
- Порог 30 = автоперелив на заместителя (автоматический)
- Порог 50 = назначение доп. согласующего (информационный + ручной)

#### 2.3.3. LS-RPT-073 "Базовый замер KPI" (НОВЫЙ)

**Назначение:** Замер KPI перед пилотом.
**Получатели:** Рабочая группа.
**Периодичность:** Однократно, перед пилотом.
**Данные:** 100+ ЛС за 6 месяцев, средняя маржа, % невыкупа, количество просрочек.

#### 2.3.4. LS-RPT-074 "Промежуточный отчет пилота" (НОВЫЙ)

**Назначение:** Контроль пилота через 1 мес.
**Получатели:** Рабочая группа.
**Периодичность:** Однократно, через 1 мес. пилота.
**Порог:** Если > 50% рекомендаций контроля игнорируются -- рабочая группа за 5 р.д.

---

## 3. Интеграции

### 3.1. ELMA BPM (LS-INT-003) + Резервный режим

Без структурных изменений относительно v1.0.6. Дополнение: **резервный режим** (см. раздел 2.2.4).

### 3.2. WMS (LS-INT-001, LS-INT-002)

Без изменений.

### 3.3. EDI

Без изменений.

### 3.4. ЦБ РФ (НОВОЕ v1.0.4, LS-BR-075)

| Параметр | Значение |
|----------|----------|
| Направление | Входящая |
| Протокол | REST API (cbr.ru/scripts/XML_daily.asp) |
| Формат | XML |
| Частота | Ежедневно, 08:00 MSK |
| Валюты | USD, EUR, CNY |

**Алгоритм автотриггера:**
```
// Ежедневно в 08:00
Процедура КонтрольАвтотриггеровНПСС()
  КурсСегодня = ПолучитьКурсЦБ("USD", ТекущаяДата());
  Курс7ДнейНазад = ПолучитьКурсЦБ("USD", ТекущаяДата() - 7);
  Изменение = Абс(КурсСегодня - Курс7ДнейНазад) / Курс7ДнейНазад * 100;

  ЕСЛИ Изменение > 5 ТОГДА
    // Автопересчет НПСС для всех импортных позиций
    ПересчитатьНПСС("КурсЦБ");
    УведомитьФинслужбу("Курс USD изменился на " + Изменение + "%. НПСС пересчитана.");
  КонецЕсли;
КонецПроцедуры
```

---

## 4. Фоновые задания

Полная таблица -- см. ARCHITECTURE-v1.0.4.md, раздел 4. Ниже -- только НОВЫЕ задания v1.0.4.

### 4.1. МониторингELMA (НОВОЕ)

| Параметр | Значение |
|----------|----------|
| Расписание | Каждые 5 мин |
| Таймаут | 2 мин |
| Retry | 3 x 1 мин |
| Мониторинг | Алерт IT-службе при недоступности |

### 4.2. ПерекрестныйКонтрольШкал (НОВОЕ)

| Параметр | Значение |
|----------|----------|
| Расписание | Событийный (при изменении плана ЛС) |
| Таймаут | 15 мин |
| Retry | 3 x 5 мин |
| Мониторинг | Уведомление менеджеру |

### 4.3. КонтрольАвтотриггеровНПСС (НОВОЕ)

| Параметр | Значение |
|----------|----------|
| Расписание | Ежедневно, 08:00 MSK |
| Таймаут | 30 мин |
| Retry | 3 x 5 мин |
| Мониторинг | Алерт финслужбе |

### 4.4. ОбработкаОчередиРезервногоРежима (НОВОЕ)

| Параметр | Значение |
|----------|----------|
| Расписание | Каждые 5 мин (при резервном режиме) |
| Таймаут | 5 мин |
| Retry | 3 x 1 мин |
| Мониторинг | Лог в журнал |

---

## 5. Инфраструктура

### 5.1. Константы (дельта v1.0.4)

| Имя | Тип | Значение | Назначение |
|-----|-----|----------|------------|
| ТаймаутБлокировкиЛС | Число(3,0) | **5** | Таймаут блокировки ЛС (мин) |
| ЛимитАвтосогласованияМенеджер | Число(15,2) | 20000 | Дневной лимит (руб.) |
| ЛимитАвтосогласованияБЮ | Число(15,2) | 100000 | Дневной лимит (руб.) |
| ЛимитИтерацийКорректировки | Число(1,0) | 5 | Макс. итераций |
| ПорогПереливаОчереди | Число(3,0) | 30 | Автоперелив задач |
| ПорогНазначенияДопСогласующего | Число(3,0) | 50 | Информационный сигнал |
| ПорогELMAFallback | Число(5,2) | 5.00 | Автосогласование в резервном режиме (п.п.) |
| ТриггерКурсЦБ | Число(5,2) | 5.00 | Порог курса для НПСС (%) |
| ТриггерЗакупочнаяЦена | Число(5,2) | 15.00 | Порог закупочной цены (%) |

### 5.2. Функциональные опции (дельта v1.0.4)

| Имя | Значение по умолчанию | Назначение |
|-----|----------------------|------------|
| ИспользоватьРезервныйРежимELMA | Истина | ELMA fallback |
| ИспользоватьАгрегированныеЛимиты | Истина | Дневные лимиты автосогласования |
| ИспользоватьПерекрестныйКонтроль | Истина | Контроль при изменении плана ЛС |
| ИспользоватьАвтотриггерыНПСС | Истина | Автотриггеры пересчета НПСС |

---

## 6. Миграция и развертывание

### 6.1. Обработчик обновления ИБ

```
Процедура ПриОбновлении()
  // 1. Проверить версию данных расширения
  // 2. Установить новые константы:
  //    ТаймаутБлокировкиЛС = 5
  //    ЛимитАвтосогласованияМенеджер = 20000
  //    ЛимитАвтосогласованияБЮ = 100000
  //    ЛимитИтерацийКорректировки = 5
  //    ПорогПереливаОчереди = 30
  //    ПорогНазначенияДопСогласующего = 50
  //    ПорогELMAFallback = 5.00
  //    ТриггерКурсЦБ = 5.00
  //    ТриггерЗакупочнаяЦена = 15.00
  // 3. Создать/обновить регламентные задания 17-20
  // 4. Включить функциональные опции v1.0.4
КонецПроцедуры
```

### 6.2. План развертывания

| Этап | Действие | Кто | Даунтайм |
|------|----------|-----|----------|
| 1 | Резервное копирование | Админ | Нет |
| 2 | Установка расширения (тест) | Разработчик | Нет |
| 3 | Проверка на тестовой базе (72 тест-кейса) | QA | Нет |
| 4 | Установка расширения (прод) | Админ | 15-30 мин |
| 5 | Обработчик обновления ИБ | Авто | В рамках п.4 |
| 6 | Настройка интеграции с ЦБ РФ | Разработчик | Нет |
| 7 | Smoke-тест (50-70 пользователей) | QA + Ключевые пользователи | Нет |

### 6.3. Откат

| Сценарий | Действие | Потеря данных |
|----------|----------|---------------|
| Критический баг | Отключить расширение | Данные расширения сохранены |
| Полный откат | Восстановить из бэкапа | Данные с момента копии |
| Частичный откат | Отключить ФО (4 новые) | Нет |

---

## 7. Оценка трудоемкости

### 7.1. Дельта v1.0.4 (дополнительные работы)

| Категория | Объект | Часы |
|-----------|--------|-----:|
| **Блокировка ЛС** | Изменение таймаута 15->5 мин, частота задания | 4 |
| **Агрег. лимиты** | Регистр ЛимитыАвтосогласования + логика + тесты | 24 |
| **Нагрузка согласующих** | Регистр НагрузкаСогласующих + виджет + 2 механизма | 32 |
| **ELMA fallback** | Регистр ОчередьРезервногоРежима + задания 17,20 + логика | 40 |
| **Перекрестный контроль** | Задание 18 + логика пересчета + уведомления | 24 |
| **Итерации корректировки** | Регистр ИтерацииКорректировкиЦены + логика лимита | 12 |
| **Автотриггеры НПСС** | Задание 19 + интеграция ЦБ РФ + логика | 24 |
| **Отчеты** | LS-RPT-070, 072, 073, 074 (4 отчета) | 48 |
| **Константы + ФО** | 9 констант + 4 функциональные опции | 8 |
| **Тестирование дельты** | 72 тест-кейса (новые + регрессия) | 32 |
| **Итого дельта v1.0.4** | | **248** |

### 7.2. Сводная оценка (обновленная)

| Фаза | P1 (MVP) | P2 (Этап 2) | Итого |
|------|:--------:|:-----------:|:-----:|
| **Разработка (v1.0.6 базовая)** | 952 ч | 196 ч | 1 148 ч |
| **Дельта v1.0.4** | 248 ч | 0 ч | 248 ч |
| **Итого разработка** | 1 200 ч | 196 ч | 1 396 ч |
| **Тестирование** (40%) | 480 ч | 78 ч | 558 ч |
| **Документация** (10%) | 120 ч | 20 ч | 140 ч |
| **Развертывание и миграция** | 40 ч | 16 ч | 56 ч |
| **Обучение пользователей** | 40 ч | 16 ч | 56 ч |
| **Подитого** | 1 880 ч | 326 ч | 2 206 ч |
| **Буфер рисков (+25%)** | 470 ч | 82 ч | 552 ч |
| **ИТОГО** | **2 350 ч** | **408 ч** | **2 758 ч** |

### 7.3. Оценка в человеко-месяцах

При 168 рабочих часов в месяц:

| Фаза | Команда | Срок |
|------|---------|------|
| **P1 (MVP)** | 3 разработчика 1С + 1 аналитик + 1 тестировщик | ~4,5 месяца |
| **P2 (Этап 2)** | 2 разработчика 1С + 1 тестировщик | ~1,5 месяца |
| **Итого** | | ~6 месяцев |

### 7.4. Сравнение с v1.0.6

| Показатель | v1.0.6 | v1.0.4 | Дельта |
|------------|--------|--------|--------|
| Разработка P1 | 952 ч | 1 200 ч | +248 ч (+26%) |
| Итого с буфером | 2 293 ч | 2 758 ч | +465 ч (+20%) |
| Срок P1 | ~3,5 мес. | ~4,5 мес. | +1 мес. |
| Объектов 1С | 77 | 143 | +66 (вкл. константы, ФО) |

Увеличение на 20% обусловлено: ELMA fallback (+40ч), нагрузка согласующих (+32ч), агрегированные лимиты (+24ч), перекрестный контроль (+24ч), автотриггеры НПСС (+24ч), 4 новых отчета (+48ч).

---

## 8. Критерии приемки

### 8.1. Функциональные критерии (дельта v1.0.4)

| # | Критерий | Тест-кейсы |
|---|----------|-----------|
| 1 | Таймаут блокировки ЛС: 5 мин (не 15 мин) | TC-004, TC-036 |
| 2 | Агрегированный лимит менеджера: 20 000 руб./день | TC-013 |
| 3 | Агрегированный лимит БЮ: 100 000 руб./день | TC-014 |
| 4 | Лимит итераций корректировки: 5, при 6-й -- автоотказ | TC-017, TC-018, TC-019 |
| 5 | Перекрестный контроль: возврат на согласование при смене уровня | TC-021, TC-022, TC-023, TC-024 |
| 6 | ELMA fallback: автосогласование до 5 п.п. при недоступности | TC-025, TC-026 |
| 7 | ELMA fallback: очередь FIFO для > 5 п.п. | TC-027 |
| 8 | Порог перелива 30: автоматическое переключение | TC-028 |
| 9 | Порог назначения 50: информационный сигнал | TC-029 |
| 10 | LS-RPT-072: оба порога (30 и 50) | TC-031 |
| 11 | Автотриггеры НПСС: курс ЦБ > 5% | TC-034 |
| 12 | Автотриггеры НПСС: закупочная цена > 15% | TC-035 |
| 13 | Все 72 тест-кейса проходят успешно | Полная матрица |

### 8.2. Нефункциональные критерии (обновленные)

| # | Критерий | Целевое значение |
|---|----------|-----------------|
| 1 | Расчет рентабельности (до 500 позиций) | <= 2 секунд |
| 2 | Максимум позиций в ЛС | 1000 |
| 3 | Максимум Заказов на согласовании | 50 |
| 4 | Обработка сообщения WMS | <= 30 секунд |
| 5 | Одновременные пользователи | **50-70** |
| 6 | Блокировка ЛС: таймаут | **5 мин** |
| 7 | Блокировка ЛС: ожидание | <= 30 секунд |
| 8 | Переключение на резервный режим ELMA | <= 5 мин |
| 9 | RLS | LS-SEC-001 |
| 10 | Журнал аудита: хранение | 5 лет, без удаления |

---

## 9. Открытые вопросы

| # | Вопрос | Источник | Влияние | Статус |
|---|--------|----------|---------|--------|
| Q1 | Таймаут блокировки: 5 мин или 15 мин? | CRIT-001, Agent 1 | Блокировка ЛС | РЕШЕН: 5 мин (по основному тексту п. 3.15, п. 3.16). LS-BR-035 требует обновления. |
| Q2 | Число P1-требований: 61 или 64? | HIGH-001, Agent 1 | Scope MVP | РЕШЕН: 64 (считано фактически). Текст ФМ требует обновления. |
| Q3 | Race condition: НПСС + согласование | GAP-02, Agent 4 | Конкурентность | ОТКРЫТ: Поведение при одновременном пересчете НПСС и согласовании не определено в ФМ. Рекомендация: блокировка ЛС на время пересчета НПСС (1-2 сек). |

---

## Ссылки

- ФМ: [Confluence PAGE_ID 83951683](https://confluence.ekf.su/pages/viewpage.action?pageId=83951683)
- Архитектура: ARCHITECTURE-v1.0.4.md
- Тест-кейсы: TEST-CASES-v1.0.4-2026-02-25.md (72 тест-кейса)
- Матрица трассируемости: traceability-matrix.json
- Предыдущая версия ТЗ: TZ-v1.0.6.md
- ТЗ в Confluence: [PAGE_ID 86048834](https://confluence.ekf.su/pages/viewpage.action?pageId=86048834)
- Архитектура в Confluence: [PAGE_ID 86048854](https://confluence.ekf.su/pages/viewpage.action?pageId=86048854)

# Техническое задание: Контроль рентабельности отгрузок по ЛС

**Код проекта:** FM-LS-PROFIT
**Версия ФМ:** 1.0.7
**Версия ТЗ:** 3.1
**Дата:** 26.02.2026
**Автор:** Шаховский А.С.
**Платформа:** 1С:Предприятие 8.3, конфигурация 1С:Управление Торговлей 10.2
**Режим работы:** Обычное приложение (толстый клиент, обычные формы)
**Расширение:** КонтрольРентабельностиОтгрузок (.cfe)

---

## Содержание

1. [Общая информация](#1-общая-информация)
2. [Объекты разработки](#2-объекты-разработки)
3. [Интеграции](#3-интеграции)
4. [Фоновые задания](#4-фоновые-задания)
5. [Инфраструктура](#5-инфраструктура)
6. [Миграция и развертывание](#6-миграция-и-развертывание)
7. [Оценка трудоемкости](#7-оценка-трудоемкости)
8. [Критерии приемки](#8-критерии-приемки)
9. [Технические ограничения и риски](#9-технические-ограничения-и-риски)
10. [Открытые вопросы](#10-открытые-вопросы)

---

---

## 1. Общая информация

### 1.1. Назначение системы

Система контроля рентабельности отгрузок по локальным сметам (ЛС) предназначена для предотвращения убыточных и низкомаржинальных частичных отгрузок в 1С:УТ. Система реализует:

- автоматический расчет рентабельности при создании Заказа клиента;
- 4-уровневую матрицу согласования отклонений (РБЮ - Директор ДРП - ДП - ГД);
- интеграцию с ELMA BPM для маршрутизации задач согласования;
- резервный режим при недоступности ELMA;
- интеграцию с WMS для контроля отгрузок;
- агрегированные лимиты автосогласования;
- перекрестный контроль шкал при изменении плана ЛС;
- автотриггеры пересчета НПСС;
- систему санкций за невыкуп ЛС (Этап 2).

### 1.2. Ссылки на документы

| Документ | Расположение |
|----------|-------------|
| Функциональная модель | Confluence, PAGE_ID 83951683, v1.0.5 |
| Архитектура | ARCHITECTURE-v1.0.5.md |
| Тест-кейсы | 72 тест-кейса |
| Матрица соответствия | 30 записей |
| ТЗ в Confluence | PAGE_ID 86049548 |
| Архитектура в Confluence | PAGE_ID 86049550 |

### 1.3. Основные формулы

**Рентабельность позиции:**
```
Рентабельность = (Цена - НПСС) / Цена x 100%
```

**Накопленная + Заказ:**
```
(Выручка_отгруж + Выручка_заказа - Себест_отгруж(НПСС) - Себест_заказа) /
(Выручка_отгруж + Выручка_заказа) x 100%
```

**Рентабельность остатка ЛС:**
```
SUM((Цена_i - НПСС_i) x Кол_i) / SUM(Цена_i x Кол_i) x 100%
```
где i - неотгруженные позиции за вычетом позиций Заказов в статусах "На согласовании" и "Согласован".

**Отклонение:**
```
Отклонение = Рент_ЛС(плановая) - MAX(Накопленная+Заказ, Рент_остатка)
Округление: до 2 знаков ДО сравнения с границами
```

### 1.4. Матрица согласования Заказов

| Отклонение (п.п.) | Согласующий | SLA P1 | SLA P2 | SLA <100тр | Автоэскалация |
|-------------------|-------------|--------|--------|------------|---------------|
| < 1,00 | Не требуется | - | - | - | - |
| 1,00 - 15,00 | РБЮ | 4ч | 24ч | 2ч | Директор ДРП |
| 15,01 - 25,00 | ДП | 8ч | 48ч | 4ч | ГД |
| > 25,00 | ГД | 24ч | 72ч | 12ч | Автоотказ 48ч |

### 1.5. Приоритизация (P1 / P2)

- **P1 (MVP):** **64 требования** -- контроль рентабельности, согласование, жизненный цикл, блокировки, базовые отчеты, интеграции, пилотные отчеты (LS-BR/FR/WF/INT/NFR/SEC до 049, LS-FR-070, LS-BR-075, LS-RPT-068..074);
- **P2 (Этап 2):** 19 требований -- обеспечение наличием, санкции за невыкуп, расширенные отчеты (LS-FR/WF/RPT 050-068 кроме 068).

### 1.6. Целевые показатели

- **50-70 одновременных пользователей**;
- до 1000 позиций в одной ЛС;
- до 50 Заказов на согласовании по одной ЛС;
- расчет рентабельности -- не более 2 секунд (до 500 позиций);
- обработка сообщения WMS -- не более 30 секунд;
- **таймаут блокировки ЛС: 5 минут**.

### 1.7. Платформа и режим работы

**Платформа:** 1С:Предприятие 8.3
**Конфигурация:** 1С:Управление Торговлей, редакция 10.2
**Режим:** Обычное приложение (толстый клиент, обычные формы)
**Поддержка вендором:** Прекращена с 01.04.2024

#### 1.7.1. Режим обычного приложения

УТ 10.2 работает исключительно в режиме обычного приложения. Все формы -- обычные (не управляемые). Это принципиально отличается от актуальных редакций (11.x) и влияет на все аспекты разработки.

| Аспект | Что доступно | Что НЕ доступно |
|--------|-------------|-----------------|
| Формы | Обычные формы. Элементы создаются в конфигураторе расширения. Программно управляется видимость, заголовки, цвета | Управляемые формы. Декларативное описание. Условное оформление формы |
| Обработчики | ПриОткрытии(), ПередЗаписью(), ПослеЗаписи(), ПриЗакрытии() | ПриСозданииНаСервере(), ОбработкаОповещения() |
| Контекст выполнения | Единый (клиент = сервер). Весь код выполняется на сервере приложений | Разделение клиент/сервер. Директивы компиляции |
| Кнопки | Кнопки с привязкой к процедурам модуля формы | Команды формы (объект КомандыФормы) |
| Видимость элементов | Программно: ЭлементыФормы.Имя.Видимость = Истина/Ложь | Условное оформление формы |
| Общие модули | Серверные + Глобальные | КлиентСервер, ВызовСервера |
| Модальные вызовы | Доступны: Предупреждение(), Вопрос(), ОткрытьФормуМодально() | Нет ограничений на модальность |
| Расширения | .cfe с перехватом &Перед/&После/&Вместо (платформа 8.3) | - |
| HTTP-сервисы | REST API (платформа 8.3) | - |
| Фоновые задания | Регламентные задания (платформа 8.3) | - |
| Таймеры | ПодключитьОбработчикОжидания (платформа 8.3) | - |

#### 1.7.2. Влияние на разработку

| Область | Влияние | Коэффициент |
|---------|---------|-------------|
| Разработка форм | Все элементы размещаются в конфигураторе расширения (.cfe). Программно управляется видимость, подписи и цвета. Каждая кнопка требует отдельной процедуры-обработчика. Условная видимость -- только через код. | +40% |
| Отладка | Единый контекст -- нет разделения на клиентский и серверный шаг. Менее информативные средства диагностики при работе с обычными формами. | +30% |
| Тестирование | Нет инструментов автоматизированного UI-тестирования обычных форм (Vanessa, TestClient работают только с управляемыми формами). Только ручное тестирование. | +35% |
| Документирование | Необходимость описывать нестандартные решения, обходы ограничений платформы. | +20% |

**Средневзвешенный коэффициент: +35%** к базовой оценке трудоемкости.

#### 1.7.3. Рекомендации

- Весь функционал реализуется через расширение КонтрольРентабельностиОтгрузок (.cfe);
- Серверная логика (регистры, модули объектов, подписки на события) не зависит от типа форм и переносится на УТ 11.x без переработки;
- Формы расширения при миграции на УТ 11.x потребуют полной переработки (обычные -> управляемые);
- Рекомендуется заложить бюджет на миграцию в среднесрочном горизонте (12-18 месяцев).

---

## 2. Объекты разработки

### 2.1. Расширение конфигурации

**Имя:** `КонтрольРентабельностиОтгрузок`
**Режим совместимости:** Версия 8.3.22+

**Расширяемые объекты типовой конфигурации:**
- Документ.ЗаказКлиента (новые реквизиты, подписки на события, форма);
- Документ.РеализацияТоваровУслуг (подписка на проведение, проверка согласования);
- Документ.ВозвратТоваровОтПокупателя (подписка на проведение, пересчет);
- Справочник.Контрагенты (новые реквизиты для санкций);
- Справочник.Номенклатура (чтение НПСС).

### 2.2. Объекты v1.0.5

Подробная спецификация каждого объекта .2. 

---

#### 2.2.1. Блокировка ЛС

Таймаут **5 мин**, регламентное задание ОчисткаБлокировок **каждую минуту**.

**Затронутые объекты:**
- Константа `ТаймаутБлокировкиЛС`: значение **5**
- Регистр `БлокировкиЛС`: реквизит ВремяИстечения = ВремяБлокировки + **5 мин**
- Регламентное задание `ОчисткаБлокировок`: расписание каждую **1 мин**
- Уведомление "Завершите редактирование": через **3 мин**

**Псевдокод:**
```
// При создании/редактировании Заказа
Процедура УстановитьБлокировкуЛС(ЛокальнаяСмета, Пользователь)
  ТаймаутМинут = Константы.ТаймаутБлокировкиЛС.Получить(); // = 5
  Запись = РегистрыСведений.БлокировкиЛС.СоздатьМенеджерЗаписи();
  Запись.ЛокальнаяСмета = ЛокальнаяСмета;
  Запись.Пользователь = Пользователь;
  Запись.ВремяБлокировки = ТекущаяДата();
  Запись.ВремяИстечения = ТекущаяДата() + ТаймаутМинут * 60;
  Запись.Записать();
КонецПроцедуры

// Регламентное задание: каждую 1 мин
Процедура ОчисткаБлокировок()
  Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ БлокировкиЛС.ЛокальнаяСмета
    ИЗ РегистрСведений.БлокировкиЛС КАК БлокировкиЛС
    ГДЕ БлокировкиЛС.ВремяИстечения < &ТекущееВремя";
  Запрос.УстановитьПараметр("ТекущееВремя", ТекущаяДата());
  // Удалить просроченные записи
КонецПроцедуры
```

---

#### 2.2.2. Регистр накопления "ЛимитыАвтосогласования"

**Назначение:** Контроль дневных лимитов автосогласования на менеджера и БЮ.

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | Менеджер | СправочникСсылка.Пользователи | Менеджер |
| Измерение | БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ |
| Измерение | Период | Дата | День |
| Ресурс | СуммаМенеджер | Число(15,2) | Лимит 20 000 руб./день |
| Ресурс | СуммаБЮ | Число(15,2) | Лимит 100 000 руб./день |

**Регистратор:** Документ.ЗаказКлиента (при автосогласовании)

**Алгоритм проверки:**
```
// Перед автосогласованием
Функция ПроверитьЛимитыАвтосогласования(Менеджер, БЮ, СуммаЗаказа) Экспорт
  // 1. Получить текущие остатки на сегодня
  ОстаткиМенеджер = ПолучитьОстатки(Менеджер, ТекущаяДата());
  ОстаткиБЮ = ПолучитьОстатки(БЮ, ТекущаяДата());

  // 2. Проверить оба лимита
  ЕСЛИ ОстаткиМенеджер + СуммаЗаказа > 20000 ТОГДА
    Возврат Ложь; // Направить на стандартное согласование РБЮ
  КонецЕсли;

  ЕСЛИ ОстаткиБЮ + СуммаЗаказа > 100000 ТОГДА
    Возврат Ложь;
  КонецЕсли;

  Возврат Истина; // Автосогласование разрешено
КонецФункции
```

---

#### 2.2.3. Регистр сведений "НагрузкаСогласующих"

**Назначение:** Мониторинг нагрузки с двумя раздельными порогами.

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | Согласующий | СправочникСсылка.Пользователи | Согласующий |
| Период | Период | Дата | День |
| Ресурс | ЗадачВОчереди | Число(3,0) | Текущее количество задач (порог 30 = перелив) |
| Ресурс | ЗадачЗаДень | Число(3,0) | Всего задач за день (порог 50 = доп. согласующий) |
| Ресурс | ПереливАктивен | Булево | Автоперелив включен |
| Ресурс | ДопСогласующийНазначен | Булево | Доп. согласующий назначен |

**Два механизма:**
- **Порог 30 (перелив):** автоматическое переключение новых задач на заместителя. Оперативный механизм, работает без участия человека.
- **Порог 50 (назначение):** информационный сигнал руководителю о необходимости назначить дополнительного согласующего. Плановый механизм, ручное действие.

**Индикаторы нагрузки согласующего (надписи на обычной форме):**
```
Форма рабочего места согласующего (обычная форма):
+-----------------------------------------------------+
| Надпись "В очереди: 28/30"  | Надпись "За день: 42/50"|
| Цвет: красный при >= 30    | Цвет: красный при >= 50 |
+-----------------------------------------------------+
Надписи добавляются программно в ПриОткрытии.
Обновляются таймером (ПодключитьОбработчикОжидания).
```

---

#### 2.2.4. Регистр сведений "ОчередьРезервногоРежима"

**Назначение:** Очередь заявок при недоступности ELMA.

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | ЗаявкаНаСогласование | ДокументСсылка | Заявка |
| Ресурс | ДатаПостановки | Дата | Когда поставлена в очередь |
| Ресурс | Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | P1 / P2 |
| Ресурс | Отклонение | Число(5,2) | Отклонение (п.п.) |
| Ресурс | Статус | ПеречислениеСсылка.СтатусыОчередиРезервногоРежима | ВОчереди / Автосогласовано / ОтправленоВЕлму |

**Алгоритм резервного режима:**
```
// При создании заявки на согласование
ЕСЛИ НЕ ELMAДоступна() ТОГДА
  ЕСЛИ Отклонение <= 5.00 ТОГДА
    // Автосогласование без ELMA
    ЗаписатьВОчередь(Заявка, Перечисления.СтатусыОчередиРезервногоРежима.Автосогласовано);
    УведомитьСогласующего("Автосогласовано в резервном режиме");
  ИНАЧЕ
    // Ожидание в очереди FIFO
    ЗаписатьВОчередь(Заявка, Перечисления.СтатусыОчередиРезервногоРежима.ВОчереди);
    УведомитьМенеджера("ELMA недоступна. Заявка в очереди.");
  КонецЕсли;
КонецЕсли;

// При восстановлении ELMA
Процедура ОбработатьОчередь()
  // P1 первыми, далее P2, внутри приоритета - FIFO
  Очередь = ПолучитьОчередь(Перечисления.СтатусыОчередиРезервногоРежима.ВОчереди);
  Для Каждого Заявка Из Очередь Цикл
    ИнтеграцияELMAСервер.СоздатьЗадачу(Заявка);
    ОбновитьСтатус(Заявка, Перечисления.СтатусыОчередиРезервногоРежима.ОтправленоВЕлму);
  КонецЦикла;
КонецПроцедуры
```

---

#### 2.2.5. Регистр сведений "ИтерацииКорректировкиЦены"

**Назначение:** Журнал итераций корректировки цены (лимит 5).

| Роль | Имя | Тип | Описание |
|------|-----|-----|----------|
| Измерение | ЗаказКлиента | ДокументСсылка | Заказ |
| Измерение | НомерИтерации | Число(1,0) | 1-5 |
| Ресурс | ДатаИтерации | Дата | Дата/время |
| Ресурс | Инициатор | СправочникСсылка.Пользователи | Согласующий |
| Ресурс | ПредложеннаяЦена | Число(15,2) | Новая цена |
| Ресурс | Результат | ПеречислениеСсылка.РезультатыКорректировки | Принято / Отклонено / АвтоОтказ |

**Алгоритм:**
```
// При решении "Согласовать с корректировкой"
Функция ПроверитьЛимитИтераций(ЗаказСсылка) Экспорт
  ТекущаяИтерация = ПолучитьКоличествоИтераций(ЗаказСсылка);
  Лимит = Константы.ЛимитИтерацийКорректировки.Получить(); // = 5

  ЕСЛИ ТекущаяИтерация >= Лимит ТОГДА
    // Автоотказ
    УстановитьСтатусЗаказа(ЗаказСсылка, "Черновик");
    УведомитьМенеджера("Лимит итераций корректировки исчерпан (5 из 5).");
    Возврат Ложь;
  КонецЕсли;

  Возврат Истина;
КонецФункции
```

---

#### 2.2.6. Шаблон уведомления при перекрестном контроле

**Шаблон:**
```
Заказ N[НомерЗаказа] возвращен на согласование.
Причина: изменение плана ЛС с [СтарыйПлан]% до [НовыйПлан]%.
Новый уровень согласования: [Уровень].
SLA: [SLAЧасов]ч.
```

**Канал доставки:** Модальный диалог (Предупреждение) при открытии формы Заказа + запись в регистр сведений УведомленияПользователей + email.

---

### 2.3. Отчеты

#### 2.3.1. LS-RPT-070 "Дашборд эффективности контроля"

**Назначение:** Ежедневный дашборд для ФД.
**Получатели:** Финансовый директор.
**Обновление:** Ежедневно, автоматически.

**Виджеты:**
- Количество согласований за период (одобрено / отклонено / эскалировано)
- Средняя маржа ЛС (план vs факт)
- Топ-10 менеджеров по отклонению от плана
- Суммарный убыток из-за согласований
- Количество экстренных согласований

**Автоалерт (рекомендация P2):** при отклонении показателя > 20% от среднего за 7 дней -- автоматическое уведомление ФД.

#### 2.3.2. LS-RPT-072 "Нагрузка согласующих"

**Назначение:** Контроль нагрузки на согласующих с двумя порогами.
**Получатели:** ДП, РБЮ.
**Периодичность:** Еженедельно.

**Колонки:**
- Согласующий (ФИО, роль, БЮ)
- Задач в очереди (текущее значение / порог 30)
- Задач за день (текущее значение / порог 50)
- Автоперелив (Да/Нет)
- Доп. согласующий назначен (Да/Нет)
- Среднее время решения
- Количество эскалаций

**Два порога:**
- Порог 30 = автоперелив на заместителя (автоматический)
- Порог 50 = назначение доп. согласующего (информационный + ручной)

#### 2.3.3. LS-RPT-073 "Базовый замер KPI"

**Назначение:** Замер KPI перед пилотом.
**Получатели:** Рабочая группа.
**Периодичность:** Однократно, перед пилотом.
**Данные:** 100+ ЛС за 6 месяцев, средняя маржа, % невыкупа, количество просрочек.

#### 2.3.4. LS-RPT-074 "Промежуточный отчет пилота"

**Назначение:** Контроль пилота через 1 мес.
**Получатели:** Рабочая группа.
**Периодичность:** Однократно, через 1 мес. пилота.
**Порог:** Если > 50% рекомендаций контроля игнорируются -- рабочая группа за 5 р.д.

---

## 3. Интеграции

### 3.1. ELMA BPM (LS-INT-003) + Резервный режим

Без изменений относительно v1.0.4. Поддержка резервного режима (см. раздел 2.2.4).

### 3.2. WMS (LS-INT-001, LS-INT-002)

Без изменений.

### 3.3. EDI

Без изменений.

### 3.4. ЦБ РФ (LS-BR-075)

| Параметр | Значение |
|----------|----------|
| Направление | Входящая |
| Протокол | REST API (cbr.ru/scripts/XML_daily.asp) |
| Формат | XML |
| Частота | Ежедневно, 08:00 MSK |
| Валюты | USD, EUR, CNY |

**Алгоритм автотриггера:**
```
// Ежедневно в 08:00
Процедура КонтрольАвтотриггеровНПСС()
  КурсСегодня = ПолучитьКурсЦБ("USD", ТекущаяДата());
  Курс7ДнейНазад = ПолучитьКурсЦБ("USD", ТекущаяДата() - 7);
  Изменение = Абс(КурсСегодня - Курс7ДнейНазад) / Курс7ДнейНазад * 100;

  ЕСЛИ Изменение > 5 ТОГДА
    // Автопересчет НПСС для всех импортных позиций
    ПересчитатьНПСС("КурсЦБ");
    УведомитьФинслужбу("Курс USD изменился на " + Изменение + "%. НПСС пересчитана.");
  КонецЕсли;
КонецПроцедуры
```

---

## 4. Фоновые задания

Полная таблица из 20 заданий -- см. ARCHITECTURE-v1.0.5.md, раздел 4. Без изменений относительно v1.0.4.

---

## 5. Инфраструктура

### 5.1. Константы

| Имя | Тип | Значение | Назначение |
|-----|-----|----------|------------|
| ТаймаутБлокировкиЛС | Число(3,0) | 5 | Таймаут блокировки ЛС (мин) |
| ЛимитАвтосогласованияМенеджер | Число(15,2) | 20000 | Дневной лимит (руб.) |
| ЛимитАвтосогласованияБЮ | Число(15,2) | 100000 | Дневной лимит (руб.) |
| ЛимитИтерацийКорректировки | Число(1,0) | 5 | Макс. итераций |
| ПорогПереливаОчереди | Число(3,0) | 30 | Автоперелив задач |
| ПорогНазначенияДопСогласующего | Число(3,0) | 50 | Информационный сигнал |
| ПорогELMAFallback | Число(5,2) | 5.00 | Автосогласование в резервном режиме (п.п.) |
| ТриггерКурсЦБ | Число(5,2) | 5.00 | Порог курса для НПСС (%) |
| ТриггерЗакупочнаяЦена | Число(5,2) | 15.00 | Порог закупочной цены (%) |

### 5.2. Функциональные опции

| Имя | Значение по умолчанию | Назначение |
|-----|----------------------|------------|
| ИспользоватьРезервныйРежимELMA | Истина | Резервный режим при недоступности ELMA |
| ИспользоватьАгрегированныеЛимиты | Истина | Дневные лимиты автосогласования |
| ИспользоватьПерекрестныйКонтроль | Истина | Контроль при изменении плана ЛС |
| ИспользоватьАвтотриггерыНПСС | Истина | Автотриггеры пересчета НПСС |

---

## 6. Миграция и развертывание

### 6.1. Обработчик обновления ИБ

```
Процедура ПриОбновлении()
  // 1. Проверить версию данных расширения
  // 2. Установить новые константы:
  //    ТаймаутБлокировкиЛС = 5
  //    ЛимитАвтосогласованияМенеджер = 20000
  //    ЛимитАвтосогласованияБЮ = 100000
  //    ЛимитИтерацийКорректировки = 5
  //    ПорогПереливаОчереди = 30
  //    ПорогНазначенияДопСогласующего = 50
  //    ПорогELMAFallback = 5.00
  //    ТриггерКурсЦБ = 5.00
  //    ТриггерЗакупочнаяЦена = 15.00
  // 3. Создать/обновить регламентные задания 17-20
  // 4. Включить функциональные опции
КонецПроцедуры
```

### 6.2. План развертывания

| Этап | Действие | Кто | Даунтайм |
|------|----------|-----|----------|
| 1 | Резервное копирование | Админ | Нет |
| 2 | Установка расширения (тест) | Разработчик | Нет |
| 3 | Проверка на тестовой базе (72 тест-кейса) | QA | Нет |
| 4 | Установка расширения (прод) | Админ | 15-30 мин |
| 5 | Обработчик обновления ИБ | Авто | В рамках п.4 |
| 6 | Настройка интеграции с ЦБ РФ | Разработчик | Нет |
| 7 | Smoke-тест (50-70 пользователей) | QA + Ключевые пользователи | Нет |

### 6.3. Откат

| Сценарий | Действие | Потеря данных |
|----------|----------|---------------|
| Критический баг | Отключить расширение | Данные расширения сохранены |
| Полный откат | Восстановить из бэкапа | Данные с момента копии |
| Частичный откат | Отключить ФО (4 новые) | Нет |

---

## 7. Оценка трудоемкости

Оценка полностью пересмотрена с учетом реальных ограничений платформы 1С:УТ 10.2 (обычные формы, толстый клиент, прекращение поддержки).

### 7.1. Фактор платформенных ограничений

Работа с обычными формами 1С:УТ 10.2 существенно увеличивает трудоемкость по сравнению с разработкой на актуальных редакциях:

| Фактор | Причина увеличения | Коэффициент |
|--------|-------------------|-------------|
| Разработка форм | Все элементы размещаются в конфигураторе расширения (.cfe). Программно управляется видимость, подписи и цвета. Каждая кнопка -- отдельная процедура-обработчик. Условная видимость -- только через код. Подсветка элементов -- программно через свойства ЦветТекста/ЦветФона. | +40% |
| Отладка | Единый контекст выполнения. При ошибке в обычной форме менее информативные сообщения платформы. Нет пошагового выполнения «клиент -> сервер -> клиент». | +30% |
| Тестирование | Средства автоматизированного UI-тестирования (Vanessa Automation, TestClient) работают только с управляемыми формами. Для обычных форм -- только ручное тестирование. При 72 тест-кейсах это существенная нагрузка. | +35% |
| Документирование | Нестандартные решения для устаревшей платформы. Необходимость описывать обходы ограничений. | +20% |
| **Средневзвешенный коэффициент** | | **+35%** |

### 7.2. Детализация по объектам разработки

| Категория объектов | Кол-во | Базовые часы | Коэфф. платформы | Часы с коэфф. |
|-------------------|--------|:------------:|:----------------:|:-------------:|
| Справочники без форм | 4 | 80 ч | +10% (нет форм) | 88 ч |
| Справочники с формами | 2 | 40 ч | +40% (обычные формы в расширении) | 56 ч |
| Документы (расширение + новые) | 6 | 360 ч | +40% (формы) | 504 ч |
| Регистры накопления | 5 | 80 ч | +10% (нет форм) | 88 ч |
| Регистры сведений | 13 | 195 ч | +10% (нет форм) | 215 ч |
| Отчеты | 15 | 300 ч | +25% (табличные документы) | 375 ч |
| Обработки (рабочие места) | 3 | 120 ч | +50% (полностью новые обычные формы) | 180 ч |
| Фоновые задания | 20 | 160 ч | +0% (серверный код) | 160 ч |
| Интеграции (ELMA, WMS, ЦБ, EDI, HR) | 6 | 240 ч | +0% (HTTP-сервисы, серверный код) | 240 ч |
| Подписки на события | 8 | 64 ч | +0% (серверный код) | 64 ч |
| Общие модули | 6 | 96 ч | +15% (глобальные вместо клиент-серверных) | 110 ч |
| Роли, RLS, ФО, константы | 30 | 60 ч | +0% | 60 ч |
| **Итого разработка** | **119** | **1 795 ч** | | **2 148 ч** |

### 7.3. Сводная оценка

| Фаза | P1 (MVP) | P2 (Этап 2) | Итого |
|------|:--------:|:-----------:|:-----:|
| **Разработка** | 1 788 ч | 360 ч | 2 148 ч |
| **Тестирование** (35% + регресс) | 625 ч | 127 ч | 752 ч |
| **Регрессионное тестирование** (3 цикла) | 72 ч | -- | 72 ч |
| **Документация** (8%) | 143 ч | 29 ч | 172 ч |
| **Развертывание и миграция** | 48 ч | 20 ч | 68 ч |
| **Обучение пользователей** | 48 ч | 20 ч | 68 ч |
| **Подитого** | 2 724 ч | 556 ч | 3 280 ч |
| **Буфер рисков (+20%)** | 545 ч | 111 ч | 656 ч |
| **ИТОГО** | **3 269 ч** | **667 ч** | **3 936 ч** |

Увеличение относительно базовой оценки (без учета платформы): +1178 ч (+43%). Причина: коэффициент +35% на ограничения обычных форм, +8ч справочники с формами, +72ч регрессионное тестирование, буфер рисков 20% (устаревшая платформа).

**Примечание к тестированию:** Доля тестирования снижена с 40% до 35% от разработки, но в абсолютных часах близка к предыдущей оценке. Причина: все тестирование ручное (нет автотестов для обычных форм), но серверная логика (регистры, подписки, фоновые задания) тестируется через юнит-тесты 1С (xUnitFor1C), которые не зависят от типа форм.

### 7.4. Оценка в человеко-месяцах

При 168 рабочих часах в месяц:

| Фаза | Команда | Срок |
|------|---------|------|
| **P1 (MVP)** | 3 разработчика 1С (опыт обычных форм!) + 1 аналитик + 1 тестировщик | ~6 месяцев |
| **P2 (Этап 2)** | 2 разработчика 1С + 1 тестировщик | ~2 месяца |
| **Итого** | | ~8 месяцев |

**Требования к команде:** Обязателен опыт работы с обычными формами 1С и конфигурацией УТ 10.2. Разработчики с опытом только управляемых форм (УТ 11.x, ERP) потребуют 2-4 недели адаптации.

### 7.5. Риски оценки

| Риск | Влияние | Вероятность | Доп. часы |
|------|---------|-------------|-----------|
| Нехватка специалистов по УТ 10.2 | На рынке стремительно сокращается количество разработчиков с опытом обычных форм. Средняя ставка специалиста выше на 20-30%. | Высокая | +0 ч (влияет на сроки и бюджет) |
| Прекращение поддержки УТ 10.2 | При обнаружении ошибки в типовом коде УТ 10.2 -- обход силами команды через расширение. Вендор не выпускает исправления. | Средняя | +80-160 ч |
| Несовместимость с новыми версиями платформы 8.3 | Обновление платформы 8.3 может изменить поведение механизмов обычных форм. Необходимо тестирование расширения перед каждым обновлением. | Низкая | +40-80 ч |
| Миграция на УТ 11.x | При решении о миграции: серверная логика переносится без изменений, но ВСЕ формы (3 обработки + расширения форм документов) требуют полной переработки. | Средняя (12-18 мес.) | +400-600 ч (отдельный проект) |
| Невозможность автотестирования UI | Ручное тестирование 72 тест-кейсов при каждом обновлении. Регрессионное тестирование: 2-3 дня ручной работы тестировщика. | Факт | Учтено в оценке |

---

## 8. Критерии приемки

### 8.1. Функциональные критерии

| # | Критерий | Тест-кейсы | Способ проверки |
|---|----------|-----------|-----------------|
| 1 | Таймаут блокировки ЛС: 5 мин (не 15 мин) | TC-004, TC-036 | Ручной: засечь время блокировки |
| 2 | Агрегированный лимит менеджера: 20 000 руб./день | TC-013 | Ручной: серия автосогласований до лимита |
| 3 | Агрегированный лимит БЮ: 100 000 руб./день | TC-014 | Ручной: серия автосогласований от разных менеджеров |
| 4 | Лимит итераций корректировки: 5, при 6-й -- автоотказ | TC-017, TC-018, TC-019 | Ручной: 5 итераций корректировки |
| 5 | Перекрестный контроль: возврат на согласование при смене уровня | TC-021..TC-024 | Ручной: изменить план ЛС, проверить возврат |
| 6 | Резервный режим ELMA: автосогласование до 5 п.п. при недоступности | TC-025, TC-026 | Ручной: отключить ELMA, создать заказ |
| 7 | Резервный режим ELMA: очередь FIFO для > 5 п.п. | TC-027 | Ручной: проверить порядок обработки очереди |
| 8 | Порог перелива 30: автоматическое переключение | TC-028 | Ручной: накопить 30 задач, проверить перелив |
| 9 | Порог назначения 50: информационный сигнал | TC-029 | Ручной: проверить отображение надписи-индикатора |
| 10 | Отчет нагрузки: оба порога (30 и 50) | TC-031 | Ручной: проверить корректность данных в отчете |
| 11 | Автотриггеры НПСС: курс ЦБ > 5% | TC-034 | Ручной: подставить тестовые курсы |
| 12 | Автотриггеры НПСС: закупочная цена > 15% | TC-035 | Ручной: ввести закупку с отклонением |
| 13 | Все 72 тест-кейса проходят успешно | Полная матрица | Ручной: полный прогон (2-3 рабочих дня) |

**Примечание:** Все тесты UI-функциональности -- ручные. Средства автоматизированного тестирования обычных форм (Vanessa Automation, TestClient) недоступны. Серверная логика (расчеты, проверки, движения регистров) тестируется через юнит-тесты xUnitFor1C.

### 8.2. Нефункциональные критерии

| # | Критерий | Целевое значение | Способ проверки |
|---|----------|-----------------|-----------------|
| 1 | Расчет рентабельности (до 500 позиций) | <= 2 секунд | Замер: ТекущаяУниверсальнаяДатаВМиллисекундах() |
| 2 | Максимум позиций в ЛС | 1000 | Тест с ЛС на 1000 позиций |
| 3 | Максимум Заказов на согласовании | 50 | Нагрузочный тест |
| 4 | Обработка сообщения WMS | <= 30 секунд | Замер через лог HTTP-сервиса |
| 5 | Одновременные пользователи (толстый клиент) | 50-70 | Нагрузочное тестирование: 70 сеансов |
| 6 | Блокировка ЛС: таймаут | 5 мин | Засечь автоснятие |
| 7 | Блокировка ЛС: ожидание (модальный диалог) | <= 30 секунд | Два пользователя, одна ЛС |
| 8 | Открытие формы Заказа с панелью рентабельности | <= 2 секунд | Замер при 500 позициях |
| 9 | Переключение на резервный режим ELMA | <= 5 мин | Отключить ELMA, замерить |
| 10 | Потребление памяти сервера | Стабильно при 70 сеансах | Мониторинг 4+ часов |
| 11 | RLS: разграничение по БЮ | Менеджер видит только свой БЮ | Проверка от двух пользователей |
| 12 | Журнал аудита: хранение | 5 лет, без удаления | Попытка удаления записи |

---

## 9. Технические ограничения и риски

### 9.1. Ограничения платформы

| Ограничение | Описание | Способ обхода |
|-------------|----------|---------------|
| Нет автотестов UI | Vanessa Automation и TestClient не поддерживают обычные формы. Невозможно автоматизировать UI-тестирование. | Ручное тестирование (72 тест-кейса). Серверная логика тестируется через xUnitFor1C. |
| Нет условного оформления формы | В обычных формах нет объекта УсловноеОформление. Невозможно декларативно задать подсветку строк. | Программная подсветка через ПриВыводеСтроки табличного поля и свойства ЦветТекста/ЦветФона элементов. |
| Нет команд формы | В обычных формах нет объекта КомандыФормы. Невозможно программно создать команду с привязкой к обработчику. | Кнопки с привязкой к процедурам модуля формы (свойство Действие). |
| Нет ОповещениеПользователя | Механизм оповещений недоступен в обычных формах. | Модальные диалоги (Предупреждение, Вопрос), надписи на формах, регистр сведений УведомленияПользователей. |
| Единый контекст | Весь код формы выполняется на сервере. Нет возможности выполнить «легкий» клиентский код без обращения к серверу. | Кеширование через модуль с повторным использованием. Минимизация обращений к СУБД. |
| Нет веб-доступа | Толстый клиент не поддерживает работу через веб-браузер. | Веб-доступ -- через HTTP-сервисы (REST API) для интеграций. Для пользователей -- только толстый клиент. |

### 9.2. Риски проекта

| Риск | Описание | Вероятность | Влияние | Меры снижения |
|------|----------|-------------|---------|---------------|
| Нехватка специалистов | Разработчики с опытом обычных форм и УТ 10.2 -- редкость. Средняя ставка выше на 20-30%. | Высокая | Высокое (сроки, бюджет) | Раннее формирование команды. Бюджет на повышенные ставки. |
| Прекращение поддержки УТ 10.2 | Вендор не выпускает исправления. При обнаружении ошибки в типовом коде -- обход силами команды. | Средняя | Среднее (+80-160 ч) | Все доработки -- через расширение. Минимальное вмешательство в типовую логику. |
| Несовместимость при обновлении платформы 8.3 | Обновление платформы 8.3 может изменить поведение механизмов обычных форм (ЭлементыФормы, обработчики). | Низкая | Среднее (+40-80 ч) | Тестирование расширения перед каждым обновлением платформы на тестовой базе. |
| Миграция на УТ 11.x | Все формы расширения потребуют полной переработки. Серверная логика переносится без изменений. | Средняя (12-18 мес.) | Высокое (+400-600 ч) | Проектировать серверную логику отдельно от форм. Отдельный бюджет на миграцию. |
| Регрессионное тестирование | 72 тест-кейса выполняются вручную. При каждом обновлении -- 2-3 дня ручной работы тестировщика. | Факт | Среднее (стоимость владения) | Выделить постоянного тестировщика. Приоритизировать регрессионные тесты. |
| Производительность при 70 сеансах | 70 одновременных сеансов толстого клиента создают нагрузку на сервер приложений (память, CPU). | Средняя | Высокое | Нагрузочное тестирование обязательно. Мониторинг серверных ресурсов. |

---

## 10. Открытые вопросы

Открытых вопросов нет.

---

## Ссылки

- ФМ: [Confluence PAGE_ID 83951683](https://confluence.ekf.su/pages/viewpage.action?pageId=83951683)
- Архитектура: ARCHITECTURE-v1.0.5.md
- Тест-кейсы: тест-план проекта (72 тест-кейса)
- Матрица соответствия требований и тестов: в составе тест-плана
- ТЗ в Confluence: [PAGE_ID 86049548](https://confluence.ekf.su/pages/viewpage.action?pageId=86049548)
- Архитектура в Confluence: [PAGE_ID 86049550](https://confluence.ekf.su/pages/viewpage.action?pageId=86049550)

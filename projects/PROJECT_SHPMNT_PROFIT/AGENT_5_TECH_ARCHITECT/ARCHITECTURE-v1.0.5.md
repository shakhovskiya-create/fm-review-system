# Архитектура данных 1С:УТ - FM-LS-PROFIT v1.0.5

**Дата:** 25.02.2026
**Автор:** Шаховский А.С.
**Версия ФМ:** 1.0.5
**Платформа:** 1С:Управление Торговлей (1С:УТ) 10.2
**Пользователи:** 50-70 одновременных
**Целевое время обработки:** <= 3 секунд

---

## Содержание

1. [Архитектура данных](#1-архитектура-данных)
2. [Роли и права](#2-роли-и-права)
3. [Бизнес-процессы](#3-бизнес-процессы)
4. [Фоновые задания](#4-фоновые-задания)
5. [Ключевые точки контроля](#5-ключевые-точки-контроля)
6. [Потенциальные блокировки](#6-потенциальные-блокировки)
7. [Интеграции](#7-интеграции)
8. [Инфраструктурные объекты](#8-инфраструктурные-объекты)

---

## Что изменилось по сравнению с архитектурой v1.0.4

Документарные правки ФМ. Архитектура не изменена.

| Область | Что исправлено в ФМ | Влияние на архитектуру |
|---------|---------------------|----------------------|
| Таймаут блокировки | В таблице требований исправлено «15 мин» на «5 мин»  | Нет -- архитектура уже использовала 5 мин |
| Количество P1-требований | В тексте приоритизации исправлено «61» на «64» | Нет -- архитектура уже учитывала 64 |
| Пороги нагрузки 30/50 | Добавлено пояснение разницы: 30 = автоперелив, 50 = назначение | Нет -- два механизма уже описаны в п. 1.5.12 |
| Описание LS-RPT-072 | Обновлено: оба порога (30 и 50) | Нет -- отчет уже содержал оба |
| Условие дефолт-решения | Уточнена формулировка: «на момент наступления дефолт-решения» | Нет -- алгоритм регламентного задания уже корректен |
| Грамматические исправления | 6 грамматических правок в ФМ | Нет |

 Ниже приведено полное описание без изменений.

---


## 1. Архитектура данных

### 1.1. Справочники (каталоги)

#### 1.1.1. ЛокальнаяСмета (расширение существующего документа/справочника)

Центральный объект учета - локальная смета клиента.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Код | Строка(11) | Уникальный идентификатор ЛС |
| Контрагент | СправочникСсылка.Контрагенты | Клиент |
| ДатаСоздания | Дата | Дата создания ЛС |
| ДатаОкончания | Дата | Дата окончания срока действия |
| Статус | ПеречислениеСсылка.СтатусыЛС | Активна / Истекла / Закрыта / Отменена |
| ПлановаяРентабельность | Число(5,2) | Плановая рентабельность (%), зафиксированная при согласовании |
| Менеджер | СправочникСсылка.Пользователи | Ответственный менеджер |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Основной бизнес-юнит |
| СуммаЛС | Число(15,2) | Общая сумма ЛС в рублях |
| КоличествоПродлений | Число(1,0) | Количество выполненных продлений (макс. 2) |
| ДатаФиксацииНПСС | Дата | Дата, на которую зафиксирована НПСС |
| РекомендательныйКонтроль | Булево | Признак рекомендательного контроля при создании ЛС (если плановая рент. < 5%) |

**Табличная часть "Позиции":**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Товар |
| Количество | Число(10,3) | Количество в ЛС |
| Цена | Число(15,2) | Цена позиции |
| Сумма | Число(15,2) | Сумма позиции |
| НПСС | Число(15,2) | Зафиксированная НПСС на момент создания ЛС |
| Рентабельность | Число(5,2) | Рассчитанная рентабельность позиции (%) |
| МинДопустимаяЦена | Число(15,2) | НПСС / (1 - Рент_ЛС_план / 100) |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ позиции (определяется по номенклатуре) |

**Жизненный цикл статусов:**

```
Создание -> [Активна] -> [Истекла] -> [Закрыта]
              |               |
          [Закрыта]    Продление -> [Активна]
              |
          (полная отгрузка)

Создание -> [Активна] -> [Отменена] (0 отгрузок)
```

---

#### 1.1.2. УполномоченныеЛица

Справочник уполномоченных лиц для экстренных согласований.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Код | Строка(9) | Идентификатор |
| ФИО | Строка(150) | ФИО сотрудника |
| Пользователь | СправочникСсылка.Пользователи | Связь с учетной записью 1С |
| УровеньПолномочий | ПеречислениеСсылка.УровниСогласования | Уровень: РБЮ (1-15), ДП (15.01-25), ГД (>25) |
| ДатаНачала | Дата | Дата начала полномочий |
| ДатаОкончания | Дата | Дата окончания (пусто = бессрочно) |
| Активен | Булево | Признак активности (снимается при увольнении/переводе) |
| Заместитель | СправочникСсылка.УполномоченныеЛица | Заместитель при отсутствии |

**Плановая актуализация:** ежемесячно (HR-служба). Интеграция с HR-системой: автоматическое исключение при увольнении/переводе.

---

#### 1.1.3. СтратегическиеКлиенты

Реестр стратегически важных клиентов.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Контрагент | СправочникСсылка.Контрагенты | Клиент |
| КритерийОтнесения | ПеречислениеСсылка.КритерииСтратегичности | (а) оборот >= 10 млн, (б) реестр ДРП, (в) контракт >= 1 млн |
| ДатаВключения | Дата | Дата включения в реестр |
| ОснованиеВключения | Строка(500) | Обоснование |
| ДопустимоеОтклонение | Число(5,2) | Допустимое отклонение от стандартных порогов (п.п.) |
| Ответственный | СправочникСсылка.Пользователи | Кто включил в реестр |
| КоличествоОтменСанкций | Число(2,0) | Количество отмен санкций за текущий год (макс. 3) |

**Актуализация:** ежеквартально, ведет Директор ДРП. Срок включения: 3 р.д. (заявка менеджера -> одобрение ДП).

---

#### 1.1.4. ДежурныеСогласующие

Справочник дежурных согласующих.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Пользователь | СправочникСсылка.Пользователи | Согласующий |
| Роль | ПеречислениеСсылка.РолиСогласующих | РБЮ / Директор ДРП / ДП / ГД |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Для РБЮ - его бизнес-юнит |
| ДатаНачалаДежурства | Дата | Начало дежурства |
| ДатаОкончанияДежурства | Дата | Окончание дежурства |
| Заместитель | СправочникСсылка.Пользователи | Заместитель на период отсутствия |
| ДоступенОнлайн | Булево | Индикатор доступности (синхронизируется из ELMA) |

---

### 1.2. Перечисления

| Имя перечисления | Значения | Описание |
|------------------|----------|----------|
| СтатусыЛС | Активна, Истекла, Закрыта, Отменена | Статусы жизненного цикла ЛС |
| СтатусыЗаказаКонтроль | Черновик, ОжидаетПоступления, НаСогласовании, Отклонен, СоглИстекло, ЧастичноСогласован, Согласован, ВРаботе, Исполнен, ЗакрытЧастично, Просрочен, Отменен | Статусы жизненного цикла Заказа |
| УровниСогласования | РБЮ, ДиректорДРП, ДП, ГД | Уровни цепочки согласования |
| ПриоритетыЗаказа | P1, P2 | P1 (>500 т.р. или экстренные), P2 (стандартные) |
| ТипыСогласования | Стандартное, Экстренное, Постфактум | Тип процедуры согласования |
| РешенияСогласования | Одобрено, Отклонено, СогласованоСКорректировкой, Эскалировано, АвтоОтказ | Решения согласующего |
| ТипыСанкций | Нет, СнижениеСкидки3, СнижениеСкидки10, ТолькоСтандартныеЦены | Типы санкций за невыкуп |
| КритерииСтратегичности | ОборотБолее10Млн, РеестрДРП, КонтрактБолее1Млн | Критерии стратегического клиента |
| РолиСогласующих | РБЮ, ДиректорДРП, ДП, ГД | Роли в процессе согласования |
| ПричиныНезакрытогоОстатка | ОшибкаМенеджера, ИзменениеПотребности, ДефицитКомпании | Классификация причин |
| РеакцияНаВозрастНПСС | БезОграничений, Предупреждение, ТребуетсяПодтверждениеРБЮ, Блокировка | Реакции на возраст НПСС |
| РежимыСогласования | Стандартный, Резервный | Режим работы: обычный (ELMA) или резервный (при недоступности ELMA) |

---

### 1.3. Документы

#### 1.3.1. ЗаказКлиента (расширение существующего документа)

Основной документ контроля рентабельности. Расширяется дополнительными реквизитами.

**Дополнительные реквизиты шапки:**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Привязка к ЛС |
| СтатусКонтроля | ПеречислениеСсылка.СтатусыЗаказаКонтроль | Статус в цепочке согласования |
| РентабельностьЗаказа | Число(5,2) | Рентабельность данного Заказа (%) |
| НакопленнаяПлюсЗаказ | Число(5,2) | (Накопленная + Заказ) (%) |
| РентабельностьОстатка | Число(5,2) | Рентабельность остатка ЛС (%) |
| Отклонение | Число(5,2) | Максимальное отклонение от плана (п.п.) |
| ТребуемыйУровень | ПеречислениеСсылка.УровниСогласования | Кто должен согласовать (или NULL - не требуется) |
| Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | P1 или P2 |
| ОбоснованиеМенеджера | Строка(1000) | Обоснование отклонения (мин. 50 символов) |
| СогласующийФИО | Строка(150) | ФИО текущего согласующего |
| ДатаСогласования | Дата | Дата получения согласования |
| СрокДействияСогласования | Дата | Дата + 5 рабочих дней |
| РешениеСогласования | ПеречислениеСсылка.РешенияСогласования | Решение |
| КомментарийСогласующего | Строка(2000) | Комментарий при отказе/корректировке |
| ТипСогласования | ПеречислениеСсылка.ТипыСогласования | Стандартное / Экстренное / Постфактум |
| ПереданНаСклад | Булево | Точка невозврата (после установки согласование не аннулируется) |
| ДатаПередачиНаСклад | Дата | Дата передачи на склад |
| ИсточникЗаказа | Строка(20) | Ручной / EDI |
| КоличествоАннулирований | Число(2,0) | Счетчик аннулирований (при >= 3 - эскалация на ДП) |
| ДатаСозданияЧерновика | Дата | Для контроля автоудаления (7 дней) |
| НомерИтерацииКорректировки | Число(1,0) | Счетчик итераций корректировки цены (макс. 5) |

**Дополнительные реквизиты табличной части "Товары":**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| НПСС | Число(15,2) | НПСС из ЛС (зафиксированная) |
| РентабельностьПозиции | Число(5,2) | (Цена - НПСС) / Цена * 100 |
| МинДопустимаяЦена | Число(15,2) | Минимальная цена без согласования |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ позиции |
| ПризнакНеликвид | Булево | Товар с признаком "неликвид" и спецценой |
| ОтклонениеОтЦеныЛС | Число(5,2) | Расхождение с ценой в ЛС (%) |

**Жизненный цикл статусов Заказа:**

```
[Черновик] -> [На согласовании] -> [Согласован] -> [В работе] -> [Исполнен]
    |              |                    |                          |
    |              v                    v                          v
    |         [Отклонен]->[Черновик]  [Согл.истекло]->[Черновик]  [Закрыт частично]
    |
    v
[Ожидает поступления] -> [На согласовании]
    |
    v
[Просрочен] (7 дней без действий)

[Отменен] (из Черновик, Отклонен, Согл.истекло)

Мульти-БЮ: [На согласовании] -> [Частично согласован] -> [Согласован]
                                         |
                                    [Черновик] (удалены позиции)

Перекрестный контроль:
[Согласован] -> [На согласовании] (при снижении плана ЛС, если уровень согласования изменился)
```

---

#### 1.3.2. ЗаявкаНаСогласование

Документ для маршрутизации согласования через ELMA.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер заявки |
| Дата | Дата | Дата создания |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Заказ-основание |
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | ЛС |
| Инициатор | СправочникСсылка.Пользователи | Менеджер |
| Отклонение | Число(5,2) | Отклонение от плана (п.п.) |
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | Требуемый уровень |
| Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | P1 / P2 |
| SLAЧасов | Число(3,0) | Время на решение (рабочие часы) |
| ДатаДедлайна | Дата | Дата/время истечения SLA |
| Согласующий | СправочникСсылка.Пользователи | Текущий согласующий |
| Решение | ПеречислениеСсылка.РешенияСогласования | Принятое решение |
| КомментарийСогласующего | Строка(2000) | Комментарий |
| ИсторияМаршрутизации | Строка(5000) | JSON: кому назначалось, когда, решение/таймаут |
| ПовторнаяПодача | Булево | Признак повторной подачи после отклонения |
| НомерПопытки | Число(2,0) | Счетчик попыток |
| РежимСогласования | ПеречислениеСсылка.РежимыСогласования | Стандартный / Резервный |
| ПричинаПерекрестногоКонтроля | Строка(500) | Заполняется при возврате из-за перекрестного контроля |

**Табличная часть "Согласующие" (для мульти-БЮ):**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ |
| Согласующий | СправочникСсылка.Пользователи | РБЮ этого БЮ |
| Решение | ПеречислениеСсылка.РешенияСогласования | Решение РБЮ по его БЮ |
| ДатаРешения | Дата | Когда принял решение |
| Комментарий | Строка(2000) | Комментарий |

---

#### 1.3.3. ЭкстренноеСогласование

Документ фиксации экстренного (внесистемного) согласования.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер документа |
| Дата | Дата | Дата фиксации |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Заказ |
| Менеджер | СправочникСсылка.Пользователи | Инициатор |
| УполномоченноеЛицо | СправочникСсылка.УполномоченныеЛица | Кто разрешил |
| ПричинаЭкстренности | Строка(1000) | Причина (выбор из справочника + свободный текст) |
| ДокументальноеПодтверждение | Строка(500) | Ссылка на скриншот/файл |
| КаналСвязи | Строка(50) | Телефон / Мессенджер / Личное обращение |
| ВремяПолученияРазрешения | Дата | Время устного согласия |
| ПодтвержденоПостфактум | Булево | Подтверждено ли в ELMA (срок 24ч) |
| ДатаПодтверждения | Дата | Дата подтверждения постфактум |
| СтатусПодтверждения | Строка(20) | Ожидает / Подтверждено / Отклонено |
| Инцидент | Булево | Зарегистрирован ли инцидент (при отклонении постфактум) |
| ПроверкаПостфактум24ч | Булево | Прошла ли автоматическая проверка постфактум (24ч) |
| ПроверкаПостфактум48ч | Булево | Прошла ли расширенная проверка (48ч) |

---

#### 1.3.4. ЗакрытиеЛС

Документ инициации закрытия локальной сметы.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер документа |
| Дата | Дата | Дата закрытия |
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Закрываемая ЛС |
| ПричинаЗакрытия | Строка(50) | Полная отгрузка / Истечение срока / Инициатива менеджера / Отмена клиентом |
| НакопленнаяРентабельность | Число(5,2) | Факт. накопленная рент. на момент закрытия |
| ОтклонениеОтПлана | Число(5,2) | Отклонение от плановой рент. (п.п.) |
| ТребуетсяСогласование | Булево | Нужно ли согласование закрытия |
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | Кто согласует |
| Решение | ПеречислениеСсылка.РешенияСогласования | Решение |
| КлассификацияПричин | ПеречислениеСсылка.ПричиныНезакрытогоОстатка | Для KPI менеджера |
| ПроцентВыкупа | Число(5,2) | % выкупа с учетом дефицита |

---

#### 1.3.5. КорректировкаОтгрузки

Документ для аварийных ситуаций - WMS отгрузил до подтверждения.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер |
| Дата | Дата | Дата создания (срок обработки 4 рабочих часа) |
| РТУОснование | ДокументСсылка.РеализацияТоваровУслуг | РТУ-основание |
| ФактическоеКоличество | Число(10,3) | Что реально отгружено |
| РасхождениеСПланом | Строка(500) | Описание расхождения |
| РентабельностьФакт | Число(5,2) | Рент. по факту |
| ТребовалосьСогласование | Булево | Нужно ли было согласование |
| ЗаписьНарушения | Булево | Создана ли запись "Нарушение процедуры" |

---

### 1.4. Регистры накопления

#### 1.4.1. ВыручкаОтгруженного

Хранение факта отгрузок по ЛС для расчета накопленной рентабельности.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Измерение | Заказ |
| Выручка | Число(15,2) | Ресурс | Сумма отгрузки (нетто, с учетом возвратов) |
| СебестоимостьНПСС | Число(15,2) | Ресурс | Себестоимость по НПСС |
| Количество | Число(10,3) | Ресурс | Количество отгруженного |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Реквизит | БЮ позиции |
| ДатаРТУ | Дата | Реквизит | Дата фактической отгрузки |

**Движения:** Приход при проведении РТУ, Расход при возврате товара.

**Ключевые запросы:**
- Накопленная рентабельность по ЛС = SUM(Выручка - СебестоимостьНПСС) / SUM(Выручка) * 100
- Формула (Накопленная + Заказ): в числитель добавляется выручка и себестоимость текущего Заказа

---

#### 1.4.2. РезервыЛС

Учет логических резервов остатка ЛС.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Измерение | Заказ |
| Количество | Число(10,3) | Ресурс | Зарезервированное количество |
| Сумма | Число(15,2) | Ресурс | Сумма резерва |
| СебестоимостьНПСС | Число(15,2) | Ресурс | Себестоимость резерва по НПСС |

---

#### 1.4.3. ОстаткиЛС

Позиционный учет доступных остатков по ЛС.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| Количество | Число(10,3) | Ресурс | Доступное количество |
| Сумма | Число(15,2) | Ресурс | Сумма остатка |
| СебестоимостьНПСС | Число(15,2) | Ресурс | Себестоимость остатка по НПСС |

---

#### 1.4.4. СчетчикЭкстренныхСогласований

Учет лимитов экстренных согласований.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Менеджер | СправочникСсылка.Пользователи | Измерение | Менеджер |
| Контрагент | СправочникСсылка.Контрагенты | Измерение | Клиент |
| Период | Дата | Измерение | Месяц |
| КоличествоПоМенеджеру | Число(2,0) | Ресурс | Счетчик на менеджера (лимит 3, декабрь/август - 5) |
| КоличествоПоКонтрагенту | Число(2,0) | Ресурс | Счетчик на контрагента (лимит 5, пиковые - 8) |

---

#### 1.4.5. ЛимитыАвтосогласования

Учет агрегированных лимитов автосогласования.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Менеджер | СправочникСсылка.Пользователи | Измерение | Менеджер |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Измерение | БЮ |
| Период | Дата | Измерение | День |
| СуммаМенеджер | Число(15,2) | Ресурс | Накопленная сумма автосогласований менеджера за день (лимит 20 000 руб.) |
| СуммаБЮ | Число(15,2) | Ресурс | Накопленная сумма автосогласований по БЮ за день (лимит 100 000 руб.) |

**Движения:** Приход при каждом автосогласовании. Проверка перед автосогласованием: если текущий остаток + сумма заказа > лимит -- направить на стандартное согласование РБЮ.

---

### 1.5. Регистры сведений

#### 1.5.1. НПССПозиций

Справочник нормативной плановой себестоимости. Включает автотриггеры.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| Период | Дата | Период | Дата расчета |
| НПСС | Число(15,2) | Ресурс | Нормативная плановая себестоимость |
| ЗакупочнаяЦена | Число(15,2) | Ресурс | Компонент: закупочная цена |
| Логистика | Число(15,2) | Ресурс | Компонент: логистические затраты |
| НакладныеРасходы | Число(15,2) | Ресурс | Компонент: накладные расходы |
| Ответственный | СправочникСсылка.Пользователи | Реквизит | Кто рассчитал |
| Метод | Строка(50) | Реквизит | Плановый / Временный (последняя закупка * 1.1) |
| ТриггерПересчета | Строка(50) | Реквизит | Плановый / КурсЦБ / ЗакупочнаяЦена / Ручной |

**Периодичность записи:** ежеквартально (плановая), событийная (курс валюты > 5%, смена поставщика).

**Автотриггеры (LS-BR-075):**
- Курс ЦБ РФ (USD/EUR/CNY): изменение > 5% за 7 дней -> автопересчет НПСС
- Закупочная цена: факт отклонения > 15% от НПСС -> пересмотр в течение 5 р.д.

---

#### 1.5.2. РентабельностьЛС

Хранение рассчитанных показателей рентабельности по ЛС.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Период | Дата | Период | Дата расчета |
| ПлановаяРентабельность | Число(5,2) | Ресурс | Плановая рент. (%) |
| НакопленнаяРентабельность | Число(5,2) | Ресурс | Накопленная рент. факт (%) |
| РентабельностьОстатка | Число(5,2) | Ресурс | Рент. неотгруженного остатка (%) |
| СуммаВыручки | Число(15,2) | Ресурс | Суммарная выручка отгруженного |
| СуммаСебестоимости | Число(15,2) | Ресурс | Суммарная себестоимость НПСС |
| ПроцентВыкупа | Число(5,2) | Ресурс | Текущий % выкупа |

---

#### 1.5.3. АктуальностьНПСС

Контроль возраста НПСС для трехуровневой проверки.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ДатаПоследнегоРасчета | Дата | Ресурс | Дата последнего расчета НПСС |
| ВозрастДней | Число(4,0) | Ресурс | Кол-во дней с последнего расчета |
| Статус | ПеречислениеСсылка.РеакцияНаВозрастНПСС | Ресурс | 0-30 / 31-60 / 61-90 / >90 |
| ОтклонениеОтФакта | Число(5,2) | Ресурс | Отклонение НПСС от факт. себестоимости (%) |

---

#### 1.5.4. SLAСогласования

Фиксация метрик SLA для аналитики.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЗаявкаНаСогласование | ДокументСсылка.ЗаявкаНаСогласование | Измерение | Заявка |
| Согласующий | СправочникСсылка.Пользователи | Измерение | Кто согласовывал |
| ДатаНазначения | Дата | Ресурс | Когда назначена задача |
| ДатаРешения | Дата | Ресурс | Когда принято решение |
| SLAЧасов | Число(3,0) | Ресурс | Выделенное время (рабочие часы) |
| ФактВремени | Число(5,2) | Ресурс | Фактическое время (рабочие часы) |
| Просрочен | Булево | Ресурс | SLA нарушен |
| Эскалирован | Булево | Ресурс | Была ли эскалация |
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | Реквизит | Уровень |
| Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | Реквизит | P1 / P2 |

---

#### 1.5.5. НарушенияМенеджеров

Регистр нарушений процедуры.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Менеджер | СправочникСсылка.Пользователи | Измерение | Менеджер |
| Период | Дата | Период | Дата нарушения |
| ТипНарушения | Строка(100) | Ресурс | Отказ_постфактум / Несанкц_отгрузка / Превышение_лимита |
| Документ | ДокументСсылка | Ресурс | Документ-основание (Заказ/РТУ/Экстренное) |
| СуммаУбытка | Число(15,2) | Ресурс | Сумма убытка (руб.) |
| УровеньЭскалации | Строка(50) | Ресурс | Куда эскалировано |
| Статус | Строка(20) | Ресурс | Открыт / Закрыт / Эскалирован |

---

#### 1.5.6. СанкцииКонтрагентов

Регистр действующих санкций за невыкуп.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Контрагент | СправочникСсылка.Контрагенты | Измерение | Клиент |
| Период | Дата | Период | Дата начала санкции |
| ТипСанкции | ПеречислениеСсылка.ТипыСанкций | Ресурс | Тип санкции |
| СнижениеСкидки | Число(5,2) | Ресурс | Снижение максимальной скидки (п.п.) |
| ПричинаЛС | СправочникСсылка.ЛокальнаяСмета | Ресурс | ЛС, ставшая причиной |
| ПроцентВыкупа | Число(5,2) | Ресурс | % выкупа по причинной ЛС |
| ДатаРеабилитации | Дата | Ресурс | Ожидаемая дата реабилитации (6 мес. без нарушений) |
| Суммировано | Число(5,2) | Ресурс | Суммарное снижение скидки (кумулятивно) |
| ОтмененаДП | Булево | Ресурс | Отменена ли решением ДП |
| ОснованиеОтмены | Строка(500) | Ресурс | Причина отмены |

---

#### 1.5.7. ФиксацияПотребности

Регистр фиксации потребности при дефиците.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Измерение | Заказ |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ДатаФиксации | Дата | Ресурс | Когда зафиксирована потребность |
| Количество | Число(10,3) | Ресурс | Запрошенное количество |
| РезультатПроверкиНаличия | Строка(20) | Ресурс | ВНаличии / НетВНаличии / Частично |
| ОжидаемаяДатаПоступления | Дата | Ресурс | Предполагаемая дата поступления |
| ДатаИстеченияОжидания | Дата | Ресурс | Максимум 90 дней от фиксации |
| ПодтвержденныйДефицит | Булево | Ресурс | Признан ли дефицит подтвержденным |
| ДнейНедоступности | Число(3,0) | Ресурс | Кол-во дней непрерывного отсутствия |

---

#### 1.5.8. ИсторияНаличияТовара

Для разрешения споров по дефициту. Хранение: 3 года.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| Склад | СправочникСсылка.Склады | Измерение | Склад |
| Период | Дата | Период | Дата снимка (ежедневно) |
| КоличествоДоступное | Число(10,3) | Ресурс | Доступный остаток |
| ВНаличии | Булево | Ресурс | Есть ли хоть 1 ед. |

---

#### 1.5.9. ЖурналАудитаЛС

Журнал всех изменений плановой рентабельности ЛС. Записи неудаляемые. Хранение: 5 лет.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Период | Дата | Период | Дата изменения |
| Автор | СправочникСсылка.Пользователи | Ресурс | Кто инициировал |
| СтароеЗначение | Число(5,2) | Ресурс | Было (%) |
| НовоеЗначение | Число(5,2) | Ресурс | Стало (%) |
| Причина | Строка(500) | Ресурс | Причина изменения |
| ТипИзменения | Строка(50) | Ресурс | ПересчетНПСС / РучнойЗапрос / Продление / ДобавлениеПозиций |
| Согласование | ДокументСсылка.ЗаявкаНаСогласование | Ресурс | Связанное согласование (если было) |

---

#### 1.5.10. ОчередьРезервногоРежима

Очередь заявок при недоступности ELMA.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЗаявкаНаСогласование | ДокументСсылка.ЗаявкаНаСогласование | Измерение | Заявка |
| ДатаПостановки | Дата | Ресурс | Когда поставлена в очередь |
| Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | Ресурс | P1 / P2 (P1 обрабатывается первым) |
| Отклонение | Число(5,2) | Ресурс | Отклонение от плана (п.п.) |
| Статус | Строка(20) | Ресурс | ВОчереди / Автосогласовано / ОтправленоВЕлму |
| РезультатАвтосогласования | Строка(50) | Ресурс | При откл. до 5 п.п.: автосогласование; свыше: ожидание FIFO |

**Логика резервного режима (ELMA fallback):**
- Отклонение до 5 п.п.: автосогласование без ELMA
- Отклонение свыше 5 п.п.: заявка ставится в очередь FIFO, обрабатывается при восстановлении ELMA
- При восстановлении ELMA: очередь отправляется в ELMA в порядке FIFO (P1 первыми)

---

#### 1.5.11. ИтерацииКорректировкиЦены

Журнал итераций корректировки цены (лимит 5 итераций).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Измерение | Заказ |
| НомерИтерации | Число(1,0) | Измерение | Номер итерации (1-5) |
| ДатаИтерации | Дата | Ресурс | Дата/время корректировки |
| Инициатор | СправочникСсылка.Пользователи | Ресурс | Согласующий, предложивший корректировку |
| ПредложеннаяЦена | Число(15,2) | Ресурс | Новая предложенная цена |
| Результат | Строка(20) | Ресурс | Принято / Отклонено / АвтоОтказ |

**Логика:** При достижении 5-й итерации -- автоматический отказ, Заказ возвращается в Черновик. Менеджер получает уведомление: "Лимит итераций корректировки исчерпан (5 из 5)."

---

#### 1.5.12. НагрузкаСогласующих

Мониторинг нагрузки на согласующих с двумя порогами.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Согласующий | СправочникСсылка.Пользователи | Измерение | Согласующий |
| Период | Дата | Период | День |
| ЗадачВОчереди | Число(3,0) | Ресурс | Текущее количество задач в очереди |
| ЗадачЗаДень | Число(3,0) | Ресурс | Всего задач за день (обработано + в очереди) |
| ПереливАктивен | Булево | Ресурс | Порог 30 превышен -> перелив на заместителя |
| ДопСогласующийНазначен | Булево | Ресурс | Порог 50 превышен -> назначен доп. согласующий |

**Два независимых механизма:**
1. **Перелив (порог 30):** При накоплении более 30 задач в очереди -- автоматическое переключение новых задач на заместителя. Оперативный механизм, срабатывает мгновенно, без участия человека.
2. **Назначение доп. согласующего (порог 50):** При достижении 50 задач за день -- информационный сигнал руководителю о необходимости назначить дополнительного согласующего на плановой основе. Ручное действие.

**Отображение в интерфейсе согласующего:**
```
Виджет: "Нагрузка: 28/30 (перелив) | 42/50 (дневной лимит)"
```

---

## 2. Роли и права

### 2.1. Матрица ролей RBAC

8 ролей: Менеджер, РБЮ, Директор ДРП, ДП, ГД, Финансовая служба, Спец. товарообмена, Администратор.

Полная матрица ролей  (без изменений).

### 2.2. RLS-политики (LS-SEC-001)

Менеджер видит только свой БЮ, РБЮ -- свой БЮ, остальные -- все БЮ. Без изменений.

---

## 3. Бизнес-процессы

### 3.1. Согласование рентабельности (4-уровневый маршрут)

**Лимит итераций корректировки цены:**
```
При решении "Согласовать с корректировкой":
1. Проверить НомерИтерацииКорректировки < 5
2. ЕСЛИ >= 5: автоотказ, Заказ -> Черновик, уведомление менеджеру
3. ЕСЛИ < 5: стандартный цикл корректировки, НомерИтерации + 1
```

**Перекрестный контроль при изменении плана ЛС:**
```
При изменении плановой рентабельности ЛС:
1. Найти все Заказы в статусе "Согласован" (до ПереданНаСклад)
2. Для каждого: пересчитать отклонение по новому плану
3. ЕСЛИ требуемый уровень согласования изменился:
   3.1. Аннулировать согласование
   3.2. Вернуть Заказ на согласование с новым уровнем
   3.3. Уведомить менеджера: "Заказ N возвращен на согласование
        (причина: изменение плана ЛС с X% до Y%).
        Новый уровень: [уровень]. SLA: [SLA]ч."
4. ЕСЛИ уровень не изменился: согласование остается в силе
```

### 3.2. Резервный режим ELMA (при недоступности)

```
ОПРЕДЕЛЕНИЕ НЕДОСТУПНОСТИ ELMA:
- Таймаут подключения 30 сек ИЛИ 3 неудачные попытки подряд
- Регламентное задание МониторингELMA проверяет каждые 5 мин

РЕЗЕРВНЫЙ РЕЖИМ:
1. Отклонение до 5 п.п.: автосогласование без ELMA
   -> запись в ОчередьРезервногоРежима со статусом "Автосогласовано"
   -> уведомление согласующему: "Автосогласовано в резервном режиме"

2. Отклонение свыше 5 п.п.: ожидание в очереди FIFO
   -> запись в ОчередьРезервногоРежима со статусом "ВОчереди"
   -> уведомление менеджеру: "ELMA недоступна. Заявка в очереди,
      будет обработана при восстановлении"
   -> P1 обрабатываются первыми

ВОССТАНОВЛЕНИЕ ELMA:
1. МониторингELMA обнаруживает доступность
2. Очередь отправляется в ELMA: P1 первыми, далее P2 по FIFO
3. Статус заявок обновляется: "ОтправленоВЕлму"
4. Автосогласованные заявки: информирование согласующего для постфактум контроля
```

### 3.3. Автоконтроль постфактум экстренных согласований

```
ПОСЛЕ экстренного согласования:
1. Через 24ч: автоматическая проверка
   -> ПодтвержденоПостфактум = Истина? ОК
   -> ПодтвержденоПостфактум = Ложь? Повторное уведомление

2. Через 48ч: расширенная проверка
   -> Если все еще не подтверждено: эскалация на ДП
   -> Запись в НарушенияМенеджеров
```

### 3.4. Агрегированные лимиты автосогласования

```
При автосогласовании (отклонение < 1 п.п.):
1. Проверить дневной лимит менеджера:
   СуммаМенеджер + СуммаЗаказа <= 20 000 руб.?
2. Проверить дневной лимит БЮ:
   СуммаБЮ + СуммаЗаказа <= 100 000 руб.?
3. ОБА лимита в норме: автосогласование, запись в ЛимитыАвтосогласования
4. ЛЮБОЙ лимит превышен: направить на стандартное согласование РБЮ
   -> уведомление менеджеру: "Дневной лимит автосогласования исчерпан,
      заказ направлен на согласование РБЮ"
```

---

## 4. Фоновые задания (регламентные задания)

### 4.1. Таблица регламентных заданий

| # | Имя | Расписание | Описание | Retry | Timeout | Мониторинг |
|---|-----|-----------|----------|-------|---------|------------|
| 1 | ПересчетСанкций | Ежедневно, 01:00 MSK | Пересчет санкций для закрытых ЛС | 3 x 15 мин | 2 часа | Алерт ФД при сбое |
| 2 | ПроверкаSLA | Каждые 15 мин, 09:00-18:00 MSK | Проверка истечения SLA, автоэскалация | 3 x 1 мин | 5 мин | Лог в журнал |
| 3 | Автоэскалация | Каждые 15 мин, 09:00-18:00 MSK | Переназначение задач вышестоящему | 3 x 1 мин | 5 мин | Уведомление |
| 4 | МониторингНПСС | Ежедневно, 07:00 MSK | Расчет возраста НПСС + автотриггеры LS-BR-075 | 3 x 5 мин | 30 мин | Алерт ФД при >90 дней |
| 5 | АвтоудалениеЧерновиков | Ежедневно, 00:00 MSK | Пометка на удаление черновиков > 7 дней | 3 x 5 мин | 15 мин | Лог в журнал |
| 6 | АннулированиеСогласований | Ежедневно, 00:00 MSK | Аннулирование согласований > 5 р.д. | 3 x 5 мин | 30 мин | Уведомления менеджерам |
| 7 | АвтозакрытиеЛС | Ежедневно, 00:00 MSK | Автозакрытие ЛС с истекшим сроком | 3 x 5 мин | 30 мин | Лог в журнал |
| 8 | ПроверкаРеабилитации | Ежедневно, 02:00 MSK | Проверка 6 мес. без нарушений, снятие санкций | 3 x 5 мин | 15 мин | Лог в журнал |
| 9 | СнимокНаличия | Ежедневно, 23:00 MSK | Запись текущих остатков в ИсторияНаличияТовара | 3 x 10 мин | 1 час | Лог в журнал |
| 10 | ОчисткаБлокировок | Каждые 1 мин | Снятие просроченных блокировок ЛС (>5 мин неактивности) | Не требуется | 30 сек | Лог в журнал |
| 11 | КонтрольЭкстренных | Каждые 30 мин, 09:00-18:00 MSK | Проверка подтверждения экстренных (2ч) + автоконтроль 24ч/48ч | 3 x 1 мин | 5 мин | Уведомление РБЮ |
| 12 | ОповещениеОПоступлении | Каждые 30 мин | Уведомление при поступлении ожидаемого товара | 3 x 5 мин | 15 мин | Лог в журнал |
| 13 | АвтопродлениеЛСПриДефиците | Ежедневно, 06:00 MSK | Автопродление ЛС < 5 р.д. до истечения | 3 x 5 мин | 15 мин | Уведомление менеджеру |
| 14 | СверкаWMS | Ежедневно, 05:00 MSK | Сверочный отчет WMS и 1С:УТ | 3 x 10 мин | 1 час | Алерт руководителю склада |
| 15 | КвартальныйАудитНПСС | 1 раз в квартал | Аудит точности НПСС: выборка 100 SKU | 3 x 15 мин | 2 часа | Отчет ФД |
| 16 | ОчисткаИсторииНаличия | 1 раз в месяц | Удаление записей > 3 лет | 3 x 10 мин | 1 час | Лог в журнал |
| 17 | МониторингELMA | Каждые 5 мин | Проверка доступности ELMA, управление резервным режимом | 3 x 1 мин | 2 мин | Алерт IT при недоступности |
| 18 | ПерекрестныйКонтрольШкал | При изменении плана ЛС (событийный) | Пересчет уровней согласования для согласованных Заказов | 3 x 5 мин | 15 мин | Уведомление менеджеру |
| 19 | КонтрольАвтотриггеровНПСС | Ежедневно, 08:00 MSK | Проверка курса ЦБ (>5% за 7 дней), закупочных цен (>15%) | 3 x 5 мин | 30 мин | Алерт ФС |
| 20 | ОбработкаОчередиРезервногоРежима | Каждые 5 мин (при активном резервном режиме) | Отправка накопленных заявок в ELMA после восстановления | 3 x 1 мин | 5 мин | Лог в журнал |

---

## 5. Ключевые точки контроля

### 5.1. Матрица контролей

| # | Точка контроля | Момент | Тип | Объект | Блокирует? |
|---|---------------|--------|-----|--------|------------|
| 1 | Расчет рентабельности Заказа | ПередЗаписью | Автоматический | ЗаказКлиента | Да - при откл >= 1 п.п. |
| 2 | Проверка возраста НПСС | ПередЗаписью | Автоматический | ЗаказКлиента | Да - при >90 дн |
| 3 | Проверка НПСС=0/NULL | ПередЗаписью | Автоматический | ЗаказКлиента | Да - блокировка позиции |
| 4 | Проверка Цена=0 | ПередЗаписью | Автоматический | ЗаказКлиента | Да - блокировка позиции |
| 5 | Соответствие цен ЛС | ПередЗаписью | Автоматический | ЗаказКлиента | Да - при расхождении >0.01% |
| 6 | Доступный остаток ЛС | При отправке на согласование | Автоматический | ЗаказКлиента | Да - при превышении |
| 7 | Лимит Заказов на согласовании | При отправке на согласование | Автоматический | ЗаказКлиента | Да - при 10+ |
| 8 | Лимит экстренных согласований | При фиксации экстренного | Автоматический | ЭкстренноеСогласование | Да - при превышении 3/5 |
| 9 | ФИО в справочнике уполномоченных | При фиксации экстренного | Автоматический | ЭкстренноеСогласование | Да - при отсутствии |
| 10 | Точка невозврата | При установке ПереданНаСклад | Информационный | ЗаказКлиента | Нет - фиксация |
| 11 | Срок действия согласования | При проведении РТУ | Автоматический | РеализацияТоваровУслуг | Да - при истечении |
| 12 | Соответствие РТУ Заказу | При проведении РТУ | Автоматический | РеализацияТоваровУслуг | Да - при расхождении |
| 13 | Атомарная проверка при РТУ | При проведении РТУ | Автоматический | РеализацияТоваровУслуг | Да - перечитывает регистр |
| 14 | Повторный пересчет | При сохранении Заказа | Автоматический | ЗаказКлиента | Да - при изменении рент. |
| 15 | Контроль B2C убытка | При проведении РТУ B2C | Автоматический | РеализацияТоваровУслуг | Да - при рент. < 0% |
| 16 | Пересчет при возврате | При проведении возврата | Автоматический | ВозвратТоваров | Нет - пересчет + уведомление |
| 17 | Проверка санкций | При создании ЛС | Информационный | ЛокальнаяСмета | Ограничение скидки |
| 18 | Рекомендательный контроль | При создании ЛС (рент. < 5%) | Информационный | ЛокальнаяСмета | Нет - предупреждение |
| 19 | Неликвид + спеццена | При создании Заказа | Автоматический | ЗаказКлиента | Нет - исключение из контроля |
| 20 | Черновик > 7 дней | Регламентное задание | Автоматический | ЗаказКлиента | Удаление |
| 21 | Агрегированный лимит автосогласования | При автосогласовании | Автоматический | ЛимитыАвтосогласования | Да - направление на РБЮ |
| 22 | Лимит итераций корректировки | При корректировке цены | Автоматический | ИтерацииКорректировкиЦены | Да - автоотказ при 5-й |
| 23 | Перекрестный контроль шкал | При изменении плана ЛС | Автоматический | ЗаказКлиента (согласованные) | Да - возврат на согласование |
| 24 | Автотриггер НПСС (курс ЦБ) | Ежедневно | Автоматический | НПССПозиций | Нет - пересчет + уведомление |
| 25 | Автотриггер НПСС (закупочная цена) | При закупке | Автоматический | НПССПозиций | Нет - пересмотр в 5 р.д. |

### 5.2. Детализация контроля при проведении РТУ

```
ПриПроведении(РТУ):
  1. НачатьТранзакцию()
  2. ЗаблокироватьПозицииЛС(ЗаказКлиента.ЛС, 5-10 сек)
  3. ПерепрочитатьНакопленнуюРентабельность()
  4. ПроверитьСрокСогласования() -- 5 рабочих дней
  5. ПроверитьПереданНаСклад() -- точка невозврата
  6. ЕСЛИ рентабельность изменилась:
     6.1 АннулироватьПараллельныеСогласования()
     6.2 УведомитьМенеджеров()
  7. ЗаписатьДвижения(ВыручкаОтгруженного, РезервыЛС, ОстаткиЛС)
  8. ЗавершитьТранзакцию()
  9. СнятьБлокировкуЛС()
```

---

## 6. Потенциальные блокировки

### 6.1. Анализ конкурентного доступа

| # | Сценарий | Объект блокировки | Тип блокировки | Макс. время | Вероятность (50-70 польз.) | Решение |
|---|----------|-------------------|----------------|-------------|---------------------------|---------|
| 1 | Два менеджера создают Заказы по одной ЛС | Запись ЛС (LS-BR-035) | Пессимистичная блокировка | 5 мин | Высокая | Блокировка записи ЛС при создании Заказа. Второй: "ЛС редактируется [ФИО] до [ЧЧ:ММ]". Автоснятие через 5 мин. |
| 2 | Одновременная отправка черновиков | Остаток ЛС (атомарная) | Транзакционная блокировка | 10 сек | Средняя | Атомарная блокировка остатка. Первый "захватывает" долю. |
| 3 | Проведение РТУ параллельно с согласованием | Регистр ВыручкаОтгруженного | Управляемая блокировка | 5-10 сек | Высокая | Блокировка позиций ЛС при проведении РТУ. |
| 4 | Два РБЮ принимают решение по мульти-БЮ | Запись ЗаявкаНаСогласование | Оптимистичная блокировка | Мгновенно | Низкая | Приоритет первому. |
| 5 | Возврат товара во время согласования | Регистры рентабельности | Управляемая блокировка | 30 сек | Низкая | Пауза на пересчет. |
| 6 | Автоудаление черновика во время редактирования | Запись ЗаказКлиента | Проверка при удалении | Мгновенно | Очень низкая | Проверка блокировки. |
| 7 | Изменение плановой рент. ЛС во время согласования | Записи Заказов по ЛС | Каскадная | До 30 сек | Низкая | Аннулирование ВСЕХ при смене уровня. |
| 8 | Перекрестный контроль при изменении плана | Согласованные Заказы по ЛС | Каскадная | До 30 сек | Низкая | Последовательный пересчет, аннулирование при смене уровня |

### 6.2. Стратегия предотвращения взаимных блокировок

```
ПОРЯДОК ЗАХВАТА БЛОКИРОВОК (строгий):
1. ЛокальнаяСмета (запись)
2. ОстаткиЛС (регистр по ЛС)
3. РезервыЛС (регистр по ЛС)
4. ВыручкаОтгруженного (регистр по ЛС)
5. ЗаказКлиента (запись)

Таймаут ожидания блокировки: 30 секунд.
```

### 6.3. Рекомендации по оптимизации (для 50-70 пользователей)

- Расчет рентабельности Заказа (до 500 позиций): <= 2 сек
- Общее время обработки документа: <= 3 сек
- **Индексы:**
  - ВыручкаОтгруженного по (ЛокальнаяСмета, Номенклатура)
  - РезервыЛС по (ЛокальнаяСмета, Номенклатура)
  - ЛимитыАвтосогласования по (Менеджер, Период)
  - НагрузкаСогласующих по (Согласующий, Период)
  - ОчередьРезервногоРежима по (Статус, Приоритет)
- Кеширование: показатели рентабельности ЛС в регистре РентабельностьЛС
- Максимум позиций в ЛС: 1000
- Максимум Заказов на согласовании по ЛС: 50
- Нагрузочное тестирование: обязательно при 70 одновременных пользователях

---

## 7. Интеграции

### 7.1. Интеграция 1С:УТ <-> ELMA (LS-INT-003)

Двустороннее взаимодействие. Поддержка резервного режима.

| Параметр | Значение |
|----------|----------|
| **Направление** | Двустороннее |
| **Протокол** | REST API / SOAP |
| **Формат** | JSON |
| **Таймаут** | 30 сек |
| **Повторные попытки** | 3 |
| **Резервный режим** | До 5 п.п. автосогласование, свыше -- очередь FIFO |

### 7.2. Интеграция 1С:УТ -> WMS (LS-INT-001)

Без изменений. Передача статуса согласования для контроля отгрузки.

### 7.3. Интеграция WMS -> 1С:УТ (LS-INT-002)

Без изменений. Прием факта отгрузки для пересчета рентабельности.

### 7.4. Интеграция с EDI

Без изменений. Прием электронных заказов.

### 7.5. Интеграция с HR-системой

Без изменений. Актуализация справочника уполномоченных лиц.

### 7.6. Интеграция с ЦБ РФ (LS-BR-075)

| Параметр | Значение |
|----------|----------|
| **Направление** | Входящая (ЦБ -> 1С:УТ) |
| **Протокол** | REST API (cbr.ru) |
| **Формат** | XML/JSON |
| **Частота** | Ежедневно (задание КонтрольАвтотриггеровНПСС, 08:00 MSK) |
| **Валюты** | USD, EUR, CNY |
| **Триггер** | Изменение курса > 5% за 7 дней -> автопересчет НПСС |

---

## 8. Инфраструктурные объекты

### 8.1. Подсистемы

| Подсистема | Родитель | Включенные объекты | В командный интерфейс |
|------------|----------|--------------------|-----------------------|
| КонтрольРентабельностиОтгрузок | Продажи | Все объекты расширения | Да |
| АдминистрированиеКонтроляРент | Администрирование | Настройки, блокировки, мониторинг ELMA | Да |

### 8.2. Общие модули

| Имя модуля | Контекст | Вызов сервера | Привилегированный | Повторн. использование | Назначение |
|------------|----------|---------------|--------------------|-----------------------|------------|
| КонтрольРентабельностиСервер | Сервер | Нет | Нет | Нет | Серверная бизнес-логика расчетов |
| КонтрольРентабельностиВызовСервера | Сервер | Да | Нет | Нет | API для клиентских вызовов |
| КонтрольРентабельностиКлиентСервер | КлиентСервер | Нет | Нет | Нет | Общие функции клиента и сервера |
| КонтрольРентабельностиПовтИсп | Сервер | Да | Нет | Да | Кешируемые данные (настройки, константы, лимиты) |
| ИнтеграцияELMAСервер | Сервер | Нет | Нет | Нет | Логика интеграции с ELMA + резервный режим |
| ИнтеграцияWMSСервер | Сервер | Нет | Нет | Нет | Логика интеграции с WMS |

### 8.3. Константы

| Имя | Тип | Значение по умолчанию | Назначение |
|-----|-----|-----------------------|------------|
| ТаймаутБлокировкиЛС | Число(3,0) | 5 | Таймаут пессимистичной блокировки ЛС (минуты) |
| ПорогАвтосогласования | Число(5,2) | 1.00 | Порог автосогласования (п.п.) |
| ЛимитАвтосогласованияМенеджер | Число(15,2) | 20000 | Дневной лимит автосогласования на менеджера (руб.) |
| ЛимитАвтосогласованияБЮ | Число(15,2) | 100000 | Дневной лимит автосогласования на БЮ (руб.) |
| ЛимитИтерацийКорректировки | Число(1,0) | 5 | Макс. итераций корректировки цены |
| ПорогПереливаОчереди | Число(3,0) | 30 | Порог автоперелива задач на заместителя |
| ПорогНазначенияДопСогласующего | Число(3,0) | 50 | Порог для назначения доп. согласующего |
| ПорогELMAFallback | Число(5,2) | 5.00 | Порог автосогласования в резервном режиме (п.п.) |
| ТриггерКурсЦБ | Число(5,2) | 5.00 | Порог изменения курса для пересчета НПСС (%) |
| ТриггерЗакупочнаяЦена | Число(5,2) | 15.00 | Порог отклонения закупочной цены (%) |

### 8.4. Функциональные опции

| Имя | Хранение | Значение по умолчанию | Что включает/отключает |
|-----|----------|-----------------------|------------------------|
| ИспользоватьКонтрольРентабельности | Константа | Истина | Весь блок расчета рентабельности |
| ИспользоватьБлокировкуОтгрузки | Константа | Ложь | Запрет проведения при низкой марже (блокирующий режим) |
| ИспользоватьРезервныйРежимELMA | Константа | Истина | Резервный режим при недоступности ELMA |
| ИспользоватьАгрегированныеЛимиты | Константа | Истина | Дневные лимиты автосогласования |
| ИспользоватьПерекрестныйКонтроль | Константа | Истина | Перекрестный контроль при изменении плана ЛС |
| ИспользоватьАвтотриггерыНПСС | Константа | Истина | Автотриггеры пересчета НПСС |

---


## Приложение B. Перечень отчетов (полный реестр)

| Код | Имя | Периодичность | Получатели | Приоритет |
|-----|-----|---------------|------------|-----------|
| LS-RPT-013 | Накопленная рентабельность по ЛС | По запросу | Менеджер, РБЮ | P1 |
| LS-RPT-038 | Устаревшие НПСС | Еженедельно | Финансовая служба | P1 |
| LS-RPT-043 | Конфликты блокировки ЛС | Еженедельно | Руководство | P1 |
| LS-BR-044 | Сверка WMS-1С | Ежедневно | Руководитель склада | P1 |
| LS-FR-046 | Соблюдение SLA согласования | Еженедельно | ДП, РБЮ | P1 |
| LS-RPT-060 | Неудовлетворенный спрос / Дефицит | Еженедельно/Ежемесячно | Закупки, ДП, ФД | P2 |
| LS-RPT-061 | Регистр санкций клиентов | По запросу | Комм. служба | P2 |
| LS-RPT-063 | Реабилитация санкций | Ежедневно (фон) | Менеджер (уведомление) | P2 |
| LS-RPT-064 | Качество ЛС по менеджерам | Ежемесячно | ДП, РБЮ | P2 |
| LS-RPT-065 | Продажи неликвида | Ежемесячно | ДП, РБЮ | P2 |
| LS-RPT-066 | Портфельная маржа по клиенту | Ежемесячно | ДП, ФД, РБЮ | P2 |
| LS-RPT-067 | Потери из-за согласований | Ежемесячно | ДП, ФД | P2 |
| LS-RPT-068 | Клиенты с низким выкупом | Еженедельно | Менеджеры, РБЮ | P1 (перенесен из P2) |
| LS-RPT-070 | Дашборд эффективности контроля | Ежедневно | ФД | P1 |
| LS-RPT-072 | Нагрузка согласующих | Еженедельно | ДП, РБЮ | P1 |
| LS-RPT-073 | Базовый замер KPI (пилот) | Перед пилотом | Рабочая группа | P1 |
| LS-RPT-074 | Промежуточный отчет пилота | Через 1 мес. пилота | Рабочая группа | P1 |

LS-RPT-072 содержит оба порога: 30 задач (автоперелив на заместителя) и 50 задач/день (назначение дополнительного согласующего).

---

## Приложение C. Нефункциональные ограничения

| Код | Требование | Значение | Примечание |
|-----|-----------|----------|------------|
| LS-NFR-001 | Время расчета рентабельности | <= 2 сек (до 500 позиций) | Индексы + кеш в регистре |
| LS-NFR-002 | Макс. позиций в ЛС | 1000 | Предупреждение: разбить |
| LS-NFR-003 | Макс. Заказов на согласовании по ЛС | 50 | Очередь с приоритизацией |
| LS-NFR-004 | SLA интеграции WMS | <= 30 сек | Автоуведомление оператору |
| - | Одновременных пользователей | 50-70 | Обязательное нагрузочное тестирование |
| - | Хранение журнала аудита ЛС | 5 лет | Неудаляемые записи |
| - | Хранение истории наличия | 3 года | Очистка регламентным заданием |
| - | Блокировка ЛС | 5 мин таймаут | Автоснятие |
| - | Ожидание получения блокировки | 30 сек | Сообщение пользователю |
| - | Время переключения на резервный режим ELMA | <= 5 мин | Определяется МониторингELMA |

---


# SE-ревью: ТЗ v3.0 и Архитектура v3.0 (FM-LS-PROFIT v1.0.5)

**Дата:** 26.02.2026
**Автор:** Шаховский А.С.
**Платформа:** 1С:УТ 10.2 на платформе 8.3, обычные формы
**Объем:** ТЗ v3.0 (712 строк, 53K), Архитектура v3.0 (1413 строк, 118K)

---

## Вердикт: APPROVED WITH CONDITIONS

Документы в целом корректно учитывают специфику платформы 1С:УТ 10.2 (обычные формы, толстый клиент). Событийная модель, модальные вызовы, общие модули, механизм уведомлений -- описаны верно. Однако выявлено **4 CRITICAL**, **5 HIGH**, **6 MEDIUM** и **3 LOW** замечаний, из которых CRITICAL требуют устранения до начала разработки.

---

## СЕКЦИЯ 1: Architecture Review

### [CRITICAL] ARC-001. ЭлементыФормы.Вставить() не существует в обычных формах

**Описание:** В разделе 0.2 архитектуры и в разделе 8.5.1 используется конструкция `ЭлементыФормы.Вставить("Имя", Тип("ГруппаФормы"))` для программного добавления элементов на обычную форму. Этот метод **не существует** в платформе 1С:Предприятие 8.3 для обычных форм.

В обычных формах коллекция `ЭлементыФормы` -- это **не массив**, а набор элементов, определенных в конфигураторе. Метод `Вставить()` не поддерживается. Программно добавить группу, надпись или кнопку на обычную форму нельзя -- все элементы создаются только в конфигураторе.

**Почему важно:** Это фундаментальная ошибка архитектуры. Весь механизм расширения форм (информационная панель, кнопки, надписи) построен на несуществующем API. При попытке реализации разработчики столкнутся с невозможностью выполнить проект так, как описано.

**Код из документа (НЕРАБОТАЮЩИЙ):**
```1c
// НЕ РАБОТАЕТ в обычных формах!
ГруппаРент = ЭлементыФормы.Вставить("ГруппаРентабельность", Тип("ГруппаФормы"));
НадписьРент = ЭлементыФормы.Вставить("НадписьРентабельность", Тип("Надпись"));
КнопкаРасчет = ЭлементыФормы.Вставить("КнопкаПересчитать", Тип("Кнопка"));
```

**Варианты решения:**

| Вариант | Трудоемкость | Риск | Влияние | Поддержка |
|---------|-------------|------|---------|-----------|
| А: Создать все элементы в конфигураторе расширения, управлять видимостью программно | Низкая | Низкий | Высокое | Низкая |
| Б: Использовать внешнюю обработку (.epf) с собственной формой вместо расширения формы | Средняя | Средний | Среднее | Средняя |
| В: Ничего не менять | -- | -- | -- | Проект невыполним |

**Рекомендация:** Вариант А. В расширении (.cfe) на платформе 8.3 можно добавить собственную форму документа, в которой все нужные элементы (группы, надписи, кнопки) создаются в конфигураторе расширения. Программно управляется только видимость, заголовки надписей и цвета:

```1c
// ПРАВИЛЬНЫЙ подход для обычных форм в расширении:
// 1. В конфигураторе расширения: создать форму с ЗАРАНЕЕ размещенными элементами
//    (ГруппаРентабельность, НадписьРентЗаказа, КнопкаОтправить и т.д.)
// 2. В модуле формы расширения:

Процедура ПриОткрытии()
  // Управлять ВИДИМОСТЬЮ заранее созданных элементов
  ЭлементыФормы.ГруппаРентабельность.Видимость = ЗначениеЗаполнено(Объект.ЛокальнаяСмета);

  // Обновлять ЗАГОЛОВКИ надписей
  ЭлементыФормы.НадписьРентЗаказа.Заголовок = "Рентабельность: " + Формат(РентЗаказа, "ЧДЦ=2") + "%";

  // Подключать обработчик ожидания
  ПодключитьОбработчикОжидания("КР_ОбновитьТаймер", 60);
КонецПроцедуры
```

**Уточнение для расширения типовых форм:** Расширение может либо (а) использовать механизм `&После("ПриОткрытии")` для перехвата обработчика типовой формы -- но добавить элементы на типовую форму из кода расширения все равно нельзя; либо (б) полностью заменить форму документа через расширение -- тогда элементы создаются в конфигураторе формы расширения. Вариант (б) предпочтителен, но имеет риск конфликта при обновлении типовой конфигурации (что в случае УТ 10.2 неактуально -- обновлений от вендора не будет).

---

### [CRITICAL] ARC-002. Регистр накопления ЛимитыАвтосогласования -- некорректная структура

**Описание:** В ТЗ (раздел 2.2.2) и архитектуре (раздел 1.4.5) описан регистр накопления `ЛимитыАвтосогласования` с полем `Период` как **измерением** типа `Дата`. В регистрах накопления период -- это стандартный реквизит, он не может быть измерением. Кроме того, описаны два ресурса `СуммаМенеджер` и `СуммаБЮ` в одном регистре, хотя по бизнес-логике это два независимых контроля (один по менеджеру, другой по БЮ).

**Почему важно:** Некорректная структура регистра приведет к неправильным остаткам и невозможности корректно проверять лимиты. Регистр накопления с "Период" в измерениях -- ошибка проектирования.

**Варианты решения:**

| Вариант | Трудоемкость | Риск | Влияние | Поддержка |
|---------|-------------|------|---------|-----------|
| А: Использовать регистр накопления с правильной структурой (Менеджер + БЮ как измерения, период через регистратор) | Низкая | Низкий | Высокое | Низкая |
| Б: Заменить на регистр сведений с периодичностью "День" | Низкая | Низкий | Высокое | Низкая |
| В: Ничего не менять | -- | -- | -- | Неработающий контроль лимитов |

**Рекомендация:** Вариант А. Правильная структура:

```
Регистр накопления "ЛимитыАвтосогласования" (тип: Остатки)
  Измерения:
    - Менеджер (СправочникСсылка.Пользователи)
    - БизнесЮнит (СправочникСсылка.БизнесЮниты)
  Ресурсы:
    - Сумма (Число(15,2))
  Регистратор: Документ.ЗаказКлиента

  // Период -- стандартный реквизит, устанавливается платформой через регистратор
  // Для запроса "остатки за сегодня" используется:
  Запрос.Текст = "ВЫБРАТЬ
    |  ЛимитыАвтосогласованияОстатки.Менеджер,
    |  ЛимитыАвтосогласованияОстатки.Сумма
    |ИЗ РегистрНакопления.ЛимитыАвтосогласования.Остатки(
    |  &КонецДня,
    |  Менеджер = &Менеджер) КАК ЛимитыАвтосогласованияОстатки";
```

Альтернативно (Вариант Б): использовать регистр сведений с периодичностью "День" и вручную суммировать записи за текущий день. Это проще, но менее производительно при большом количестве записей.

Отдельно: ресурс `СуммаБЮ` дублирует измерение `БизнесЮнит` -- лимит по БЮ вычисляется как SUM(Сумма) по всем менеджерам одного БЮ. Два отдельных ресурса не нужны.

---

### [CRITICAL] ARC-003. Регистр сведений НагрузкаСогласующих -- поля ПереливАктивен и ДопСогласующийНазначен как "Ресурсы"

**Описание:** В архитектуре (раздел 1.5.12) и ТЗ (раздел 2.2.3) регистр сведений `НагрузкаСогласующих` содержит булевы поля `ПереливАктивен` и `ДопСогласующийНазначен` как **ресурсы**. Регистры сведений не имеют понятия "ресурс" -- у них есть измерения, реквизиты и период. Термин "ресурс" применим только к регистрам накопления.

Кроме того, хранить оперативное состояние (количество задач в очереди, флаги перелива) в регистре сведений с периодичностью "День" -- архитектурная ошибка. Такие данные должны вычисляться запросом к регистру заявок на согласование, а не дублироваться в отдельном регистре.

**Почему важно:** Дублирование данных приводит к рассинхронизации. Если запись в регистр `НагрузкаСогласующих` по какой-то причине не произойдет (ошибка, конкурентная запись), фактическое количество задач будет отличаться от значения в регистре.

**Варианты решения:**

| Вариант | Трудоемкость | Риск | Влияние | Поддержка |
|---------|-------------|------|---------|-----------|
| А: Вычислять нагрузку запросом к заявкам на согласование, регистр для истории | Средняя | Низкий | Высокое | Низкая |
| Б: Оставить регистр, но исправить терминологию (ресурсы -> реквизиты) и добавить механизм синхронизации | Низкая | Средний | Среднее | Средняя |
| В: Ничего не менять | -- | -- | -- | Рассинхронизация данных |

**Рекомендация:** Вариант А. Текущее количество задач вычислять запросом:

```1c
Функция ПолучитьНагрузкуСогласующего(Согласующий) Экспорт
  Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ
    |  КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ЗаявкаНаСогласование.Ссылка) КАК ЗадачВОчереди
    |ИЗ Документ.ЗаявкаНаСогласование КАК ЗаявкаНаСогласование
    |ГДЕ ЗаявкаНаСогласование.Согласующий = &Согласующий
    |  И ЗаявкаНаСогласование.Решение = ЗНАЧЕНИЕ(Перечисление.РешенияСогласования.ПустаяСсылка)";
  Запрос.УстановитьПараметр("Согласующий", Согласующий);
  Выборка = Запрос.Выполнить().Выбрать();
  Если Выборка.Следующий() Тогда
    Возврат Выборка.ЗадачВОчереди;
  КонецЕсли;
  Возврат 0;
КонецФункции
```

Регистр `НагрузкаСогласующих` при этом использовать для **истории** (архивные данные за прошлые дни для отчета LS-RPT-072), но не для оперативных решений по переливу.

---

### [CRITICAL] ARC-004. ОчередьРезервногоРежима -- регистр сведений с полем "Статус" как Строка(20)

**Описание:** Регистр сведений `ОчередьРезервногоРежима` (раздел 1.5.10 архитектуры, раздел 2.2.4 ТЗ) использует `Статус` типа `Строка(20)` со значениями "ВОчереди / Автосогласовано / ОтправленоВЕлму". Использование строковых литералов для статусов -- нарушение стандартов 1С. Это приводит к ошибкам при опечатках, невозможности использования в запросах с ЗНАЧЕНИЕ(), затрудняет локализацию.

Аналогичная проблема в регистрах: `НарушенияМенеджеров` (поле Статус: Строка(20)), `ФиксацияПотребности` (поле РезультатПроверкиНаличия: Строка(20)), `ЭкстренноеСогласование` (поле СтатусПодтверждения: Строка(20)), `ИтерацииКорректировкиЦены` (поле Результат: Строка(20)).

**Почему важно:** Строковые статусы -- источник трудноуловимых ошибок. Опечатка в одном месте ("ВОчереде" вместо "ВОчереди") приводит к потере заявки. Перечисления обеспечивают контроль на уровне платформы.

**Варианты решения:**

| Вариант | Трудоемкость | Риск | Влияние | Поддержка |
|---------|-------------|------|---------|-----------|
| А: Заменить все строковые статусы на перечисления | Низкая | Низкий | Высокое | Низкая |
| Б: Ничего не менять | -- | -- | -- | Ошибки при сравнении строк |

**Рекомендация:** Вариант А. Создать перечисления:
- `СтатусыОчередиРезервногоРежима`: ВОчереди, Автосогласовано, ОтправленоВЕлму
- `СтатусыНарушений`: Открыт, Закрыт, Эскалирован
- `РезультатыПроверкиНаличия`: ВНаличии, НетВНаличии, Частично
- `СтатусыПодтверждения`: Ожидает, Подтверждено, Отклонено
- `РезультатыКорректировки`: Принято, Отклонено, АвтоОтказ

Это добавит 5 перечислений (11 -- было, 16 -- стало), но исключит целый класс ошибок.

---

### [HIGH] ARC-005. Расширение типовой формы ЗаказКлиента через &После("ПриОткрытии") -- невозможно добавить элементы

**Описание:** В разделе 8.5.1 архитектуры описан перехват `&После("ПриОткрытии")` с добавлением элементов на форму. Как указано в ARC-001, программное добавление элементов невозможно. Но даже если бы это было возможно -- перехват `&После` для обработчика `ПриОткрытии` обычной формы **работает**, но с ограничениями: расширение не может модифицировать структуру формы, только читать/писать свойства существующих элементов.

**Почему важно:** Если выбрать подход "полная замена формы через расширение" (рекомендация из ARC-001), то перехват &После не нужен -- используется собственная форма расширения. Если же оставить типовую форму и перехватить обработчик -- можно управлять только видимостью и свойствами элементов, которые уже есть в конфигураторе типовой формы (т.е. элементы расширения не добавятся).

**Варианты решения:**

| Вариант | Трудоемкость | Риск | Влияние | Поддержка |
|---------|-------------|------|---------|-----------|
| А: Полная замена формы ЗаказКлиента через расширение (все элементы в конфигураторе формы расширения) | Средняя | Низкий (УТ 10.2 не обновляется) | Высокое | Низкая |
| Б: Отдельная обработка-сателлит с собственной формой, вызываемая из перехваченного ПриОткрытии | Средняя | Средний | Среднее | Средняя |
| В: Ничего не менять | -- | -- | -- | Проект невыполним в этой части |

**Рекомендация:** Вариант А. Поскольку УТ 10.2 больше не обновляется вендором, риск конфликта при замене формы через расширение практически нулевой. Это самый чистый подход: все элементы (и типовые, и новые) описываются в форме расширения, обработчики -- в модуле формы расширения.

---

### [HIGH] ARC-006. ПодключитьОбработчикОжидания -- корректность для обычных форм подтверждена, но таймер на 60 сек при 70 сеансах создает нагрузку

**Описание:** `ПодключитьОбработчикОжидания` действительно работает на обычных формах платформы 8.3. Однако каждый вызов обработчика ожидания в обычном приложении -- это серверный вызов (в обычных формах нет клиентского контекста). При 70 одновременных сеансах и таймере в 60 секунд это создает 70 серверных вызовов в минуту только от таймеров.

На форме согласующего (раздел 8.5.2) таймер обновляет надписи нагрузки и SLA. На форме Заказа -- обратный отсчет SLA. Если открыты 10 форм согласующих + 30 форм Заказов -- это 40 серверных вызовов каждые 60 секунд, плюс в каждом вызове выполняются запросы к базе.

**Почему важно:** В обычном приложении **каждый** вызов обработчика ожидания отнимает серверное соединение. При 70 одновременных толстых клиентах это может привести к конкуренции за соединения и замедлению работы.

**Варианты решения:**

| Вариант | Трудоемкость | Риск | Влияние | Поддержка |
|---------|-------------|------|---------|-----------|
| А: Увеличить интервал таймера до 120-180 сек, кешировать результаты | Низкая | Низкий | Среднее | Низкая |
| Б: Использовать "ленивое" обновление -- таймер только при активной форме | Средняя | Низкий | Высокое | Средняя |
| В: Ничего не менять | -- | -- | -- | Деградация производительности |

**Рекомендация:** Комбинация А + Б. Увеличить интервал до 120 сек (SLA измеряется часами, минутная точность избыточна). Проверять активность формы перед выполнением запросов:

```1c
Процедура КР_ОбновитьТаймерSLA()
  // Проверить, что форма активна (не свернута)
  Если НЕ ЭтаФорма.ТекущийЭлемент = Неопределено Тогда
    // Обновлять только если прошло >= 120 сек
    ОстатокМинут = КонтрольРентабельностиПовтИсп.РассчитатьОстатокSLA(
      ТекущаяЗаявкаСсылка);
    ЭлементыФормы.НадписьSLA.Заголовок = "До истечения SLA: "
      + Формат(ОстатокМинут, "ЧГ=0") + " мин";
  КонецЕсли;
КонецПроцедуры
```

---

### [HIGH] ARC-007. Привилегированный модуль -- нет описания RLS bypass и аудита использования

**Описание:** В архитектуре (раздел 8.2) описан модуль `КонтрольРентабельностиПривилегированный` с флагом "Привилегированный = Истина" для записи в журнал аудита ЛС. Привилегированный модуль обходит RLS и все проверки прав. Однако в документации не описано:
1. Какие именно операции выполняются из привилегированного модуля (только журнал аудита или что-то еще?).
2. Как контролируется, что привилегированный модуль не используется для обхода бизнес-логики.
3. Журналирование вызовов привилегированного модуля.

**Почему важно:** Привилегированный модуль -- потенциальная точка обхода системы безопасности. Без явного контроля разработчик может добавить в него операции, не требующие привилегированного режима, расширив поверхность атаки.

**Рекомендация:** Добавить в архитектуру:
1. Явный перечень операций привилегированного модуля (только: запись в ЖурналАудитаЛС, чтение данных для RLS-ограниченных отчетов).
2. Запрет на добавление новых экспортных функций без код-ревью.
3. Логирование каждого вызова через `ЗаписьЖурналаРегистрации()`.

---

### [HIGH] ARC-008. Общие модули: КонтрольРентабельностиГлобальный -- неверная характеристика

**Описание:** В разделе 8.2 архитектуры модуль `КонтрольРентабельностиГлобальный` описан с флагами "Контекст = Сервер, Глобальный = Да". В документации сказано: "В обычном приложении модуль формы может вызывать только глобальные модули". Это **неточно**.

В обычном приложении 1С весь код выполняется на сервере, поэтому из модуля обычной формы можно вызывать **любые** серверные модули напрямую (не только глобальные). Флаг "Глобальный" в контексте обычных форм означает, что модуль доступен в глобальном контексте приложения (т.е. вызывается без указания имени модуля), а не то, что без этого флага вызов невозможен.

**Почему важно:** Если разработчики поверят, что из обычных форм можно вызывать только глобальные модули, они будут делать все модули глобальными, что засорит глобальный контекст и может привести к конфликтам имен.

**Рекомендация:** Исправить описание:
- Из модуля обычной формы можно вызывать серверные модули напрямую: `КонтрольРентабельностиСервер.РассчитатьРентабельность(...)`.
- Глобальные модули нужны **только** если требуется вызов из контекста, где нет явной ссылки на модуль (например, из выражений отборов, обработки заполнения).
- Рекомендация: основную логику держать в серверном модуле (не глобальном), глобальный использовать минимально -- для "обёрточных" функций, если они действительно нужны в глобальном контексте.

---

### [HIGH] ARC-009. Отсутствует механизм сброса кеша при изменении констант

**Описание:** Модуль `КонтрольРентабельностиПовтИсп` описан с флагом "Повторное использование = На время сеанса". В описании сказано: "Сброс кеша -- при изменении констант". Однако механизм сброса не описан.

В 1С:Предприятие 8.3 для модулей с повторным использованием "на время сеанса" нет штатного механизма автоматического сброса кеша при изменении данных. Если администратор изменит, например, `ЛимитАвтосогласованияМенеджер` с 20000 на 30000, все активные сеансы (до 70) продолжат использовать старое значение 20000 до конца сеанса.

**Почему важно:** Без явного сброса кеша изменение настроек не вступит в силу, пока все пользователи не перезапустят 1С. При 70 одновременных пользователях это может занять часы. В это время одни пользователи работают со старыми лимитами, другие -- с новыми.

**Варианты решения:**

| Вариант | Трудоемкость | Риск | Влияние | Поддержка |
|---------|-------------|------|---------|-----------|
| А: Использовать "На время вызова" вместо "На время сеанса" | Низкая | Низкий | Среднее (чаще запросы к БД) | Низкая |
| Б: Добавить в подписку на запись констант вызов ОбновитьПовторноИспользуемыеЗначения() | Средняя | Низкий | Высокое | Средняя |
| В: Ничего не менять | -- | -- | -- | Устаревшие настройки в кеше |

**Рекомендация:** Вариант Б. Добавить подписку на событие "ПриЗаписи" констант (ТаймаутБлокировкиЛС, ЛимитАвтосогласованияМенеджер, и т.д.), которая вызывает `ОбновитьПовторноИспользуемыеЗначения()`. Это штатный способ сброса кеша в 1С:Предприятие 8.3. Однако нужно учитывать: `ОбновитьПовторноИспользуемыеЗначения()` сбрасывает кеш только в текущем сеансе. Для сброса во всех сеансах необходим механизм с использованием общего ресурса (например, запись даты изменения настроек в регистр сведений и проверка при каждом обращении к кешу).

---

## СЕКЦИЯ 2: Code Quality Review / Estimate Review

### [MEDIUM] EST-001. Коэффициент +20% на справочники заниженный, +50% на обработки -- адекватный

**Описание:** В ТЗ (раздел 7.2) коэффициент платформы для справочников -- +20% с пояснением "нет форм-специфики". Однако 2 справочника из 6 (`ЛокальнаяСмета` с табличной частью "Позиции" и `СтратегическиеКлиенты`) имеют формы, которые также необходимо создавать в расширении. Для них коэффициент должен быть +40% (как для документов с формами).

Коэффициент +50% на обработки (рабочие места) -- адекватный, поскольку это полностью новые обычные формы с нуля.

**Почему важно:** Занижение оценки на справочники с формами приведет к перерасходу бюджета. Разница: 2 справочника x 20ч базовых x (40% - 20%) = 8ч. Некритично, но принцип важен -- все объекты с обычными формами должны иметь коэффициент +40%.

**Рекомендация:** Разделить справочники на две группы: без форм (+10%, аналогично регистрам) и с формами (+40%, аналогично документам). Пересчитать: 144ч -> ~152ч (+8ч).

---

### [MEDIUM] EST-002. Тестирование +35% -- реалистично, но занижено для полного ручного регресса

**Описание:** В ТЗ (раздел 7.3) тестирование оценено в 35% от разработки = 749ч. При 72 тест-кейсах и полностью ручном тестировании это дает примерно 10.4ч на тест-кейс (с учетом подготовки данных, выполнения, документирования).

10.4ч на тест-кейс -- адекватно для первичного тестирования. Однако в ТЗ не учтена стоимость **регрессионного тестирования** при каждом обновлении расширения. Раздел 9.2 (риски) упоминает "2-3 дня ручной работы тестировщика" при каждом обновлении, но эта стоимость не включена в оценку.

**Почему важно:** Если планируется 3-4 обновления расширения в течение проекта (MVP + hotfixes), регрессионное тестирование добавит 6-12 рабочих дней (48-96ч), что не учтено.

**Рекомендация:** Добавить в оценку P1 строку "Регрессионное тестирование (3 цикла x 24ч)" = +72ч. Итого тестирование: 749 + 72 = 821ч.

---

### [MEDIUM] EST-003. Трудоемкость 3675ч: общая оценка адекватна, но буфер 15% мал для устаревшей платформы

**Описание:** Итоговая оценка 3675ч при средневзвешенном коэффициенте +35% на ограничения платформы -- обоснована и прозрачна. Детализация по категориям объектов корректна. Однако буфер рисков 15% (479ч) может быть недостаточен с учетом:
1. Прекращение поддержки платформы (ошибки в типовом коде -- обход силами команды).
2. Нехватка специалистов (время на поиск + адаптацию).
3. Обычные формы -- редко используемая технология, мало документации и примеров.

**Почему важно:** При высоком риске нехватки специалистов (оценка "Высокая" в ТЗ) и факте прекращения поддержки, 15% -- это буфер для "обычного" проекта. Для проекта на устаревшей платформе рекомендуется 20-25%.

**Рекомендация:** Увеличить буфер рисков до 20%. Итого: 3196 x 1.20 = 3835ч (+160ч к текущей оценке). Это даст запас на непредвиденные обходы ошибок типовой конфигурации.

---

### [MEDIUM] EST-004. Команда: 3 разработчика 1С с опытом обычных форм -- риск в доступности

**Описание:** ТЗ (раздел 7.4) требует "3 разработчика 1С (опыт обычных форм!)". Рынок разработчиков 1С с опытом обычных форм УТ 10.2 крайне узкий. Большинство специалистов последние 5-7 лет работали исключительно с управляемыми формами (УТ 11.x, ERP, КА).

**Почему важно:** Время на поиск и найм 3 специалистов может составить 1-2 месяца, что сдвинет старт проекта. Стоимость таких специалистов на 20-30% выше (указано в ТЗ), но сама доступность -- под вопросом.

**Рекомендация:** Предусмотреть план Б:
1. Набрать 2 разработчика с опытом обычных форм + 1 разработчика с опытом управляемых форм (с 2-4 неделями адаптации).
2. Заложить 2-4 недели на адаптацию третьего разработчика (уже учтено в ТЗ как "+2-4 недели", но не отражено в часах).
3. Рассмотреть привлечение внешнего эксперта по обычным формам для ревью первых итераций.

---

### [MEDIUM] EST-005. xUnitFor1C для серверной логики -- корректный выбор, но ограничения не описаны

**Описание:** В ТЗ (разделы 7.1, 8.1) и архитектуре корректно указано, что xUnitFor1C используется для тестирования серверной логики (регистры, подписки, расчеты), а UI тестируется вручную. Однако не описаны ограничения xUnitFor1C в контексте расширений:
1. xUnitFor1C запускается как внешняя обработка. Для тестирования кода расширения необходимо, чтобы расширение было установлено в базу.
2. Тестирование подписок на события требует проведения документов -- это интеграционные тесты, не юнит-тесты.
3. Нет описания организации тестовых данных (фикстуры, очистка после тестов).

**Почему важно:** Без явного описания стратегии тестирования через xUnitFor1C команда будет изобретать подход в процессе, теряя время.

**Рекомендация:** Добавить в ТЗ раздел "Стратегия автоматического тестирования":
- Юнит-тесты (xUnitFor1C): расчет рентабельности, проверки лимитов, валидация данных.
- Интеграционные тесты (xUnitFor1C): проведение документов, проверка движений регистров.
- Подготовка данных: описать механизм создания тестовых фикстур и очистки после тестов.
- Запуск: описать как запускать тесты (внешняя обработка, CLI, CI).

---

### [MEDIUM] EST-006. В описании кода используется "ТекущаяДата()" для работы со временем

**Описание:** В нескольких местах ТЗ и архитектуры для работы с временем блокировки используется `ТекущаяДата()`:

```1c
Запись.ВремяБлокировки = ТекущаяДата();
Запись.ВремяИстечения = ТекущаяДата() + 5 * 60; // 5 минут
```

`ТекущаяДата()` в 1С:Предприятие 8.3 возвращает дату/время **сервера приложений**. Если сервер приложений находится в другом часовом поясе относительно пользователей, время блокировки будет некорректным. Кроме того, два вызова `ТекущаяДата()` в разных строках могут вернуть разное значение (если между ними прошла секунда).

**Почему важно:** Некорректное время блокировки может привести к тому, что блокировка снимается раньше или позже 5 минут.

**Рекомендация:** Использовать единый вызов в переменную:

```1c
ТекущееВремя = ТекущаяДата();
Запись.ВремяБлокировки = ТекущееВремя;
Запись.ВремяИстечения = ТекущееВремя + 5 * 60;
```

И добавить в архитектуру явное указание: "Все операции со временем используют серверное время (`ТекущаяДата()`). Часовой пояс сервера приложений должен совпадать с рабочим часовым поясом пользователей (MSK)".

---

## СЕКЦИЯ 3: Специфика УТ 10.2 и расширений

### [HIGH] UT10-001. Добавление новых регистров через расширение -- ограничения

**Описание:** Архитектура предполагает создание 5 регистров накопления и 13 регистров сведений через расширение (.cfe). На платформе 8.3 добавление **новых** объектов метаданных через расширение поддерживается, начиная с определенных версий платформы. В ТЗ (раздел 2.1) указан "Режим совместимости: Версия 8.3.22+".

На платформе 8.3.22 и выше добавление новых справочников, документов, регистров, обработок через расширение поддерживается. Однако необходимо уточнить:
1. Точную минорную версию платформы 8.3, установленную у заказчика.
2. Какие типы объектов метаданных поддерживаются в расширениях конкретной версии.
3. Поддерживаются ли регистры накопления как **новые** объекты расширения (не расширение существующих).

**Почему важно:** Если установленная версия платформы ниже 8.3.22, часть объектов невозможно добавить через расширение. В этом случае потребуется либо обновление платформы, либо изменение подхода (внесение объектов в конфигурацию напрямую).

**Рекомендация:**
1. До начала разработки: запросить точную версию платформы 8.3 у заказчика (команда `ВерсияПлатформы()` в конфигураторе).
2. Провести технический PoC (proof of concept): создать тестовое расширение с 1 справочником, 1 документом, 1 регистром накопления, 1 регистром сведений и убедиться, что все работают на конкретной версии платформы заказчика.
3. Зафиксировать минимальную версию платформы в ТЗ: "Платформа 8.3.22+ (проверено: [конкретная версия])".

---

### [LOW] UT10-002. Конфликт с типовыми подписками на события ЗаказКлиента

**Описание:** В УТ 10.2 типовая конфигурация содержит подписки на события для документа ЗаказКлиента (проведение, заполнение, проверка заполнения). Расширение добавляет собственные подписки (перехват ПередЗаписью, ОбработкаПроведения). На платформе 8.3 подписки расширения выполняются **после** типовых подписок (для &После) или **перед** (для &Перед).

Потенциальный конфликт: если типовая подписка на ПередЗаписью устанавливает Отказ=Истина, перехват &Перед в расширении не выполнится (поведение зависит от версии платформы).

**Почему важно:** Риск низкий, поскольку УТ 10.2 не обновляется и типовые подписки не меняются. Однако при обновлении платформы 8.3 поведение может измениться.

**Рекомендация:** Задокументировать порядок выполнения подписок. Тестировать на конкретной версии платформы. Для перехвата ПередЗаписью использовать &Перед, а не &Вместо (чтобы типовая логика выполнялась).

---

### [LOW] UT10-003. Фоновые задания в расширении -- идемпотентность

**Описание:** 20 фоновых заданий описаны с retry-логикой (3 попытки). Однако не описана **идемпотентность** -- что произойдет, если задание будет перезапущено после частичного выполнения. Например, задание `ПересчетСанкций` обрабатывает список ЛС. Если после обработки 50 из 100 ЛС задание упадет и перезапустится -- первые 50 будут обработаны повторно.

**Почему важно:** Повторная обработка может привести к дублированию записей в регистрах (двойная санкция, двойное начисление).

**Рекомендация:** Для каждого фонового задания описать механизм идемпотентности:
- Использовать отметку "обработано" (реквизит в регистре или вспомогательная таблица).
- Или использовать паттерн "запрос без обработанных" (WHERE НЕ Обработано).

---

### [LOW] UT10-004. JSON в реквизите ИсторияМаршрутизации (Строка(5000))

**Описание:** Документ `ЗаявкаНаСогласование` (раздел 1.3.2 архитектуры) содержит реквизит `ИсторияМаршрутизации` типа `Строка(5000)` с пояснением "JSON: кому назначалось, когда, решение/таймаут". Хранение структурированных данных в JSON-строке внутри реквизита -- антипаттерн для 1С:
1. Невозможно использовать в запросах.
2. Платформа не контролирует формат.
3. При превышении 5000 символов данные обрежутся без ошибки.

**Почему важно:** Для 1-2 маршрутизаций JSON может быть компактным, но при 5+ эскалациях и перелинковках строка может превысить 5000 символов. Потеря истории маршрутизации -- потеря аудиторского следа.

**Рекомендация:** Заменить на табличную часть "ИсторияМаршрутизации" документа `ЗаявкаНаСогласование`:

```
Табличная часть "ИсторияМаршрутизации":
  - НомерШага (Число(2,0))
  - Согласующий (СправочникСсылка.Пользователи)
  - ДатаНазначения (Дата)
  - ДатаРешения (Дата)
  - Решение (ПеречислениеСсылка.РешенияСогласования)
  - Причина (Строка(500))
```

Это обеспечивает структурированное хранение, возможность запросов и нет ограничения на количество шагов.

---

## СЕКЦИЯ 4: Performance Review

### [INFO] PERF-001. Порядок захвата блокировок описан корректно

Раздел 6.2 архитектуры описывает строгий порядок захвата блокировок: ЛокальнаяСмета -> ОстаткиЛС -> РезервыЛС -> ВыручкаОтгруженного -> ЗаказКлиента. Таймаут ожидания 30 секунд. Это корректный подход для предотвращения взаимных блокировок (deadlock).

### [INFO] PERF-002. Индексы описаны адекватно

Раздел 6.3 описывает индексы для основных регистров. Набор индексов покрывает основные сценарии запросов. Дополнительные индексы могут понадобиться после нагрузочного тестирования.

### [INFO] PERF-003. Целевые показатели реалистичны

Расчет рентабельности <= 2 сек при 500 позициях, обработка WMS <= 30 сек, открытие формы <= 2 сек -- реалистичные показатели при условии наличия индексов и кеширования через модуль с повторным использованием.

---

## Сводная таблица замечаний

| ID | Уровень | Категория | Краткое описание | Секция |
|----|---------|-----------|------------------|--------|
| ARC-001 | CRITICAL | Архитектура | ЭлементыФормы.Вставить() не существует в обычных формах | 1 |
| ARC-002 | CRITICAL | Архитектура | Некорректная структура регистра ЛимитыАвтосогласования | 1 |
| ARC-003 | CRITICAL | Архитектура | Регистр НагрузкаСогласующих: булевы "ресурсы" в регистре сведений | 1 |
| ARC-004 | CRITICAL | Архитектура | Строковые статусы вместо перечислений (5 регистров) | 1 |
| ARC-005 | HIGH | Архитектура | Невозможность добавления элементов через &После на типовую форму | 1 |
| ARC-006 | HIGH | Производительность | Таймер 60 сек при 70 сеансах создает серверную нагрузку | 1 |
| ARC-007 | HIGH | Безопасность | Привилегированный модуль без описания RLS bypass и аудита | 1 |
| ARC-008 | HIGH | Архитектура | Неверная характеристика "Глобальных" модулей | 1 |
| ARC-009 | HIGH | Архитектура | Отсутствует механизм сброса кеша при изменении констант | 1 |
| EST-001 | MEDIUM | Оценка | Занижен коэффициент на справочники с формами (+20% вместо +40%) | 2 |
| EST-002 | MEDIUM | Оценка | Не учтено регрессионное тестирование (+72ч) | 2 |
| EST-003 | MEDIUM | Оценка | Буфер рисков 15% мал для устаревшей платформы (рекомендация 20%) | 2 |
| EST-004 | MEDIUM | Оценка | Доступность 3 разработчиков с опытом обычных форм | 2 |
| EST-005 | MEDIUM | Тестирование | xUnitFor1C: ограничения для расширений не описаны | 2 |
| EST-006 | MEDIUM | Код | ТекущаяДата() вызывается дважды для одной операции | 2 |
| UT10-001 | HIGH | Платформа | Версия платформы 8.3 для поддержки новых регистров в расширении | 3 |
| UT10-002 | LOW | Платформа | Потенциальный конфликт с типовыми подписками | 3 |
| UT10-003 | LOW | Код | Фоновые задания без описания идемпотентности | 3 |
| UT10-004 | LOW | Архитектура | JSON в строковом реквизите вместо табличной части | 3 |

---

## Вывод по трудоемкости

| Показатель | Значение в ТЗ | Комментарий |
|-----------|---------------|------------|
| Базовая трудоемкость | 1795 ч | Адекватно для 118 объектов |
| Коэффициент платформы +35% | Обоснован | Средневзвешенный по категориям объектов -- корректный подход |
| Разработка с коэффициентом | 2140 ч | Корректно, с учетом EST-001: +8ч = 2148 ч |
| Тестирование 35% | 749 ч | Адекватно, с учетом EST-002: +72ч = 821 ч |
| Буфер рисков 15% | 479 ч | Рекомендация: 20% = 639 ч (+160 ч) |
| **Итого в ТЗ** | **3675 ч** | -- |
| **Рекомендуемый итог** | **~3915 ч** | +240 ч (EST-001 + EST-002 + EST-003) |
| Команда 3+1+1 на 6+2 мес. | Адекватно | С оговоркой о доступности (EST-004) |

**Резюме:** Оценка трудоемкости в ТЗ v3.0 обоснована и прозрачна. Рекомендуемая корректировка +240ч (+6.5%) не является критической и может быть учтена при планировании.

---

## Что корректно (подтверждения)

1. **Событийная модель обычных форм** (ПриОткрытии, ПередЗаписью, ПослеЗаписи, ПриЗакрытии) -- описана верно.
2. **Модальные вызовы** (Предупреждение, Вопрос, ОткрытьФормуМодально) -- доступны в обычных формах, описание корректно.
3. **ПодключитьОбработчикОжидания** для таймера -- работает на обычных формах платформы 8.3, описание корректно.
4. **Подсветка через ПриВыводеСтроки** табличного поля -- корректная замена условного оформления для обычных форм.
5. **Уведомления через модальные диалоги + надписи + регистр** -- адекватная замена ОповещениеПользователю.
6. **Расширение (.cfe) на платформе 8.3** -- все описанные объекты (справочники, документы, регистры, обработки, общие модули, подписки) можно создать в расширении при версии платформы 8.3.22+.
7. **HTTP-сервисы для интеграций** -- работают штатно на платформе 8.3, не зависят от типа форм.
8. **Стратегия блокировок** (пессимистичная через регистр сведений) -- правильный подход для обычного приложения с 50-70 пользователями.
9. **Порядок захвата блокировок** и таймауты -- описаны корректно.
10. **Рекомендация по миграции** (серверная логика переносится, формы переделываются) -- верно.

---

## Рекомендации до начала разработки

1. **[ОБЯЗАТЕЛЬНО]** Исправить ARC-001: убрать все упоминания ЭлементыФормы.Вставить(), описать подход "форма создается в конфигураторе расширения".
2. **[ОБЯЗАТЕЛЬНО]** Исправить ARC-002: пересмотреть структуру регистра ЛимитыАвтосогласования.
3. **[ОБЯЗАТЕЛЬНО]** Исправить ARC-003: НагрузкаСогласующих -- убрать дублирование, вычислять оперативные данные запросом.
4. **[ОБЯЗАТЕЛЬНО]** Исправить ARC-004: заменить строковые статусы на перечисления (5 регистров).
5. **[РЕКОМЕНДУЕТСЯ]** Провести технический PoC на версии платформы заказчика (UT10-001).
6. **[РЕКОМЕНДУЕТСЯ]** Увеличить интервал таймера до 120 сек (ARC-006).
7. **[РЕКОМЕНДУЕТСЯ]** Скорректировать оценку: +240ч к итогу.
8. **[РЕКОМЕНДУЕТСЯ]** Описать стратегию xUnitFor1C тестирования для расширений (EST-005).

---

*Дата ревью: 26.02.2026*
*Автор: Шаховский А.С.*

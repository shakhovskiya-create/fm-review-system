# SE Review: Расширение 1С — Kafka Producer (Phase 1.5)

**Дата:** 02.03.2026
**Ревьюер:** Agent 10 (Senior Engineer 1С)
**Проект:** FM-LS-PROFIT (Контроль рентабельности отгрузок по ЛС)
**Объект ревью:** `AGENT_11_DEV_1C/phase1_5_extension.md`
**Спецификация:** `AGENT_5_TECH_ARCHITECT/phase1e_integration_architecture.md`
**Issue:** #176

---

## 1. Executive Summary

**Вердикт: CONDITIONAL PASS (0 CRITICAL / 1 HIGH / 6 MEDIUM / 5 LOW)**

Расширение КонтрольРентабельностиИнтеграция реализует транспортную интеграцию между 1С:УТ 10.2 и profitability-service через HTTP->Kafka. Архитектура расширения корректна: подписки &После, kill switch, retry queue с экспоненциальным backoff, дедупликация callback, HTTPS, API-ключ в константах.

**Ключевая проблема (HIGH):** Расширение реализует продюсеры только для 4 из 9 inbound event types (order.created, order.updated, shipment.posted, shipment.returned). Отсутствуют 5 типов событий: price.npss-updated, price.purchase-changed, client.updated, ls.created, ls.plan-changed. Это описано как "Phase 1.5 scope" -- проверить намерение: если 5 событий запланированы на Phase 2, зафиксировать в issue.

**Сильные стороны:**
- Чистая архитектура: подписки -> серверный модуль -> HTTP -> retry queue
- Kill switch через константу (отключение без перезапуска)
- Корректная обработка HTTP-кодов (202, 400, 401, 409, 500)
- Дедупликация callback в транзакции с бизнес-логикой
- HTTPS с ЗащищенноеСоединениеOpenSSL
- Стандарт ИТС 455 для структуры модулей
- Хорошее покрытие тестовыми сценариями (32 теста)

---

## 2. Findings

| ID | Severity | Category | Finding | Recommendation |
|----|----------|----------|---------|----------------|
| SE-EXT-001 | HIGH | Integration completeness | 5 из 9 inbound event types отсутствуют (price.npss-updated, price.purchase-changed, client.updated, ls.created, ls.plan-changed). Спецификация phase1e определяет 9 inbound topics, расширение реализует 4. | Если это scope Phase 1.5 -- зафиксировать TODO с issue. Если ожидается полная реализация -- добавить 5 подписок + payload builders. |
| SE-EXT-002 | MEDIUM | Code quality | Регистр ekf_ОчередьОтправкиСобытий объявляет 4 статуса (pending/sending/failed/expired), но код использует только 2: "pending" и "expired". Статусы "sending" и "failed" нигде не устанавливаются. | Либо использовать "sending" при захвате записи из очереди (optimistic lock), либо убрать неиспользуемые статусы из описания. Рекомендация: использовать "sending" -- это решает проблему параллельной обработки одной записи двумя экземплярами фонового задания. |
| SE-EXT-003 | MEDIUM | Performance | Регламентное задание ekf_ОбработкаОчередиОтправки с интервалом 60 секунд. При 50-70 одновременных сеансах и потенциальном запуске нескольких экземпляров фонового задания возможна конкуренция за записи очереди. Нет механизма блокировки (пессимистичной или оптимистичной). | Добавить установку статуса "sending" перед отправкой + проверку в WHERE-условии запроса. Альтернативно: использовать ВЫБРАТЬ ... ДЛЯ ИЗМЕНЕНИЯ или ЗаблокироватьДанныеДляРедактирования для предотвращения параллельной обработки. Дополнительно: добавить ключ Предопределенное = Истина и Количество = 1 для регламентного задания, чтобы гарантировать один экземпляр. |
| SE-EXT-004 | MEDIUM | Data types | Регистр сведений ekf_ОчередьОтправкиСобытий -- поле Статус и ТипСобытия объявлены как Строка. По стандартам 1С строковые статусы -- антипаттерн. | Заменить на перечисления: СтатусыОчередиОтправки (Ожидающий, Отправляется, Истек), ТипыСобытийИнтеграции (order_created, order_updated, ...). Это даст контроль на уровне платформы и исключит опечатки. Однако, учитывая что это расширение для интеграции и строковые значения совпадают с event_type из спецификации -- компромисс приемлем если добавить валидацию. |
| SE-EXT-005 | MEDIUM | Security | Функция ПроверитьAPIКлюч использует прямое сравнение строк (ПолученныйКлюч = ДействующийКлюч). Это уязвимо к timing attack (разное время выполнения для ключей разной длины). | В критичных системах использовать побайтное сравнение фиксированной длины. В контексте 1С:УТ в корпоративной сети за VPN -- риск минимален, но хорошая практика -- проверять через хеширование: если SHA256(полученный) = SHA256(эталон). |
| SE-EXT-006 | MEDIUM | Error handling | В функции ОбработатьЗапросCallback при HTTP 500 в ответ отправляется полный ТекстОшибки (ПодробноеПредставлениеОшибки). Это раскрывает внутреннюю информацию о 1С (стек вызовов, имена модулей). | Отправлять generic "Internal server error" в HTTP-ответе, а подробности записывать только в журнал регистрации. ТекстОшибки уже записывается в ЖР -- дублировать его в HTTP-ответ не нужно. |
| SE-EXT-007 | MEDIUM | Compatibility | Поле ВидЗаказа в строке `ДокументОбъект.ВидЗаказа = "EDI"` -- в УТ 10.2 нет стандартного реквизита "ВидЗаказа" у документа "Заказ покупателя". Это может быть доработка клиента или ошибка. Код не обернут в Попытка/Исключение. | Обернуть обращение к ВидЗаказа в Попытка/Исключение аналогично ЛокальнаяСмета. Или использовать проверку через Метаданные.Документы.ЗаказПокупателя.Реквизиты.Найти("ВидЗаказа"). |
| SE-EXT-008 | LOW | Code quality | Функции СтруктуруВJSON и JSONВСтруктуру в ekf_ИнтеграцияСервер -- utility-функции, но объявлены в приватной области (СлужебныеПроцедурыИФункции). При этом JSONВСтруктуру вызывается из ekf_ИнтеграцияКоллбэкСервер (строка 930). Приватная функция вызвана из другого модуля. | Переместить JSONВСтруктуру и СтруктуруВJSON в область ПрограммныйИнтерфейс, либо вынести в отдельный общий модуль ekf_ИнтеграцияУтилиты. |
| SE-EXT-009 | LOW | Rounding | Функция Окр() без второго параметра округляет до целого по правилам банковского округления. Для финансовых данных (суммы в копейках) результат может отличаться от ожидаемого: Окр(150.5) = 150 (не 151). | Использовать Окр(Значение * 100, 0, РежимОкругления.Окр15как20) для гарантии предсказуемого округления вверх при .5. Или Цел(Значение * 100) если дробная часть после * 100 невозможна. |
| SE-EXT-010 | LOW | Monitoring | Функция ПолучитьСтатистикуОчереди экспортирована, но нигде не вызывается. Нет HTTP-endpoint для мониторинга очереди (healthcheck). | Добавить эндпоинт GET /api/v1/health в HTTP-сервис callback (или отдельный HTTP-сервис) для мониторинга. Возвращать: queue_pending, queue_expired, integration_active. |
| SE-EXT-011 | LOW | Cleanup | Процедура ОчиститьСтарыеЗаписи в модуле менеджера ekf_ОбработанныеКоллбэки удаляет записи поштучно в цикле ВЫБРАТЬ -> Удалить(). При большом объеме (1000+ записей за 30 дней) -- неоптимально. | Использовать НаборЗаписей с фильтром для массового удаления, или выполнить DELETE через запрос-обновление. Для текущих объемов (~50-100 callback/день) -- приемлемо, но при масштабировании потребуется оптимизация. |
| SE-EXT-012 | LOW | Documentation | В секции 2 спецификации (phase1e) фоновое задание обработки очереди запускается каждые 30 секунд. В расширении -- каждые 60 секунд. Расхождение со спецификацией. | Согласовать с архитектором: 60 секунд предпочтительнее (из memory: рекомендация Agent 10 при 70 сеансах -- минимум 120 сек). Обновить спецификацию или расширение. |

---

## 3. Code Quality Assessment

### 3.1. Naming Conventions

**Оценка: PASS**

- Все объекты расширения имеют префикс `ekf_` -- корректно
- Именование модулей на русском, в соответствии с конвенциями 1С
- Структура JSON-полей в camelCase (английский) -- соответствует спецификации
- Области модулей по ИТС 455: ПрограммныйИнтерфейс, СлужебныйПрограммныйИнтерфейс, СлужебныеПроцедурыИФункции -- корректно

### 3.2. Error Handling

**Оценка: PASS (с замечанием SE-EXT-006)**

- Все HTTP-вызовы обернуты в Попытка/Исключение
- При сетевой ошибке -- запись в очередь (graceful degradation)
- При HTTP 400 -- не повторяется (permanent failure)
- При HTTP 401 -- логирование + очередь
- При HTTP 409 -- корректная обработка дубликата
- Callback: транзакция НачатьТранзакцию/ЗафиксироватьТранзакцию/ОтменитьТранзакцию -- корректный паттерн
- Замечание: раскрытие стека ошибки в HTTP-ответе (SE-EXT-006)

### 3.3. Logging

**Оценка: PASS**

- ЗаписьЖурналаРегистрации используется с правильными параметрами
- Корректные уровни: Ошибка для failures, Предупреждение для сетевых проблем, Информация для операций
- Указание MetadataObject для привязки к документам (ЗаказПокупателя)
- Информативные сообщения с СтрШаблон (тип события, ID, контрагент)
- Отдельный event name "ekf_Интеграция.ПовторнаяОтправка.ТребуетВнимания" для алертинга -- хорошая практика

### 3.4. Comments

**Оценка: PASS**

- Все функции имеют описание параметров и возвращаемых значений
- Комментарии на русском -- соответствует стандартам 1С
- Ссылки на ТЗ в комментариях (phase1e, секция N) -- хорошая практика
- Области модулей размечены

---

## 4. Security Assessment

**Оценка: CONDITIONAL PASS**

### 4.1. API Key Management

- API-ключ хранится в константе (не в коде) -- корректно
- Отдельные ключи для outbound (ekf_ИнтеграцияAPIКлюч) и inbound callback (ekf_КоллбэкAPIКлюч) -- хорошая практика
- Ключи передаются в заголовке X-Api-Key -- корректно
- Ротация описана в спецификации (ежемесячно через Infisical) -- процедура есть

### 4.2. Input Validation

- JSON тело callback парсится через стандартный ЧтениеJSON -- корректно
- Проверка пустого тела запроса -- есть
- Проверка наличия request_id -- есть
- Определение типа операции через Найти() по URL -- корректно

### 4.3. Замечания

- **SE-EXT-005** (MEDIUM): Timing attack при сравнении ключей -- низкий риск в корпоративной сети
- **SE-EXT-006** (MEDIUM): Раскрытие стека ошибки в HTTP-ответе -- нужно исправить
- Нет rate limiting на callback endpoint -- учитывая что вызывающая сторона (integration-service) контролируется нами, это приемлемо
- Нет проверки Content-Length на входящий callback -- при очень большом payload возможна проблема с памятью. Низкий риск (integration-service контролирует размер).

### 4.4. HTTPS

- HTTPS через ЗащищенноеСоединениеOpenSSL -- корректно
- Дефолтный порт 443 -- корректно
- Нет hardcoded credentials -- корректно

---

## 5. Compatibility Check

**Оценка: PASS**

### 5.1. Платформа 1С:УТ 10.2 + 8.3

- Режим совместимости расширения: 8.3.9 -- корректно (минимальная версия для расширений с новыми объектами)
- Формы не используются в этом расширении (только серверная логика) -- нет конфликта с обычными формами
- Нет директив компиляции (&НаСервере, &НаКлиенте) -- корректно для общих модулей без разделения контекста
- Нет Обещание/Ждать (async) -- корректно
- ЗаписьJSON, ЧтениеJSON, HTTPСоединение, HTTPСервис -- все доступны в 8.3

### 5.2. Расширение (.cfe)

- Подписки только &После (ОбработкаПроведения) -- корректно, не &Вместо
- Все новые объекты с префиксом ekf_ -- не конфликтуют с типовыми
- Расширение не модифицирует типовые объекты метаданных -- минимальная инвазия
- Kill switch через константу -- возможность отключения без снятия расширения

### 5.3. Замечание SE-EXT-007

- Обращение к ДокументОбъект.ВидЗаказа без Попытка/Исключение -- потенциальная ошибка в типовой конфигурации УТ 10.2. Аналогичное обращение к ЛокальнаяСмета обернуто -- нужна одинаковая стратегия.

---

## 6. Integration Correctness Check

### 6.1. Event Coverage

| # | Event Type (spec) | Kafka Topic | Producer в расширении | Статус |
|---|-------------------|-------------|----------------------|--------|
| 1 | order.created | 1c.order.created.v1 | ekf_ПриПроведенииЗаказаПокупателя | ЕСТЬ |
| 2 | order.updated | 1c.order.updated.v1 | ekf_ПриПроведенииЗаказаПокупателя | ЕСТЬ |
| 3 | shipment.posted | 1c.shipment.posted.v1 | ekf_ПриПроведенииРеализации | ЕСТЬ |
| 4 | shipment.returned | 1c.shipment.returned.v1 | ekf_ПриПроведенииВозврата | ЕСТЬ |
| 5 | price.npss-updated | 1c.price.npss-updated.v1 | -- | ОТСУТСТВУЕТ |
| 6 | price.purchase-changed | 1c.price.purchase-changed.v1 | -- | ОТСУТСТВУЕТ |
| 7 | client.updated | 1c.client.updated.v1 | -- | ОТСУТСТВУЕТ |
| 8 | ls.created | 1c.ls.created.v1 | -- | ОТСУТСТВУЕТ |
| 9 | ls.plan-changed | 1c.ls.plan-changed.v1 | -- | ОТСУТСТВУЕТ |

**Покрытие: 4/9 (44%)** -- это основной finding SE-EXT-001.

### 6.2. JSON Payload Schema Conformance

Проверка соответствия формируемого JSON спецификации phase1e (секция 2.6):

**order.created / order.updated (2.6.1):**

| Required field (spec) | Формируется | Замечание |
|----------------------|-------------|-----------|
| order_id | Да (Строка(Номер)) | OK |
| local_estimate_id | Да (Попытка/Исключение) | OK, graceful degradation |
| client_id | Да (Контрагент.Код) | OK |
| manager_id | Да (Ответственный.Код) | OK |
| business_unit_id | Да (Подразделение.Код) | OK |
| total_amount | Да (Окр(Сумма*100)) | OK, в копейках |
| line_items | Да (массив) | OK |
| source | Да (EDI/manual) | Замечание SE-EXT-007: ВидЗаказа |
| currency | Да ("RUB") | OK |

**shipment.posted (2.6.2):**

| Required field (spec) | Формируется | Замечание |
|----------------------|-------------|-----------|
| shipment_doc_id | Да | OK |
| order_id | Да | OK |
| local_estimate_id | Да (через заказ) | OK |
| posted_at | Да (XMLСтрока) | OK |
| line_items | Да | OK |
| total_amount | Да | OK |
| client_id | Да | OK |
| warehouse_id | Да | OK |

**shipment.returned (2.6.3):**

| Required field (spec) | Формируется | Замечание |
|----------------------|-------------|-----------|
| return_doc_id | Да | OK |
| order_id | Да (через ДокументОснование) | OK |
| local_estimate_id | Да (через ДокументОснование) | OK |
| returned_at | Да | OK |
| line_items | Да | OK |
| total_amount | Да | OK |
| client_id | Да | OK |
| reason | Да (Комментарий) | OK |

### 6.3. Callback Endpoints

| Callback (spec) | HTTP-сервис | Обработчик | Статус |
|----------------|-------------|------------|--------|
| PUT /callback/approval/{order_id}/result | Да | ОбработатьApprovalResult -> ОбработатьЗапросCallback | OK |
| PUT /callback/sanction/{client_id} | Да | ОбработатьSanction -> ОбработатьЗапросCallback | OK |
| PUT /callback/block/{order_id} | Да | ОбработатьBlock -> ОбработатьЗапросCallback | OK |

Все 3 outbound callback реализованы корректно.

### 6.4. Retry Policy

Экспоненциальный backoff реализован в соответствии со спецификацией (phase1e, секция 2.3):

| Попытка | Spec | Extension | Match |
|---------|------|-----------|-------|
| 1 | 30 сек | 30 сек | OK |
| 2 | 1 мин | 60 сек | OK |
| 3 | 2 мин | 120 сек | OK |
| 4 | 5 мин | 300 сек | OK |
| 5 | 10 мин | 600 сек | OK |
| 6-10 | 15 мин | 900 сек | OK |
| 11-20 | 30 мин | 1800 сек | OK |
| 21-50 | 1 час | 3600 сек | OK |
| 51-100 | 2 часа | 7200 сек | OK |

Макс. попыток: 100 (spec) = 100 (extension) -- OK.

### 6.5. Idempotency

- Outbound (1С -> Go): message_id генерируется как UUID, передается в заголовке X-Message-Id -- OK
- Inbound (Go -> 1С): request_id проверяется в регистре ekf_ОбработанныеКоллбэки, запись dedup + бизнес-логика в одной транзакции -- OK
- HTTP 409 при дубликате callback -- OK

---

## 7. Recommendations

### 7.1. Must fix (до deployment)

1. **SE-EXT-001** (HIGH): Определить scope -- если 5 оставшихся event types запланированы на Phase 2, создать отдельную issue. Если ожидаются в этом расширении -- реализовать подписки и payload builders для price.npss-updated, price.purchase-changed, client.updated, ls.created, ls.plan-changed.

2. **SE-EXT-006** (MEDIUM): Убрать ПодробноеПредставлениеОшибки из HTTP-ответа 500. Заменить на generic "Internal server error". Подробности уже записаны в ЖР.

3. **SE-EXT-007** (MEDIUM): Обернуть обращение к ВидЗаказа в Попытка/Исключение или проверить наличие реквизита через метаданные.

### 7.2. Should fix (до production)

4. **SE-EXT-003** (MEDIUM): Добавить защиту от параллельной обработки в фоновом задании. Установить Предопределенное = Истина, Количество = 1 для регламентного задания. Использовать статус "sending" для optimistic lock.

5. **SE-EXT-002** (MEDIUM): Привести статусы регистра в соответствие с кодом. Использовать "sending" или убрать.

6. **SE-EXT-004** (MEDIUM): Рассмотреть замену строковых статусов на перечисления. Компромиссный вариант -- оставить строки с валидацией.

### 7.3. Nice to have

7. **SE-EXT-009** (LOW): Уточнить режим округления для финансовых сумм.
8. **SE-EXT-010** (LOW): Добавить healthcheck endpoint.
9. **SE-EXT-011** (LOW): Оптимизировать массовое удаление в ОчиститьСтарыеЗаписи.
10. **SE-EXT-012** (LOW): Согласовать интервал фонового задания (60 сек vs 30 сек в спецификации).

---

## 8. Test Coverage Assessment

32 тестовых сценария покрывают все реализованные компоненты:

| Группа | Кол-во | Покрытие |
|--------|--------|----------|
| Отправка событий | 6 (T-01..T-06) | kill switch, success, failures, duplicate |
| Формирование payload | 5 (T-07..T-11) | все 3 типа документов + edge cases |
| Retry queue | 7 (T-12..T-18) | backoff, expired, cleanup, notification |
| Callback HTTP-сервис | 9 (T-19..T-27) | all endpoints, dedup, auth, errors |
| Подписки на события | 5 (T-28..T-32) | created/updated, rejection, all doc types |

**Общее покрытие: 32 сценария -- хорошо для Phase 1.5.**

**Недостающие тест-сценарии (рекомендуется добавить):**
- T-33: Параллельная обработка очереди (2 экземпляра фонового задания)
- T-34: Очистка при пустом регистре (граничный случай)
- T-35: Очередь с записями в статусе "expired" не обрабатывается повторно
- T-36: Максимальный размер JSON payload (1000+ строк товаров)
- T-37: Таймаут HTTP-соединения (5 секунд) при медленном сервисе

---

## 9. Summary Metrics

| Метрика | Значение |
|---------|----------|
| Findings total | 12 (0C/1H/6M/5L) |
| CRITICAL | 0 |
| HIGH | 1 (SE-EXT-001: missing 5/9 events) |
| MEDIUM | 6 |
| LOW | 5 |
| Code quality | PASS |
| Security | CONDITIONAL PASS |
| Compatibility | PASS |
| Integration correctness | 44% events, 100% callbacks |
| Test coverage | 32 scenarios |
| Verdict | CONDITIONAL PASS |

**Условия прохождения:**
1. Зафиксировать scope 5 отсутствующих event types (issue или Phase 2 backlog)
2. Исправить раскрытие стека ошибки в HTTP-ответе (SE-EXT-006)
3. Обернуть ВидЗаказа в Попытка/Исключение (SE-EXT-007)

При выполнении этих 3 условий -- расширение APPROVED для deployment.

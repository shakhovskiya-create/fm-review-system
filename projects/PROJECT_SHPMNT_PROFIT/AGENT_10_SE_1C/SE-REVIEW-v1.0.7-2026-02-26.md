# SE-ревью: ТЗ v3.1 и Архитектура v1.0.7 (FM-LS-PROFIT v1.0.7)

**Дата:** 26.02.2026
**Автор:** Шаховский А.С.
**Платформа:** 1С:УТ 10.2 на платформе 8.3, обычные формы, толстый клиент
**Объем:** ТЗ v3.1 (689 строк), Архитектура v1.0.7 (1527 строк)
**Предыдущий ревью:** SE-REVIEW-v1.0.6-2026-02-26.md (0C/3H/5M/4L, APPROVED WITH CONDITIONS)
**GitHub Issue:** #91

---

## Вердикт: APPROVED

**Рейтинг: 0 CRITICAL, 0 HIGH, 2 MEDIUM, 2 LOW**

Документы v1.0.7 полностью устраняют все 3 HIGH-замечания и 4 из 5 MEDIUM-замечаний предыдущего ревью. Все 4 LOW-замечания также учтены. Оставшиеся 2 MEDIUM и 2 LOW -- новые, обнаруженные при верификации.

**Общая оценка:** Документы готовы к передаче в разработку. Оставшиеся замечания не блокирующие и могут быть устранены при детальном проектировании.

---

## Прогресс закрытия замечаний предыдущего ревью (12 из 12)

### HIGH (3/3 закрыты)

| Замечание v1.0.6 | Статус в v1.0.7 | Где исправлено |
|------------------|-----------------|----------------|
| ARC-005: НагрузкаСогласующих -- Реквизит/Ресурс рассогласование | ЗАКРЫТО | Архитектура 1.5.12 (стр. 830-833): все 4 поля теперь Ресурс, с комментарием "для доступности через СрезПоследних". ТЗ 2.2.3 (стр. 252-255) уже был корректен (Ресурс) |
| ARC-006: ОчередьРезервногоРежима.Статус = Строка(20) в ТЗ | ЗАКРЫТО | ТЗ 2.2.4 (стр. 284): Статус = ПеречислениеСсылка.СтатусыОчередиРезервногоРежима. Перечисление определено в Архитектуре 1.2 (стр. 348). Строка(20) устранена |
| ARC-007: ИтерацииКорректировкиЦены.Результат = Строка(20) в ТЗ | ЗАКРЫТО | ТЗ 2.2.5 (стр. 325): Результат = ПеречислениеСсылка.РезультатыКорректировки. Перечисление определено в Архитектуре 1.2 (стр. 352). Строка(20) устранена |

### MEDIUM (4/5 закрыты)

| Замечание v1.0.6 | Статус в v1.0.7 | Где исправлено |
|------------------|-----------------|----------------|
| ARC-008: Таймер 60 сек vs 120 сек | ЗАКРЫТО | Архитектура 8.5.2 (стр. 1397): ПодключитьОбработчикОжидания("КР_ОбновитьТаймерSLA", 120). Комментарий: "единый интервал для всех форм, SLA измеряется часами -- минутная точность избыточна, см. раздел 0.4" |
| ARC-009: Формулировки о программном создании элементов | ЗАКРЫТО | ТЗ 1.7.1 (стр. 119): "Элементы создаются в конфигураторе расширения. Программно управляется видимость, заголовки, цвета". ТЗ 1.7.2 (стр. 135): "Все элементы размещаются в конфигураторе расширения (.cfe). Программно управляется видимость, подписи и цвета." Корректные формулировки |
| ARC-010: Подсистемы "В командный интерфейс" | ЗАКРЫТО | Архитектура 8.1 (стр. 1171-1173): убрана колонка "В командный интерфейс", добавлено примечание о навигации через панель функций / Действия |
| ARC-011: ФО не управляют видимостью в обычных формах | ЗАКРЫТО | Архитектура 8.4 (стр. 1220-1227): добавлено развернутое примечание с примером кода проверки ПолучитьФункциональнуюОпцию() в ПриОткрытии |
| ARC-012: JSON в ИсторияМаршрутизации | ЗАКРЫТО | Архитектура 1.3.2 (стр. 459-472): удален реквизит Строка(5000), добавлена табличная часть ИсторияМаршрутизации (7 полей: НомерШага, Согласующий, ДатаНазначения, ДатаРешения, Решение, ТаймаутНаступил, Комментарий) |

### LOW (4/4 закрыты)

| Замечание v1.0.6 | Статус в v1.0.7 | Где исправлено |
|------------------|-----------------|----------------|
| CODE-001: Двойной ТекущаяДата() в ТЗ | НЕ ЗАКРЫТО (см. NEW-001) | ТЗ 2.2.1 (стр. 189-190): двойной вызов остался. Архитектура (стр. 150-152) корректна |
| CODE-002: Комментарий к ПустаяСсылка | ЗАКРЫТО | Архитектура 1.5.12 (стр. 845): добавлен комментарий "Пустое решение = задача в очереди (ещё не обработана согласующим)" |
| CODE-003: Регистр ДатаИзмененияНастроек не описан | ЗАКРЫТО | Архитектура 1.5.13 (стр. 867-877): добавлен регистр сведений ДатаИзмененияНастроек (2 поля: ИмяНастройки, ДатаИзменения), с описанием альтернативного варианта (константа) |
| PERF-001: Нагрузка от 20 регламентных заданий | ЗАКРЫТО | Архитектура 6.3 (стр. 1112-1114): добавлена рекомендация по нагрузочному тестированию совокупной нагрузки регламентных заданий |

**Итог:** 11 из 12 замечаний полностью закрыты. CODE-001 (двойной ТекущаяДата()) не устранен в ТЗ, переквалифицирован в NEW-001.

---

## Новые замечания v1.0.7

### [MEDIUM] NEW-001. ТЗ 2.2.1: двойной вызов ТекущаяДата() в псевдокоде УстановитьБлокировкуЛС

**Описание:** В ТЗ раздел 2.2.1 (стр. 189-190) сохраняется двойной вызов ТекущаяДата():

```1c
Запись.ВремяБлокировки = ТекущаяДата();
Запись.ВремяИстечения = ТекущаяДата() + ТаймаутМинут * 60;
```

Архитектура v1.0.7 (раздел 0.3, стр. 150-152) использует корректный паттерн с единым вызовом:

```1c
ТекущееВремя = ТекущаяДата(); // единый вызов для согласованности
Запись.ВремяБлокировки = ТекущееВремя;
Запись.ВремяИстечения = ТекущееВремя + 5 * 60;
```

Это наследие замечания CODE-001 из ревью v1.0.6, которое было устранено в Архитектуре, но не в ТЗ.

**Почему важно:** Рассогласование псевдокода между ТЗ и Архитектурой. Разработчик, читающий ТЗ первым, может скопировать неоптимальный паттерн. Не блокирующее, но документарная небрежность.

**Варианты решения:**

| Вариант | Трудоёмкость | Риск | Влияние |
|---------|-------------|------|---------|
| А: Привести ТЗ к единому вызову (как в Архитектуре) | Нулевая (1 правка) | Низкий | Среднее |
| Б: Оставить как есть, Архитектура приоритетнее | -- | Низкий | Низкое |

**Рекомендация:** Вариант А -- привести ТЗ 2.2.1 в соответствие с Архитектурой 0.3.

---

### [MEDIUM] NEW-002. Рассогласование ролей полей ОчередьРезервногоРежима.Статус и ИтерацииКорректировкиЦены.Результат между ТЗ и Архитектурой

**Описание:** Хотя замечания ARC-006 и ARC-007 закрыты (типы данных унифицированы на ПеречислениеСсылка), роли полей различаются между документами:

| Регистр | Поле | ТЗ (Роль) | Архитектура (Роль) | Корректнее |
|---------|------|-----------|--------------------|------------|
| ОчередьРезервногоРежима | Статус | Ресурс (стр. 284) | Реквизит (стр. 796) | Реквизит |
| ИтерацииКорректировкиЦены | Результат | Ресурс (стр. 325) | Реквизит (стр. 816) | Реквизит |

Анализ:
- **ОчередьРезервногоРежима** -- не является периодическим регистром сведений в классическом понимании (одна запись на заявку, не временной ряд). Поле Статус используется для фильтрации (WHERE Статус = ВОчереди), но не для агрегации и не в СрезПоследних. Корректнее: **Реквизит** (не участвует в итогах).
- **ИтерацииКорректировкиЦены** -- регистр с составным измерением (ЗаказКлиента + НомерИтерации). СрезПоследних не нужен. Поле Результат -- классификатор, не числовой показатель. Корректнее: **Реквизит** (не участвует в итогах).

Сравнить с регистром **НагрузкаСогласующих** (ARC-005), где ЗадачВОчереди и ЗадачЗаДень были верно переведены в Ресурс -- это числовые показатели, которые должны быть доступны через СрезПоследних.

**Почему важно:** Рассогласование между ТЗ и Архитектурой в ролях полей. Не влияет на работоспособность (для запросов с фильтрацией разница минимальна), но создает путаницу для разработчика.

**Варианты решения:**

| Вариант | Трудоёмкость | Риск | Влияние |
|---------|-------------|------|---------|
| А: Привести ТЗ к Реквизит (как в Архитектуре) | Нулевая (2 правки) | Низкий | Среднее |
| Б: Оставить как есть, Архитектура приоритетнее | -- | Низкий | Низкое |

**Рекомендация:** Вариант А -- привести ТЗ разделы 2.2.4 и 2.2.5 в соответствие с Архитектурой.

---

### [LOW] NEW-003. ТЗ 2.2.3 (стр. 268): формулировка "Надписи добавляются программно в ПриОткрытии"

**Описание:** В разделе 2.2.3 ТЗ (стр. 268) для индикаторов нагрузки указано:

> Надписи добавляются программно в ПриОткрытии.

Формулировка неточна. Надписи как элементы формы создаются в конфигураторе расширения. Программно в ПриОткрытии обновляются их **заголовки** (текст) и **цвета**, но не сами элементы.

Это согласуется с основным текстом ТЗ раздел 1.7.1 (стр. 119): "Элементы создаются в конфигураторе расширения. Программно управляется видимость, заголовки, цвета." -- но конкретная фраза в 2.2.3 противоречит этому принципу.

**Почему важно:** Мелкая неточность, которая может быть неверно интерпретирована. Архитектура (8.5.2, стр. 1378-1382) описывает элементы корректно: "НадписьОчередь | Надпись | Индикатор: X/30 (перелив)."

**Рекомендация:** Исправить формулировку на: "Заголовки надписей обновляются программно в ПриОткрытии. Цвет текста изменяется при достижении порога."

---

### [LOW] NEW-004. ТЗ не ссылается на ИсторияМаршрутизации как табличную часть документа ЗаявкаНаСогласование

**Описание:** В Архитектуре v1.0.7 (раздел 1.3.2, стр. 459-472) документ ЗаявкаНаСогласование содержит табличную часть ИсторияМаршрутизации (7 полей). Это ключевое архитектурное изменение (ARC-012 предыдущего ревью, +16 часов трудоёмкости).

ТЗ v3.1 не содержит упоминания ИсторияМаршрутизации. ТЗ не описывает документ ЗаявкаНаСогласование подробно (только ссылка на него в разделе 2.2.4 ОчередьРезервногоРежима).

Это объяснимо архитектурой документа: ТЗ описывает конкретные объекты разработки (секция 2), а полная спецификация ЗаявкаНаСогласование дана в Архитектуре. Однако для полноты ТЗ стоит хотя бы упомянуть наличие табличной части ИсторияМаршрутизации -- хотя бы в разделе 2.2.6 (шаблон уведомления при перекрестном контроле), где описывается история маршрутизации заявки.

**Почему важно:** Не блокирующее. ТЗ и Архитектура -- сопутствующие документы, Архитектура является авторитетным источником по структуре объектов.

**Рекомендация:** Не обязательно. При желании -- добавить примечание в ТЗ раздел 2.2.6: "Полная история маршрутизации фиксируется в табличной части документа ЗаявкаНаСогласование (см. Архитектуру, раздел 1.3.2)."

---

## СЕКЦИЯ 5: SBS Compatibility & Hyperlinks Review

### Раздел 0A Архитектуры (SBS-зависимости)

Раздел сохранён из v1.0.6, все 5 зависимостей описаны корректно:

| ЧТЗ SBS | Гиперссылка | Корректность | Проверка |
|---------|-------------|-------------|----------|
| [SBS-58](https://confluence.ekf.su/pages/viewpage.action?pageId=71107278) | pageId=71107278 | Корректно | Формула НПСС, snapshot, период 6 мес. |
| [SBS-59](https://confluence.ekf.su/pages/viewpage.action?pageId=83951622) | pageId=83951622 | Корректно | Справочный ориентир, не блокирующий |
| [SBS-63](https://confluence.ekf.su/pages/viewpage.action?pageId=63471872) | pageId=63471872 | Корректно | Сверка план/факт, порог 10% |
| [SBS-130](https://confluence.ekf.su/pages/viewpage.action?pageId=78742009) | pageId=78742009 | Корректно | Внутренние цены, fallback ПТУ |
| [SBS-57](https://confluence.ekf.su/pages/viewpage.action?pageId=78741936) | pageId=78741936 | Корректно | Массовый пересчет НПСС |

Все гиперссылки -- markdown-формат `[SBS-XX](URL)`, URL корректные (https://confluence.ekf.su/...), pageId соответствуют реальным страницам.

В ТЗ v3.1 гиперссылки отсутствуют в тексте (только в разделе Ссылки внизу -- 3 ссылки на ФМ, ТЗ, Архитектуру в Confluence). Это нормально: ТЗ не содержит раздел SBS-зависимостей, он находится только в Архитектуре.

**Вывод:** SBS-зависимости описаны полно и корректно в Архитектуре. Гиперссылки рабочие.

---

## СЕКЦИЯ 6: Согласованность ТЗ и Архитектуры

### Проверка перекрестной согласованности

| Объект / Параметр | ТЗ v3.1 | Архитектура v1.0.7 | Согласован? |
|-------------------|---------|--------------------|-----------:|
| Таймаут блокировки ЛС | 5 мин (стр. 104, 173, 177, 179) | 5 мин (стр. 60, 152, 1198) | Да |
| Константа ТаймаутБлокировкиЛС | Число(3,0) = 5 (стр. 467) | Число(3,0) = 5 (стр. 1198) | Да |
| P1 требований | 64 (стр. 94) | -- (нет в Архитектуре) | Да (ТЗ авторитетен) |
| Одновременные пользователи | 50-70 (стр. 99) | 50-70 (стр. 8) | Да |
| Расчет рентабельности <= 2 сек | Стр. 102 | Стр. 1092 | Да |
| Обработка WMS <= 30 сек | Стр. 103 | Стр. 1484 | Да |
| Таймер | 120 сек (стр. 166, не явно) | 120 сек (стр. 73, 166, 1397) | Да |
| ОчередьРезервногоРежима.Статус тип | ПеречислениеСсылка (стр. 284) | ПеречислениеСсылка (стр. 796) | Да |
| ОчередьРезервногоРежима.Статус роль | Ресурс (стр. 284) | Реквизит (стр. 796) | НЕТ (NEW-002) |
| ИтерацииКорректировкиЦены.Результат тип | ПеречислениеСсылка (стр. 325) | ПеречислениеСсылка (стр. 816) | Да |
| ИтерацииКорректировкиЦены.Результат роль | Ресурс (стр. 325) | Реквизит (стр. 816) | НЕТ (NEW-002) |
| НагрузкаСогласующих.ЗадачВОчереди тип | Число(3,0) (стр. 252) | Число(3,0) (стр. 830) | Да |
| НагрузкаСогласующих.ЗадачВОчереди роль | Ресурс (стр. 252) | Ресурс (стр. 830) | Да |
| Лимит менеджера 20000 руб./день | Стр. 216, 230, 468 | Стр. 619, 1200 | Да |
| Лимит БЮ 100000 руб./день | Стр. 217, 233, 469 | Стр. 620, 1201 | Да |
| Лимит итераций = 5 | Стр. 321, 332, 470 | Стр. 818, 1202 | Да |
| Порог перелива = 30 | Стр. 258, 471 | Стр. 857, 1203 | Да |
| Порог назначения = 50 | Стр. 259, 472 | Стр. 858, 1204 | Да |
| Порог ELMA fallback = 5 п.п. | Стр. 290, 473 | Стр. 799, 1205 | Да |
| Триггер курс ЦБ = 5% | Стр. 445, 474 | Стр. 647, 1206 | Да |
| Триггер закупочная цена = 15% | Стр. 443, 475 | Стр. 648, 1207 | Да |
| Регламентных заданий | 20 (стр. 457) | 20 (стр. 978-999) | Да |
| Отчетов | 15 (не явно) | 17 (стр. 1453-1473) | Да (Архитектура полнее) |
| Функциональных опций | 4 (стр. 477-484) | 6 (стр. 1211-1218) | НЕТ (см. примечание) |

**Примечание по ФО:** ТЗ описывает 4 новые ФО (раздел 5.2), Архитектура -- 6 (включая ИспользоватьКонтрольРентабельности и ИспользоватьБлокировкуОтгрузки). Это не рассогласование: ТЗ описывает только ФО, добавленные в v1.0.4+, Архитектура -- полный перечень. Архитектура авторитетнее.

---

## Оценка трудоёмкости

Оценка ТЗ v3.1: **3 936 ч** (P1: 3 269ч, P2: 667ч), включая буфер рисков 20%.

Архитектура v1.0.7 добавила:
- +1 регистр сведений (ДатаИзмененияНастроек) -- минимальная доработка (~4ч)
- +1 табличная часть (ИсторияМаршрутизации, 7 полей) -- оценка +16ч

Формально трудоёмкость должна увеличиться на ~20ч, однако ТЗ оставляет оценку на 3 936ч. Это в пределах погрешности (0.5%), покрывается буфером рисков (656ч, 20%).

**Оценка SE-ревью:**

| Параметр | Оценка ТЗ | Оценка SE |
|----------|-----------|-----------|
| Базовая разработка | 2 148 ч | 2 148 ч (корректно) |
| Тестирование (35%) | 752 ч | 752 ч (корректно) |
| Регрессионное | 72 ч | 72 ч (корректно) |
| Документация (8%) | 172 ч | 172 ч (корректно) |
| Развертывание | 68 ч | 68 ч (корректно) |
| Обучение | 68 ч | 68 ч (корректно) |
| Буфер рисков (20%) | 656 ч | 656 ч (корректно) |
| Доработки по NEW-замечаниям | -- | +0 ч (документарные) |
| **Итого** | **3 936 ч** | **3 936 ч** |

Оценка совпадает. Доработки ARC-012 (+16ч) покрываются буфером рисков.

---

## Сводная таблица замечаний v1.0.7

| # | Серьёзность | Код | Секция | Описание | Тип | Блокирует? |
|---|------------|-----|--------|----------|-----|-----------|
| 1 | MEDIUM | NEW-001 | Code | Двойной ТекущаяДата() в ТЗ 2.2.1 (не исправлен из CODE-001) | Документарное | Нет |
| 2 | MEDIUM | NEW-002 | Architecture | Ресурс/Реквизит рассогласование: ОчередьРезервногоРежима.Статус и ИтерацииКорректировкиЦены.Результат | Документарное | Нет |
| 3 | LOW | NEW-003 | Architecture | "Надписи добавляются программно" -- неточная формулировка в ТЗ 2.2.3 | Документарное | Нет |
| 4 | LOW | NEW-004 | Architecture | ТЗ не упоминает табличную часть ИсторияМаршрутизации | Документарное | Нет |

---

## Итоговые рекомендации

### Рекомендуется устранить при следующей итерации (2 MEDIUM):

1. **NEW-001:** Привести псевдокод УстановитьБлокировкуЛС в ТЗ 2.2.1 к единому вызову ТекущаяДата() (как в Архитектуре 0.3). Трудоёмкость: 0ч.

2. **NEW-002:** Привести ТЗ разделы 2.2.4 (стр. 284) и 2.2.5 (стр. 325) к использованию Реквизит вместо Ресурс для полей Статус и Результат соответственно. Архитектура корректнее: эти поля -- классификаторы, а не числовые показатели. Трудоёмкость: 0ч.

### Учесть при необходимости (2 LOW):

3. **NEW-003:** Исправить формулировку "Надписи добавляются программно в ПриОткрытии" в ТЗ 2.2.3 (стр. 268).

4. **NEW-004:** По желанию добавить ссылку на ИсторияМаршрутизации в ТЗ.

### Общие выводы

Документы v1.0.7 демонстрируют значительный прогресс:
- v1.0.5: 4 CRITICAL, 5 HIGH, 6 MEDIUM, 3 LOW (APPROVED WITH CONDITIONS)
- v1.0.6: 0 CRITICAL, 3 HIGH, 5 MEDIUM, 4 LOW (APPROVED WITH CONDITIONS)
- **v1.0.7: 0 CRITICAL, 0 HIGH, 2 MEDIUM, 2 LOW (APPROVED)**

Все замечания, влияющие на корректность разработки (CRITICAL и HIGH), устранены. Оставшиеся -- документарные неточности, не влияющие на функциональность. Документы готовы к передаче в разработку.

---

# Тест-план FM-LS-PROFIT v1.0.4

**Дата:** 25.02.2026
**Версия ФМ:** 1.0.4 (Confluence page 83951683, v82)
**Платформа:** 1С:УТ
**Область:** Полное покрытие — исправленные замечания v1.0.3, новые требования v1.0.4, findings аудита v1.0.4

---

## Метрики покрытия

| Категория | Всего объектов | Покрыто тестами | % |
|-----------|----------------|-----------------|---|
| Бизнес-правила (LS-BR) | 18 ключевых | 18 | 100% |
| Функциональные (LS-FR) | 12 ключевых | 12 | 100% |
| Findings аудита v1.0.4 (CRIT/HIGH) | 4 | 4 | 100% |
| Новые требования v1.0.4 | 6 | 6 | 100% |
| Манипуляции / обход контроля | 8 | 8 | 100% |
| Интеграции | 3 | 3 | 100% |

**Всего тест-кейсов:** 72
- Позитивных (POS): 18
- Негативных (NEG): 19
- Граничных (EDGE): 17
- Манипуляций (MANIP): 8
- Интеграционных (INT): 5
- Производительность/нагрузка (PERF): 5

---

## Выявленные риски (непротестируемые требования)

| # | Требование в ФМ | Проблема | Рекомендация |
|---|-----------------|----------|--------------|
| 1 | CRIT-001 (LS-BR-035) | Таблица требований: «15 мин», текст: «5 мин» — противоречие | Тест TC-004 намеренно проверяет оба значения, выявляя расхождение |
| 2 | HIGH-002/003 | Два порога для нагрузки согласующих: 30 задач (перелив) и 50 задач (орг. решение) — близко расположены, разработчик может перепутать | Тест TC-052 проверяет оба порога последовательно |
| 3 | GAP-02 | Гонка: одновременный пересчёт НПСС и согласование ЛС | Тест TC-068 выявляет поведение при race condition |

---

## Вопросы к аналитикам

| # | Вопрос | Влияние на тесты |
|---|--------|------------------|
| 1 | Какое значение таймаута реализовывать: 5 мин (основной текст п. 3.15) или 15 мин (таблица LS-BR-035)? | Тест TC-004 не может дать однозначный результат до устранения CRIT-001 |
| 2 | HIGH-001: Сколько фактически P1-требований — 61 (как в тексте) или ~64 (фактический подсчёт)? | Влияет на acceptance criteria приёмочного тест-плана |
| 3 | HIGH-003: LS-RPT-072 должен показывать порог 30 или оба (30 и 50)? | Тест TC-053 проверит соответствие отчёта спецификации |

---

## Тест-кейсы

---

### Модуль 1: Расчёт рентабельности и формулы (п. 3.3, 3.5, B7)

---

#### TC-001: Базовый расчёт рентабельности позиции

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.3 — Рентабельность = (Цена - НПСС) / Цена x 100% |
| **Finding** | — |

**Предусловия:**
- ЛС с плановой рентабельностью 35%
- Позиция: Цена = 1 000 руб., НПСС = 650 руб.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с указанной позицией | Заказ создан |
| 2 | Проверить рассчитанную рентабельность позиции | (1 000 - 650) / 1 000 * 100% = 35,00% |
| 3 | Убедиться, что согласование не требуется | Заказ получает статус «Согласован системой» без запуска ELMA |

---

#### TC-002: Формула «Выручка отгруженного» — нетто с учётом возвратов

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.5 — Выручка отгруженного = SUM(РТУ) - SUM(Возвраты 60д) |
| **Finding** | B7 |

**Предусловия:**
- ЛС с двумя отгрузками: РТУ-1 на 100 000 руб., РТУ-2 на 50 000 руб.
- Возврат по РТУ-1 на 20 000 руб. в течение 60 дней

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Провести РТУ-1 и РТУ-2 | Накопленная выручка = 150 000 руб. |
| 2 | Провести Возврат по РТУ-1 (в течение 60 дней) | Накопленная выручка пересчитана: 100 000 + 50 000 - 20 000 = 130 000 руб. |
| 3 | Создать Заказ-3 и проверить расчёт накопленной рентабельности | Накопленная рентабельность рассчитана от 130 000 руб. (нетто) |

---

#### TC-003: Блокировка позиции при НПСС=0

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Негативный |
| **Требование** | п. 3.3 — при НПСС=0/NULL позиция блокируется |
| **Finding** | — |

**Предусловия:**
- ЛС с позицией, у которой НПСС = 0

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ, включить позицию с НПСС=0 | Позиция заблокирована |
| 2 | Проверить сообщение менеджеру | Сообщение содержит: какая позиция, причину (НПСС=0), что остальные позиции доступны |
| 3 | Проверить уведомление финслужбе | Уведомление отправлено: номенклатура, номер ЛС |
| 4 | Попытаться провести Заказ с другими позициями той же ЛС | Заказ создаётся без ограничений |

---

#### TC-004: [CRIT-001] Таймаут блокировки LS-BR-035 — проверка противоречия 15 мин vs 5 мин

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Граничный |
| **Требование** | LS-BR-035 (таблица: «15 мин»), п. 3.15 (текст: «5 мин») — CRIT-001 аудита v1.0.4 |
| **Finding** | CRITICAL-001 |

**Предусловия:**
- Менеджер-1 начал создание Заказа по ЛС (ЛС заблокирована)
- Менеджер-2 пытается создать Заказ по той же ЛС

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Менеджер-1 начинает создание Заказа, не совершает действий | ЛС заблокирована; менеджер-2 видит «Заблокировано: [ФИО] до [ЧЧ:ММ]» |
| 2 | Ожидать 5 минут неактивности Менеджера-1 | **Ожидается:** блокировка снята (по п. 3.15 и п. 3.16 = 5 мин) |
| 3 | Зафиксировать фактическое поведение | Если блокировка снята через 5 мин — соответствует основному тексту. Если снята через 15 мин — реализован устаревший таймаут из LS-BR-035. **DEFECT если 15 мин.** |
| 4 | Проверить, что принудительное снятие администратором работает | Администратор открывает «Активные блокировки ЛС», снимает блокировку вручную |

**Примечание:** До устранения CRIT-001 тест имеет неоднозначный критерий. Ожидаемый результат = 5 мин (версия основного текста).

---

#### TC-005: Округление отклонения до сравнения с границами (п. 3.15)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 3.15 — округление до 2 знаков до сравнения; 15.005% → 15.01% → ДП; 15.004% → 15.00% → РБЮ |
| **Finding** | — |

**Тестовые данные:**

| Фактическое отклонение | После округления | Ожидаемый согласующий |
|------------------------|-----------------|----------------------|
| 15.005% | 15.01% | ДП |
| 15.004% | 15.00% | РБЮ |
| 14.995% | 15.00% | РБЮ |
| 25.005% | 25.01% | ГД |
| 25.004% | 25.00% | ДП |
| 0.994% | 0.99% | Согласование не требуется |
| 0.995% | 1.00% | РБЮ |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с отклонением 15.005% | Согласование уровня ДП |
| 2 | Создать Заказ с отклонением 15.004% | Согласование уровня РБЮ |
| 3 | Создать Заказ с отклонением 0.994% | Согласование не требуется |
| 4 | Создать Заказ с отклонением 0.995% | Согласование уровня РБЮ |

---

### Модуль 2: Матрица согласования (п. 3.4)

---

#### TC-006: Позитивный сценарий — согласование РБЮ (отклонение 7 п.п.)

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.4 — 1,00-15,00 п.п. → РБЮ |
| **Finding** | — |

**Предусловия:** ЛС план 35%, (Накопленная + Заказ) = 28%. Отклонение = 7 п.п.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с отклонением 7 п.п. | Заказ переходит в статус «На согласовании» |
| 2 | В ELMA появляется задача для РБЮ | Задача создана: номер Заказа, сумма, отклонение 7 п.п. |
| 3 | РБЮ согласует Заказ | Заказ переходит в статус «Согласован» |
| 4 | Проверить, что уведомление о согласовании отправлено менеджеру | Уведомление получено с вариантами дальнейших действий |

---

#### TC-007: Автоэскалация РБЮ → Директор ДРП после SLA P1

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.6 — РБЮ 4ч → Директор ДРП; для P1 (сумма > 500 т.р.) |
| **Finding** | B1 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ P1 (> 500 т.р.) с отклонением 7 п.п. | Задача РБЮ в ELMA |
| 2 | Подождать 4 рабочих часа без ответа РБЮ | Задача автоматически эскалируется Директору ДРП |
| 3 | Проверить уведомление РБЮ об эскалации | РБЮ получил уведомление |
| 4 | Подождать ещё 4 часа (Директор ДРП не ответил) | Задача эскалируется ДП через суммарно 8 часов |

---

#### TC-008: Автоотказ ГД через 48 часов (п. 3.5.2)

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.5.2 — автоотказ ГД через 48ч, уведомление ФД |
| **Finding** | B5 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с отклонением > 25 п.п. (уровень ГД) | Задача ГД в ELMA |
| 2 | Подождать 48 рабочих часов без ответа ГД | Статус Заказа: «Превышение SLA», автоматический отказ |
| 3 | Проверить уведомление ФД | ФД получил уведомление с пометкой «Требует эскалации» |
| 4 | ФД принимает решение за 3 рабочих дня | ФД может одобрить, направить ГД повторно или подтвердить отказ |
| 5 | Проверить возможность повторной подачи менеджером | Менеджер может повторно подать Заказ |

---

#### TC-009: Автосогласование системой при улучшении рентабельности (п. 3.5.3)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | п. 3.5.3 — автосогласование при улучшении < 1 п.п. во время ожидания |
| **Finding** | B6 |

**Предусловия:** Заказ ждёт согласования РБЮ с отклонением 3 п.п. В это время по той же ЛС отгружен другой Заказ с высокой маржой, улучшивший накопленную рентабельность до < 1 п.п. отклонения.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ-1 находится «На согласовании» (отклонение 3 п.п.) | Задача у РБЮ |
| 2 | Провести Заказ-2 по той же ЛС с высокой маржой | Накопленная рентабельность улучшается |
| 3 | Система пересчитывает (Накопленная + Заказ-1) | (Накопленная + Заказ-1) теперь < 1 п.п. от плана |
| 4 | Проверить, что Заказ-1 автоматически согласован | Статус Заказ-1 = «Согласован», задача в ELMA закрыта |

---

#### TC-010: Исключение дефолта ГД — условие «на момент наступления» (MED-001)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 3.6 — исключение автоотказа ГД, если на момент 48ч (Накоп. + Заказ) >= плановой |
| **Finding** | MED-001 |

**Предусловия:** Заказ ждёт решения ГД 48 часов. За это время по той же ЛС отгружен Заказ с маржой +40 п.п., что привело к (Накоп. + Заказ) >= плана.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ-1 находится «На согласовании» у ГД (36 ч.) | Статус «На согласовании» |
| 2 | Провести Заказ-2 по той же ЛС с маржой +40 п.п. | Накопленная рентабельность достигла плановой |
| 3 | Дождаться 48 часов для Заказа-1 | Система проверяет условие исключения |
| 4 | Проверить, что Заказ-1 НЕ получил автоотказ | Статус = «Согласован автоматически» (условие исключения выполнено) |

---

#### TC-011: SLA для заказов до 100 т.р. — ускоренное согласование

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 3.4.1 — фиксированные SLA <100 т.р.: РБЮ 2ч, ДП 4ч, ГД 12ч |
| **Finding** | B1 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ < 100 т.р. с отклонением 7 п.п. | Задача РБЮ с SLA 2 часа |
| 2 | Подождать 2 ч. без ответа РБЮ | Автоэскалация к Директору ДРП (через 4 ч. суммарно — двойной SLA) |
| 3 | Создать Заказ точно 100 000 руб. с отклонением 7 п.п. | SLA по P1/P2 (НЕ ускоренный), граница включительно проверена |
| 4 | Создать Заказ 99 999 руб. с отклонением 7 п.п. | Ускоренный SLA (2ч РБЮ) |

---

### Модуль 3: Автосогласование и агрегированные лимиты (п. 3.5, 3.7, BIZ-001)

---

#### TC-012: Автосогласование в пределах лимита (5 000 руб./день)

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.5 — автосогласование при отклонении < 1 п.п.; лимит 5 000 руб./день |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с отклонением 0.5 п.п., сумма убытка 3 000 руб. | Автосогласование: статус «Согласован системой», ELMA не запускается |
| 2 | Создать второй Заказ с отклонением 0.5 п.п., убыток 1 500 руб. | Автосогласование (суммарно 4 500 руб. < 5 000) |
| 3 | Создать третий Заказ с любым отклонением, убыток 600 руб. | Суммарно 5 100 руб. > 5 000 → направляется на стандартное согласование |

---

#### TC-013: [НОВОЕ v1.0.4] Агрегированный лимит менеджера — 20 000 руб./день

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Граничный |
| **Требование** | п. 3.7 — агрег. лимит менеджера 20 000 руб./день суммарного убытка по экстренным |
| **Finding** | BIZ-001 |

**Тестовые данные:**

| Заказ | Убыток по экстренному согл. | Накопленный | Ожидание |
|-------|-----------------------------|-------------|----------|
| 1 | 8 000 руб. | 8 000 | Экстренное согласование доступно |
| 2 | 7 000 руб. | 15 000 | Экстренное согласование доступно |
| 3 | 6 000 руб. | 21 000 | Лимит превышен (> 20 000) — стандартное согласование |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Провести экстренные согласования: 8 000 + 7 000 руб. убытка | Оба согласованы (накопл. 15 000 < 20 000) |
| 2 | Попытаться провести третье экстренное (убыток 6 000 руб.) | Сообщение: «Превышен агрегированный лимит менеджера (20 000 руб./день)» |
| 3 | Убедиться, что Заказ направлен на стандартное согласование | ELMA: задача стандартного согласования |
| 4 | В 00:00 следующего дня создать новое экстренное | Лимит сброшен, экстренное согласование снова доступно |

---

#### TC-014: [НОВОЕ v1.0.4] Агрегированный лимит БЮ — 100 000 руб./день

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 3.7 — агрег. лимит БЮ 100 000 руб./день |
| **Finding** | BIZ-001 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | 5 разных менеджеров одного БЮ совершают экстренные согласования по 18 000 руб. каждый | Каждый в пределах личного лимита (< 20 000) — все успешны. Накопл. по БЮ = 90 000 |
| 2 | Шестой менеджер того же БЮ создаёт экстренное с убытком 12 000 | Накопл. 102 000 > 100 000 → стандартное согласование |
| 3 | Проверить, что другие БЮ не затронуты | Менеджеры других БЮ могут использовать экстренное согласование без ограничений |

---

#### TC-015: Экстренное согласование — лимит 10/мес в пиковые периоды

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 3.7 — 3/мес на менеджера, 5/мес на контрагента; пик — до 10 |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Вне пикового периода: 3-е экстренное согласование менеджера в месяц | Согласование доступно (3 <= 3) |
| 2 | Вне пикового периода: 4-е экстренное согласование | Заблокировано: «Исчерпан лимит экстренных согласований (3/мес)» |
| 3 | В пиковый период: 10-е экстренное согласование | Согласование доступно (10 <= 10) |
| 4 | В пиковый период: 11-е экстренное согласование | Заблокировано: «Исчерпан лимит (10/мес в пиковый период)» |

---

#### TC-016: Автоконтроль постфактум экстренного согласования (BIZ-001)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | п. 3.7 — автоконтроль постфактум в течение 24ч; для стратегических клиентов 48ч |
| **Finding** | BIZ-001 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Менеджер проводит экстренное согласование | Заказ отгружен, таймер 24ч запущен |
| 2 | В течение 24ч согласующий не подтверждает | Уведомление согласующему и менеджеру |
| 3 | По истечении 48ч (стратегический клиент) без подтверждения | Уведомление руководству; в отчёте ФД — пометка |
| 4 | Согласующий подтверждает постфактум | Постфактум-статус снят, Заказ отмечен как нормализованный |

---

### Модуль 4: Лимит итераций корректировки цены (п. 3.5.1) — НОВОЕ v1.0.4

---

#### TC-017: [НОВОЕ v1.0.4] Успешная корректировка цены за 1 итерацию

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.5.1 — лимит 5 итераций корректировки; все итерации в аудите |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ на согласовании, согласующий указывает рекомендуемую цену | Цена передана менеджеру как рекомендация |
| 2 | Менеджер вносит рекомендуемую цену, система пересчитывает рентабельность | Отклонение стало < 1 п.п. |
| 3 | Система автоматически согласовывает Заказ | Статус «Согласован», итерация 1 зафиксирована в аудите |

---

#### TC-018: [НОВОЕ v1.0.4] Автоотклонение после 5-й итерации корректировки

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Негативный |
| **Требование** | п. 3.5.1 — после 5-й итерации автоматическое отклонение, Заказ → «Черновик» |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Провести 4 итерации корректировки цены (ни одна не выводит в норму) | Четыре итерации зафиксированы в аудите |
| 2 | Пятая итерация: менеджер вносит цену, которая всё равно не проходит порог | 5-я итерация зафиксирована |
| 3 | Попытка шестой итерации | Заказ автоматически отклоняется (статус «Черновик»), сообщение: «Превышен лимит итераций корректировки цены (5)» |
| 4 | Проверить журнал аудита | Все 5 итераций зафиксированы с датой/временем и ФИО |

---

#### TC-019: Менеджер отклоняет рекомендацию согласующего по цене

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | п. 3.5.1 — менеджер может отклонить рекомендацию |
| **Finding** | B2 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Согласующий указывает рекомендуемую цену | Менеджер получает рекомендацию с вариантами: принять / отклонить |
| 2 | Менеджер нажимает «Отклонить рекомендацию» | Итерация считается использованной |
| 3 | Заказ возвращается на согласование с исходной ценой | Счётчик итераций: 1 из 5 |

---

#### TC-020: EDI-заказ — только «одобрить» или «отклонить» (без корректировки цены)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Негативный |
| **Требование** | п. 3.5.1 — для EDI кнопка «Согласовать с корректировкой цены» недоступна |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | EDI-заказ поступает с отклонением рентабельности | Заказ направляется на согласование |
| 2 | Согласующий видит форму согласования EDI-заказа | Доступны только кнопки «Одобрить» и «Отклонить». Кнопка «Корректировка цены» — скрыта или неактивна |
| 3 | Попытаться провести корректировку цены программным путём | Система блокирует операцию с сообщением «Корректировка цены EDI-заказа недоступна» |

---

### Модуль 5: Перекрёстный контроль шкал при изменении плана ЛС (п. 3.15) — НОВОЕ v1.0.4

---

#### TC-021: [НОВОЕ v1.0.4] Повторная проверка заказов «На согласовании» при снижении плана ЛС

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.15 — при снижении плана ЛС все Заказы «На согласовании» проходят повторную проверку |
| **Finding** | — |

**Предусловия:**
- ЛС с планом 35%. Заказ-1 на согласовании у РБЮ (отклонение 7 п.п. = 28% факт).
- Руководство снижает план ЛС с 35% до 25%.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Изменить плановую рентабельность ЛС: 35% → 25% | Система инициирует перекрёстный контроль |
| 2 | Система пересчитывает отклонение для Заказа-1 | Новое отклонение: 25% - 28% = -3 п.п. (Заказ стал лучше плана) |
| 3 | Проверить, что Заказ-1 автоматически согласован | Заказ-1 получает статус «Согласован» (отклонение < 1 п.п. по новому плану) |

---

#### TC-022: [НОВОЕ v1.0.4] Повышение уровня согласования при изменении плана ЛС

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Негативный |
| **Требование** | п. 3.15 — если уровень согласования по новому плану выше текущего — Заказ на повторное согласование |
| **Finding** | — |

**Предусловия:**
- ЛС с планом 25%. Заказ-1 на согласовании у РБЮ (отклонение 7 п.п.).
- Руководство повышает план ЛС с 25% до 45%.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Изменить плановую рентабельность ЛС: 25% → 45% | Перекрёстный контроль запущен |
| 2 | Система пересчитывает отклонение для Заказа-1 | Новое отклонение: 45% - 28% = 17 п.п. (было 7 п.п. на уровне РБЮ) |
| 3 | Проверить маршрутизацию Заказа-1 | Отклонение 17 п.п. → уровень ДП. Заказ-1 отправлен на повторное согласование к ДП |
| 4 | РБЮ получает уведомление об аннулировании текущей задачи | Уведомление: «Задача аннулирована, отклонение пересчитано» |

---

#### TC-023: [НОВОЕ v1.0.4] Перекрёстный контроль «Согласованных» заказов при изменении плана

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Негативный |
| **Требование** | п. 3.15 — «Согласованные» Заказы также проходят повторную проверку |
| **Finding** | — |

**Предусловия:** Заказ-2 в статусе «Согласован» (ещё не передан на склад). План ЛС повышен с 25% до 45%.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Изменить план ЛС 25% → 45%, Заказ-2 статус «Согласован» | Система запускает перекрёстный контроль для «Согласованных» |
| 2 | Система пересчитывает отклонение Заказа-2 | Новое отклонение 17 п.п. > 15 п.п. — требуется уровень ДП |
| 3 | Статус Заказа-2 изменён | Заказ-2 переходит в «На повторном согласовании» у ДП |
| 4 | Проверить, что передача на склад блокируется до повторного согласования | Попытка передать в WMS — заблокирована |

---

#### TC-024: [НОВОЕ v1.0.4] Точка невозврата — перекрёстный контроль не применяется

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | п. 3.15 — после установки «ПереданНаСклад» Заказ не подлежит повторному согласованию |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ-3 передан на склад (реквизит «ПереданНаСклад» = Истина) | Заказ находится в точке невозврата |
| 2 | Изменить план ЛС | Перекрёстный контроль запускается для других Заказов |
| 3 | Проверить, что Заказ-3 НЕ затронут | Заказ-3 остаётся в текущем статусе без изменений |

---

### Модуль 6: ELMA Fallback (резервный режим) — НОВОЕ v1.0.4

---

#### TC-025: [НОВОЕ v1.0.4] ELMA fallback — автосогласование при отклонении до 5 п.п.

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.13 — резервный режим при недоступности ELMA: до 5 п.п. — автосогласование |
| **Finding** | BIZ-012 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Имитировать недоступность ELMA (системный сбой) | 1С:УТ не может создать задачу в ELMA |
| 2 | Создать Заказ с отклонением 3 п.п. в резервном режиме | Заказ автоматически согласован (до 5 п.п.) с пометкой «Резервный режим» |
| 3 | Проверить уведомление IT-директора | Уведомление об активации резервного режима |
| 4 | Проверить журнал | Все операции резервного режима зафиксированы |

---

#### TC-026: [НОВОЕ v1.0.4] ELMA fallback — очередь FIFO при отклонении свыше 5 п.п.

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | п. 3.13 — при недоступности ELMA: свыше 5 п.п. — очередь FIFO |
| **Finding** | BIZ-012 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | ELMA недоступна. Создать 3 Заказа с отклонением > 5 п.п. в порядке А, Б, В | Все 3 попадают в очередь ожидания FIFO |
| 2 | ELMA восстановлена | Задачи согласования создаются в порядке поступления А, Б, В |
| 3 | Проверить, что при восстановлении ELMA очередь не теряется | Все 3 задачи созданы корректно |
| 4 | Проверить уведомление согласующих | После восстановления ELMA согласующие уведомлены о pending-задачах |

---

#### TC-027: [НОВОЕ v1.0.4] ELMA недоступна > 4 часов — эскалация IT-директору

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Негативный |
| **Требование** | п. 3.13 — при недоступности ELMA > 4 часов — эскалация IT-директору |
| **Finding** | BIZ-012 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | ELMA недоступна, прошло 4 часа | Уведомление IT-директору |
| 2 | Прошло 4 часа в рабочее время | IT-директор получает эскалацию с деталями сбоя |
| 3 | Система продолжает работу в резервном режиме | Операции до 5 п.п. по-прежнему автосогласуются |

---

### Модуль 7: Нагрузка согласующих — два порога (п. 5, HIGH-002, HIGH-003)

---

#### TC-028: Порог 30 задач — автоматический перелив на заместителя

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 5 — при накоплении > 30 задач → перелив на заместителя |
| **Finding** | HIGH-002 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать 30 Заказов на согласовании у РБЮ | 30 задач у РБЮ — перелив ещё не активен |
| 2 | Создать 31-й Заказ на согласовании у того же РБЮ | Новая задача автоматически перенаправляется заместителю РБЮ |
| 3 | Проверить, что РБЮ уведомлён о переливе | Уведомление: «Задачи перенаправлены заместителю [ФИО]» |
| 4 | Проверить, что заместитель назначен из справочника ELMA | Заместитель — тот, что указан в справочнике ELMA |

---

#### TC-029: [HIGH-002] Порог 50 задач — организационное решение

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 5 — при > 50 задач/день на согласующего — назначить дополнительного согласующего |
| **Finding** | HIGH-002 |

**Примечание:** Порог 30 = автоматический оперативный перелив. Порог 50 = организационный лимит.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | РБЮ получает 50 задач за день | 50-я задача: отчёт LS-RPT-072 показывает «норма» |
| 2 | Создать 51-ю задачу за день для того же РБЮ | Отчёт LS-RPT-072 сигнализирует о превышении порога 50/день |
| 3 | Проверить уведомление ДП о перегрузке | ДП получает уведомление: «Согласующий [ФИО]: 51 задача/день, превышен порог 50» |
| 4 | Убедиться, что порог 30 (перелив) и порог 50 (оргрешение) не путаются | Перелив активируется при > 30, сигнал перегрузки — при > 50. Два разных механизма. |

---

#### TC-030: Назначение заместителя при отсутствии согласующего > 4 часов

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | п. 3.6 — при отсутствии согласующего > 4ч — переназначение заместителю из справочника ELMA |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Отметить РБЮ отсутствующим в ELMA (отпуск) | Задачи перенаправляются заместителю сразу |
| 2 | Проверить, что задачи нового Заказа попадают к заместителю | Задача у заместителя РБЮ |
| 3 | Проверить, что возврат РБЮ из отпуска переключает задачи обратно | При снятии статуса «отсутствует» новые задачи снова к РБЮ |

---

### Модуль 8: Отчёты пилота (LS-RPT-072, 073, 074) — НОВОЕ v1.0.4

---

#### TC-031: [НОВОЕ v1.0.4] LS-RPT-072 — два порога нагрузки в одном отчёте (HIGH-003)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | LS-RPT-072 — отчёт нагрузки согласующих; порог перелива 30 и лимит 50 |
| **Finding** | HIGH-003 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Открыть отчёт LS-RPT-072 | Отчёт показывает нагрузку по каждому согласующему |
| 2 | Найти согласующего с 35 задачами | Отчёт подсвечивает жёлтым (перелив активен, < 50) |
| 3 | Найти согласующего с 55 задачами | Отчёт подсвечивает красным (превышен лимит 50/день) |
| 4 | **Проверить наличие обоих порогов в легенде отчёта** | Отчёт содержит оба порога: 30 (перелив) и 50 (лимит). Если только один — DEFECT (HIGH-003) |

---

#### TC-032: [НОВОЕ v1.0.4] LS-RPT-073 — базовый замер KPI (100+ ЛС, 6 мес.)

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | LS-RPT-073 — отчёт базового замера KPI перед запуском пилота |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Открыть отчёт LS-RPT-073 | Отчёт содержит данные по 100+ закрытым ЛС за 6 мес. |
| 2 | Проверить наличие базовых KPI в отчёте | Показатели: % отгруженных ЛС ниже плановой рентабельности, средняя потеря маржи/ЛС |
| 3 | Отчёт при < 100 ЛС | Предупреждение: «Недостаточно данных для базового замера (N < 100 ЛС)» |

---

#### TC-033: [НОВОЕ v1.0.4] LS-RPT-074 — промежуточный отчёт пилота (через 1 мес.)

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | LS-RPT-074 — если доля проигнорированных предупреждений > 50%, рабочая группа за 5 р.д. |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Открыть LS-RPT-074 через 1 мес. пилота | Отчёт содержит: кол-во предупреждений, кол-во проигнорированных, долю |
| 2 | Смоделировать 60% игнорирования предупреждений | Доля > 50% → система инициирует уведомление о созыве рабочей группы за 5 р.д. |
| 3 | Смоделировать 40% игнорирования | Доля < 50% → уведомление не создаётся |

---

### Модуль 9: Автотриггеры НПСС (LS-BR-075) — НОВОЕ v1.0.4

---

#### TC-034: [НОВОЕ v1.0.4] Автотриггер пересчёта НПСС при курсе ЦБ > 5% за 7 дней

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | LS-BR-075 — пересчёт НПСС при курсе ЦБ РФ > 5% за 7 дней (USD/EUR/CNY) |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Смоделировать изменение курса USD/ЦБ на +5.1% за 7 дней | Регламентное задание обнаруживает триггер |
| 2 | Проверить запуск пересчёта НПСС | НПСС пересчитана для номенклатуры с USD-составляющей |
| 3 | Проверить уведомление финслужбы | Уведомление: «НПСС пересчитана, причина: курс USD вырос на 5.1%» |
| 4 | Смоделировать изменение курса на 4.9% за 7 дней | Триггер НЕ срабатывает (< 5%) |

---

#### TC-035: [НОВОЕ v1.0.4] Автотриггер НПСС при закупочной цене > 15%

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | LS-BR-075 — пересчёт НПСС при отклонении закупочной цены > 15% |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Провести поступление товара с закупочной ценой на 16% выше предыдущей | Автотриггер обнаружен |
| 2 | Проверить запуск пересчёта НПСС для этой номенклатуры | НПСС пересчитана, дата пересчёта обновлена в регистре |
| 3 | Открытые Заказы на согласовании с этой номенклатурой | Заказы проверяются по новой НПСС (пересчёт рентабельности) |
| 4 | Изменение на 14.9% | Триггер НЕ срабатывает |

---

### Модуль 10: Блокировки и конкурентность (LS-BR-035, п. 3.15)

---

#### TC-036: Два пользователя редактируют одну ЛС — блокировка

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Негативный |
| **Требование** | LS-BR-035 — пессимистичная блокировка; сообщение второму пользователю |
| **Finding** | CRITICAL-001 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Менеджер-1 начинает создание Заказа по ЛС | ЛС заблокирована для редактирования |
| 2 | Менеджер-2 пытается создать Заказ по той же ЛС | Сообщение: «ЛС редактируется пользователем [ФИО]. Повторите попытку позже» |
| 3 | Проверить формат отображения таймера | Отображается: «Заблокировано: [ФИО] до [ЧЧ:ММ]» |
| 4 | Менеджер-1 сохраняет Заказ | Блокировка снята сразу |
| 5 | Менеджер-2 повторяет попытку | Создание Заказа успешно |

---

#### TC-037: Просмотр ЛС при наличии блокировки — не блокируется

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | LS-BR-035 — просмотр ЛС и отчётов не блокируется |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Менеджер-1 редактирует Заказ (ЛС заблокирована) | — |
| 2 | Менеджер-2 открывает ЛС в режиме просмотра | Просмотр доступен без ожидания |
| 3 | Менеджер-2 открывает отчёт по ЛС | Отчёт открывается: остаток актуальный, без учёта черновика менеджера-1 |

---

### Модуль 11: Sanctions и закрытие ЛС (п. 3.12, 3.18)

---

#### TC-038: Фоновое задание пересчёта санкций — retry 3x15 мин (B4)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | п. 3.18 — санкции: 02:00 МСК, retry 3x15 мин, таймаут 2ч, алерт ФД |
| **Finding** | B4 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Имитировать сбой при первом запуске фонового задания (02:00) | Задание фиксирует ошибку |
| 2 | Первая повторная попытка через 15 мин (02:15) — тоже сбой | Зафиксирована 2-я ошибка |
| 3 | Вторая повторная попытка (02:30) — успех | Санкции пересчитаны |
| 4 | Все три попытки неуспешны | После 3-й попытки — алерт ФД |

---

#### TC-039: Санкции — срок ввода блокирующего контроля (не позднее 1 мес. после Этапа 2)

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | п. 3.18 — срок ввода санкций: не позднее 1 мес. после перехода на блокирующий контроль |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Система переходит на Этап 2 (блокирующий контроль) | Таймер «1 мес. до ввода санкций» запущен |
| 2 | До истечения 1 мес. | Санкции в информационном режиме |
| 3 | По истечении 1 мес. без настройки санкций | Уведомление ответственным |

---

### Модуль 12: Интеграции (WMS, ELMA, EDI)

---

#### TC-040: Интеграция 1С:УТ → WMS при статусе «Согласован»

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Интеграционный |
| **Требование** | LS-INT-001 — JSON, таймаут 30 сек, 3 попытки |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ перешёл в статус «Согласован» | 1С:УТ отправляет JSON-сообщение в WMS |
| 2 | WMS недоступна, 1-я попытка — таймаут | Повторная попытка через 30 сек |
| 3 | 3-я попытка — таймаут | Уведомление: «WMS недоступна, требуется ручное вмешательство» |
| 4 | WMS доступна, 1-я попытка — успех | Сообщение отправлено, комплектация запущена |

---

#### TC-041: Интеграция WMS → 1С:УТ — фактическое количество при расхождении

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Интеграционный |
| **Требование** | LS-INT-002 — при расхождении факт/план → уведомление в 1С:УТ |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | WMS завершает комплектацию: план 100 ед., факт 85 ед. | Сообщение в 1С:УТ с фактическим количеством 85 ед. |
| 2 | Проверить пересчёт рентабельности с 85 ед. | Рентабельность пересчитана, менеджер уведомлён о расхождении |
| 3 | Расхождение приводит к нарушению порога | Создаётся новое согласование для остатка |

---

#### TC-042: EDI-заказ — разделение по ЛС (LS-FR-049a, 049b, 049c)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Интеграционный |
| **Требование** | LS-FR-049a/b/c — EDI разделяется по ЛС; привязка к одной ЛС |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Получить EDI-заказ с товарами из двух ЛС | Система автоматически разделяет на два под-заказа по ЛС |
| 2 | Попытаться вручную изменить привязку позиции к другой ЛС | Операция заблокирована (EDI-привязка зафиксирована клиентом) |
| 3 | Одна из частей EDI нарушает рентабельность | Доступны «Одобрить» / «Отклонить», кнопка корректировки цены — скрыта |

---

### Модуль 13: Мульти-БЮ (LS-FR-047, 048)

---

#### TC-043: Параллельное согласование мульти-БЮ — статус «Согласован» только при 100%

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | LS-FR-047 — параллельное согласование; статус «Согласован» только при согласовании всех РБЮ |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с позициями из 3 БЮ, все с отклонением > 1 п.п. | 3 параллельные задачи созданы для 3 РБЮ |
| 2 | РБЮ-1 и РБЮ-2 согласовали | Статус = «Частично согласован» (не «Согласован») |
| 3 | РБЮ-3 согласовал | Статус = «Согласован» |

---

#### TC-044: Мульти-БЮ — один РБЮ отклонил

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Негативный |
| **Требование** | LS-FR-048 — при отказе одного РБЮ: удалить позиции или отменить Заказ |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | РБЮ-1 согласовал, РБЮ-2 отклонил | Статус = «Частично согласован» |
| 2 | Менеджер выбирает «Удалить позиции БЮ-2» | Позиции БЮ-2 удалены, Заказ содержит только согласованные позиции |
| 3 | Менеджер выбирает «Отменить Заказ» | Заказ аннулируется, статус = «Черновик» |
| 4 | Арбитраж Директора ДРП при расхождении РБЮ разных БЮ | Заказ эскалируется Директору ДРП |

---

### Модуль 14: Права доступа и безопасность (LS-SEC-001)

---

#### TC-045: RLS — менеджер видит только свои Заказы своего БЮ

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Негативный |
| **Требование** | LS-SEC-001 — RLS по БЮ; менеджер не видит Заказы чужого БЮ |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Менеджер-1 (БЮ-А) открывает список Заказов | Видит только Заказы БЮ-А |
| 2 | Попытаться прямым запросом получить Заказ БЮ-Б | Доступ заблокирован, ошибка «Нет доступа» |
| 3 | РБЮ открывает список Заказов на согласовании | Видит Заказы своего БЮ; Директор ДРП видит все эскалированные |

---

#### TC-046: Специалист товарообмена — удаление Заказа «На согласовании»

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | п. 3.11 — удаление согласованного Заказа требует подтверждения РБЮ, журналируется |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Специалист товарообмена пытается удалить Заказ «Согласован» | Запрос на подтверждение отправлен РБЮ |
| 2 | РБЮ подтверждает удаление | Заказ удалён |
| 3 | Проверить журнал аудита | Запись: кто удалил, когда, подтверждение РБЮ |
| 4 | Обычный менеджер пытается удалить Заказ «Согласован» | Заблокировано: нет прав |

---

### Модуль 15: Тесты на манипуляции и обходы контроля

---

#### TC-047: [MANIP] Попытка дробления одного крупного заказа на несколько мелких для обхода согласования

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Манипуляция |
| **Требование** | п. 3.4 — контроль по накопленной рентабельности ЛС |
| **Finding** | — |

**Сценарий:** Менеджер разбивает заказ на 5 частей, каждая из которых в отдельности не нарушает порог.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ-1 (20% ЛС) с рентабельностью 28% (отклонение 7 п.п.) | Согласование требуется (отклонение > 1 п.п.) |
| 2 | Провести Заказ-1 через согласование | Накопленная рентабельность ухудшилась |
| 3 | Создать Заказ-2 (ещё 20% ЛС) с той же структурой | Система учитывает накопленную: (Накоп. + Заказ-2) < план → требуется согласование |
| 4 | Убедиться, что дробление не обходит контроль | Каждый последующий Заказ проверяется с учётом уже отгруженного |

---

#### TC-048: [MANIP] Попытка изменить цену задним числом в проведённом Заказе

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Манипуляция |
| **Требование** | п. 3.11 — точка невозврата после передачи на склад |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ передан на склад («ПереданНаСклад» = Истина) | — |
| 2 | Менеджер пытается изменить цену в Заказе | Заблокировано: «Заказ передан на склад, редактирование невозможно» |
| 3 | Специалист товарообмена пытается изменить цену | Заблокировано; требуется сторнирование через специальную процедуру (п. 3.14) |

---

#### TC-049: [MANIP] Попытка использовать экстренное согласование при нулевой рентабельности

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Манипуляция |
| **Требование** | п. 3.7 — при убыточном отклонении: только стандартное согласование |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с рентабельностью -5% (отрицательная) | Система отображает: «Рентабельность отрицательная. Требуется согласование ГД» |
| 2 | Попытаться использовать экстренное согласование | Кнопка экстренного согласования — недоступна (только стандартное) |
| 3 | Попытаться обойти через EDI-заказ | Та же блокировка для EDI с отрицательной рентабельностью |

---

#### TC-050: [MANIP] Манипуляция с НПСС — попытка занизить для обхода контроля

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Манипуляция |
| **Требование** | LS-SEC-001 — изменение НПСС требует прав финслужбы |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Менеджер пытается изменить НПСС позиции напрямую | Заблокировано: нет прав на изменение НПСС |
| 2 | Финансовый специалист изменяет НПСС | Изменение разрешено, но фиксируется в журнале аудита |
| 3 | После изменения НПСС — перепроверить открытые Заказы | Открытые Заказы пересчитываются по новой НПСС |

---

#### TC-051: [MANIP] Попытка повторной подачи Заказа после автоотказа ГД без устранения причины

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Манипуляция |
| **Требование** | п. 3.5.2 — повторная подача Заказа после автоотказа ГД |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ получил автоотказ (48ч ГД) | Статус «Превышение SLA» |
| 2 | Менеджер повторно подаёт Заказ без изменений | Заказ принят к повторному рассмотрению (нет ограничений на повторную подачу) |
| 3 | ГД снова не отвечает 48ч | Второй автоотказ; счётчик автоотказов виден в отчёте ФД |

---

#### TC-052: [MANIP] Попытка превысить лимит итераций корректировки цены

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Манипуляция |
| **Требование** | п. 3.5.1 — не более 5 итераций |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Провести 5 итераций корректировки, ни одна не приводит к норме | 5-я итерация зафиксирована |
| 2 | Согласующий пытается создать 6-ю итерацию | Заблокировано: «Превышен лимит итераций (5). Заказ отклонён» |
| 3 | Менеджер пытается вручную сбросить счётчик итераций | Счётчик не сбрасывается пользователем; только создание нового Заказа |

---

#### TC-053: [MANIP] Подача Заказа в нерабочее время для обхода SLA

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Манипуляция |
| **Требование** | п. 3.6 — SLA считается в рабочих часах (09:00-18:00 МСК) |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Подать Заказ на согласование в 17:58 (за 2 мин до конца рабочего дня) | Заказ принят, таймер SLA = 2 мин рабочего времени сегодня |
| 2 | Следующий рабочий день 09:00 | Таймер продолжает с 09:00, всего использовано 2 мин из SLA |
| 3 | Убедиться, что ночное время не включается в SLA | Отсчёт SLA прерывается в 18:00 и возобновляется в 09:00 |

---

#### TC-054: [MANIP] Попытка выбора «правильного» момента для снижения плана ЛС (обход перекрёстного контроля)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Манипуляция |
| **Требование** | п. 3.15 — перекрёстный контроль при изменении плана ЛС |
| **Finding** | — |

**Сценарий:** Менеджер пытается снизить план ЛС в момент, когда все Заказы по ней уже отгружены (в статусе «ПереданНаСклад»), чтобы последующие Заказы проходили с меньшим контролем.

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Все текущие Заказы по ЛС — «ПереданНаСклад» | Нет открытых Заказов для перекрёстного контроля |
| 2 | Руководство снижает план ЛС с 35% до 20% | Изменение фиксируется в журнале аудита с датой и автором |
| 3 | Создать новый Заказ по ЛС с отклонением 14 п.п. (от нового плана) | При старом плане 35% → отклонение было бы 21 п.п. (уровень ДП). При новом 20% → 6 п.п. (РБЮ) |
| 4 | Проверить журнал изменений плана ЛС | Все изменения плана видны в истории; ФД получает уведомление об изменении |

---

### Модуль 16: Производительность и нагрузка

---

#### TC-055: Время обработки Заказа в пиковый период (50-70 пользователей)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Производительность |
| **Требование** | LS-NFR — время проведения при 50-70 одновременных пользователях |
| **Finding** | BIZ-003 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать нагрузку: 50 пользователей, 30 Заказов/мин | Система работает без деградации |
| 2 | Создать Заказ с автосогласованием (< 1 п.п.) при нагрузке | Время создания + согласования < 3 секунд |
| 3 | Создать Заказ с отправкой в ELMA при нагрузке | Время создания задачи в ELMA < 5 секунд |
| 4 | Сформировать отчёт LS-RPT-072 при нагрузке | Время формирования < 10 секунд |

---

#### TC-056: Проведение Заказа в конце отчётного периода

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Производительность |
| **Требование** | LS-NFR — стабильность в конце периода |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Последний рабочий день месяца, 17:30 | Пиковая нагрузка на систему |
| 2 | Провести 100 Заказов за 1 час при нагрузке 70 пользователей | Все проведены без deadlock |
| 3 | Запустить регламентное задание пересчёта санкций | Задание выполнено в рамках 2-часового таймаута |

---

#### TC-057: Очередь согласования при 420 задачах на РБЮ

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Производительность |
| **Требование** | п. 5 — BIZ-003: перегрузка до 420 задач/день на РБЮ в пики |
| **Finding** | BIZ-003 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать 420 задач согласования у одного РБЮ | Перелив срабатывает > 30, уведомление > 50 |
| 2 | При 30+ задачах заместители подключены | Нагрузка распределена |
| 3 | Отчёт LS-RPT-072 при 420 задачах | Формируется корректно, не зависает |

---

### Модуль 17: Переходы состояний (State Transitions)

---

#### TC-058: Полный жизненный цикл Заказа — happy path

| Поле | Значение |
|------|----------|
| **Приоритет** | Критический |
| **Тип** | Позитивный |
| **Требование** | Статусная модель — 11 статусов |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ | Статус «Черновик» |
| 2 | Заказ без отклонений | Статус «Согласован системой» (без согласования) |
| 3 | Передать Заказ на склад | «ПереданНаСклад» = Истина |
| 4 | WMS завершила комплектацию | Статус «Готов к отгрузке» |
| 5 | Создать РТУ | Статус «Отгружен» |

---

#### TC-059: Невалидный переход — Заказ «Отгружен» → «Черновик»

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Негативный |
| **Требование** | Статусная модель — невалидные переходы заблокированы |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ в статусе «Отгружен» | — |
| 2 | Попытка перевести в «Черновик» | Заблокировано: «Некорректный переход статуса» |
| 3 | Попытка изменить позиции в «Отгружен» | Заблокировано |

---

#### TC-060: Повторная проверка согласования — срок действия 5 р.д.

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 3.6 — согласование действительно 5 р.д. |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ получил статус «Согласован» | Таймер 5 р.д. запущен |
| 2 | На 5-й рабочий день передать Заказ в работу | Успешно (срок не истёк) |
| 3 | Не переводить Заказ 5 р.д. | По истечении 5 р.д. — согласование аннулируется |
| 4 | Проверить уведомление менеджеру | Уведомление: «Согласование аннулировано, требуется повторная подача» |

---

### Модуль 18: Piloting Ready Checks (п. 5)

---

#### TC-061: НПСС заполнена для пилотных БЮ — минимум 80%

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Позитивный |
| **Требование** | п. 5 — условие готовности к пилоту: НПСС >= 80% номенклатуры |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Открыть отчёт готовности к пилоту | Показывает % заполненности НПСС |
| 2 | НПСС = 75% номенклатуры | Статус: «Не готово к пилоту (75% < 80%)» |
| 3 | НПСС = 80% номенклатуры | Статус: «Готово к пилоту по НПСС» |
| 4 | НПСС = 100% | Статус: «Полная готовность» |

---

#### TC-062: Базовый замер — анализ 100+ закрытых ЛС за 6 мес.

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | п. 5, LS-RPT-073 — базовый замер перед пилотом |
| **Finding** | BIZ-008 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Запустить отчёт LS-RPT-073 при 120 ЛС за 6 мес. | Отчёт сформирован: текущий уровень потерь, % ЛС ниже плана |
| 2 | Результат зафиксирован как базовый | Baseline сохранён, использован для сравнения post-pilot |

---

### Модуль 19: Gherkin — автоматизированные тесты (Vanessa Automation)

---

#### TC-063: Gherkin — блокировка заказа при отклонении, happy path

```gherkin
# language: ru
Функциональность: Матрица согласования рентабельности FM-LS-PROFIT

  Контекст:
    Дано в системе существует ЛС "ЛС-2026-001" с плановой рентабельностью 35%
    И НПСС для всех позиций заполнена

  Сценарий: Заказ без отклонения согласуется системой автоматически
    Дано я вхожу в систему как "Менеджер по продажам"
    И существует Заказ с рентабельностью 35% по ЛС "ЛС-2026-001"
    Когда я сохраняю Заказ
    Тогда статус Заказа становится "Согласован системой"
    И задача согласования в ELMA не создается

  Сценарий: Заказ с отклонением 7 п.п. направляется к РБЮ
    Дано я вхожу в систему как "Менеджер по продажам"
    И существует Заказ с рентабельностью 28% (отклонение 7 п.п.) по ЛС "ЛС-2026-001"
    Когда я сохраняю Заказ
    Тогда статус Заказа становится "На согласовании"
    И задача согласования создана у РБЮ в ELMA
    И уведомление с обратным отсчетом SLA отправлено менеджеру

  Структура сценария: Граничные значения матрицы согласования
    Дано рентабельность Заказа составляет <рентабельность>%
    И плановая рентабельность ЛС = 35%
    Когда я сохраняю Заказ
    Тогда система <результат>

    Примеры:
      | рентабельность | результат                                    |
      | 34.01          | автоматически согласовывает Заказ (откл. 0.99 п.п.) |
      | 34.00          | направляет к РБЮ (откл. 1.00 п.п.)          |
      | 20.00          | направляет к РБЮ (откл. 15.00 п.п.)         |
      | 19.99          | направляет к ДП (откл. 15.01 п.п.)          |
      | 10.00          | направляет к ДП (откл. 25.00 п.п.)          |
      | 9.99           | направляет к ГД (откл. 25.01 п.п.)          |
```

---

#### TC-064: Gherkin — агрегированный лимит менеджера

```gherkin
# language: ru
Функциональность: Агрегированный лимит экстренных согласований

  Сценарий: Превышение агрегированного лимита менеджера 20000 руб./день
    Дано я вхожу в систему как "Менеджер Иванов" с БЮ "Юг"
    И сегодня я уже использовал экстренное согласование на 18000 рублей убытка
    Когда я пытаюсь провести новое экстренное согласование с убытком 3000 рублей
    Тогда система блокирует экстренное согласование
    И отображает сообщение "Превышен агрегированный лимит менеджера (20 000 руб./день)"
    И Заказ направляется на стандартное согласование

  Сценарий: Лимит менеджера в пределах нормы
    Дано я вхожу в систему как "Менеджер Иванов"
    И сегодня я использовал экстренное согласование на 10000 рублей убытка
    Когда я провожу новое экстренное согласование с убытком 8000 рублей
    Тогда экстренное согласование доступно
    И суммарный лимит составляет 18000 руб. (из 20000 доступных)
```

---

#### TC-065: Gherkin — ELMA fallback при сбое

```gherkin
# language: ru
Функциональность: Резервный режим при недоступности ELMA

  Сценарий: Автосогласование в резервном режиме при отклонении до 5 п.п.
    Дано ELMA недоступна более 0 минут
    И существует Заказ с отклонением 3 процентного пункта
    Когда менеджер сохраняет Заказ
    Тогда Заказ автоматически согласован с пометкой "Резервный режим"
    И уведомление об активации резервного режима отправлено IT-директору

  Сценарий: Очередь FIFO при отклонении свыше 5 п.п. в резервном режиме
    Дано ELMA недоступна
    И существует Заказ с отклонением 10 процентных пунктов
    Когда менеджер сохраняет Заказ
    Тогда Заказ помещен в очередь ожидания FIFO
    И менеджер видит сообщение "ELMA временно недоступна. Заказ в очереди ожидания"

  Сценарий: Эскалация IT-директору при сбое ELMA свыше 4 часов
    Дано ELMA недоступна в течение 4 рабочих часов
    Тогда система отправляет эскалацию IT-директору
    И журнал фиксирует время начала сбоя и длительность
```

---

#### TC-066: Gherkin — перекрёстный контроль шкал

```gherkin
# language: ru
Функциональность: Перекрёстный контроль при изменении плана ЛС

  Сценарий: Заказ на согласовании повышается до уровня ДП при изменении плана
    Дано существует ЛС с плановой рентабельностью 25%
    И Заказ-1 находится "На согласовании" у РБЮ с фактической рентабельностью 18%
    Когда руководство изменяет плановую рентабельность ЛС с 25% на 45%
    Тогда система пересчитывает отклонение Заказа-1: 45% - 18% = 27 п.п.
    И Заказ-1 переходит на согласование к ГД (отклонение > 25 п.п.)
    И РБЮ получает уведомление об аннулировании текущей задачи

  Сценарий: Заказ "Согласован" возвращается на повторное согласование
    Дано существует ЛС с плановой рентабельностью 25%
    И Заказ-2 имеет статус "Согласован" (не передан на склад), рентабельность 18%
    Когда руководство изменяет план ЛС с 25% до 45%
    Тогда Заказ-2 переходит в статус "На повторном согласовании"
    И передача в WMS заблокирована до повторного согласования
```

---

### Модуль 20: GAP-тесты (выявление пробелов ФМ)

---

#### TC-067: [GAP] HIGH-001 — Проверка соответствия числа P1-требований

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | HIGH-001 — текст: «61 требование P1», фактически ~64 |
| **Finding** | HIGH-001 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Подсчитать все P1-требования в таблице раздела 6 | Фактическое число = ~64 (LS-BR-001..LS-FR-049c, LS-INT-001..003, LS-NFR-001..004, LS-SEC-001, LS-RPT-068..071, LS-FR-070, LS-BR-075, LS-RPT-072..074) |
| 2 | Сравнить с заявленным числом «61» в тексте приоритизации | **DEFECT:** расхождение 3 требования. До исправления не использовать для планирования |
| 3 | Приёмочный критерий | Число в тексте совпадает с фактическим подсчётом (ожидается ~64 после правки HIGH-001) |

---

#### TC-068: [GAP] GAP-02 — Гонка: одновременный пересчёт НПСС и согласование по ЛС

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Граничный |
| **Требование** | GAP-02 — поведение при race condition пересчёта НПСС |
| **Finding** | GAP-02 |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Одновременно: согласующий просматривает Заказ (НПСС = 650) | Согласующий видит рентабельность на момент просмотра |
| 2 | В тот же момент: финслужба запускает пересчёт НПСС (новая = 700) | Пересчёт НПСС запущен |
| 3 | Согласующий принимает решение | **Вопрос:** по какой НПСС зафиксировано решение? |
| 4 | Ожидаемое поведение (требует уточнения) | ФМ не определяет: зафиксированная НПСС на момент создания Заказа или актуальная? **OPEN QUESTION** |

---

#### TC-069: [GAP] Проверка поведения при пустой базе (нет НПСС)

| Поле | Значение |
|------|----------|
| **Приоритет** | Высокий |
| **Тип** | Граничный |
| **Требование** | п. 3.3 — при НПСС=NULL позиция блокируется |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Создать Заказ с новой номенклатурой (НПСС не заполнена) | Блокировка позиции, уведомление финслужбы |
| 2 | Попытаться провести Заказ с заблокированными позициями | Проведение невозможно |
| 3 | Финслужба заполняет НПСС | Менеджер перезапускает создание Заказа |

---

#### TC-070: [GAP] Срок действия согласования — ровно 5 рабочих дней

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Граничный |
| **Требование** | п. 3.6 — согласование действительно 5 р.д. |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Заказ согласован в пятницу в 17:59 | Таймер 5 р.д. запущен |
| 2 | Следующий вторник (5-й р.д.) в 09:01 — перевести в работу | Согласование ещё действительно |
| 3 | Следующий вторник в 17:59 (конец 5-го р.д.) | Граничный момент: согласование должно действовать |
| 4 | Следующая среда (6-й р.д.) | Согласование аннулировано |

---

#### TC-071: [GAP] Проверка приоритизации очереди согласования (FIFO vs сумма)

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Граничный |
| **Требование** | п. 3.6 — приоритизация по сумме Заказа (убывание), при равных — FIFO |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | В очереди: Заказ-А (100 000 руб.), Заказ-Б (500 000 руб.), Заказ-В (500 000 руб.) | — |
| 2 | Согласующий открывает очередь | Порядок: Заказ-Б или В (500 000 > 100 000) |
| 3 | Заказ-Б и Заказ-В поступили одновременно | FIFO между равными суммами: Заказ-Б выше Заказа-В |

---

#### TC-072: [GAP] Стратегический клиент — допустимое отклонение от стандартных порогов

| Поле | Значение |
|------|----------|
| **Приоритет** | Средний |
| **Тип** | Позитивный |
| **Требование** | п. 2.1, п. 3.18 — стратегические клиенты: иные пороги рентабельности |
| **Finding** | — |

| # | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Клиент включён в реестр «Стратегические клиенты» | Реестр содержит допустимые отклонения |
| 2 | Создать Заказ для стратегического клиента с нестандартным отклонением | Система применяет параметры из реестра стратегических клиентов |
| 3 | Проверить журнал | Пометка «Стратегический клиент» в решении о согласовании |

---

## Тестовые данные

| Сущность | Атрибут | Тестовые значения |
|----------|---------|-------------------|
| ЛС | Плановая рентабельность | 0%, 5%, 20%, 25%, 35%, 50%, -5% (убыточная) |
| Заказ | Сумма | 0, 99 999, 100 000, 100 001, 499 999, 500 000, 500 001 руб. |
| Заказ | Отклонение | -0.01, 0, 0.99, 1.00, 15.00, 15.01, 25.00, 25.01, 30, 50 п.п. |
| НПСС | Значение | 0, NULL, 650, 700, 1 000 руб. |
| Итерации корректировки | Счётчик | 0, 1, 4, 5, 6 |
| Нагрузка согласующего | Задач | 0, 1, 29, 30, 31, 49, 50, 51, 420 |
| Агрег. лимит менеджера | Убыток | 0, 15 000, 19 999, 20 000, 20 001 руб. |
| Агрег. лимит БЮ | Убыток | 0, 80 000, 99 999, 100 000, 100 001 руб. |
| Таймаут блокировки | Минуты | 4, 5, 6, 14, 15, 16 мин. |
| Срок согласования | Рабочие дни | 1, 4, 5, 6 р.д. |
| Лимит экстренных | Месяц | 0, 2, 3, 4 (вне пика); 0, 9, 10, 11 (в пике) |
| НПСС авт. триггер | Курс валюты | +4.9%, +5.0%, +5.1% за 7 дней |
| НПСС авт. триггер | Закупочная цена | +14.9%, +15.0%, +15.1% |
| ELMA Fallback | Отклонение | 0, 3, 5, 5.01, 10 п.п. |
| Базовый замер | ЛС | 50, 99, 100, 101, 200 |
| Пилот | Предупреждения игнор. | 30%, 50%, 51%, 70% |

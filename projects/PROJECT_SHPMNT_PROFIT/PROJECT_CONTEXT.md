# PROJECT_CONTEXT — PROJECT_SHPMNT_PROFIT

## Ключевые параметры
- **Код ФМ:** FM-LS-PROFIT
- **Версия:** v1.0.7 (ВСЕГДА проверять актуальную через Confluence API!)
- **Конфигурация:** 1С:УТ + 1С:ДО + WMS
- **Пользователи системы:** 50-70 одновременных
- **Цель:** Контроль рентабельности при частичных отгрузках по ЛС
- **Проблема:** Cherry-picking - выборочный выкуп низкомаржинальных позиций

## Текущий статус
- Аудит: выполнен (Agent 1) - v1.0.0 → v1.0.1
- Симуляция ролей: выполнена (Agent 2)
- Тесты: выполнены (Agent 4)
- Архитектура: выполнена (Agent 5)

## Confluence
- PAGE_ID: 83951683
- URL страницы: https://confluence.ekf.su/pages/viewpage.action?pageId=83951683
- Версия страницы: 35
- Статус согласования: не начато

---

### 09.02.2026 — AGENT_1_ARCHITECT: /audit

**Проверено:** Полный аудит FM-LS-PROFIT v1.0.0 (Confluence версия 26)

**Контекст интервью:**
- Приоритет: баланс скорости и контроля
- Нельзя замедлять: отгрузку товара
- Известные манипуляции: изменение скидок/цен после согласования + отгрузка без оплаты
- Фокус: полный аудит

**Предыдущий аудит (v2.5.4):** 18 из 19 замечаний закрыты. Остаточное - CRIT-001 (FAQ 30д vs 60д).

**Найдено:**
- [CRIT-001] FAQ: срок учета возвратов 30д vs 60д → ИСПРАВЛЕНО (60д)
- [HIGH-001] Противоречие в условиях дефицита 30 vs 60 дней → ИСПРАВЛЕНО (60д)
- [HIGH-002] Не определен диапазон рабочих часов → ИСПРАВЛЕНО (09:00-18:00 МСК)
- [HIGH-003] Приоритизация P1/P2 неоднозначна → ИСПРАВЛЕНО (колонка в таблице)
- [MED-001..005] 5 замечаний средней критичности → ИСПРАВЛЕНЫ
- [LOW-001..004] 4 замечания низкой критичности → 3 исправлены, 1 отложен (LOW-003)
- [GAP-01..03] 3 пробела → не применены (за рамками ФМ / низкий приоритет)

**Решения:**
- Срок учета возвратов: 60 дней (единый)
- Рабочие часы: 09:00-18:00 МСК
- Роль администратора: за рамками ФМ

**Результат:** 12 правок применены в Confluence → v1.0.1 (версия страницы 27). Верификация: 20/20 проверок пройдено.

**Открытые вопросы:**
- [ ] LOW-003: Минимальная сумма ЛС (требует бизнес-решения)
- [ ] GAP-02: Мониторинг регламентных заданий (низкий приоритет)
- [ ] GAP-03: Служебные пользователи и контроль (низкий приоритет)

---

### 09.02.2026 — AGENT_1_ARCHITECT: /audit (повторный)

**Проверено:** Повторный полный аудит FM-LS-PROFIT v1.0.1 (Confluence версия 31)

**Предыдущий аудит (v1.0.0):** 10 из 12 правок закрыты, 2 остатка (LOW-002, LOW-004).

**Найдено (новые):**
- [MED-001] Пропуск нумерации требований 067-069 → ИСПРАВЛЕНО (перенумерация)
- [MED-002] P1/P2 сводка неполная (35 из 57 P1 отсутствовали) → ИСПРАВЛЕНО
- [MED-003] LS-RPT-XXX в таблице кодов → СНЯТО (корректная заглушка)
- [LOW-001] Англицизмы: Phase, cherry-picking, retry → ИСПРАВЛЕНО
- [LOW-002r] Остаток: ПереданНаСклад → ИСПРАВЛЕНО
- [LOW-003r] Остаток: 90-94% без .99 → ИСПРАВЛЕНО
- [LOW-004] Нет нумерации разделов → ИСПРАВЛЕНО (9 h1, 26 h2)

**BPMN-анализ:**
- 3 текущих диаграммы проверены (2 мелких структурных замечания)
- Покрытие: только ядро процесса, 9 процессов не визуализированы
- Стратегия принята: инлайн-размещение + общая обзорная + создание всех недостающих

**Результат:** 8 правок применены в Confluence v31→v33. Верификация: 22/22 проверок пройдено.

**Открытые вопросы:**
- [ ] LOW-003 (v1.0.0): Минимальная сумма ЛС

---

### 09.02.2026 — AGENT_8_BPMN_DESIGNER: /bpmn

**Сделано:** Создание и публикация 13 BPMN-диаграмм (10 новых + 3 исправленных)

**Исправлены структурные проблемы:**
- D2 (process-2-approval): удален избыточный gateway x2 (1 исходящее ребро)
- D3 (process-3-emergency): удален end event e1 с исходящим ребром

**Новые диаграммы:**
- process-0-overview: Общая обзорная схема
- process-4-order-lifecycle: Жизненный цикл Заказа (11 статусов)
- process-5-ls-lifecycle: Жизненный цикл ЛС (4 статуса)
- process-6-wms-integration: Интеграция с WMS (точка невозврата, частичная отборка)
- process-7-return: Возврат товара (активная/закрытая ЛС, 60 дней)
- process-8-ls-closing: Закрытие ЛС (матрица согласования, санкции)
- process-9-npss-control: Контроль возраста НПСС (4 зоны: 0-30/31-60/61-90/>90)
- process-10-profitability-change: Изменение плановой рентабельности
- process-11-demand-fixation: Фиксация потребности (Этап 2)
- process-12-sanctions: Санкции за невыкуп (Этап 2)

**Результат:** 13/13 диаграмм загружены и встроены в Confluence v33→v34.

---

### 09.02.2026 — AGENT_8_BPMN_DESIGNER: /bpmn (исправление layout)

**Сделано:** Исправление наложений стрелок и текста во всех 13 BPMN-диаграммах

**Исправления в generate-bpmn.js:**
- Увеличены размеры узлов (taskMinWidth 100→120, taskMaxWidth 180→240, gatewaySize 45→50)
- Увеличены отступы (lanePadding 30→60, eventLabelSpace 35→55)
- Адаптивные nodesep/ranksep по количеству узлов и ребер
- Orthogonal edges с rounded corners (убрано curved=1)
- Динамический pageWidth/pageHeight
- Увеличены подписи (fontSize=10 на стрелках, 110px ширина для событий)

**Per-diagram layout overrides:**
- process-0-overview: nodesep=220, ranksep=270
- process-4-order-lifecycle: nodesep=220, ranksep=260
- process-5-ls-lifecycle: nodesep=220, ranksep=260
- process-6-wms-integration: nodesep=200, ranksep=240
- process-8-ls-closing: nodesep=220, ranksep=260
- process-11-demand-fixation: nodesep=170, ranksep=200

**Результат:** 13/13 перезагружены в Confluence v34→v35. Верификация: 13/13 drawio-макросов.

**Открытые вопросы:**
- [ ] Инлайн-размещение диаграмм в соответствующих разделах ФМ
- [ ] LOW-003 (v1.0.0): Минимальная сумма ЛС

---

### 09.02.2026 — AGENT_8_BPMN_DESIGNER: /bpmn (компактный layout v2)

**Сделано:** Полная переработка layout после обратной связи (растянутые диаграммы, стрелки сквозь узлы)

**Исправления в generate-bpmn.js:**
- Возврат к компактным параметрам (taskMinWidth=100, taskMaxWidth=180, gatewaySize=45)
- Компактные отступы (lanePadding=30, eventLabelSpace=35)
- nodesep=70, ranksep=80 (дефолт dagre)
- Прямые линии для cross-lane ребер (без edgeStyle) - устраняет проход стрелок сквозь узлы
- Orthogonal routing только для same-lane ребер (безопасен внутри одной дорожки)
- Удалены все per-diagram layout overrides из 6 JSON-файлов

**Ключевое решение:** Разделение стилей ребер:
- Cross-lane: прямые линии (rounded=1, без edgeStyle) - физически не могут пройти сквозь узлы
- Same-lane: orthogonalEdgeStyle (безопасен внутри одной swimlane)

**Результат:** 13/13 вложений перезагружены в Confluence (версия страницы 35, обновлены только вложения).
Верификация: 13/13 drawio-макросов, 13/13 process-*.drawio вложений.

---

### 09.02.2026 — AGENT_8_BPMN_DESIGNER: /bpmn (Z-path edge routing v3)

**Сделано:** Фундаментальное исправление маршрутизации ребер в generate-bpmn.js

**Проблема:** Предыдущая версия (компактный layout v2) создавала диагональные "лестничные" линии при cross-lane ребрах.

**Исправления в generate-bpmn.js:**
- Cross-lane ребра: явные Z-path waypoints (горизонталь - вертикаль - горизонталь)
  - midX = середина между правым краем источника и левым краем цели
  - Два waypoint: (midX, srcPoolY) и (midX, tgtPoolY)
  - Для backward-ребер: обход справа через bypassX
- Same-lane ребра: parent = lane (не pool), orthogonalEdgeStyle
  - Routing видит узлы как siblings и обходит их корректно

**Ключевое решение:** Разделение edge-parent:
- Cross-lane: parent = pool, явные waypoints (Z-path)
- Same-lane: parent = lane, автоматический orthogonal routing

**Результат:** 13/13 вложений перезагружены в Confluence (обновлены только вложения).

**Открытые вопросы:**
- [ ] Инлайн-размещение диаграмм в соответствующих разделах ФМ
- [ ] LOW-003 (v1.0.0): Минимальная сумма ЛС

---

### 13.02.2026 - АНАЛИТИК: Анализ бизнес-вопросов B1-B9

**Задача:** Проанализировать 9 бизнес-вопросов (4 CRITICAL + 5 HIGH), выявленных в ходе полного цикла конвейера, подготовить варианты решений с оценкой влияния на ТЗ и сроки.

**Контекст:** После завершения полного цикла (Agents 1-6, Quality Gate, /evolve) зафиксированы 9 неопределенностей, требующих решения стейкхолдеров перед началом разработки.

**Выполнено:**

1. **Анализ CRITICAL вопросов (B1-B4):**
   - B1: SLA для заказов < 100 т.р. - рекомендация: жесткие значения 2/4/12ч (+8ч)
   - B2: Согласование с корректировкой цены - рекомендация: корректировка как рекомендация менеджеру (+8ч)
   - B3: Логический резерв ЛС при дефиците - рекомендация: 48ч блокирует, 90д информационно (0ч)
   - B4: Фоновое задание пересчета санкций - рекомендация: retry 3x15min, таймаут 2ч, алерт ФД (+8ч)

2. **Анализ HIGH вопросов (B5-B9):**
   - B5: Терминальное поведение при автоотказе ГД - рекомендация: уведомление CFO (+12ч)
   - B6: Улучшение рентабельности во время согласования - рекомендация: автосогласование < 1 п.п. (+8ч)
   - B7: Формулы "Выручка отгруженного" - рекомендация: нетто с учетом возвратов (+8ч)
   - B8: Автопродление ЛС + НПСС > 90 дней - рекомендация: блокировка остается (0ч)
   - B9: Определение подтвержденного дефицита - рекомендация: автоматическое + РБЮ для споров (+16ч)

3. **Сводная оценка влияния:**
   - Общая дельта трудоемкости: **+68 часов (+3% от базовой оценки 2293ч)**
   - P1 (MVP): 1885ч -> 1929ч (+44ч, +2%)
   - P2 (расширения): 408ч -> 432ч (+24ч, +6%)
   - Срок реализации: ~9 месяцев -> ~9.2 месяца (+1 неделя)
   - Команда: без изменений (3 разработчика + 1 аналитик + 1 тестировщик)

4. **Созданный документ:**
   - REPORTS/BUSINESS-QUESTIONS-B1-B9-ANALYSIS.md - детальный анализ с вариантами решений и рекомендациями для стейкхолдеров

**Решения:**
- Рекомендуемые решения оптимизируют баланс между автоматизацией и контролем
- Все CRITICAL вопросы (B1-B4) должны быть решены в течение 1 недели перед началом разработки
- HIGH вопросы (B5-B9) можно решить параллельно с разработкой

**Результат:** Готов документ для утверждения стейкхолдерами. После утверждения решений можно обновить ФМ и ТЗ, затем стартовать Этап 0 (подготовка среды).

**Следующие шаги:**
1. Согласование решений по B1-B4 (CRITICAL) с ДП, ФД, РБЮ - 1 неделя
2. Обновление ФМ v1.0.6 -> v1.0.7 с утвержденными решениями
3. Обновление ТЗ v1.0.6 с дельтой +68 часов
4. Старт Этапа 0 (подготовка инфраструктуры и решение CRITICAL)

**Статус бизнес-вопросов:**
- [ ] B1-B4 (CRITICAL): требуют утверждения стейкхолдеров в течение 1 недели
- [ ] B5-B9 (HIGH): можно решить параллельно с разработкой

**Статус утверждения решений:**
- [x] B1-B4 (CRITICAL): утверждены стейкхолдерами (13.02.2026)
- [x] B5-B9 (HIGH): утверждены стейкхолдерами (13.02.2026)

**Созданные артефакты:**
- REPORTS/BUSINESS-QUESTIONS-B1-B9-ANALYSIS.md - детальный анализ с рекомендациями
- CHANGES/FM-LS-PROFIT-v1.0.7-PLAN.md - план изменений для Agent 0
- DECISIONS-B1-B9-APPROVED.md - финальные утвержденные решения

**Передача Agent 0 (Creator):**
Для обновления ФМ v1.0.6 -> v1.0.7 передать Agent 0 следующие документы:
1. CHANGES/FM-LS-PROFIT-v1.0.7-PLAN.md (детальный план с формулировками)
2. DECISIONS-B1-B9-APPROVED.md (утвержденные решения)

Задача Agent 0: внести 9 уточнений в ФМ, обновить метаданные (v1.0.7, дата 13.02.2026, добавить строку в историю версий), применить в Confluence, верифицировать.

---

# Техническое задание: Контроль рентабельности отгрузок по ЛС

**Код проекта:** FM-LS-PROFIT
**Версия ФМ:** 1.0.6 (Confluence v49)
**Версия ТЗ:** 1.0
**Дата:** 13.02.2026
**Автор:** Agent 5 (Tech Architect)
**Платформа:** 1С:Управление Торговлей 11.5+
**Расширение:** КонтрольРентабельностиОтгрузок

---

## Содержание

1. [Общая информация](#1-общая-информация)
2. [Объекты разработки](#2-объекты-разработки)
3. [Интеграции](#3-интеграции)
4. [Фоновые задания](#4-фоновые-задания)
5. [Оценка трудоемкости](#5-оценка-трудоемкости)
6. [Критерии приемки](#6-критерии-приемки)
7. [Неопределенности](#7-неопределенности)
8. [Этапы реализации](#8-этапы-реализации)

---

## 1. Общая информация

### 1.1. Назначение системы

Система контроля рентабельности отгрузок по локальным сметам (ЛС) предназначена для предотвращения убыточных и низкомаржинальных частичных отгрузок в 1С:УТ. Система реализует:

- автоматический расчет рентабельности при создании Заказа клиента;
- 4-уровневую матрицу согласования отклонений (РБЮ - Директор ДРП - ДП - ГД);
- интеграцию с ELMA BPM для маршрутизации задач согласования;
- интеграцию с WMS для контроля отгрузок;
- систему санкций за невыкуп ЛС (Этап 2).

### 1.2. Ссылки на документы

| Документ | Расположение |
|----------|-------------|
| Функциональная модель | Confluence, PAGE_ID 83951683, v1.0.6 |
| Аудит-отчет | AUDIT-REPORT-v1.0.6-2026-02-13.md |
| Тест-кейсы (базовые) | TEST-CASES-CORE-v1.0.6.md (30 тест-кейсов) |
| Тест-кейсы (расширенные) | TEST-CASES-EXTENDED-v1.0.6.md (35 тест-кейсов) |
| Матрица трассируемости | traceability-matrix.json (27 находок, 100% покрытие) |

### 1.3. Основные формулы

**Рентабельность позиции:**
```
Рентабельность = (Цена - НПСС) / Цена x 100%
```

**Накопленная + Заказ:**
```
(Выручка_отгруж + Выручка_заказа - Себест_отгруж(НПСС) - Себест_заказа) /
(Выручка_отгруж + Выручка_заказа) x 100%
```

**Рентабельность остатка ЛС:**
```
SUM((Цена_i - НПСС_i) x Кол_i) / SUM(Цена_i x Кол_i) x 100%
```
где i - неотгруженные позиции за вычетом позиций Заказов в статусах "На согласовании" и "Согласован".

**Отклонение:**
```
Отклонение = Рент_ЛС(плановая) - MAX(Накопленная+Заказ, Рент_остатка)
```

### 1.4. Матрица согласования Заказов

| Отклонение (п.п.) | Согласующий | Автоэскалация при бездействии |
|-------------------|-------------|-------------------------------|
| < 1,00 | Не требуется | - |
| 1,00 - 15,00 | РБЮ | Директор ДРП |
| 15,01 - 25,00 | ДП | ГД |
| > 25,00 | ГД | Автоотказ 48ч |

### 1.5. Приоритизация (P1 / P2)

- **P1 (MVP):** 57 требований - контроль рентабельности, согласование, жизненный цикл, блокировки, базовые отчеты, интеграции (LS-BR/FR/WF/INT/NFR/SEC до 049);
- **P2 (Этап 2):** 19 требований - обеспечение наличием, санкции за невыкуп, расширенные отчеты (LS-FR/WF/RPT 050-068).

### 1.6. Целевые показатели

- 10-50 одновременных пользователей;
- до 1000 позиций в одной ЛС;
- до 50 Заказов на согласовании по одной ЛС;
- расчет рентабельности - не более 2 секунд (до 500 позиций);
- обработка сообщения WMS - не более 30 секунд.

---

## 2. Объекты разработки

### 2.1. Расширение конфигурации

**Имя:** `КонтрольРентабельностиОтгрузок`
**Назначение:** Расширение для 1С:УТ 11.5+, реализующее контроль рентабельности отгрузок по локальным сметам.
**Режим совместимости:** Версия 8.3.22+

**Расширяемые объекты типовой конфигурации:**
- Документ.ЗаказКлиента (новые реквизиты, подписки на события, форма);
- Документ.РеализацияТоваровУслуг (подписка на проведение, проверка согласования);
- Документ.ВозвратТоваровОтПокупателя (подписка на проведение, пересчет);
- Справочник.Контрагенты (новые реквизиты для санкций);
- Справочник.Номенклатура (чтение НПСС);
- ОбщийМодуль.УправлениеПечатью (внедрение отчетов).

---

### 2.2. Справочник "ЛокальнаяСмета"

**Назначение:** Хранение локальных смет с плановой рентабельностью и составом позиций.

#### 2.2.1. Реквизиты шапки

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| Контрагент | СправочникСсылка.Контрагенты | Да | Клиент, которому принадлежит ЛС |
| ДатаНачала | Дата | Да | Начало срока действия ЛС |
| ДатаОкончания | Дата | Да | Окончание срока действия ЛС |
| Статус | ПеречислениеСсылка.СтатусыЛС | Да | Активна / Истекла / Закрыта / Отменена |
| ПлановаяРентабельность | Число(10,2) | Да | Плановая рентабельность ЛС, % |
| Ответственный | СправочникСсылка.Пользователи | Да | Менеджер, создавший ЛС |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Да | Основной бизнес-юнит |
| КоличествоПродлений | Число(1,0) | Нет | Счетчик ручных продлений (макс. 2) |
| ДатаПоследнегоПродления | Дата | Нет | Дата последнего продления |
| ПричинаЗакрытия | Строка(500) | Нет | Причина досрочного закрытия |

#### 2.2.2. Табличная часть "Позиции"

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Да | Товар |
| Количество | Число(15,3) | Да | Количество по ЛС |
| Цена | Число(15,2) | Да | Цена продажи |
| НПСС | Число(15,2) | Да | Зафиксированная НПСС на момент создания |
| ДатаФиксацииНПСС | Дата | Да | Дата фиксации НПСС |
| ОтгруженоКоличество | Число(15,3) | Нет | Фактически отгружено (обновляется при проведении РТУ) |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Да | БЮ номенклатуры |
| ПризнакНеликвид | Булево | Нет | Признак неликвидного товара со спецценой |

#### 2.2.3. Формы

- **ФормаЭлемента:** Основная форма с панелью показателей (плановая рентабельность, накопленная рентабельность, % выкупа, остаток), списком позиций с цветовой индикацией рентабельности по строкам, историей заказов по ЛС.
- **ФормаСписка:** Список ЛС с фильтрами по статусу, менеджеру, БЮ, контрагенту.

#### 2.2.4. Права

| Роль | Чтение | Создание | Изменение | Удаление |
|------|:------:|:--------:|:---------:|:--------:|
| Менеджер | Свой БЮ | Да | Ограничено* | Нет |
| РБЮ | Свой БЮ | Да | Да | Нет |
| ДП | Все | Да | Да | Нет |
| ГД | Все | Нет | Нет | Нет |
| Администратор | Все | Да | Да | Да |

*Менеджер может изменять состав неотгруженных позиций; изменение плановой рентабельности требует пересогласования.

---

### 2.3. Справочник "УполномоченныеЛица"

**Назначение:** Реестр лиц, уполномоченных на экстренное согласование, с привязкой к уровням отклонения.

#### 2.3.1. Реквизиты

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| Сотрудник | СправочникСсылка.Пользователи | Да | ФИО уполномоченного |
| УровеньОтклонения | ПеречислениеСсылка.УровниОтклонения | Да | 1-15 п.п. / 15.01-25 п.п. |
| ДатаНазначения | Дата | Да | Дата включения в справочник |
| ДатаОкончания | Дата | Нет | Дата исключения (NULL - бессрочно) |
| Активен | Булево | Да | Признак активности |
| Подразделение | СправочникСсылка.Подразделения | Нет | Подразделение (для фильтрации) |

#### 2.3.2. Алгоритм актуализации

- Плановая актуализация - ежемесячно (HR-служба);
- При увольнении/переводе - автоматическое исключение (интеграция с HR или ручное);
- При каждом обращении к справочнику - проверка ДатаОкончания и признака Активен.

---

### 2.4. Справочник "СтратегическиеКлиенты"

**Назначение:** Реестр стратегически важных клиентов с особыми условиями контроля.

#### 2.4.1. Реквизиты

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| Контрагент | СправочникСсылка.Контрагенты | Да | Клиент |
| КритерийВключения | Строка(500) | Да | Обоснование: оборот 10 млн, реестр ДРП, контракт 1 млн |
| ДатаВключения | Дата | Да | Дата включения в реестр |
| КемДобавлен | СправочникСсылка.Пользователи | Да | Кто инициировал |
| Утвердил | СправочникСсылка.Пользователи | Да | ДП, утвердивший включение |
| ДопустимоеОтклонение | Число(5,2) | Нет | Допустимое отклонение порогов (п.п.) |

#### 2.4.2. Процедура добавления

Заявка менеджера с обоснованием - одобрение ДП - включение в реестр (SLA 3 р.д.). Актуализация ежеквартально.

---

### 2.5. Документ "ЗаявкаНаСогласование"

**Назначение:** Основной документ процесса согласования отклонений рентабельности. Создается автоматически при отправке Заказа клиента на согласование.

#### 2.5.1. Реквизиты шапки

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Да | Заказ, требующий согласования |
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Да | ЛС, по которой создан Заказ |
| ДатаСоздания | Дата | Да | Дата и время создания заявки |
| Статус | ПеречислениеСсылка.СтатусыСогласования | Да | НаСогласовании / Согласован / Отклонен / Аннулирован / СогласованСКорректировкой |
| Приоритет | ПеречислениеСсылка.ПриоритетЗаявки | Да | P1 (> 500 т.р. или экстренный) / P2 (стандартный) |
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | Да | РБЮ / ДиректорДРП / ДП / ГД |
| Согласующий | СправочникСсылка.Пользователи | Да | Текущий согласующий |
| ОтклонениеНакопленная | Число(10,2) | Да | Отклонение по (Накопленная + Заказ), п.п. |
| ОтклонениеОстаток | Число(10,2) | Да | Отклонение по рент. остатка ЛС, п.п. |
| МаксОтклонение | Число(10,2) | Да | MAX(ОтклонениеНакопленная, ОтклонениеОстаток) |
| РентабельностьЗаказа | Число(10,2) | Да | Рентабельность текущего Заказа, % |
| НакопленнаяРентабельность | Число(10,2) | Да | Накопленная рентабельность, % |
| РентабельностьОстатка | Число(10,2) | Да | Рентабельность остатка ЛС, % |
| ОбоснованиеМенеджера | Строка(2000) | Да | Обоснование (мин. 50 символов) |
| СуммаЗаказа | Число(15,2) | Да | Сумма Заказа (руб.) |
| ДатаСогласования | Дата | Нет | Дата и время принятия решения |
| КомментарийСогласующего | Строка(2000) | Нет | Комментарий согласующего |
| ПричинаОтказа | Строка(2000) | Нет | Причина отказа (обязательна при отказе) |
| ДатаИстечения | Дата | Нет | Дата истечения согласования (5 р.д.) |
| ПризнакЭкстренного | Булево | Нет | Признак экстренного согласования |
| ЭскалированОт | СправочникСсылка.Пользователи | Нет | Кто эскалировал |
| СчетчикАннулирований | Число(2,0) | Нет | Количество аннулирований (при >= 3 - эскалация ДП) |
| ИдентификаторЗадачиELMA | Строка(100) | Нет | ID задачи в ELMA BPM |
| ПереданНаСклад | Булево | Нет | Точка невозврата (после установки - согласование не аннулируется) |
| ТипРешения | ПеречислениеСсылка.ТипыРешенийСогласования | Нет | Одобрить / Одобрить с комментарием / Одобрить с корректировкой / Отклонить |

#### 2.5.2. Табличная часть "ИсторияСогласования"

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| ДатаСобытия | Дата | Да | Дата и время события |
| ТипСобытия | Строка(50) | Да | Создание / Эскалация / Решение / Аннулирование / Отзыв |
| Исполнитель | СправочникСсылка.Пользователи | Да | Кто совершил действие |
| Комментарий | Строка(2000) | Нет | Описание |
| Отклонение | Число(10,2) | Нет | Отклонение на момент события |

#### 2.5.3. Табличная часть "ИнформацияДляСогласующего"

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Да | Товар |
| Количество | Число(15,3) | Да | Количество в Заказе |
| Цена | Число(15,2) | Да | Цена |
| НПСС | Число(15,2) | Да | НПСС |
| РентабельностьПозиции | Число(10,2) | Да | Рент. позиции, % |
| ПотериМаржиРуб | Число(15,2) | Да | Потери маржи, руб. |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Нет | БЮ позиции |

#### 2.5.4. Формы

**ФормаСогласующего** (основная):
- Блок данных Заказа: номенклатура, количество, цены, суммы;
- Блок показателей: рентабельность Заказа, остатка ЛС, накопленная; все суммы дублируются в рублях и процентах;
- Блок истории ЛС: предыдущие отгрузки, их рентабельность;
- Блок обоснования менеджера;
- Кнопки действий: "Согласовать" / "Согласовать с комментарием" / "Согласовать с корректировкой цены" / "Отклонить";
- При отклонении - обязательное поле "Причина отказа".

**ФормаМенеджера:**
- Информация о статусе: ожидание, просмотрено, решение;
- Кнопка "Отозвать" (доступна до принятия решения);
- История аннулирований и решений.

#### 2.5.5. Статусная модель

```
Создана → НаСогласовании → Согласован (5 р.д.)
                          → СогласованСКорректировкой (5 р.д.)
                          → Отклонен → (менеджер редактирует Заказ) → НаСогласовании
                          → Аннулирован → НаСогласовании
                → Отозвана (менеджер)
                → Эскалирована → НаСогласовании (новый согласующий)
```

#### 2.5.6. Алгоритм создания

1. Менеджер нажимает "Отправить на согласование" в Заказе клиента;
2. Система выполняет атомарную блокировку остатка ЛС (10 сек);
3. Пересчет накопленной рентабельности (перечитать из регистра);
4. Расчет отклонения:
   - Отклонение_Накопл = Рент_ЛС - (Накопленная + Заказ);
   - Отклонение_Остатка = Рент_ЛС - Рент_Остатка;
   - МаксОтклонение = MAX(Отклонение_Накопл, Отклонение_Остатка);
   - Если остаток ЛС = 0 после Заказа, проверка остатка не применяется;
5. Округление до 2 знаков (математическое);
6. Определение уровня согласования по матрице п. 3.4;
7. Особые случаи:
   - Рентабельность < 0% при плане >= 0% - жесткая блокировка, ГД;
   - Убыток < 100 руб. - автосогласование;
   - Все позиции - неликвид со спецценой - без контроля;
8. Создание задачи в ELMA BPM;
9. Снятие блокировки ЛС.

#### 2.5.7. Алгоритм аннулирования

Согласование аннулируется автоматически при:
1. Истечении 5 рабочих дней;
2. Изменении состава или цен Заказа;
3. Увеличении отклонения более чем на 3 п.п.;
4. Переходе в зону более высокого уровня согласования;
5. Изменении плановой рентабельности ЛС;
6. Закрытии или аннулировании ЛС.

**Исключение:** после установки флага ПереданНаСклад - аннулирование запрещено.

При >= 3 аннулированиях одного Заказа - автоматическая эскалация на ДП.

---

### 2.6. Документ "ЭкстренноеСогласование"

**Назначение:** Фиксация экстренного согласования Заказа без стандартной процедуры в ELMA.

#### 2.6.1. Реквизиты

| Имя | Тип 1С | Обязательный | Описание |
|-----|--------|:------------:|----------|
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Да | Заказ |
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Да | ЛС |
| Менеджер | СправочникСсылка.Пользователи | Да | Инициатор |
| УполномоченноеЛицо | СправочникСсылка.УполномоченныеЛица | Да | Кто разрешил (из справочника) |
| ПричинаСрочности | Строка(2000) | Да | Обоснование экстренности |
| ДокументПодтверждения | Строка(500) | Нет | Ссылка на скриншот/письмо |
| КаналСвязи | ПеречислениеСсылка.КаналыСвязи | Да | Телефон / Мессенджер / ЛичноеОбращение |
| ДатаРазрешения | Дата | Да | Дата и время устного разрешения |
| СогласованиеПостфактум | Булево | Нет | Получено согласование в ELMA |
| ДатаСогласованияПостфактум | Дата | Нет | Дата согласования постфактум |
| Отклонение | Число(10,2) | Да | Величина отклонения |
| ПризнакИнцидента | Булево | Нет | Если отказано постфактум |

#### 2.6.2. Ограничения

- Не более 3 на менеджера в календарный месяц (пиковые периоды - до 5 по решению ДП);
- Не более 5 на контрагента в месяц (пиковые - до 8);
- При отклонении > 25 п.п. или убытке - экстренное согласование недоступно;
- Для убыточных ЛС (план < 0%) - экстренное доступно по общим правилам;
- Согласование постфактум обязательно в течение 24 рабочих часов;
- Защита от фальсификации: push-уведомление уполномоченному, 2 часа на подтверждение.

#### 2.6.3. Алгоритм фиксации

1. Менеджер заполняет форму (выбирает уполномоченное лицо из справочника, указывает причину);
2. Система проверяет лимиты (менеджер/контрагент);
3. Система отправляет push-уведомление уполномоченному лицу;
4. Заказ переходит в статус "Согласован" с пометкой "Экстренно";
5. Создается задача на согласование постфактум в ELMA (SLA 24 раб. часа);
6. При отказе постфактум - создание записи "Инцидент".

#### 2.6.4. Последствия отказа постфактум

| Размер убытка | Последствие |
|---------------|-------------|
| До 10 000 руб. | Без персональной ответственности |
| 10 000 - 100 000 руб. | Удержание из премии (не более 30%) |
| > 100 000 руб. | Разбор на уровне ДП с участием HR |

При 3+ инцидентах в квартал - автоматическая эскалация к ДП.

---

### 2.7. Регистры сведений

#### 2.7.1. Регистр "РентабельностьЛС"

**Назначение:** Хранение рассчитанных показателей рентабельности по каждой ЛС.

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | ЛС |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| ПлановаяРентабельность | Число(10,2) | Плановая рентабельность ЛС, % |
| НакопленнаяРентабельность | Число(10,2) | Накопленная по отгрузкам, % |
| РентабельностьОстатка | Число(10,2) | Рентабельность неотгруженного остатка, % |
| ВыручкаОтгруженная | Число(15,2) | Суммарная выручка по проведенным РТУ |
| СебестоимостьОтгруженная | Число(15,2) | Суммарная НПСС по проведенным РТУ |
| ПроцентВыкупа | Число(5,2) | Процент выкупа ЛС, % |
| ДатаПоследнегоПересчета | Дата | Время последнего обновления |

**Обновляется при:** проведении/отмене РТУ, проведении возврата, закрытии ЛС.

#### 2.7.2. Регистр "НПССПозиций"

**Назначение:** Хранение актуальных значений НПСС по номенклатуре.

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Товар |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| НПСС | Число(15,2) | Нормативная плановая себестоимость |
| ДатаРасчета | Дата | Дата последнего расчета НПСС |
| ВозрастДней | Число(4,0) | Количество дней с момента расчета |
| МетодРасчета | Строка(50) | Стандартный / ПоПоследнейЗакупке / Временный |

| Реквизит | Тип 1С | Описание |
|----------|--------|----------|
| СтараяНПСС | Число(15,2) | Предыдущее значение (для истории) |
| ПричинаИзменения | Строка(200) | Причина пересчета |

#### 2.7.3. Регистр "SLAСогласования"

**Назначение:** Настройки SLA и правил автоэскалации по уровням и приоритетам.

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | РБЮ / ДиректорДРП / ДП / ГД |
| Приоритет | ПеречислениеСсылка.ПриоритетЗаявки | P1 / P2 |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| SLAЧасов | Число(3,0) | Время на решение (рабочие часы) |
| ЭскалацияЧасов | Число(3,0) | Через сколько часов эскалация |
| ЦельЭскалации | ПеречислениеСсылка.УровниСогласования | Кому эскалировать |
| ДефолтРешение | Строка(50) | Действие при бездействии (Эскалация / Автоотказ / Автосогласование) |

**Значения по умолчанию:**

| Уровень | P1 SLA | P1 Эскалация | P2 SLA | P2 Эскалация |
|---------|--------|-------------|--------|-------------|
| РБЮ | 4ч | 8ч - ДП | 24ч | 48ч - ДП |
| ДП | 8ч | 16ч - ГД | 48ч | 96ч - ГД |
| ГД | 24ч | 48ч - Автоотказ | 72ч | 144ч - Автоотказ |

Для заказов < 100 т.р.: SLA сокращен вдвое.

#### 2.7.4. Регистр "НарушенияМенеджеров"

**Назначение:** Учет нарушений процедуры для мониторинга и отчетности.

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| Менеджер | СправочникСсылка.Пользователи | Менеджер |
| ДатаНарушения | Дата | Дата события |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| ТипНарушения | Строка(100) | ОтказПостфактум / НесанкционированнаяОтгрузка / ЛимитЭкстренных |
| СуммаУбытка | Число(15,2) | Сумма убытка, руб. |
| ДокументОснование | Строка(200) | Ссылка на документ |
| Контрагент | СправочникСсылка.Контрагенты | Клиент |

#### 2.7.5. Регистр "СанкцииКлиентов" (P2)

**Назначение:** Хранение текущих и исторических санкций по клиентам.

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| Контрагент | СправочникСсылка.Контрагенты | Клиент |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| ТипСанкции | ПеречислениеСсылка.ТипыСанкций | Нет / МинусТриПП / МинусДесятьПП / ТолькоСтандартные |
| ДатаНачала | Дата | Дата применения |
| ПричинаЛС | СправочникСсылка.ЛокальнаяСмета | ЛС-причина |
| ДатаРеабилитации | Дата | Ожидаемая дата снятия (6 мес.) |
| НакопленноеОграничение | Число(5,2) | Суммарное ограничение скидки, п.п. |

#### 2.7.6. Регистр "ИсторияАвтопродленийЛС" (P2)

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | ЛС |
| Номенклатура | СправочникСсылка.Номенклатура | Позиция |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| ДатаАвтопродления | Дата | Дата продления |
| НоваяДатаОкончания | Дата | Продленный срок |

#### 2.7.7. Регистр "БлокировкиЛС"

**Назначение:** Пессимистичная блокировка ЛС при редактировании Заказов.

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | ЛС |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| Пользователь | СправочникСсылка.Пользователи | Кто заблокировал |
| ВремяБлокировки | Дата | Начало блокировки |
| ВремяИстечения | Дата | Автоматическое снятие (+ 15 мин.) |

**Логика:**
- При начале создания/редактирования Заказа - установка блокировки;
- Снятие: при сохранении/отмене или автоматически через 15 мин.;
- Уведомление через 10 мин. "Завершите редактирование";
- Максимальное ожидание - 30 сек, затем сообщение о занятости;
- Администратор может принудительно снять (справочник "Активные блокировки").

#### 2.7.8. Регистр "ФиксацияПотребности" (P2)

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Заказ |
| Номенклатура | СправочникСсылка.Номенклатура | Позиция |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| ДатаФиксации | Дата | Дата попытки создания Заказа |
| Количество | Число(15,3) | Запрошенное количество |
| РезультатПроверки | Строка(20) | ВНаличии / НетВНаличии / Частично |
| ОжидаемаяДата | Дата | Ожидаемая дата поступления |
| ДатаОкончанияОжидания | Дата | Максимальный срок (90 дней) |

#### 2.7.9. Регистр "ЖурналАудитаЛС"

**Назначение:** Неизменяемый журнал всех изменений ЛС. Хранение 5 лет. Доступ: ДП, ФД, СБ.

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | ЛС |
| ДатаИзменения | Дата | Дата и время |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| Автор | СправочникСсылка.Пользователи | Кто изменил |
| ТипИзменения | Строка(100) | Создание / ИзменениеПлана / Продление / Закрытие |
| СтароеЗначение | Строка(500) | Предыдущее значение |
| НовоеЗначение | Строка(500) | Новое значение |
| Причина | Строка(500) | Обоснование |

---

### 2.8. Регистры накопления

#### 2.8.1. Регистр "СчетчикЭкстренныхСогласований"

| Измерение | Тип 1С | Описание |
|-----------|--------|----------|
| Менеджер | СправочникСсылка.Пользователи | Менеджер |
| Контрагент | СправочникСсылка.Контрагенты | Клиент |
| Период | Дата | Календарный месяц |

| Ресурс | Тип 1С | Описание |
|--------|--------|----------|
| КоличествоМенеджер | Число(2,0) | Счетчик на менеджера (лимит 3/5) |
| КоличествоКонтрагент | Число(2,0) | Счетчик на контрагента (лимит 5/8) |

---

### 2.9. Отчеты

#### 2.9.1. Отчет "ОтчетРентабельности" (LS-RPT-013)

**Назначение:** Анализ накопленной рентабельности по ЛС в разрезе менеджеров.

**Параметры:** Период, Менеджер, БЮ, Контрагент, СтатусЛС.
**Колонки:** ЛС, Контрагент, Менеджер, БЮ, ПлановаяРент, НакопленнаяРент, Отклонение, СуммаЛС, СуммаОтгружено.
**Группировки:** По менеджеру, по БЮ, по контрагенту.
**Цветовая индикация:** зеленый (отклонение < 1), желтый (1-15), красный (> 15).

#### 2.9.2. Отчет "ДашбордМенеджера" (часть LS-FR-006)

**Назначение:** Панель менеджера при работе с Заказами.

**Виджеты:**
- Плановая рентабельность ЛС;
- Текущая накопленная рентабельность;
- Минимальная допустимая цена (руб.) по каждой позиции;
- Остаток ЛС (количество и сумма);
- Список Заказов по ЛС с их статусами;
- Индикатор возраста НПСС.

#### 2.9.3. Отчет "ДашбордСогласующего" (LS-FR-045)

**Назначение:** Виджет "Ожидают моего решения" на главной странице 1С:УТ.

**Виджеты:**
- Список задач на согласование (приоритизация: P1 выше P2, по сумме убывающей, по FIFO);
- Индикатор оставшегося SLA;
- Количество эскалированных задач;
- Статистика за период: согласовано/отклонено/эскалировано.

#### 2.9.4. Отчет "KPIМенеджеров" (LS-RPT-064)

**Назначение:** Отчет "Качество ЛС по менеджерам".

**Расчет:** Средний % выкупа по закрытым ЛС за период.

**Шкала KPI:**

| % выкупа | Коэффициент |
|----------|-------------|
| 95%+ | 120% |
| 90-94,99% | 100% |
| 85-89,99% | 90% |
| 80-84,99% | 80% |
| 70-79,99% | 60% |
| < 70% | 0% |

**Группировки:** По менеджерам, по БЮ, по периодам.

#### 2.9.5. Дополнительные отчеты

| Код | Название | Периодичность | Получатели | Приоритет |
|-----|----------|---------------|------------|-----------|
| LS-RPT-038 | Устаревшие НПСС | Еженедельно | ФС | P1 |
| LS-RPT-043 | Конфликты блокировки ЛС | По запросу | Руководство | P1 |
| LS-BR-044 | Сверочный отчет WMS-1С | Ежедневно | Склад, IT | P1 |
| LS-FR-046 | Соблюдение SLA | Еженедельно | ДП, РБЮ | P1 |
| LS-RPT-060 | Дефицит | Еженедельно | Закупки | P2 |
| LS-RPT-065 | Продажи неликвида | Ежемесячно | ДП | P2 |
| LS-RPT-066 | Портфельная маржа | Ежемесячно | ДП, ФД | P2 |
| LS-RPT-067 | Потери из-за согласований | Ежемесячно | ДП, ФД | P2 |
| LS-RPT-068 | Клиенты с низким выкупом | Еженедельно | Менеджеры, РБЮ | P2 |

---

### 2.10. Обработки

#### 2.10.1. Обработка "ПанельМенеджера"

**Назначение:** Интерактивная панель для менеджера при создании Заказа.

**Функции:**
- Отображение плановой рентабельности ЛС;
- Расчет текущей накопленной рентабельности;
- Показ минимальной допустимой цены по каждой позиции;
- Интерактивный пересчет: менеджер меняет количество/цены - рентабельность пересчитывается мгновенно;
- Цветовая индикация: зеленый (ОК), желтый (потребуется РБЮ), оранжевый (ДП), красный (ГД);
- Показ остатка ЛС с учетом Заказов на согласовании;
- Индикатор возраста НПСС с рекомендациями.

**Алгоритм минимальной допустимой цены:**
```
МинЦена = НПСС / (1 - (РентЛС - 1) / 100)
```
где 1 п.п. - порог автосогласования.

#### 2.10.2. Обработка "АрбитражДиректора" (для мульти-БЮ)

**Назначение:** Форма арбитража Директора ДРП при расхождении решений РБЮ разных БЮ.

**Контекст вызова:** Один РБЮ согласовал, другой отклонил.

**Функции:**
- Отображение решений каждого РБЮ с обоснованиями;
- Показ состава Заказа по БЮ;
- Варианты решения: согласовать весь Заказ / отклонить весь Заказ / частичное согласование;
- SLA: 8 рабочих часов;
- При превышении SLA - автоэскалация на ДП.

#### 2.10.3. Обработка "ЭкстренноеСогласование"

**Назначение:** Мастер оформления экстренного согласования.

**Шаги:**
1. Выбор уполномоченного лица из справочника;
2. Указание причины срочности (обязательная валидация);
3. Прикрепление подтверждения (скриншот, письмо);
4. Проверка лимитов (менеджер/контрагент);
5. Отправка push-уведомления уполномоченному;
6. Перевод Заказа в статус "Согласован (экстренно)".

#### 2.10.4. Обработка "УправлениеБлокировкамиЛС"

**Назначение:** Административная панель для просмотра и снятия блокировок ЛС.

**Функции:**
- Список активных блокировок (ЛС, пользователь, время, осталось);
- Кнопка принудительного снятия блокировки;
- Отчет "Топ-10 ЛС по конфликтам блокировки".

---

### 2.11. Перечисления

| Имя перечисления | Значения |
|-----------------|----------|
| СтатусыЛС | Активна, Истекла, Закрыта, Отменена |
| СтатусыЗаказаКонтроль | Черновик, ОжидаетПоступления, НаСогласовании, Отклонен, СоглИстекло, ЧастичноСогласован, Согласован, ВРаботе, Исполнен, ЗакрытЧастично, Просрочен, Отменен |
| СтатусыСогласования | НаСогласовании, Согласован, Отклонен, Аннулирован, СогласованСКорректировкой, Отозвана, Эскалирована |
| УровниСогласования | НеТребуется, РБЮ, ДиректорДРП, ДП, ГД |
| УровниОтклонения | От1до15, От15до25 |
| ПриоритетЗаявки | P1, P2 |
| ТипыРешенийСогласования | Одобрить, ОдобритьСКомментарием, ОдобритьСКорректировкой, Отклонить |
| КаналыСвязи | Телефон, Мессенджер, ЛичноеОбращение, Email |
| ТипыСанкций | Нет, МинусТриПП, МинусДесятьПП, ТолькоСтандартные |

---

### 2.12. Подписки на события

| Событие | Объект | Обработчик | Описание |
|---------|--------|-----------|----------|
| ПередЗаписью | Документ.ЗаказКлиента | ПроверкаРентабельностиПередЗаписью | Пересчет рентабельности, проверка блокировок |
| ПриПроведении | Документ.РеализацияТоваровУслуг | КонтрольРТУПриПроведении | Проверка согласования, обновление регистра рентабельности |
| ПриПроведении | Документ.ВозвратТоваровОтПокупателя | ПересчетПриВозврате | Пересчет накопленной рентабельности, проверка аннулирований |
| ПередЗаписью | Справочник.ЛокальнаяСмета | БлокировкаИзмененияПлана | Контроль изменения плановой рентабельности |

---

### 2.13. Роли и права (RLS)

| Роль | Видимость ЛС | Видимость Заказов | Согласование | Экстренное | Управление |
|------|:--------:|:---------:|:--------:|:--------:|:--------:|
| Менеджер | Свой БЮ | Свои | Нет | Да (инициирует) | Нет |
| РБЮ | Свой БЮ | Свой БЮ | Уровень 1 | Нет | Нет |
| Директор ДРП | Все БЮ | Все БЮ | Арбитраж | Нет | Нет |
| ДП | Все | Все | Уровень 2 | Нет | Да (санкции) |
| ГД | Все | Все | Уровень 3 | Нет | Нет |
| СпециалистТоварообмена | Все | Все | Нет | Нет | Удаление/отмена |
| Финансовая служба | Все (чтение) | Все (чтение) | Нет | Нет | НПСС |
| Администратор | Все | Все | Нет | Нет | Полное |

---

## 3. Интеграции

### 3.1. Интеграция с ELMA BPM (LS-INT-003)

**Направление:** 1С:УТ <-> ELMA
**Протокол:** REST API (JSON)
**Аутентификация:** OAuth 2.0 / API-ключ

#### 3.1.1. Создание задачи согласования (1С → ELMA)

**Триггер:** Заказ переходит в статус "На согласовании".

**Передаваемые данные:**
```json
{
  "taskType": "approval",
  "orderId": "string",
  "orderNumber": "string",
  "orderSum": "number",
  "deviation": "number",
  "approvalLevel": "RBU|DRP|DP|GD",
  "priority": "P1|P2",
  "assignee": "string (email/id)",
  "slaHours": "number",
  "escalationTarget": "string",
  "orderDetails": {
    "items": [...],
    "profitabilityOrder": "number",
    "profitabilityAccumulated": "number",
    "profitabilityRemainder": "number",
    "justification": "string"
  }
}
```

**SLA создания задачи:** 30 секунд.

#### 3.1.2. Получение решения (ELMA → 1С)

**Механизм:** Webhook / Polling каждые 60 секунд.

**Получаемые данные:**
```json
{
  "taskId": "string",
  "orderId": "string",
  "decision": "approved|approved_with_comment|approved_with_correction|rejected",
  "comment": "string",
  "correctedPrice": "number (опционально)",
  "decidedBy": "string",
  "decidedAt": "datetime"
}
```

#### 3.1.3. Эскалация (1С → ELMA)

**Триггер:** Превышение SLA (регламентное задание каждые 15 минут, 09:00-18:00 МСК).

**Действия:**
1. Закрытие текущей задачи с пометкой "Эскалирована";
2. Создание новой задачи на следующий уровень;
3. Уведомление исходному согласующему.

#### 3.1.4. Замещение согласующего

**Источник:** Справочник заместителей в ELMA.
**Триггер:** Отсутствие согласующего более 4 часов (отпуск, командировка).
**Действие:** Автоматическое переназначение задачи заместителю.

#### 3.1.5. Определение недоступности ELMA

- Таймаут подключения: 30 секунд;
- 3 неудачные попытки подряд = ELMA недоступна;
- При недоступности: согласование по email/телефону с фиксацией постфактум (SLA 4 часа после восстановления).

---

### 3.2. Интеграция с WMS (LS-INT-001, LS-INT-002)

**Направление:** 1С:УТ <-> WMS
**Протокол:** REST API (JSON) / MQ
**Таймаут:** 30 секунд, 3 повторные попытки.

#### 3.2.1. Передача Заказа на склад (1С → WMS)

**Триггер:** Заказ переходит в статус "Согласован" или "Без согласования" + нажатие "Передать на склад".

**Передаваемые данные:**
```json
{
  "orderId": "string",
  "items": [
    {"sku": "string", "quantity": "number", "price": "number"}
  ],
  "priority": "normal|urgent",
  "deliveryDate": "date"
}
```

**Побочный эффект:** Установка флага ПереданНаСклад (точка невозврата).

#### 3.2.2. Результат комплектации (WMS → 1С)

**Триггер:** Завершение комплектации на складе.

**Получаемые данные:**
```json
{
  "orderId": "string",
  "items": [
    {"sku": "string", "pickedQuantity": "number", "requestedQuantity": "number"}
  ],
  "status": "full|partial"
}
```

**Обработка частичной комплектации:**
1. Пересчет рентабельности для фактического количества;
2. Уведомление менеджеру с вариантами (подтвердить/отменить);
3. SLA на решение: 2 часа (при бездействии - автоотмена);
4. Если рентабельность не ухудшилась - отгрузка по факту без пересогласования.

---

### 3.3. Интеграция с EDI

**Направление:** Внешняя система → 1С:УТ
**Контекст:** Прием EDI-заказов с автоматической привязкой к ЛС.

**Правила:**
- Один EDI-заказ привязывается к одной ЛС;
- При несоответствии (позиции из разных ЛС) - отклонение с сообщением "Разбейте заказ по ЛС";
- Изменение состава невозможно (ограничение EDI-протокола);
- При отказе согласующего - отмена заказа целиком (дефолт);
- 4-часовое окно для владельца сделки: (а) согласовать без позиций отказавшего БЮ, (б) эскалировать;
- Автоуведомление клиента об отмене через EDI-канал.

---

## 4. Фоновые задания

### 4.1. Регламентное задание "КонтрольSLAСогласования"

| Параметр | Значение |
|----------|----------|
| Расписание | Каждые 15 минут, 09:00-18:00 МСК (по производственному календарю РФ) |
| Таймаут | 5 минут |
| Retry | 3 попытки с интервалом 1 мин. |
| Мониторинг | Запись в журнал регистрации; алерт администратору при 3+ неудачах подряд |

**Алгоритм:**
1. Выбрать все заявки со статусом "На согласовании";
2. Для каждой проверить: время с момента создания > SLA;
3. Если превышен SLA:
   - Для РБЮ: создать задачу Директору ДРП;
   - Для ДП: создать задачу ГД;
   - Для ГД (48ч): проверить исключение (Накопл+Заказ = план);
     - Если да - автосогласование;
     - Если нет - автоотказ;
4. Уведомить исходного согласующего об эскалации;
5. Обновить историю согласования.

**Обработка ошибок:**
- При недоступности ELMA - записать в очередь, повторить при следующем запуске;
- При ошибке отдельной заявки - продолжить обработку остальных, записать ошибку в журнал.

---

### 4.2. Регламентное задание "АвтоудалениеПросроченныхЧерновиков"

| Параметр | Значение |
|----------|----------|
| Расписание | Ежедневно, 00:00 МСК |
| Таймаут | 10 минут |
| Retry | 2 попытки с интервалом 5 мин. |
| Мониторинг | Журнал регистрации, счетчик удаленных |

**Алгоритм:**
1. Выбрать Заказы в статусе "Черновик" старше 7 дней;
2. Отправить уведомление менеджерам (за 3 дня - первое предупреждение);
3. Если прошло 7 дней: перевести в статус "Просрочен";
4. Снять блокировки ЛС (если черновик блокировал запись).

---

### 4.3. Регламентное задание "АннулированиеИстекшихСогласований"

| Параметр | Значение |
|----------|----------|
| Расписание | Ежедневно, 00:00 МСК |
| Таймаут | 10 минут |
| Retry | 2 попытки с интервалом 5 мин. |
| Мониторинг | Журнал регистрации |

**Алгоритм:**
1. Выбрать все заявки со статусом "Согласован" старше 5 рабочих дней;
2. Проверить флаг ПереданНаСклад (если установлен - пропустить);
3. Аннулировать согласование, перевести Заказ в "Согл. истекло";
4. Уведомить менеджера.

---

### 4.4. Регламентное задание "ЗакрытиеИстекшихЛС"

| Параметр | Значение |
|----------|----------|
| Расписание | Ежедневно, 00:00 МСК |
| Таймаут | 15 минут |
| Retry | 2 попытки с интервалом 5 мин. |
| Мониторинг | Журнал регистрации |

**Алгоритм:**
1. Выбрать ЛС со статусом "Истекла" без активных Заказов, прошло 5 р.д.;
2. Отправить уведомление менеджерам (за 3 дня - предупреждение);
3. Перевести в статус "Закрыта";
4. Аннулировать Заказы в статусах "На согласовании" и "Ожидает поступления";
5. Сохранить Заказы "Согласован" на 5 р.д.;
6. Заказы "В работе" - обработать до конца.

---

### 4.5. Регламентное задание "ПересчетСанкций" (P2)

| Параметр | Значение |
|----------|----------|
| Расписание | Ежедневно, 02:00 МСК |
| Таймаут | 30 минут |
| Retry | 3 попытки с интервалом 15 мин. |
| Мониторинг | Алерт ФД при ошибке; запись в журнал |

**Алгоритм:**
1. Для всех закрытых ЛС за последние 60 дней - проверить поступление возвратов;
2. Пересчитать % выкупа с учетом возвратов 60д;
3. Если % выкупа снизился ниже 90% - применить санкцию по матрице;
4. Записать в регистр санкций;
5. Уведомить менеджера о применении/изменении санкции.

**Обработка ошибок:**
- При ошибке на конкретной ЛС - логировать, продолжить со следующей;
- При 3+ ошибках подряд - приостановить, алерт администратору и ФД.

---

### 4.6. Регламентное задание "Реабилитация" (P2)

| Параметр | Значение |
|----------|----------|
| Расписание | Ежедневно, 03:00 МСК |
| Таймаут | 10 минут |
| Retry | 2 попытки |
| Мониторинг | Журнал регистрации |

**Алгоритм:**
1. Проверить клиентов с активными санкциями;
2. Если нет закрытых ЛС с нарушением за последние 6 месяцев - снять санкцию;
3. Обнулить счетчик;
4. Уведомить менеджера.

---

### 4.7. Регламентное задание "ОчисткаБлокировок"

| Параметр | Значение |
|----------|----------|
| Расписание | Каждые 5 минут |
| Таймаут | 1 минута |
| Retry | Не требуется |

**Алгоритм:**
1. Проверить все записи в регистре блокировок;
2. Удалить записи с истекшим временем (ВремяИстечения < ТекущееВремя);
3. Записать в журнал.

---

## 5. Оценка трудоемкости

### 5.1. Разработка по объектам (P1 - MVP)

| Категория | Объект | Часы |
|-----------|--------|-----:|
| **Справочники** | ЛокальнаяСмета (с формами, правами, RLS) | 40 |
| | УполномоченныеЛица | 8 |
| | СтратегическиеКлиенты | 12 |
| | **Итого справочники** | **60** |
| **Документы** | ЗаявкаНаСогласование (формы, статусы, алгоритмы) | 80 |
| | ЭкстренноеСогласование (формы, лимиты, push) | 40 |
| | Расширение ЗаказКлиента (реквизиты, подписки, интерфейс) | 60 |
| | Расширение РТУ (подписка, проверка) | 24 |
| | Расширение Возврат (подписка, пересчет) | 16 |
| | **Итого документы** | **220** |
| **Регистры** | РентабельностьЛС | 16 |
| | НПССПозиций | 12 |
| | SLAСогласования | 8 |
| | НарушенияМенеджеров | 8 |
| | БлокировкиЛС | 12 |
| | ЖурналАудитаЛС | 8 |
| | СчетчикЭкстренных | 8 |
| | **Итого регистры** | **72** |
| **Отчеты** | ОтчетРентабельности (LS-RPT-013) | 24 |
| | ДашбордМенеджера | 32 |
| | ДашбордСогласующего (LS-FR-045) | 24 |
| | Устаревшие НПСС (LS-RPT-038) | 8 |
| | Конфликты блокировки (LS-RPT-043) | 8 |
| | Сверочный WMS-1С (LS-BR-044) | 16 |
| | Соблюдение SLA (LS-FR-046) | 16 |
| | **Итого отчеты** | **128** |
| **Обработки** | ПанельМенеджера (интерактивный пересчет) | 40 |
| | АрбитражДиректора (мульти-БЮ) | 24 |
| | ЭкстренноеСогласование (мастер) | 20 |
| | УправлениеБлокировкамиЛС | 12 |
| | **Итого обработки** | **96** |
| **Интеграции** | ELMA BPM (создание/получение задач, эскалация, замещение) | 80 |
| | WMS (передача/прием, частичная комплектация) | 48 |
| | EDI (привязка к ЛС, обработка отказов) | 32 |
| | **Итого интеграции** | **160** |
| **Бизнес-процессы** | Матрица согласования (логика определения уровня) | 24 |
| | Аннулирование согласований (6 триггеров) | 20 |
| | Жизненный цикл ЛС (статусы, переходы) | 16 |
| | Жизненный цикл Заказа (11 статусов, переходы) | 20 |
| | Контроль возраста НПСС (3 уровня) | 12 |
| | Контроль изменения плановой рентабельности | 12 |
| | Защита от гонки (блокировки, атомарные операции) | 16 |
| | **Итого БП** | **120** |
| **Фоновые задания** | КонтрольSLA (15 мин.) | 16 |
| | АвтоудалениеЧерновиков | 8 |
| | АннулированиеИстекших | 8 |
| | ЗакрытиеЛС | 12 |
| | ОчисткаБлокировок | 4 |
| | **Итого фоновые** | **48** |
| **Перечисления, общие модули** | Перечисления (9 шт.), общие модули | 24 |
| **RLS** | Настройка RLS по БЮ для 8 ролей | 24 |

### 5.2. Разработка P2 (Этап 2)

| Категория | Объект | Часы |
|-----------|--------|-----:|
| Справочники | Расширение ЛокальнаяСмета (статус ОжидаетПоступления) | 8 |
| Регистры | СанкцииКлиентов | 12 |
| | ИсторияАвтопродлений | 8 |
| | ФиксацияПотребности | 16 |
| Логика санкций | Расчет % выкупа, матрица санкций, реабилитация | 40 |
| Логика дефицита | Фиксация потребности, подтвержденный дефицит, автопродление | 40 |
| Фоновые задания | ПересчетСанкций, Реабилитация | 16 |
| Отчеты P2 | RPT-060, 065, 066, 067, 068, KPI (6 отчетов) | 56 |
| **Итого P2** | | **196** |

### 5.3. Сводная оценка

| Фаза | P1 (MVP) | P2 (Этап 2) | Итого |
|------|:--------:|:-----------:|:-----:|
| **Разработка** | 952 ч | 196 ч | 1 148 ч |
| **Тестирование** (40% от разработки) | 381 ч | 78 ч | 459 ч |
| **Документация** (10% от разработки) | 95 ч | 20 ч | 115 ч |
| **Развертывание и миграция** | 40 ч | 16 ч | 56 ч |
| **Обучение пользователей** | 40 ч | 16 ч | 56 ч |
| **Подитого** | 1 508 ч | 326 ч | 1 834 ч |
| **Буфер рисков (+25%)** | 377 ч | 82 ч | 459 ч |
| **ИТОГО** | **1 885 ч** | **408 ч** | **2 293 ч** |

### 5.4. Оценка в человеко-месяцах

При 168 рабочих часов в месяц:

| Фаза | Команда | Срок |
|------|---------|------|
| **P1 (MVP)** | 3 разработчика 1С + 1 аналитик + 1 тестировщик | ~3,5 месяца |
| **P2 (Этап 2)** | 2 разработчика 1С + 1 тестировщик | ~1,5 месяца |
| **Итого** | | ~5 месяцев |

### 5.5. Распределение по ролям

| Роль | P1 часы | P2 часы | Итого |
|------|--------:|--------:|------:|
| 1С-разработчик (3 чел.) | 1 190 ч | 238 ч | 1 428 ч |
| Системный аналитик | 190 ч | 42 ч | 232 ч |
| Тестировщик | 381 ч | 78 ч | 459 ч |
| DevOps / администратор | 40 ч | 16 ч | 56 ч |
| Бизнес-тренер | 40 ч | 16 ч | 56 ч |
| Руководитель проекта | 44 ч | 18 ч | 62 ч |

---

## 6. Критерии приемки

### 6.1. Функциональные критерии

| # | Критерий | Метод проверки |
|---|----------|---------------|
| 1 | Расчет рентабельности Заказа по базовой формуле дает результат с точностью до 2 знаков | TC-CORE-001, TC-CORE-007 |
| 2 | Блокировка при НПСС=0/NULL с уведомлением финслужбы | TC-CORE-002, TC-CORE-003 |
| 3 | Корректное определение уровня согласования по матрице п. 3.4 | TC-CORE-008 - TC-CORE-012 |
| 4 | Автосогласование при отклонении < 1 п.п. | TC-CORE-005, TC-EXT-003 |
| 5 | Автоэскалация при превышении SLA | TC-CORE-013, TC-EXT-005 |
| 6 | Аннулирование согласования по 6 триггерам | TC-EXT-004 |
| 7 | Точка невозврата (ПереданНаСклад) защищает от аннулирования | TC-EXT-004 (шаг 6) |
| 8 | Экстренное согласование с проверкой лимитов | TC-CORE-017 - TC-CORE-019 |
| 9 | Мульти-БЮ: параллельное согласование и арбитраж | TC-CORE-020 - TC-CORE-022, TC-EXT-013 |
| 10 | Жизненный цикл Заказа: все переходы статусов | TC-EXT-003 |
| 11 | Жизненный цикл ЛС: закрытие, истечение, отмена | TC-EXT-003, TC-EXT-025 |
| 12 | Блокировка ЛС при одновременном редактировании (15 мин.) | TC-EXT-002 |
| 13 | Контроль возраста НПСС (3 уровня) | TC-EXT-017, TC-EXT-018 |
| 14 | Интеграция с ELMA: создание/получение/эскалация | TC-CORE-013 |
| 15 | Интеграция с WMS: передача/прием, частичная комплектация | TC-CORE-029 |
| 16 | Все 65 тест-кейсов проходят успешно | Матрица трассируемости |

### 6.2. Нефункциональные критерии

| # | Критерий | Целевое значение |
|---|----------|-----------------|
| 1 | Расчет рентабельности (до 500 позиций) | <= 2 секунд (LS-NFR-001) |
| 2 | Максимум позиций в ЛС | 1000 (LS-NFR-002) |
| 3 | Максимум Заказов на согласовании по ЛС | 50 (LS-NFR-003) |
| 4 | Обработка сообщения WMS | <= 30 секунд (LS-NFR-004) |
| 5 | Одновременные пользователи | 10-50 |
| 6 | Блокировка ЛС: ожидание | <= 30 секунд, затем сообщение |
| 7 | Атомарная блокировка остатка ЛС | <= 10 секунд |
| 8 | RLS: менеджер видит только свой БЮ | LS-SEC-001 |
| 9 | Журнал аудита: хранение | 5 лет, без возможности удаления |

---

## 7. Неопределенности

В ходе аудита v1.0.6 выявлены 9 бизнес-вопросов (B1-B9), требующих решения до начала разработки. Ниже приведена связь каждого вопроса с затрагиваемыми объектами и дельта трудоемкости при различных вариантах решения.

### B1 (CRITICAL) - SLA для заказов < 100 т.р.

**Проблема:** Указано "всегда P2, SLA вдвое", но P2/2 дает 12ч/24ч/36ч - не совпадает с написанными 2ч/4ч/12ч.

**Затронутые объекты:** РегистрСведений.SLAСогласования, КонтрольSLAСогласования (фоновое задание).

**Варианты решения:**
1. Это отдельный P3 (три яруса SLA) - дельта +16 ч (новое значение перечисления, дополнительная логика);
2. Это P2 с делением пополам - дельта 0 ч (текущая реализация);
3. Уточненные значения (2ч/4ч/12ч как есть) - дельта +8 ч (жесткая таблица).

### B2 (CRITICAL) - Согласование с корректировкой цены

**Проблема:** Нет описания полного цикла: автозамена цены, рекурсия проверки, EDI-ограничения.

**Затронутые объекты:** Документ.ЗаявкаНаСогласование, ФормаСогласующего, Расширение ЗаказКлиента.

**Варианты решения:**
1. Полный цикл с автозаменой + рекурсивная проверка - дельта +40 ч;
2. Корректировка как рекомендация (менеджер вносит вручную) - дельта +8 ч;
3. Не реализовывать (только одобрить/отклонить) - дельта -16 ч.

### B3 (CRITICAL) - Логический резерв ЛС при дефиците

**Проблема:** 48ч vs 90 дней, блокирует vs не блокирует - противоречие в ФМ.

**Затронутые объекты:** РегистрСведений.ФиксацияПотребности, Расширение ЗаказКлиента (P2).

**Варианты решения:**
1. 48ч блокирующий резерв + 90 дней ожидания без блокировки - дельта 0 ч (текущая интерпретация);
2. 90 дней блокирующий резерв - дельта +16 ч (усложнение логики);
3. Только информационная фиксация без резерва - дельта -8 ч.

### B4 (CRITICAL) - Фоновое задание пересчета санкций

**Проблема:** Нет retry/timeout/мониторинга.

**Затронутые объекты:** РегламентноеЗадание.ПересчетСанкций (P2).

**Варианты решения:**
1. Полная спецификация (retry 3x15min, таймаут 2ч, алерт ФД) - дельта +8 ч;
2. Базовый retry без мониторинга - дельта +4 ч;
3. Без retry (перезапуск вручную) - дельта 0 ч.

**Рекомендация:** Вариант 1 (уже заложен в оценку выше).

### B5 (HIGH) - Терминальное поведение при автоотказе ГД

**Проблема:** После автоотказа ГД (48ч) - что дальше? Нет эскалации выше.

**Затронутые объекты:** Документ.ЗаявкаНаСогласование, КонтрольSLAСогласования.

**Варианты решения:**
1. Уведомление CFO/совета + пометка "автоматический" - дельта +12 ч;
2. Только логирование и возможность повторной подачи - дельта 0 ч;
3. Блокировка повторной подачи до ручного вмешательства - дельта +4 ч.

### B6 (HIGH) - Улучшение рентабельности во время согласования

**Проблема:** Если отклонение уменьшилось с уровня ДП до РБЮ - нет правила снижения уровня.

**Затронутые объекты:** Документ.ЗаявкаНаСогласование, КонтрольSLAСогласования.

**Варианты решения:**
1. Пересоздание задачи на нижнем уровне - дельта +16 ч;
2. Оставить текущему (ДП сам решит) - дельта 0 ч;
3. Автосогласование при уходе отклонения < 1 п.п. - дельта +8 ч.

### B7 (HIGH) - Формулы "Выручка отгруженного" - нетто или брутто

**Проблема:** ФМ не уточняет, учитываются ли возвраты в формуле.

**Затронутые объекты:** РегистрСведений.РентабельностьЛС, все расчеты рентабельности.

**Варианты решения:**
1. Нетто (с учетом возвратов) - дельта +8 ч (дополнительная логика пересчета);
2. Брутто (без учета) - дельта 0 ч;
3. Оба варианта (основной нетто, справочный брутто) - дельта +16 ч.

**Рекомендация:** Вариант 1 (нетто).

### B8 (HIGH) - Автопродление ЛС + НПСС > 90 дней

**Проблема:** Автопродление при позднем поступлении может конфликтовать с блокировкой по возрасту НПСС.

**Затронутые объекты:** Справочник.ЛокальнаяСмета, логика контроля НПСС (P2).

**Варианты решения:**
1. При автопродлении проверка НПСС приостанавливается - дельта +4 ч;
2. Автопродление не влияет на НПСС (блокировка остается) - дельта 0 ч;
3. Автопродление триггерит пересчет НПСС - дельта +12 ч.

### B9 (HIGH) - Определение подтвержденного дефицита

**Проблема:** ФМ описывает ручное определение РБЮ, но правила алгоритмические.

**Затронутые объекты:** РегистрСведений.ФиксацияПотребности, ПересчетСанкций (P2).

**Варианты решения:**
1. Автоматическое определение, РБЮ только для споров (SLA 3 дня) - дельта +16 ч;
2. Полностью ручное (РБЮ каждый раз) - дельта -8 ч;
3. Автоматическое + ручное подтверждение - дельта +24 ч.

### Сводная таблица неопределенностей

| Вопрос | Серьезность | Влияние на P1 | Влияние на P2 | Дельта (мин-макс) |
|--------|:-----------:|:-------:|:-------:|:---------:|
| B1 | CRITICAL | Да | Нет | 0 - +16 ч |
| B2 | CRITICAL | Да | Нет | -16 - +40 ч |
| B3 | CRITICAL | Нет | Да | -8 - +16 ч |
| B4 | CRITICAL | Нет | Да | 0 - +8 ч |
| B5 | HIGH | Да | Нет | 0 - +12 ч |
| B6 | HIGH | Да | Нет | 0 - +16 ч |
| B7 | HIGH | Да | Нет | 0 - +16 ч |
| B8 | HIGH | Нет | Да | 0 - +12 ч |
| B9 | HIGH | Нет | Да | -8 - +24 ч |
| **Суммарная дельта** | | | | **-32 - +160 ч** |

**Рекомендация:** Решить B1-B4 (CRITICAL) до начала разработки. B5-B9 (HIGH) можно уточнить в процессе, но до начала соответствующего модуля.

---

## 8. Этапы реализации

### Этап 0: Подготовка (2 недели)

**Цель:** Подготовка инфраструктуры и снятие неопределенностей.

| Задача | Срок | Ответственный |
|--------|------|---------------|
| Решить бизнес-вопросы B1-B4 (CRITICAL) | 1 неделя | Аналитик + ДП + ФД |
| Согласовать приоритизацию P1/P2 | 1 неделя | ДП |
| Настроить окружение (расширение, тестовая база, ELMA sandbox) | 1 неделя | DevOps |
| Заполнить справочник НПСС (для пилота) | 2 недели | ФС |
| Решить бизнес-вопросы B5-B9 (HIGH) | 2 недели | Аналитик + ДП |

### Этап 1: Ядро (MVP) - 6 недель

**Цель:** Базовый контроль рентабельности с согласованием.

| Спринт | Объекты | Часы |
|--------|---------|-----:|
| Спринт 1 (2 нед.) | Справочники (ЛС, Уполномоченные), перечисления, регистры (НПСС, Рентабельность, Блокировки), журнал аудита | ~200 |
| Спринт 2 (2 нед.) | Документ ЗаявкаНаСогласование, расширение ЗаказКлиента, матрица согласования, аннулирование, жизненный цикл Заказа | ~250 |
| Спринт 3 (2 нед.) | Документ ЭкстренноеСогласование, обработки (ПанельМенеджера, Арбитраж), фоновые задания (SLA, черновики, аннулирование) | ~200 |

### Этап 2: Интеграции - 4 недели

**Цель:** Подключение ELMA, WMS, EDI.

| Спринт | Объекты | Часы |
|--------|---------|-----:|
| Спринт 4 (2 нед.) | Интеграция ELMA (задачи, эскалация, замещение), интеграция WMS (передача, комплектация) | ~200 |
| Спринт 5 (2 нед.) | Интеграция EDI, расширение РТУ и Возврат, RLS, отчеты P1 | ~200 |

### Этап 3: Тестирование и пилот - 4 недели

**Цель:** Полное тестирование, запуск пилота.

| Неделя | Задачи |
|--------|--------|
| 1-2 | Выполнение 65 тест-кейсов, исправление дефектов |
| 3 | Пилот на 1-2 БЮ в режиме "мягкий контроль" (предупреждения без блокировок) |
| 4 | Анализ результатов пилота, корректировка порогов, обучение |

### Этап 4: Продуктив P1 + переход на "жесткий контроль" - 2 недели

**Цель:** Полномасштабное внедрение MVP.

| Неделя | Задачи |
|--------|--------|
| 1 | Включение блокировок, горячая линия поддержки |
| 2 | Мониторинг, корректировки, стабилизация |

### Этап 5: P2 (Этап 2) - 6 недель (через 3 месяца пилота)

**Цель:** Обеспечение наличием, санкции за невыкуп.

| Спринт | Объекты | Часы |
|--------|---------|-----:|
| Спринт 6 (2 нед.) | Регистры P2 (Санкции, Фиксация, Автопродление), логика дефицита | ~120 |
| Спринт 7 (2 нед.) | Логика санкций, фоновые задания (Пересчет, Реабилитация), отчеты P2 | ~120 |
| Спринт 8 (2 нед.) | Тестирование P2, пилот санкций | ~90 |

### Сводный таймлайн

```
Нед. 1-2:   [Этап 0: Подготовка]
Нед. 3-8:   [Этап 1: Ядро (MVP)]
Нед. 9-12:  [Этап 2: Интеграции]
Нед. 13-16: [Этап 3: Тестирование + Пилот]
Нед. 17-18: [Этап 4: Продуктив P1]
--- 3 месяца пилот (сбор данных) ---
Нед. 30-36: [Этап 5: P2 (санкции, дефицит)]
```

**Общий срок:** ~9 месяцев от старта до полного внедрения (P1 + P2).

---

## Приложение: Связь требований ФМ с объектами разработки

| Код ФМ | Наименование | Объект разработки |
|--------|-------------|-------------------|
| LS-BR-001 | Расчет рентабельности | ОбщийМодуль.РасчетРентабельности |
| LS-BR-002 | Рентабельность остатка | ОбщийМодуль.РасчетРентабельности |
| LS-BR-003 | Накопленная рентабельность | РегистрСведений.РентабельностьЛС |
| LS-BR-004 | Блокировка Заказа | Расширение ЗаказКлиента |
| LS-FR-005 | Форма обоснования | Документ.ЗаявкаНаСогласование |
| LS-FR-006 | Визуализация рентабельности | Обработка.ПанельМенеджера |
| LS-WF-007 | Экстренное согласование | Документ.ЭкстренноеСогласование |
| LS-WF-008 | SLA и автоэскалация | РегистрСведений.SLAСогласования + фоновое задание |
| LS-BR-009 | Фиксация НПСС | Справочник.ЛокальнаяСмета |
| LS-BR-010 | Учет параллельных Заказов | ОбщийМодуль.РасчетОстаткаЛС |
| LS-FR-011 | Срок действия согласования | Фоновое задание.АннулированиеИстекших |
| LS-FR-012 | Статусы Заказа | Перечисление.СтатусыЗаказаКонтроль |
| LS-INT-001 | Интеграция 1С→WMS | ОбщийМодуль.ИнтеграцияWMS |
| LS-INT-002 | Интеграция WMS→1С | ОбщийМодуль.ИнтеграцияWMS |
| LS-INT-003 | Интеграция 1С↔ELMA | ОбщийМодуль.ИнтеграцияELMA |
| LS-BR-035 | Блокировка ЛС | РегистрСведений.БлокировкиЛС |
| LS-FR-041 | Журнал аудита | РегистрСведений.ЖурналАудитаЛС |
| LS-FR-045 | Дашборд согласующего | Обработка.ДашбордСогласующего |
| LS-WF-058 | Расчет % выкупа (P2) | ОбщийМодуль.РасчетСанкций |
| LS-WF-059 | Применение санкций (P2) | РегистрСведений.СанкцииКлиентов |
| LS-SEC-001 | RLS по БЮ | Роли и права доступа |

---

*Документ подготовлен на основании FM-LS-PROFIT v1.0.6, аудита v1.0.6 и 65 тест-кейсов.*
*Оценка трудоемкости является экспертной и подлежит уточнению после снятия неопределенностей B1-B9.*

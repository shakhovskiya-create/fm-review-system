# Архитектура данных 1С:УТ - FM-LS-PROFIT v1.0.6

**Дата:** 13.02.2026
**Агент:** Agent 5 (Tech Architect)
**Версия ФМ:** 1.0.6 (Confluence v49)
**Платформа:** 1С:Управление Торговлей (1C:УТ)
**Пользователи:** 10-50 одновременных
**Целевое время обработки:** <= 3 секунд

---

## Содержание

1. [Архитектура данных](#1-архитектура-данных)
2. [Роли и права](#2-роли-и-права)
3. [Бизнес-процессы](#3-бизнес-процессы)
4. [Фоновые задания](#4-фоновые-задания)
5. [Ключевые точки контроля](#5-ключевые-точки-контроля)
6. [Потенциальные блокировки](#6-потенциальные-блокировки)
7. [Интеграции](#7-интеграции)

---

## 1. Архитектура данных

### 1.1. Справочники (Каталоги)

#### 1.1.1. ЛокальнаяСмета (расширение существующего документа/справочника)

Центральный объект учета - локальная смета клиента.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Код | Строка(11) | Уникальный идентификатор ЛС |
| Контрагент | СправочникСсылка.Контрагенты | Клиент |
| ДатаСоздания | Дата | Дата создания ЛС |
| ДатаОкончания | Дата | Дата окончания срока действия |
| Статус | ПеречислениеСсылка.СтатусыЛС | Активна / Истекла / Закрыта / Отменена |
| ПлановаяРентабельность | Число(5,2) | Плановая рентабельность (%), зафиксированная при согласовании |
| Менеджер | СправочникСсылка.Пользователи | Ответственный менеджер |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Основной бизнес-юнит |
| СуммаЛС | Число(15,2) | Общая сумма ЛС в рублях |
| КоличествоПродлений | Число(1,0) | Количество выполненных продлений (макс. 2) |
| ДатаФиксацииНПСС | Дата | Дата, на которую зафиксирована НПСС |
| РекомендательныйКонтроль | Булево | Признак рекомендательного контроля при создании ЛС (если плановая рент. < 5%) |

**Табличная часть «Позиции»:**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Товар |
| Количество | Число(10,3) | Количество в ЛС |
| Цена | Число(15,2) | Цена позиции |
| Сумма | Число(15,2) | Сумма позиции |
| НПСС | Число(15,2) | Зафиксированная НПСС на момент создания ЛС |
| Рентабельность | Число(5,2) | Рассчитанная рентабельность позиции (%) |
| МинДопустимаяЦена | Число(15,2) | НПСС / (1 - Рент_ЛС_план / 100) |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ позиции (определяется по номенклатуре) |

**Жизненный цикл статусов:**

```
Создание → [Активна] → [Истекла] → [Закрыта]
              ↓               ↓
          [Закрыта]    Продление → [Активна]
              ↓
          (полная отгрузка)

Создание → [Активна] → [Отменена] (0 отгрузок)
```

---

#### 1.1.2. УполномоченныеЛица

Справочник уполномоченных лиц для экстренных согласований (п. 3.7).

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Код | Строка(9) | Идентификатор |
| ФИО | Строка(150) | ФИО сотрудника |
| Пользователь | СправочникСсылка.Пользователи | Связь с учетной записью 1С |
| УровеньПолномочий | ПеречислениеСсылка.УровниСогласования | Уровень: РБЮ (1-15), ДП (15.01-25), ГД (>25) |
| ДатаНачала | Дата | Дата начала полномочий |
| ДатаОкончания | Дата | Дата окончания (пусто = бессрочно) |
| Активен | Булево | Признак активности (снимается при увольнении/переводе) |
| Заместитель | СправочникСсылка.УполномоченныеЛица | Заместитель при отсутствии |

**Плановая актуализация:** ежемесячно (HR-служба). Интеграция с HR-системой: автоматическое исключение при увольнении/переводе.

---

#### 1.1.3. СтратегическиеКлиенты

Реестр стратегически важных клиентов (п. 3.18).

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Контрагент | СправочникСсылка.Контрагенты | Клиент |
| КритерийОтнесения | ПеречислениеСсылка.КритерииСтратегичности | (а) оборот >= 10 млн, (б) реестр ДРП, (в) контракт >= 1 млн |
| ДатаВключения | Дата | Дата включения в реестр |
| ОснованиеВключения | Строка(500) | Обоснование |
| ДопустимоеОтклонение | Число(5,2) | Допустимое отклонение от стандартных порогов (п.п.) |
| Ответственный | СправочникСсылка.Пользователи | Кто включил в реестр |
| КоличествоОтменСанкций | Число(2,0) | Количество отмен санкций за текущий год (макс. 3) |

**Актуализация:** ежеквартально, ведет Директор ДРП. SLA включения: 3 р.д. (заявка менеджера -> одобрение ДП).

---

#### 1.1.4. ДежурныеСогласующие

Справочник дежурных согласующих (FAQ п. 9).

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Пользователь | СправочникСсылка.Пользователи | Согласующий |
| Роль | ПеречислениеСсылка.РолиСогласующих | РБЮ / Директор ДРП / ДП / ГД |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Для РБЮ - его бизнес-юнит |
| ДатаНачалаДежурства | Дата | Начало дежурства |
| ДатаОкончанияДежурства | Дата | Окончание дежурства |
| Заместитель | СправочникСсылка.Пользователи | Заместитель на период отсутствия |
| ДоступенОнлайн | Булево | Индикатор доступности (синхронизируется из ELMA) |

---

#### 1.1.5. АктивныеБлокировкиЛС

Справочник текущих блокировок ЛС (LS-FR-036, п. 3.15).

| Реквизит | Тип | Описание |
|----------|-----|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Заблокированная ЛС |
| Пользователь | СправочникСсылка.Пользователи | Кто заблокировал |
| ВремяБлокировки | Дата | Время установки блокировки |
| ВремяИстечения | Дата | Время автоматического снятия (через 15 мин) |
| ТипОперации | Строка(50) | Создание Заказа / Редактирование Заказа |

---

### 1.2. Перечисления

| Имя перечисления | Значения | Описание |
|------------------|----------|----------|
| СтатусыЛС | Активна, Истекла, Закрыта, Отменена | Статусы жизненного цикла ЛС |
| СтатусыЗаказаКонтроль | Черновик, ОжидаетПоступления, НаСогласовании, Отклонен, СоглИстекло, ЧастичноСогласован, Согласован, ВРаботе, Исполнен, ЗакрытЧастично, Просрочен, Отменен | Статусы жизненного цикла Заказа |
| УровниСогласования | РБЮ, ДиректорДРП, ДП, ГД | Уровни цепочки согласования |
| ПриоритетыЗаказа | P1, P2 | P1 (>500 т.р. или экстренные), P2 (стандартные) |
| ТипыСогласования | Стандартное, Экстренное, Постфактум | Тип процедуры согласования |
| РешенияСогласования | Одобрено, Отклонено, СогласованоСКорректировкой, Эскалировано, АвтоОтказ | Решения согласующего |
| ТипыСанкций | Нет, СнижениеСкидки3, СнижениеСкидки10, ТолькоСтандартныеЦены | Типы санкций за невыкуп |
| КритерииСтратегичности | ОборотБолее10Млн, РеестрДРП, КонтрактБолее1Млн | Критерии стратегического клиента |
| РолиСогласующих | РБЮ, ДиректорДРП, ДП, ГД | Роли в процессе согласования |
| ПричиныНезакрытогоОстатка | ОшибкаМенеджера, ИзменениеПотребности, ДефицитКомпании | Классификация причин (п. 3.18) |
| РеакцияНаВозрастНПСС | БезОграничений, Предупреждение, ТребуетсяПодтверждениеРБЮ, Блокировка | Реакции на возраст НПСС |

---

### 1.3. Документы

#### 1.3.1. ЗаказКлиента (расширение существующего документа)

Основной документ контроля рентабельности. Расширяется дополнительными реквизитами.

**Дополнительные реквизиты шапки:**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Привязка к ЛС |
| СтатусКонтроля | ПеречислениеСсылка.СтатусыЗаказаКонтроль | Статус в цепочке согласования |
| РентабельностьЗаказа | Число(5,2) | Рентабельность данного Заказа (%) |
| НакопленнаяПлюсЗаказ | Число(5,2) | (Накопленная + Заказ) (%) |
| РентабельностьОстатка | Число(5,2) | Рентабельность остатка ЛС (%) |
| Отклонение | Число(5,2) | Максимальное отклонение от плана (п.п.) |
| ТребуемыйУровень | ПеречислениеСсылка.УровниСогласования | Кто должен согласовать (или NULL - не требуется) |
| Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | P1 или P2 |
| ОбоснованиеМенеджера | Строка(1000) | Обоснование отклонения (мин. 50 символов) |
| СогласующийФИО | Строка(150) | ФИО текущего согласующего |
| ДатаСогласования | Дата | Дата получения согласования |
| СрокДействияСогласования | Дата | Дата + 5 рабочих дней |
| РешениеСогласования | ПеречислениеСсылка.РешенияСогласования | Решение |
| КомментарийСогласующего | Строка(2000) | Комментарий при отказе/корректировке |
| ТипСогласования | ПеречислениеСсылка.ТипыСогласования | Стандартное / Экстренное / Постфактум |
| ПереданНаСклад | Булево | Точка невозврата (после установки согласование не аннулируется) |
| ДатаПередачиНаСклад | Дата | Дата передачи на склад |
| ИсточникЗаказа | Строка(20) | Ручной / EDI |
| КоличествоАннулирований | Число(2,0) | Счетчик аннулирований (при >= 3 - эскалация на ДП) |
| ДатаСозданияЧерновика | Дата | Для контроля автоудаления (7 дней) |

**Дополнительные реквизиты табличной части «Товары»:**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| НПСС | Число(15,2) | НПСС из ЛС (зафиксированная) |
| РентабельностьПозиции | Число(5,2) | (Цена - НПСС) / Цена * 100 |
| МинДопустимаяЦена | Число(15,2) | Минимальная цена без согласования |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ позиции |
| ПризнакНеликвид | Булево | Товар с признаком «неликвид» и спецценой |
| ОтклонениеОтЦеныЛС | Число(5,2) | Расхождение с ценой в ЛС (%) |

**Жизненный цикл статусов Заказа:**

```
[Черновик] → [На согласовании] → [Согласован] → [В работе] → [Исполнен]
    |              |                    |                          |
    |              ↓                    ↓                          ↓
    |         [Отклонен]→[Черновик]  [Согл.истекло]→[Черновик]  [Закрыт частично]
    |
    ↓
[Ожидает поступления] → [На согласовании]
    |
    ↓
[Просрочен] (7 дней без действий)

[Отменен] (из Черновик, Отклонен, Согл.истекло)

Мульти-БЮ: [На согласовании] → [Частично согласован] → [Согласован]
                                         ↓
                                    [Черновик] (удалены позиции)
```

---

#### 1.3.2. ЗаявкаНаСогласование

Документ для маршрутизации согласования через ELMA.

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер заявки |
| Дата | Дата | Дата создания |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Заказ-основание |
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | ЛС |
| Инициатор | СправочникСсылка.Пользователи | Менеджер |
| Отклонение | Число(5,2) | Отклонение от плана (п.п.) |
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | Требуемый уровень |
| Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | P1 / P2 |
| SLAЧасов | Число(3,0) | Время на решение (рабочие часы) |
| ДатаДедлайна | Дата | Дата/время истечения SLA |
| Согласующий | СправочникСсылка.Пользователи | Текущий согласующий |
| Решение | ПеречислениеСсылка.РешенияСогласования | Принятое решение |
| КомментарийСогласующего | Строка(2000) | Комментарий |
| ИсторияМаршрутизации | Строка(5000) | JSON: кому назначалось, когда, решение/таймаут |
| ПовторнаяПодача | Булево | Признак повторной подачи после отклонения |
| НомерПопытки | Число(2,0) | Счетчик попыток |

**Табличная часть «Согласующие» (для мульти-БЮ):**

| Реквизит | Тип | Описание |
|----------|-----|----------|
| БизнесЮнит | СправочникСсылка.БизнесЮниты | БЮ |
| Согласующий | СправочникСсылка.Пользователи | РБЮ этого БЮ |
| Решение | ПеречислениеСсылка.РешенияСогласования | Решение РБЮ по его БЮ |
| ДатаРешения | Дата | Когда принял решение |
| Комментарий | Строка(2000) | Комментарий |

---

#### 1.3.3. ЭкстренноеСогласование

Документ фиксации экстренного (внесистемного) согласования (п. 3.7).

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер документа |
| Дата | Дата | Дата фиксации |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Заказ |
| Менеджер | СправочникСсылка.Пользователи | Инициатор |
| УполномоченноеЛицо | СправочникСсылка.УполномоченныеЛица | Кто разрешил |
| ПричинаЭкстренности | Строка(1000) | Причина (выбор из справочника + свободный текст) |
| ДокументальноеПодтверждение | Строка(500) | Ссылка на скриншот/файл |
| КаналСвязи | Строка(50) | Телефон / Мессенджер / Личное обращение |
| ВремяПолученияРазрешения | Дата | Время устного согласия |
| ПодтвержденоПостфактум | Булево | Подтверждено ли в ELMA (SLA 24ч) |
| ДатаПодтверждения | Дата | Дата подтверждения постфактум |
| СтатусПодтверждения | Строка(20) | Ожидает / Подтверждено / Отклонено |
| Инцидент | Булево | Зарегистрирован ли инцидент (при отклонении постфактум) |

---

#### 1.3.4. ЗакрытиеЛС

Документ инициации закрытия локальной сметы (п. 3.12).

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер документа |
| Дата | Дата | Дата закрытия |
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Закрываемая ЛС |
| ПричинаЗакрытия | Строка(50) | Полная отгрузка / Истечение срока / Инициатива менеджера / Отмена клиентом |
| НакопленнаяРентабельность | Число(5,2) | Факт. накопленная рент. на момент закрытия |
| ОтклонениеОтПлана | Число(5,2) | Отклонение от плановой рент. (п.п.) |
| ТребуетсяСогласование | Булево | Нужно ли согласование закрытия |
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | Кто согласует |
| Решение | ПеречислениеСсылка.РешенияСогласования | Решение |
| КлассификацияПричин | ПеречислениеСсылка.ПричиныНезакрытогоОстатка | Для KPI менеджера |
| ПроцентВыкупа | Число(5,2) | % выкупа с учетом дефицита |

---

#### 1.3.5. КорректировкаОтгрузки

Документ для аварийных ситуаций - WMS отгрузил до подтверждения (п. 3.11).

| Реквизит | Тип | Описание |
|----------|-----|----------|
| Номер | Строка(11) | Номер |
| Дата | Дата | Дата создания (SLA 4 рабочих часа) |
| РТУОснование | ДокументСсылка.РеализацияТоваровУслуг | РТУ-основание |
| ФактическоеКоличество | Число(10,3) | Что реально отгружено |
| РасхождениеСПланом | Строка(500) | Описание расхождения |
| РентабельностьФакт | Число(5,2) | Рент. по факту |
| ТребовалосьСогласование | Булево | Нужно ли было согласование |
| ЗаписьНарушения | Булево | Создана ли запись «Нарушение процедуры» |

---

### 1.4. Регистры накопления

#### 1.4.1. ВыручкаОтгруженного

Хранение факта отгрузок по ЛС для расчета накопленной рентабельности.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Измерение | Заказ |
| Выручка | Число(15,2) | Ресурс | Сумма отгрузки (нетто, с учетом возвратов) |
| СебестоимостьНПСС | Число(15,2) | Ресурс | Себестоимость по НПСС |
| Количество | Число(10,3) | Ресурс | Количество отгруженного |
| БизнесЮнит | СправочникСсылка.БизнесЮниты | Реквизит | БЮ позиции |
| ДатаРТУ | Дата | Реквизит | Дата фактической отгрузки |

**Движения:** Приход при проведении РТУ, Расход при возврате товара.

**Ключевые запросы:**
- Накопленная рентабельность по ЛС = SUM(Выручка - СебестоимостьНПСС) / SUM(Выручка) * 100
- Формула (Накопленная + Заказ): в числитель добавляется выручка и себестоимость текущего Заказа

---

#### 1.4.2. РезервыЛС

Учет логических резервов остатка ЛС (Заказы на согласовании и согласованные).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Измерение | Заказ |
| Количество | Число(10,3) | Ресурс | Зарезервированное количество |
| Сумма | Число(15,2) | Ресурс | Сумма резерва |
| СебестоимостьНПСС | Число(15,2) | Ресурс | Себестоимость резерва по НПСС |

**Движения:** Приход при отправке Заказа на согласование / переходе в «Согласован». Расход при отмене, отклонении, проведении РТУ (факт переходит в ВыручкаОтгруженного).

**Формула остатка ЛС:**
```
ДоступныйОстаток = ИсходнаяЛС - Остаток(ВыручкаОтгруженного) - Остаток(РезервыЛС)
```

---

#### 1.4.3. ОстаткиЛС

Позиционный учет доступных остатков по ЛС.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| Количество | Число(10,3) | Ресурс | Доступное количество |
| Сумма | Число(15,2) | Ресурс | Сумма остатка |
| СебестоимостьНПСС | Число(15,2) | Ресурс | Себестоимость остатка по НПСС |

**Движения:** Приход при создании ЛС / возврате товара / отмене Заказа. Расход при проведении РТУ / отправке на согласование.

---

#### 1.4.4. СчетчикЭкстренныхСогласований

Учет лимитов экстренных согласований (п. 3.7).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Менеджер | СправочникСсылка.Пользователи | Измерение | Менеджер |
| Контрагент | СправочникСсылка.Контрагенты | Измерение | Клиент |
| Период | Дата | Измерение | Месяц |
| КоличествоПоМенеджеру | Число(2,0) | Ресурс | Счетчик на менеджера (лимит 3, декабрь/август - 5) |
| КоличествоПоКонтрагенту | Число(2,0) | Ресурс | Счетчик на контрагента (лимит 5, пиковые - 8) |

---

### 1.5. Регистры сведений

#### 1.5.1. НПССПозиций

Справочник нормативной плановой себестоимости.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| Период | Дата | Период | Дата расчета |
| НПСС | Число(15,2) | Ресурс | Нормативная плановая себестоимость |
| ЗакупочнаяЦена | Число(15,2) | Ресурс | Компонент: закупочная цена |
| Логистика | Число(15,2) | Ресурс | Компонент: логистические затраты |
| НакладныеРасходы | Число(15,2) | Ресурс | Компонент: накладные расходы |
| Ответственный | СправочникСсылка.Пользователи | Реквизит | Кто рассчитал |
| Метод | Строка(50) | Реквизит | Плановый / Временный (последняя закупка * 1.1) |

**Периодичность записи:** ежеквартально (плановая), событийная (курс валюты > 5%, смена поставщика).

---

#### 1.5.2. РентабельностьЛС

Хранение рассчитанных показателей рентабельности по ЛС (кеш для отчетов).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Период | Дата | Период | Дата расчета |
| ПлановаяРентабельность | Число(5,2) | Ресурс | Плановая рент. (%) |
| НакопленнаяРентабельность | Число(5,2) | Ресурс | Накопленная рент. факт (%) |
| РентабельностьОстатка | Число(5,2) | Ресурс | Рент. неотгруженного остатка (%) |
| СуммаВыручки | Число(15,2) | Ресурс | Суммарная выручка отгруженного |
| СуммаСебестоимости | Число(15,2) | Ресурс | Суммарная себестоимость НПСС |
| ПроцентВыкупа | Число(5,2) | Ресурс | Текущий % выкупа |

---

#### 1.5.3. АктуальностьНПСС

Контроль возраста НПСС для трехуровневой проверки (п. 3.15).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ДатаПоследнегоРасчета | Дата | Ресурс | Дата последнего расчета НПСС |
| ВозрастДней | Число(4,0) | Ресурс | Кол-во дней с последнего расчета |
| Статус | ПеречислениеСсылка.РеакцияНаВозрастНПСС | Ресурс | 0-30 / 31-60 / 61-90 / >90 |
| ОтклонениеОтФакта | Число(5,2) | Ресурс | Отклонение НПСС от факт. себестоимости (%) |

---

#### 1.5.4. SLAСогласования

Фиксация метрик SLA для аналитики (LS-FR-046).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЗаявкаНаСогласование | ДокументСсылка.ЗаявкаНаСогласование | Измерение | Заявка |
| Согласующий | СправочникСсылка.Пользователи | Измерение | Кто согласовывал |
| ДатаНазначения | Дата | Ресурс | Когда назначена задача |
| ДатаРешения | Дата | Ресурс | Когда принято решение |
| SLAЧасов | Число(3,0) | Ресурс | Выделенное время (рабочие часы) |
| ФактВремени | Число(5,2) | Ресурс | Фактическое время (рабочие часы) |
| Просрочен | Булево | Ресурс | SLA нарушен |
| Эскалирован | Булево | Ресурс | Была ли эскалация |
| УровеньСогласования | ПеречислениеСсылка.УровниСогласования | Реквизит | Уровень |
| Приоритет | ПеречислениеСсылка.ПриоритетыЗаказа | Реквизит | P1 / P2 |

---

#### 1.5.5. НарушенияМенеджеров

Регистр нарушений процедуры (п. 3.7, п. 3.11).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Менеджер | СправочникСсылка.Пользователи | Измерение | Менеджер |
| Период | Дата | Период | Дата нарушения |
| ТипНарушения | Строка(100) | Ресурс | Отказ_постфактум / Несанкц_отгрузка / Превышение_лимита |
| Документ | ДокументСсылка | Ресурс | Документ-основание (Заказ/РТУ/Экстренное) |
| СуммаУбытка | Число(15,2) | Ресурс | Сумма убытка (руб.) |
| УровеньЭскалации | Строка(50) | Ресурс | Куда эскалировано |
| Статус | Строка(20) | Ресурс | Открыт / Закрыт / Эскалирован |

---

#### 1.5.6. СанкцииКонтрагентов

Регистр действующих санкций за невыкуп (LS-RPT-061).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Контрагент | СправочникСсылка.Контрагенты | Измерение | Клиент |
| Период | Дата | Период | Дата начала санкции |
| ТипСанкции | ПеречислениеСсылка.ТипыСанкций | Ресурс | Тип санкции |
| СнижениеСкидки | Число(5,2) | Ресурс | Снижение максимальной скидки (п.п.) |
| ПричинаЛС | СправочникСсылка.ЛокальнаяСмета | Ресурс | ЛС, ставшая причиной |
| ПроцентВыкупа | Число(5,2) | Ресурс | % выкупа по причинной ЛС |
| ДатаРеабилитации | Дата | Ресурс | Ожидаемая дата реабилитации (6 мес. без нарушений) |
| Суммировано | Число(5,2) | Ресурс | Суммарное снижение скидки (кумулятивно) |
| ОтмененаДП | Булево | Ресурс | Отменена ли решением ДП |
| ОснованиеОтмены | Строка(500) | Ресурс | Причина отмены |

---

#### 1.5.7. ФиксацияПотребности

Регистр фиксации потребности при дефиците (п. 3.17).

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЗаказКлиента | ДокументСсылка.ЗаказКлиента | Измерение | Заказ |
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| ДатаФиксации | Дата | Ресурс | Когда зафиксирована потребность |
| Количество | Число(10,3) | Ресурс | Запрошенное количество |
| РезультатПроверкиНаличия | Строка(20) | Ресурс | ВНаличии / НетВНаличии / Частично |
| ОжидаемаяДатаПоступления | Дата | Ресурс | Предполагаемая дата поступления |
| ДатаИстеченияОжидания | Дата | Ресурс | Максимум 90 дней от фиксации |
| ПодтвержденныйДефицит | Булево | Ресурс | Признан ли дефицит подтвержденным |
| ДнейНедоступности | Число(3,0) | Ресурс | Кол-во дней непрерывного отсутствия |

---

#### 1.5.8. ИсторияНаличияТовара

Для разрешения споров по дефициту (п. 3.17). Хранение: 3 года.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| Номенклатура | СправочникСсылка.Номенклатура | Измерение | Товар |
| Склад | СправочникСсылка.Склады | Измерение | Склад |
| Период | Дата | Период | Дата снимка (ежедневно) |
| КоличествоДоступное | Число(10,3) | Ресурс | Доступный остаток |
| ВНаличии | Булево | Ресурс | Есть ли хоть 1 ед. |

---

#### 1.5.9. ЖурналАудитаЛС

Журнал всех изменений плановой рентабельности ЛС (LS-FR-041). Записи неудаляемые. Хранение: 5 лет.

| Поле | Тип | Роль | Описание |
|------|-----|------|----------|
| ЛокальнаяСмета | СправочникСсылка.ЛокальнаяСмета | Измерение | ЛС |
| Период | Дата | Период | Дата изменения |
| Автор | СправочникСсылка.Пользователи | Ресурс | Кто инициировал |
| СтароеЗначение | Число(5,2) | Ресурс | Было (%) |
| НовоеЗначение | Число(5,2) | Ресурс | Стало (%) |
| Причина | Строка(500) | Ресурс | Причина изменения |
| ТипИзменения | Строка(50) | Ресурс | ПересчетНПСС / РучнойЗапрос / Продление / ДобавлениеПозиций |
| Согласование | ДокументСсылка.ЗаявкаНаСогласование | Ресурс | Связанное согласование (если было) |

---

## 2. Роли и права

### 2.1. Матрица ролей RBAC

| Объект / Действие | Менеджер | РБЮ | Директор ДРП | ДП | ГД | Финансовая служба | Спец. товарообмена | Администратор |
|-------------------|----------|-----|--------------|----|----|-------------------|--------------------|---------------|
| **ЛокальнаяСмета** | | | | | | | | |
| Создание | + | + | + | + | - | - | - | + |
| Просмотр (свой БЮ) | + | + | + | + | + | + | + | + |
| Просмотр (все БЮ) | - | - | + | + | + | + | - | + |
| Изменение плановой рент. | - | Запрос | Запрос | Одобрение | Одобрение | - | - | - |
| Продление | + | + | + | + | - | - | - | + |
| Закрытие (инициация) | + | + | + | + | - | - | - | + |
| **ЗаказКлиента** | | | | | | | | |
| Создание | + | + | - | - | - | - | - | + |
| Редактирование (Черновик) | + | + | - | - | - | - | - | + |
| Отправка на согласование | + | + | - | - | - | - | - | + |
| Отзыв с согласования | + | + | - | - | - | - | - | + |
| Удаление (Черновик/Отклонен) | + | + | - | - | - | - | - | + |
| Отмена (На согл./Согласован) | - | - | - | - | - | - | + (с подтв. РБЮ) | + |
| **Согласование** | | | | | | | | |
| Согласование (1-15 п.п.) | - | + | Эскалация | - | - | - | - | - |
| Согласование (15.01-25) | - | - | - | + | Эскалация | - | - | - |
| Согласование (>25 п.п.) | - | - | - | - | + | - | - | - |
| Арбитраж мульти-БЮ | - | - | + | Эскалация | - | - | - | - |
| Экстренное (1-15) | - | - | + | + | - | - | - | - |
| Экстренное (15.01-25) | - | - | - | + | - | - | - | - |
| **НПСС** | | | | | | | | |
| Расчет/Обновление | - | - | - | - | - | + | - | - |
| Подтверждение актуальности (61-90д) | - | + | - | - | - | - | - | - |
| Временное разрешение (80+д) | - | - | - | + | - | - | - | - |
| **Санкции** | | | | | | | | |
| Просмотр | + (свой) | + (свой БЮ) | + (все) | + (все) | + (все) | + (все) | - | + |
| Отмена (стратег. клиент) | - | - | - | + | - | + (при >3 отмен) | - | - |
| Приостановка (форс-мажор) | - | - | - | + | - | - | - | - |
| **Справочники** | | | | | | | | |
| Уполномоченные лица | - | Просмотр | Просмотр | Редактирование | Редактирование | - | - | + |
| Стратегические клиенты | - | Просмотр | Редактирование | Одобрение | - | - | - | + |
| Блокировки ЛС (снятие) | - | - | - | - | - | - | - | + |
| **Отчеты** | | | | | | | | |
| Личные отчеты (свои ЛС) | + | - | - | - | - | - | - | - |
| Отчеты по БЮ | - | + | + | - | - | - | - | - |
| Сводные отчеты (все) | - | - | - | + | + | + | - | + |
| Журнал аудита ЛС | - | - | - | + | - | + | - | + |

### 2.2. RLS-политики (LS-SEC-001)

| Роль | Правило видимости |
|------|-------------------|
| Менеджер | ЛС и Заказы, где Менеджер = ТекущийПользователь |
| РБЮ | Все ЛС и Заказы, где БизнесЮнит = БЮ текущего пользователя |
| Директор ДРП | Все ЛС и Заказы (все БЮ) |
| ДП | Все ЛС и Заказы (все БЮ) |
| ГД | Все ЛС и Заказы (все БЮ) |
| Финансовая служба | Все ЛС и Заказы (все БЮ), только чтение |
| Спец. товарообмена | Все документы, права на отмену и сторнирование |
| Администратор | Полный доступ, управление блокировками и настройками |

---

## 3. Бизнес-процессы

### 3.1. Согласование рентабельности (4-уровневый маршрут)

```
┌────────────────────────────────────────────────────────────────────┐
│  МАРШРУТ СОГЛАСОВАНИЯ РЕНТАБЕЛЬНОСТИ                               │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  РАСЧЕТ ОТКЛОНЕНИЯ:                                                │
│  Откл = Рент_ЛС_план - max(Накопл+Заказ, Рент_Остатка)           │
│  (округление до 2 знаков ДО сравнения с границами)                 │
│                                                                    │
│  Откл < 1 п.п.                                                    │
│  ├── Автосогласование (без отправки в ELMA)                        │
│  └── Статус: Согласован                                            │
│                                                                    │
│  Откл 1.00 - 15.00 п.п.                                           │
│  ├── Задача → РБЮ (SLA: P1=4ч, P2=24ч, <100тр=2ч)                │
│  ├── Таймаут → Директор ДРП (SLA +4ч)                              │
│  ├── Таймаут → ДП (через двойной SLA)                              │
│  └── Мульти-БЮ: параллельные задачи всем РБЮ                      │
│       ├── Все ОК → Согласован                                      │
│       ├── Расхождение → Арбитраж Директора ДРП (SLA 8ч)            │
│       └── Все молчат → Директор ДРП напрямую                       │
│                                                                    │
│  Откл 15.01 - 25.00 п.п.                                          │
│  ├── Задача → ДП (SLA: P1=8ч, P2=48ч)                             │
│  ├── Таймаут → ГД (через двойной SLA)                              │
│  └── Мульти-БЮ НЕ применяется (ДП один на компанию)               │
│                                                                    │
│  Откл > 25.00 п.п.                                                │
│  ├── Задача → ГД (SLA: P1=24ч)                                    │
│  ├── Таймаут 48ч → Автоотказ                                       │
│  │   (исключение: если Накопл+Заказ = план → автосогласование)     │
│  └── Мульти-БЮ НЕ применяется                                     │
│                                                                    │
│  ОСОБЫЕ СЛУЧАИ:                                                    │
│  Рент. Заказа < 0% при план ЛС >= 0%                              │
│  ├── Жесткая блокировка → только ГД                               │
│  ├── Экстренное согласование НЕДОСТУПНО                            │
│  └── Исключение: убыток < -0.1% от суммы → автосогласование       │
│                                                                    │
│  РЕШЕНИЯ СОГЛАСУЮЩЕГО:                                             │
│  1. Одобрить (с комментарием)                                      │
│  2. Согласовать с корректировкой цены (*)                          │
│  3. Отклонить (с обязательным указанием причины)                   │
│                                                                    │
│  (*) UX-APPROVER-001, B2: цикл корректировки не описан в ФМ.      │
│  РЕКОМЕНДАЦИЯ: добавить в ТЗ полный цикл, см. секцию 3.1.1       │
│                                                                    │
│  АННУЛИРОВАНИЕ СОГЛАСОВАНИЯ:                                       │
│  - 5 р.д. истекло (кроме ПереданНаСклад = Истина)                  │
│  - Другой Заказ по ЛС изменил рентабельность                      │
│  - Откл. выросло на 3+ п.п.                                       │
│  - Изменен уровень согласования                                    │
│  - Изменена плановая рент. ЛС                                     │
│  - ЛС закрыта/аннулирована                                        │
│  При 3+ аннулированиях → автоэскалация на ДП                      │
└────────────────────────────────────────────────────────────────────┘
```

#### 3.1.1. Рекомендуемый цикл «Согласовать с корректировкой цены» (закрытие B2/UX-APPROVER-001)

```
1. Согласующий выбирает «Согласовать с корректировкой»
2. Согласующий указывает новую цену (по каждой позиции или общую скидку)
3. Система мгновенно пересчитывает рентабельность
4. ЕСЛИ новая рентабельность проходит порог (откл < 1 п.п.):
   → Автосогласование. Менеджер получает уведомление с новыми ценами.
5. ЕСЛИ новая рентабельность НЕ проходит порог:
   → Предупреждение согласующему: «Отклонение X п.п. Требуется уровень Y»
   → Согласующий решает: скорректировать цену или одобрить на своем уровне
6. Менеджер получает уведомление: «Заказ согласован с корректировкой: [было] -> [стало]»
7. Менеджер подтверждает или отклоняет корректировку (SLA 4 рабочих часа)
8. Для EDI-заказов: опция «с корректировкой» НЕДОСТУПНА (только одобрить/отклонить)
```

---

### 3.2. Экстренное согласование

```
┌────────────────────────────────────────────────────────────────────┐
│  ЭКСТРЕННОЕ СОГЛАСОВАНИЕ (п. 3.7)                                  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ПРЕДУСЛОВИЯ:                                                      │
│  - Откл 1-15 п.п.: разрешает Директор ДРП или выше                │
│  - Откл 15.01-25 п.п.: разрешает ДП или выше                      │
│  - Откл > 25 п.п. или убыток: НЕДОСТУПНО                          │
│                                                                    │
│  ШАГИ:                                                             │
│  1. Менеджер → устное разрешение (тел./мессенджер)                 │
│  2. Менеджер → фиксация в 1С: ФИО из справочника,                 │
│     причина, скриншот, канал связи                                 │
│  3. Проверка: ФИО в справочнике УполномоченныеЛица                 │
│  4. Проверка: лимит 3/мес на менеджера + 5/мес на контрагента      │
│  5. Заказ → Согласован (пометка «Экстренно»)                      │
│  6. Push-уведомление согласующему: «Подтвердите в 2 рабочих часа»  │
│  7. Отгрузка (параллельно с п.6)                                   │
│  8. Согласование постфактум в ELMA (SLA 24 рабочих часа)           │
│  9. При отклонении постфактум → инцидент                           │
│                                                                    │
│  ЗАЩИТА ОТ ФАЛЬСИФИКАЦИИ:                                          │
│  - Push согласующему при каждом экстренном согласовании             │
│  - Неподтверждение в 2ч = автоотказ                                │
│  - Инцидент включается в отчет менеджера и БЮ                     │
│                                                                    │
│  ПИКОВЫЕ ПЕРИОДЫ (декабрь, август):                                │
│  - Лимит на менеджера: до 5 (по решению ДП)                       │
│  - Лимит на контрагента: до 8 (по решению ДП)                     │
└────────────────────────────────────────────────────────────────────┘
```

---

### 3.3. Закрытие ЛС

```
┌────────────────────────────────────────────────────────────────────┐
│  ЗАКРЫТИЕ ЛОКАЛЬНОЙ СМЕТЫ (п. 3.12)                                │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ТРИГГЕРЫ:                                                         │
│  1. Полная отгрузка (остаток = 0) → Автозакрытие, без согласования │
│  2. Истечение срока → Менеджер: продлить или закрыть               │
│  3. Инициатива менеджера → Запрос на закрытие                      │
│  4. Отмена клиентом (0 отгрузок) → Статус: Отменена                │
│                                                                    │
│  ПРИ ЧАСТИЧНОЙ ОТГРУЗКЕ - СОГЛАСОВАНИЕ:                            │
│  Откл < 1 п.п.  → Закрытие без согласования                       │
│  Откл 1-15 п.п. → РБЮ (SLA 4ч)                                   │
│  Откл 15.01-25   → ДП (SLA 8ч)                                    │
│  Откл > 25 п.п. → ГД (SLA 24ч)                                    │
│                                                                    │
│  ПОСЛЕ ЗАКРЫТИЯ:                                                   │
│  1. Неотгруженный товар → свободный остаток                        │
│  2. Расчет % выкупа (п. 3.18)                                      │
│  3. Определение подтвержденного дефицита (РБЮ)                     │
│  4. Применение санкций (если % выкупа < 90%)                       │
│  5. Классификация причин → KPI менеджера                           │
│                                                                    │
│  АВТОМАТИЧЕСКОЕ ЗАКРЫТИЕ:                                          │
│  ЛС с истекшим сроком + нет активных Заказов → автоперевод          │
│  в «Закрыта» через 5 рабочих дней. За 3 дня - уведомление.        │
│                                                                    │
│  МАКС. ОТКЛОНЕНИЙ ЗАКРЫТИЯ:                                        │
│  2 отклонения → далее автоэскалация к ДП                           │
└────────────────────────────────────────────────────────────────────┘
```

---

### 3.4. Арбитраж мульти-БЮ

```
┌────────────────────────────────────────────────────────────────────┐
│  АРБИТРАЖ ПРИ РАСХОЖДЕНИИ РЕШЕНИЙ РБЮ (п. 3.8)                    │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  КОНТЕКСТ: Заказ содержит позиции нескольких БЮ                    │
│  Отклонение 1-15 п.п. → параллельное согласование РБЮ             │
│                                                                    │
│  РАСХОЖДЕНИЕ РЕШЕНИЙ:                                              │
│  РБЮ_A: Одобрено   +   РБЮ_B: Отклонено                          │
│  → Автоэскалация к Директору ДРП (SLA 8 рабочих часов)             │
│                                                                    │
│  ИНФОРМАЦИЯ ДЛЯ АРБИТРА (UX-APPROVER-005):                        │
│  - Решения и обоснования обоих РБЮ в единой форме                  │
│  - Данные Заказа с раскладкой по БЮ                                │
│  - Рентабельность по каждому БЮ отдельно                           │
│                                                                    │
│  РЕШЕНИЯ ДИРЕКТОРА ДРП:                                            │
│  1. Согласовать полностью                                          │
│  2. Согласовать частично (указать какие БЮ)                        │
│  3. Отклонить полностью                                            │
│  4. Вернуть РБЮ на доработку                                      │
│                                                                    │
│  ЧАСТИЧНОЕ СОГЛАСОВАНИЕ → менеджеру доступны:                      │
│  - Удалить позиции несогласовавшего БЮ                             │
│  - Отменить Заказ целиком                                          │
│  После удаления → автопересчет рент. → автопроверка                │
│                                                                    │
│  ВСЕ РБЮ НЕ ОТВЕТИЛИ:                                             │
│  → Заказ эскалируется Директору ДРП напрямую (без решений РБЮ)     │
│  → Индикатор: «Решения РБЮ отсутствуют (таймаут)»                 │
│                                                                    │
│  ТАЙМАУТ АРБИТРАЖА:                                                │
│  При превышении SLA 8ч → автоэскалация на ДП                      │
│                                                                    │
│  ФИКСАЦИЯ РЕШЕНИЯ:                                                │
│  При одновременном сохранении - приоритет первому.                  │
│  Второй: «Решение уже принято»                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

### 3.5. Процесс изменения плановой рентабельности ЛС

```
Повышение → без согласования
Снижение 0-3.00 п.п. → РБЮ
Снижение 3.01-10.00 п.п. → ДП
Снижение > 10.00 п.п. → ГД
Исключение: снижение из-за пересчета НПСС → без согласования

При ЛЮБОМ изменении плана:
- Аннулируются Заказы «На согласовании» (если изменился уровень)
- Запись в ЖурналАудитаЛС
```

---

## 4. Фоновые задания (регламентные задания)

### 4.1. Таблица регламентных заданий

| # | Имя | Расписание | Описание | Retry | Timeout | Мониторинг |
|---|-----|-----------|----------|-------|---------|------------|
| 1 | ПересчетСанкций | Ежедневно, 01:00 MSK | Пересчет санкций для закрытых ЛС при поступлении возвратов в течение 60 дней. Обновление регистра СанкцииКонтрагентов. | 3 x 15 мин | 2 часа | Алерт ФД при сбое |
| 2 | ПроверкаSLA | Каждые 15 мин, 09:00-18:00 MSK | Проверка истечения SLA по заявкам на согласование. Автоэскалация при превышении. | 3 x 1 мин | 5 мин | Лог в журнал |
| 3 | Автоэскалация | Каждые 15 мин, 09:00-18:00 MSK | Переназначение задач вышестоящему при превышении SLA (совместно с п.2). | 3 x 1 мин | 5 мин | Уведомление исходному согласующему |
| 4 | МониторингНПСС | Ежедневно, 07:00 MSK | Расчет возраста НПСС для всей номенклатуры. Обновление регистра АктуальностьНПСС. Формирование еженедельного отчета для ФС. | 3 x 5 мин | 30 мин | Алерт ФД при >90 дней |
| 5 | АвтоудалениеЧерновиков | Ежедневно, 00:00 MSK | Пометка на удаление черновиков старше 7 дней. Уведомление менеджерам за 3 дня до удаления (за 3 дня - отдельное задание). | 3 x 5 мин | 15 мин | Лог в журнал |
| 6 | АннулированиеСогласований | Ежедневно, 00:00 MSK | Аннулирование согласований с истекшим сроком (5 рабочих дней). Проверка условий аннулирования: +3 п.п., смена уровня. | 3 x 5 мин | 30 мин | Уведомления менеджерам |
| 7 | АвтозакрытиеЛС | Ежедневно, 00:00 MSK | Автозакрытие ЛС с истекшим сроком (через 5 р.д.). Уведомления за 3 дня. Аннулирование Заказов «На согласовании». | 3 x 5 мин | 30 мин | Лог в журнал |
| 8 | ПроверкаРеабилитации | Ежедневно, 02:00 MSK | Проверка 6-месячного периода без нарушений. Снятие санкций. Уведомление менеджеру. | 3 x 5 мин | 15 мин | Лог в журнал |
| 9 | СнимокНаличия | Ежедневно, 23:00 MSK | Запись текущих остатков в ИсторияНаличияТовара (для контроля дефицита). | 3 x 10 мин | 1 час | Лог в журнал |
| 10 | ОчисткаБлокировок | Каждые 5 мин | Снятие просроченных блокировок ЛС (>15 мин неактивности). Освобождение заблокированных ЛС. | Не требуется | 1 мин | Лог в журнал |
| 11 | КонтрольЭкстренных | Каждые 30 мин, 09:00-18:00 MSK | Проверка подтверждения экстренных согласований (2ч окно). Автоотказ при неподтверждении. | 3 x 1 мин | 5 мин | Уведомление РБЮ |
| 12 | ОповещениеОПоступлении | Каждые 30 мин | Проверка поступления ожидаемого товара. Уведомление менеджерам и клиентам. Физический резерв 48ч. | 3 x 5 мин | 15 мин | Лог в журнал |
| 13 | АвтопродлениеЛСПриДефиците | Ежедневно, 06:00 MSK | Если товар поступил < 5 р.д. до истечения ЛС → автопродление на 5 р.д. | 3 x 5 мин | 15 мин | Уведомление менеджеру |
| 14 | СверкаWMS | Ежедневно, 05:00 MSK | Сверочный отчет расхождений WMS и 1С:УТ (LS-BR-044). | 3 x 10 мин | 1 час | Алерт руководителю склада |
| 15 | КвартальныйАудитНПСС | 1 раз в квартал (10-е число) | Аудит точности НПСС: выборка 100 SKU, сравнение с фактом. Отчет для ФД. | 3 x 15 мин | 2 часа | Отчет ФД |
| 16 | ОчисткаИсторииНаличия | 1 раз в месяц | Удаление записей старше 3 лет из ИсторияНаличияТовара. | 3 x 10 мин | 1 час | Лог в журнал |

### 4.2. Связь с бизнес-вопросом B4 аудита

Бизнес-вопрос B4 (CRITICAL): «Фоновое задание пересчета санкций - нет retry/timeout/мониторинга».

**Решение в архитектуре:** Для каждого регламентного задания определены:
- **Retry:** количество повторных попыток и интервал между ними;
- **Timeout:** максимальное время выполнения;
- **Мониторинг:** алерт при сбое (кому и как).

Реализация через механизм регламентных заданий 1С:УТ с дополнительной обработкой в модуле ОбработкаСбоевРегламентныхЗаданий.

---

## 5. Ключевые точки контроля

### 5.1. Матрица контролей

| # | Точка контроля | Момент | Тип | Объект | Блокирует? |
|---|---------------|--------|-----|--------|------------|
| 1 | Расчет рентабельности Заказа | Перед проведением (ПередЗаписью) | Автоматический | ЗаказКлиента | Да - при откл >= 1 п.п. |
| 2 | Проверка возраста НПСС | При создании Заказа (ПередЗаписью) | Автоматический | ЗаказКлиента | Да - при >90 дн |
| 3 | Проверка НПСС=0/NULL | При создании Заказа (ПередЗаписью) | Автоматический | ЗаказКлиента | Да - блокировка позиции |
| 4 | Проверка Цена=0 | При создании Заказа (ПередЗаписью) | Автоматический | ЗаказКлиента | Да - блокировка позиции |
| 5 | Соответствие цен ЛС | При создании Заказа (ПередЗаписью) | Автоматический | ЗаказКлиента | Да - при расхождении >0.01% |
| 6 | Доступный остаток ЛС | При отправке на согласование | Автоматический | ЗаказКлиента | Да - при превышении |
| 7 | Лимит Заказов на согласовании | При отправке на согласование | Автоматический | ЗаказКлиента | Да - при 10+ |
| 8 | Лимит экстренных согласований | При фиксации экстренного | Автоматический | ЭкстренноеСогласование | Да - при превышении 3/5 |
| 9 | ФИО в справочнике уполномоченных | При фиксации экстренного | Автоматический | ЭкстренноеСогласование | Да - при отсутствии |
| 10 | Точка невозврата | При установке ПереданНаСклад | Информационный | ЗаказКлиента | Нет - фиксация |
| 11 | Срок действия согласования | При проведении РТУ | Автоматический | РеализацияТоваровУслуг | Да - при истечении |
| 12 | Соответствие РТУ Заказу | При проведении РТУ | Автоматический | РеализацияТоваровУслуг | Да - при расхождении |
| 13 | Атомарная проверка при РТУ | При проведении РТУ (ПриПроведении) | Автоматический | РеализацияТоваровУслуг | Да - перечитывает регистр |
| 14 | Повторный пересчет | При сохранении Заказа | Автоматический | ЗаказКлиента | Да - при изменении рент. |
| 15 | Контроль B2C убытка | При проведении РТУ B2C | Автоматический | РеализацияТоваровУслуг | Да - при рент. < 0% |
| 16 | Пересчет при возврате | При проведении возврата | Автоматический | ВозвратТоваров | Нет - пересчет + уведомление |
| 17 | Проверка санкций | При создании ЛС | Информационный | ЛокальнаяСмета | Ограничение скидки |
| 18 | Рекомендательный контроль | При создании ЛС (рент. < 5%) | Информационный | ЛокальнаяСмета | Нет - предупреждение |
| 19 | Неликвид + спеццена | При создании Заказа | Автоматический | ЗаказКлиента | Нет - исключение из контроля |
| 20 | Черновик > 7 дней | Регламентное задание | Автоматический | ЗаказКлиента | Удаление |

### 5.2. Детализация контроля при проведении РТУ (п.13 - критичный)

```
ПриПроведении(РТУ):
  1. НачатьТранзакцию()
  2. ЗаблокироватьПозицииЛС(ЗаказКлиента.ЛС, 5-10 сек)
  3. ПерепрочитатьНакопленнуюРентабельность() -- из регистра ВыручкаОтгруженного
  4. ПроверитьСрокСогласования() -- 5 рабочих дней
  5. ПроверитьПереданНаСклад() -- точка невозврата
  6. ЕСЛИ рентабельность изменилась:
     6.1 АннулироватьПараллельныеСогласования()
     6.2 УведомитьМенеджеров()
  7. ЗаписатьДвижения(ВыручкаОтгруженного, РезервыЛС, ОстаткиЛС)
  8. ЗавершитьТранзакцию()
  9. СнятьБлокировкуЛС()
```

---

## 6. Потенциальные блокировки

### 6.1. Анализ конкурентного доступа

| # | Сценарий | Объект блокировки | Тип блокировки | Макс. время | Вероятность | Решение |
|---|----------|-------------------|----------------|-------------|-------------|---------|
| 1 | Два менеджера создают Заказы по одной ЛС | Запись ЛС (LS-BR-035) | Пессимистичная блокировка | 15 мин | Средняя | Блокировка записи ЛС при создании Заказа. Второй пользователь: «ЛС редактируется [ФИО] до [ЧЧ:ММ]». Автоснятие через 15 мин. |
| 2 | Одновременная отправка черновиков на согласование | Остаток ЛС (атомарная) | Транзакционная блокировка | 10 сек | Низкая | Атомарная блокировка остатка. Первый успешный «захватывает» долю. Второй: ошибка. |
| 3 | Проведение РТУ параллельно с согласованием | Регистр ВыручкаОтгруженного | Управляемая блокировка | 5-10 сек | Средняя | Блокировка позиций ЛС при проведении РТУ. Аннулирование согласований при изменении рент. |
| 4 | Два РБЮ принимают решение по мульти-БЮ | Запись ЗаявкаНаСогласование | Оптимистичная блокировка | Мгновенно | Низкая | Проверка при сохранении. Приоритет первому. Второй: «Решение уже принято». |
| 5 | Возврат товара во время согласования | Регистры рентабельности | Управляемая блокировка | 30 сек | Низкая | Пауза на пересчет рентабельности (до 30 сек). Аннулирование при изменении уровня. |
| 6 | Автоудаление черновика во время редактирования | Запись ЗаказКлиента | Проверка при удалении | Мгновенно | Очень низкая | Регламентное задание проверяет блокировку перед удалением. |
| 7 | Изменение плановой рент. ЛС во время согласования Заказов | Записи Заказов по ЛС | Каскадная | До 30 сек | Низкая | Аннулирование ВСЕХ Заказов «На согласовании» ЕСЛИ меняется уровень. |

### 6.2. Стратегия предотвращения взаимных блокировок

```
ПОРЯДОК ЗАХВАТА БЛОКИРОВОК (строгий):
1. ЛокальнаяСмета (запись)
2. ОстаткиЛС (регистр по ЛС)
3. РезервыЛС (регистр по ЛС)
4. ВыручкаОтгруженного (регистр по ЛС)
5. ЗаказКлиента (запись)

Правило: блокировки захватываются ТОЛЬКО в указанном порядке.
Нарушение порядка = потенциальная взаимная блокировка.
Таймаут ожидания блокировки: 30 секунд.
При истечении: отмена операции с сообщением пользователю.
```

### 6.3. Рекомендации по оптимизации (LS-NFR-001)

- Расчет рентабельности Заказа (до 500 позиций): <= 2 сек
- Общее время обработки документа: <= 3 сек
- Индексы: ВыручкаОтгруженного по (ЛокальнаяСмета, Номенклатура), РезервыЛС по (ЛокальнаяСмета, Номенклатура)
- Кеширование: показатели рентабельности ЛС в регистре РентабельностьЛС (обновляется при каждом движении)
- Максимум позиций в ЛС: 1000 (LS-NFR-002)
- Максимум Заказов на согласовании по ЛС: 50 (LS-NFR-003)

---

## 7. Интеграции

### 7.1. Интеграция 1С:УТ <-> ELMA (LS-INT-003)

| Параметр | Значение |
|----------|----------|
| **Направление** | Двустороннее |
| **Протокол** | REST API / SOAP (по конфигурации ELMA) |
| **Формат** | JSON |
| **Таймаут** | 30 сек |
| **Повторные попытки** | 3 |

**1С:УТ -> ELMA (создание задачи согласования):**

| Поле | Описание |
|------|----------|
| НомерЗаказа | Номер Заказа клиента |
| НомерЗаявки | Номер ЗаявкиНаСогласование |
| Сумма | Сумма Заказа |
| Отклонение | Отклонение рентабельности (п.п.) |
| Приоритет | P1 / P2 |
| Согласующий | ФИО и ID пользователя |
| SLA | Время на решение (рабочие часы) |
| Инициатор | Менеджер |
| ДанныеЗаказа | JSON с позициями, ценами, рентабельностью |
| ИсторияЛС | Предыдущие отгрузки, рентабельность |
| ОбоснованиеМенеджера | Текст обоснования |

**ELMA -> 1С:УТ (результат согласования):**

| Поле | Описание |
|------|----------|
| НомерЗаявки | Номер ЗаявкиНаСогласование |
| Решение | Одобрено / Отклонено / СКорректировкой / Эскалировано |
| Согласующий | Кто принял решение |
| Комментарий | Комментарий согласующего |
| НовыеЦены | (при корректировке) JSON с измененными ценами |
| ВремяРешения | Дата/время решения |

**Fallback при недоступности ELMA:**
- Таймаут подключения: 30 секунд или 3 неудачные попытки
- Согласование по email/телефону (аналогично экстренному)
- SLA на фиксацию в системе: 4 часа после восстановления ELMA

---

### 7.2. Интеграция 1С:УТ -> WMS (LS-INT-001)

| Параметр | Значение |
|----------|----------|
| **Направление** | 1С:УТ -> WMS |
| **Инициатор** | Push (1С:УТ отправляет при изменении статуса) |
| **Формат** | JSON |
| **Таймаут** | 30 сек |
| **Повторные попытки** | 3 |

**Триггер:** Заказ переходит в статус «Согласован» или «Без согласования».

**Состав сообщения:**

```json
{
  "НомерЗаказа": "...",
  "ДатаЗаказа": "...",
  "Контрагент": "...",
  "АдресДоставки": "...",
  "Приоритет": "P1",
  "Позиции": [
    {
      "Номенклатура": "...",
      "Количество": 100,
      "Склад": "...",
      "Артикул": "..."
    }
  ],
  "СтатусКонтроля": "Согласован",
  "ТочкаНевозврата": false
}
```

**Установка ПереданНаСклад:** После успешной отправки в WMS устанавливается реквизит «ПереданНаСклад» = Истина. Это точка невозврата - после нее согласование не аннулируется.

---

### 7.3. Интеграция WMS -> 1С:УТ (LS-INT-002)

| Параметр | Значение |
|----------|----------|
| **Направление** | WMS -> 1С:УТ |
| **Инициатор** | Push (WMS отправляет при завершении комплектации) |
| **Формат** | JSON |
| **SLA обработки** | <= 30 сек (LS-NFR-004) |

**Триггер:** Завершение комплектации (полная или частичная).

**Состав сообщения:**

```json
{
  "НомерЗаказа": "...",
  "РезультатКомплектации": "Полная | Частичная | Ошибка",
  "Позиции": [
    {
      "Номенклатура": "...",
      "КоличествоПлан": 100,
      "КоличествоФакт": 95,
      "Расхождение": 5
    }
  ],
  "ВремяКомплектации": "..."
}
```

**Обработка расхождений (частичная комплектация):**

```
ЕСЛИ факт < план:
  1. Пересчет рентабельности по факту
  2. ЕСЛИ рент. не ухудшилась → отгрузка по факту
  3. ЕСЛИ рент. ухудшилась, уровень тот же → запрос менеджеру (SLA 2ч)
  4. ЕСЛИ рент. ухудшилась, требуется выше → новое согласование
  5. При отсутствии решения 2ч → автоотмена комплектации
```

---

### 7.4. Интеграция с EDI

| Параметр | Значение |
|----------|----------|
| **Направление** | Двустороннее |
| **Протокол** | EDI (по стандарту EDI-контрагентов) |
| **Формат** | По протоколу EDI |

**Входящий EDI-заказ:**
1. Прием EDI-сообщения
2. Парсинг позиций и привязка к ЛС
3. Проверка: один EDI-заказ = одна ЛС (при несоответствии - отклонение: «Разбейте заказ по ЛС»)
4. Создание ЗаказКлиента с ИсточникЗаказа = «EDI»
5. Стандартный контроль рентабельности
6. Ограничения: изменение состава невозможно; опция «с корректировкой цены» недоступна

**Исходящие EDI-уведомления:**
- Статус заказа (принят / на согласовании / согласован / отклонен / отменен)
- При отмене: автоматическое уведомление клиента через EDI-канал

**4-часовое окно EDI:**
При отказе любого БЮ в мульти-БЮ EDI-заказе:
- Владелец сделки принимает решение в 4 часа
- При бездействии: эскалация Директору ДРП
- Если нет решения: автоотмена заказа + уведомление клиента через EDI

---

### 7.5. Интеграция с HR-системой

| Параметр | Значение |
|----------|----------|
| **Направление** | HR -> 1С:УТ |
| **Протокол** | REST API / Файловый обмен |
| **Частота** | При событии (увольнение/перевод) + ежедневная синхронизация |

**Триггеры:**
- Увольнение/перевод сотрудника → автоматическое исключение из справочника УполномоченныеЛица
- Изменение оргструктуры → обновление справочника ДежурныеСогласующие
- Назначение/снятие роли → обновление прав в 1С

---

### 7.6. Схема потоков данных

```
┌──────────────┐     JSON (согласование)      ┌──────────────┐
│              │ ──────────────────────────────→│              │
│   1С:УТ      │                               │    ELMA      │
│              │←────────────────────────────── │              │
└──────┬───────┘     JSON (решение)            └──────────────┘
       │
       │ JSON (Заказ)     ┌──────────────┐
       │──────────────────→│              │
       │                   │    WMS       │
       │←──────────────────│              │
       │ JSON (комплект.)  └──────────────┘
       │
       │ EDI               ┌──────────────┐
       │←─────────────────→│   Клиенты    │
       │                   │   (EDI)      │
       │                   └──────────────┘
       │
       │ API/файл          ┌──────────────┐
       │←──────────────────│   HR-система │
       │                   └──────────────┘
```

---

## Приложение A. Связь с находками аудита и UX

| ID находки | Серьезность | Описание | Раздел архитектуры | Статус |
|-----------|------------|----------|-------------------|--------|
| B1 | CRITICAL | SLA <100 т.р.: неясные значения | 4.1 (ПроверкаSLA) | Требует уточнения ФМ |
| B2 | CRITICAL | «Согласовать с корректировкой» - нет цикла | 3.1.1 | Предложен цикл |
| B3 | CRITICAL | Логический резерв 48ч vs 90д | 1.5.7, 1.4.2 | Реализован: 48ч для физического, 90д для логического |
| B4 | CRITICAL | Фоновое задание - нет retry/timeout | 4.1, 4.2 | Закрыто: retry/timeout/мониторинг для всех заданий |
| B5 | HIGH | Терминальное поведение при автоотказе ГД | 3.1 | Рекомендовано: уведомление CFO |
| B6 | HIGH | Улучшение рент. во время согласования | 3.1 (аннулирование) | Рекомендовано: пересоздание на нижнем уровне |
| B7 | HIGH | Формулы: нетто или брутто | 1.4.1 | Решено: нетто (с учетом возвратов) |
| B8 | HIGH | Автопродление + НПСС >90д = конфликт | 4.1 (АвтопродлениеЛС) | Рекомендовано: приостановка проверки НПСС при автопродлении |
| B9 | HIGH | Определение дефицита вручную | 1.5.7, 4.1 (расчет санкций) | Автоматизировано: алгоритмическая проверка, РБЮ - только споры |
| UX-ROLE-002 | CRITICAL | НПСС=0: непрозрачность для менеджера | 5.1 (п.3) | В ТЗ: автосоздание заявки + трекер |
| UX-ROLE-008 | CRITICAL | Нет интерактивного пересчета | 1.3.1 (реквизиты) | В ТЗ: real-time пересчет при изменении позиций |
| UX-ROLE-013 | CRITICAL | «Согласование с корректировкой» - зависание | 3.1.1 | Предложен полный цикл |
| UX-APPROVER-001 | CRITICAL | Корректировка цены - нет описания | 3.1.1 | Предложен полный цикл |
| UX-APPROVER-002 | CRITICAL | Автоотказ ГД без уведомления | 3.1 | Рекомендовано: условный отказ + CFO |
| UX-APPROVER-005 | HIGH | Арбитраж: неполная информация | 3.4 | Описана единая форма арбитража |

---

## Приложение B. Перечень отчетов (полный реестр)

| Код | Имя | Периодичность | Получатели | Приоритет |
|-----|-----|---------------|------------|-----------|
| LS-RPT-013 | Накопленная рентабельность по ЛС | По запросу | Менеджер, РБЮ | P1 |
| LS-RPT-038 | Устаревшие НПСС | Еженедельно | Финансовая служба | P1 |
| LS-RPT-043 | Конфликты блокировки ЛС | Еженедельно | Руководство | P1 |
| LS-BR-044 | Сверка WMS-1С | Ежедневно | Руководитель склада | P1 |
| LS-FR-046 | Соблюдение SLA согласования | Еженедельно | ДП, РБЮ | P1 |
| LS-RPT-060 | Неудовлетворенный спрос / Дефицит | Еженедельно/Ежемесячно | Закупки, ДП, ФД | P2 |
| LS-RPT-061 | Регистр санкций клиентов | По запросу | Комм. служба | P2 |
| LS-RPT-063 | Реабилитация санкций | Ежедневно (фон) | Менеджер (уведомление) | P2 |
| LS-RPT-064 | Качество ЛС по менеджерам | Ежемесячно | ДП, РБЮ | P2 |
| LS-RPT-065 | Продажи неликвида | Ежемесячно | ДП, РБЮ | P2 |
| LS-RPT-066 | Портфельная маржа по клиенту | Ежемесячно | ДП, ФД, РБЮ | P2 |
| LS-RPT-067 | Потери из-за согласований | Ежемесячно | ДП, ФД | P2 |
| LS-RPT-068 | Клиенты с низким выкупом | Еженедельно | Менеджеры, РБЮ | P2 |

---

## Приложение C. Нефункциональные ограничения

| Код | Требование | Значение | Примечание |
|-----|-----------|----------|------------|
| LS-NFR-001 | Время расчета рентабельности | <= 2 сек (до 500 позиций) | Индексы + кеш в регистре |
| LS-NFR-002 | Макс. позиций в ЛС | 1000 | Предупреждение: разбить |
| LS-NFR-003 | Макс. Заказов на согласовании по ЛС | 50 | Очередь с приоритизацией |
| LS-NFR-004 | SLA интеграции WMS | <= 30 сек | Автоуведомление оператору |
| - | Одновременных пользователей | 10-50 | Требует нагрузочного тестирования |
| - | Хранение журнала аудита ЛС | 5 лет | Неудаляемые записи |
| - | Хранение истории наличия | 3 года | Очистка регламентным заданием |
| - | Блокировка ЛС | 15 мин таймаут | Автоснятие |
| - | Ожидание получения блокировки | 30 сек | Сообщение пользователю |
| - | Рабочие часы SLA | 09:00-18:00 MSK | Производственный календарь РФ |

# Тест-план: расширенные сценарии FM-LS-PROFIT v1.0.6

**Дата:** 13.02.2026
**Агент:** Agent 4 (QA Tester)
**Версия ФМ:** 1.0.6 (Confluence v49)
**Охват:** Разделы 3.10-3.18 (статусы согласования, жизненный цикл ЛС, блокировки, НПСС, мобильное согласование, дефицит, санкции, KPI)
**Источники:** AUDIT-REPORT-v1.0.6, UX-FINDINGS-APPROVERS-v1.0.6, бизнес-вопросы B5-B9

---

## Сводка тест-кейсов

| Категория | Кол-во | Приоритет |
|-----------|--------|-----------|
| Позитивные (POS) | 8 | P1-P2 |
| Негативные (NEG) | 7 | P1-P2 |
| Граничные (EDGE) | 8 | P1-P2 |
| Манипулятивные (MANIP) | 5 | P1 |
| Производительность (PERF) | 3 | P2 |
| Переходы состояний (STATE) | 4 | P1 |
| **Итого** | **35** | |

---

## Связь с находками аудита и UX

| Находка | Тест-кейсы |
|---------|-----------|
| B5 (автоотказ ГД - нет эскалации) | TC-EXT-005, TC-EXT-006 |
| B6 (улучшение рентабельности при согласовании) | TC-EXT-007, TC-EXT-008 |
| B7 (формулы - нетто или брутто) | TC-EXT-009 |
| B8 (автопродление ЛС + НПСС >90 дней) | TC-EXT-019, TC-EXT-020 |
| B9 (определение подтвержденного дефицита) | TC-EXT-021, TC-EXT-022 |
| UX-APPROVER-001 (цикл корректировки цены) | TC-EXT-010, TC-EXT-011 |
| UX-APPROVER-002 (автоотказ ГД без уведомления) | TC-EXT-005, TC-EXT-006 |
| UX-APPROVER-003 (перегрузка P1/P2) | TC-EXT-033 |
| UX-APPROVER-004 (повторная подача после отказа) | TC-EXT-012 |
| UX-APPROVER-005 (арбитраж мульти-БЮ) | TC-EXT-013 |
| UX-APPROVER-006 (эскалация vs прямая задача) | TC-EXT-014 |
| UX-APPROVER-007 (2-часовое окно экстренного) | TC-EXT-015 |
| UX-APPROVER-008 (стратегический клиент - счетчик) | TC-EXT-023, TC-EXT-024 |
| UX-APPROVER-009 (закрытие ЛС + классификация) | TC-EXT-025 |
| UX-APPROVER-010 (НПСС 61-90 дней - формальное) | TC-EXT-017, TC-EXT-018 |
| Паттерн: противоречие NOTE vs основной текст | TC-EXT-026 |
| Паттерн: граничные значения 0/null/отрицательные | TC-EXT-027, TC-EXT-028, TC-EXT-029 |
| Паттерн: некорректные перекрестные ссылки | TC-EXT-030 |

---

## Тест-кейсы

---

### TC-EXT-001 (POS) - Несколько заказов по одной ЛС: корректный расчет остатка

**Приоритет:** P1
**Тип:** Позитивный
**Требование:** п. 3.10 - остаток ЛС = исходная ЛС - Заказы "В работе" - Заказы на согласовании - Заказы в статусе "Согласован"
**Связь с находками:** -

**Предусловия:**
- ЛС на 100 ед. с плановой рентабельностью 35%, статус "Активна";
- Заказ-1 на 30 ед. в статусе "На согласовании";
- Заказ-2 на 20 ед. в статусе "Согласован";
- Заказ-3 на 10 ед. в статусе "В работе" (проведен РТУ).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Открыть карточку ЛС, проверить отображаемый остаток | Остаток = 100 - 30 - 20 - 10 = 40 ед. |
| 2 | Менеджер создает Заказ-4 на 40 ед. | Заказ создается, ошибок нет |
| 3 | Менеджер создает Заказ-5 на 41 ед. | Ошибка: "Недостаточно доступного остатка ЛС" |
| 4 | Проверить, что черновики НЕ учитываются в остатке | Создание черновика на 100 ед. не влияет на остаток 40 ед. для других менеджеров |

**Ожидаемый результат:** Остаток ЛС корректно вычитает заказы всех учитываемых статусов, черновики не влияют на расчет.

---

### TC-EXT-002 (NEG) - Конкурентный доступ: одновременная отправка черновиков

**Приоритет:** P1
**Тип:** Негативный
**Требование:** п. 3.10 - атомарная блокировка остатка в момент отправки (10 секунд)
**Связь с находками:** -

**Предусловия:**
- ЛС на 100 ед., остаток = 60 ед.;
- Менеджер А имеет черновик Заказа на 40 ед.;
- Менеджер Б имеет черновик Заказа на 35 ед.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер А нажимает "Отправить на согласование" | Блокировка ЛС на 10 сек., обработка запроса |
| 2 | Менеджер Б нажимает "Отправить на согласование" (через 2 сек.) | Менеджер Б ожидает освобождения блокировки (до 30 сек.) |
| 3 | Заказ менеджера А зафиксирован | Остаток ЛС = 60 - 40 = 20 ед. |
| 4 | Заказ менеджера Б проверяется | Ошибка: "Недостаточно доступного остатка ЛС" (35 > 20) |

**Ожидаемый результат:** Атомарная блокировка исключает двойное "захватывание" остатка; второй менеджер получает корректное сообщение об ошибке.

---

### TC-EXT-003 (POS) - Жизненный цикл Заказа: полный позитивный путь

**Приоритет:** P1
**Тип:** Позитивный
**Требование:** п. 3.11 - переходы статусов Заказа
**Связь с находками:** -

**Предусловия:**
- ЛС на 50 ед., плановая рентабельность 35%;
- Заказ на 50 ед. с рентабельностью 36%.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер создает Заказ | Статус = "Черновик", редактирование разрешено |
| 2 | Менеджер отправляет на согласование | Статус = "На согласовании", редактирование заблокировано |
| 3 | Отклонение < 1 п.п. - автосогласование | Статус = "Согласован", срок действия 5 р.д. |
| 4 | Менеджер создает РТУ на 30 ед. | Статус = "В работе", редактирование заблокировано |
| 5 | Менеджер создает РТУ на 20 ед. (остаток) | Статус = "Исполнен" |
| 6 | Проверить, что повторный контроль рентабельности при РТУ НЕ выполняется | РТУ проводится без дополнительных проверок |

**Ожидаемый результат:** Заказ проходит весь цикл: Черновик - На согласовании - Согласован - В работе - Исполнен.

---

### TC-EXT-004 (STATE) - Аннулирование согласования: все триггеры

**Приоритет:** P1
**Тип:** Переходы состояний
**Требование:** п. 3.11 - согласование аннулируется при 6 условиях
**Связь с находками:** -

**Предусловия:**
- ЛС на 100 ед., плановая рентабельность 35%;
- Заказ-1 на 50 ед. в статусе "Согласован" (отклонение 5 п.п.).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Подождать 5 р.д. + 1 час без перевода в работу | Статус → "Согл. истекло", уведомление менеджеру |
| 2 | (Новый Заказ) Согласован. Менеджер изменяет цену в Заказе | Статус → "Согл. истекло", т.к. состав/цены изменены |
| 3 | (Новый Заказ) Согласован (отклонение 5). Другой менеджер проводит Заказ-2 по ЛС, отклонение растет до 9 | Разница 4 > 3 п.п. → аннулирование |
| 4 | (Новый Заказ) Согласован. Плановая рентабельность ЛС изменена через пересогласование | Аннулирование всех активных согласований |
| 5 | (Новый Заказ) Согласован. Изменился уровень: было РБЮ, стало ДП | Аннулирование |
| 6 | Заказ в статусе "Согласован", установлен флаг "ПереданНаСклад" | Согласование НЕ аннулируется (точка невозврата) |

**Ожидаемый результат:** Все 5 триггеров аннулирования работают корректно; точка невозврата защищает переданные на склад заказы.

---

### TC-EXT-005 (NEG) - Автоотказ ГД через 48ч: терминальное поведение

**Приоритет:** P1 (CRITICAL)
**Тип:** Негативный
**Требование:** п. 3.6 - автоотказ ГД; бизнес-вопрос B5
**Связь с находками:** B5, UX-APPROVER-002

**Предусловия:**
- Заказ на 2 млн руб., отклонение 28 п.п. → уровень ГД;
- ГД в командировке, заместитель не назначен;
- Прошло 48 часов с момента получения задачи.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Система выполняет автоотказ | Заказ → статус "Отклонен" |
| 2 | Проверить уведомление менеджеру | Получено, текст: "Автоматический отказ (бездействие 48ч)" |
| 3 | Проверить уведомление ГД | ГД уведомлен об автоотказе по его задаче |
| 4 | Проверить: есть ли уведомление вышестоящей инстанции (CFO / совет) | **ОЖИДАЕМЫЙ ПРОБЕЛ (B5):** уведомления нет. ФМ не описывает эскалацию выше ГД |
| 5 | Менеджер пробует повторно подать тот же Заказ | Заказ можно переподать, но история предыдущего отказа НЕ привязана к новой задаче |

**Ожидаемый результат:** Автоотказ выполняется, но отсутствуют: (а) уведомление CFO/совету, (б) пометка "автоматический" в истории, (в) связь с предыдущей подачей. Подтверждает критичность B5.

---

### TC-EXT-006 (EDGE) - Автоотказ ГД при выполнении условия автосогласования

**Приоритет:** P1 (CRITICAL)
**Тип:** Граничный
**Требование:** п. 3.6 - исключение: если "Накопленная + Заказ" = плановой рентабельности ЛС, то автосогласование
**Связь с находками:** B5, UX-APPROVER-002

**Предусловия:**
- Заказ с отклонением 28 п.п. отправлен на согласование ГД;
- За 47 часов другой менеджер провел прибыльные Заказы по той же ЛС;
- В момент 48-часовой отметки: "Накопленная + Заказ" = плановой рентабельности ЛС (отклонение 0).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Таймер 48 часов срабатывает | Система проверяет исключение перед автоотказом |
| 2 | Проверка: "Накопленная + Заказ" = план | Должно выполниться автосогласование, а НЕ автоотказ |
| 3 | Проверить статус Заказа | Статус = "Согласован" (а не "Отклонен") |
| 4 | Проверить: уведомление менеджеру | Текст: "Автосогласование (отклонение устранено)" |

**Ожидаемый результат:** При устранении отклонения другими Заказами автоотказ заменяется автосогласованием. Проверяет корректность исключения из п. 3.6.

---

### TC-EXT-007 (EDGE) - Улучшение рентабельности во время согласования: снижение уровня

**Приоритет:** P1 (HIGH)
**Тип:** Граничный
**Требование:** п. 3.6 (улучшение НЕ является триггером аннулирования); бизнес-вопрос B6
**Связь с находками:** B6, UX-APPROVER-006

**Предусловия:**
- Заказ с отклонением 20 п.п. → уровень ДП, задача назначена ДП;
- Другой менеджер провел прибыльный Заказ по ЛС;
- Отклонение снизилось с 20 п.п. до 8 п.п. (теперь уровень РБЮ).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | ДП открывает задачу на согласование | ДП видит актуальное отклонение 8 п.п., а не 20 п.п. |
| 2 | Проверить: произошла ли автоматическая передача задачи на РБЮ | **ОЖИДАЕМЫЙ ПРОБЕЛ (B6):** ФМ НЕ описывает снижение уровня. Задача остается у ДП |
| 3 | ДП согласует Заказ | Заказ согласован (ДП имеет полномочия) |
| 4 | Проверить: не создалась ли дублирующая задача для РБЮ | Дубликатов нет |

**Ожидаемый результат:** Задача НЕ переназначается на нижний уровень. ДП согласует (уровень достаточен). Подтверждает пробел B6 - нет механизма оптимизации.

---

### TC-EXT-008 (STATE) - Улучшение рентабельности до уровня "без согласования"

**Приоритет:** P1
**Тип:** Переходы состояний
**Требование:** п. 3.6 - улучшение НЕ триггер аннулирования; бизнес-вопрос B6
**Связь с находками:** B6

**Предусловия:**
- Заказ с отклонением 5 п.п. → уровень РБЮ, задача назначена;
- Другой менеджер провел прибыльный Заказ по ЛС;
- Отклонение снизилось до 0.5 п.п. (< 1 п.п. - согласование не требуется).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Проверить: автоматически ли согласуется Заказ | **ОЖИДАЕМЫЙ ПРОБЕЛ:** ФМ не описывает автосогласование при улучшении ниже 1 п.п. |
| 2 | РБЮ все еще видит задачу | Задача остается (отклонение не является триггером аннулирования) |
| 3 | РБЮ согласует | Заказ согласован |

**Ожидаемый результат:** Даже при устранении отклонения задача остается у согласующего. Подтверждает необходимость правила из B6.

---

### TC-EXT-009 (EDGE) - Формула выручки: нетто или брутто (с учетом возвратов)

**Приоритет:** P1 (HIGH)
**Тип:** Граничный
**Требование:** п. 3.3 (формула рентабельности), п. 3.14 (возврат); бизнес-вопрос B7
**Связь с находками:** B7

**Предусловия:**
- ЛС на 100 ед. Отгружено 80 ед. с рентабельностью 35%;
- Клиент вернул 20 ед. через 30 дней (< 60 дней);
- Рентабельность возвращенных позиций (по цене РТУ) = 40%.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Система пересчитывает накопленную рентабельность | Пересчет по оставшимся 60 ед. (без возвращенных) |
| 2 | Проверить: используется ли цена из РТУ (не текущая НПСС) | Цена возврата = цена из связанного РТУ (п. 3.14) |
| 3 | Проверить: "Отгружено" в формуле % выкупа | Отгружено = 80 - 20 = 60 (нетто) |
| 4 | **ПРОВЕРКА B7:** Формула рентабельности Заказа использует нетто-выручку? | Необходимо уточнить: если менеджер создает новый Заказ, учитываются ли возвраты в "Накопленная" |

**Ожидаемый результат:** Рентабельность пересчитывается корректно с учетом возвратов; формула использует нетто-значения. Подтверждает или опровергает B7.

---

### TC-EXT-010 (NEG) - Согласование с корректировкой цены: полный цикл отсутствует

**Приоритет:** P1 (CRITICAL)
**Тип:** Негативный
**Требование:** п. 3.4 - три варианта решения согласующего; бизнес-вопрос B2
**Связь с находками:** B2, UX-APPROVER-001

**Предусловия:**
- Заказ с отклонением 8 п.п. → уровень РБЮ;
- РБЮ хочет согласовать с корректировкой цены.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | РБЮ нажимает "Согласовать с корректировкой цены" | **ПРОБЕЛ:** Какой интерфейс открывается? Какие поля доступны? |
| 2 | РБЮ указывает новую цену по проблемным позициям | **ПРОБЕЛ:** Есть ли автопересчет рентабельности в реальном времени? |
| 3 | Новая цена все еще не проходит порог (отклонение 6 п.п.) | **ПРОБЕЛ:** Нужна ли повторная итерация? Кто видит предупреждение? |
| 4 | Для EDI-заказа: попытка изменить цену | **ПРОБЕЛ:** Ограничения EDI при корректировке не описаны |

**Ожидаемый результат:** Тест фиксирует отсутствие описания полного цикла корректировки цены. Критическая находка UX-APPROVER-001 / B2 подтверждена.

---

### TC-EXT-011 (POS) - Согласование с корректировкой цены: рекурсивная проверка

**Приоритет:** P1
**Тип:** Позитивный
**Требование:** п. 3.4 - корректировка цены; бизнес-вопрос B2
**Связь с находками:** B2, UX-APPROVER-001

**Предусловия:**
- Заказ с отклонением 8 п.п. → уровень РБЮ;
- РБЮ указывает новую цену, после которой отклонение = 0.5 п.п.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | РБЮ вводит новую цену в форме корректировки | Система пересчитывает рентабельность в реальном времени |
| 2 | Отклонение < 1 п.п. | Отображается индикатор "Согласование не потребуется" |
| 3 | РБЮ подтверждает корректировку | Цена в Заказе обновляется, статус → "Согласован" |
| 4 | Менеджер видит уведомление | "Заказ согласован с корректировкой цены. Новая цена: [X]" |

**Ожидаемый результат:** Полный цикл корректировки завершается успешно с автоматическим пересчетом. (Целевое поведение для устранения B2.)

---

### TC-EXT-012 (NEG) - Повторная подача после отклонения: связь с предыдущим

**Приоритет:** P2 (HIGH)
**Тип:** Негативный
**Требование:** п. 3.11 - статус "Отклонен", действия менеджера
**Связь с находками:** UX-APPROVER-004

**Предусловия:**
- Заказ-1 отклонен РБЮ с причиной "Цена ниже закупочной по кабель-каналу";
- Менеджер редактирует Заказ и подает повторно (Заказ все тот же документ).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер меняет цену и нажимает "Отправить на согласование" | Заказ → "На согласовании" |
| 2 | РБЮ получает задачу | **ПРОБЕЛ:** Нет пометки "повторная подача" |
| 3 | РБЮ открывает задачу | **ПРОБЕЛ:** Нет ссылки на предыдущее отклонение и его причину |
| 4 | Проверить: видит ли РБЮ историю отказов в списке задач (не открывая карточку) | Не видит - история только в карточке Заказа (п. 3.11) |
| 5 | Менеджер подает тот же Заказ без изменений (третья попытка) | Система не блокирует повторную подачу без изменений |

**Ожидаемый результат:** Подтверждает UX-APPROVER-004: нет визуальной связи между повторной подачей и предыдущим отклонением. Нет блокировки повторной подачи без изменений.

---

### TC-EXT-013 (NEG) - Арбитраж мульти-БЮ: информация для Директора ДРП

**Приоритет:** P1 (HIGH)
**Тип:** Негативный
**Требование:** п. 3.8 - мульти-БЮ Заказ; SLA арбитража 8 р.ч.
**Связь с находками:** UX-APPROVER-005

**Предусловия:**
- Заказ с товарами из БЮ-1 и БЮ-2;
- РБЮ-1 согласовал (рентабельность по его БЮ = 32%);
- РБЮ-2 отклонил (рентабельность по его БЮ = 12%);
- Задача эскалирована Директору ДРП.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Директор ДРП открывает задачу арбитража | Видит общую информацию по Заказу |
| 2 | Проверить: видит ли арбитр обоснования обоих РБЮ в одном окне | **ПРОБЕЛ:** Нет описания формата представления конфликта |
| 3 | Проверить: какие варианты решения доступны | **ПРОБЕЛ:** Не описано - "согласовать полностью" / "частично" / "отклонить" / "вернуть" |
| 4 | Все РБЮ не ответили (автоэскалация) | Директор ДРП получает задачу БЕЗ решений РБЮ - нужно решать с нуля |

**Ожидаемый результат:** Подтверждает UX-APPROVER-005: недостаточно информации для арбитража. Нет единой формы с решениями обоих РБЮ.

---

### TC-EXT-014 (STATE) - Эскалация vs прямая задача ДП: различимость

**Приоритет:** P2 (HIGH)
**Тип:** Переходы состояний
**Требование:** п. 3.6 - автоэскалация; п. 3.4 - уровни
**Связь с находками:** UX-APPROVER-006

**Предусловия:**
- Заказ-1: отклонение 20 п.п. → уровень ДП (прямая задача);
- Заказ-2: отклонение 8 п.п. → уровень РБЮ, РБЮ не ответил за 4ч → Директор ДРП +4ч → ДП (эскалация).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | ДП открывает список задач | **ПРОБЕЛ:** Обе задачи отображаются одинаково |
| 2 | Проверить: есть ли индикатор "эскалация" на Заказе-2 | **ПРОБЕЛ:** Нет визуального отличия |
| 3 | Проверить: видит ли ДП историю маршрутизации Заказа-2 | **ПРОБЕЛ:** Кому назначалось, когда, решение/таймаут - не описано |
| 4 | ДП анализирует Заказ-2 без контекста эскалации | +20 мин. на выяснение истории |

**Ожидаемый результат:** Подтверждает UX-APPROVER-006: эскалированные и прямые задачи визуально неразличимы.

---

### TC-EXT-015 (EDGE) - Экстренное согласование: 2-часовое окно и тип часов

**Приоритет:** P2 (MEDIUM)
**Тип:** Граничный
**Требование:** п. 3.7 - экстренное согласование, подтверждение постфактум
**Связь с находками:** UX-APPROVER-007

**Предусловия:**
- Менеджер провел экстренное согласование в 17:30 пятницы;
- РБЮ получает push-уведомление о подтверждении.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Push-уведомление отправлено в 17:30 | РБЮ получает уведомление |
| 2 | Проверить: 2 часа = календарные или рабочие? | **ПРОБЕЛ:** Для SLA (п. 3.6) указано "рабочие часы", для п. 3.7 - не уточнено |
| 3 | Если календарные: таймер истекает в 19:30 пятницы | Автоотказ в нерабочее время - создается инцидент |
| 4 | Товар уже отгружен (п. 3.7: отгрузка ДО подтверждения) | Автоотказ создает инцидент, но НЕ отменяет отгрузку |
| 5 | Проверить: доступен ли третий вариант "Подтверждаю постфактум" | **ПРОБЕЛ:** Только "подтвердить" / "отклонить" |

**Ожидаемый результат:** Подтверждает UX-APPROVER-007: тип часов (рабочие/календарные) не определен; автоотказ в нерабочее время создает формальные инциденты.

---

### TC-EXT-016 (POS) - Блокировка при НПСС = 0 и Цена = 0

**Приоритет:** P1
**Тип:** Позитивный
**Требование:** п. 3.3 - при НПСС=0/NULL блокировка с уведомлением; при Цена=0 блокировка
**Связь с находками:** Паттерн граничных условий

**Предусловия:**
- ЛС с позицией, для которой НПСС = 0 в регистре.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер создает Заказ с этой позицией | Позиция блокируется |
| 2 | Проверить уведомление финансовой службе | Уведомление отправлено с перечнем позиций |
| 3 | SLA на исправление: 24 р.ч. | Таймер запущен |
| 4 | Через 48 р.ч. без исправления | Эскалация к ФД |
| 5 | Тест с Цена = 0 в позиции | Позиция блокируется, уведомление менеджеру "Ошибка ценообразования" |
| 6 | Тест с НПСС = NULL (не заполнено) | Позиция блокируется аналогично НПСС = 0 |

**Ожидаемый результат:** Система корректно блокирует позиции с нулевой/пустой НПСС и нулевой ценой. Уведомления отправляются соответствующим получателям.

---

### TC-EXT-017 (POS) - Контроль актуальности НПСС: трехуровневый

**Приоритет:** P1
**Тип:** Позитивный
**Требование:** п. 3.15 - возраст НПСС: 0-30, 31-60, 61-90, 90+ дней
**Связь с находками:** UX-APPROVER-010

**Предусловия:**
- ЛС с позициями, у которых НПСС обновлялась в разные даты.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Позиция с НПСС возрастом 25 дней | Работа без ограничений, индикатор зеленый |
| 2 | Позиция с НПСС возрастом 45 дней | Предупреждение (желтый индикатор), работа разрешена |
| 3 | Позиция с НПСС возрастом 75 дней | Требуется подтверждение РБЮ |
| 4 | Позиция с НПСС возрастом 95 дней | Блокировка создания Заказов, обязательный пересчет |
| 5 | Проверить: возраст считается от даты расчета НПСС в регистре, а не от даты создания ЛС | Дата берется из "Нормативная плановая себестоимость" для конкретной номенклатуры |

**Ожидаемый результат:** Все 4 уровня контроля работают корректно с правильным источником даты.

---

### TC-EXT-018 (EDGE) - НПСС возраст: граничные значения 30/60/90 дней

**Приоритет:** P1
**Тип:** Граничный
**Требование:** п. 3.15 - пороги возраста НПСС
**Связь с находками:** UX-APPROVER-010, паттерн граничных условий

**Предусловия:**
- ЛС с позициями, НПСС обновляется в контролируемую дату.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Возраст НПСС = 30 дней (ровно) | Без ограничений ("До 30 дней" включает 30) |
| 2 | Возраст НПСС = 31 день | Предупреждение (желтый), переход в диапазон 31-60 |
| 3 | Возраст НПСС = 60 дней (ровно) | Предупреждение (желтый), все еще диапазон 31-60 |
| 4 | Возраст НПСС = 61 день | Требуется подтверждение РБЮ |
| 5 | Возраст НПСС = 90 дней (ровно) | Требуется подтверждение РБЮ (все еще диапазон 61-90) |
| 6 | Возраст НПСС = 91 день | Блокировка |
| 7 | Возраст НПСС = 80 дней | ДП получает уведомление с возможностью временного разрешения |
| 8 | ДП разрешает продажи при НПСС 80+ дней | ВСЕ заказы требуют согласования РБЮ до обновления НПСС |

**Ожидаемый результат:** Граничные значения обрабатываются корректно. Эскалация при 80 днях (до блокировки) работает.

---

### TC-EXT-019 (EDGE) - Автопродление ЛС + НПСС > 90 дней: конфликт

**Приоритет:** P1 (HIGH)
**Тип:** Граничный
**Требование:** п. 3.17 (автопродление 5 р.д.), п. 3.15 (НПСС > 90 = блокировка); бизнес-вопрос B8
**Связь с находками:** B8

**Предусловия:**
- ЛС истекает 01.04, НПСС возраст = 92 дня (> 90, блокировка);
- Товар по Заказу в статусе "Ожидает поступления" поступил 29.03 (за 3 р.д. до истечения);
- Сработало автопродление ЛС на 5 р.д. (до 07.04).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Товар поступил, автопродление активировано | ЛС продлена до 07.04 |
| 2 | Клиент подтверждает Заказ в течение 5 р.д. | Заказ → "На согласовании" |
| 3 | Система проверяет НПСС: возраст 92 дня | **КОНФЛИКТ (B8):** Блокировка создания Заказов (НПСС > 90) противоречит автопродлению |
| 4 | Проверить: проходит ли Заказ на согласование или блокируется | **ОЖИДАЕМЫЙ ПРОБЕЛ:** ФМ не описывает приоритет правил |
| 5 | Если блокировка - автопродление бесполезно | Клиент не может выкупить товар, который ждал 90 дней |

**Ожидаемый результат:** Подтверждает конфликт B8: автопродление + блокировка НПСС > 90 дней взаимоисключают друг друга. Необходимо правило приоритета.

---

### TC-EXT-020 (EDGE) - НПСС пересчет при продлении ЛС > 3 месяцев

**Приоритет:** P2
**Тип:** Граничный
**Требование:** п. 3.9 (пересчет НПСС при продлении > 3 мес.), п. 3.12 (продление макс. 2 раза)
**Связь с находками:** B8

**Предусловия:**
- ЛС создана 01.01, срок до 01.04 (3 мес.);
- Продление 1: до 01.07 (суммарно > 3 мес. от создания);
- Пересчет НПСС после продления.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер продлевает ЛС на 3 мес. (первый раз) | ЛС продлена, пересчет НПСС выполняется автоматически |
| 2 | Новая НПСС существенно отличается (цены выросли на 15%) | Плановая рентабельность пересчитана |
| 3 | Заказы в статусе "Согласован" | Проверить: аннулируются ли согласования при изменении НПСС |
| 4 | Менеджер продлевает второй раз | Продление разрешено (макс. 2 раза) |
| 5 | Менеджер пробует продлить третий раз | Отказ: "Достигнут лимит продлений (2)" |

**Ожидаемый результат:** Пересчет НПСС выполняется корректно при продлении > 3 мес.; лимит 2 продлений соблюдается.

---

### TC-EXT-021 (POS) - Определение подтвержденного дефицита: алгоритмическое

**Приоритет:** P1 (HIGH)
**Тип:** Позитивный
**Требование:** п. 3.18 - подтвержденный дефицит; п. 3.17 - фиксация потребности; бизнес-вопрос B9
**Связь с находками:** B9

**Предусловия:**
- ЛС на 1 000 000 руб. (3 позиции);
- Позиция "Розетка" (250 000 руб.): клиент зафиксировал потребность 15.02 (за 45 дней до истечения 01.04);
- На момент фиксации товара не было на складе;
- Товар не поступил до 01.04.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | ЛС закрывается (срок истек) | Триггер расчета санкций |
| 2 | Система определяет подтвержденный дефицит | Проверка всех 3 условий: (а) фиксация за 14+ дней - ДА; (б) товара не было - ДА; (в) товар не поступил - ДА |
| 3 | "Розетка" = подтвержденный дефицит | Исключается из базы расчета |
| 4 | % выкупа = Отгружено / (1 000 000 - 250 000) | База = 750 000 руб. |
| 5 | Проверить: кто определяет дефицит - система или РБЮ вручную? | **ПРОБЕЛ (B9):** BPMN показывает РБЮ на шаге "Определение дефицита", но правила алгоритмические |

**Ожидаемый результат:** Подтвержденный дефицит определяется корректно. Выявляет B9: ручное определение РБЮ противоречит алгоритмическим правилам.

---

### TC-EXT-022 (NEG) - Позиция НЕ признается дефицитом: все исключения

**Приоритет:** P1
**Тип:** Негативный
**Требование:** п. 3.18 - позиция НЕ признается дефицитом
**Связь с находками:** B9

**Предусловия:**
- ЛС с 3 позициями, каждая с разными условиями.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Позиция А: клиент НЕ фиксировал потребность вообще | НЕ является дефицитом, учитывается в санкциях |
| 2 | Позиция Б: фиксация за 10 дней до истечения, товар отсутствовал 40 дней | НЕ является дефицитом (< 14 дней И товар отсутствовал < 60 дней) |
| 3 | Позиция В: товар поступил, клиент не подтвердил за 5 р.д. | НЕ является дефицитом (товар был, клиент проигнорировал) |
| 4 | Все 3 позиции учитываются в базе расчета санкций | % выкупа считается по полной ЛС |

**Ожидаемый результат:** Все 3 исключения из определения дефицита работают корректно. Позиции справедливо учитываются в санкциях.

---

### TC-EXT-023 (POS) - Отмена санкции для стратегического клиента: счетчик и лимит

**Приоритет:** P1 (MEDIUM)
**Тип:** Позитивный
**Требование:** п. 3.18 - ДП отменяет санкцию, лимит 3 отмены/год
**Связь с находками:** UX-APPROVER-008

**Предусловия:**
- Клиент с годовым оборотом 15 млн руб. (критерий "а" стратегичности);
- % выкупа по ЛС = 78% → санкция: скидка -3 п.п.;
- В текущем году использовано 2 отмены из 3.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер инициирует запрос на отмену санкции | Запрос поступает ДП |
| 2 | ДП открывает форму отмены | **ПРОБЕЛ (UX-008):** Видит ли ДП счетчик "Использовано: 2 из 3"? |
| 3 | Система автоматически проверяет критерии стратегичности | Подтверждается: оборот 15 млн > 10 млн |
| 4 | ДП утверждает отмену (третья за год) | Санкция снята, запись в журнале LS-FR-037 |
| 5 | Новый запрос на отмену (четвертый) | Лимит превышен: "Требуется согласие ФД" |

**Ожидаемый результат:** Лимит 3 отмен в год работает корректно; при превышении требуется ФД. Подтверждает UX-APPROVER-008 о необходимости счетчика.

---

### TC-EXT-024 (EDGE) - Стратегический клиент: граничные критерии

**Приоритет:** P2
**Тип:** Граничный
**Требование:** п. 3.18 - критерии стратегичности
**Связь с находками:** UX-APPROVER-008

**Предусловия:**
- Три клиента с разными критериями.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Клиент А: оборот 9 999 999 руб. (< 10 млн) | НЕ стратегический по критерию "а" |
| 2 | Клиент А: не в реестре Директора ДРП | НЕ стратегический по критерию "б" |
| 3 | Клиент А: контракт на 999 999 руб. (< 1 млн) | НЕ стратегический по критерию "в". Отмена невозможна |
| 4 | Клиент Б: оборот 10 000 000 руб. (ровно 10 млн) | Стратегический по критерию "а" (граница включена) |
| 5 | Клиент В: оборот 5 млн, но в реестре Директора ДРП | Стратегический по критерию "б" |
| 6 | Проверить: счетчик обнуляется 1 января | 31.12 - 3 отмены использованы; 01.01 - счетчик = 0 |

**Ожидаемый результат:** Граничные значения критериев стратегичности обрабатываются корректно. Обнуление счетчика 1 января работает.

---

### TC-EXT-025 (NEG) - Закрытие ЛС + классификация причин: два несвязанных действия

**Приоритет:** P2 (MEDIUM)
**Тип:** Негативный
**Требование:** п. 3.12 (закрытие ЛС), п. 3.18 (KPI, классификация причин)
**Связь с находками:** UX-APPROVER-009

**Предусловия:**
- ЛС закрывается с частичной отгрузкой, отклонение 8 п.п. → согласование РБЮ;
- Одновременно требуется классификация причин незакрытого остатка (п. 3.18 KPI).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | РБЮ получает задачу на согласование закрытия ЛС (п. 3.12) | Задача в дашборде |
| 2 | Проверить: содержит ли задача закрытия форму классификации причин | **ПРОБЕЛ:** Классификация описана в п. 3.18, согласование в п. 3.12 - два разных процесса |
| 3 | РБЮ согласует закрытие без классификации | Закрытие выполнено, но KPI менеджера не рассчитан |
| 4 | Позже: РБЮ должен отдельно классифицировать причины | Дублирование работы, отсутствие единой формы |
| 5 | Конфликт интересов: РБЮ управляет менеджером И оценивает его KPI | Проверить: есть ли аудит-след классификации |

**Ожидаемый результат:** Подтверждает UX-APPROVER-009: два действия (согласование + классификация) не объединены в одну форму. Конфликт интересов не митигирован.

---

### TC-EXT-026 (EDGE) - Противоречие в примечаниях vs основной текст (паттерн NOTE)

**Приоритет:** P2
**Тип:** Граничный
**Требование:** п. 3.12 (50 Заказов на согласовании), п. 3.10 (лимит 10 Заказов)
**Связь с находками:** Паттерн противоречия NOTE vs основной текст

**Предусловия:**
- ЛС с активными Заказами.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Проверить п. 3.10: "жесткий лимит 10 Заказов на согласовании" | Блокировка при 10+ Заказах |
| 2 | Проверить п. 3.12: "система поддерживает до 50 Заказов в статусе На согласовании" | **ПРОТИВОРЕЧИЕ:** 10 (п. 3.10) vs 50 (п. 3.12, Примечание) |
| 3 | Создать 11-й Заказ на согласование | Какой лимит применяется: 10 или 50? |
| 4 | Создать 51-й Заказ на согласование | По п. 3.12 - система ставит в очередь |

**Ожидаемый результат:** Выявляет противоречие между лимитами в п. 3.10 (10 Заказов, жесткий лимит для менеджера) и п. 3.12 (50 Заказов, системный лимит НФТ). Требуется уточнение: это разные ограничения или одно из них ошибочно.

---

### TC-EXT-027 (EDGE) - Формула % выкупа: граничные значения

**Приоритет:** P1
**Тип:** Граничный
**Требование:** п. 3.18 - формула % выкупа, округление
**Связь с находками:** Паттерн граничных условий

**Предусловия:**
- ЛС на 100 000 руб., подтвержденный дефицит = 0 руб.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Отгружено 89 900 руб., возвраты (60д) = 0 | % = 89 900 / 100 000 = 89.9% → округление вниз → 89% |
| 2 | Проверить санкцию при 89% | Санкция: -3 п.п. к скидке (диапазон 70-89%) |
| 3 | Отгружено 90 000 руб. | % = 90% → без санкций (диапазон 90-100%) |
| 4 | Отгружено 89 999 руб. | % = 89.999% → округление вниз → 89% → санкция -3 п.п. |
| 5 | Отгружено 0 руб. (клиент ничего не выкупил) | % = 0% → санкция: только стандартные цены |
| 6 | ЛС = 100 000, дефицит = 100 000 | % = 0 / 0 → **ДЕЛЕНИЕ НА НОЛЬ** |
| 7 | ЛС = 100 000, дефицит = 99 999 | % = 0 / 1 = 0% → только стандартные цены |

**Ожидаемый результат:** Округление "вниз до целого" (п. 3.18) работает корректно на границах; деление на ноль обработано без ошибки.

---

### TC-EXT-028 (EDGE) - Формула рентабельности: отрицательная НПСС и нулевая цена

**Приоритет:** P1
**Тип:** Граничный
**Требование:** п. 3.3 - формула рентабельности
**Связь с находками:** Паттерн граничных условий (0/null/отрицательные)

**Предусловия:**
- Позиция с различными некорректными значениями.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | НПСС = -100 (отрицательная, ошибка данных) | Блокировка позиции (аналогично НПСС=0) или ошибка |
| 2 | Цена = 0, НПСС = 100 | Деление на ноль: (0-100)/0 → блокировка с уведомлением "Ошибка ценообразования" |
| 3 | Цена = 100, НПСС = 100 | Рентабельность = 0% → ниже любого плана → согласование |
| 4 | Цена = 100, НПСС = 150 | Рентабельность = -50% → убыточная продажа |
| 5 | Цена = 0.01, НПСС = 0.01 | Рентабельность = 0% (корректный расчет с малыми числами) |
| 6 | Цена = 999 999 999, НПСС = 1 | Рентабельность ≈ 100% (корректный расчет с большими числами) |

**Ожидаемый результат:** Все аномальные значения обрабатываются без ошибок системы. Блокировки при НПСС=0/NULL и Цена=0 срабатывают.

---

### TC-EXT-029 (EDGE) - Санкции: суммирование и максимум

**Приоритет:** P1
**Тип:** Граничный
**Требование:** п. 3.18 - суммирование санкций, максимум "только стандартные цены"
**Связь с находками:** Паттерн граничных условий

**Предусловия:**
- Клиент с историей нарушений.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | ЛС-1 закрыта: % выкупа = 85% → -3 п.п. | Санкция -3 п.п. к скидке на след. ЛС |
| 2 | ЛС-2 закрыта: % выкупа = 80% → -3 п.п. | Суммарная санкция: -3 + (-3) = -6 п.п. |
| 3 | ЛС-3 закрыта: % выкупа = 55% → -10 п.п. | Суммарная санкция: -6 + (-10) = -16 п.п. → превышает -13 |
| 4 | Проверить: применяется максимум | Только стандартные цены (при -13 и более) |
| 5 | Реабилитация: 6 мес. без нарушений | Счетчик обнуляется до 0 |
| 6 | Новая ЛС после реабилитации | Санкции сняты, клиент работает на обычных условиях |
| 7 | Две ЛС закрываются одновременно | Санкции рассчитываются по каждой независимо и суммируются |

**Ожидаемый результат:** Суммирование санкций работает корректно; максимум "только стандартные цены" при -13+ п.п.; реабилитация обнуляет счетчик.

---

### TC-EXT-030 (NEG) - Перекрестные ссылки: верификация после исправлений v1.0.6

**Приоритет:** P2
**Тип:** Негативный
**Требование:** Все разделы - перекрестные ссылки между п. 3.10-3.18
**Связь с находками:** Паттерн некорректных перекрестных ссылок, аудит v1.0.6 (5 исправлений)

**Предусловия:**
- Актуальная версия ФМ v1.0.6 (Confluence v49).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | FAQ: ссылка на санкции за невыкуп | Указывает на п. 3.18 (исправлено с п. 3.16 в v1.0.6) |
| 2 | п. 3.9: ссылка на блокировку НПСС=0 | Указывает на п. 3.3 (исправлено с п. 3.4 в v1.0.6) |
| 3 | п. 3.12: ссылка на Заказы клиента | Указывает на BPMN 4 (п. 3.11) |
| 4 | п. 3.13: ссылка "отклонение 3.4 → уровень РБЮ" | Проверить: это ссылка на п. 3.4 (уровни) - корректно? |
| 5 | п. 3.13: "санкция согласно п. 3.18" | Проверить корректность ссылки |
| 6 | п. 3.15: "согласование Заказов, п. 3.4" | Проверить корректность |
| 7 | п. 3.18: KPI ссылка на LS-RPT-064 | Проверить: отчет описан и доступен |

**Ожидаемый результат:** Все перекрестные ссылки в разделах 3.10-3.18 указывают на корректные пункты ФМ. Исправления v1.0.6 верифицированы.

---

### TC-EXT-031 (MANIP) - Манипуляция: снижение плановой рентабельности ЛС для обхода контроля

**Приоритет:** P1
**Тип:** Манипулятивный
**Требование:** п. 3.15 - контроль изменения плановой рентабельности; п. 3.16 - риск манипуляции
**Связь с находками:** -

**Предусловия:**
- ЛС с плановой рентабельностью 35%;
- Менеджер хочет провести Заказ с рентабельностью 20% без согласования.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер пробует изменить плановую рентабельность на 18% | Запрещено без согласования (снижение > 3 п.п.) |
| 2 | Менеджер пробует снизить на 2.99 п.п. (до 32.01%) | Снижение 0-3 п.п. → требуется согласование РБЮ |
| 3 | Менеджер пробует снизить поэтапно: 35→32 (РБЮ), затем 32→29 (РБЮ) | Каждое снижение требует отдельного согласования |
| 4 | Менеджер пробует снизить после первой РТУ | Требуется пересогласование ВСЕХ активных заказов (п. 3.16) |
| 5 | Снижение вызвано пересчетом НПСС (НПСС выросла) | Исключение: согласование НЕ требуется |

**Ожидаемый результат:** Все попытки обхода контроля блокируются. Исключение для пересчета НПСС работает корректно.

---

### TC-EXT-032 (MANIP) - Манипуляция: фиктивная фиксация потребности для избежания санкций

**Приоритет:** P1
**Тип:** Манипулятивный
**Требование:** п. 3.17 - защита от манипуляций с фиксацией; п. 3.18 - подтвержденный дефицит
**Связь с находками:** -

**Предусловия:**
- ЛС истекает 01.04;
- Товар X был в наличии с 01.01 по 15.03 (отсутствует 17 дней на момент фиксации);
- Клиент фиксирует потребность 25.03 (за 7 дней до истечения - в "опасной зоне").

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Клиент/менеджер фиксирует потребность 25.03 | Фиксация принята, но с пометкой "< 14 дней до истечения" |
| 2 | Система проверяет историю наличия | Товар отсутствовал 17 дней (с 15.03), < 60 дней подряд |
| 3 | Фиксация НЕ признается подтвержденным дефицитом | Позиция учитывается в санкциях |
| 4 | Другой случай: товар отсутствовал 65 дней (с 20.01) | Фиксация в последние 14 дней ПРИЗНАЕТСЯ (> 60 дней отсутствия) |
| 5 | Проверить: черновик НЕ фиксирует потребность | Создание черновика на проблемные позиции не защищает от санкций |

**Ожидаемый результат:** Защита от фиктивной фиксации работает: правило 14 дней + 60 дней отсутствия предотвращает манипуляции.

---

### TC-EXT-033 (PERF) - Производительность: 100+ согласований в день на одного РБЮ

**Приоритет:** P2
**Тип:** Производительность
**Требование:** п. 3.6 (SLA), дашборд LS-FR-045
**Связь с находками:** UX-APPROVER-003

**Предусловия:**
- РБЮ отвечает за 3 бизнес-юнита;
- Активный день: 120 запросов на согласование (80 P2, 40 P1).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | 120 задач поступают в течение рабочего дня (8 часов) | Дашборд "Ожидают моего решения" отображает все 120 |
| 2 | P1 (40 задач): SLA 4 часа | Среднее время на задачу < 6 мин. при 100% выполнении SLA |
| 3 | Проверить: визуальная дифференциация P1 vs P2 | **ПРОБЕЛ (UX-003):** Нет описания визуальной индикации |
| 4 | Проверить: группировка по ЛС/клиенту | **ПРОБЕЛ:** Несколько заказов по одной ЛС - удобнее рассматривать вместе |
| 5 | 20% задач автоэскалируются из-за таймаута | Директор ДРП получает 24 дополнительных задачи |
| 6 | Время загрузки дашборда с 120 задачами | < 3 секунды |

**Ожидаемый результат:** Система корректно обрабатывает высокую нагрузку; дашборд загружается за допустимое время. Подтверждает UX-APPROVER-003 о рисках перегрузки.

---

### TC-EXT-034 (PERF) - Производительность: конкурентный доступ к ЛС (10 менеджеров)

**Приоритет:** P2
**Тип:** Производительность
**Требование:** п. 3.10 (конкурентный доступ), п. 3.15 (блокировка ЛС), п. 3.16 (риск очередей)
**Связь с находками:** -

**Предусловия:**
- Крупная ЛС проекта на 1000 позиций;
- 10 менеджеров одновременно работают с этой ЛС.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | 10 менеджеров одновременно открывают ЛС для просмотра | Все 10 видят актуальный остаток (просмотр не блокируется) |
| 2 | 3 менеджера начинают создавать Заказы | Первый захватывает блокировку, два других ждут (до 30 сек.) |
| 3 | Первый сохраняет Заказ через 5 минут | Блокировка снимается, второй менеджер получает блокировку |
| 4 | Блокировка не снимается 15 минут (неактивность) | Автоматическое снятие блокировки |
| 5 | После 10 мин. неактивности - предупреждение | "Завершите редактирование или блокировка будет снята" |
| 6 | Администратор принудительно снимает блокировку | Блокировка снята через справочник "Активные блокировки ЛС" |

**Ожидаемый результат:** Блокировка работает корректно при высокой конкуренции; автоматическое снятие через 15 мин.; очередь не превышает 30 секунд ожидания.

---

### TC-EXT-035 (PERF) - Производительность: регламентные задания (ночной пересчет санкций)

**Приоритет:** P2
**Тип:** Производительность
**Требование:** п. 3.13 (ежедневный пересчет санкций), п. 3.18 (санкции)
**Связь с находками:** B4 (нет retry/timeout/мониторинга)

**Предусловия:**
- 500 закрытых ЛС с активными возвратами (< 60 дней);
- Регламентное задание пересчета санкций запускается в 00:00 МСК.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Задание стартует в 00:00 | Обработка 500 ЛС |
| 2 | Задание завершается до 06:00 (до начала рабочего дня) | Все ЛС пересчитаны |
| 3 | Ошибка при обработке ЛС #247 (недоступность БД) | **ПРОБЕЛ (B4):** Нет описания retry |
| 4 | Задание зависло (выполняется > 2 часов) | **ПРОБЕЛ (B4):** Нет описания таймаута |
| 5 | Задание не завершилось к 09:00 | **ПРОБЕЛ (B4):** Нет описания алерта для ФД |
| 6 | Проверить: задание не блокирует работу пользователей | Пользователи работают параллельно без задержек |

**Ожидаемый результат:** Подтверждает B4: нет описания retry, timeout, мониторинга для фонового задания пересчета санкций.

---

### TC-EXT-036 (MANIP) - Атака на таймер автоэскалации: намеренное затягивание

**Приоритет:** P1
**Тип:** Манипулятивный
**Требование:** п. 3.6 - SLA и автоэскалация, п. 3.11 - статус "Просмотрено"
**Связь с находками:** -

**Предусловия:**
- Заказ на согласовании РБЮ, SLA P1 = 4 часа;
- РБЮ хочет отложить решение, но не хочет эскалации.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | РБЮ открывает задачу через 3 ч. 50 мин. (статус "Просмотрено") | Останавливается ли таймер автоэскалации при просмотре? |
| 2 | Если таймер остановлен: РБЮ закрывает задачу без решения | **МАНИПУЛЯЦИЯ:** Таймер сброшен, решение отложено на неопределенный срок |
| 3 | Если таймер НЕ остановлен: через 10 мин. (4ч) эскалация | Корректное поведение - просмотр не сбрасывает таймер |
| 4 | РБЮ сохраняет "черновик ответа" без отправки | Является ли это действием, останавливающим эскалацию? |

**Ожидаемый результат:** Просмотр задачи ("Просмотрено") НЕ останавливает таймер автоэскалации. Только финальное решение (одобрить/отклонить/корректировка) останавливает таймер.

---

### TC-EXT-037 (MANIP) - Манипуляция: злоупотребление исключениями для стратегических клиентов

**Приоритет:** P1
**Тип:** Манипулятивный
**Требование:** п. 3.18 - стратегические клиенты, отмена санкций
**Связь с находками:** UX-APPROVER-008

**Предусловия:**
- Менеджер систематически создает завышенные ЛС для стратегических клиентов;
- ДП регулярно отменяет санкции (3 раза в год на клиента).

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Клиент A: 3 отмены за январь-март | Лимит исчерпан |
| 2 | Менеджер регистрирует новую ЛС на дочернюю компанию клиента A | Система считает дочернюю компанию отдельным контрагентом |
| 3 | ДП отменяет санкцию для дочерней компании | **ПРОБЕЛ:** Нет связи контрагентов "родитель-дочка" для целей лимита |
| 4 | Один ДП обслуживает 50 стратегических клиентов, по 3 отмены | 150 отмен/год - проверить: есть ли агрегированный отчет |
| 5 | Проверить: отчет LS-FR-037 показывает паттерн злоупотреблений | Журнал фиксирует причины, но нет автоматического анализа |

**Ожидаемый результат:** Выявляет потенциальные схемы обхода лимита через связанные компании. Нет автоматического контроля агрегированных отмен.

---

### TC-EXT-038 (MANIP) - Манипуляция с возвратами: "отгрузить для % → вернуть"

**Приоритет:** P1
**Тип:** Манипулятивный
**Требование:** п. 3.18 - учет возвратов в течение 60 дней
**Связь с находками:** -

**Предусловия:**
- ЛС на 100 000 руб., % выкупа без манипуляции = 75% (санкция -3 п.п.);
- Менеджер хочет поднять % выкупа, договорившись с клиентом о фиктивной отгрузке.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Менеджер отгружает дополнительно 20 000 руб. (фиктивно) | % выкупа = 95 000 / 100 000 = 95% |
| 2 | Клиент возвращает 20 000 руб. через 30 дней | Возврат в течение 60 дней → уменьшает % выкупа |
| 3 | Пересчет: % = (95 000 - 20 000) / 100 000 = 75% | Манипуляция не сработала: возврат учтен |
| 4 | Клиент возвращает через 65 дней (> 60) | Возврат НЕ учитывается в формуле: % остается 95% |
| 5 | Проверить: пересчет регламентным заданием (п. 3.13) | Ежедневный ночной пересчет обнаруживает возврат |

**Ожидаемый результат:** Защита от манипуляции через возвраты работает в пределах 60 дней. Возвраты после 60 дней не пересчитываются (потенциальная лазейка для долгосрочных схем).

---

### TC-EXT-039 (STATE) - Переходы статусов ЛС: все допустимые и недопустимые

**Приоритет:** P1
**Тип:** Переходы состояний
**Требование:** п. 3.12 - жизненный цикл ЛС
**Связь с находками:** -

**Предусловия:**
- ЛС в различных статусах.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Активна → Истекла (срок вышел) | Допустимо (автоматически) |
| 2 | Активна → Закрыта (все отгружено) | Допустимо (автоматически при остатке = 0) |
| 3 | Активна → Отменена (0 отгрузок) | Допустимо (менеджер/система) |
| 4 | Истекла → Активна (продление) | Допустимо (менеджер, макс. 2 раза) |
| 5 | Истекла → Закрыта (согласование закрытия) | Допустимо (после согласования) |
| 6 | Закрыта → Активна | **НЕДОПУСТИМО**: закрытая ЛС не может быть переоткрыта |
| 7 | Отменена → Активна | **НЕДОПУСТИМО**: отмененная ЛС не может быть переоткрыта |
| 8 | Активна → Активна (после обработки Заказа) | Допустимо (ЛС остается активной) |
| 9 | Закрыта → Отменена | **НЕДОПУСТИМО**: терминальные состояния не взаимозаменяемы |

**Ожидаемый результат:** Все допустимые переходы работают; все недопустимые переходы блокируются системой.

---

### TC-EXT-040 (STATE) - Переходы статусов Заказа: недопустимые переходы

**Приоритет:** P1
**Тип:** Переходы состояний
**Требование:** п. 3.11 - статусы Заказа клиента
**Связь с находками:** -

**Предусловия:**
- Заказы в различных статусах.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 1 | Черновик → На согласовании | Допустимо (менеджер) |
| 2 | На согласовании → Черновик (отзыв) | Допустимо (менеджер, пока нет решения) |
| 3 | На согласовании → Согласован (одобрение) | Допустимо (согласующий) |
| 4 | На согласовании → Отклонен (отказ) | Допустимо (согласующий) |
| 5 | Согласован → В работе (проведен РТУ) | Допустимо (система при проведении РТУ) |
| 6 | В работе → Согласован | **НЕДОПУСТИМО**: нельзя "вернуть" после проведения РТУ |
| 7 | Исполнен → В работе | **НЕДОПУСТИМО**: полная отгрузка необратима |
| 8 | Отклонен → Согласован (напрямую) | **НЕДОПУСТИМО**: только через Черновик → На согласовании |
| 9 | Просрочен → На согласовании | **НЕДОПУСТИМО**: черновик автоудален |
| 10 | Отменен → Черновик | **НЕДОПУСТИМО**: отмена необратима |
| 11 | Ожидает поступл. → Согласован (напрямую) | **НЕДОПУСТИМО**: обязателен контроль рентабельности (п. 3.17) |

**Ожидаемый результат:** Все допустимые переходы работают; все недопустимые переходы блокируются. Особенно важен п. 11 - прямой переход "Ожидает поступл." → "Согласован" невозможен.

---

## Матрица покрытия разделов ФМ

| Раздел | Тест-кейсы | Покрытие |
|--------|-----------|----------|
| 3.10 (Несколько Заказов по ЛС) | TC-EXT-001, 002, 026, 034 | Полное |
| 3.11 (Жизненный цикл Заказа) | TC-EXT-003, 004, 012, 036, 040 | Полное |
| 3.12 (Жизненный цикл ЛС) | TC-EXT-020, 025, 026, 039 | Полное |
| 3.13 (Изменение ЛС после отгрузки) | TC-EXT-031, 035 | Частичное |
| 3.14 (Возврат товара) | TC-EXT-009, 038 | Частичное |
| 3.15 (Защита от манипулирования) | TC-EXT-017, 018, 019, 031, 034 | Полное |
| 3.16 (Риски реализации) | TC-EXT-033, 034, 036 | Полное |
| 3.17 (Обеспечение наличием) | TC-EXT-021, 022, 032 | Полное |
| 3.18 (Санкции за невыкуп) | TC-EXT-023, 024, 025, 027, 029, 037, 038 | Полное |
| Бизнес-вопросы B5-B9 | TC-EXT-005, 006, 007, 008, 009, 019, 021 | Полное |
| UX-находки (11 шт.) | TC-EXT-005, 010-015, 017, 023, 025, 033 | Полное |

---

## Сводка по типам тестов

### Манипулятивные тесты (5)
- TC-EXT-031: снижение плановой рентабельности ЛС для обхода контроля;
- TC-EXT-032: фиктивная фиксация потребности для избежания санкций;
- TC-EXT-036: атака на таймер автоэскалации через просмотр задачи;
- TC-EXT-037: злоупотребление исключениями для стратегических клиентов;
- TC-EXT-038: "отгрузить для % → вернуть" (обход санкций).

### Тесты производительности (3)
- TC-EXT-033: 100+ согласований/день на РБЮ;
- TC-EXT-034: 10 менеджеров одновременно работают с ЛС;
- TC-EXT-035: ночной пересчет санкций (500 ЛС, retry/timeout).

### Тесты переходов состояний (4)
- TC-EXT-004: 6 триггеров аннулирования согласования;
- TC-EXT-014: эскалация vs прямая задача;
- TC-EXT-039: допустимые/недопустимые переходы ЛС;
- TC-EXT-040: допустимые/недопустимые переходы Заказа.

---

## Выявленные пробелы ФМ (подтвержденные тестами)

| # | Пробел | Тест-кейс | Серьезность |
|---|--------|-----------|------------|
| 1 | Нет эскалации выше ГД при автоотказе | TC-EXT-005 | CRITICAL |
| 2 | Нет описания цикла корректировки цены | TC-EXT-010 | CRITICAL |
| 3 | Конфликт автопродления ЛС и блокировки НПСС > 90 дней | TC-EXT-019 | HIGH |
| 4 | Ручное определение дефицита vs алгоритмическое | TC-EXT-021 | HIGH |
| 5 | Нет правила снижения уровня согласования при улучшении | TC-EXT-007 | HIGH |
| 6 | Нетто или брутто в формуле выручки | TC-EXT-009 | HIGH |
| 7 | Нет retry/timeout для фонового пересчета санкций | TC-EXT-035 | HIGH |
| 8 | Тип часов (рабочие/календарные) для экстренного подтверждения | TC-EXT-015 | MEDIUM |
| 9 | Нет счетчика отмен для ДП | TC-EXT-023 | MEDIUM |
| 10 | Закрытие ЛС и классификация причин - два процесса | TC-EXT-025 | MEDIUM |
| 11 | Противоречие лимитов: 10 (п. 3.10) vs 50 (п. 3.12) | TC-EXT-026 | MEDIUM |
| 12 | Деление на ноль при полном дефиците | TC-EXT-027 | MEDIUM |

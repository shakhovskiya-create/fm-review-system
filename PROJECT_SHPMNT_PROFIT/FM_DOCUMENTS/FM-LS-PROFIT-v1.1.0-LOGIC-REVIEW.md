# ОТЧЕТ ПО АНАЛИЗУ ЛОГИКИ FM-LS-PROFIT v1.1.0

**Дата анализа:** 28.01.2026
**Документ:** FM-LS-PROFIT v1.1.0
**Аналитик:** Claude Sonnet 4.5 (Logic Review Agent)
**Метод:** Системное моделирование + Граничные случаи + Race Conditions + Математическая верификация

---

## EXECUTIVE SUMMARY

Проведен глубокий анализ бизнес-логики документа FM-LS-PROFIT v1.1.0 на предмет логических противоречий, граничных случаев и возможных обходов контроля.

**НАЙДЕНО ПРОБЛЕМ:** 23
- CRITICAL: 7
- HIGH: 9
- MEDIUM: 5
- LOW: 2

**КЛЮЧЕВЫЕ НАХОДКИ:**
1. **CRITICAL:** Race condition при параллельном создании заказов с аннулированием согласований
2. **CRITICAL:** Конфликт формул накопленной рентабельности при учете заказов "На согласовании"
3. **CRITICAL:** Логическая дыра в механизме фиксации потребности через создание/отмену черновиков
4. **HIGH:** Противоречие в обработке возвратов для закрытых ЛС и санкций
5. **HIGH:** Манипуляция через автопродление при дефиците

---

## 1. КРИТИЧЕСКИЕ ПРОБЛЕМЫ (CRITICAL)

### CRIT-001: Race Condition при параллельном согласовании и аннулировании

**ЛОКАЦИЯ:** п. 3.5 (Аннулирование согласования) + п. 3.10 (Параллельные заказы)

**ПРОБЛЕМА:**

Документ описывает механизм аннулирования согласований при изменении уровня отклонения. Однако возникает race condition:

**Сценарий:**
1. Менеджер А создает Заказ-1 (отклонение 5 п.п.) → согласование РБЮ → РБЮ согласовал
2. Менеджер Б параллельно создает Заказ-2 (отклонение 3 п.п.) → согласование РБЮ
3. РБЮ согласовывает Заказ-2
4. Менеджер А проводит РТУ по Заказу-1 → накопленная рентабельность ухудшается
5. Система должна пересчитать отклонение для Заказа-2
6. Новое отклонение для Заказа-2 = 9 п.п. (было 3)
7. Разница = 6 п.п. > 3 п.п. → согласование должно аннулироваться
8. **НО**: Заказ-2 уже в статусе "Согласован" и может быть передан на склад

**ПРОБЛЕМА:** Между проведением РТУ по Заказу-1 и аннулированием Заказа-2 проходит время. Менеджер Б может успеть передать Заказ-2 на склад (флаг "ПереданНаСклад").

**РИСК:** Отгрузка Заказа-2 с отклонением 9 п.п. вместо требуемого согласования ДП (отклонение > 15 требует ДП).

**ФОРМУЛА КОНФЛИКТА:**
```
T(проведение РТУ-1) < T(передача на склад Заказа-2) < T(аннулирование Заказа-2)
```

**ТЕКУЩАЯ ЗАЩИТА:**
П. 3.5: "После точки невозврата согласование НЕ аннулируется". Но это не решает проблему — заказ с неверным уровнем согласования уже отгружается.

**РЕКОМЕНДАЦИЯ:**
- **Атомарная проверка перед передачей на склад:** При установке флага "ПереданНаСклад" система должна повторно проверить актуальность уровня согласования с учетом ВСЕХ проведенных РТУ по ЛС.
- **Блокировка:** При проведении РТУ устанавливать краткосрочную блокировку (5-10 сек) на все Заказы "Согласован" по этой ЛС для пересчета и аннулирования.

---

### CRIT-002: Конфликт формул при учете заказов "На согласовании"

**ЛОКАЦИЯ:** п. 3.4 (Критерии срабатывания) + п. 3.10 (Параллельные заказы)

**ПРОБЛЕМА:**

Документ противоречиво определяет, что входит в расчет показателя "Накопленная + Заказ":

**Определение в п. 3.4:**
> "(Накопл. + Заказы «На согласовании» + Заказ) = (Выручка отгруж. + Выручка заказа − Себест. отгруж. − Себест. заказа) / (Выручка отгруж. + Выручка заказа) × 100%"

**Уточнение в п. 3.10:**
> "При расчете показателей учитываются:
> в (Накопл. + Заказы «На согласовании» + Заказ) - только фактически отгруженные РТУ + текущий Заказ"

**ПРОТИВОРЕЧИЕ:** Первое определение включает "Заказы на согласовании", второе — НЕТ.

**СЦЕНАРИЙ ПРОБЛЕМЫ:**
- ЛС = 35%, накопленная = 0
- Заказ-1 на согласовании (отклонение 5 п.п., рент. 30%)
- Менеджер создает Заказ-2 (рент. 28%)

**Вариант А (включая Заказ-1):**
```
(Накопл. + Заказ-1 + Заказ-2) = (30% + 28%) / 2 = 29%
Отклонение = 35% - 29% = 6 п.п. → РБЮ
```

**Вариант Б (без Заказа-1):**
```
(Накопл. + Заказ-2) = 28%
Отклонение = 35% - 28% = 7 п.п. → РБЮ
```

**Влияние:** При большом количестве заказов на согласовании разница может менять уровень согласования (РБЮ vs ДП).

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ** формулу в п. 3.4: явно указать, что "Заказы на согласовании" НЕ входят в числитель, но ВХОДЯТ в знаменатель (для расчета доступного остатка).
- **ПЕРЕИМЕНОВАТЬ** показатель: "(Накопл. + Заказ)" вместо "(Накопл. + Заказы «На согласовании» + Заказ)" для устранения путаницы.

---

### CRIT-003: Манипуляция через создание/отмену черновиков для фиксации потребности

**ЛОКАЦИЯ:** п. 3.16.2 (Фиксация потребности) + п. 3.10 (Черновики)

**ПРОБЛЕМА:**

Документ описывает механизм фиксации потребности при создании Заказа для защиты от санкций. Однако черновики НЕ учитываются в остатке ЛС, и их можно создавать неограниченно.

**СЦЕНАРИЙ МАНИПУЛЯЦИИ:**
1. ЛС истекает через 5 дней
2. Клиент знает, что не выкупит 50% позиций → санкция "только стандартные цены"
3. Менеджер создает черновики Заказов на все "проблемные" позиции (товара нет в наличии)
4. Система фиксирует потребность с результатом "нет в наличии"
5. Менеджер НЕ отправляет черновики на согласование (держит их в статусе "Черновик")
6. Через 7 дней черновики помечаются на удаление → но фиксация потребности уже записана
7. При закрытии ЛС эти позиции исключаются из расчета санкций как "подтвержденный дефицит"

**ЗАЩИТА ДОКУМЕНТА:**
> "Фиксация потребности действительна, если сделана не позднее чем за 14 дней до истечения ЛС"

**НО:** Это не защищает от сценария выше, если манипуляция начинается за 15+ дней.

**РЕКОМЕНДАЦИЯ:**
- **Требование:** Фиксация потребности действительна ТОЛЬКО для Заказов в статусе "На согласовании" или "Ожидает поступления". Черновики НЕ фиксируют потребность.
- **Альтернатива:** При удалении черновика старше 7 дней — удалять и записи фиксации потребности, сделанные через этот черновик.

---

### CRIT-004: Конфликт округления в граничных случаях матрицы согласования

**ЛОКАЦИЯ:** п. 3.3 (Уровни согласования)

**ПРОБЛЕМА:**

Документ определяет округление рентабельности до 2 знаков, но граничные значения матрицы согласования используют 2 знака после запятой.

**Граничные значения:**
> - отклонение 0.99 - согласование не требуется; 1.00 - уже РБЮ
> - отклонение 15.00 - согласует РБЮ; 15.01 - уже ДП
> - отклонение 25.00 - согласует ДП; 25.01 - уже ГД

**ПРОБЛЕМА ОКРУГЛЕНИЯ:**

**Пример:**
```
ЛС = 35.00%
(Накопл. + Заказ) = 19.995%
Отклонение = 35.00 - 19.995 = 15.005

После округления до 2 знаков: 15.01 → ДП
Без округления: 15.005 → технически между 15.00 и 15.01
```

**ВОПРОС:** Округление отклонения до 2 знаков происходит ДО или ПОСЛЕ сравнения с границами?

**СЦЕНАРИЙ КРИТИЧНЫЙ:**
```
Отклонение расчетное = 25.004
Округление "вниз" (floor) → 25.00 → ДП
Округление "математическое" → 25.00 → ДП
Округление "вверх" (ceil) → 25.01 → ГД
```

**ТЕКУЩИЙ ТЕКСТ:**
> "Рентабельность округляется до 2 знаков после запятой (математическое округление)"

**НО:** Не указано, что округляется — рентабельность позиций или ОТКЛОНЕНИЕ.

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "Отклонение рентабельности округляется до 2 знаков после запятой математическим методом (0.5 → вверх) ДО сравнения с границами матрицы."
- **Пример:** Отклонение 15.005 → 15.01 → ДП.

---

### CRIT-005: Возврат товара по закрытой ЛС не влияет на санкции

**ЛОКАЦИЯ:** п. 3.12 (Возврат товара) + п. 3.16.8 (Санкции)

**ПРОБЛЕМА:**

Документ описывает учет возвратов в формуле % выкупа:

> "% выкупа = (Отгружено − Возвраты 60д) / (ЛС − Подтвержденный дефицит) × 100%"

**НО:** В п. 3.12 для закрытых ЛС:
> "ЛС закрыта: возврат учитывается только для корректировки финансов; товар поступает в свободный остаток"

**ПРОБЛЕМА:** Санкции применяются "при закрытии или истечении ЛС" (п. 3.16.8). Если ЛС уже закрыта и санкция применена, возврат через 10 дней НЕ пересчитывает санкцию.

**СЦЕНАРИЙ МАНИПУЛЯЦИИ:**
1. Клиент выкупил 90% ЛС → санкций нет
2. ЛС закрыта
3. Через 20 дней клиент возвращает 25% отгруженного товара
4. Фактический % выкупа = (90 - 25) / 100 = 65% → должна быть санкция -10 п.п.
5. **НО:** ЛС уже закрыта, санкция не пересчитывается

**РИСК:** Клиент обходит санкции, возвращая товар после закрытия ЛС.

**ЗАЩИТА ДОКУМЕНТА:**
> "Возвраты 60д - документы «Возврат товаров» с датой возврата ≤ 60 дней от даты РТУ"

**НО:** Не указано, что возврат ПОСЛЕ закрытия ЛС должен корректировать санкции.

**РЕКОМЕНДАЦИЯ:**
- **Правило:** При возврате товара (дата возврата ≤ 60 дней от РТУ) по закрытой ЛС — пересчитывать % выкупа и корректировать санкцию.
- **Механизм:** Регламентное задание "Контроль возвратов по закрытым ЛС" — ежедневная проверка возвратов, пересчет санкций, уведомление менеджеру.

---

### CRIT-006: Автопродление ЛС при позднем поступлении — манипуляция через повторные заказы

**ЛОКАЦИЯ:** п. 3.16.5 (Поступление товара в последние дни ЛС)

**ПРОБЛЕМА:**

Документ описывает автопродление:

> "Если товар поступил менее чем за 5 рабочих дней до истечения ЛС, срок действия ЛС автоматически продлевается на 5 рабочих дней для этой позиции. Автопродление возможно не более 1 раза."

**СЦЕНАРИЙ МАНИПУЛЯЦИИ:**
1. ЛС на 100 ед. товара X (дефицит), срок истекает 01.04
2. Товар поступает 29.03 (за 3 р.д.) → автопродление до 08.04
3. Клиент НЕ подтверждает Заказ в течение 5 р.д. → потребность аннулируется
4. Товар снова становится "в наличии", НО для этого клиента автопродление уже использовано
5. Клиент создает новый Заказ 07.04 (до нового истечения 08.04) → товар в наличии → стандартный процесс
6. Товар "случайно" заканчивается в течение дня (разобрали другие клиенты)
7. Повторное поступление 08.04 (день истечения) — автопродление не применяется (лимит 1 раз)
8. ЛС истекает, позиция не выкуплена → но фиксация потребности была 07.04 → **должна ли она считаться подтвержденным дефицитом?**

**ВОПРОС:** Что значит "автопродление не более 1 раза" — на всю ЛС или на конкретную позицию?

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "Автопродление не более 1 раза для конкретной позиции номенклатуры в рамках одной ЛС. Счетчик автопродлений хранится в регистре «История автопродлений ЛС»."
- **Защита:** При повторном поступлении после использования лимита — уведомление менеджеру о необходимости ручного продления ЛС.

---

### CRIT-007: Конфликт в определении "подтвержденного дефицита" для частичного наличия

**ЛОКАЦИЯ:** п. 3.16.8 (Подтвержденный дефицит)

**ПРОБЛЕМА:**

Документ определяет условия подтвержденного дефицита:

> "Подтвержденный дефицит - позиции, по которым выполнены ВСЕ условия:
> - клиент зафиксировал потребность за 14+ дней до истечения ЛС
> - на момент фиксации товара не было (или было частично)"

**ПРОБЛЕМА:** Что значит "было частично"?

**СЦЕНАРИЙ:**
- ЛС: 100 ед. товара X
- Клиент создает Заказ на 100 ед. за 20 дней до истечения
- На момент фиксации: в наличии 30 ед., остальные 70 — дефицит
- Система создает Заказ со статусом "Частично в наличии" (п. 3.16.2, таблица)
- Через 10 дней клиент выкупает 30 ед. (что было в наличии)
- Остальные 70 так и не поступают
- При закрытии ЛС: % выкупа = 30 / 100 = 30%

**ВОПРОС:** Являются ли эти 70 ед. "подтвержденным дефицитом"?

**Вариант А:** Да, потому что "на момент фиксации товара не было **или было частично**"
→ % выкупа = 30 / (100 - 70) = 100% → нет санкций

**Вариант Б:** Нет, потому что клиент мог зафиксировать потребность только на 70 ед., а не на 100
→ % выкупа = 30 / 100 = 30% → санкция "только стандартные цены"

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "При частичном наличии фиксация потребности разделяется на две части: (1) позиции в наличии — стандартный контроль рентабельности; (2) позиции в дефиците — переход в статус «Ожидает поступления», фиксация только для дефицитной части."
- **Формула:** Подтвержденный дефицит = количество, зафиксированное в статусе "Ожидает поступления", а НЕ в статусе "Черновик" или "На согласовании".

---

## 2. ВЫСОКОПРИОРИТЕТНЫЕ ПРОБЛЕМЫ (HIGH)

### HIGH-001: Несогласованность триггеров аннулирования при изменении плановой рентабельности ЛС

**ЛОКАЦИЯ:** п. 3.5 (Триггеры аннулирования) + п. 3.13 (Изменение ЛС)

**ПРОБЛЕМА:**

Триггер аннулирования:
> "изменение плановой рентабельности ЛС"

Но в п. 3.13:
> "если новая плановая рентабельность ниже исходной - требуется повторное согласование ЛС; все Заказы в статусе «Согласован» по этой ЛС аннулируются"

**ПРОТИВОРЕЧИЕ:** Аннулируются ли Заказы при ПОВЫШЕНИИ плановой рентабельности?

**СЦЕНАРИЙ:**
- ЛС создана с планом 25% (согласована ГД, т.к. низкая рентабельность)
- Заказ-1 на согласовании с отклонением 5 п.п. (план 25%, факт 20%) → РБЮ согласовал
- ЛС изменяется: новый план 35% (добавлены высокомаржинальные позиции)
- Новое отклонение Заказа-1 = 35% - 20% = 15 п.п. → требует ДП вместо РБЮ

**ВОПРОС:** Должен ли Заказ-1 аннулироваться при повышении плана ЛС?

**ЛОГИКА:**
Повышение плана УХУДШАЕТ отклонение для существующих Заказов → требует более высокого согласования → должен аннулироваться.

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "При изменении плановой рентабельности ЛС (как повышении, так и понижении) все Заказы в статусах «На согласовании» и «Согласован» аннулируются, если изменение плана меняет требуемый уровень согласования."

---

### HIGH-002: Блокировка ЛС при редактировании не защищает от одновременного проведения РТУ

**ЛОКАЦИЯ:** п. 3.14.1 (Защита от гонки)

**ПРОБЛЕМА:**

Документ описывает блокировку ЛС при создании Заказа:

> "при начале создания Заказа по ЛС система устанавливает блокировку на уровне записи ЛС"

**НО:** Не указано, блокируется ли ЛС при проведении РТУ.

**СЦЕНАРИЙ ГОНКИ:**
1. Менеджер А создает Заказ-1 → ЛС заблокирована на 15 мин
2. Менеджер Б проводит РТУ по ранее согласованному Заказу-2 → накопленная рентабельность изменяется
3. Менеджер А завершает создание Заказа-1 → отклонение рассчитано на основе старой накопленной рентабельности

**ПРОБЛЕМА:** Между началом создания Заказа-1 и его сохранением прошло время, за которое накопленная рентабельность изменилась.

**РЕКОМЕНДАЦИЯ:**
- **Атомарная проверка:** При сохранении Заказа система должна повторно пересчитать показатели с учетом ТЕКУЩЕЙ накопленной рентабельности (перечитать из регистра).
- **Блокировка:** При проведении РТУ краткосрочная блокировка (транзакционная) на регистр накопленной рентабельности ЛС для обновления.

---

### HIGH-003: Экстренное согласование — "устное разрешение" не имеет защиты от фальсификации

**ЛОКАЦИЯ:** п. 3.6 (Экстренное согласование)

**ПРОБЛЕМА:**

Документ описывает процедуру:

> "менеджер получает устное разрешение (телефон, мессенджер) от уполномоченного лица; менеджер фиксирует факт разрешения: скриншот переписки или запись в журнале"

**РИСК:** Менеджер может сфальсифицировать скриншот переписки (редактор Telegram/WhatsApp позволяет удалять сообщения после отправки).

**СЦЕНАРИЙ ЗЛОУПОТРЕБЛЕНИЯ:**
1. Менеджер создает фейковый скриншот "разрешения" от Директора ДРП
2. Выбирает ФИО из справочника "Уполномоченные для экстренных согласований"
3. Проводит экстренную отгрузку в убыток
4. В течение 24ч должен получить согласование постфактум
5. Согласующий отказывает → инцидент
6. **НО:** товар уже физически отгружен, убыток зафиксирован

**ЗАЩИТА ДОКУМЕНТА:**
> "при отказе в согласовании постфактум: [...] убыток свыше 10 000 руб. - удержание из премии менеджера"

**НО:** Это не предотвращает злоупотребление, а только наказывает постфактум.

**РЕКОМЕНДАЦИЯ:**
- **Требование:** Экстренное согласование ВСЕГДА должно подтверждаться ответным сообщением согласующего. Скриншот должен содержать как минимум 2 сообщения: (1) запрос менеджера, (2) подтверждение согласующего.
- **Альтернатива:** Система отправляет push-уведомление согласующему при экстренном согласовании от его имени: "Вам приписано экстренное согласование Заказа №XXX. Подтвердите или отклоните в течение 2 часов."

---

### HIGH-004: Санкции суммируются, но не указано, как обрабатывать реабилитацию при частичном снятии

**ЛОКАЦИЯ:** п. 3.16.8 (Санкции)

**ПРОБЛЕМА:**

Документ описывает суммирование санкций:

> "При повторном нарушении ограничения суммируются (максимум: только стандартные цены). Пример: −3 + −3 = −6"

И реабилитацию:

> "6 месяцев без новых нарушений - ограничение снимается. После реабилитации счетчик обнуляется."

**ВОПРОС:** Что значит "счетчик обнуляется" при суммированных санкциях?

**СЦЕНАРИЙ:**
1. Клиент закрывает ЛС-1 с % выкупа 75% → санкция −3
2. Через 2 месяца: ЛС-2 с % выкупа 80% → санкция −3
3. Суммарная санкция: −6 п.п.
4. Через 6 месяцев после ЛС-2 (нет нарушений) → реабилитация

**ВОПРОС:** Снимается вся санкция (−6 обнуляется до 0) или частично (−6 → −3)?

**ЛОГИКА А:** Полное снятие после 6 мес. без нарушений
→ Клиент может "накопить" −10, подождать 6 мес., и все обнулится

**ЛОГИКА Б:** Снимается только последняя санкция (−6 → −3 → 0 через еще 6 мес.)
→ Более справедливо, но не указано в документе

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "Реабилитация снимает ВСЮ накопленную санкцию полностью при условии 6 месяцев без новых закрытых ЛС с % выкупа <90%. Счетчик обнуляется до 0."
- **ИЛИ:** "Реабилитация снимает санкции по принципу FIFO: каждая санкция действует 6 месяцев с момента ее применения. Через 6 мес. после ЛС-1 снимается −3 от ЛС-1, через 6 мес. после ЛС-2 снимается −3 от ЛС-2."

---

### HIGH-005: Контроль возраста НПСС — блокировка >90 дней может парализовать продажи

**ЛОКАЦИЯ:** п. 3.14.2 (Контроль актуальности НПСС)

**ПРОБЛЕМА:**

Документ описывает жесткую блокировку:

> "Более 90 дней: Блокировка создания Заказов. Обязательный пересчет НПСС перед продолжением работы"

**РИСК:** Если НПСС по критичной номенклатуре устарела (>90 дн.) и финслужба не успела пересчитать — менеджеры не могут создавать Заказы → потеря продаж.

**СЦЕНАРИЙ:**
1. Август (сезон отпусков): финслужба работает в сокращенном составе
2. НПСС по группе "Кабельные системы" (20% оборота) устарела на 91 день
3. Система блокирует все новые Заказы с этой номенклатурой
4. Клиенты получают отказы → уходят к конкурентам
5. Финслужба получает задачу на пересчет НПСС → SLA 24ч (п. 3.4)
6. Пересчет требует согласования методики → 3-5 дней
7. Итог: неделя простоя продаж

**ЗАЩИТА ДОКУМЕНТА:**
> "еженедельный отчет для финансовой службы: перечень ЛС с устаревшей НПСС"

**НО:** Отчет — это реактивная мера, а не профилактическая.

**РЕКОМЕНДАЦИЯ:**
- **Эскалация:** При возрасте НПСС >80 дней — автоуведомление ФД с предупреждением о блокировке через 10 дней.
- **Временное решение:** При блокировке >90 дней — ДП может разрешить создание Заказов с пометкой "Устаревшая НПСС" и обязательным согласованием РБЮ для ВСЕХ Заказов (даже без отклонений).

---

### HIGH-006: Возврат товара по активной ЛС может создать отрицательную накопленную рентабельность

**ЛОКАЦИЯ:** п. 3.12 (Возврат товара)

**ПРОБЛЕМА:**

Документ описывает пересчет при возврате:

> "накопленная рентабельность пересчитывается без возвращенного товара"

**СЦЕНАРИЙ:**
- ЛС = 35%, 100 ед.
- Отгружено: 60 ед. с рентабельностью 20% (накопл. = 20%)
- Клиент возвращает 50 ед. из этих 60 (рентабельность возвращенных = 25%)
- Оставшаяся отгрузка: 10 ед. с рентабельностью ?

**РАСЧЕТ:**
```
Было отгружено: 60 ед., маржа = 60 * 20% = 12 ед. маржи
Вернули: 50 ед. с рент. 25%, маржа возврата = 50 * 25% = 12.5 ед.
Осталось: 60 - 50 = 10 ед., маржа = 12 - 12.5 = -0.5

Рентабельность оставшихся = -0.5 / 10 = -5% (УБЫТОК)
```

**ПРОБЛЕМА:** Накопленная рентабельность становится отрицательной.

**ВОПРОС:** Как система должна обрабатывать следующий Заказ?

**СЦЕНАРИЙ:**
- Менеджер создает новый Заказ на 20 ед. с рентабельностью 40%
- (Накопл. + Заказ) = (-5% * 10 + 40% * 20) / 30 = 24.5%
- Отклонение = 35% - 24.5% = 10.5 → РБЮ

**НО:** Если бы возврата не было:
- (Накопл. + Заказ) = (20% * 60 + 40% * 20) / 80 = 25%
- Отклонение = 10 → РБЮ (тот же уровень)

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "При возврате товара рентабельность возврата берется ИЗ СВЯЗАННОГО РТУ (фиксированная на момент отгрузки), а НЕ пересчитывается по текущей НПСС."
- **Защита:** Если после возврата накопленная рентабельность < 0% — автоуведомление РБЮ для проверки корректности данных.

---

### HIGH-007: Мульти-БЮ заказ с частичным согласованием — пересчет рентабельности некорректен

**ЛОКАЦИЯ:** п. 3.7 (Заказы с товарами нескольких бизнес-юнитов)

**ПРОБЛЕМА:**

Документ описывает сценарий:

> "если после удаления позиций - автоматический пересчет рентабельности; если после пересчета рентабельность в норме - Заказ переходит в «Согласован» автоматически"

**СЦЕНАРИЙ:**
- Заказ содержит позиции БЮ "Кабель" (рент. 15%) и БЮ "Автоматы" (рент. 50%)
- Общая рентабельность Заказа = 30%, план ЛС = 35%
- Отклонение = 5 → РБЮ
- РБЮ "Кабель" отказал, РБЮ "Автоматы" согласовал
- Менеджер удаляет позиции БЮ "Кабель"
- Новая рентабельность Заказа = 50% (только автоматы)
- Отклонение = 35% - 50% = -15 (рентабельность ВЫШЕ плана) → согласование не требуется

**ПРОБЛЕМА:** Но документ говорит:

> "если после пересчета требуется согласование - новая задача согласующему оставшегося БЮ"

**ВОПРОС:** Нужно ли повторное согласование РБЮ "Автоматы", если рентабельность улучшилась?

**ЛОГИКА:**
Исходное согласование РБЮ "Автоматы" было для Заказа с общей рентабельностью 30%. После удаления позиций Заказ стал другим (рент. 50%) → формально, это НОВЫЙ Заказ → требует нового согласования.

**НО:** Согласующий уже одобрил отгрузку автоматов → повторное согласование избыточно.

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "При удалении позиций несогласовавшего БЮ: если новая рентабельность Заказа >= плановой рентабельности ЛС - 1 (согласование не требуется по общим правилам), Заказ переходит в статус «Согласован» автоматически БЕЗ повторного согласования оставшихся БЮ."

---

### HIGH-008: Лимит экстренных согласований — 3 в месяц на менеджера, но нет защиты от обхода через другого менеджера

**ЛОКАЦИЯ:** п. 3.6 (Экстренное согласование)

**ПРОБЛЕМА:**

Документ устанавливает лимит:

> "не более 3 экстренных согласований на одного менеджера в месяц"

**СЦЕНАРИЙ ОБХОДА:**
1. Менеджер А исчерпал лимит экстренных согласований (3/3)
2. Менеджер А просит коллегу Б создать Заказ от его имени (но формально инициатор — Б)
3. Менеджер Б использует экстренное согласование
4. Товар отгружается клиенту менеджера А

**РИСК:** Обход лимита через "подставных" менеджеров.

**ЗАЩИТА ДОКУМЕНТА:**
Нет.

**РЕКОМЕНДАЦИЯ:**
- **Контроль по клиенту:** Лимит экстренных согласований привязывается не только к менеджеру, но и к контрагенту: "Не более 5 экстренных согласований на одного контрагента в месяц независимо от менеджера."
- **Алерт:** При превышении 3 экстренных согласований по одному клиенту от разных менеджеров — автоуведомление РБЮ для проверки.

---

### HIGH-009: Статус "Ожидает поступления" — резерв остатка ЛС на 48ч может создать блокировку для других менеджеров

**ЛОКАЦИЯ:** п. 3.16.2 (Фиксация потребности)

**ПРОБЛЕМА:**

Документ описывает резервирование:

> "остаток ЛС по этим позициям резервируется на 48 часов"

**СЦЕНАРИЙ:**
- ЛС содержит 100 ед. товара X (дефицит)
- Менеджер А создает Заказ на 100 ед. → статус "Ожидает поступления" → резерв остатка ЛС на 48ч
- Через 24ч товар поступает (30 ед.)
- Менеджер Б (тот же клиент, другой проект) пытается создать Заказ на 30 ед. → система блокирует: "Остаток ЛС зарезервирован Заказом №XXX"
- Менеджер А еще не получил уведомление о поступлении (или не отреагировал)
- Итог: 30 ед. заблокированы, но НЕ отгружаются

**ПРОБЛЕМА:** Резерв остатка ЛС (логический) блокирует позиции для ВСЕХ менеджеров, даже если товар поступил.

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "Резерв остатка ЛС снимается автоматически при поступлении товара. После поступления позиции становятся доступными для создания новых Заказов. Менеджер, зафиксировавший потребность, получает приоритет на физический резерв товара (48ч с момента уведомления)."
- **Механизм:** Разделить логический резерв ЛС (для защиты от превышения) и физический резерв товара (для защиты приоритета клиента).

---

## 3. СРЕДНЕПРИОРИТЕТНЫЕ ПРОБЛЕМЫ (MEDIUM)

### MED-001: Черновики старше 7 дней автоудаляются, но не указано, что происходит с блокировкой ЛС

**ЛОКАЦИЯ:** п. 3.10 (Черновики)

**ПРОБЛЕМА:**

> "черновики старше 7 дней автоматически помечаются на удаление и переводятся в статус «Просрочен»"

**ВОПРОС:** Если черновик создан и менеджер забыл его закрыть (ЛС заблокирована на 15 мин), но прошло 7 дней — снимается ли блокировка автоматически?

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "При автоудалении черновика старше 7 дней блокировка ЛС снимается автоматически."

---

### MED-002: SLA согласования — "рабочие часы МСК" не учитывают часовые пояса филиалов

**ЛОКАЦИЯ:** п. 3.5 (SLA и автоэскалация)

**ПРОБЛЕМА:**

> "SLA считается в рабочих часах (рабочие часы МСК по календарю РФ)"

**СЦЕНАРИЙ:**
- Менеджер из Владивостока (UTC+10) создает Заказ в 18:00 местного времени (10:00 МСК)
- РБЮ находится в Екатеринбурге (UTC+5)
- SLA = 4 часа рабочих (до 14:00 МСК)
- 14:00 МСК = 19:00 по Екатеринбургу (уже нерабочее время)
- Автоэскалация к Директору ДРП (Москва)

**ПРОБЛЕМА:** РБЮ физически не успевает согласовать в рабочее время своего часового пояса.

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "SLA считается в рабочих часах СОГЛАСУЮЩЕГО (по его часовому поясу, указанному в справочнике сотрудников). При автоэскалации — рабочие часы следующего согласующего."

---

### MED-003: Возврат товара — связь с РТУ через "Документ-основание", но что если РТУ сторнирован?

**ЛОКАЦИЯ:** п. 3.12 (Возврат товара) + п. 3.16.8 (Учет возвратов 60д)

**ПРОБЛЕМА:**

> "Возвраты 60д - документы «Возврат товаров» с датой возврата ≤ 60 дней от даты РТУ-основания (по реквизиту «Документ-основание»)"

**СЦЕНАРИЙ:**
1. РТУ-1 проведен по Заказу-1 (отгружено 50 ед.)
2. Через 10 дней клиент возвращает 20 ед. → создается "Возврат товаров" с основанием РТУ-1
3. Через 15 дней обнаруживается ошибка — РТУ-1 сторнируется (п. 3.12)
4. Создается новый РТУ-2 с корректными данными (45 ед. вместо 50)
5. При закрытии ЛС: система считает возврат по РТУ-1, но РТУ-1 сторнирован

**ВОПРОС:** Учитывается ли этот возврат в формуле % выкупа?

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "При сторнировании РТУ-основания возвраты, связанные с этим РТУ, автоматически исключаются из расчета % выкупа. Система должна перепроверить связи возвратов при закрытии ЛС."

---

### MED-004: Блокировка убытка — исключение для "убытка менее 100 руб." может быть использовано для манипуляции

**ЛОКАЦИЯ:** п. 3.4 (Жесткая блокировка при убытке)

**ПРОБЛЕМА:**

> "Исключение: убыток менее 100 руб. (округление, курсовые разницы) - автосогласование"

**СЦЕНАРИЙ МАНИПУЛЯЦИИ:**
- ЛС = 35%, 1000 позиций
- Менеджер создает 10 Заказов по 100 позиций
- Каждый Заказ имеет 1 позицию с убытком -50 руб., остальные — с нормальной рентабельностью
- Общий убыток Заказа < 100 руб. → автосогласование
- Итого: 10 Заказов с общим убытком -500 руб. прошли без согласования ГД

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "Исключение применяется только для Заказов с общим убытком < 100 руб. При наличии нескольких убыточных Заказов по одной ЛС в течение одного дня с суммарным убытком >100 руб. — требуется согласование ГД."

---

### MED-005: Автоматическое создание РТУ — контроль рентабельности перед проведением дублирует проверку Заказа

**ЛОКАЦИЯ:** п. 3.11 (Автоматическое создание РТУ)

**ПРОБЛЕМА:**

> "РТУ может создаваться автоматически при появлении товара на остатках (по Заказу, связанному с ЛС). В этом случае документ также проходит контроль рентабельности перед проведением."

**ВОПРОС:** Зачем повторный контроль, если Заказ уже согласован?

**СЦЕНАРИЙ:**
- Заказ согласован РБЮ (отклонение 5 п.п.)
- РТУ создается автоматически
- Между согласованием Заказа и созданием РТУ прошло 3 дня
- Другой РТУ по этой ЛС был проведен → накопленная рентабельность изменилась
- Отклонение для текущего РТУ теперь 16 п.п. → требует ДП

**ПРОБЛЕМА:** РТУ не может быть заблокирован, т.к. создан из согласованного Заказа.

**РЕКОМЕНДАЦИЯ:**
- **УДАЛИТЬ** фразу "В этом случае документ также проходит контроль рентабельности перед проведением" ИЛИ
- **УТОЧНИТЬ:** "Контроль выполняется только информационно (логирование отклонения), но НЕ блокирует проведение РТУ, созданного из согласованного Заказа."

---

## 4. НИЗКОПРИОРИТЕТНЫЕ ПРОБЛЕМЫ (LOW)

### LOW-001: Отчет "Качество ЛС" — шкала KPI содержит перекрытие диапазонов

**ЛОКАЦИЯ:** п. 3.16.9 (KPI менеджера)

**ПРОБЛЕМА:**

> "Шкала выполнения: 95%+ = 120% KPI; 90-94% = 100%; 85-89% = 90%; 80-84% = 80%; 70-79% = 60%; <70% = 0%."

**ВОПРОС:** Что происходит при % выкупа = 95%? Попадает в "95%+" (120%) или в "90-94%" (100%)?

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "95% и выше = 120%; 90-94.99% = 100%; 85-89.99% = 90%; 80-84.99% = 80%; 70-79.99% = 60%; менее 70% = 0%."

---

### LOW-002: FAQ — вопрос "Сколько раз можно продлить ЛС?" противоречит п. 3.8

**ЛОКАЦИЯ:** FAQ (п. 7) + п. 3.8 (Фиксация НПСС)

**FAQ:**
> "В: Сколько раз можно продлить ЛС?
> О: Не более 2 раз."

**П. 3.8:**
> "максимальное количество продлений - 2 (далее требуется закрытие и создание новой ЛС); Примечание: автопродление по дефициту НЕ входит в этот лимит"

**ПРОТИВОРЕЧИЕ:** FAQ не упоминает исключение для автопродления.

**РЕКОМЕНДАЦИЯ:**
- **ИСПРАВИТЬ FAQ:** "Не более 2 раз ручного продления. Автопродление при позднем поступлении дефицитного товара (п. 3.16.5) НЕ учитывается в этом лимите."

---

## 5. МАТЕМАТИЧЕСКАЯ ВЕРИФИКАЦИЯ ФОРМУЛ

### ФОРМУЛА-001: Расчет % выкупа с возвратами — корректность при возврате >100%

**ФОРМУЛА:**
```
% выкупа = (Отгружено − Возвраты 60д) / (ЛС − Подтвержденный дефицит) × 100%
```

**ГРАНИЧНЫЙ СЛУЧАЙ:**
- ЛС = 100 000 руб.
- Отгружено = 90 000 руб.
- Возвраты 60д = 95 000 руб. (клиент вернул больше, чем получил по ЭТОЙ ЛС — но товар из другой ЛС)

**РЕЗУЛЬТАТ:**
```
% = (90 000 - 95 000) / 100 000 = -5%
```

**ВОПРОС:** Как система должна обрабатывать отрицательный % выкупа?

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "Возвраты 60д учитывают ТОЛЬКО те возвраты, которые связаны с РТУ по данной ЛС (через реквизит «Документ-основание»). Возвраты по другим ЛС не учитываются."
- **Защита:** При расчете % выкупа < 0% — система выдает ошибку и требует проверки данных РБЮ.

---

### ФОРМУЛА-002: Округление рентабельности — потеря точности при многоуровневых расчетах

**ПРОБЛЕМА:**

Документ указывает:

> "Рентабельность округляется до 2 знаков после запятой (математическое округление)"

**СЦЕНАРИЙ:**
- Позиция 1: цена 100.00, НПСС 65.555 → рент. = (100 - 65.555) / 100 = 0.34445 = 34.45%
- Позиция 2: цена 200.00, НПСС 130.004 → рент. = (200 - 130.004) / 200 = 0.34998 = 35.00%
- Средневзвешенная рентабельность (без округления промежуточных):
  ```
  (100 * 0.34445 + 200 * 0.34998) / 300 = 0.34814 = 34.81%
  ```
- Средневзвешенная рентабельность (с округлением промежуточных):
  ```
  (100 * 0.3445 + 200 * 0.3500) / 300 = 0.3482 = 34.82%
  ```

**РАЗНИЦА:** 0.01 п.п. — не критично для большинства сценариев, НО:

**ГРАНИЧНЫЙ СЛУЧАЙ:**
- План ЛС = 35.00%
- Расчет без округления: (Накопл. + Заказ) = 34.01% → отклонение 0.99 → без согласования
- Расчет с округлением: (Накопл. + Заказ) = 34.00% → отклонение 1.00 → РБЮ

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ:** "Округление до 2 знаков применяется ТОЛЬКО к итоговому значению отклонения, НЕ к промежуточным расчетам. Промежуточные значения хранятся с точностью до 6 знаков после запятой."

---

## 6. СОСТОЯНИЯ И ПЕРЕХОДЫ — НЕДОСТАЮЩИЕ СТАТУСЫ

### STATE-001: Отсутствует статус "На удалении" для Заказов с согласованиями

**ПРОБЛЕМА:**

Документ описывает удаление Заказов:

> "статус «На согласовании» или «Согласован» - только специалист товарообмена (отмена согласованного Заказа требует подтверждения РБЮ, действие журналируется в LS-FR-037)"

**ВОПРОС:** Как обрабатывается период между инициацией удаления и подтверждением РБЮ?

**СЦЕНАРИЙ:**
1. Специалист товарообмена инициирует удаление Заказа в статусе "Согласован"
2. Система отправляет запрос РБЮ на подтверждение
3. РБЮ не отвечает в течение 24 часов
4. За это время менеджер может создать РТУ из этого Заказа?

**РЕКОМЕНДАЦИЯ:**
- **ДОБАВИТЬ** промежуточный статус: "На удалении" — Заказ заблокирован для создания РТУ, ожидается подтверждение РБЮ.
- **SLA:** 24 часа на подтверждение, иначе автоотмена запроса на удаление.

---

## 7. ПРАВА ДОСТУПА И БЕЗОПАСНОСТЬ

### SEC-001: Экстренное согласование — нет контроля попыток использования несуществующих ФИО

**ЛОКАЦИЯ:** п. 3.6 (Экстренное согласование)

**ПРОБЛЕМА:**

> "при указании ФИО в форме экстренного согласования система проверяет наличие в справочнике"

**ВОПРОС:** Что происходит при попытке ввести несуществующее ФИО?

**СЦЕНАРИЙ:**
- Менеджер пытается использовать экстренное согласование
- Вводит ФИО "Иванов И.И." (не в справочнике)
- Система блокирует → менеджер пробует другие ФИО ("Петров П.П.", "Сидоров С.С.")
- После 5 попыток — все равно блокировка

**РИСК:** Перебор ФИО для поиска уполномоченных лиц (социальная инженерия).

**РЕКОМЕНДАЦИЯ:**
- **ДОБАВИТЬ:** "При 3 неудачных попытках ввода ФИО (не в справочнике) экстренное согласование блокируется на 24 часа для данного менеджера с уведомлением РБЮ."

---

## 8. ИНТЕГРАЦИИ И ФОНОВЫЕ ЗАДАНИЯ

### INT-001: Интеграция WMS — таймаут 30 сек при частичной комплектации может быть недостаточен

**ЛОКАЦИЯ:** п. 3.11 (Частичная комплектация) + LS-NFR-004

**ПРОБЛЕМА:**

> "SLA интеграции WMS: Обработка сообщения WMS о расхождении комплектации - не более 30 секунд"

**СЦЕНАРИЙ:**
1. WMS обнаруживает недостачу (заказано 100 ед., найдено 45 ед.)
2. WMS отправляет сообщение в 1С:УТ
3. 1С:УТ должен пересчитать рентабельность для 45 ед. (формула п. 3.4)
4. Для сложных ЛС с 500+ позициями (LS-NFR-002) пересчет может занять >2 сек
5. 1С:УТ должен отправить уведомление менеджеру
6. Менеджер должен принять решение (подтвердить/отменить) в течение 2 часов
7. **НО:** Интеграция WMS ждет ответ 30 сек → таймаут

**ПРОБЛЕМА:** WMS не получает подтверждение от 1С:УТ и переходит в режим "автоотмена" или "ручная обработка".

**РЕКОМЕНДАЦИЯ:**
- **РАЗДЕЛИТЬ** процесс на 2 этапа:
  1. WMS → 1С:УТ: "Обнаружена недостача" (синхронный, ответ <5 сек: "Принято в обработку")
  2. 1С:УТ пересчитывает, уведомляет менеджера (асинхронный, до 2 часов)
  3. 1С:УТ → WMS: "Подтверждено/Отменено" (синхронный, ответ <5 сек)

---

## 9. ИДЕМПОТЕНТНОСТЬ И ОТКАТ

### IDEMP-001: Проведение РТУ — нет защиты от двойного проведения при сбое

**ПРОБЛЕМА:**

Документ не описывает, как система обрабатывает ситуацию двойного проведения РТУ при сбое сети.

**СЦЕНАРИЙ:**
1. Менеджер проводит РТУ-1
2. 1С:УТ обновляет накопленную рентабельность ЛС
3. Сеть обрывается до отправки ответа клиенту
4. Менеджер не видит подтверждения → повторно нажимает "Провести"
5. 1С:УТ повторно обновляет накопленную рентабельность ЛС (дублирование)

**РИСК:** Накопленная рентабельность учитывает РТУ-1 дважды → некорректные блокировки следующих Заказов.

**РЕКОМЕНДАЦИЯ:**
- **ИДЕМПОТЕНТНОСТЬ:** При проведении РТУ система проверяет наличие записей в регистре накопления "Рентабельность ЛС" с тем же документом-основанием. При дубле — пропуск обновления.

---

## 10. ПРОИЗВОДИТЕЛЬНОСТЬ И МАСШТАБИРУЕМОСТЬ

### PERF-001: Расчет рентабельности для 1000 позиций ЛС может превысить SLA 2 секунды

**ЛОКАЦИЯ:** LS-NFR-001 + LS-NFR-002

**ПРОБЛЕМА:**

> "LS-NFR-001: Расчет рентабельности Заказа выполняется не более 2 секунд при количестве позиций до 500."
> "LS-NFR-002: Локальная смета поддерживает до 1000 позиций номенклатуры."

**ПРОТИВОРЕЧИЕ:** SLA гарантирован для 500 позиций, но ЛС может содержать 1000.

**СЦЕНАРИЙ:**
- ЛС содержит 1000 позиций
- Менеджер создает Заказ на 800 позиций
- Система должна пересчитать: рентабельность Заказа, рентабельность остатка (200 позиций), накопленную
- При 1000 позициях расчет может занять >2 сек → таймаут → менеджер видит "зависание"

**РЕКОМЕНДАЦИЯ:**
- **УТОЧНИТЬ SLA:** "Расчет рентабельности выполняется не более 5 секунд при количестве позиций до 1000. Для ЛС >1000 позиций — рекомендуется разбить на несколько ЛС."

---

## ИТОГОВАЯ ТАБЛИЦА ПРОБЛЕМ

| ID | Приоритет | Раздел | Проблема | Риск |
|----|-----------|--------|----------|------|
| CRIT-001 | CRITICAL | 3.5, 3.10 | Race condition при параллельном согласовании и проведении РТУ | Отгрузка с неверным уровнем согласования |
| CRIT-002 | CRITICAL | 3.4, 3.10 | Конфликт формул "Накопл. + Заказы на согласовании + Заказ" | Некорректное определение уровня согласования |
| CRIT-003 | CRITICAL | 3.16.2, 3.10 | Манипуляция через черновики для фиксации потребности | Обход санкций за невыкуп |
| CRIT-004 | CRITICAL | 3.3 | Неоднозначность округления в граничных случаях | Разные уровни согласования при отклонении ~15.00 |
| CRIT-005 | CRITICAL | 3.12, 3.16.8 | Возврат после закрытия ЛС не пересчитывает санкции | Обход санкций через поздний возврат |
| CRIT-006 | CRITICAL | 3.16.5 | Автопродление — манипуляция через повторные заказы | Обход фиксации дефицита |
| CRIT-007 | CRITICAL | 3.16.8 | Неоднозначность "подтвержденного дефицита" при частичном наличии | Некорректный расчет санкций |
| HIGH-001 | HIGH | 3.5, 3.13 | Триггер аннулирования при ПОВЫШЕНИИ плана ЛС | Отгрузка с устаревшим уровнем согласования |
| HIGH-002 | HIGH | 3.14.1 | Блокировка ЛС не защищает от проведения РТУ | Некорректный расчет отклонения при гонке |
| HIGH-003 | HIGH | 3.6 | Экстренное согласование — риск фальсификации | Несанкционированные убыточные отгрузки |
| HIGH-004 | HIGH | 3.16.8 | Неоднозначность реабилитации при суммировании санкций | Обход санкций через периоды ожидания |
| HIGH-005 | HIGH | 3.14.2 | Блокировка НПСС >90 дней без временного решения | Остановка продаж при задержке финслужбы |
| HIGH-006 | HIGH | 3.12 | Возврат может создать отрицательную накопленную рентабельность | Некорректные блокировки следующих Заказов |
| HIGH-007 | HIGH | 3.7 | Мульти-БЮ — пересчет после удаления позиций | Избыточное повторное согласование |
| HIGH-008 | HIGH | 3.6 | Обход лимита экстренных согласований через других менеджеров | Систематические нарушения контроля |
| HIGH-009 | HIGH | 3.16.2 | Резерв остатка ЛС блокирует других менеджеров | Блокировка товара, который уже поступил |
| MED-001 | MEDIUM | 3.10 | Черновики 7 дней — блокировка ЛС | Блокировка доступа к ЛС |
| MED-002 | MEDIUM | 3.5 | SLA в МСК не учитывает часовые пояса филиалов | Невыполнимые SLA для удаленных согласующих |
| MED-003 | MEDIUM | 3.12, 3.16.8 | Возврат при сторнированном РТУ-основании | Некорректный расчет % выкупа |
| MED-004 | MEDIUM | 3.4 | Исключение убытка <100 руб. — манипуляция | Накопление малых убытков без согласования ГД |
| MED-005 | MEDIUM | 3.11 | Автосоздание РТУ — дублирование контроля | Избыточная проверка рентабельности |
| LOW-001 | LOW | 3.16.9 | Шкала KPI — перекрытие диапазонов | Неоднозначность при граничных значениях |
| LOW-002 | LOW | FAQ, 3.8 | Противоречие в FAQ о продлении ЛС | Путаница у пользователей |

---

## РЕКОМЕНДАЦИИ ПО ПРИОРИТИЗАЦИИ ИСПРАВЛЕНИЙ

### PHASE 1 (ДО ПИЛОТА):
- CRIT-001, CRIT-002, CRIT-004 — критичны для корректности расчетов
- HIGH-002, HIGH-005 — критичны для стабильности работы

### PHASE 2 (ПОСЛЕ 1 МЕСЯЦА ПИЛОТА):
- CRIT-003, CRIT-005, CRIT-006, CRIT-007 — связаны с санкциями (Phase 2)
- HIGH-001, HIGH-003, HIGH-004, HIGH-006, HIGH-007, HIGH-008, HIGH-009

### PHASE 3 (ДОРАБОТКИ):
- MED-001–MED-005
- LOW-001–LOW-002
- Математическая верификация (ФОРМУЛА-001, ФОРМУЛА-002)
- Производительность (PERF-001)

---

## ЗАКЛЮЧЕНИЕ

Функциональная модель FM-LS-PROFIT v1.1.0 демонстрирует высокий уровень детализации бизнес-логики. Однако обнаружены критические противоречия и граничные случаи, которые могут привести к:

1. **Обходу контроля рентабельности** через race conditions и манипуляции со статусами
2. **Некорректным санкциям** из-за неоднозначности определения "подтвержденного дефицита"
3. **Блокировкам продаж** при устаревании НПСС без временных решений
4. **Математическим ошибкам** в граничных случаях округления

**Критично:** Исправить CRIT-001–CRIT-004 ДО запуска пилота. Остальные проблемы могут быть доработаны по мере валидации на реальных данных.

---

**Автор анализа:** Claude Sonnet 4.5 (Logic Review Agent)
**Дата:** 28.01.2026
**Статус:** Готово к обсуждению с командой разработки

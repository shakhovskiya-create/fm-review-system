#!/bin/bash

# AGENT_1 ARCHITECT — Интерактивный лаунчер
# Запуск: ./agent1_audit.sh [путь_к_ФМ.docx]

set -e

# Цвета
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

echo ""
echo -e "${YELLOW}═══════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}  AGENT_1: АРХИТЕКТОР — Аудит функциональной модели${NC}"
echo -e "${YELLOW}═══════════════════════════════════════════════════════════${NC}"
echo ""

# ШАГ 1: Приоритет
PRIORITY=$(gum choose --header "? Что в приоритете для этого процесса?" \
    "1. Скорость — не тормозить продажи" \
    "2. Баланс скорости и контроля ⭐ рекомендуется" \
    "3. Контроль — максимальная защита" \
    "4. Другое")

if [[ "$PRIORITY" == "4. Другое" ]]; then
    PRIORITY=$(gum input --placeholder "Введите свой вариант...")
fi

echo -e "${GREEN}✓ Приоритет: ${PRIORITY}${NC}"
echo ""

# ШАГ 2: Красные линии
REDLINE=$(gum choose --header "? Что точно НЕЛЬЗЯ замедлять?" \
    "1. Создание/проведение заказов" \
    "2. Отгрузку товара ⭐ рекомендуется" \
    "3. Согласование цен/скидок" \
    "4. Другое")

if [[ "$REDLINE" == "4. Другое" ]]; then
    REDLINE=$(gum input --placeholder "Введите свой вариант...")
fi

echo -e "${GREEN}✓ Красная линия: ${REDLINE}${NC}"
echo ""

# ШАГ 3: Манипуляции
MANIPULATIONS=$(gum choose --header "? Какие манипуляции/обходы уже были?" \
    "1. Изменение скидок/цен после согласования" \
    "2. Отгрузка без оплаты/превышение лимита ⭐ частая проблема" \
    "3. Изменение документов задним числом" \
    "4. Не было / не знаю" \
    "5. Другое")

if [[ "$MANIPULATIONS" == "5. Другое" ]]; then
    MANIPULATIONS=$(gum input --placeholder "Опишите манипуляции...")
fi

echo -e "${GREEN}✓ Манипуляции: ${MANIPULATIONS}${NC}"
echo ""

# ШАГ 4: BPMN
BPMN=$(gum choose --header "? Есть ли BPMN-схема к этой ФМ?" \
    "1. Да, приложена" \
    "2. Нет, только ФМ ⭐ типичный случай" \
    "3. Есть отдельно, могу прислать")

echo -e "${GREEN}✓ BPMN: ${BPMN}${NC}"
echo ""

# ШАГ 5: Фокус проверки
FOCUS=$(gum choose --header "? На чём сфокусировать проверку?" \
    "1. Полный аудит (все секции) ⭐ рекомендуется" \
    "2. Только логика и противоречия" \
    "3. Только 1С-специфика (блокировки, права, проведение)" \
    "4. Только манипуляции и обходы" \
    "5. Конкретный раздел")

if [[ "$FOCUS" == "5. Конкретный раздел" ]]; then
    FOCUS=$(gum input --placeholder "Какой раздел?")
fi

echo -e "${GREEN}✓ Фокус: ${FOCUS}${NC}"
echo ""

# Формируем контекст
CONTEXT="КОНТЕКСТ ИНТЕРВЬЮ:
- Приоритет: ${PRIORITY}
- Красная линия: ${REDLINE}
- Манипуляции: ${MANIPULATIONS}
- BPMN: ${BPMN}
- Фокус проверки: ${FOCUS}"

echo -e "${YELLOW}═══════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Интервью завершено. Контекст собран.${NC}"
echo -e "${YELLOW}═══════════════════════════════════════════════════════════${NC}"
echo ""

# Сохраняем контекст в файл
CONTEXT_FILE="/Users/antonsahovskii/Documents/claude-agents/fm-review-system/.interview_context.txt"
echo "$CONTEXT" > "$CONTEXT_FILE"

echo "Контекст сохранён в: $CONTEXT_FILE"
echo ""
echo "Теперь в Claude Code напиши:"
echo -e "${YELLOW}  /audit${NC}"
echo ""
echo "Агент прочитает контекст автоматически."

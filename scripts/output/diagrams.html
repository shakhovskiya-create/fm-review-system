<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BPMN Процессы - FM-LS-PROFIT v1.0</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;display:flex;height:100vh;background:#f1f5f9;color:#1e293b}

/* Sidebar */
#sidebar{width:280px;min-width:280px;background:#1e293b;color:#e2e8f0;overflow-y:auto;padding:20px 0;flex-shrink:0}
#sidebar h2{padding:0 20px;font-size:14px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px}
#sidebar .ver{padding:0 20px;font-size:12px;color:#64748b;margin:4px 0 16px}
#sidebar ul{list-style:none}
#sidebar li{padding:10px 20px;cursor:pointer;font-size:13px;border-left:3px solid transparent;transition:all .15s}
#sidebar li:hover{background:#334155}
#sidebar li.active{background:#334155;border-left-color:#3b82f6;color:#fff}
#sidebar li .n{color:#64748b;font-size:11px;display:block}

/* Main */
#main{flex:1;overflow:auto;padding:32px}
#header{margin-bottom:8px}
#title{font-size:22px;font-weight:700;color:#1e293b}
#desc{font-size:14px;color:#64748b;margin-top:4px}

/* Breadcrumb */
#breadcrumb{margin-bottom:16px;min-height:28px}
.bc-link{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;font-size:12px;font-weight:600;color:#1d4ed8;cursor:pointer;transition:all .15s}
.bc-link:hover{background:#dbeafe}

/* Stats */
.stats{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.stat{padding:6px 14px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;font-size:12px}
.stat b{color:#1e293b}
.stat span{color:#64748b}

/* Lanes */
.lanes-section{margin-bottom:16px}
.lanes-section h3{font-size:13px;font-weight:600;color:#475569;margin-bottom:6px}
.lane-chips{display:flex;gap:6px;flex-wrap:wrap}
.lane-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;border-radius:16px;font-size:12px;font-weight:500;border:1px solid}

/* Flow table */
.flow-card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06),0 8px 24px rgba(0,0,0,.04)}
.flow-table{width:100%;border-collapse:collapse;font-size:13px}
.flow-table thead{background:#f8fafc;position:sticky;top:0;z-index:1}
.flow-table th{padding:8px 12px;text-align:left;font-weight:600;color:#475569;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid #e2e8f0}
.flow-table td{padding:8px 12px;border-bottom:1px solid #f1f5f9;vertical-align:top}
.flow-table tr:last-child td{border-bottom:none}
.flow-table tbody tr{transition:background .15s}
.flow-table tbody tr:hover{background:#f8fafc}

/* Row highlight animation */
.flow-table tbody tr.highlight{animation:flash .8s ease-out}
@keyframes flash{0%{background:#fef08a}50%{background:#fef9c3}100%{background:transparent}}

/* Row type markers (left border) */
.row-start td:first-child{border-left:3px solid #16a34a}
.row-end td:first-child{border-left:3px solid #16a34a}
.row-end-err td:first-child{border-left:3px solid #dc2626}
.row-task td:first-child{border-left:3px solid #3b82f6}
.row-task-err td:first-child{border-left:3px solid #dc2626}
.row-subprocess td:first-child{border-left:3px solid #7c3aed}
.row-gateway td:first-child{border-left:3px solid #d97706}

/* Type icons */
.type-icon{font-size:15px;display:inline-block;width:20px;text-align:center}
.ti-start{color:#16a34a}
.ti-end{color:#16a34a}
.ti-end-err{color:#dc2626}
.ti-task{color:#3b82f6}
.ti-task-err{color:#dc2626}
.ti-subprocess{color:#7c3aed}
.ti-gateway{color:#d97706}

/* Type label (small) */
.type-label{font-size:10px;color:#94a3b8;display:block;margin-top:1px}

/* Lane tag */
.lane-tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500;white-space:nowrap}

/* Clickable elements */
.click-node{color:#1e293b;text-decoration:none;cursor:pointer;border-bottom:1px dashed #cbd5e1;transition:all .15s}
.click-node:hover{color:#2563eb;border-bottom-color:#2563eb}
.click-ref{color:#7c3aed;font-weight:600;cursor:pointer;text-decoration:none;border-bottom:1px dashed #a78bfa;transition:all .15s;white-space:nowrap}
.click-ref:hover{color:#5b21b6;border-bottom-color:#5b21b6}

/* Transitions */
.transitions{display:flex;flex-direction:column;gap:2px}
.trans{display:flex;align-items:baseline;gap:4px;font-size:12px;line-height:1.5}
.trans-arrow{color:#94a3b8;flex-shrink:0;font-size:13px}
.trans-back{color:#dc2626}
.trans-cond{font-size:10.5px;padding:1px 6px;border-radius:8px;font-weight:600;white-space:nowrap}
.cond-green{background:#dcfce7;color:#166534}
.cond-red{background:#fef2f2;color:#991b1b}
.cond-amber{background:#fef3c7;color:#92400e}
.cond-gray{background:#f1f5f9;color:#475569}

/* Step number */
.step-num{font-weight:700;color:#cbd5e1;font-size:13px;text-align:center;width:32px;min-width:32px}

/* Element name */
.el-name{font-weight:500}
.el-name-err{font-weight:600;color:#dc2626}
.el-name-sub{font-weight:500;color:#1e293b}

/* Notes */
.note-box{margin-top:14px;display:flex;align-items:flex-start;gap:8px;background:#fffbeb;border:1px solid #fde68a;border-left:3px solid #f59e0b;padding:10px 14px;border-radius:0 8px 8px 0;font-size:13px;color:#78350f;max-width:600px}
.note-box b{color:#d97706;flex-shrink:0}

/* Orphan/issue section */
.issues-section{margin-top:14px;padding:10px 14px;background:#fef2f2;border:1px solid #fecaca;border-left:3px solid #dc2626;border-radius:0 8px 8px 0;font-size:12px;color:#991b1b}
.issues-section h4{font-size:12px;font-weight:600;margin-bottom:6px}
.issue-item{padding:2px 0;display:flex;align-items:center;gap:6px}
.bg-process-section{margin-top:14px;padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px}
.bg-process-section h4{font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px}

/* Audit badge */
.audit-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;margin-left:6px}
.audit-ok{background:#dcfce7;color:#166534}
.audit-warn{background:#fef3c7;color:#92400e}
.audit-fix{background:#eff6ff;color:#1e40af}
</style>
</head>
<body>
<div id="sidebar">
<h2>BPMN Процессы</h2>
<div class="ver">FM-LS-PROFIT v1.0</div>
<ul id="nav"></ul>
</div>
<div id="main">
<div id="header"><div id="title"></div><div id="desc"></div></div>
<div id="breadcrumb"></div>
<div id="content"></div>
</div>

<script>
// ===== PROCESS DATA (audited & fixed) =====
const P=[
// BPMN 0 — FIX: added edges for sub_emergency (orphan) and sub_return (disconnected)
{num:0,name:'Общая схема контроля рентабельности',
 diagramName:'BPMN 0: Общая схема контроля рентабельности ЛС',
 description:'Обзорная диаграмма всех процессов контроля рентабельности при отгрузках по ЛС',
 lanes:[
  {id:'manager',name:'Менеджер',color:'#dae8fc'},
  {id:'system',name:'1С:УТ',color:'#d5e8d4'},
  {id:'approver',name:'Согласующие (РБЮ / ДП / ГД)',color:'#ffe6cc'},
  {id:'wms',name:'WMS / Склад',color:'#d5e8d4'}
 ],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'manager'},
  {id:'t1',type:'task',label:'Создание ЛС\n(фиксация НПСС)',lane:'manager'},
  {id:'t2',type:'task',label:'Создание Заказа\nпо ЛС',lane:'manager'},
  {id:'sub_npss',type:'subprocess',label:'Контроль\nвозраста НПСС\n(см. BPMN 9)',lane:'system'},
  {id:'x1',type:'gateway',label:'X',lane:'system'},
  {id:'block_npss',type:'taskError',label:'Блокировка\n(НПСС устарела)',lane:'system'},
  {id:'t3',type:'task',label:'Расчет\nрентабельности',lane:'system'},
  {id:'x2',type:'gateway',label:'X',lane:'system'},
  {id:'t4',type:'task',label:'Авто-\nсогласование',lane:'system'},
  {id:'sub_approval',type:'subprocess',label:'Согласование\n(см. BPMN 2)',lane:'approver'},
  {id:'sub_emergency',type:'subprocess',label:'Экстренное\nсогласование\n(см. BPMN 3)',lane:'approver'},
  {id:'t5',type:'task',label:'Передача\nна склад\n(точка невозврата)',lane:'system'},
  {id:'sub_wms',type:'subprocess',label:'Интеграция\nс WMS\n(см. BPMN 6)',lane:'wms'},
  {id:'t6',type:'task',label:'Создание и\nпроведение РТУ',lane:'system'},
  {id:'x3',type:'gateway',label:'X',lane:'system'},
  {id:'sub_return',type:'subprocess',label:'Возврат товара\n(см. BPMN 7)',lane:'manager'},
  {id:'sub_close',type:'subprocess',label:'Закрытие ЛС\n(см. BPMN 8)',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'ЛС закрыта',lane:'system'},
  {id:'end_block',type:'eventEndError',label:'Заблокировано',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},
  {from:'t1',to:'t2'},
  {from:'t2',to:'sub_npss'},
  {from:'sub_npss',to:'x1'},
  {from:'x1',to:'block_npss',label:'> 90 дн'},
  {from:'block_npss',to:'end_block'},
  {from:'x1',to:'t3',label:'< 90 дн'},
  {from:'t3',to:'x2'},
  {from:'x2',to:'t4',label:'< 1 п.п.'},
  {from:'x2',to:'sub_approval',label:'>= 1 п.п.'},
  {from:'x2',to:'sub_emergency',label:'срочная отгрузка'},
  {from:'t4',to:'t5'},
  {from:'sub_approval',to:'t5'},
  {from:'sub_emergency',to:'t5'},
  {from:'t5',to:'sub_wms'},
  {from:'sub_wms',to:'t6'},
  {from:'t6',to:'x3'},
  {from:'x3',to:'sub_close',label:'все отгружено'},
  {from:'x3',to:'t2',label:'следующий заказ'},
  {from:'x3',to:'sub_return',label:'возврат'},
  {from:'sub_return',to:'x3'},
  {from:'sub_close',to:'end_ok'}
 ],
 notes:[{text:'Диаграммы 11-12 (Этап 2): Фиксация потребности, Санкции за невыкуп'}]
},
// BPMN 1 — OK (no issues)
{num:1,name:'Контроль рентабельности',
 diagramName:'BPMN 1: Контроль рентабельности',
 description:'Процесс контроля рентабельности заказов клиентов в 1С:УТ',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'system',name:'Контроль рентабельности 1С:УТ',color:'#d5e8d4'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'manager'},
  {id:'t1',type:'task',label:'Создать\nЗаказ клиента',lane:'manager'},
  {id:'t2',type:'task',label:'Проверка НПСС\n(возраст < 90 дн)',lane:'system'},
  {id:'x1',type:'gateway',label:'X',lane:'system'},
  {id:'t3',type:'taskError',label:'Блокировка\n(обновить НПСС)',lane:'system'},
  {id:'e1',type:'eventEndError',label:'Заблокирован',lane:'system'},
  {id:'t4',type:'task',label:'Расчет\nрентабельности',lane:'system'},
  {id:'x2',type:'gateway',label:'X',lane:'system'},
  {id:'t5',type:'task',label:'Авто-\nсогласование',lane:'system'},
  {id:'e2',type:'eventEnd',label:'Заказ\nсогласован',lane:'system'},
  {id:'t6',type:'subprocess',label:'Согласование\n(см. BPMN 2)',lane:'system'},
  {id:'x3',type:'gateway',label:'X',lane:'system'},
  {id:'e3',type:'eventEnd',label:'Согласовано',lane:'system'},
  {id:'e4',type:'eventEndError',label:'Отклонено',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'t2'},{from:'t2',to:'x1'},
  {from:'x1',to:'t3',label:'устарела'},{from:'t3',to:'e1'},
  {from:'x1',to:'t4',label:'актуальна'},{from:'t4',to:'x2'},
  {from:'x2',to:'t5',label:'>= 0%'},{from:'t5',to:'e2'},
  {from:'x2',to:'t6',label:'< 0%'},{from:'t6',to:'x3'},
  {from:'x3',to:'e3',label:'да'},{from:'x3',to:'e4',label:'нет'}
 ],
 notes:[]
},
// BPMN 2 — OK
{num:2,name:'Согласование отрицательной рентабельности',
 diagramName:'BPMN 2: Согласование отрицательной рентабельности',
 description:'Процесс согласования заказов с отрицательной рентабельностью',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'head',name:'Руководитель отдела продаж',color:'#ffe6cc'},{id:'system',name:'1С:УТ',color:'#d5e8d4'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'system'},
  {id:'t1',type:'task',label:'Формирование\nзапроса на\nсогласование',lane:'system'},
  {id:'t2',type:'task',label:'Уведомление\nруководителя',lane:'system'},
  {id:'t3',type:'task',label:'Рассмотрение\nзаказа',lane:'head'},
  {id:'x1',type:'gateway',label:'X',lane:'head'},
  {id:'t4',type:'task',label:'Согласовать\nс комментарием',lane:'head'},
  {id:'t5',type:'task',label:'Отклонить\nс причиной',lane:'head'},
  {id:'t6',type:'task',label:'Фиксация\nрешения',lane:'system'},
  {id:'t7',type:'task',label:'Получить\nуведомление',lane:'manager'},
  {id:'x3',type:'gateway',label:'X',lane:'manager'},
  {id:'t8',type:'task',label:'Продолжить\nработу с заказом',lane:'manager'},
  {id:'t9',type:'task',label:'Скорректировать\nзаказ',lane:'manager'},
  {id:'e1',type:'eventEnd',label:'Согласовано',lane:'system'},
  {id:'e2',type:'eventEndError',label:'Отклонено',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'t2'},{from:'t2',to:'t3'},
  {from:'t3',to:'x1'},{from:'x1',to:'t4',label:'одобрить'},{from:'x1',to:'t5',label:'отклонить'},
  {from:'t4',to:'t6'},{from:'t5',to:'t6'},{from:'t6',to:'t7'},
  {from:'t7',to:'x3'},{from:'x3',to:'t8',label:'согласован'},{from:'x3',to:'t9',label:'отклонен'},
  {from:'t8',to:'e1'},{from:'t9',to:'e2'}
 ],
 notes:[]
},
// BPMN 3 — FIX: added e1 end event and edge from t3
{num:3,name:'Экстренное согласование',
 diagramName:'BPMN 3: Экстренное согласование (устное разрешение)',
 description:'Процесс экстренного согласования при срочных отгрузках с отрицательной рентабельностью',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'warehouse',name:'Склад',color:'#d5e8d4'},{id:'approver',name:'Согласующий',color:'#ffe6cc'},{id:'result',name:'Результат',color:'#f5f5f5'}],
 nodes:[
  {id:'start',type:'eventStart',label:'Срочная\nотгрузка',lane:'manager'},
  {id:'t1',type:'task',label:'Запрос устного\nразрешения',lane:'manager'},
  {id:'x1',type:'gateway',label:'X',lane:'manager'},
  {id:'t2',type:'task',label:'Фиксация в 1С\n(комментарий)',lane:'manager'},
  {id:'t3',type:'subprocess',label:'Стандартный процесс\n(см. BPMN 2)',lane:'manager'},
  {id:'t4',type:'task',label:'Отгрузка\nтовара',lane:'warehouse'},
  {id:'t5',type:'task',label:'Согласование\nпост-фактум\n(SLA 24ч)',lane:'approver'},
  {id:'x2',type:'gateway',label:'X',lane:'approver'},
  {id:'e1',type:'eventEnd',label:'Стандартное\nсогласование',lane:'result'},
  {id:'e2',type:'eventEnd',label:'Согласовано\nпост-фактум',lane:'result'},
  {id:'t6',type:'taskError',label:'Регистрация\nинцидента',lane:'result'},
  {id:'e3',type:'eventEndError',label:'Инцидент',lane:'result'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'x1'},
  {from:'x1',to:'t2',label:'да'},{from:'x1',to:'t3',label:'нет'},
  {from:'t3',to:'e1'},
  {from:'t2',to:'t4'},{from:'t4',to:'t5'},{from:'t5',to:'x2'},
  {from:'x2',to:'e2',label:'да'},{from:'x2',to:'t6',label:'нет'},
  {from:'t6',to:'e3'}
 ],
 notes:[{text:'Лимиты: 3/мес на менеджера, 5/мес на контрагента'}]
},
// BPMN 4 — FIX: added edge from s_draft to s_cancel
{num:4,name:'Жизненный цикл заказа',
 diagramName:'BPMN 4: Жизненный цикл Заказа клиента',
 description:'Статусы и переходы Заказа клиента по ЛС',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'approver',name:'Согласующий',color:'#ffe6cc'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'manager'},
  {id:'t_create',type:'task',label:'Создание\nзаказа',lane:'manager'},
  {id:'s_draft',type:'task',label:'Черновик',lane:'system'},
  {id:'x_auto',type:'gateway',label:'X',lane:'system'},
  {id:'t_auto',type:'task',label:'Авто-согласование\n(< 1 п.п.)',lane:'system'},
  {id:'s_approval',type:'task',label:'На согласовании',lane:'system'},
  {id:'s_waiting',type:'task',label:'Ожидает\nпоступления',lane:'system'},
  {id:'x_decision',type:'gateway',label:'X',lane:'approver'},
  {id:'s_approved',type:'task',label:'Согласован\n(5 раб. дней)',lane:'system'},
  {id:'s_rejected',type:'task',label:'Отклонен',lane:'system'},
  {id:'s_partial',type:'task',label:'Частично\nсогласован',lane:'system'},
  {id:'s_expired',type:'task',label:'Согласование\nистекло',lane:'system'},
  {id:'x_rtu',type:'gateway',label:'X',lane:'system'},
  {id:'s_work',type:'task',label:'В работе\n(есть РТУ)',lane:'system'},
  {id:'x_done',type:'gateway',label:'X',lane:'system'},
  {id:'s_done',type:'task',label:'Исполнен',lane:'system'},
  {id:'s_partial_close',type:'task',label:'Закрыт\nчастично',lane:'system'},
  {id:'s_cancel',type:'task',label:'Отменен',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'Завершен',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t_create'},{from:'t_create',to:'s_draft'},{from:'s_draft',to:'x_auto'},
  {from:'s_draft',to:'s_cancel',label:'отмена'},
  {from:'x_auto',to:'t_auto',label:'< 1 п.п.'},{from:'x_auto',to:'s_approval',label:'>= 1 п.п.'},
  {from:'x_auto',to:'s_waiting',label:'нет товара'},
  {from:'t_auto',to:'s_approved'},{from:'s_approval',to:'x_decision'},
  {from:'x_decision',to:'s_approved',label:'одобрен'},{from:'x_decision',to:'s_rejected',label:'отклонен'},
  {from:'x_decision',to:'s_partial',label:'частично'},
  {from:'s_rejected',to:'s_draft'},{from:'s_partial',to:'s_approved'},{from:'s_expired',to:'s_draft'},
  {from:'s_waiting',to:'s_approval'},{from:'s_approved',to:'x_rtu'},
  {from:'x_rtu',to:'s_work',label:'РТУ проведен'},{from:'x_rtu',to:'s_expired',label:'5 дней / > 3 п.п.'},
  {from:'s_work',to:'x_done'},
  {from:'x_done',to:'s_done',label:'все отгружено'},{from:'x_done',to:'s_partial_close',label:'клиент отменил'},
  {from:'s_done',to:'end_ok'},{from:'s_partial_close',to:'end_ok'},{from:'s_cancel',to:'end_ok'}
 ],
 notes:[{text:'Черновик: автоудаление через 7 дней (предупреждение за 3 дня)'}]
},
// BPMN 5 — OK
{num:5,name:'Жизненный цикл ЛС',
 diagramName:'BPMN 5: Жизненный цикл локальной сметы',
 description:'Статусы и переходы локальной сметы от создания до закрытия',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'approver',name:'Согласующий (РБЮ / ДП / ГД)',color:'#ffe6cc'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'manager'},
  {id:'t_create',type:'task',label:'Создание ЛС\n(НПСС фиксируется)',lane:'manager'},
  {id:'s_active',type:'task',label:'Активна\n(создание заказов\nразрешено)',lane:'system'},
  {id:'x_event',type:'gateway',label:'X',lane:'system'},
  {id:'t_order',type:'subprocess',label:'Заказы клиента\n(см. BPMN 4)',lane:'manager'},
  {id:'x_shipped',type:'gateway',label:'X',lane:'system'},
  {id:'s_closed',type:'task',label:'Закрыта\n(все отгружено)',lane:'system'},
  {id:'s_expired',type:'task',label:'Истекла\n(срок вышел)',lane:'system'},
  {id:'x_expired',type:'gateway',label:'X',lane:'system'},
  {id:'t_extend',type:'task',label:'Продление\n(макс. 2 раза)',lane:'manager'},
  {id:'t_close_manual',type:'task',label:'Закрытие\nс частичной\nотгрузкой',lane:'manager'},
  {id:'x_close_approval',type:'gateway',label:'X',lane:'system'},
  {id:'t_close_auto',type:'task',label:'Закрытие\nбез согласования\n(< 1 п.п.)',lane:'system'},
  {id:'t_close_approve',type:'task',label:'Согласование\nзакрытия',lane:'approver'},
  {id:'s_cancelled',type:'task',label:'Отменена\n(0 отгрузок)',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'ЛС завершена',lane:'system'},
  {id:'end_cancel',type:'eventEndError',label:'ЛС отменена',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t_create'},{from:'t_create',to:'s_active'},{from:'s_active',to:'x_event'},
  {from:'x_event',to:'t_order',label:'новый заказ'},{from:'x_event',to:'s_expired',label:'срок истек'},
  {from:'x_event',to:'s_cancelled',label:'отмена (0 отгрузок)'},
  {from:'t_order',to:'x_shipped'},
  {from:'x_shipped',to:'s_closed',label:'все отгружено'},{from:'x_shipped',to:'s_active',label:'есть остаток'},
  {from:'s_expired',to:'x_expired'},
  {from:'x_expired',to:'t_extend',label:'продлить'},{from:'x_expired',to:'t_close_manual',label:'закрыть'},
  {from:'t_extend',to:'s_active'},{from:'t_close_manual',to:'x_close_approval'},
  {from:'x_close_approval',to:'t_close_auto',label:'< 1 п.п.'},{from:'x_close_approval',to:'t_close_approve',label:'>= 1 п.п.'},
  {from:'t_close_auto',to:'s_closed'},{from:'t_close_approve',to:'s_closed'},
  {from:'s_closed',to:'end_ok'},{from:'s_cancelled',to:'end_cancel'}
 ],
 notes:[{text:'Продление: макс. 2 раза; если > 3 мес. - пересчет НПСС'}]
},
// BPMN 6 — OK
{num:6,name:'Интеграция с WMS',
 diagramName:'BPMN 6: Интеграция с WMS',
 description:'Процесс передачи заказа на склад, отборка, частичная отгрузка',
 lanes:[{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'wms',name:'WMS',color:'#d5e8d4'},{id:'warehouse',name:'Специалист склада',color:'#dae8fc'},{id:'manager',name:'Менеджер',color:'#dae8fc'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'system'},
  {id:'t1',type:'task',label:'Отправка JSON\nс заказом в WMS',lane:'system'},
  {id:'t_pnr',type:'task',label:'Установка флага\nПереданНаСклад\n(точка невозврата)',lane:'system'},
  {id:'t2',type:'task',label:'Получение задания\nна отборку',lane:'wms'},
  {id:'t3',type:'task',label:'Отборка товара',lane:'warehouse'},
  {id:'x1',type:'gateway',label:'X',lane:'wms'},
  {id:'t4',type:'task',label:'Полная отборка\n(факт = план)',lane:'wms'},
  {id:'t5',type:'task',label:'Частичная отборка\n(факт < план)',lane:'wms'},
  {id:'t6',type:'task',label:'Пересчет\nрентабельности\nпо факту',lane:'system'},
  {id:'x2',type:'gateway',label:'X',lane:'system'},
  {id:'t7',type:'task',label:'Отгрузка по факту',lane:'system'},
  {id:'t8',type:'task',label:'Запрос решения\nменеджера\n(SLA 2 часа)',lane:'manager'},
  {id:'x3',type:'gateway',label:'X',lane:'manager'},
  {id:'t9',type:'task',label:'Подтвердить\nотгрузку',lane:'manager'},
  {id:'t10',type:'taskError',label:'Отмена\n(авто через 2 ч)',lane:'manager'},
  {id:'t11',type:'task',label:'Создание и\nпроведение РТУ',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'РТУ проведен',lane:'system'},
  {id:'end_cancel',type:'eventEndError',label:'Отменено',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'t_pnr'},{from:'t_pnr',to:'t2'},
  {from:'t2',to:'t3'},{from:'t3',to:'x1'},
  {from:'x1',to:'t4',label:'полная'},{from:'x1',to:'t5',label:'частичная'},
  {from:'t4',to:'t11'},{from:'t5',to:'t6'},{from:'t6',to:'x2'},
  {from:'x2',to:'t7',label:'не ухудшилась'},{from:'x2',to:'t8',label:'ухудшилась'},
  {from:'t7',to:'t11'},{from:'t8',to:'x3'},
  {from:'x3',to:'t9',label:'отгрузить'},{from:'x3',to:'t10',label:'отменить'},
  {from:'t9',to:'t11'},{from:'t10',to:'end_cancel'},{from:'t11',to:'end_ok'}
 ],
 notes:[{text:'SLA интеграции: 30 сек + 3 повторные попытки'}]
},
// BPMN 7 — FIX: added edge from x_ls to t_storno
{num:7,name:'Возврат товара',
 diagramName:'BPMN 7: Возврат товара по ЛС',
 description:'Процесс возврата товара и его влияние на рентабельность ЛС',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'exchange',name:'Специалист товарообмена',color:'#dae8fc'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'manager'},
  {id:'t1',type:'task',label:'Инициация\nвозврата',lane:'manager'},
  {id:'x_ls',type:'gateway',label:'X',lane:'system'},
  {id:'t2',type:'task',label:'Создание\n"Возврат товаров"\n(привязка к РТУ)',lane:'system'},
  {id:'t3',type:'task',label:'Товар в остаток ЛС\n(рент. по цене РТУ)',lane:'system'},
  {id:'t4',type:'task',label:'Пересчет\nнакопленной\nрентабельности',lane:'system'},
  {id:'x_level',type:'gateway',label:'X',lane:'system'},
  {id:'t5',type:'task',label:'Аннулирование\nсогласований',lane:'system'},
  {id:'t6',type:'task',label:'Возврат по\nзакрытой ЛС\n(товар в своб. остаток)',lane:'system'},
  {id:'x_60d',type:'gateway',label:'X',lane:'system'},
  {id:'t7',type:'task',label:'Учет в санкциях\n(% выкупа)',lane:'system'},
  {id:'t8',type:'task',label:'Только финансовая\nкорректировка',lane:'system'},
  {id:'t_storno',type:'task',label:'Сторнирование РТУ\n(товар не покидал склад)',lane:'exchange'},
  {id:'end_ok',type:'eventEnd',label:'Возврат обработан',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'x_ls'},
  {from:'x_ls',to:'t2',label:'ЛС активна'},{from:'x_ls',to:'t6',label:'ЛС закрыта'},
  {from:'x_ls',to:'t_storno',label:'сторно (товар на складе)'},
  {from:'t2',to:'t3'},{from:'t3',to:'t4'},{from:'t4',to:'x_level'},
  {from:'x_level',to:'t5',label:'уровень изменился'},{from:'x_level',to:'end_ok',label:'без изменений'},
  {from:'t5',to:'end_ok'},
  {from:'t6',to:'x_60d'},
  {from:'x_60d',to:'t7',label:'<= 60 дней'},{from:'x_60d',to:'t8',label:'> 60 дней'},
  {from:'t7',to:'end_ok'},{from:'t8',to:'end_ok'},
  {from:'t_storno',to:'t4'}
 ],
 notes:[{text:'Рентабельность возврата: по цене на момент отгрузки (из РТУ), НЕ текущая НПСС'}]
},
// BPMN 8 — FIX: added end_rejected node and edge from t_rejected
{num:8,name:'Закрытие ЛС',
 diagramName:'BPMN 8: Закрытие локальной сметы',
 description:'Процесс закрытия ЛС с проверкой рентабельности и согласованием',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'approver',name:'Согласующий (РБЮ / ДП / ГД)',color:'#ffe6cc'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'system'},
  {id:'x_trigger',type:'gateway',label:'X',lane:'system'},
  {id:'t_auto_close',type:'task',label:'Автозакрытие\n(все отгружено)',lane:'system'},
  {id:'t_manual_close',type:'task',label:'Инициация закрытия\nменеджером',lane:'manager'},
  {id:'t_expired',type:'task',label:'ЛС истекла\n(срок вышел)',lane:'system'},
  {id:'x_shipments',type:'gateway',label:'X',lane:'system'},
  {id:'t_cancel',type:'task',label:'Статус: Отменена\n(0 отгрузок)',lane:'system'},
  {id:'t_calc',type:'task',label:'Расчет накопленной\nрентабельности',lane:'system'},
  {id:'x_deviation',type:'gateway',label:'X',lane:'system'},
  {id:'t_close_auto',type:'task',label:'Закрытие\nбез согласования',lane:'system'},
  {id:'t_approve_rbu',type:'task',label:'Согласование РБЮ\n(1-15 п.п.)',lane:'approver'},
  {id:'t_approve_dp',type:'task',label:'Согласование ДП\n(15.01-25 п.п.)',lane:'approver'},
  {id:'t_approve_gd',type:'task',label:'Согласование ГД\n(> 25 п.п.)',lane:'approver'},
  {id:'x_result',type:'gateway',label:'X',lane:'approver'},
  {id:'t_closed',type:'task',label:'Статус: Закрыта\n(товар в своб. остаток)',lane:'system'},
  {id:'t_rejected',type:'task',label:'ЛС остается\nактивной',lane:'system'},
  {id:'end_rejected',type:'eventEnd',label:'Закрытие\nотклонено',lane:'system'},
  {id:'sub_sanctions',type:'subprocess',label:'Расчет санкций\n(см. BPMN 12)',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'ЛС закрыта',lane:'system'},
  {id:'end_cancel',type:'eventEndError',label:'ЛС отменена',lane:'system'}
 ],
 edges:[
  {from:'start',to:'x_trigger'},
  {from:'x_trigger',to:'t_auto_close',label:'остаток = 0'},{from:'x_trigger',to:'t_manual_close',label:'вручную'},
  {from:'x_trigger',to:'t_expired',label:'срок истек'},
  {from:'t_auto_close',to:'t_closed'},{from:'t_manual_close',to:'x_shipments'},{from:'t_expired',to:'x_shipments'},
  {from:'x_shipments',to:'t_cancel',label:'0 отгрузок'},{from:'x_shipments',to:'t_calc',label:'есть отгрузки'},
  {from:'t_calc',to:'x_deviation'},
  {from:'x_deviation',to:'t_close_auto',label:'< 1 п.п.'},{from:'x_deviation',to:'t_approve_rbu',label:'1-15 п.п.'},
  {from:'x_deviation',to:'t_approve_dp',label:'15.01-25'},{from:'x_deviation',to:'t_approve_gd',label:'> 25 п.п.'},
  {from:'t_close_auto',to:'t_closed'},
  {from:'t_approve_rbu',to:'x_result'},{from:'t_approve_dp',to:'x_result'},{from:'t_approve_gd',to:'x_result'},
  {from:'x_result',to:'t_closed',label:'одобрено'},{from:'x_result',to:'t_rejected',label:'отклонено'},
  {from:'t_rejected',to:'end_rejected'},
  {from:'t_closed',to:'sub_sanctions'},{from:'sub_sanctions',to:'end_ok'},{from:'t_cancel',to:'end_cancel'}
 ],
 notes:[{text:'SLA согласования: РБЮ: 4 часа, ДП: 8 часов, ГД: 24 часа'}]
},
// BPMN 9 — FIX: added edge from x_rbu to t_dp_temp
{num:9,name:'Контроль актуальности НПСС',
 diagramName:'BPMN 9: Контроль актуальности НПСС',
 description:'Проверка возраста нормативной плановой себестоимости и действия при устаревании',
 lanes:[{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'rbu',name:'РБЮ',color:'#ffe6cc'},{id:'dp',name:'ДП',color:'#ffe6cc'},{id:'finance',name:'Финансовая служба',color:'#f5f5f5'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'system'},
  {id:'t1',type:'task',label:'Проверка возраста\nНПСС при\nсоздании заказа',lane:'system'},
  {id:'x1',type:'gateway',label:'X',lane:'system'},
  {id:'t_green',type:'task',label:'0-30 дней\n(работа без\nограничений)',lane:'system'},
  {id:'t_yellow',type:'task',label:'31-60 дней\n(предупреждение)',lane:'system'},
  {id:'t_orange',type:'task',label:'61-90 дней\n(требуется\nподтверждение РБЮ)',lane:'system'},
  {id:'t_rbu_confirm',type:'task',label:'Подтверждение\nактуальности\nили пересчет',lane:'rbu'},
  {id:'x_rbu',type:'gateway',label:'X',lane:'rbu'},
  {id:'t_red',type:'taskError',label:'> 90 дней\nБЛОКИРОВКА\n(обязательный пересчет)',lane:'system'},
  {id:'t_dp_temp',type:'task',label:'Временное разрешение\n(80+ дней)',lane:'dp'},
  {id:'t_recalc',type:'task',label:'Пересчет НПСС\n(ежемесячно до 10-го)',lane:'finance'},
  {id:'t_audit',type:'task',label:'Квартальный аудит\n(100 SKU)',lane:'finance'},
  {id:'end_ok',type:'eventEnd',label:'Продолжение работы',lane:'system'},
  {id:'end_block',type:'eventEndError',label:'Заблокировано',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'x1'},
  {from:'x1',to:'t_green',label:'0-30 дн'},{from:'x1',to:'t_yellow',label:'31-60 дн'},
  {from:'x1',to:'t_orange',label:'61-90 дн'},{from:'x1',to:'t_red',label:'> 90 дн'},
  {from:'t_green',to:'end_ok'},{from:'t_yellow',to:'end_ok'},
  {from:'t_orange',to:'t_rbu_confirm'},{from:'t_rbu_confirm',to:'x_rbu'},
  {from:'x_rbu',to:'end_ok',label:'актуальна'},{from:'x_rbu',to:'t_recalc',label:'пересчет'},
  {from:'x_rbu',to:'t_dp_temp',label:'эскалация ДП'},
  {from:'t_red',to:'end_block'},
  {from:'t_dp_temp',to:'end_ok'},{from:'t_recalc',to:'end_ok'},{from:'t_audit',to:'end_ok'}
 ],
 notes:[{text:'SLA корректировки: 24 раб. часа (НПСС=0). Эскалация на ФС через 48ч'}]
},
// BPMN 10 — OK
{num:10,name:'Изменение плановой рентабельности',
 diagramName:'BPMN 10: Изменение плановой рентабельности ЛС',
 description:'Процесс согласования изменения плановой рентабельности локальной сметы',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'approver',name:'Согласующий (РБЮ / ДП / ГД)',color:'#ffe6cc'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'manager'},
  {id:'t1',type:'task',label:'Запрос на изменение\nплановой рентабельности',lane:'manager'},
  {id:'x_direction',type:'gateway',label:'X',lane:'system'},
  {id:'t_increase',type:'task',label:'Повышение\n(без согласования)',lane:'system'},
  {id:'x_cause',type:'gateway',label:'X',lane:'system'},
  {id:'t_npss',type:'task',label:'Снижение из-за\nпересчета НПСС\n(без согласования)',lane:'system'},
  {id:'x_level',type:'gateway',label:'X',lane:'system'},
  {id:'t_rbu',type:'task',label:'Согласование РБЮ\n(0-3 п.п.)',lane:'approver'},
  {id:'t_dp',type:'task',label:'Согласование ДП\n(3.01-10 п.п.)',lane:'approver'},
  {id:'t_gd',type:'task',label:'Согласование ГД\n(> 10 п.п.)',lane:'approver'},
  {id:'x_result',type:'gateway',label:'X',lane:'approver'},
  {id:'t_apply',type:'task',label:'Применение изменения\n(запись в журнал)',lane:'system'},
  {id:'t_annul',type:'task',label:'Аннулирование\nсогласований',lane:'system'},
  {id:'t_reject',type:'taskError',label:'Отказ\n(изменение не применено)',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'Изменено',lane:'system'},
  {id:'end_reject',type:'eventEndError',label:'Отклонено',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'x_direction'},
  {from:'x_direction',to:'t_increase',label:'повышение'},{from:'x_direction',to:'x_cause',label:'снижение'},
  {from:'x_cause',to:'t_npss',label:'пересчет НПСС'},{from:'x_cause',to:'x_level',label:'ручной запрос'},
  {from:'x_level',to:'t_rbu',label:'0-3 п.п.'},{from:'x_level',to:'t_dp',label:'3.01-10'},
  {from:'x_level',to:'t_gd',label:'> 10 п.п.'},
  {from:'t_rbu',to:'x_result'},{from:'t_dp',to:'x_result'},{from:'t_gd',to:'x_result'},
  {from:'x_result',to:'t_apply',label:'одобрено'},{from:'x_result',to:'t_reject',label:'отклонено'},
  {from:'t_increase',to:'t_apply'},{from:'t_npss',to:'t_apply'},
  {from:'t_apply',to:'t_annul'},{from:'t_annul',to:'end_ok'},{from:'t_reject',to:'end_reject'}
 ],
 notes:[{text:'Журнал аудита: автор, дата, старое/новое значение, причина. Хранение: 5 лет.'}]
},
// BPMN 11 — OK
{num:11,name:'Фиксация потребности',
 diagramName:'BPMN 11: Фиксация потребности (Этап 2)',
 description:'Процесс фиксации потребности при дефиците товара и механизм резервирования',
 lanes:[{id:'manager',name:'Менеджер',color:'#dae8fc'},{id:'system',name:'1С:УТ',color:'#d5e8d4'},{id:'wms',name:'WMS / Склад',color:'#d5e8d4'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'manager'},
  {id:'t1',type:'task',label:'Создание заказа\nпо ЛС',lane:'manager'},
  {id:'t2',type:'task',label:'Проверка\nналичия товара',lane:'system'},
  {id:'x_stock',type:'gateway',label:'X',lane:'system'},
  {id:'t_full',type:'task',label:'100% в наличии\n(стандартный поток)',lane:'system'},
  {id:'t_partial',type:'task',label:'Частичное наличие\n(разделение заказа)',lane:'system'},
  {id:'t_none',type:'task',label:'Нет на складе\n(весь заказ в ожидание)',lane:'system'},
  {id:'t_fix',type:'task',label:'Фиксация потребности\n(дата, позиции, кол-во)',lane:'system'},
  {id:'t_wait',type:'task',label:'Ожидание поступления\n(макс. 90 дней)',lane:'system'},
  {id:'x_arrive',type:'gateway',label:'X',lane:'wms'},
  {id:'t_arrived',type:'task',label:'Товар поступил\n(физ. резерв 48 ч)',lane:'wms'},
  {id:'t_notify',type:'task',label:'Уведомление\nклиента / менеджера',lane:'system'},
  {id:'x_confirm',type:'gateway',label:'X',lane:'manager'},
  {id:'t_confirm',type:'task',label:'Подтверждение\n(в течение 5 дней)',lane:'manager'},
  {id:'t_cancel',type:'task',label:'Отказ / таймаут',lane:'manager'},
  {id:'x_expiry',type:'gateway',label:'X',lane:'system'},
  {id:'t_extend',type:'task',label:'Автопродление ЛС\n(5 дней, одноразово)',lane:'system'},
  {id:'t_annul',type:'taskError',label:'Аннулирование фиксации\n(товар в своб. остаток)',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'К согласованию',lane:'system'},
  {id:'end_cancel',type:'eventEndError',label:'Аннулировано',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'t2'},{from:'t2',to:'x_stock'},
  {from:'x_stock',to:'t_full',label:'100%'},{from:'x_stock',to:'t_partial',label:'частично'},
  {from:'x_stock',to:'t_none',label:'0%'},
  {from:'t_full',to:'end_ok'},{from:'t_partial',to:'t_fix'},{from:'t_none',to:'t_fix'},
  {from:'t_fix',to:'t_wait'},{from:'t_wait',to:'x_arrive'},
  {from:'x_arrive',to:'t_arrived',label:'поступил'},{from:'x_arrive',to:'t_annul',label:'90 дней / ЛС истекла'},
  {from:'t_arrived',to:'t_notify'},{from:'t_notify',to:'x_confirm'},
  {from:'x_confirm',to:'t_confirm',label:'да'},{from:'x_confirm',to:'t_cancel',label:'нет / таймаут'},
  {from:'t_confirm',to:'x_expiry'},
  {from:'x_expiry',to:'end_ok',label:'ЛС активна'},{from:'x_expiry',to:'t_extend',label:'< 5 дн до истечения'},
  {from:'t_extend',to:'end_ok'},{from:'t_cancel',to:'t_annul'},{from:'t_annul',to:'end_cancel'}
 ],
 notes:[{text:'Антиманипуляция: фиксация за < 14 дней - только если товар отсутствовал 60+ дней'}]
},
// BPMN 12 — t_rehab orphan (design choice: async 6-month process, kept as background element)
{num:12,name:'Санкции за невыкуп',
 diagramName:'BPMN 12: Санкции за невыкуп (Этап 2)',
 description:'Расчет санкций при закрытии ЛС с неполным выкупом, реабилитация, исключения',
 lanes:[{id:'system',name:'1С:УТ (авторасчет)',color:'#d5e8d4'},{id:'rbu',name:'РБЮ',color:'#ffe6cc'},{id:'dp',name:'ДП',color:'#ffe6cc'},{id:'manager',name:'Менеджер',color:'#dae8fc'}],
 nodes:[
  {id:'start',type:'eventStart',label:'',lane:'system'},
  {id:'t1',type:'task',label:'ЛС закрыта или истекла\n(триггер)',lane:'system'},
  {id:'t2',type:'task',label:'Расчет % выкупа\n(Отгруж.-Возвр.60д)\n/ (ЛС-Дефицит)',lane:'system'},
  {id:'t3',type:'task',label:'Определение\nподтвержденного\nдефицита',lane:'rbu'},
  {id:'x_percent',type:'gateway',label:'X',lane:'system'},
  {id:'t_ok',type:'task',label:'90-100%\nБез санкций',lane:'system'},
  {id:'t_mild',type:'task',label:'70-89%\nСкидка -3 п.п.',lane:'system'},
  {id:'t_medium',type:'task',label:'50-69%\nСкидка -10 п.п.',lane:'system'},
  {id:'t_severe',type:'task',label:'< 50%\nТолько стандартные цены',lane:'system'},
  {id:'x_strategic',type:'gateway',label:'X',lane:'dp'},
  {id:'t_exception',type:'task',label:'Отмена санкции\n(стратегический клиент)',lane:'dp'},
  {id:'t_register',type:'task',label:'Запись в реестр\n(контрагент, тип, дата)',lane:'system'},
  {id:'t_notify',type:'task',label:'Уведомление менеджера\nо санкции',lane:'manager'},
  {id:'t_rehab',type:'task',label:'Реабилитация\n(6 мес. без нарушений)',lane:'system'},
  {id:'end_ok',type:'eventEnd',label:'Санкция применена',lane:'system'},
  {id:'end_clean',type:'eventEnd',label:'Без санкций',lane:'system'}
 ],
 edges:[
  {from:'start',to:'t1'},{from:'t1',to:'t3'},{from:'t3',to:'t2'},{from:'t2',to:'x_percent'},
  {from:'x_percent',to:'t_ok',label:'90-100%'},{from:'x_percent',to:'t_mild',label:'70-89%'},
  {from:'x_percent',to:'t_medium',label:'50-69%'},{from:'x_percent',to:'t_severe',label:'< 50%'},
  {from:'t_ok',to:'end_clean'},
  {from:'t_mild',to:'x_strategic'},{from:'t_medium',to:'x_strategic'},{from:'t_severe',to:'x_strategic'},
  {from:'x_strategic',to:'t_exception',label:'стратег. клиент'},{from:'x_strategic',to:'t_register',label:'обычный клиент'},
  {from:'t_exception',to:'end_clean'},{from:'t_register',to:'t_notify'},{from:'t_notify',to:'end_ok'},
  {from:'t_rehab',to:'end_clean'}
 ],
 notes:[{text:'Кумулятивность: повторные нарушения суммируются. При -13+ п.п. - только стандартные цены.'}]
}
];

// ===== BPMN NUMBER → P INDEX MAP =====
const BPMN_IDX={};
P.forEach((p,i)=>BPMN_IDX[p.num]=i);

// ===== LANE COLORS =====
const LC={
  '#dae8fc':{bg:'#eff6ff',border:'#93c5fd',text:'#1e40af'},
  '#d5e8d4':{bg:'#f0fdf4',border:'#86efac',text:'#166534'},
  '#ffe6cc':{bg:'#fef3c7',border:'#fcd34d',text:'#92400e'},
  '#f5f5f5':{bg:'#f8fafc',border:'#cbd5e1',text:'#475569'}
};
function lc(c){return LC[c]||LC['#f5f5f5'];}

// ===== TYPE CONFIG =====
const TY={
  eventStart:{icon:'\u25CB',cls:'start',label:'Начало',row:'row-start'},
  eventEnd:{icon:'\u25CF',cls:'end',label:'Завершение',row:'row-end'},
  eventEndError:{icon:'\u2716',cls:'end-err',label:'Ошибка',row:'row-end-err'},
  task:{icon:'\u25A1',cls:'task',label:'Задача',row:'row-task'},
  taskError:{icon:'\u26A0',cls:'task-err',label:'Ошибка',row:'row-task-err'},
  subprocess:{icon:'\u29C9',cls:'subprocess',label:'Подпроцесс',row:'row-subprocess'},
  gateway:{icon:'\u25C7',cls:'gateway',label:'Развилка XOR',row:'row-gateway'}
};

function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function clean(s){return s.replace(/\n/g,' ').trim();}

// Condition color class
function cc(label){
  if(!label)return'cond-gray';
  const l=label.toLowerCase();
  if(/^да$|одобр|полн|все отгруж|не ухудш|без изменен|актуальн|^отгрузить$|повышение|рту проведен|90-100|0-30|есть остаток|^согласован$|поступил|^100%$|остаток = 0/.test(l))return'cond-green';
  if(/отклон|^нет$|отмен|блок|устарел|инцидент|> ?90|ухудш|истек|0 отгруз|аннул|^нет\b/.test(l))return'cond-red';
  if(/частично|ожид|нет товар|вручную|снижен|закрыть|^0%$|продлить|таймаут|сторно|эскалац/.test(l))return'cond-amber';
  return'cond-gray';
}

// ===== NAVIGATION STATE =====
let navStack=[];
let currentIdx=0;

// ===== HIGHLIGHT ROW =====
function hl(nodeId){
  const el=document.getElementById('row-'+nodeId);
  if(!el)return;
  el.scrollIntoView({behavior:'smooth',block:'center'});
  el.classList.remove('highlight');
  void el.offsetWidth;
  el.classList.add('highlight');
}

// ===== GO TO BPMN PROCESS =====
function goTo(bpmnNum){
  if(BPMN_IDX[bpmnNum]===undefined)return;
  navStack.push(currentIdx);
  show(BPMN_IDX[bpmnNum]);
}

// ===== RENDER PROCESS TABLE =====
function renderProcess(proc){
  const nm=new Map(proc.nodes.map(n=>[n.id,n]));
  const lm=new Map(proc.lanes.map(l=>[l.id,l]));
  const out={},inc={};
  proc.nodes.forEach(n=>{out[n.id]=[];inc[n.id]=[];});
  proc.edges.forEach(e=>{if(out[e.from])out[e.from].push(e);if(inc[e.to])inc[e.to].push(e);});

  // Detect back-edges
  const back=new Set();
  const vis=new Set(),stk=new Set();
  function dfs(id){
    vis.add(id);stk.add(id);
    (out[id]||[]).forEach(e=>{
      if(stk.has(e.to))back.add(e.from+'>'+e.to);
      else if(!vis.has(e.to))dfs(e.to);
    });
    stk.delete(id);
  }
  const targets=new Set(proc.edges.map(e=>e.to));
  proc.nodes.forEach(n=>{if(!targets.has(n.id)&&!vis.has(n.id))dfs(n.id);});
  proc.nodes.forEach(n=>{if(!vis.has(n.id))dfs(n.id);});

  // Topological sort (excluding back-edges)
  const deg={};
  proc.nodes.forEach(n=>{deg[n.id]=0;});
  proc.edges.filter(e=>!back.has(e.from+'>'+e.to)).forEach(e=>{deg[e.to]++;});
  const q=proc.nodes.filter(n=>deg[n.id]===0).map(n=>n.id);
  const order=[];
  while(q.length){
    const id=q.shift();order.push(id);
    (out[id]||[]).forEach(e=>{
      if(back.has(e.from+'>'+e.to))return;
      deg[e.to]--;if(deg[e.to]===0)q.push(e.to);
    });
  }
  proc.nodes.forEach(n=>{if(!order.includes(n.id))order.push(n.id);});

  // Orphans (no incoming at all, except start)
  const orphans=new Set();
  proc.nodes.forEach(n=>{
    if(n.type!=='eventStart'&&!targets.has(n.id))orphans.add(n.id);
  });

  // Stats
  let st={t:0,g:0,s:0,e:0};
  proc.nodes.forEach(n=>{
    if(n.type==='task')st.t++;
    if(n.type==='taskError')st.e++;
    if(n.type==='gateway')st.g++;
    if(n.type==='subprocess')st.s++;
  });

  let h='';

  // Stats
  h+='<div class="stats">';
  h+=`<div class="stat"><b>${proc.nodes.length}</b> <span>элементов</span></div>`;
  h+=`<div class="stat"><b>${st.t}</b> <span>задач</span></div>`;
  if(st.g)h+=`<div class="stat"><b>${st.g}</b> <span>развилок</span></div>`;
  if(st.s)h+=`<div class="stat"><b>${st.s}</b> <span>подпроцессов</span></div>`;
  if(st.e)h+=`<div class="stat"><b>${st.e}</b> <span>ошибок</span></div>`;
  h+=`<div class="stat"><b>${proc.edges.length}</b> <span>переходов</span></div>`;
  if(!orphans.size)h+='<div class="stat"><span class="audit-badge audit-ok">Аудит OK</span></div>';
  h+='</div>';

  // Lanes
  h+='<div class="lanes-section"><h3>Участники</h3><div class="lane-chips">';
  proc.lanes.forEach(l=>{
    const c=lc(l.color);
    h+=`<div class="lane-chip" style="background:${c.bg};border-color:${c.border};color:${c.text}">${esc(l.name.replace(/\n/g,' '))}</div>`;
  });
  h+='</div></div>';

  // Table
  h+='<div class="flow-card"><table class="flow-table"><thead><tr>';
  h+='<th style="width:36px">#</th><th style="width:32px"></th><th>Элемент</th><th style="width:140px">Роль</th><th>Переходы</th>';
  h+='</tr></thead><tbody>';

  let step=0;
  order.forEach(id=>{
    const n=nm.get(id);if(!n)return;
    step++;
    const ty=TY[n.type]||TY.task;
    const lane=lm.get(n.lane);
    const cl=lane?lc(lane.color):lc('#f5f5f5');
    const label=clean(n.label);
    const edges=out[id]||[];
    const isOrphan=orphans.has(id);

    h+=`<tr id="row-${id}" class="${ty.row}">`;

    // Step
    h+=`<td class="step-num">${step}</td>`;

    // Type icon
    h+=`<td><span class="type-icon ti-${ty.cls}" title="${ty.label}">${ty.icon}</span></td>`;

    // Element name
    h+='<td>';
    if(n.type==='subprocess'){
      const ref=n.label.match(/см\.\s*BPMN\s*(\d+)/);
      const nameOnly=esc(label.replace(/\(см\.\s*BPMN\s*\d+\)/,'').trim());
      h+=`<span class="el-name-sub">${nameOnly}</span>`;
      if(ref){
        h+=` <a class="click-ref" onclick="goTo(${ref[1]})" title="Перейти к BPMN ${ref[1]}">\u2192 BPMN ${ref[1]}</a>`;
      }
    }else if(n.type==='taskError'){
      h+=`<span class="el-name-err">${esc(label)}</span>`;
    }else if(n.type==='eventStart'){
      h+=`<span class="el-name">${label?esc(label):'<span style="color:#94a3b8">Начало процесса</span>'}</span>`;
    }else if(n.type==='eventEnd'||n.type==='eventEndError'){
      h+=`<span class="el-name">${label?esc(label):'<span style="color:#94a3b8">Конец</span>'}</span>`;
    }else if(n.type==='gateway'){
      h+=`<span class="el-name" style="color:#92400e;font-weight:600">Развилка</span>`;
    }else{
      h+=`<span class="el-name">${esc(label)}</span>`;
    }
    if(isOrphan)h+=' <span class="audit-badge audit-warn" title="Фоновый / асинхронный элемент">фоновый</span>';
    h+='</td>';

    // Lane
    h+=`<td><span class="lane-tag" style="background:${cl.bg};border:1px solid ${cl.border};color:${cl.text}">${lane?esc(lane.name.replace(/\n/g,' ')):'?'}</span></td>`;

    // Transitions
    h+='<td>';
    if(edges.length){
      h+='<div class="transitions">';
      edges.forEach(e=>{
        const tgt=nm.get(e.to);if(!tgt)return;
        const tl=clean(tgt.label);
        const isBack=back.has(e.from+'>'+e.to);
        const tty=TY[tgt.type]||TY.task;

        h+='<div class="trans">';
        h+=`<span class="trans-arrow${isBack?' trans-back':''}">${isBack?'\u21A9':'\u2192'}</span>`;
        if(e.label){
          h+=` <span class="trans-cond ${cc(e.label)}">${esc(e.label)}</span>`;
        }

        // Target: clickable to scroll & highlight
        let targetText=tl;
        if(tgt.type==='gateway')targetText='Развилка';
        else if(!tl)targetText=tgt.type.startsWith('event')?'Конец':'?';

        // If target is subprocess with BPMN ref, add ref link
        const tref=tgt.label.match(/см\.\s*BPMN\s*(\d+)/);
        if(tgt.type==='subprocess'&&tref){
          const tn=clean(tgt.label.replace(/\(см\.\s*BPMN\s*\d+\)/,''));
          h+=` <a class="click-node" onclick="hl('${e.to}')" title="Перейти к строке">${esc(tn)}</a>`;
          h+=` <a class="click-ref" onclick="goTo(${tref[1]})" title="Открыть BPMN ${tref[1]}">\u2192 BPMN ${tref[1]}</a>`;
        }else{
          h+=` <a class="click-node" onclick="hl('${e.to}')" title="Перейти к строке #">${esc(targetText)}</a>`;
        }
        if(isBack)h+=' <span style="font-size:10px;color:#94a3b8">(возврат)</span>';
        h+='</div>';
      });
      h+='</div>';
    }else{
      h+='<span style="color:#cbd5e1">\u2014</span>';
    }
    h+='</td></tr>';
  });

  h+='</tbody></table></div>';

  // Notes
  if(proc.notes&&proc.notes.length){
    proc.notes.forEach(n=>{
      h+=`<div class="note-box"><b>\u26A0</b><div>${esc(n.text)}</div></div>`;
    });
  }

  // Background processes note (orphans that remain)
  const bgOrphans=proc.nodes.filter(n=>orphans.has(n.id));
  if(bgOrphans.length){
    h+='<div class="bg-process-section"><h4>Фоновые / асинхронные элементы</h4>';
    bgOrphans.forEach(o=>{
      const ty=TY[o.type]||TY.task;
      const lane=lm.get(o.lane);
      h+=`<div class="issue-item"><span class="type-icon ti-${ty.cls}">${ty.icon}</span> <b>${esc(clean(o.label))}</b> <span style="color:#94a3b8">(${lane?esc(lane.name.replace(/\n/g,' ')):'?'})</span></div>`;
    });
    h+='</div>';
  }

  return h;
}

// ===== SIDEBAR NAVIGATION =====
const nav=document.getElementById('nav');
P.forEach((p,i)=>{
  const li=document.createElement('li');
  li.innerHTML='<span class="n">BPMN '+p.num+'</span>'+esc(p.name);
  li.onclick=()=>{navStack=[];show(i);};
  nav.appendChild(li);
});

function show(i){
  currentIdx=i;
  nav.querySelectorAll('li').forEach((li,j)=>li.classList.toggle('active',j===i));
  const p=P[i];
  document.getElementById('title').textContent=p.diagramName;
  document.getElementById('desc').textContent=p.description;

  // Breadcrumb
  const bc=document.getElementById('breadcrumb');
  if(navStack.length){
    const prev=P[navStack[navStack.length-1]];
    bc.innerHTML=`<a class="bc-link" onclick="navStack.pop();show(${navStack[navStack.length-1]===undefined?i:navStack[navStack.length-1]})">\u2190 ${esc(prev.diagramName)}</a>`;
  }else{
    bc.innerHTML='';
  }

  document.getElementById('content').innerHTML=renderProcess(p);
  document.getElementById('main').scrollTop=0;
}

show(0);
</script>
</body>
</html>

#!/bin/bash
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# NEW_PROJECT.SH ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –§–ú
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"
check_gum

header "–°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û –ü–†–û–ï–ö–¢–ê"

# –®–ê–ì 1: –ù–∞–∑–≤–∞–Ω–∏–µ
NAME=$(gum input --header "–ö–æ–¥–æ–≤–æ–µ –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞ (–ª–∞—Ç–∏–Ω–∏—Ü–∞, UPPER_CASE):" \
    --placeholder "–ù–∞–ø—Ä–∏–º–µ—Ä: INVENTORY_CONTROL")

# –í–∞–ª–∏–¥–∞—Ü–∏—è
NAME=$(echo "$NAME" | tr '[:lower:]' '[:upper:]' | tr ' ' '_' | tr -cd 'A-Z_')
if [[ -z "$NAME" ]]; then
    error "–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

PROJECT_DIR="${ROOT_DIR}/projects/PROJECT_${NAME}"
if [[ -d "$PROJECT_DIR" ]]; then
    error "–ü—Ä–æ–µ–∫—Ç PROJECT_${NAME} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    exit 1
fi

# –®–ê–ì 2: –û–ø–∏—Å–∞–Ω–∏–µ
DESC=$(gum input --header "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–ø–æ-—Ä—É—Å—Å–∫–∏):" \
    --placeholder "–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–Ω—Ç—Ä–æ–ª—å —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤")

# –®–ê–ì 3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 1–°
CONFIG=$(gum choose --header "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 1–°:" \
    "1–°:ERP" \
    "1–°:–£–¢" \
    "1–°:–ö–ê" \
    "1–°:–£–• + –£–¢" \
    "–î—Ä—É–≥–∞—è")

[[ "$CONFIG" == "–î—Ä—É–≥–∞—è" ]] && CONFIG=$(gum input --placeholder "–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...")

# –®–ê–ì 4: –ò—Å—Ç–æ—á–Ω–∏–∫ –§–ú
FM_SOURCE=$(gum choose --header "–û—Ç–∫—É–¥–∞ –±–µ—Ä–µ–º –§–ú?" \
    "1. –°–æ–∑–¥–∞–µ–º —Å –Ω—É–ª—è (Agent 0)" \
    "2. –ó–∞–≥—Ä—É–∂–∞—é –≥–æ—Ç–æ–≤—ã–π .docx —Ñ–∞–π–ª" \
    "3. –ü–æ–∫–∞ –±–µ–∑ –§–ú (—Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)")

# –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
subheader "–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã"

mkdir -p "${PROJECT_DIR}"/{FM_DOCUMENTS,CHANGES,AGENT_0_CREATOR,AGENT_1_ARCHITECT,AGENT_2_ROLE_SIMULATOR,AGENT_3_DEFENDER,AGENT_4_QA_TESTER,AGENT_5_TECH_ARCHITECT,AGENT_6_PRESENTER,AGENT_7_PUBLISHER,AGENT_8_BPMN_DESIGNER,REPORTS}

# README
cat > "${PROJECT_DIR}/README.md" <<EOF
# PROJECT_${NAME}

> **${DESC}**

## –ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| –ü—Ä–æ–µ–∫—Ç | PROJECT_${NAME} |
| –û–ø–∏—Å–∞–Ω–∏–µ | ${DESC} |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | ${CONFIG} |
| –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è | $(date '+%Y-%m-%d') |
| –í–µ—Ä—Å–∏—è –§–ú | ‚Äî |
| –°—Ç–∞—Ç—É—Å | üî¥ –ù–∞—á–∞–ª—å–Ω—ã–π |

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

\`\`\`
PROJECT_${NAME}/
‚îú‚îÄ‚îÄ README.md              ‚Üê –≠—Ç–æ—Ç —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ CONFLUENCE_PAGE_ID     ‚Üê ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã Confluence (–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
‚îú‚îÄ‚îÄ FM_DOCUMENTS/          ‚Üê –í—Å–µ –≤–µ—Ä—Å–∏–∏ –§–ú
‚îú‚îÄ‚îÄ CHANGES/               ‚Üê FM-*-CHANGES.md –ø–æ –≤–µ—Ä—Å–∏—è–º
‚îú‚îÄ‚îÄ AGENT_0_CREATOR/       ‚Üê –ß–µ—Ä–Ω–æ–≤–∏–∫ –§–ú
‚îú‚îÄ‚îÄ AGENT_1_ARCHITECT/     ‚Üê –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞
‚îú‚îÄ‚îÄ AGENT_2_ROLE_SIMULATOR/‚Üê –°–∏–º—É–ª—è—Ü–∏–∏ —Ä–æ–ª–µ–π
‚îú‚îÄ‚îÄ AGENT_3_DEFENDER/      ‚Üê –û—Ç–≤–µ—Ç—ã –Ω–∞ –∑–∞–º–µ—á–∞–Ω–∏—è
‚îú‚îÄ‚îÄ AGENT_4_QA_TESTER/     ‚Üê –¢–µ—Å—Ç-–∫–µ–π—Å—ã
‚îú‚îÄ‚îÄ AGENT_5_TECH_ARCHITECT/‚Üê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ + –¢–ó
‚îú‚îÄ‚îÄ AGENT_6_PRESENTER/     ‚Üê –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ AGENT_7_PUBLISHER/     ‚Üê –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Confluence
‚îú‚îÄ‚îÄ AGENT_8_BPMN_DESIGNER/ ‚Üê BPMN-–¥–∏–∞–≥—Ä–∞–º–º—ã –≤ Confluence
‚îî‚îÄ‚îÄ REPORTS/               ‚Üê –ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
\`\`\`
EOF

# PROJECT_CONTEXT.md
cat > "${PROJECT_DIR}/PROJECT_CONTEXT.md" <<EOF
# PROJECT_CONTEXT.md ‚Äî ${DESC}

> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–∞–º–∏

## –ü–∞—Å–ø–æ—Ä—Ç

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| –ù–∞–∑–≤–∞–Ω–∏–µ | ${DESC} |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | ${CONFIG} |
| –í–µ—Ä—Å–∏—è –§–ú | ‚Äî |
| –°—Ç–∞—Ç—É—Å | –ù–∞—á–∞–ª—å–Ω—ã–π |

## –ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç

_–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –§–ú (Agent 0) –∏–ª–∏ –∞—É–¥–∏—Ç–µ (Agent 1)_

## –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã

_–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏_

## –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

_–ü–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–∞–º–∏_
EOF

# CHANGELOG.md
cat > "${PROJECT_DIR}/CHANGELOG.md" <<EOF
# CHANGELOG ‚Äî PROJECT_${NAME}

## $(date '+%Y-%m-%d') ‚Äî –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${CONFIG}
EOF

# CONFLUENCE_PAGE_ID ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (Agent 7) (AG-08)
echo "# ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã Confluence (–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)" > "${PROJECT_DIR}/CONFLUENCE_PAGE_ID"

success "–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω: PROJECT_${NAME}"
echo ""
echo -e "  ${DIM}–°—Ç—Ä—É–∫—Ç—É—Ä–∞:${NC}"
echo -e "  ${PROJECT_DIR}/"
ls -1 "${PROJECT_DIR}/" | while read -r f; do
    echo -e "  ‚îú‚îÄ‚îÄ ${f}"
done
echo ""

# –ö–æ–ø–∏—Ä—É–µ–º .docx –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
if [[ "$FM_SOURCE" == "2."* ]]; then
    echo ""
    FM_FILE=$(gum file --header "–í—ã–±–µ—Ä–∏—Ç–µ .docx —Ñ–∞–π–ª:")
    if [[ -n "$FM_FILE" && -f "$FM_FILE" ]]; then
        cp "$FM_FILE" "${PROJECT_DIR}/FM_DOCUMENTS/"
        success "–§–ú —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: $(basename "$FM_FILE")"
    fi
fi

info "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∑–∞–ø—É—Å—Ç–∏—Ç–µ ./scripts/orchestrate.sh"

#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NEW_PROJECT.SH â€” Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¤Ðœ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"
check_gum

header "Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• ÐÐžÐ’ÐžÐ“Ðž ÐŸÐ ÐžÐ•ÐšÐ¢Ð"

# Ð¨ÐÐ“ 1: ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ
NAME=$(gum input --header "ÐšÐ¾Ð´Ð¾Ð²Ð¾Ðµ Ð¸Ð¼Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð»Ð°Ñ‚Ð¸Ð½Ð¸Ñ†Ð°, UPPER_CASE):" \
    --placeholder "ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: INVENTORY_CONTROL")

# Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ
NAME=$(echo "$NAME" | tr '[:lower:]' '[:upper:]' | tr ' ' '_' | tr -cd 'A-Z_')
if [[ -z "$NAME" ]]; then
    error "Ð˜Ð¼Ñ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼"
    exit 1
fi

PROJECT_DIR="${ROOT_DIR}/projects/PROJECT_${NAME}"
if [[ -d "$PROJECT_DIR" ]]; then
    error "ÐŸÑ€Ð¾ÐµÐºÑ‚ PROJECT_${NAME} ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    exit 1
fi

# Ð¨ÐÐ“ 2: ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ
DESC=$(gum input --header "ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ (Ð¿Ð¾-Ñ€ÑƒÑÑÐºÐ¸):" \
    --placeholder "ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ ÑÐºÐ»Ð°Ð´ÑÐºÐ¸Ñ… Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¾Ð²")

# Ð¨ÐÐ“ 3: ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ 1Ð¡
CONFIG=$(gum choose --header "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ 1Ð¡:" \
    "1Ð¡:ERP" \
    "1Ð¡:Ð£Ð¢" \
    "1Ð¡:ÐšÐ" \
    "1Ð¡:Ð£Ð¥ + Ð£Ð¢" \
    "Ð”Ñ€ÑƒÐ³Ð°Ñ")

[[ "$CONFIG" == "Ð”Ñ€ÑƒÐ³Ð°Ñ" ]] && CONFIG=$(gum input --placeholder "Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ...")

# Ð¨ÐÐ“ 4: Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¤Ðœ
FM_SOURCE=$(gum choose --header "ÐžÑ‚ÐºÑƒÐ´Ð° Ð±ÐµÑ€ÐµÐ¼ Ð¤Ðœ?" \
    "1. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ Ð½ÑƒÐ»Ñ (Agent 0)" \
    "2. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ .docx Ñ„Ð°Ð¹Ð»" \
    "3. ÐŸÐ¾ÐºÐ° Ð±ÐµÐ· Ð¤Ðœ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°)")

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
subheader "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹"

mkdir -p "${PROJECT_DIR}"/{FM_DOCUMENTS,AGENT_0_CREATOR,AGENT_1_ARCHITECT,AGENT_2_ROLE_SIMULATOR,AGENT_3_DEFENDER,AGENT_4_QA_TESTER,AGENT_5_TECH_ARCHITECT,AGENT_6_PRESENTER,AGENT_7_MIGRATOR,AGENT_8_EPC_DESIGNER,REPORTS}

# README
cat > "${PROJECT_DIR}/README.md" <<EOF
# PROJECT_${NAME}

> **${DESC}**

## ÐŸÐ°ÑÐ¿Ð¾Ñ€Ñ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

| ÐŸÐ¾Ð»Ðµ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
|------|----------|
| ÐŸÑ€Ð¾ÐµÐºÑ‚ | PROJECT_${NAME} |
| ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ | ${DESC} |
| ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ | ${CONFIG} |
| Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ | $(date '+%Y-%m-%d') |
| Ð’ÐµÑ€ÑÐ¸Ñ Ð¤Ðœ | â€” |
| Ð¡Ñ‚Ð°Ñ‚ÑƒÑ | ðŸ”´ ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ |

## Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°

\`\`\`
PROJECT_${NAME}/
â”œâ”€â”€ README.md              â† Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð»
â”œâ”€â”€ FM_DOCUMENTS/          â† Ð’ÑÐµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¤Ðœ
â”œâ”€â”€ AGENT_0_CREATOR/       â† Ð§ÐµÑ€Ð½Ð¾Ð²Ð¸Ðº Ð¤Ðœ
â”œâ”€â”€ AGENT_1_ARCHITECT/     â† Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð°ÑƒÐ´Ð¸Ñ‚Ð°
â”œâ”€â”€ AGENT_2_ROLE_SIMULATOR/â† Ð¡Ð¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¸ Ñ€Ð¾Ð»ÐµÐ¹
â”œâ”€â”€ AGENT_3_DEFENDER/      â† ÐžÑ‚Ð²ÐµÑ‚Ñ‹ Ð½Ð° Ð·Ð°Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ
â”œâ”€â”€ AGENT_4_QA_TESTER/     â† Ð¢ÐµÑÑ‚-ÐºÐµÐ¹ÑÑ‹
â”œâ”€â”€ AGENT_5_TECH_ARCHITECT/â† ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° + Ð¢Ð—
â”œâ”€â”€ AGENT_6_PRESENTER/     â† ÐŸÑ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
â”œâ”€â”€ AGENT_7_MIGRATOR/      â† ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð² Confluence
â”œâ”€â”€ AGENT_8_EPC_DESIGNER/  â† ePC Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ (Miro ÑÑÑ‹Ð»ÐºÐ¸)
â””â”€â”€ REPORTS/               â† Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹
\`\`\`
EOF

# PROJECT_CONTEXT.md
cat > "${PROJECT_DIR}/PROJECT_CONTEXT.md" <<EOF
# PROJECT_CONTEXT.md â€” ${DESC}

> ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð°Ð³ÐµÐ½Ñ‚Ð°Ð¼Ð¸

## ÐŸÐ°ÑÐ¿Ð¾Ñ€Ñ‚

| ÐŸÐ¾Ð»Ðµ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
|------|----------|
| ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ | ${DESC} |
| ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ | ${CONFIG} |
| Ð’ÐµÑ€ÑÐ¸Ñ Ð¤Ðœ | â€” |
| Ð¡Ñ‚Ð°Ñ‚ÑƒÑ | ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ |

## Ð‘Ð¸Ð·Ð½ÐµÑ-ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚

_Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¤Ðœ (Agent 0) Ð¸Ð»Ð¸ Ð°ÑƒÐ´Ð¸Ñ‚Ðµ (Agent 1)_

## Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

_ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸_

## ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹

_ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð°Ð³ÐµÐ½Ñ‚Ð°Ð¼Ð¸_
EOF

# CHANGELOG.md
cat > "${PROJECT_DIR}/CHANGELOG.md" <<EOF
# CHANGELOG â€” PROJECT_${NAME}

## $(date '+%Y-%m-%d') â€” ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½
- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ð°Ð¿Ð¾Ðº
- ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ: ${CONFIG}
EOF

success "ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½: PROJECT_${NAME}"
echo ""
echo -e "  ${DIM}Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°:${NC}"
echo -e "  ${PROJECT_DIR}/"
ls -1 "${PROJECT_DIR}/" | while read -r f; do
    echo -e "  â”œâ”€â”€ ${f}"
done
echo ""

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .docx ÐµÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½
if [[ "$FM_SOURCE" == "2."* ]]; then
    echo ""
    FM_FILE=$(gum file --header "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ .docx Ñ„Ð°Ð¹Ð»:")
    if [[ -n "$FM_FILE" && -f "$FM_FILE" ]]; then
        cp "$FM_FILE" "${PROJECT_DIR}/FM_DOCUMENTS/"
        success "Ð¤Ðœ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°: $(basename "$FM_FILE")"
    fi
fi

info "Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³: Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ./scripts/orchestrate.sh"

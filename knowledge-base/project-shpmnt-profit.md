# Проект «Контроль рентабельности отгрузок» (FM-LS-PROFIT)

> Источник: Confluence PAGE_ID 83951683, проект PROJECT_SHPMNT_PROFIT

## Суть проекта

Контроль рентабельности при частичных отгрузках по Локальным сметам (ЛС) в 1С:УТ 10.2.

**Проблема:** Cherry-picking — клиенты выборочно выкупают низкомаржинальные позиции из ЛС, оставляя высокомаржинальные. Компания теряет прибыль.

**Решение:** Автоматический контроль маржинальности каждой отгрузки относительно плана ЛС. Если отгрузка снижает рентабельность ниже порога — согласование руководством.

## Ключевые бизнес-правила

### Пороги контроля
- Расчётная маржинальность = (Цена – НПСС) / Цена
- Целевая маржинальность — из SBS-59 (регистр)
- Отклонение > порога → согласование (РБЮ → ФД → ГД)

### SLA согласования
- P1 (< 100 т.р.): 2ч / 4ч / 12ч
- P2 (100 т.р. – 1 млн): удвоенные сроки
- P3 (> 1 млн): индивидуально

### Автосогласование
- Отклонение < 1 п.п. → автосогласование
- Лимит: 5 000 руб/день на менеджера, 20 000 руб/день агрегированный
- Лимит на БЮ: 100 000 руб/день

### Экстренные отгрузки
- До 10/мес в пиковые периоды
- Постфактум-контроль в течение 24ч/48ч

### Резервный режим ELMA
- При недоступности ELMA: автосогласование до 5 п.п., свыше — очередь FIFO

### Автотриггеры НПСС
- Курс ЦБ РФ изменился > 5%
- Закупочная цена отклонилась > 15%

## Пользователи

| Роль | Количество | Действия |
|------|-----------|----------|
| Менеджер по продажам | ~50 | Создание ЛС, отгрузки, корректировка цен |
| РБЮ (руководитель бизнес-юнита) | ~10 | Согласование отгрузок |
| Финансовый директор | 1-2 | Согласование крупных отклонений |
| Генеральный директор | 1 | Финальное согласование |
| Аналитик | 2-3 | Отчёты, мониторинг |

## Связь с проектом Себестоимость (SBS)

Наша ФМ — **надстройка над SBS**:

| Компонент SBS | Как используется в FM-LS-PROFIT |
|---------------|--------------------------------|
| НПСС (SBS-58) | Входные данные для расчёта маржинальности |
| Целевая маржинальность (SBS-59) | Ориентир для менеджера |
| Фактическая рентабельность (SBS-63) | Сверка план/факт при закрытии месяца |
| Внутренние цены (SBS-130) | Влияет на себестоимость товара от производства |
| ТТК по странам (SBS-58) | Входит в расчёт НПСС |

**Ключевое отличие:** SBS работает при закрытии периода (постфактум). Наша ФМ работает в реальном времени (превентивный контроль).

## Текущая версия

- **Версия ФМ:** 1.0.6
- **Confluence PAGE_ID:** 83951683
- **ТЗ PAGE_ID:** 86049548
- **Архитектура PAGE_ID:** 86049550
- **Платформа:** 1С:УТ 10.2 на платформе 8.3
- **Реализация:** через расширение (.cfe)
- **Оценка трудоёмкости:** 2758ч (P1 MVP: 2350ч, P2: 408ч)
- **Команда:** 3 разработчика + 1 аналитик + 1 тестировщик
- **Срок:** ~6 месяцев

## История версий ФМ

| Версия | Дата | Что изменилось |
|--------|------|----------------|
| 1.0.0 | 28.01.2026 | Первая стабильная версия |
| 1.0.1 | 09.02.2026 | 12 правок по аудиту |
| 1.0.2 | 16.02.2026 | 23 правки по бизнес-ревью + ответы на 25 замечаний |
| 1.0.3 | 17.02.2026 | 5 UX-улучшений + 16 правок бизнес-критики |
| 1.0.4 | 20.02.2026 | 10 правок повторного аудита |
| 1.0.5 | 25.02.2026 | 11 документарных правок (таймаут 5 мин, пороги, грамматика) |
| 1.0.6 | 26.02.2026 | Зависимости от SBS (SBS-58/59/63/130), формула НПСС → SBS-58 (6 мес), счёт P1 68 |

## 143 объекта архитектуры (v1.0.6)

- 6 справочников, 6 документов
- 5 регистров накопления, 13 регистров сведений
- 15 отчётов, 5 бизнес-процессов
- 20 фоновых заданий, 6 интеграций
- 9 ролей, 11 перечислений, 10 констант
- 6 функциональных опций
- 25 контрольных точек мониторинга

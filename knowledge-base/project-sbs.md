# Проект «Себестоимость» (SBS)

> Источник: Jira SBS (145 issues), Confluence space EW, 7 ЧТЗ в DOCX

## Суть
Комплексная доработка 1С:УТ 10.2 для управления полной себестоимостью и рентабельностью продаж.
От закупки импортного товара до закрытия периода с фиксацией фактической маржинальности.

## 9 ЧТЗ

| Код | Название | Статус | Суть |
|-----|----------|--------|------|
| SBS-31 | ПТС | Тестирование | Поступление товаров на склад (базовый процесс) |
| SBS-57 | Закрытие месяца | Разработка | 6-шаговый визард: запреты → последовательность → НПСС → рентабельность → перенос → общий запрет |
| SBS-58 | НПСС | Разработка | Расчёт нормативной плановой себестоимости |
| SBS-59 | Цены/скидки | Согласование | Целевая маржинальность + максимальные скидки + загрузка из Excel |
| SBS-60 | ВЭД показатели | Разработка | Показатели внешнеэкономической деятельности |
| SBS-61 | Контроли сборки | Готово | Контроль варианта комплектации по хозоперации |
| SBS-63 | Тех. закрытие | Готово | Восстановление последовательности + история рентабельности |
| SBS-129 | ВЭД документы | Согласовано | Файлы поставки: инвойсы, ГТД, счета → привязка к УЛ |
| SBS-130 | Внутренние цены | Согласование | Приход по внутренним трансфертным ценам (ERP→УТ) |

## Ключевые формулы

- **НПСС** = ЦЗсредняя × ТТК_страна (ЦЗ = средневзвешенная цена закупки за 6 мес., ТТК = транспортно-таможенный коэффициент по стране)
- **Маржинальность расчётная** = (Цена – НПСС) / Цена
- **Маржинальность фактическая** = (Цена – Себестоимость) / Цена
- **Внутренняя стоимость** = Внутренняя цена × Количество (в регистр Партий)

## Ключевые объекты (создаются)

### Справочники
- Файлы согласования БЦ, маржинальности и скидок
- Файлы поставки (ВЭД)
- Страны отгрузки (для НПСС)

### Документы
- Регистрация целевой маржинальности
- Установка максимальных скидок

### Регистры
- РС «НПСС» (нормативная плановая себестоимость)
- РС «Коэффициенты ТТК» (транспортно-таможенные по странам)
- РС «Целевая маржинальность»
- РС «Максимальные скидки»
- РС «История изменения рентабельности РТУ»
- РС «Сеансы восстановления последовательности»
- РС «Протокол восстановления последовательности»

### Обработки
- Расчёт НПСС (SBS-58)
- Процедуры закрытия месяца — 6-шаговый визард (SBS-57)
- Перенос отгрузочных документов в рабочий период (SBS-57)
- Восстановление последовательности EKF (SBS-63)
- Расчёт фактической рентабельности сделок (SBS-63)
- Регистрация БЦ, маржинальности и скидок (SBS-59)

### Отчёты
- Анализ расчёта НПСС (4 отчёта)
- Анализ изменений маржинальности (SBS-57)
- Анализ маржинальности и скидок (SBS-59, 2 варианта)
- Отчёт по файлам поставки (SBS-129)

## Связь с проектом «Контроль рентабельности отгрузок»

Наш проект (PROJECT_SHPMNT_PROFIT) — это **надстройка над SBS**:
- SBS создаёт инфраструктуру расчёта себестоимости (НПСС, рентабельность, скидки)
- Наша ФМ добавляет **контроль рентабельности в момент отгрузки** — до закрытия месяца
- НПСС из SBS-58 используется в нашей ФМ для расчётной маржинальности
- Целевая маржинальность из SBS-59 — ориентир для менеджера
- Наш проект работает в реальном времени, SBS — при закрытии периода

## Цикл закрытия месяца (SBS-57)

1. Установка дат запрета по группам пользователей
2. Восстановление последовательности партионного учёта (SBS-63)
3. Расчёт НПСС (SBS-58)
4. Расчёт фактической рентабельности (SBS-63)
5. Перенос незавершённых отгрузок в рабочий период
6. Установка общей даты запрета

## Даты запрета редактирования (SBS-57)

Расширенный механизм: 20+ типов документов, 10 разделов (Продажи, Закупки, Склад, Банк, Касса, Взаиморасчеты, CRM, Авансовые отчеты, Ценообразование, Регламентные операции, Производство, Проекты).
Приоритет: пользователь > группа > общая. По типу документа > по разделу > все.

## Внутренние цены (SBS-130)

Товар от производства (1С ERP) приходит в торговлю (1С УТ) по внутренним трансфертным ценам.
В регистр «Партии товаров» записывается внутренняя цена × количество.
В бухгалтерию (1С БП) уходят прежние отгрузочные цены — интеграция не меняется.

## Контроли сборки (SBS-61)

Вариант комплектации привязан к хозоперации. При выборе номенклатуры — автоподбор правильного варианта. При сохранении — блокировка несоответствующего варианта.

## Команда
- Крот А.А. — руководитель проекта
- Кривошей А.Н. — функциональный архитектор, аналитик
- Борисенко И.Н. — ведущий разработчик
- Сагалакова Н.К. — консультант-аналитик

# Аудит multi-agent системы FM Review

> **Роль:** Ведущий аудитор multi-agent систем. Только констатация и рекомендации, без изменений кода.
> **Дата:** 06.02.2026  
> **Основа:** репозиторий fm-review-system (дерево файлов, агенты, правила, скрипты, docs).

---

## RE-AUDIT: повторная проверка (после исправлений)

Проверка актуального состояния репозитория: что исправлено, что остаётся, что сломалось после переименований.

### Исправлено

| ID | Что сделано |
|----|-------------|
| **AG-09** | Workflow приведён к BPMN: в `workflows/fm-workflows.md` Agent 8 описан как «BPMN в Confluence (drawio)», команды `/publish`, `/bpmn`. Miro/ePC убраны из основного сценария. |
| **Нейминг агентов** | Файлы переименованы: `AGENT_7_PUBLISHER.md`, `AGENT_8_BPMN_DESIGNER.md` (вместо MIGRATOR/EPC_DESIGNER). Роли в CLAUDE.md обновлены. |
| **Верификация** | В CLAUDE.md явно закреплено правило 6 (GET после PUT, проверка контента) и правило 11 (план изменений → подтверждение → PUT). |

### Остаётся открытым

| ID | Текущее состояние |
|----|-------------------|
| **AG-01** | Скрипты `agent0_new.sh`, `agent1_audit.sh`, … `agent5_architect.sh` по-прежнему **отсутствуют** в `scripts/`. Оркестратор их вызывает — пункты 2–7 меню падают при выборе. |
| **AG-02** | `quality_gate.sh` и `get_latest_fm()` без изменений: проверка FM_DOCUMENTS, поиск .docx/.md. Confluence не используется в гейте. |
| **AG-03** | В агентах 1–5 по-прежнему: «ПОСЛЕ /apply: Обновление ФМ → Confluence (PUT API)». Единственный писатель страницы не формализован. |
| **AG-04** | `CONTEXT_FILE="${ROOT_DIR}/.interview_context.txt"` — один файл на репозиторий. |
| **AG-05** | Два места контекста: `docs/PROJECT_CONTEXT.md` и `projects/…/PROJECT_CONTEXT.md`. |
| **AG-06** | В `projects/PROJECT_SHPMNT_PROFIT/` папки **CHANGES/** нет; *-CHANGES.md лежат в FM_DOCUMENTS/. |
| **AG-07** | quality_gate по-прежнему: `grep "CRITICAL.*Открыт"`, `"HIGH.*Открыт"`. |
| **AG-08** | Файла `CONFLUENCE_PAGE_ID` в проекте нет; скрипты используют env/дефолт. |
| **AG-10** | В самих файлах агентов 1–5 шаг верификации после PUT не прописан (есть только в общих правилах CLAUDE). |

### Новая регрессия после переименования

| Проблема | Evidence | Последствие |
|----------|----------|--------------|
| **Ссылки на старые имена агентов** | В `scripts/orchestrate.sh`: `PIPELINE_FILES` содержит `AGENT_7_MIGRATOR`, `AGENT_8_EPC_DESIGNER`; пункты 9 и 10 вызывают `AGENT_7_MIGRATOR.md`, `AGENT_8_EPC_DESIGNER.md`. Файлов с такими именами **нет** (есть только AGENT_7_PUBLISHER.md, AGENT_8_BPMN_DESIGNER.md). | При выборе «Полный цикл» с этапами 7 или 8 и при выборе пунктов 9 или 10 в меню запуск падает (файл не найден). |
| **PROMPTS.md** | Указаны `agents/AGENT_7_MIGRATOR.md`, `agents/AGENT_8_EPC_DESIGNER.md`. | Промпты ведут на несуществующие файлы. |
| **quality_gate.sh** | В списке агентов: `AGENT_7_MIGRATOR`, `AGENT_8_EPC_DESIGNER` (имена **папок** в проекте). Папки в new_project.sh создаются с этими именами — здесь расхождение только в том, что в quality_gate подпись «ePC диаграмма» устарела. Файлы агентов скрипт не открывает, только проверяет каталоги — логика гейта не падает, но названия в выводе устаревшие. |

**Итог повторной проверки (обновлено 06.02.2026):** Регрессия после переименования устранена: orchestrate.sh, PROMPTS.md, quality_gate.sh и AGENT_6_PRESENTER.md обновлены; созданы скрипты agent0_new.sh … agent5_architect.sh; в пайплайне для Agent 7/8 передаются /publish и /bpmn. Остальные риски (AG-02–AG-08, AG-10) по-прежнему в списке открытых — см. раздел «Остаётся открытым» выше.

---

## 0) EXEC_SUMMARY

- **Масштабируемость:** **Нет** в текущем виде. Причины: (1) оркестратор вызывает отсутствующие скрипты `agent0_new.sh` … `agent5_architect.sh` — пайплайн падает; (2) два конкурирующих источника истины (Confluence по правилам vs FM_DOCUMENTS/Word в скриптах и quality_gate); (3) шесть агентов имеют право писать в одну и ту же Confluence-страницу без протокола блокировок/очереди.
- **Топ-3 системных риска:**  
  1. **Рассинхрон источника истины** — документация и CLAUDE объявляют Confluence единственным источником ФМ, при этом `quality_gate.sh`, `get_latest_fm`, `orchestrate.sh` и часть скриптов завязаны на `FM_DOCUMENTS/` и .docx; при автономном запуске агенты и гейты могут опираться на разные артефакты.  
  2. **Write-collision в Confluence** — агенты 0, 1, 2, 3, 4, 5 в своих инструкциях после `/apply` предписывают «Обновление ФМ → Confluence (PUT API)»; единого владельца записи (только Agent 7) нет; параллельный или последовательный запуск без координации может перезаписывать страницу.  
  3. **Отсутствующая спецификация запуска** — скрипты `agent0_new.sh`, `agent1_audit.sh`, `agent2_simulate.sh`, `agent3_defend.sh`, `agent4_test.sh`, `agent5_architect.sh` вызываются из `orchestrate.sh`, но в репозитории отсутствуют; полный цикл из меню невыполним.

---

## 1) AGENTS_MAP

| AgentName | Purpose | Inputs | Outputs | AllowedDecisions | MustEscalate |
|-----------|---------|--------|---------|------------------|--------------|
| Agent 0 (Creator) | Создание ФМ с нуля, интервью, структура, наполнение | PROJECT_CONTEXT, ответы интервью, .interview_context.txt | Контент ФМ (для Confluence), PROJECT_[NAME]/, при /auto — передача Agent 7 | Структура разделов, формулировки, экспорт-формат | Смена канонического формата ФМ, создание нового проекта без подтверждения |
| Agent 1 (Architect) | Полный аудит ФМ (бизнес + 1С), поиск дыр и манипуляций | Confluence (PAGE_ID), PROJECT_CONTEXT, AGENT_* | AGENT_1_ARCHITECT/*.md, findings (CRITICAL/HIGH/MED/LOW), при /apply — правки в Confluence | Классификация замечаний, предложение правок | Применение всех правок без выбора пользователя (должен спросить какие применить) |
| Agent 2 (Role Simulator) | Симуляция ролей, UX, обходы | Confluence, AGENT_1_ARCHITECT, PROJECT_CONTEXT | AGENT_2_ROLE_SIMULATOR/*.md, UX findings, при /apply — правки в Confluence | Приоритизация UX-правок | Изменение структуры документа |
| Agent 3 (Defender) | Ответы на замечания, классификация A–I | AGENT_1/2/4, Confluence, PROJECT_CONTEXT | AGENT_3_DEFENDER/*.md, ответы, при /apply — правки в Confluence | Классификация (A–I), аргументация | Принятие/отклонение замечаний без явного решения пользователя |
| Agent 4 (QA Tester) | Тест-кейсы, покрытие, манипуляции | AGENT_1/2, Confluence, PROJECT_CONTEXT | AGENT_4_QA_TESTER/*.md, тесты, при /apply — правки в Confluence | Приоритет тестов, формулировки кейсов | Изменение требований ФМ без трассировки к finding |
| Agent 5 (Tech Architect) | Архитектура 1С, ТЗ, оценка | AGENT_1/2/4, Confluence, PROJECT_CONTEXT | AGENT_5_TECH_ARCHITECT/*.md, ТЗ, при /apply — техтребования в Confluence | Выбор решений 1С, оценка | Изменение бизнес-правил (это зона Agent 1) |
| Agent 6 (Presenter) | Презентации, отчёты, экспорт | Все AGENT_*/, Confluence, PROJECT_CONTEXT | AGENT_6_PRESENTER/*, summary, roadmap, pptx; не пишет в Confluence (делегирует Agent 7) | Выбор формата и аудитории | Публикация в Confluence (только Agent 7) |
| Agent 7 (Migrator) | Публикация/обновление ФМ в Confluence, XHTML, версии | PAGE_ID, контент от агентов 0–5, PROJECT_CONTEXT | Confluence (PUT/POST), AGENT_7_MIGRATOR/*, обновление PROJECT_CONTEXT (URL) | Идемпотентность (GET перед PUT), комментарий версии | Создание страницы в другом space без подтверждения |
| Agent 8 (EPC/BPMN Designer) | BPMN 2.0, drawio, публикация в Confluence | Confluence (ФМ), AGENT_1/2/7, bpmn-processes/*.json | JSON в scripts/bpmn-processes/, drawio в scripts/output/, вложения Confluence | Выбор нотации и разметки BPMN | Изменение текста ФМ на странице (только контент диаграмм) |

---

## 2) FINDINGS

### AG-01 — Отсутствуют скрипты интервью агентов
- **Severity:** High  
- **Evidence:** `scripts/orchestrate.sh` строки 147, 163, 172, 180, 188, 196 вызывают `agent0_new.sh`, `agent1_audit.sh`, `agent2_simulate.sh`, `agent3_defend.sh`, `agent4_test.sh`, `agent5_architect.sh`. В `scripts/` этих файлов нет (проверено list_dir и grep).  
- **Risk:** Запуск «Полный цикл review» или отдельных пунктов 2–7 завершится ошибкой bash.  
- **Failure mode:** Пользователь выбирает агента в меню → скрипт не найден → пайплайн не стартует.  
- **What to formalize:** Спецификация: либо реализовать все перечисленные скрипты, либо убрать вызовы и заменить единым способом передачи контекста (например, только через PROJECT_CONTEXT + промпт в буфер).

### AG-02 — Два конкурирующих источника истины по ФМ
- **Severity:** High  
- **Evidence:** CLAUDE.md и агенты: «Confluence = единственный источник ФМ», «ЗАПРЕЩЕНО читать из Word/DOCX». Одновременно: `scripts/lib/common.sh` — `get_latest_fm()` ищет ФМ в `projects/$1/FM_DOCUMENTS` по .docx/.md; `scripts/quality_gate.sh` требует `FM_DOCUMENTS/` и вызывает `get_latest_fm`; `orchestrate.sh` передаёт `FM_PATH` (локальный файл) в контекст; `publish_to_confluence.py` содержит захардкоженный DOC_PATH к .docx.  
- **Risk:** Quality Gate и оркестратор считают «последнюю ФМ» по файловой системе; агенты по инструкции читают Confluence. Версии и содержание могут разойтись.  
- **Failure mode:** После правок в Confluence агент 1/2/4/5 не обновлял Word; quality_gate проверяет Word; гейт проходит по устаревшему артефакту или падает из-за отсутствия .docx.  
- **What to formalize:** Единый контракт: либо (a) только Confluence — тогда quality_gate и get_latest_fm должны опираться на PAGE_ID и API (без обязательного FM_DOCUMENTS), либо (b) явно два режима (Confluence-only vs legacy Word) с разными путями и гейтами.

### AG-03 — Множественная запись в одну Confluence-страницу без владельца
- **Severity:** High  
- **Evidence:** В каждом из агентов 0–5 в секции «ПОСЛЕ /apply» указано: «Обновление ФМ → Confluence (PUT API)». Agent 7 описан как эксперт по Confluence, но ни в CLAUDE, ни в агентах нет правила «только Agent 7 выполняет PUT тела страницы ФМ».  
- **Risk:** Два агента подряд делают /apply: каждый GET → правки → PUT. Второй PUT может перезаписать правки первого (lost update).  
- **Failure mode:** Agent 1 вносит правки по аудиту → Agent 2 вносит UX-правки поверх старой версии страницы → правки Agent 1 теряются.  
- **What to formalize:** Протокол записи: единственный писатель тела страницы ФМ — Agent 7; агенты 0–5 при /apply формируют патч/список изменений и передают Agent 7 (или в очередь), либо явный lock/version check перед PUT.

### AG-04 — Контекст интервью в одном глобальном файле
- **Severity:** Med  
- **Evidence:** `scripts/lib/common.sh`: `CONTEXT_FILE="${ROOT_DIR}/.interview_context.txt"` — один файл на весь репозиторий. `orchestrate.sh` и `export_miro.sh` пишут в него. Agent 1 читает `.interview_context.txt` при /audit.  
- **Risk:** Запуск двух сессий (два проекта или два агента подряд) перезаписывает контекст; второй агент получает чужие ответы.  
- **Failure mode:** Пользователь запускает Agent 1 для проекта A, затем Agent 2 для проекта B; контекст Agent 2 перезаписывает файл; при следующем /audit Agent 1 читает контекст проекта B.  
- **What to formalize:** Контекст на проект или на сессию: например `.interview_context_${PROJECT}.txt` или передача контекста только через константы в промпте без общего файла.

### AG-05 — Два разных места PROJECT_CONTEXT
- **Severity:** Med  
- **Evidence:** CLAUDE.md (раздел автосохранение): «файлы в папке docs/ (docs/PROJECT_CONTEXT.md, docs/CHANGELOG.md, docs/WORKPLAN.md)». Агенты 0–8: «читаю PROJECT_[NAME]/PROJECT_CONTEXT.md», «дополнить PROJECT_CONTEXT.md» в проекте. В репозитории: `docs/PROJECT_CONTEXT.md` — объёмный контекст с историей; `projects/PROJECT_SHPMNT_PROFIT/PROJECT_CONTEXT.md` — короткий файл, в нём упоминаются Notion/Miro (устаревшие).  
- **Risk:** Агенты обновляют проектный файл; человек или отчёты смотрят docs — рассинхрон. Или наоборот: контекст накапливается в docs, агенты читают пустой/короткий проектный.  
- **Failure mode:** Решения и открытые вопросы фиксируются только в docs/PROJECT_CONTEXT.md; агент в следующей сессии читает projects/…/PROJECT_CONTEXT.md и не видит решений.  
- **What to formalize:** Один канон: либо один файл на проект (projects/PROJECT_*/PROJECT_CONTEXT.md) с обязательным обновлением при каждой сессии, либо один глобальный (docs) с явной привязкой по имени проекта; и синхронизация/отказ от дублирования.

### AG-06 — Папка CHANGES не используется по правилу
- **Severity:** Med  
- **Evidence:** CLAUDE.md: «CHANGES/ в PROJECT_[NAME]/», «FM-*-CHANGES.md в CHANGES/». В PROJECT_SHPMNT_PROFIT папки CHANGES/ нет; файлы *-CHANGES.md лежат в FM_DOCUMENTS/ (например FM-SHPMNT-PROFIT-v2.5.5-CHANGES.md).  
- **Risk:** Поиск «всех изменений» по правилу ведёт в пустую CHANGES/; реальная история в другом месте.  
- **Failure mode:** Автоматизация или человек ожидает CHANGES в проекте и не находит; дублирование артефактов в FM_DOCUMENTS.  
- **What to formalize:** Либо перенести все FM-*-CHANGES.md в PROJECT_[NAME]/CHANGES/ и обновить скрипты/агентов, либо зафиксировать в правиле, что CHANGES хранятся в FM_DOCUMENTS (и убрать упоминание CHANGES/).

### AG-07 — Quality Gate проверяет открытые CRITICAL/HIGH по тексту
- **Severity:** Low  
- **Evidence:** `quality_gate.sh`: подсчёт `OPEN_CRITICAL`/`OPEN_HIGH` через `grep -c "CRITICAL.*Открыт"` и `"HIGH.*Открыт"` в AGENT_1_ARCHITECT/*.md.  
- **Risk:** Формат отчёта изменился (например «Открыт» заменён на «Open» или статус в таблице) — гейт даёт ложный pass или fail.  
- **Failure mode:** Все замечания закрыты, но формулировка без слова «Открыт» — гейт всё равно считает открытые.  
- **What to formalize:** Машиночитаемый формат статуса findings (например метка в одной строке или отдельный JSON) и парсинг по нему, а не по свободному тексту.

### AG-08 — CONFLUENCE_PAGE_ID в нескольких местах без единого источника
- **Severity:** Med  
- **Evidence:** Agent 7: «PAGE_ID из PROJECT_[NAME]/CONFLUENCE_PAGE_ID» (файл); `publish_to_confluence.py`, `export_from_confluence.py` и др.: `os.environ.get("CONFLUENCE_PAGE_ID", "83951683")`; `publish-bpmn.py` и часть скриптов — из .env или config.  
- **Risk:** Смена проекта или страницы: обновляют только один источник; скрипты или агенты берут старый PAGE_ID.  
- **Failure mode:** В проекте создан новый Confluence-лист, PAGE_ID записан в файл проекта, но скрипты без env подставляют дефолт 83951683 → запись в чужую страницу.  
- **What to formalize:** Один источник PAGE_ID на проект: например только файл PROJECT_[NAME]/CONFLUENCE_PAGE_ID, а скрипты всегда получают его через аргумент или чтение этого файла (без дефолта по другому проекту).

### AG-09 — Workflow и реальные команды Agent 8 расходятся
- **Severity:** Low  
- **Evidence:** `workflows/fm-workflows.md`: «Agent 8 (EPC Design) | ePC в Miro → embed в Confluence». В `agents/AGENT_8_EPC_DESIGNER.md`: BPMN 2.0, generate-bpmn.js, drawio, публикация в Confluence через publish-bpmn.py; Miro не фигурирует как основной выход.  
- **Risk:** Пользователь по workflow ожидает Miro; по факту агент и скрипты работают с Confluence drawio.  
- **Failure mode:** Документация по сценарию «ePC в Miro» не соответствует коду и роли агента.  
- **What to formalize:** Привести workflow в соответствие с реализацией (BPMN/drawio/Confluence) или явно описать legacy Miro и переход на BPMN.

### AG-10 — Верификация после /apply не гарантирована всеми агентами
- **Severity:** Med  
- **Evidence:** CLAUDE.md правило 6: после обновления Confluence — GET, проверка отсутствия старых значений и наличия новых. В описаниях агентов 1–5 при /apply указано «обновление ФМ → Confluence», но пошаговая верификация (GET + проверка контента) закреплена только в инструкциях Agent 7.  
- **Risk:** Агент 1/2/3/4/5 выполняет PUT, но не проверяет результат; ошибка API или частичная запись остаётся незамеченной.  
- **Failure mode:** PUT вернул 200, но из-за размера или макроса контент обрезан; агент сообщает «готово» без верификации.  
- **What to formalize:** Общее правило: любой агент, инициирующий изменение Confluence (напрямую или через вызов), должен либо сам выполнять GET и проверку, либо делегировать верификацию Agent 7 с явным контрактом (например Agent 7 /verify после каждого /apply от 1–5).

---

## 3) LOGIC_GAPS

- **Циклы без гарантированного выхода:** Бизнес-согласование (ЭТАП 4): цикл «Agent 3 → Agent 0 доработка → Agent 7 /sync» до снятия замечаний. Критерий «все замечания сняты» не формализован (нет машинного статуса или гейта); теоретически цикл может повторяться без перехода в Approved.  
- **Шаги без единственного владельца:** Запись тела страницы ФМ в Confluence — владелец не назначен (см. AG-03). Обновление PROJECT_CONTEXT после сессии — несколько агентов его «дополняют», формат и место размыты (AG-05).  
- **Решения без критериев:** Выбор «какие замечания применить» (все / только критические / номера) остаётся на пользователя; при /auto агенты могут применять «все» или «по умолчанию» без явного критерия в спецификации.  
- **Состояния без проверяемости:** Статусы «Draft», «Review», «Approved» упомянуты в workflow и в Confluence (макрос status), но quality_gate и скрипты их не проверяют; нет контракта «считаем согласование завершённым, если …».

---

## 4) STRUCTURE_RISKS

- **Single source of truth:**  
  - ФМ: заявлен Confluence, но FM_DOCUMENTS и get_latest_fm/quality_gate опираются на файлы (см. AG-02).  
  - Контекст проекта: раздвоение docs/PROJECT_CONTEXT.md и projects/…/PROJECT_CONTEXT.md (AG-05).  
- **Write-collisions:**  
  - Одна Confluence-страница ФМ: потенциальные писатели 0, 1, 2, 3, 4, 5, 7 (AG-03).  
  - Один .interview_context.txt для всех проектов/агентов (AG-04).  
- **Missing specs:**  
  - Отсутствуют скрипты agent0_new.sh … agent5_architect.sh (AG-01).  
  - Нет явного протокола «кто когда пишет в Confluence» и «кто верифицирует после записи».

---

## 5) TOP10_RISKS (Impact × Likelihood, упрощённо)

1. **Рассинхрон Confluence vs Word/FM_DOCUMENTS** — высокий impact (неверная версия ФМ), высокая вероятность при использовании и скриптов, и агентов.  
2. **Потеря правок при нескольких /apply в Confluence** — высокий impact, средняя вероятность при ручном последовательном запуске без перезагрузки страницы.  
3. **Падение полного цикла из-за отсутствующих скриптов** — средний impact (пайплайн не стартует), высокая вероятность при выборе пунктов 2–7 в orchestrate.sh.  
4. **Неверный PAGE_ID при смене проекта** — высокий impact (запись в чужую страницу), средняя вероятность.  
5. **Рассинхрон контекста (docs vs project PROJECT_CONTEXT)** — средний impact, высокая вероятность при регулярной работе.  
6. **Перезапись .interview_context.txt при двух сессиях** — средний impact, средняя вероятность.  
7. **Цикл бизнес-согласования без критерия выхода** — средний impact, низкая вероятность при руком управлении.  
8. **Отсутствие верификации после PUT у агентов 1–5** — средний impact (тихие ошибки записи), средняя вероятность.  
9. **Quality Gate на свободном тексте (CRITICAL/HIGH)** — низкий impact, средняя вероятность.  
10. **Путаница Miro vs BPMN/Confluence в документации** — низкий impact, в основном для новых пользователей.

---

## 6) HUMAN_IN_LOOP

- **Выбор объёма применяемых правок после аудита/симуляции/тестов:** Agent 1/2/4 при /apply должны спрашивать «все / только критические / конкретные номера». Решение должен принять человек; без этого возможны массовые автоматические правки по умолчанию.  
- **Подтверждение записи в Confluence:** Перед первым PUT новой страницы или смены PAGE_ID нужен явный подтверждающий шаг (например dry-run и «опубликовать?»), иначе агент может создать страницу в неверном space.  
- **Бизнес-согласование:** Переход в «Approved» и «отправка на согласование» — решения человека; агенты только меняют контент и статус по команде.  
- **Создание нового проекта и назначение CONFLUENCE_PAGE_ID:** Создание папки и привязка к странице Confluence должны быть за человеком (или чётким контрактом с созданием страницы через API с подтверждением).  
- **Разрешение конфликтов при расхождении Confluence и локальных артефактов:** Если когда-то будет два источника (Confluence и экспорт), решение «какая версия верная» — за человеком.

---

## 7) RECOMMENDATIONS (без внедрения)

1. **Формализовать единственный источник ФМ:** Зафиксировать в одном месте (CLAUDE + README + скрипты): либо только Confluence (тогда убрать обязательность FM_DOCUMENTS в quality_gate и get_latest_fm перевести на PAGE_ID/API), либо два явных режима с разными сценариями.  
2. **Ввести единственного писателя тела страницы ФМ в Confluence:** Правило: только Agent 7 выполняет PUT тела; агенты 0–5 при /apply отдают изменения (патч/список) Agent 7 или в очередь; в описаниях агентов 0–5 заменить «Обновление ФМ → Confluence (PUT API)» на «передать изменения Agent 7» или «записать в … для Agent 7».  
3. **Восстановить или убрать вызовы скриптов интервью:** Либо добавить в репозиторий agent0_new.sh … agent5_architect.sh с явной спецификацией (вход/выход/куда пишут контекст), либо убрать их вызов из orchestrate.sh и передавать контекст только через PROJECT_CONTEXT и промпт.  
4. **Унифицировать контекст проекта:** Один канон — один файл контекста на проект (например projects/PROJECT_*/PROJECT_CONTEXT.md) с обязательным обновлением; убрать дублирование с docs/PROJECT_CONTEXT.md или явно определить docs как архив/глобальный лог, а проект — рабочим контекстом.  
5. **Контекст интервью на проект или сессию:** Не использовать один .interview_context.txt на весь репозиторий; ввести .interview_context_${PROJECT}.txt или передавать контекст только в промпте без перезаписываемого общего файла.  
6. **Единый источник CONFLUENCE_PAGE_ID на проект:** Брать PAGE_ID только из файла проекта (например PROJECT_[NAME]/CONFLUENCE_PAGE_ID); в скриптах убрать жёсткий дефолт 83951683 при работе с произвольным проектом.  
7. **Гейт выхода из цикла согласования:** В workflow зафиксировать критерий «согласование завершено» (например статус Approved в Confluence + отсутствие открытых комментариев типа «требует доработки») и при необходимости проверку в quality_gate или отдельном скрипте.  
8. **Верификация после любого изменения Confluence:** Правило: после каждого PUT страницы ФМ выполнять GET и проверку ключевых правок (или вызов Agent 7 /verify); закрепить в инструкциях агентов 1–5 либо делегирование верификации Agent 7, либо явный шаг самопроверки.  
9. **Расположение CHANGES:** Либо перенести все FM-*-CHANGES.md в PROJECT_[NAME]/CHANGES/ и обновить ссылки, либо изменить правило в CLAUDE и описать хранение в FM_DOCUMENTS.  
10. **Привести workflow (Miro vs BPMN):** В fm-workflows.md и связанных описаниях заменить «ePC в Miro» на текущую реализацию (BPMN, drawio, Confluence) или описать оба варианта с пометкой, какой актуален.  
11. **Машиночитаемый статус findings:** Ввести единый формат статуса замечаний (например метка в строке или поле в структурированном отчёте) и парсить его в quality_gate вместо grep по свободному тексту.  
12. **Явный dry-run перед первой публикацией:** В сценарии Agent 7 при создании новой страницы или смене PAGE_ID обязательный шаг «показать план / dry-run» и подтверждение пользователем перед POST/PUT.

---

## FINAL CHECK

**Можно ли доверить автономную работу без человека?**  
**Нет.**

**Условия, при которых автономия была бы допустима (для последующей доработки системы):**

1. Единственный источник ФМ (Confluence) и все гейты/скрипты переведены на него; никакой логики «последний .docx в FM_DOCUMENTS» без явного режима.  
2. Единственный писатель тела страницы ФМ (Agent 7); агенты 1–5 не выполняют PUT сами, а передают изменения в очередь/протокол к Agent 7.  
3. Наличие всех вызываемых скриптов (или отказ от их вызова) и однозначная передача контекста (один PROJECT_CONTEXT на проект, контекст интервью не глобальный).  
4. Обязательная верификация после каждой записи в Confluence (GET + проверка) по контракту.  
5. Критерий выхода из цикла бизнес-согласования и, при необходимости, проверка в гейте.  
6. Решение «какие правки применить» после аудита/симуляции/тестов остаётся за человеком либо явно формализовано (например «в /auto применять только CRITICAL» с фиксацией в спецификации).

Без этих условий автономный запуск пайплайна и агентов с записью в Confluence несёт риски потери правок, записи в неверную страницу и работы с устаревшими или противоречивыми артефактами.

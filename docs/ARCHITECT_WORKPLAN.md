# Рабочий план Lead Architect

> **Назначение:** Постоянный план работ архитектора системы. Обновляется (НЕ затирается) при каждой сессии.
> **Правило:** Новые записи добавляются в конец соответствующей секции. Старые записи НЕ удаляются.

---

## Обязательный финал каждой сессии архитектора

```
После завершения всех правок в сессии ОБЯЗАТЕЛЬНО:

1. git add — добавить все измененные файлы
2. git commit — коммит с описанием что сделано (например: "feat: Implement FC-13..FC-21 audit fixes")
3. git push — отправить в удаленный репозиторий
4. gh pr create — создать Pull Request в main с описанием изменений

НЕ ЗАВЕРШАТЬ СЕССИЮ без коммита и пуша!
Все изменения должны быть зафиксированы в Git.
```

---

## Текущие приоритеты

| # | Задача | ID находки | Статус | Приоритет |
|---|--------|------------|--------|-----------|
| 1 | Принудительный _summary.json через оркестратор | FC-07 | Закрыто 09.02 | ВЫСОКИЙ |
| 2 | Обязательный Quality Gate с пропуском по причине | FC-08 | Закрыто 09.02 | ВЫСОКИЙ |
| 3 | Гибридная схема контекста для /auto | FC-09 | Закрыто 09.02 | ВЫСОКИЙ |
| 4 | Матрица трассируемости замечание->тест->ТЗ | FC-10 | Закрыто 09.02 | СРЕДНИЙ |
| 5 | Автопатч версии при /apply | FC-11 | Закрыто 09.02 | СРЕДНИЙ |
| 6 | Журнал аудита записей в Confluence | FC-12 | Закрыто 09.02 | СРЕДНИЙ |
| 7 | _summary.json в агентах 3, 6, 8 | FC-13 | Закрыто 09.02 | ВЫСОКИЙ |
| 8 | URL-паттерн Confluence в quality_gate.sh | FC-14 | Закрыто 09.02 | ВЫСОКИЙ |
| 9 | Битые пути в fm_version.sh | FC-15 | Закрыто 09.02 | ВЫСОКИЙ |
| 10 | PIPELINE_NAMES в orchestrate.sh | FC-16 | Закрыто 09.02 | ВЫСОКИЙ |
| 11 | Примеры кода Agent 7 → confluence_utils | FC-17 | Закрыто 09.02 | СРЕДНИЙ |
| 12 | APPLY_MODE в агентах 0, 3, 5 | FC-18 | Закрыто 09.02 | СРЕДНИЙ |
| 13 | Очистка устаревших данных (Notion/Miro/v2.0) | FC-19 | Закрыто 09.02 | СРЕДНИЙ |
| 14 | agent_name в publish_to_confluence.py | FC-20 | Закрыто 09.02 | СРЕДНИЙ |
| 15 | Мелкие правки документации | FC-21 | Закрыто 09.02 | НИЗКИЙ |
| 16 | Вывод run_agent.py из experimental | — | Запланировано | НИЗКИЙ |

---

## История сессий

### Сессия 09.02.2026 - Третий архитектурный аудит

**Цель:** Полный аудит системы на автономность и детерминизм

**Выполнено:**
- Просканированы все 9 агентов, оркестрация, скрипты, схемы, документация
- Идентифицировано 6 новых классов проблем (FC-07...FC-12)
- Для каждого класса предложены 2-3 архитектурных варианта с рекомендацией
- Все рекомендации утверждены заказчиком
- Начата реализация:
  - FC-12B: журнал аудита в confluence_utils.py
  - Схемы: traceabilityMatrix, contextSchema в agent-contracts.json v2.1
  - AG-14: убран глобальный PIPELINE_STATE
  - AG-12/AG-15: уже решены в publish_to_confluence.py v3.0
  - Создан FINDINGS_LEDGER.md (постоянный реестр находок)
  - Создан ARCHITECT_WORKPLAN.md (этот файл)

**Карта автономности (до/после):**

| Метрика | До | Прогноз | Изменение |
|---------|-----|---------|-----------|
| Детерминизм | 2/5 | 4.5/5 | +2.5 |
| Трассируемость | 2/5 | 5/5 | +3 |
| Безопасность изменений | 3/5 | 5/5 | +2 |
| Радиус поражения | 3/5 | 4/5 | +1 |
| Зависимость от человека | 1/5 | 4/5 | +3 |

**Открытые вопросы:**
- [ ] run_agent.py: вывести из experimental или удалить?
- [x] Формат хранения реестра находок: Markdown (текущий) или JSON? -> Markdown (FINDINGS_LEDGER.md)

### Сессия 09.02.2026 (продолжение) - Реализация FC-07..FC-12

**Выполнено:**
- FC-07A: quality_gate.sh v2.0 проверяет _summary.json; инструкции 6 агентов обновлены
- FC-08C: quality_gate.sh с --reason; orchestrate.sh вызывает Gate перед Agent 7
- FC-09C: contextSchema в agent-contracts.json v2.1 (3 обязательных + 4 опциональных ключа)
- FC-10A: traceabilityMatrix/traceabilityEntry в agent-contracts.json v2.1; quality_gate.sh проверяет; Agent 4 инструктирован
- FC-11C: fm_version.sh auto-patch для Z; bump для Y/X
- FC-12B: _audit_log() в confluence_utils.py v1.1; JSONL в .audit_log/; quality_gate.sh проверяет
- AG-14: убран глобальный PIPELINE_STATE из common.sh (заменен комментарием)
- CLAUDE.md: добавлены 5 новых секций (Quality Gate, матрица, контекст, журнал, архитектор)
- FINDINGS_LEDGER.md: все FC-07..FC-12 закрыты
- ARCHITECT_WORKPLAN.md: обновлен

**Карта автономности (после реализации):**

| Метрика | Было | Стало |
|---------|------|-------|
| Детерминизм | 2/5 | 4.5/5 |
| Трассируемость | 2/5 | 5/5 |
| Безопасность изменений | 3/5 | 5/5 |
| Радиус поражения | 3/5 | 4/5 |
| Зависимость от человека | 1/5 | 4/5 |

### Сессия 09.02.2026 (четвертый аудит) - Аудит FC-13..FC-21

**Цель:** Повторный полный аудит системы после реализации FC-07..FC-12

**Выполнено:**
- Параллельное сканирование тремя агентами (скрипты, агенты, документация)
- Идентифицировано 9 новых классов проблем (FC-13...FC-21)
- 4 HIGH: битые пути, молчаливый пропуск Agent 4, неработающий Quality Gate Confluence
- 4 MEDIUM: рассинхрон документации с реализацией, отсутствие APPLY_MODE
- 1 LOW: косметические правки документации
- Все рекомендации утверждены заказчиком и реализованы в одной сессии

**Измененные файлы (9 FC, 15+ файлов):**
- agents/AGENT_3_DEFENDER.md: +_summary.json +APPLY_MODE
- agents/AGENT_6_PRESENTER.md: +_summary.json
- agents/AGENT_8_BPMN_DESIGNER.md: +_summary.json
- agents/AGENT_0_CREATOR.md: +APPLY_MODE
- agents/AGENT_5_TECH_ARCHITECT.md: +APPLY_MODE
- agents/AGENT_7_PUBLISHER.md: примеры кода → ConfluenceClient
- scripts/quality_gate.sh: секция 9 переписана (CONFLUENCE_PAGE_ID + BPMN)
- scripts/fm_version.sh: 4 пути исправлены (/projects/)
- scripts/orchestrate.sh: PIPELINE_NAMES исправлен ("Тест-кейсы")
- scripts/publish_to_confluence.py: +agent_name="Agent7_Publisher"
- projects/PROJECT_SHPMNT_PROFIT/PROJECT_CONTEXT.md: Notion/Miro → Confluence
- CLAUDE.md, README.md: v2.0 → v2.1
- docs/CONTRACT_CONFLUENCE_FM.md: раздел 8 обновлен, дата 2025→2026
- docs/PROMPTS.md: убраны фантомные скрипты
- docs/READINESS_CHECK.md: дата 2025→2026

**Карта автономности (после четвертого аудита):**

| Метрика | Было (до 4-го) | Стало |
|---------|----------------|-------|
| Детерминизм | 4.5/5 | 5/5 |
| Трассируемость | 5/5 | 5/5 |
| Безопасность изменений | 5/5 | 5/5 |
| Радиус поражения | 4/5 | 4.5/5 |
| Зависимость от человека | 4/5 | 4.5/5 |

---

## Архитектурные решения (лог)

### 09.02.2026

| Решение | Обоснование |
|---------|-------------|
| _summary.json обязателен (FC-07A) | Машиночитаемый пайплайн - главный блокатор автономности |
| Quality Gate обязателен, WARN пропускаем с причиной (FC-08C) | CRITICAL не должны попадать в публикацию; бизнес не должен тормозиться |
| Гибридная схема контекста: ядро обязательно + опциональное со значениями по умолчанию (FC-09C) | Баланс строгости и гибкости; практичный путь миграции |
| Матрица трассируемости JSON (FC-10A) | Без нее "все замечания протестированы" - утверждение, не факт |
| Автопатч, ручная минорная/мажорная (FC-11C) | 80% изменений - патчи; мажорные требуют человека |
| Соглашение + журнал аудита (FC-12B) | Достаточно для LLM-агентов; путь перехода к типобезопасности при необходимости |

### 09.02.2026 (четвертый аудит)

| Решение | Обоснование |
|---------|-------------|
| _summary.json во ВСЕХ агентах (FC-13) | Без сайдкара оркестратор не знает статус агента; 3 из 9 были без него |
| Проверка CONFLUENCE_PAGE_ID вместо URL (FC-14) | URL-паттерн atlassian.net не совпадал с ekf.su; файловая проверка надежнее |
| Исправление путей /projects/ (FC-15) | 4 команды fm_version.sh использовали ${ROOT_DIR}/${PROJECT} без /projects/ |
| grep-совместимость PIPELINE_NAMES (FC-16) | Agent 4 молча пропускался из-за несовпадения "Тесты" с "Тест-кейсы" |
| confluence_utils в примерах Agent 7 (FC-17) | Документация расходилась с реализацией; агент мог использовать requests вместо клиента |
| APPLY_MODE во всех агентах с /apply (FC-18) | Агенты 0, 3, 5 не имели автономного режима; конвейер не мог работать без человека |
| Очистка призрачных ссылок (FC-19) | Notion/Miro/v2.0 создавали ложное впечатление о зависимостях |
| agent_name при каждом PUT (FC-20) | Без идентификации вызывающего журнал аудита бесполезен |

---

## Технический долг

| Элемент | Описание | Приоритет | Зависит от |
|---------|----------|-----------|------------|
| Автономный оркестратор | orchestrate.sh вызывает Claude API напрямую | НИЗКИЙ | FC-07, FC-09, run_agent.py |
| Автоматическое бизнес-согласование | Чтение комментариев Confluence, запуск Agent 3 | НИЗКИЙ | FC-08 |
| Валидация _summary.json по схеме | contract_validator.py из experimental/ | НИЗКИЙ | FC-07 |

# ШАБЛОН CONFLUENCE ПУБЛИКАЦИИ ФМ

## Назначение
Эталонная структура страницы ФМ в Confluence.
Скрипт `scripts/publish_to_confluence.py` генерирует страницу по этому шаблону.

---

## Структура страницы

```
+--------------------------------------------------+
| ЗАГОЛОВОК СТРАНИЦЫ: FM-LS-PROFIT                  |
| (не содержит версию - используем встроенную)      |
+--------------------------------------------------+

+--------------------------------------------------+
| МЕТА-БЛОК                                         |
| Код: FM-LS-PROFIT | Версия: 1.0.0 | Дата: авто  |
+--------------------------------------------------+

+--------------------------------------------------+
| МЕТА-ТАБЛИЦА (4x2)                                |
|  Версия   | 1.0.0                                 |
|  Дата     | [текущая дата, авто]                  |
|  Статус   | Разработка                            |
|  Автор    | Шаховский А.С.                        |
+--------------------------------------------------+

+--------------------------------------------------+
| ИСТОРИЯ ВЕРСИЙ (таблица на странице — ОБЯЗАТЕЛЬНО)|
| При каждом обновлении страницы добавляется строка  |
| с кратким описанием изменений.                    |
| Номер  | Дата (авто) | Автор | Изменения          |
| 1.0.0  | авто        | авто  | Первая публикация  |
| 1.0.1  | авто        | авто  | Уточнение п. 3.4   |
+--------------------------------------------------+

... ОСНОВНОЕ СОДЕРЖАНИЕ ФМ ...

+--------------------------------------------------+
| СИСТЕМА КОДОВ ТИПОВ (таблица 7x2)                 |
| Код          | Описание                           |
| LS-BR-XXX    | Бизнес-правила. Расчеты, лимиты   |
| LS-FR-XXX    | Функциональные требования          |
| ...          | ...                                |
+--------------------------------------------------+

... ОПИСАНИЕ ПРОБЛЕМЫ, ПРОЦЕССЫ, ПРАВИЛА ...

+==================================================+
| WARNING PANEL (КРАСНАЯ)                           |
| ⛔ Критическая зависимость                        |
| Текст без эмодзи - панель имеет свою иконку     |
+==================================================+

+--------------------------------------------------+
| NOTE PANEL (ЖЁЛТАЯ)                              |
| ⚠ Предупреждение / исключение                    |
| Текст без эмодзи - панель имеет свою иконку     |
+--------------------------------------------------+

... ТАБЛИЦА ТРЕБОВАНИЙ (77x3) ...

+--------------------------------------------------+
| ТРЕБОВАНИЯ (таблица Код/Наименование/Описание)    |
| LS-BR-001 | Расчет рентабельности | ...           |
| LS-FR-001 | Форма заказа клиента  | ...           |
| ...       | ...                   | ...           |
+--------------------------------------------------+
```

---

## XHTML шаблоны компонентов

### Мета-таблица
```xml
<table class="confluenceTable"><tbody>
  <tr>
    <td style="background-color: #f4f5f7;"><strong>Версия</strong></td>
    <td>{FM_VERSION}</td>
  </tr>
  <tr>
    <td style="background-color: #f4f5f7;"><strong>Дата</strong></td>
    <td>{datetime.now()}</td>
  </tr>
  <tr>
    <td style="background-color: #f4f5f7;"><strong>Статус</strong></td>
    <td>Разработка</td>
  </tr>
  <tr>
    <td style="background-color: #f4f5f7;"><strong>Автор</strong></td>
    <td>Шаховский А.С.</td>
  </tr>
</tbody></table>
```

### Warning panel (КРАСНАЯ) - для критических
```xml
<ac:structured-macro ac:name="warning">
  <ac:rich-text-body>
    <p>КРИТИЧЕСКАЯ ЗАВИСИМОСТЬ: текст без эмодзи</p>
  </ac:rich-text-body>
</ac:structured-macro>
```

### Note panel (ЖЁЛТАЯ) - для предупреждений
```xml
<ac:structured-macro ac:name="note">
  <ac:rich-text-body>
    <p>Предупреждение: текст без эмодзи</p>
  </ac:rich-text-body>
</ac:structured-macro>
```

### Заголовки (жирные)
```xml
<h1><strong>Заголовок раздела</strong></h1>
<h2><strong>Подзаголовок</strong></h2>
<h3><strong>Подподзаголовок</strong></h3>
```

### Таблица с заголовком
```xml
<table class="confluenceTable"><tbody>
  <tr>
    <th class="confluenceTh" style="background-color: #f4f5f7;">
      <strong>Колонка 1</strong>
    </th>
    <th class="confluenceTh" style="background-color: #f4f5f7;">
      <strong>Колонка 2</strong>
    </th>
  </tr>
  <tr>
    <td class="confluenceTd">Значение 1</td>
    <td class="confluenceTd">Значение 2</td>
  </tr>
</tbody></table>
```

---

## Управление версиями (R-05)

### Два типа версий

| Тип | Формат | Где хранится | Кто управляет |
|-----|--------|--------------|---------------|
| FM_VERSION | X.Y.Z (семантическая) | Мета-таблица, История версий, version.message | Agent 0/7 |
| Confluence version | 1,2,3... (автоинкремент) | Confluence API | Confluence |

### Связь версий

При каждом обновлении страницы через Agent 7:
1. **FM_VERSION** указывается в теле запроса (например, "1.2.3")
2. **version.message** содержит: `[FM 1.2.3] Описание изменений`
3. **Confluence version** инкрементируется автоматически

### Как найти FM-версию по Confluence-версии

```
Confluence History → version.message содержит "[FM X.Y.Z]"
```

### Правила версионирования FM

| Изменение | FM_VERSION | Пример |
|-----------|------------|--------|
| Патч (опечатки, уточнения) | X.Y.Z+1 | 1.0.0 → 1.0.1 |
| Минорные (новые требования) | X.Y+1.0 | 1.0.1 → 1.1.0 |
| Мажорные (переработка логики) | X+1.0.0 | 1.1.0 → 2.0.0 |

---

## Confluence API

| Параметр | Значение |
|----------|----------|
| URL | https://confluence.ekf.su |
| Auth | Bearer token (PAT) |
| API | /rest/api/content/{PAGE_ID} |
| Метод | PUT (обновление) |
| Формат | storage (XHTML) |
| Версионность | автоинкремент version.number |

---

## Скрипт публикации

**Файл:** `scripts/publish_to_confluence.py`

**Запуск:**
```bash
python3 scripts/publish_to_confluence.py
```

**Конфигурация внутри скрипта:**
- `CONFLUENCE_URL` - адрес сервера
- `PAGE_ID` - ID страницы ФМ
- `TOKEN` - Personal Access Token

**Что делает:**
1. Читает текущую страницу из Confluence (GET API)
2. Формирует обновленный XHTML контент
3. Подменяет дату на текущую
4. Обновляет мета-таблицу (версия, дата, автор)
5. Собирает систему кодов типов в таблицу
6. Оборачивает предупреждения/критические в панели
7. Публикует через PUT /rest/api/content/{PAGE_ID}

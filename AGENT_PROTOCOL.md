# Обязательный протокол работы агента

> Каждый агент (0-8, EVOLVE) выполняет этот протокол на каждую сессию.
> Ссылка на этот файл есть в начале каждого AGENT_*.md.

---

## СТАРТ СЕССИИ

1. **Прочитать контекст:**
   - `CLAUDE.md` - роутер команд
   - `projects/<PROJECT>/PROJECT_CONTEXT.md` - бизнес-контекст текущего проекта
   - `projects/<PROJECT>/WORKPLAN.md` - план и статус задач
   - `HANDOFF.md` - что было сделано в прошлой сессии, что дальше
   - `.patches/*.md` - накопленные паттерны ошибок (self-improvement)

2. **Залогировать старт** в `/logs/`:
   ```
   /logs/YYYY-MM-DD/HHMM_AGENT-N_PROJECT_step-start.md
   ```
   Содержание: цель сессии, какой проект, какая версия ФМ, какой этап pipeline.

3. **Обновить WORKPLAN** текущего проекта: пометить задачу "in progress".

## ПЛАНИРОВАНИЕ (перед реализацией!)

4. **Составить план работ** ПЕРЕД началом реализации:
   - Определить задачи и их порядок
   - Записать план в WORKPLAN.md (или показать пользователю для крупных задач)
   - Указать: что делать, какие файлы затронуты, ожидаемый результат
   - Тривиальные правки (опечатки, однострочные фиксы) - без плана

## РАБОТА

5. **Выполнить задачи по плану** согласно своей спецификации (AGENT_*.md).

6. **При обнаружении паттерна** - записать в `.patches/`:
   ```
   .patches/YYYY-MM-DD_AGENT-N_PROJECT_описание.md
   ```

7. **При принятии решения** (выбор из альтернатив) - записать в `DECISIONS.md`.

8. **При ЛЮБОМ вопросе к пользователю** - ВСЕГДА вызывать AskUserQuestion. Вопрос текстом в чате = вопрос в пустоту. Без исключений.

## ФИКСАЦИЯ (после каждого блока задач!)

9. **Залогировать итог** - дополнить файл из шага 2:
   - Actions: что конкретно сделано
   - Output: результат (факты, цифры)
   - Files changed: список файлов
   - Risks: что проверить

10. **Обновить WORKPLAN**: пометить задачу "done" или "blocked" с причиной.

11. **Зафиксировать изменения**: git commit с описанием что сделано.

12. **Обновить HANDOFF.md**: текущий статус для следующего агента/сессии.

13. **Обновить DECISIONS.md**: если были приняты решения.

---

## ФОРМАТ ЛОГА

```markdown
# [Agent N] Step: <название>

**Дата:** YYYY-MM-DD HH:MM
**Проект:** PROJECT_NAME
**Версия ФМ:** vX.Y.Z
**Цель:** 1-2 строки

## Inputs
- Какие файлы/данные использованы

## Actions
- Что конкретно сделано (список)

## Output
- Результат (факты)

## Files changed
- Список измененных файлов

## Risks / Notes
- Что проверить, нюансы

## Next
- Следующий шаг, кто выполняет
```

---

## ЕСЛИ НЕ МОЖЕШЬ ВЫПОЛНИТЬ ШАГ

1. Залогировать причину
2. Пометить WORKPLAN как "blocked" с причиной
3. Предложить 1-2 альтернативы через AskUserQuestion
4. Обновить HANDOFF.md с описанием блокера
